<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/CMZqNMRh/IMG-6497.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>ğŸ‡Phone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #a8d8ff;}
        html { height: 100%; overflow: hidden; }


        /* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ,æ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ body, phone-frame, phone-screen ç­‰æ ·å¼ â–¼â–¼â–¼ */

/* === ã€ç»ˆæé¢œè‰²ä¿®æ­£ v2ã€‘ === */

/* 1. ç»Ÿä¸€å®šä¹‰å…¨å±€çš„ä¸»é¢˜è‰²å’ŒæŒ‰é’®è‰²å˜é‡ */
:root {
    --theme-button-bg: #c7c7c7 !important; /* æŒ‰é’®é¢œè‰²å˜é‡ */
}

/* 2. ä¿®æ­£æ‰€æœ‰ã€å®å¿ƒã€‘æŒ‰é’®çš„èƒŒæ™¯è‰² */
#fetch-models-btn,
#gemini-studio-setup-btn,
#save-api-settings-btn,
.form-button,
.custom-modal-footer .save,
.comment-send-btn,
#chat-lock-content .lock-action-btn,
#member-management-actions button {
    background-color: var(--theme-button-bg) !important;
    border-color: var(--theme-button-bg) !important; /* ç¡®ä¿è¾¹æ¡†é¢œè‰²ä¹Ÿä¸€è‡´ */
}

/* 3. ä¿®æ­£æ‰€æœ‰ã€æ–‡å­—ã€‘æŒ‰é’®çš„é¢œè‰² */
.header .save-btn,
.header .back-btn, 
.header .action-btn,
#selection-cancel-btn,
.nav-item.active,
.playlist-header .panel-btn,
#sticker-panel-header .panel-btn,
.modal-header .action-button,
#load-more-btn,
.custom-modal-footer button {
    color: var(--theme-button-bg) !important;
}

/* 4. ä¿®æ­£æ‰€æœ‰ã€çº¿æ¡†ã€‘æŒ‰é’®çš„é¢œè‰² */
.poll-action-btn,
.saved-bubble-theme-item .theme-actions .apply-btn,
#chat-lock-content .lock-action-btn.secondary,
.modal-footer .cancel {
    color: var(--theme-button-bg) !important;
    border-color: var(--theme-button-bg) !important;
}

/* 5. ä¿®æ­£å…¶ä»–å…ƒç´ çš„é¢œè‰² */
.message-bubble.selected::after,
#favorites-view.selection-mode .favorite-item-card.selected::before,
.contact-picker-item.selected .checkbox {
    background-color: var(--theme-button-bg) !important;
    border-color: var(--theme-button-bg) !important;
}

.poll-option-item.voted,
.custom-multiselect .select-box.expanded {
     border-color: var(--theme-button-bg) !important;
}

#phone-screen.dark-mode .quoted-message .quoted-sender {
    color: var(--theme-button-bg) !important;
}

/* === ä¿®æ­£ç»“æŸ === */
        
/* 1. é‡ç½® body,ä½¿å…¶æˆä¸ºä¸€ä¸ªå¹²å‡€çš„ç”»å¸ƒ */
body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: normal;
    background-color: #f0f2f5; 
}

/* 2. è®© #phone-screen æˆä¸ºæ–°çš„â€œæ ¹â€å®¹å™¨,æ’‘æ»¡æ•´ä¸ªæµè§ˆå™¨çª—å£ */
#phone-screen {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: #000; /* ä¿ç•™ä¸€ä¸ªé»˜è®¤çš„é»‘è‰²èƒŒæ™¯ */
}

/* 3. ã€æ ¸å¿ƒã€‘éšè—æ‰æ¨¡æ‹Ÿå™¨çš„çŠ¶æ€æ  */
#status-bar {
    display: none;
}

/* 4. ã€æ ¸å¿ƒã€‘è®©æ‰€æœ‰é¡µé¢çš„å¤´éƒ¨è‡ªåŠ¨é€‚åº”iPhoneçš„â€œåˆ˜æµ·â€å®‰å…¨åŒº */
.header, .qzone-header {
    /* ä½¿ç”¨ env(safe-area-inset-top) è‡ªåŠ¨è·å–é¡¶éƒ¨å®‰å…¨è·ç¦» */
    padding-top: calc(15px + env(safe-area-inset-top));
}

/* 5. ã€æ ¸å¿ƒã€‘è®©èŠå¤©è¾“å…¥æ¡†å’Œåº•éƒ¨å¯¼èˆªæ è‡ªåŠ¨é€‚åº”iPhoneåº•éƒ¨çš„â€œå°é»‘æ¡â€å®‰å…¨åŒº */
#chat-input-area {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }

.header .action-btn {
    font-size: 16px; /* ä¸“é—¨ä¸ºâ€œä¸Šä¼ â€ã€â€œ+â€ç­‰æ–‡å­—æŒ‰é’®ç¼©å°å­—å· */
    font-weight: 600; /* å¯ä»¥åŠ ç²—ä¸€ç‚¹è®©å®ƒæ›´æ¸…æ™° */
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 100px; padding-bottom: 80px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
/* â–¼â–¼â–¼ 2. ä¿®æ”¹ä¸»é¡µå¸ƒå±€æ ·å¼:è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„CSSæ ·å¼,æ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ #app-grid å’Œ .app-row æ ·å¼ â–¼â–¼â–¼ */

/* a. å®šä¹‰é»‘èƒ¶å”±ç‰‡æ—‹è½¬åŠ¨ç”» */
@keyframes spin-vinyl {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* b. é‡å®šä¹‰ #app-grid ä¸ºå·¦å³å¸ƒå±€çš„ flex å®¹å™¨ */
#app-grid {
    display: flex;
    flex-direction: row; /* æ°´å¹³æ’åˆ— */
    justify-content: center; /* å±…ä¸­åˆ†å¸ƒ */
    align-items: center;
    width: 100%;
    margin-top: auto; /* å°†æ•´ä¸ªå®¹å™¨æ¨åˆ°åº•éƒ¨,æ—¶é’Ÿä¿æŒåœ¨é¡¶éƒ¨ */
    padding: 20px 10px;
    gap: 15px; /* å·¦å³ä¸¤å¤§å—ä¹‹é—´çš„é—´è· */
}

/* â–¼â–¼â–¼ ç”¨è¿™æ•´å—æ–°æ ·å¼,æ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ vinyl-player ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */

/* 1. å¤–å±‚æ€»å®¹å™¨,å®ƒåªè´Ÿè´£ã€æ¨¡ç³ŠèƒŒæ™¯ã€‘å’Œã€å®šä½ã€‘ */
#vinyl-player-container {
    width: 180px;
    height: 180px;
    position: relative; /* å…³é”®:è®©å†…éƒ¨çš„å›¾ç‰‡å¯ä»¥ç›¸å¯¹äºå®ƒè¿›è¡Œç»å¯¹å®šä½ */
    cursor: pointer;
    border-radius: 15px;
    overflow: hidden; /* <-- æ·»åŠ è¿™ä¸€è¡Œ */
    
    /* â–¼â–¼â–¼ æ–°å¢:æ·»åŠ ä¸€ä¸ªç™½è‰²åº•è‰² â–¼â–¼â–¼ */
    background-color: white; 
    
    /* é»˜è®¤èƒŒæ™¯å›¾,JSä¼šæ›´æ–°å®ƒ */
    background-image: url('https://i.postimg.cc/CMZqNMRh/IMG-6497.jpg');
    background-size: cover;
    background-position: center;
}

#vinyl-player-container::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: inherit;
    background-size: cover;
    background-position: center;
    border-radius: 15px; /* <-- ä¿®æ”¹è¿™é‡Œ */
    filter: blur(8px); 
    transform: scale(1.1);
    opacity: 0.8;
    z-index: 1; 
}

/* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘é™æ€çš„ã€ä¸åŠ¨çš„ã€é€æ˜é»‘èƒ¶åœˆã€‘æ ·å¼ */
#vinyl-record-overlay {
    position: absolute;
    top: 10px;
    left: -28px;
    width: 110%;
    height: 90%;
    z-index: 3; /* <-- z-index ä¿®æ”¹ä¸º 3 */
    pointer-events: none !important;
}

/* 4. ã€æ ¸å¿ƒä¿®å¤ã€‘å”¯ä¸€æ—‹è½¬çš„ã€ä¸“è¾‘å°é¢å›¾ã€‘æ ·å¼ */
#vinyl-album-art {
    position: absolute;
    top: 10%;
    left: 7%;
    transform: translate(-50%, -50%); 
    width: 85%;  
    height: 85%;
    border-radius: 50%;
    object-fit: cover;
    z-index: 2; /* <-- z-index ä¿®æ”¹ä¸º 2 */
    background-color: rgb(43, 43, 43); 
    
    animation: spin-vinyl 8s linear infinite; 
}
/* d. å³ä¾§ 2x2 å›¾æ ‡ç½‘æ ¼ */
#new-app-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2åˆ— */
    grid-template-rows: repeat(2, 1fr);    /* 2è¡Œ */
    gap: 15px; /* å›¾æ ‡é—´è· */
}

/* e. å¾®è°ƒæ–°å¸ƒå±€ä¸‹çš„å›¾æ ‡å’Œå°å­—å¤§å° */
#new-app-grid .app-icon .icon-bg {
    width: 58px;
    height: 58px;
}

#new-app-grid .app-icon .label {
    font-size: 13px;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦èƒ¶å›Šå¼é€‰æ‹©å™¨æ ·å¼ â–¼â–¼â–¼ */
#world-book-pills-container {
    padding: 10px;
    background-color: #f7f8fa; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰²ä»¥åŒºåˆ† */
    border-radius: 8px;
    border: 1px solid #e9ecef;
    max-height: 200px; /* å¢åŠ æœ€å¤§é«˜åº¦å’Œæ»šåŠ¨æ¡ */
    overflow-y: auto;
}
#phone-screen.dark-mode #world-book-pills-container {
    background-color: #2c2c2e;
    border-color: #38383a;
}

.wb-pill-category-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 10px 5px 5px;
    margin-top: 10px;
    border-bottom: 1px solid var(--border-color);
}
.wb-pill-category-title:first-child {
    margin-top: 0;
}

.wb-pills-wrapper {
    display: flex;
    flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
    gap: 10px; /* èƒ¶å›Šä¹‹é—´çš„é—´è· */
    padding-top: 10px;
}

.wb-pill {
    padding: 8px 15px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 20px; /* èƒ¶å›Šå½¢çŠ¶ */
    background-color: #e9ecef;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    display: flex;
    align-items: center;
    gap: 6px;
}
#phone-screen.dark-mode .wb-pill {
    background-color: #3e3e42;
}

/* é€‰ä¸­çŠ¶æ€ */
.wb-pill.selected {
    background-color: var(--accent-color);
    color: white;
    box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
}

.wb-pill .check-icon {
    display: none; /* é»˜è®¤éšè—å¯¹å‹¾ */
    font-weight: bold;
}
.wb-pill.selected .check-icon {
    display: inline; /* é€‰ä¸­æ—¶æ˜¾ç¤º */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ‰‹æœºè¾¹æ¡†ç¾åŒ–æ ·å¼ (æ›¿æ¢æ—§çš„è¾¹æ¡†æ¨¡å¼CSS) â–¼â–¼â–¼ */

/* 1. è®© body æˆä¸ºä¸€ä¸ªå±…ä¸­çš„ã€å¸¦æœ‰æŸ”å’ŒèƒŒæ™¯çš„ç”»æ¿ */
body.bordered-mode {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #fdf2f7; /* ä¸€ä¸ªæŸ”å’Œçš„æ·¡ç²‰è‰²èƒŒæ™¯,å‘¼åº”å›¾ç‰‡é£æ ¼ */
    padding: 20px;
    box-sizing: border-box;
    transition: background-color 0.3s; /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ */
}

/* 2. ã€æ ¸å¿ƒã€‘é‡æ–°å®šä¹‰æ‰‹æœºå¤–è§‚,ä½¿å…¶æ›´åƒå›¾ç‰‡ä¸­çš„ç™½è‰²ç®€çº¦æ¨¡å‹ */
body.bordered-mode #phone-screen {
    width: 375px;
    height: 812px;
    border-radius: 44px; /* ä¿æŒåœ†è§’ */
    position: relative;
    overflow: hidden;
    
    /* ç§»é™¤æ—§çš„æ·±è‰²è¾¹æ¡†å’Œå¤–å£³é˜´å½± */
    border: none;
    
    /* ä½¿ç”¨å…¨æ–°çš„ box-shadow æ¥å®ç°â€œç™½è‰²å¤–å£³ + æŸ”å’Œé˜´å½±â€çš„æ•ˆæœ */
    box-shadow: 
        /* ç¬¬ä¸€å±‚: æ¨¡æ‹Ÿå±å¹•å†…åµŒçš„ç™½è‰²è¾¹æ¡† (Bezel) */
        inset 0 0 0 8px #fff,
        /* ç¬¬äºŒå±‚: æ¨¡æ‹Ÿæ‰‹æœºæ•´ä½“çš„ã€æŸ”å’Œçš„æ‚¬æµ®é˜´å½± */
        0 15px 35px rgba(0, 0, 0, 0.1);

    /* æ·»åŠ ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœ,è®©åˆ‡æ¢æ›´è‡ªç„¶ */
    transition: width 0.3s, height 0.3s, box-shadow 0.3s;
}

/* 3. åœ¨è¾¹æ¡†æ¨¡å¼ä¸‹,è®©çŠ¶æ€æ é‡æ–°æ˜¾ç¤ºå‡ºæ¥ (ä¿æŒä¸å˜) */
body.bordered-mode #status-bar {
    display: flex;
}
/* â–²â–²â–² ç¾åŒ–æ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€QQå¤´åƒæ¡†ç‰¹æ•ˆ - ç»ˆæç‰ˆCSSã€‘(è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ‰€æœ‰æ—§çš„å¤´åƒæ¡†ç›¸å…³CSS) â–¼â–¼â–¼ */

/* 1. é€šç”¨åŒ…è£¹å®¹å™¨:å®ƒçš„å°ºå¯¸å°±æ˜¯å¤´åƒçš„å°ºå¯¸ */
.avatar-frame-wrapper {
    position: relative; /* å…³é”®:æˆä¸ºå†…éƒ¨å¤´åƒæ¡†çš„å®šä½åŸºå‡† */
    flex-shrink: 0;
    /* å®¹å™¨æœ¬èº«æ²¡æœ‰èƒŒæ™¯æˆ–è¾¹æ¡† */
}

/* 2. å†…éƒ¨çš„å¤´åƒå›¾ç‰‡:æ’‘æ»¡æ•´ä¸ªå®¹å™¨ (å·²ä¿®æ­£) */
.avatar-frame-wrapper .avatar-img,
.avatar-editor-preview-wrapper .avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%; /* ç¡®ä¿å¤´åƒæ˜¯æ­£åœ†å½¢ */
    display: block; /* ç§»é™¤å›¾ç‰‡é»˜è®¤çš„åº•éƒ¨é—´éš™ */
}

/* 3. ã€ã€ã€æ ¸å¿ƒé­”æ³•ã€‘ã€‘ã€‘å åŠ çš„å¤´åƒæ¡†å›¾ç‰‡ (å·²ä¿®æ­£) */
.avatar-frame-wrapper .avatar-frame-overlay,
.avatar-editor-preview-wrapper .avatar-frame-overlay {
    position: absolute; /* è„±ç¦»æ–‡æ¡£æµ,æ‚¬æµ®èµ·æ¥ */
    z-index: 1;         /* ç¡®ä¿åœ¨å¤´åƒå›¾ç‰‡ä¹‹ä¸Š */
    pointer-events: none; /* è®©é¼ æ ‡å¯ä»¥ç©¿é€å®ƒ */

    /* å…³é”®:è®©å¤´åƒæ¡†æ¯”å®¹å™¨(ä¹Ÿå°±æ˜¯å¤´åƒ)å¤§ 25% */
    width: 165%;
    height: 165%;
    
    /* å…³é”®:ä½¿ç”¨ transform æŠ€å·§,å°†æ”¾å¤§çš„å¤´åƒæ¡†å®Œç¾å±…ä¸­å¯¹é½ */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); 
}

/* 4. ã€é€‚é…ã€‘ä¸åŒä½ç½®çš„å¤´åƒå°ºå¯¸(è¿™éƒ¨åˆ†ä¿æŒä¸å˜,ä½†å¾ˆé‡è¦) */
/* a. èŠå¤©åˆ—è¡¨ */
.chat-list-item .avatar-frame-wrapper {
    width: 45px;
    height: 45px;
    margin-right: 12px;
}
/* b. èŠå¤©æ°”æ³¡ */
.message-bubble .avatar-frame-wrapper {
    top: -5px;
    width: 40px;
    height: 40px;
}

/* d. å¤´åƒæ¡†åº”ç”¨å¼¹çª—é¢„è§ˆåŒº */
#avatar-frame-apply-modal .avatar-frame-wrapper {
    width: 70px;
    height: 70px;
    margin-bottom: 10px;
    padding: 2px;
    border-radius: 50%;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* ä¿®æ”¹åçš„ #world-book-list æ ·å¼ */
#world-book-list {
    flex-grow: 1;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    padding-top: 80px;
    margin-top: -80px;
}

/* ä¿®æ”¹åçš„ #chat-list æ ·å¼,å»æ‰äº† padding å’Œ margin */
#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 80px; 
    padding-bottom: 50px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
    box-sizing: border-box;
}

        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: var(--border-color); padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }

/* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ #chat-messages æ ·å¼ â–¼â–¼â–¼ */
#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden; /* æ ¸å¿ƒä¿®æ­£1: å¼ºåˆ¶ç¦æ­¢æ°´å¹³æ»šåŠ¨/æ‹–åŠ¨ */
    padding: 10px 15px; /* æ ¸å¿ƒä¿®æ­£2: å°†å·¦å³å†…è¾¹è·å¢åŠ åˆ°15px,æä¾›æ›´å¤šå‘¼å¸ç©ºé—´ */
    padding-top: 110px;
    margin-top: -80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·è®¡ç®—æ­£ç¡® */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }

.message-wrapper.ai .sender-name {
    margin-left: 50px; /* ç¨å¾®è°ƒæ•´,ä¸å¤´åƒå¯¹é½ */
    margin-bottom: 3px;
    position: absolute; /* è®©å®ƒè„±ç¦»æµ,é¿å…å½±å“æ°”æ³¡å¯¹é½ */
    top: -16px;       /* å®šä½åˆ°æ°”æ³¡ä¸Šæ–¹ */
    left: 0;
}

/* === ã€å…¨æ–°ã€‘æ¶ˆæ¯å¸ƒå±€ä¸æ—¶é—´æˆ³æ ·å¼ === */

/* 1. æ¶ˆæ¯å•å…ƒçš„æ€»å®¹å™¨ (é‡æ„) */
.message-wrapper {
    display: flex;          /* ä½¿ç”¨Flexå¸ƒå±€ */
    gap: 8px;               /* æ°”æ³¡å’Œæ—¶é—´æˆ³ä¹‹é—´çš„é—´è· */
    align-items: flex-end;  /* æ ¸å¿ƒ:è®©æ°”æ³¡å’Œæ—¶é—´æˆ³åº•éƒ¨å¯¹é½ */
    position: relative;
    max-width: 90%;         /* å¯ä»¥ç¨å¾®æ”¾å®½ä¸€ç‚¹,å› ä¸ºæ—¶é—´æˆ³ç°åœ¨åœ¨å¤–é¢äº† */
}

/* 2. AIæ¶ˆæ¯å•å…ƒé å·¦ */
.message-wrapper.ai {
    align-self: flex-start;
    flex-direction: row; /* å¤´åƒã€æ°”æ³¡ã€æ—¶é—´æˆ³,ä»å·¦åˆ°å³æ’åˆ— */
}

/* 3. ç”¨æˆ·æ¶ˆæ¯å•å…ƒé å³ */
.message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse; /* æ—¶é—´æˆ³ã€æ°”æ³¡ã€å¤´åƒ,ä»å³åˆ°å·¦æ’åˆ— */
}

/* 4. æ°”æ³¡å’Œå¤´åƒçš„ç›´æ¥å®¹å™¨ (ä¿æŒä¸å˜) */
.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.timestamp {
    /* ç§»é™¤æ—§çš„ position: absolute */
    font-size: 11px;
    color: #999;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
    white-space: nowrap; /* é˜²æ­¢æ—¶é—´æ¢è¡Œ */
    margin-bottom: 5px;  /* è®©å®ƒå’Œæ°”æ³¡åº•éƒ¨æœ‰è½»å¾®çš„å¯¹é½åç§»,æ›´ç¾è§‚ */
    flex-shrink: 0;      /* é˜²æ­¢è¢«å‹ç¼© */
}

        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
#chat-input {
  width: 100%;
  padding: 10px 15px;
  padding-right: 45px; /* è¯­éŸ³æŒ‰é’®é¢„ç•™ç©ºé—´ */
  border-radius: 20px;
  border: none;
  background-color: var(--secondary-bg);
  font-size: 16px;
  max-height: 100px;
  resize: none;
  /* --- æ ¸å¿ƒä¿®æ­£ --- */
  min-height: 40px;      /* è®¾ç½®ä¸€ä¸ªä¸å‘é€æŒ‰é’®ç­‰é«˜çš„æœ€å°é«˜åº¦ */
  box-sizing: border-box; /* ç¡®ä¿ padding å’Œ border è¢«è®¡ç®—åœ¨é«˜åº¦ä¹‹å†… */
}        
.action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
#send-btn {
  background-color: #f0f0f0; /* 1. å°†èƒŒæ™¯è‰²ä»ä¸»é¢˜è“è‰²æ”¹ä¸ºæµ…ç°è‰² */
  /* 2. ç§»é™¤äº†æ—§çš„ color å’Œ svg æ ·å¼,å› ä¸ºç°åœ¨æ˜¯å›¾ç‰‡äº† */
}

/* 3. ã€æ–°å¢ã€‘ä¸ºå‘é€æŒ‰é’®å†…çš„å›¾ç‰‡è®¾ç½®åˆé€‚çš„å°ºå¯¸ */
#send-btn img {
    width: 24px;
    height: 24px;
    object-fit: contain; /* ä¿è¯å›¾æ ‡æ¯”ä¾‹æ­£ç¡® */
}        
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    /* å…³é”®:åœ¨Yè½´å›åˆ°åŸä½çš„åŒæ—¶,ä¿æŒXè½´çš„å±…ä¸­å˜æ¢ */
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
/* â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ›¿æ¢ â–¼â–¼â–¼ */
/* èŠå¤©è¾“å…¥åŒºé¡¶éƒ¨å¿«æ·æ“ä½œå›¾æ ‡ */
.chat-action-icon-btn {
    background: none; /* æ ¸å¿ƒä¿®æ”¹:å»æ‰èƒŒæ™¯é¢œè‰² */
    border: none;     /* æ ¸å¿ƒä¿®æ”¹:å»æ‰è¾¹æ¡† */
    padding: 2px;       /* å»æ‰å†…è¾¹è· */
    width: 25px;      /* ç»Ÿä¸€å›¾æ ‡å®½åº¦ */
    height: 25px;     /* ç»Ÿä¸€å›¾æ ‡é«˜åº¦ */
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* ã€æ–°å¢ã€‘ä¸ºå›¾æ ‡å†…çš„å›¾ç‰‡è®¾ç½®æ ·å¼ */
.chat-action-icon-btn img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* ä¿è¯å›¾ç‰‡æ¯”ä¾‹æ­£ç¡® */
}
/* â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨ç›´æ’­é—´é¡µé¢éšè—çŠ¶æ€æ  â–¼â–¼â–¼ */
#phone-screen:has(#live-stream-screen.active) #status-bar {
    display: none !important;
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ 2. ç”¨è¿™æ•´å—æ–°ä»£ç ,æ›¿æ¢æ‰æ—§çš„â€œè®¾ç½®é¡µé¢æ ·å¼â€ä»£ç  â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘å¤–è§‚è®¾ç½®é¡µé¢ç²¾è‡´åŒ–å¸ƒå±€ === */

/* a. ä¸ºå¤–è§‚è®¾ç½®é¡µé¢çš„ä¸»å®¹å™¨æä¾›ç»Ÿä¸€çš„èƒŒæ™¯å’Œå†…è¾¹è· */
#wallpaper-screen .form-container {
    background-color: #f7f8fa;
    padding: 20px;
    gap: 25px;
}
#phone-screen.dark-mode #wallpaper-screen .form-container {
    background-color: #000;
}


/* b. å°†å¤–è§‚è®¾ç½®é¡µå†…çš„æ¯ä¸ªè®¾ç½®åŒºåŸŸæ”¹é€ ä¸ºå¡ç‰‡æ ·å¼ */
#wallpaper-screen #theme-management-section, 
#wallpaper-screen #wallpaper-settings-section, 
#wallpaper-screen #icon-settings-section, 
#wallpaper-screen #other-settings-section,
#wallpaper-screen #font-settings-section {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 0 !important;
}

#phone-screen.dark-mode #wallpaper-screen #theme-management-section, 
#phone-screen.dark-mode #wallpaper-screen #wallpaper-settings-section, 
#phone-screen.dark-mode #wallpaper-screen #icon-settings-section, 
#phone-screen.dark-mode #wallpaper-screen #other-settings-section,
#phone-screen.dark-mode #wallpaper-screen #font-settings-section {
    border-color: var(--border-color);
}


/* c. ä¼˜åŒ–å¤–è§‚è®¾ç½®é¡µå†…è¡¨å•ç»„çš„å†…éƒ¨é—´è· */
#wallpaper-screen .form-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* d. ç¾åŒ–å¤–è§‚è®¾ç½®é¡µå†…çš„æ ‡ç­¾å’ŒåŒºåŸŸæ ‡é¢˜ */
#wallpaper-screen .form-group label, 
#wallpaper-screen .section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}
#wallpaper-screen .section-title {
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 15px !important;
    text-align: left;
}

/* e. ç¾åŒ–å¤–è§‚è®¾ç½®é¡µå†…çš„è¾“å…¥æ¡†ã€é€‰æ‹©æ¡†å’Œæ–‡æœ¬åŸŸ */
#wallpaper-screen .form-group input, 
#wallpaper-screen .form-group select, 
#wallpaper-screen .form-group textarea {
    background-color: #f7f8fa;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 14px;
    font-size: 15px;
    transition: all 0.2s ease-in-out;
}
#wallpaper-screen .form-group input:focus, 
#wallpaper-screen .form-group select:focus, 
#wallpaper-screen .form-group textarea:focus {
    border-color: var(--accent-color);
    background-color: #fff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); /* æ¢å¤ä¸ºè“è‰²å…‰æ™• */
}
#phone-screen.dark-mode #wallpaper-screen .form-group input, 
#phone-screen.dark-mode #wallpaper-screen .form-group select, 
#phone-screen.dark-mode #wallpaper-screen .form-group textarea {
    background-color: #2c2c2e;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ¨æ€è¯„è®ºåŒºâ€œå›å¤â€æ ·å¼ â–¼â–¼â–¼ */
.comment-item .reply-indicator {
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰²,ä¸é‚£ä¹ˆæ˜¾çœ¼ */
    font-size: 13px;              /* å­—ä½“å¯ä»¥å’Œæ­£æ–‡ä¸€æ ·å¤§ */
    margin: 0 4px;                /* å‰åç•™å‡ºä¸€ç‚¹é—´è· */
    font-weight: normal;          /* æ— éœ€åŠ ç²— */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* f. ç¾åŒ–å¤–è§‚è®¾ç½®é¡µå†…çš„æ‰€æœ‰æŒ‰é’® */
#wallpaper-screen .form-button {
    background-color: var(--accent-color);
    border-radius: 10px;
    padding: 16px;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3); /* æ¢å¤ä¸ºè“è‰²é˜´å½± */
    transition: all 0.2s ease-in-out;
}
#wallpaper-screen .form-button:active {
    transform: scale(0.98);
    opacity: 0.9;
}
#wallpaper-screen .form-button-secondary {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    box-shadow: none;
}
#phone-screen.dark-mode #wallpaper-screen .form-button-secondary {
    background-color: #2c2c2e;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* ä½ çš„ç›®æ ‡å…ƒç´  */
.your-scrollable-element {
    /* 
     * å…³é”®æ­¥éª¤1:
     * å¿…é¡»è®¾ç½® overflow ä¸º auto æˆ– scroll,
     * è¿™ä½¿å¾—å…ƒç´ åœ¨å†…å®¹è¶…å‡ºæ—¶å¯ä»¥æ»šåŠ¨ã€‚
     * å¦‚æœæ˜¯å‚ç›´æ»šåŠ¨,åˆ™ä½¿ç”¨ overflow-y: auto;
     * å¦‚æœæ˜¯æ°´å¹³æ»šåŠ¨,åˆ™ä½¿ç”¨ overflow-x: auto;
     */
    overflow-y: auto; /* ä»¥å‚ç›´æ»šåŠ¨ä¸ºä¾‹ */

    /* 
     * å…³é”®æ­¥éª¤2:
     * é’ˆå¯¹ä¸åŒæµè§ˆå™¨éšè—æ»šåŠ¨æ¡ã€‚
     */
    
    /* a. é€‚ç”¨äº Firefox */
    scrollbar-width: none; 
    
    /* b. é€‚ç”¨äº Internet Explorer å’Œ Edge (æ—§ç‰ˆ) */
    -ms-overflow-style: none;  
}

/* 
 * c. é€‚ç”¨äº Chrome, Safari, Edge (æ–°ç‰ˆ) å’Œå…¶ä»– WebKit å†…æ ¸çš„æµè§ˆå™¨ã€‚
 *    è¿™é‡Œä½¿ç”¨ä¼ªå…ƒç´ é€‰æ‹©å™¨æ¥è®¿é—®æ»šåŠ¨æ¡å¹¶å°†å…¶éšè—ã€‚
 */
.your-scrollable-element::-webkit-scrollbar {
    display: none; 
}
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    /* æ ¸å¿ƒä¿®æ”¹:ä¸å†ä½¿ç”¨ top,è€Œæ˜¯ç”¨ margin-top æ¥åˆ›é€ é—´è·,æ›´ç¨³å®š */
    top: 100%; 
    margin-top: 5px; /* <-- æ–°å¢:å‘ä¸‹æ¨å¼€5åƒç´ çš„è·ç¦» */
    left: 0;
    right: 0;
    max-height: 150px;
    overflow-y: auto;
    overflow-x: hidden;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px; /* <-- ä¿®æ”¹:å¢åŠ äº†ä¸Šä¸‹å’Œå·¦å³çš„å†…è¾¹è·,è®©æ¯ä¸€è¡Œæ›´é«˜æ›´å®½ */
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px; /* <-- æ–°å¢:å°†å­—ä½“å¤§å°ä»é»˜è®¤å€¼æ”¾å¤§åˆ°15px */
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    /* --- æ ¸å¿ƒä¿®æ­£ --- */
    font-size: var(--chat-font-size, 13px);
    /* --- ä¿®æ­£ç»“æŸ --- */
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }

/* â–¼â–¼â–¼ ç”¨è¿™å—ä»£ç æ›¿æ¢æ‰ä½ åŸæ¥çš„ .message-bubble .content æ ·å¼ â–¼â–¼â–¼ */
/* é€šç”¨å†…å®¹åŒºæ ·å¼,ä¸ºæ—¶é—´æˆ³å’Œå­—ä½“å¤§å°åšå‡†å¤‡ */
.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word; /* æ ¸å¿ƒä¿®æ­£: å¼ºåˆ¶é•¿å•è¯æˆ–URLæ¢è¡Œ,é˜²æ­¢æ’‘ç ´æ°”æ³¡ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */



        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ğŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color:var(--accent-color); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

/* â–¼â–¼â–¼ ã€ä¿®å¤ç‰ˆã€‘Persona Library Styles â–¼â–¼â–¼ */

/* 1. äººè®¾åº“ç½‘æ ¼æ ·å¼ (ä¿æŒä¸å˜) */
#persona-library-grid { 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 15px; 
    padding: 10px; 
}
.persona-preset-item { 
    aspect-ratio: 1 / 1; 
    border-radius: 12px; 
    background-size: cover; 
    background-position: center; 
    cursor: pointer; 
    transition: transform 0.2s, box-shadow 0.2s; 
    border: 1px solid rgba(0,0,0,0.1); 
}
.persona-preset-item:hover { 
    transform: scale(1.08); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
}

/* 2. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºäººè®¾ç¼–è¾‘å™¨å¼¹çª—å†…çš„å¤´åƒé¢„è§ˆè®¾ç½®å°ºå¯¸ */
#persona-editor-modal .avatar-upload img {
    width: 80px;  /* è®¾ç½®ä¸€ä¸ªåˆé€‚çš„å®½åº¦ */
    height: 80px; /* è®¾ç½®ä¸€ä¸ªåˆé€‚çš„é«˜åº¦ */
    border-radius: 50%; /* ç¡®ä¿å¤´åƒæ˜¯åœ†å½¢çš„ */
    object-fit: cover; /* ç¡®ä¿å›¾ç‰‡ä¸å˜å½¢ */
    border: 1px solid var(--border-color); /* ç»™ä¸€ä¸ªç»†è¾¹æ¡† */
}

/* 3. å¼¹çª—å³ä¸Šè§’æŒ‰é’®æ ·å¼ (ä¿æŒä¸å˜) */
.modal-header .action-button { 
    font-size: 16px; 
    color: var(--accent-color); 
    font-weight: 600; 
    cursor: pointer; 
    background: none; 
    border: none; 
    padding: 5px; 
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

/* è¿™æ˜¯ä½ è¦æ·»åŠ çš„æ–°æ ·å¼ */
#font-preview {
    transition: font-family 0.3s ease;}

/* â–¼â–¼â–¼ 3. ã€ä¿®æ­£ã€‘é˜²æ­¢é¡¶æ æ–‡å­—æŒ‰é’®æ¢è¡Œ (å‚è€ƒP4) â–¼â–¼â–¼ */
.header .action-btn,
.qzone-header .action-btn {
    white-space: nowrap; /* æ ¸å¿ƒ:å¼ºåˆ¶ä¸æ¢è¡Œ */
    flex-shrink: 0;      /* é˜²æ­¢æŒ‰é’®åœ¨ç©ºé—´ä¸è¶³æ—¶è¢«å‹ç¼© */
}
/* â–²â–²â–² 3. ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ 1. ã€ä¿®æ­£ã€‘å¼ºåˆ¶è®¾å®šâ€œç®¡ç†åˆ†ç±»â€æŒ‰é’®å­—ä½“å¤§å° â–¼â–¼â–¼ */
#manage-world-book-categories-btn {
    font-size: 13px !important;
}
/* â–²â–²â–² 1. ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©è®¾ç½®é¡µå¯ç¼–è¾‘æ–‡æœ¬å—æ ·å¼ â–¼â–¼â–¼ */
.editable-name-block {
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
    width: 100%;
}

/* é¼ æ ‡æ‚¬åœæ—¶ç»™ä¸€ä¸ªè§†è§‰åé¦ˆ */
.editable-name-block:hover {
    background-color: rgba(0, 0, 0, 0.04);
}
#phone-screen.dark-mode .editable-name-block:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.editable-name-block .label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    display: block; /* ç¡®ä¿æ ‡ç­¾ç‹¬å ä¸€è¡Œ */
    margin-bottom: 5px; /* æ ‡ç­¾å’Œå€¼ä¹‹é—´çš„é—´è· */
}

.editable-name-block .value {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
    /* å¤„ç†é•¿æ–‡æœ¬æ¢è¡Œ */
    white-space: pre-wrap;
    word-break: break-word;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸¸æˆåŠŸèƒ½æ ·å¼ (ä»è¿™é‡Œå¼€å§‹ç²˜è´´) â–¼â–¼â–¼ */

/* 1. æ¸¸æˆé€‰æ‹©é¢æ¿ (ç±»ä¼¼è¡¨æƒ…åŒ…é¢æ¿) */
#game-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(242, 242, 247, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-top: 1px solid var(--border-color);
    border-radius: 20px 20px 0 0;
    z-index: 200;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    visibility: hidden;
}
#game-panel.visible {
    transform: translateY(0);
    visibility: visible;
}
#phone-screen.dark-mode #game-panel {
    background-color: rgba(40, 40, 40, 0.9);
}

/* 2. æ¸¸æˆé¢æ¿å¤´éƒ¨ */
.game-panel-header {
    padding: 15px 20px;
    text-align: center;
    font-weight: 600;
    font-size: 16px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
    position: relative;
}
#phone-screen.dark-mode .game-panel-header {
    border-bottom-color: #38383a;
}
.game-panel-header .close-btn {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    color: var(--accent-color);
    cursor: pointer;
}

/* 3. æ¸¸æˆé€‰é¡¹ç½‘æ ¼ */
.game-options-grid {
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}
.game-option-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}
.game-option-item .icon-bg {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-color: #ffffff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 32px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}
.game-option-item:active .icon-bg {
    transform: scale(0.9);
}
.game-option-item .icon-bg img {
    width: 60%;
    height: 60%;
}
.game-option-item .label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
}
#phone-screen.dark-mode .game-option-item .icon-bg {
    background-color: #3e3e42;
}

/* â–¼â–¼â–¼ ã€æ¸¸æˆæ ·å¼ä¿®æ­£ç‰ˆã€‘è¯·ç”¨è¿™å—æ–°CSSæ›¿æ¢æ—§çš„ç¬¬4ã€5ã€6ã€7ç‚¹æ ·å¼ â–¼â–¼â–¼ */

/* 4. æ¸¸æˆäº‹ä»¶æ¶ˆæ¯çš„æ ·å¼ (ç±»ä¼¼æ‹ä¸€æ‹) */
.game-event-message {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    padding: 6px 14px;
    margin: 8px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 13px;
    border-radius: 12px;
    text-align: center;
    max-width: 90%;
}
#phone-screen.dark-mode .game-event-message {
    background-color: rgba(255, 255, 255, 0.15);
}

/* 5. æ¸¸æˆåç»­æ“ä½œæŒ‰é’®çš„å®¹å™¨ */
.game-actions-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 10px; /* ä¸ä¸Šæ–¹çš„ç»“æœæ–‡å­—æ‹‰å¼€è·ç¦» */
}

/* 6. å•ä¸ªæ“ä½œæŒ‰é’®çš„æ ·å¼ */
.game-action-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 18px; /* èƒ¶å›Šå½¢çŠ¶ */
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
}
.game-action-btn:active {
    transform: scale(0.95);
}
.game-action-btn.secondary {
    background-color: #f0f0f0;
    color: var(--text-primary);
}
#phone-screen.dark-mode .game-action-btn.secondary {
    background-color: #3e3e42;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åŠ¨æ€å¤šé€‰æ¨¡å¼æ ·å¼ â–¼â–¼â–¼ */

/* 1. ç»™å¸–å­å®¹å™¨æ·»åŠ ç›¸å¯¹å®šä½ï¼Œä»¥ä¾¿å®šä½è¦†ç›–å±‚ */
.qzone-post-container {
    position: relative;
    border-radius: 12px; /* ç¡®ä¿åœ†è§’èƒ½è£å‰ªè¦†ç›–å±‚ */
    overflow: hidden;
}

/* 2. é€‰ä¸­çŠ¶æ€çš„åŠé€æ˜è¦†ç›–å±‚ */
.qzone-post-container .selection-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.3); /* ä½¿ç”¨ä¸»é¢˜è“è‰²ä½œä¸ºè¦†ç›–è‰² */
    border: 3px solid var(--accent-color); /* æ·»åŠ ä¸€ä¸ªè“è‰²è¾¹æ¡†ï¼Œæ›´é†’ç›® */
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none; /* ç¡®ä¿ä¸ä¼šå¹²æ‰°ä¸‹å±‚å…ƒç´ çš„ç‚¹å‡» */
    z-index: 5; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}
.qzone-post-container.selected .selection-overlay {
    opacity: 1;
}

/* 3. è¦†ç›–å±‚ä¸Šçš„â€œâœ“â€å¯¹å‹¾å›¾æ ‡ */
.qzone-post-container .selection-overlay::after {
    content: 'âœ“';
    color: white;
    font-size: 48px;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* 4. åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œè®©æ•´ä¸ªå®¹å™¨çœ‹èµ·æ¥å¯ç‚¹å‡» */
.qzone-post-container.selection-mode {
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² (ç²˜è´´åˆ°è¿™é‡Œç»“æŸ) â–²â–²â–² */

/* â–¼â–¼â–¼ 1. ã€å…¨æ–°ã€‘æ¶ˆæ¯æ“ä½œèœå•ç¾åŒ– (å‚è€ƒP2) â–¼â–¼â–¼ */

/* a. è®©æŒ‰é’®å®¹å™¨æ¨ªå‘æ’åˆ— */
#message-actions-modal .custom-modal-footer {
    display: flex;
    flex-wrap: wrap; /* å…è®¸å¤šè¡Œæ’åˆ— */
    justify-content: space-around; /* å‡åŒ€åˆ†å¸ƒ */
    padding: 10px 5px;
    border-top: none; /* ç§»é™¤é¡¶éƒ¨åˆ†éš”çº¿ */
}

/* b. æ”¹é€ æ‰€æœ‰æŒ‰é’®,å˜ä¸ºâ€œä¸Šå›¾æ ‡ä¸‹æ–‡å­—â€çš„ç»“æ„ */
#message-actions-modal .custom-modal-footer button {
    flex: 1 0 20%; /* å¼¹æ€§å¸ƒå±€,ä¸€è¡Œæœ€å¤šæ”¾5ä¸ª */
    min-width: 40px; /* ä¿è¯æœ€å°å®½åº¦ */
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ—å›¾æ ‡å’Œæ–‡å­— */
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    padding: 10px 5px;
    border: none;
    background: none;
    color: #333; /* ç»Ÿä¸€æ–‡å­—é¢œè‰² */
    font-size: 9px; /* ç¼©å°æ–‡å­— */
    font-weight: normal;
    border-radius: 8px;
    transition: background-color 0.2s;
    margin-top: 0 !important; /* å¼ºåˆ¶ç§»é™¤å–æ¶ˆæŒ‰é’®çš„é¡¶éƒ¨è¾¹è· */
}
#phone-screen.dark-mode #message-actions-modal .custom-modal-footer button {
    color: #f0f0f0; /* å¤œé—´æ¨¡å¼æ–‡å­—é¢œè‰² */
}

/* c. é¼ æ ‡æ‚¬åœæ—¶å¢åŠ åé¦ˆæ•ˆæœ */
#message-actions-modal .custom-modal-footer button:hover {
    background-color: #f0f0f0;
}
#phone-screen.dark-mode #message-actions-modal .custom-modal-footer button:hover {
    background-color: #333;
}


/* d. ã€æ ¸å¿ƒã€‘ä½¿ç”¨ ::before ä¼ªå…ƒç´ æ·»åŠ SVGå›¾æ ‡ */
#message-actions-modal .custom-modal-footer button::before {
    content: '';
    width: 15px;
    height: 15px;
    background-color: #555; /* å›¾æ ‡é¢œè‰² */
    mask-repeat: no-repeat;
    mask-position: center;
    mask-size: contain;
    -webkit-mask-repeat: no-repeat;
    -webkit-mask-position: center;
    -webkit-mask-size: contain;
}
#phone-screen.dark-mode #message-actions-modal .custom-modal-footer button::before {
    background-color: #f0f0f0; /* å¤œé—´æ¨¡å¼å›¾æ ‡é¢œè‰² */
}

/* e. ä¸ºæ¯ä¸ªæŒ‰é’®æŒ‡å®šä¸åŒçš„å›¾æ ‡ (ä½¿ç”¨mask-image) */
#edit-message-btn::before {
    mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>');
}
#copy-message-btn::before {
    mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>');
}
#recall-message-btn::before {
    mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>');
}
#quote-message-btn::before {
    mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 2v6h3v4c0 2.25 1 4 2.5 4zM14 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 2v6h3v4c0 2.25 1 4 2.5 4z"></path></svg>');
}
#select-message-btn::before {
    mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>');
}

/* f. å•ç‹¬å¤„ç†â€œå–æ¶ˆâ€æŒ‰é’® */
#cancel-message-action-btn {
    background-color: #f0f0f0;
}
#phone-screen.dark-mode #cancel-message-action-btn {
    background-color: #333;
}
#cancel-message-action-btn::before {
    display: none; /* å–æ¶ˆæŒ‰é’®ä¸éœ€è¦å›¾æ ‡ */
}
/* â–²â–²â–² 1. ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–²â–²â–² ç²˜è´´åˆ°æ­¤ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºäº”å­—æ£‹æ·»åŠ â€œæ­£åœ¨è¾“å…¥â€æ ·å¼ (ç²˜è´´åˆ° <style> æœ«å°¾) â–¼â–¼â–¼ */
#ac-typing-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 15px;
    flex-shrink: 0;
}
.typing-dot {
    width: 8px;
    height: 8px;
    background-color: #ccc;
    border-radius: 50%;
    animation: typing-bounce 1.4s infinite ease-in-out both;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing-bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1.0); }
}
/* â–²â–²â–² æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©åˆ—è¡¨é¡µé¡¶éƒ¨ä¸‹æ‹‰èœå•æ ·å¼ === */

/* 1. ç»™æŒ‰é’®å®¹å™¨æ·»åŠ ç›¸å¯¹å®šä½,ä½œä¸ºèœå•çš„å®šä½åŸºå‡† */
.header .header-actions {
    position: relative;
}

/* 2. éšè—æ—§çš„â€œåˆ›å»ºç¾¤èŠâ€SVGå›¾æ ‡æŒ‰é’®,å› ä¸ºå®ƒå·²è¢«èœå•é¡¹æ›¿ä»£ */
#add-group-chat-btn {
    display: none !important;
}

/* 3. ä¸‹æ‹‰èœå•çš„å®¹å™¨æ ·å¼ */
#add-chat-menu {
    position: absolute;
    top: calc(100% + 10px); /* å®šä½åœ¨â€œ+â€æŒ‰é’®ä¸‹æ–¹,å¹¶ç•™å‡º10pxé—´è· */
    right: 5px;             /* é å³å¯¹é½ */
    width: 160px;           /* è®¾ç½®ä¸€ä¸ªåˆé€‚çš„å®½åº¦ */
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1); /* å‚è€ƒå›¾ç‰‡ä¸­çš„ç²¾è‡´é˜´å½± */
    z-index: 20; /* ç¡®ä¿èœå•åœ¨é¡¶å±‚ */
    padding: 5px; /* èœå•å†…éƒ¨çš„ç•™ç™½ */
    box-sizing: border-box;
    /* é»˜è®¤éšè—,JSä¼šæ§åˆ¶æ˜¾ç¤º/éšè—å’ŒåŠ¨ç”» */
    display: none; 
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    pointer-events: none;
}

#add-chat-menu.visible {
    display: block;
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

/* 4. ä½¿ç”¨ä¼ªå…ƒç´ åˆ›å»ºèœå•é¡¶éƒ¨æŒ‡å‘æŒ‰é’®çš„å°ä¸‰è§’ */
#add-chat-menu::before {
    content: '';
    position: absolute;
    top: -8px; /* å°†ä¸‰è§’å®šä½åˆ°èœå•çš„ä¸Šæ–¹ */
    right: 18px; /* è°ƒæ•´ä¸‰è§’çš„æ°´å¹³ä½ç½®,ä½¿å…¶å¯¹å‡†â€œ+â€æŒ‰é’® */
    width: 16px;
    height: 16px;
    background-color: #ffffff;
    transform: rotate(45deg); /* é€šè¿‡æ—‹è½¬ä¸€ä¸ªæ­£æ–¹å½¢æ¥åˆ›å»ºä¸‰è§’ */
    z-index: -1; /* ç¡®ä¿åœ¨èœå•å†…å®¹ä¹‹ä¸‹ */
}

/* 5. èœå•å†…æ¯ä¸ªé€‰é¡¹çš„æ ·å¼ */
.menu-item {
    display: flex;
    align-items: center;
    padding: 12px 10px;
    cursor: pointer;
    color: #1f1f1f;
    font-size: 16px;
    font-weight: 500;
    border-radius: 6px;
    transition: background-color 0.2s;
}

/* é¼ æ ‡æ‚¬åœæ—¶ç»™ä¸€ä¸ªåé¦ˆæ•ˆæœ */
.menu-item:hover {
    background-color: #f5f5f5;
}

/* èœå•é¡¹å†…éƒ¨å›¾æ ‡çš„æ ·å¼ */
.menu-icon {
    width: 22px;
    height: 22px;
    margin-right: 12px;
}

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ V2ã€‘å¼¹çª—å±‚çº§ç»Ÿä¸€ç®¡ç† â–¼â–¼â–¼ */

/* åŸºç¡€å¼¹çª—å±‚çº§ (èŠå¤©è®¾ç½®ç­‰) */
#chat-settings-modal, .modal {
    z-index: 100 !important;
}

/* ç¬¬ä¸€å±‚å¼¹çª— (å¤´åƒè®¾ç½®) */
#ai-avatar-editor-modal,
#my-avatar-editor-modal {
    z-index: 101 !important;
}

/* ç¬¬äºŒå±‚å¼¹çª— (äººè®¾åº“ / å¤´åƒæ¡†åº“ / AIå¤´åƒåº“) */
#persona-library-modal,
#avatar-frame-library-modal,
#ai-avatar-library-modal {
    z-index: 102 !important;
}

/* ç¬¬ä¸‰å±‚å¼¹çª— (äººè®¾ç¼–è¾‘ / é•¿æŒ‰æ“ä½œ / å¤´åƒæ¡†åº”ç”¨) */
#persona-editor-modal,
#preset-actions-modal,
#avatar-frame-apply-modal {
    z-index: 103 !important;
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ— è¾¹æ¡†æ¨¡å¼ç²¾è‡´åŒ–UIå¸ƒå±€ â–¼â–¼â–¼ */

/* --- 1. å…¨å±€å¾®è°ƒ & é¡¶æ /å¯¼èˆªæ ä¼˜åŒ– --- */

/* å½“å¤„äºæ— è¾¹æ¡†æ¨¡å¼æ—¶,åº”ç”¨ä»¥ä¸‹æ‰€æœ‰æ ·å¼ */
body:not(.bordered-mode) #phone-screen {
    /* æ ¸å¿ƒ:å¢å¤§å±å¹•åœ†è§’,è§†è§‰ä¸Šæ›´æŸ”å’Œ */
    border-radius: 0px; 
}

/* ç»Ÿä¸€è°ƒæ•´æ‰€æœ‰é¡¶æ ,è®©å…¶æ›´çº¤è–„ */
body:not(.bordered-mode) .header,
body:not(.bordered-mode) .qzone-header {
    padding-top: 20px; /* å‡å°å®‰å…¨åŒºå¤–çš„è¾¹è· */
    padding-bottom: 5px; /* å‡å°åº•éƒ¨å†…è¾¹è· */
    min-height: 64px;    /* è®¾å®šä¸€ä¸ªæœ€å°é«˜åº¦,é˜²æ­¢å†…å®¹è¢«è¿‡åº¦å‹ç¼© */
    box-sizing: border-box;
}

/* è°ƒæ•´åº•éƒ¨å¯¼èˆªæ ,ä½¿å…¶æ›´ç²¾è‡´å¹¶å¢å¤§åœ†è§’ */
body:not(.bordered-mode) #chat-list-bottom-nav {
    padding-top: 8px;
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
    border-top-left-radius: 0px;  /* å¢å¤§åœ†è§’ */
    border-top-right-radius: 0px; /* å¢å¤§åœ†è§’ */
}
body:not(.bordered-mode) .nav-item {
    padding-top: 8px; /* å‡å°å†…éƒ¨å…ƒç´ çš„ä¸Šä¸‹è¾¹è· */
    padding-bottom: 8px;
    font-size: 12px; /* é€‚å½“ç¼©å°å¯¼èˆªæ–‡å­— */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¿ä¸‹æ¨¡å¼ç»“æŸæŒ‰é’®æ–‡æœ¬åŒ–æ ·å¼ â–¼â–¼â–¼ */
#end-offline-mode-btn {
    /* 1. è¦†ç›–æ‰åœ†å½¢æŒ‰é’®çš„å°ºå¯¸ */
    width: auto; /* å®½åº¦ç”±å†…å®¹è‡ªåŠ¨å†³å®š */
    height: 50px; /* é«˜åº¦å¯ä»¥å°ä¸€ç‚¹ */
    border-radius: 25px; /* åœ†è§’çŸ©å½¢(èƒ¶å›Šå½¢çŠ¶) */
    background-color: #d7f0ff; /* ä½¿ç”¨ä¸€ä¸ªæ¼‚äº®çš„è“è‰²ä½œä¸ºèƒŒæ™¯ */

    /* 2. ç§»é™¤èƒŒæ™¯å›¾æ ‡ */
    background-image: none !important;

    /* 3. ä¸ºæ–‡å­—æ·»åŠ å†…è¾¹è·,è®©å®ƒä¸è´´è¾¹ */
    padding-left: 20px;
    padding-right: 20px;

    /* 4. è®¾ç½®æ–‡å­—æ ·å¼ */
    font-size: 15px;
    font-weight: 600;
    color: white;
    white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆæ•´åˆç‰ˆ V5 - å®¹å™¨æ ·å¼æ³•ã€‘åŠ¨æ€é¡µé¢ç»ˆæç¾åŒ–å¸ƒå±€ â–¼â–¼â–¼ */

/* --- 1. æ•´ä½“ä¸é¡¶éƒ¨æµ®åŠ¨æ  (ä¿æŒä¸å˜) --- */
#phone-screen:has(#qzone-screen.active) #status-bar,
#phone-screen:has(#qzone-screen.active) #qzone-screen > .qzone-header {
    display: none !important;
}

.qzone-floating-header {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    z-index: 20 !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    padding: 15px 20px !important;
    padding-top: calc(15px + env(safe-area-inset-top)) !important;
    box-sizing: border-box !important;
}

.top-right-cluster {
    display: flex !important;
    flex-direction: column !important;
    align-items: flex-end !important;
    gap: 8px !important;
}

/* --- 2. ã€ã€ã€æ ¸å¿ƒä¿®å¤åŒºã€‘ã€‘ã€‘ --- */

/* a. è¿”å›æŒ‰é’® (ä¿æŒä¸å˜) */
.qzone-floating-header .back-btn { background-color: transparent !important; color: white !important; width: 32px !important; height: 32px !important; border-radius: 50% !important; display: flex !important; justify-content: center !important; align-items: center !important; font-size: 24px !important; cursor: pointer !important; text-shadow: 0 1px 3px rgba(0,0,0,0.4) !important; }

/* b. ã€å…¨æ–°ã€‘ä¸ºæ‰€æœ‰æŒ‰é’®çš„çˆ¶å®¹å™¨è®¾ç½®åŸºç¡€æ ·å¼ */
#qzone-normal-actions, #qzone-edit-actions {
    display: flex;
    align-items: center;
    background-color: rgba(240, 240, 240, 0.1) !important; /* ç»Ÿä¸€çš„åŠé€æ˜æµ…ç°è‰²èƒŒæ™¯ */
    border-radius: 16px !important; /* ç»Ÿä¸€çš„èƒ¶å›Šåœ†è§’ */
    padding: 2px !important; /* ç»™å®¹å™¨ä¸€ç‚¹å†…è¾¹è·ï¼Œè®©æŒ‰é’®çœ‹èµ·æ¥æ›´åè°ƒ */
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
}

/* c. ã€å…¨æ–°ã€‘ä¸ºå®¹å™¨å†…éƒ¨çš„æ‰€æœ‰æŒ‰é’®è®¾ç½®ç»Ÿä¸€æ ·å¼ */
#qzone-normal-actions .action-btn,
#qzone-edit-actions .action-btn {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #333 !important; /* ç»Ÿä¸€çš„æ·±è‰²æ–‡å­— */
    background-color: transparent !important; /* æŒ‰é’®æœ¬èº«èƒŒæ™¯é€æ˜ */
    border: none !important;
    padding: 6px 6px !important; /* æŒ‰é’®çš„å†…è¾¹è· */
    cursor: pointer !important;
    white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
}

/* d. å•ç‹¬ä¸ºâ€œåˆ é™¤â€æŒ‰é’®è®¾ç½®çº¢è‰²æ–‡å­— */
#qzone-delete-selected-btn {
    color: #ff3b30 !important;
}

/* --- 3. ä¸ªäººèµ„æ–™ä¸èƒŒæ™¯å¸ƒå±€ (ä¿æŒä¸å˜) --- */
.qzone-profile-header { padding-bottom: 0 !important; margin-bottom: 0 !important; }
.qzone-banner-container { height: 280px !important; position: relative !important; }
.qzone-user-info { display: block !important; text-align: center !important; padding: 0 20px !important; margin-top: -170px !important; position: relative !important; z-index: 5 !important; }
.qzone-avatar-container { margin: 0 auto 6px auto !important; display: inline-block !important; position: relative !important; }
.qzone-banner-container::after { content: '' !important; position: absolute !important; bottom: -1px !important; left: 0 !important; width: 100% !important; height: 120px !important; background: linear-gradient(to top, #ffffff, rgba(255, 255, 255, 0)) !important; }
#phone-screen.dark-mode .qzone-banner-container::after { background: linear-gradient(to top, #000000, rgba(0, 0, 0, 0)) !important; }
#qzone-avatar-img { width: 90px !important; height: 90px !important; border-width: 4px !important; }
.qzone-user-details { display: block !important; width: 100% !important; }
#qzone-nickname { font-size: 22px !important; font-weight: 700 !important; color: var(--text-primary) !important; text-shadow: 0 1px 3px rgba(0,0,0,0.3) !important; cursor: pointer !important; text-align: center !important; margin: 0 !important; }
#qzone-signature { font-size: 14px !important; color: var(--text-secondary) !important; margin: 5px 0 0 0 !important; cursor: pointer !important; text-align: center !important; }
#qzone-visitor-info { font-size: 12px !important; color: white !important; background-color: rgba(0, 0, 0, 0.25) !important; backdrop-filter: blur(5px) !important; -webkit-backdrop-filter: blur(5px) !important; border-radius: 12px !important; padding: 4px 10px !important; cursor: pointer !important; gap: 6px !important; align-items: center !important; display: inline-flex !important; }

/* --- 4. åŠŸèƒ½æ ä¸å¸–å­åˆ—è¡¨ (ä¿æŒä¸å˜) --- */
.qzone-actions-bar { margin: 10px 15px 20px 15px !important; background-color: transparent !important; box-shadow: none !important; }
.qzone-post-container { border-bottom: 1px solid #e9e9e9 !important; background-color: transparent !important; }
#phone-screen.dark-mode .qzone-post-container { border-bottom-color: #2c2c2e !important; }
#qzone-posts-list .qzone-post-container:last-child { border-bottom: none !important; }
.qzone-post-item { padding: 15px 15px 0 15px !important; background-color: var(--secondary-bg) !important; border: none !important; position: relative !important; z-index: 2 !important; }
#phone-screen.dark-mode .qzone-post-item { background-color: #000000 !important; }

/* --- 5. è¯„è®ºåŒºç­‰ (ä¿æŒä¸å˜) --- */
.post-likes-section, .post-comments-container { background-color: transparent !important; padding: 0 !important; margin: 10px 0 0 0 !important; border: none !important; }
.post-footer { position: relative !important; margin-top: 15px !important; padding-bottom: 15px !important; border-top: none !important;}
.comment-section .comment-avatar { position: absolute !important; left: 10px !important; top: 50% !important; transform: translateY(-50%) !important; z-index: 5 !important; width: 32px !important; height: 32px !important;}
.comment-input { background-color: #f0f2f5 !important; border-radius: 18px !important; padding: 10px 15px 10px 50px !important; font-size: 14px !important; width: 100% !important; box-sizing: border-box !important;}
#phone-screen.dark-mode .comment-input { background-color: #2c2c2e !important; }
.qzone-post-delete-action span { background-color: #ff3b30; color: white; padding: 8px 15px; border-radius: 20px; }
.action-item { color: var(--text-secondary) !important; }
.action-item:not(:last-child)::after { height: 16px !important; background-color: var(--border-color) !important; }

/* â–²â–²â–² æœ€ç»ˆç‰ˆCSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¿ä¸‹æ¨¡å¼å›¾æ ‡ç¾åŒ– â–¼â–¼â–¼ */

/* ä¸“é—¨ä¸ºçº¿ä¸‹æ¨¡å¼çš„â€œè¡ŒåŠ¨â€æŒ‰é’®è®¾ç½®æ–°çš„å›¾æ ‡å’Œé¢œè‰² */
#user-offline-action-btn {
    background-color: #ffd7e6; /* ä½¿ç”¨ä¸€ä¸ªæ¼‚äº®çš„è“è‰²ä½œä¸ºèƒŒæ™¯ */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>');
    background-size: 60%; /* è°ƒæ•´æ˜Ÿæ˜Ÿçš„å¤§å° */
    width: 40px; /* å®½åº¦ç”±å†…å®¹è‡ªåŠ¨å†³å®š */
    height: 40px; /* é«˜åº¦å¯ä»¥å°ä¸€ç‚¹ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* --- 2. çŠ¶æ€æ  & ç”µæ± å›¾æ ‡ç¼©å° --- */

/* è°ƒæ•´çŠ¶æ€æ çš„å­—ä½“å’Œä½ç½® */
body:not(.bordered-mode) #status-bar {
    font-size: 13px; /* ç¼©å°çŠ¶æ€æ å­—ä½“ */
    padding-top: calc(8px + env(safe-area-inset-top));
}

/* ç¼©å°ç”µæ± å›¾æ ‡å®¹å™¨å’Œé—´è· */
body:not(.bordered-mode) .battery-container {
    gap: 4px; /* å‡å°å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    transform: scale(0.7); /* æ•´ä½“ç¼©å° */
}


/* --- 3. èŠå¤©ç•Œé¢UIå…ƒç´ è°ƒæ•´ --- */

/* ç¼©å°èŠå¤©è¾“å…¥åŒºçš„é¡¶éƒ¨å¿«æ·æ“ä½œå›¾æ ‡ */
body:not(.bordered-mode) .chat-action-icon-btn {
    width: 25px;   /* ç¼©å°å°ºå¯¸ */
    height: 25px;
    font-size: 25px; /* ç¼©å°å†…éƒ¨å›¾æ ‡å­—ä½“å¤§å° */
}

/* è®©è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®æ›´åè°ƒ */
body:not(.bordered-mode) #chat-input {
    padding: 8px 15px; /* å‡å°è¾“å…¥æ¡†çš„å‚ç›´å†…è¾¹è· */
}
body:not(.bordered-mode) #send-btn,
body:not(.bordered-mode) #wait-reply-btn {
    height: 36px; /* é™ä½å‘é€æŒ‰é’®çš„é«˜åº¦ */
    padding: 0 12px;
}

/* è°ƒæ•´èŠå¤©æ°”æ³¡å†…å¤´åƒçš„å¤§å°å’Œåœ†è§’ */
body:not(.bordered-mode) .message-bubble .avatar {
    width: 36px;
    height: 36px;
    border-radius: 10px; /* å¢å¤§åœ†è§’,ä½¿å…¶æ›´åƒiOSé£æ ¼ */
}


/* --- 4. ç»Ÿä¸€æ‰€æœ‰é¡¶æ æŒ‰é’®çš„é£æ ¼ --- */

/* ç»Ÿä¸€è°ƒæ•´è¿”å›æŒ‰é’®å’Œæ“ä½œæŒ‰é’® */
body:not(.bordered-mode) .header .back-btn,
body:not(.bordered-mode) .header .action-btn {
    color: var(--theme-top-bar-text); /* ç¡®ä¿é¢œè‰²è·Ÿéšä¸»é¢˜æ–‡å­—é¢œè‰² */
    font-size: 22px; /* è°ƒæ•´å›¾æ ‡å­—ä½“å¤§å° */
    padding: 4px;
}

/* ä¸“é—¨é’ˆå¯¹SVGå›¾æ ‡æŒ‰é’®è¿›è¡Œç¼©æ”¾ */
body:not(.bordered-mode) .header .action-btn svg {
    width: 25px;
    height: 25px;
}

/* ä¸“é—¨è°ƒæ•´ "+" å·è¿™ç±»æ–‡å­—æŒ‰é’®,ä½¿å…¶æ›´ç²¾è‡´ */
body:not(.bordered-mode) .header #add-chat-btn,
body:not(.bordered-mode) .header #add-world-book-btn,
body:not(.bordered-mode) .header #create-album-btn-page {
    font-size: 28px;
    font-weight: 300; /* ä½¿ç”¨æ›´ç»†çš„å­—é‡ */
    position: relative;
    top: -1px;
}

/* è°ƒæ•´â€œä¿å­˜â€ã€â€œç¼–è¾‘â€è¿™ç±»æ–‡å­—æŒ‰é’®çš„å­—ä½“å¤§å° */
body:not(.bordered-mode) .header .save-btn,
body:not(.bordered-mode) #favorites-edit-btn,
body:not(.bordered-mode) .selection-controls .action-btn {
    font-size: 15px; /* ç»Ÿä¸€å­—ä½“å¤§å° */
}


/* --- 5. ä¿®æ­£ç§»åŠ¨ç«¯å­—ä½“ä¸å¸ƒå±€æ’åˆ— --- */

/* å¾®è°ƒèŠå¤©åˆ—è¡¨é¡¹çš„å­—ä½“å’Œé—´è·,é˜²æ­¢å†…å®¹æ‹¥æŒ¤ */
body:not(.bordered-mode) .chat-list-item .name {
    font-size: 16px; /* ç¨å¾®ç¼©å°åå­—å­—ä½“ */
}
body:not(.bordered-mode) .chat-list-item .last-msg {
    font-size: 13px;
    max-width: 95%; /* ç¡®ä¿ç»™æ—¶é—´æˆ³ç•™å‡ºç©ºé—´ */
}

/* è°ƒæ•´åŠ¨æ€(QZone)é¡µé¢çš„å­—ä½“,ä½¿å…¶æ›´å’Œè° */
body:not(.bordered-mode) .qzone-nickname {
    font-size: 16px;
}
body:not(.bordered-mode) .action-item {
    font-size: 14px;
}
body:not(.bordered-mode) .post-nickname {
    font-size: 14px;
}
body:not(.bordered-mode) .post-content,
body:not(.bordered-mode) .comment-text {
    font-size: 14px;
    line-height: 1.55; /* ä¼˜åŒ–é˜…è¯»è¡Œé«˜ */
}
body:not(.bordered-mode) .comment-input {
    font-size: 13px;
}

/* â–²â–²â–² ç²˜è´´åˆ°æ­¤ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å·²ä¿å­˜çš„æ°”æ³¡ä¸»é¢˜åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
.saved-bubble-theme-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .saved-bubble-theme-item {
    background-color: #2c2c2e;
}
.saved-bubble-theme-item .theme-name {
    font-weight: 500;
}
.saved-bubble-theme-item .theme-actions button {
    margin-left: 8px;
    padding: 4px 10px;
    font-size: 12px;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
}
#phone-screen.dark-mode .saved-bubble-theme-item .theme-actions button {
    background-color: #3e3e42;
    border-color: #555;
    color: #fff;
}
.saved-bubble-theme-item .theme-actions .apply-btn {
    border-color: var(--accent-color);
    color: var(--accent-color);
}
.saved-bubble-theme-item .theme-actions .delete-btn {
    border-color: #ff3b30;
    color: #ff3b30;
}
/* â–²â–²â–² æ–°å¢æ ·å¼ç»“æŸ â–²â–²â–² */

/* === èŠå¤©åˆ—è¡¨ç•Œé¢æ–°å¢æ ·å¼ (è¿™æ˜¯æ–°æ·»åŠ çš„) === */
#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}

/* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
#chat-list-bottom-nav {
    position: absolute; /* è®©å®ƒå›ºå®šåœ¨åº•éƒ¨ */
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 15; /* ç¡®ä¿å®ƒåœ¨è§†å›¾ä¹‹ä¸Š */
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}

/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ®µã€‘æ–°ä»£ç ï¼Œæ›¿æ¢æ—§çš„ #qzone-screen â–¼â–¼â–¼ */
#qzone-screen {
    background-color: #ffffff !important; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘èƒŒæ™¯è‰²æ”¹ä¸ºçº¯ç™½è‰² */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.qzone-header {
    /* position: absolute;  <-- æŠŠè¿™ä¸ªæ”¹æˆ relative */
    position: relative;
    z-index: 10; /* z-index ä¿æŒ,æˆ–è€…å¯ä»¥æ›´é«˜ */
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { /* "å¥½å‹åŠ¨æ€"æ–‡å­— */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    /* padding-top: 80px;  <-- åˆ é™¤è¿™ä¸ª,å› ä¸ºheaderä¸å†æ˜¯absoluteäº† */
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; /* èƒŒæ™¯æ¿é«˜åº¦ */
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .qzone-user-info â–¼â–¼â–¼ */
.qzone-user-info {
    /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç§»é™¤flexå¸ƒå±€ï¼Œæ”¹ä¸ºé»˜è®¤çš„å—çº§å¸ƒå±€ï¼Œå¹¶è®©å†…å®¹å±…ä¸­ */
    display: block;
    text-align: center;
    
    padding: 0 5px !important;
    margin-top: -185px !important; /* ä¿æŒå‘ä¸Šææ‹‰çš„æ•ˆæœ */
    position: relative;
    z-index: 5;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ #qzone-avatar-container â–¼â–¼â–¼ */
.qzone-avatar-container {
    margin: 0 auto 6px auto !important;/* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤å³è¾¹è·ï¼Œæ”¹ä¸ºè‡ªåŠ¨æ°´å¹³å±…ä¸­ï¼Œå¹¶å¢åŠ ä¸‹è¾¹è· */
    display: inline-block; /* ç¡®ä¿margin: autoç”Ÿæ•ˆ */
    position: relative; /* ç¡®ä¿z-indexç”Ÿæ•ˆ */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ #qzone-avatar-img â–¼â–¼â–¼ */
#qzone-avatar-img {
    width: 90px !important;
    height: 90px !important;
    border-radius: 50% !important;
    background-color: rgba(255,255,255,1) !important;
    /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ç§»é™¤æˆ–æ³¨é‡Šæ‰è¾¹æ¡†å±æ€§ */
    border: none !important; 
    
    /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ·»åŠ ä¸€ä¸ªæŸ”å’Œçš„é˜´å½±æ¥ä»£æ›¿è¾¹æ¡† */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    
    object-fit: cover !important;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 0px; /* å¾®è°ƒä½ç½® */
}

/* ç¼–è¾‘æŒ‰é’®çš„é€šç”¨æ ·å¼ */
.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; /* ä¸æ˜µç§°çš„é—´è· */
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; /* è„±ç¦»flexå¸ƒå±€çš„å¯¹é½ */
    bottom: 5px; /* å¾®è°ƒå‚ç›´ä½ç½® */
}

/* === è®©ç¼–è¾‘åŠŸèƒ½æ›´â€œéšå½¢â€ === */
#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»æ‰‹åŠ¿ */
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; /* æ‚¬åœæ—¶ç¨å¾®å˜æš—,ç»™ç”¨æˆ·åé¦ˆ */
}
/* éšè—æ‰æ—§çš„ã€ç‹¬ç«‹çš„ç¼–è¾‘æŒ‰é’® */
.qzone-edit-btn {
    display: none;
}

/* === æ§åˆ¶ Header å’Œ Bottom Nav çš„æ˜¾éš === */
/* é»˜è®¤éšè—åŠ¨æ€ç•Œé¢çš„ Header */
#qzone-screen .qzone-header {
    display: none;
}
/* å½“åŠ¨æ€è§†å›¾æ¿€æ´»æ—¶,æ˜¾ç¤ºå®ƒçš„Header */
#qzone-screen.active .qzone-header {
    display: flex;
}

/* å½“è¿›å…¥åŠ¨æ€è§†å›¾æ—¶,éšè—ä¸»Headerå’Œåº•éƒ¨å¯¼èˆªæ  */
#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-list-item:first-child,
.chat-group-container:first-child {
    margin-top: 5px; 
}

/* â–²â–²â–² æ–°æ ·å¼æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ å…¨æ–°:ä¸»å±å¹•é»‘èƒ¶+å›¾æ ‡ç½‘æ ¼å¸ƒå±€æ ·å¼ â–¼â–¼â–¼ */

/* 1. å®šä¹‰æ—‹è½¬åŠ¨ç”» */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 2. ä¿®æ”¹ #app-grid ä¸ºæ–°çš„ flex å®¹å™¨ */
#app-grid.new-home-layout {
    flex-direction: row; /* è®©å­å…ƒç´ æ°´å¹³æ’åˆ— */
    align-items: center; /* å‚ç›´å±…ä¸­ */
    justify-content: center; /* æ°´å¹³å±…ä¸­ */
    gap: 20px; /* å·¦å³ä¸¤å—çš„é—´è· */
    padding: 0 20px; /* ç»™å·¦å³ä¸€äº›è¾¹è· */
}

/* â–¼â–¼â–¼ ç”¨è¿™æ•´å—æ–°æ ·å¼,æ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ vinyl-player å’Œ vinyl-record-img æ ·å¼ â–¼â–¼â–¼ */

/* 6. å³ä¾§ 2x2 å›¾æ ‡ç½‘æ ¼å®¹å™¨ */
.right-app-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* åˆ›å»ºä¸€ä¸ªä¸¤åˆ—çš„ç½‘æ ¼ */
    gap: 20px; /* å›¾æ ‡ä¹‹é—´çš„é—´è· */
}

/* 7. å¾®è°ƒåŸæœ‰çš„ .app-row (ç”±äºHTMLç»“æ„æ”¹å˜,è¿™ä¸ªæ ·å¼ä¸å†éœ€è¦,å¯ä»¥åˆ é™¤æˆ–å¿½ç•¥) */
.app-row {
   /* è¿™ä¸ªæ ·å¼åœ¨æ–°çš„å¸ƒå±€ä¸‹å·²å¤±æ•ˆ */
}

/* 8. ç¡®ä¿å›¾æ ‡åœ¨ç½‘æ ¼ä¸­æ­£å¸¸æ˜¾ç¤º (é€šå¸¸ä¸éœ€è¦ä¿®æ”¹,ä½†ä»¥é˜²ä¸‡ä¸€) */
#app-grid.new-home-layout .app-icon {
    margin: 0; /* ç§»é™¤ä»»ä½•å¯èƒ½å½±å“ç½‘æ ¼å¸ƒå±€çš„å¤–è¾¹è· */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¡®ä¿AIç”Ÿæˆçš„HTMLæ¨¡å—èƒ½æ­£ç¡®å±…ä¸­ â–¼â–¼â–¼ */
.message-bubble .content > div {
    margin-left: auto;
    margin-right: auto;
}
/* â–²â–²â–² æ–°å¢CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠæ‰€æœ‰è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === åŠ¨æ€åŠŸèƒ½æ æ ·å¼ === */
.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; /* ä¸Šè¾¹è·æ›´å¤§,ä¸ºæµ®åŠ¨çš„å¤´åƒç•™å‡ºç©ºé—´ */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}

/* ç”¨ä¼ªå…ƒç´ åˆ›å»ºåˆ†éš”çº¿ */
.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}

/* === åŠ¨æ€å¸–å­åˆ—è¡¨æ ·å¼ === */
#qzone-posts-list {
    padding: 0 15px 20px 15px; /* å·¦å³å’Œåº•éƒ¨ç•™å‡ºè¾¹è· */
    display: flex;
    flex-direction: column;
    gap: 20px; /* å¸–å­ä¹‹é—´çš„é—´è· */
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; /* è®©æ¢è¡Œç¬¦ç”Ÿæ•ˆ */
    word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ç²˜è´´åˆ°æœ«å°¾ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†æ ·å¼ === */
#post-public-text {
    min-height: 80px; /* ç¡®ä¿æ–‡æœ¬åŸŸæœ‰è¶³å¤Ÿçš„é«˜åº¦ */
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; /* ä¿æŒ16:9çš„é¢„è§ˆæ¯”ä¾‹ */
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; /* ä¸Šä¼ åæ˜¾ç¤º */
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æ–°æ ·å¼ â–¼â–¼â–¼ */

/* === å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡† - æ¨¡å¼åˆ‡æ¢æ ·å¼ === */
.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none; /* é»˜è®¤éƒ½éšè— */
}

.post-mode-content.active {
    display: block; /* æ¿€æ´»çš„æ‰æ˜¾ç¤º */
}

/* â–²â–²â–² æ–°æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ç¬¬1æ­¥:å°†è¿™å—CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
/* === ã€å…¨æ–°ã€‘æ—¥å†ç¡®è®¤å¼¹çª—æŒ‰é’®ç¾åŒ– === */
#custom-modal-footer button#custom-modal-cancel {
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰² */
    font-weight: bold;
    font-size: 22px; /* æ”¾å¤§ç¬¦å· */
    line-height: 1;
}
#custom-modal-footer button#custom-modal-confirm.confirm-check {
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¢˜å¼ºè°ƒè‰² */
    font-weight: bold;
    font-size: 22px; /* æ”¾å¤§ç¬¦å· */
    line-height: 1;
}
/* â–²â–²â–² CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€ç¬¬2æ­¥ã€‘ç”¨è¿™æ•´å—æ–°CSS,æ›¿æ¢æ—§çš„ .cute-event-viewer-content ç›¸å…³æ ·å¼ â–¼â–¼â–¼ */

/* === å¯çˆ±çš„æ—¥å†äº‹ä»¶æŸ¥çœ‹å™¨æ ·å¼ (V2ç‰ˆ) === */
#cute-event-viewer-modal .cute-event-viewer-content {
    background-color: #fffaf0;
    width: 290px;
    border-radius: 16px;
    border-top: 6px solid #f6ad55;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    padding: 20px 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    font-family: 'bulangni', sans-serif;
}

.cute-event-header { margin-bottom: 10px; }
.cute-event-icon { font-size: 28px; line-height: 1; }
.cute-event-title { font-size: 20px; font-weight: 600; color: #a56707; margin: 0 0 12px 0; }
.cute-event-meta {
    font-size: 11px; color: #b79452; margin-bottom: 18px;
    padding-bottom: 10px; border-bottom: 1px dashed rgba(165, 103, 7, 0.2); width: 100%;
}
.cute-event-memo {
    font-size: 14px; line-height: 1.7; color: #6d4c41; white-space: pre-wrap;
    word-break: break-word; text-align: left; width: 100%; margin-bottom: 25px;
    background-color: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 8px;
    max-height: 150px; /* å¢åŠ æœ€å¤§é«˜åº¦å’Œæ»šåŠ¨æ¡ */
    overflow-y: auto;
}
/* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºåº•éƒ¨æ“ä½œæ å’ŒæŒ‰é’®æ·»åŠ æ ·å¼ */
.cute-event-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    gap: 10px;
}
.cute-event-action-btn {
    flex: 1; /* è®©æŒ‰é’®å¹³åˆ†å®½åº¦ */
    background: none;
    border: 2px solid;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.cute-event-action-btn.danger {
    color: #ef4444;
    border-color: #ef4444;
}
.cute-event-action-btn.danger:hover {
    background-color: #ef4444;
    color: white;
}
.cute-event-action-btn:not(.danger):not(.secondary) { /* ç¼–è¾‘æŒ‰é’® */
    color: #f6ad55;
    border-color: #f6ad55;
}
.cute-event-action-btn:not(.danger):not(.secondary):hover {
    background-color: #f6ad55;
    color: white;
}
.cute-event-action-btn.secondary { /* å…³é—­æŒ‰é’® */
    color: #a1887f;
    border-color: #d7ccc8;
}
.cute-event-action-btn.secondary:hover {
    background-color: #d7ccc8;
    color: #5d4037;
}

/* â–²â–²â–² CSSæ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¡¨æƒ…åŒ…æ‰¹é‡ç®¡ç†æ ·å¼ â–¼â–¼â–¼ */
.sticker-item.in-selection-mode {
    cursor: pointer;
}

/* é€‰æ‹©æ¡†çš„é»˜è®¤æ ·å¼ */
.sticker-item.in-selection-mode::after {
    content: '';
    position: absolute;
    top: 5px;
    right: 5px;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.8);
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

/* é€‰ä¸­åçš„æ ·å¼ */
.sticker-item.in-selection-mode.selected::after {
    background-color: var(--accent-color);
    border-color: white;
    content: 'âœ”';
    color: white;
    font-size: 14px;
    font-weight: bold;
    text-align: center;
    line-height: 20px;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ç›¸å†Œé¡µé¢èƒŒæ™¯è‰² === */
#album-screen {
    background-color: #f0f2f5; /* ä½¿ç”¨ä¸€ä¸ªæŸ”å’Œçš„æµ…ç°è‰²,æ¯”çº¯ç™½æ›´æŠ¤çœ¼ */
}

/* === ç›¸å†Œé¡µé¢ç½‘æ ¼å¸ƒå±€ === */
#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* æ¯è¡Œæ˜¾ç¤º2ä¸ªç›¸å†Œ */
    gap: 15px;
}

/* === ç›¸å†Œé¡¹ç›®æ ·å¼ (ç¾åŒ–) === */
.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; /* ç»™æ•´ä¸ªé¡¹ç›®ä¹ŸåŠ ä¸ªåœ†è§’ */
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1; /* ä¿æŒå°é¢ä¸ºæ­£æ–¹å½¢ */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; /* å°é¢åŠ è½½å‰çš„å ä½é¢œè‰² */
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é˜²æ­¢é•¿åå­—æ¢è¡Œ */
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}

/* â–²â–²â–² æ–°çš„ CSS ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€ä¸Šä¸‹å¸ƒå±€ç‰ˆã€‘ä¸Šä¸‹æ–‡æ¶ˆæ¯æ“ä½œèœå•æ ·å¼ (V3) â–¼â–¼â–¼ */

/* 1. èœå•å®¹å™¨ */
#message-actions-menu {
    position: absolute; 
    z-index: 250; 
    background-color: rgba(249, 249, 249, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    display: flex;
    padding: 0px 0px; /* è°ƒæ•´å†…è¾¹è· */
    
    opacity: 0;
    transform: translateY(10px) scale(0.95);
    visibility: hidden;
    transition: opacity 0.15s ease-out, transform 0.15s ease-out, visibility 0.15s;
    pointer-events: none;
}
#message-actions-menu.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
    visibility: visible;
    pointer-events: auto;
}
#phone-screen.dark-mode #message-actions-menu {
    background-color: rgba(50, 50, 52, 0.95);
}

/* 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘èœå•é¡¹æ”¹ä¸ºå‚ç›´å¸ƒå±€ */
.context-menu .menu-item {
    padding: 8px 10px; /* è°ƒæ•´å†…è¾¹è· */
    display: flex;
    flex-direction: column; /* <<<<<<< æ ¸å¿ƒï¼šæ”¹ä¸ºå‚ç›´æ’åˆ— */
    align-items: center;    /* <<<<<<< æ ¸å¿ƒï¼šæ°´å¹³å±…ä¸­ */
    gap: 6px;               /* <<<<<<< æ ¸å¿ƒï¼šå›¾æ ‡å’Œæ–‡å­—çš„å‚ç›´é—´è· */
    font-size: 10px;        /* <<<<<<< æ ¸å¿ƒï¼šç¼©å°å­—ä½“ */
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    border-radius: 8px;
    transition: background-color 0.2s;
    white-space: nowrap; 
}
.context-menu .menu-item:hover {
    background-color: rgba(0,0,0,0.05);
}
#phone-screen.dark-mode .context-menu .menu-item:hover {
    background-color: rgba(255,255,255,0.1);
}

/* 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒæ•´å›¾æ ‡å°ºå¯¸ */
.context-menu .icon {
    width: 15px;   /* <<<<<<< æ ¸å¿ƒï¼šå¢å¤§å›¾æ ‡å°ºå¯¸ */
    height: 15px;  /* <<<<<<< æ ¸å¿ƒï¼šå¢å¤§å›¾æ ‡å°ºå¯¸ */
    background-color: #333; 
    -webkit-mask-size: contain;
    mask-size: contain;
    -webkit-mask-position: center;
    mask-position: center;
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
}
#phone-screen.dark-mode .context-menu .icon {
    background-color: #f0f0f0;
}

/* 4. å›¾æ ‡SVGå½¢çŠ¶ (ä¿æŒä¸å˜) */
.context-menu .icon.edit   { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>'); }
.context-menu .icon.copy   { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>'); }
.context-menu .icon.recall { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8v4l-4 2"/></svg>'); }
.context-menu .icon.quote  { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 2v6h3v4c0 2.25 1 4 2.5 4zM14 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 2v6h3v4c0 2.25 1 4 2.5 4z"></path></svg>'); }
.context-menu .icon.select { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>'); }
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ç›¸å†Œç…§ç‰‡è¯¦æƒ…é¡µ === */
#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    /* æ¯è¡Œæ˜¾ç¤º3å¼ ç…§ç‰‡,å¹¶ä¿æŒé—´è· */
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
    aspect-ratio: 1 / 1; /* ä¿æŒç…§ç‰‡ä¸ºæ­£æ–¹å½¢ */
    border-radius: 6px;
    overflow: hidden; /* é˜²æ­¢å›¾ç‰‡æº¢å‡ºåœ†è§’ */
    background-color: #e9ecef; /* å›¾ç‰‡åŠ è½½å‰çš„å ä½ç¬¦é¢œè‰² */
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡å®¹å™¨ä¸”ä¸å˜å½¢ */
    cursor: pointer;
}

/* åˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s ease;
}

/* é¼ æ ‡æ‚¬åœåœ¨ç…§ç‰‡ä¸Šæ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.photo-item:hover .photo-delete-btn {
    opacity: 1;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸»é¢˜ç³»ç»Ÿ & å¤–è§‚è®¾ç½®é¡µé¢ç¾åŒ– â–¼â–¼â–¼ */

/* 1. å®šä¹‰å…¨å±€é¢œè‰²å˜é‡,è¿™æ˜¯å®ç°ä¸»é¢˜åˆ‡æ¢çš„æ ¸å¿ƒ */
:root {
    --theme-top-bar-bg: #fdfdfd;      /* é¡¶æ èƒŒæ™¯è‰² */
    --theme-top-bar-text: #1f1f1f;     /* é¡¶æ æ–‡å­—é¢œè‰² */
    --theme-bottom-bar-bg: #f8f8f8; /* åº•æ èƒŒæ™¯è‰² (å¯ä»¥å’Œé¡¶æ ä¸åŒ) */
    --accent-color: #007bff;          /* ä¸»é¢˜å¼ºè°ƒè‰² (ä¿æŒä¸å˜) */
}

/* 2. å°†é¢œè‰²å˜é‡åº”ç”¨åˆ°æ‰€æœ‰ç›¸å…³çš„UIå…ƒç´ ä¸Š */
.header, .qzone-header {
    background-color: var(--theme-top-bar-bg);
    color: var(--theme-top-bar-text);
    border-bottom-color: rgba(0, 0, 0, 0.08);
}
.header .back-btn, .header .action-btn, .header .save-btn, .qzone-header .back-btn {
    color: var(--theme-top-bar-text); /* ç¡®ä¿æŒ‰é’®é¢œè‰²è·Ÿéšä¸»é¢˜ */
}

#chat-list-bottom-nav {
    background-color: var(--theme-bottom-bar-bg);
    border-top-color: rgba(0, 0, 0, 0.08);
    border-radius: 0 0 20px 20px; /* ç»™åº•éƒ¨å¯¼èˆªæ åŠ åœ†è§’,æ›´ç¾è§‚ */
}

#chat-input-area {
    background-color: var(--theme-bottom-bar-bg);
    border-top-color: rgba(0, 0, 0, 0.08);
}

/* 3. ç¾åŒ–å¤–è§‚è®¾ç½®é¡µé¢çš„æ–°å¸ƒå±€ */
.form-container .section-title {
    display: block;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 15px;
    text-align: left;
    width: 100%;
}

#theme-management-section, #wallpaper-settings-section, #icon-settings-section, #other-settings-section {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.color-picker-group {
    display: flex;
    justify-content: space-around;
    width: 100%;
    margin-bottom: 20px;
}
.color-input-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
.color-input-wrapper label {
    font-size: 13px;
    font-weight: 500;
}
input[type="color"] {
    -webkit-appearance: none;
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 50%;
    overflow: hidden;
    cursor: pointer;
    background: none;
    padding: 0;
}
input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
}
input[type="color"]::-webkit-color-swatch {
    border: 2px solid #ddd;
    border-radius: 50%;
}

/* 4. ä¿å­˜çš„ä¸»é¢˜åˆ—è¡¨æ ·å¼ */
#saved-themes-list {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    width: 100%;
    margin-top: 20px;
}

.saved-theme-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.theme-preview {
    width: 70px;
    height: 70px;
    border-radius: 12px;
    border: 2px solid #ccc;
    position: relative;
    background-size: cover;
    background-position: center;
    overflow: hidden;
}

.theme-preview::before, .theme-preview::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    height: 12px; /* æ¨¡æ‹Ÿé¡¶æ å’Œåº•æ çš„é«˜åº¦ */
}
.theme-preview::before {
    top: 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}
.theme-preview::after {
    bottom: 0;
    border-top: 1px solid rgba(0,0,0,0.1);
}

.theme-name {
    font-size: 12px;
    font-weight: 500;
}

.theme-delete-btn {
    font-size: 11px;
    color: #ff3b30;
    opacity: 0.7;
    transition: opacity 0.2s;
}
.theme-delete-btn:hover {
    opacity: 1;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘ç”¨è¿™ã€ä¸€æ•´å—ã€‘ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„æ£‹ç›˜å’Œè§„åˆ™å›¾æ ‡æ ·å¼ â–¼â–¼â–¼ */

/* --- 1. æ¸¸æˆè§„åˆ™å¼¹çª—å†…çš„å›¾æ ‡æ ·å¼ --- */
.rules-icon {
    display: inline-block;
    width: 18px;
    height: 18px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    vertical-align: middle;
    margin-right: 8px;
}
/* ä¸ºè§„åˆ™å¼¹çª—å†…çš„æ¯ç§å›¾æ ‡æŒ‡å®šå›¾ç‰‡ */
.rules-icon.star { background-image: url('https://sharkpan.xyz/f/2dlzHQ/%E6%98%9F%E6%98%9F.png'); }
.rules-icon.bomb { background-image: url('https://sharkpan.xyz/f/LzXnC7/%E6%81%B6%E9%AD%94.png'); }
.rules-icon.event { background-image: url('https://sharkpan.xyz/f/qODGC3/%E9%97%AE%E5%8F%B7.png'); }
.rules-icon.pause { background-image: url('https://sharkpan.xyz/f/gwm5sw/%E6%9A%82%E5%81%9C.png'); }
.rules-icon.back { background-image: url('https://sharkpan.xyz/f/XDxqsW/%E8%BF%94%E5%9B%9E.png'); }
.rules-icon.forward { background-image: url('https://sharkpan.xyz/f/JZLLFg/%E5%89%8D%E8%BF%9B.png'); }

/* --- 2. æ£‹ç›˜æ ¼å­ä¸Šçš„å›¾æ ‡æ ·å¼ --- */
.chess-cell .cell-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 24px;
    height: 24px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}
/* ä¸ºæ£‹ç›˜ä¸Šçš„æ¯ç§å›¾æ ‡æŒ‡å®šå›¾ç‰‡ (ä¸è§„åˆ™å¼¹çª—å®Œå…¨åŒæ­¥) */
.chess-cell.star .cell-icon { background-image: url('https://sharkpan.xyz/f/2dlzHQ/%E6%98%9F%E6%98%9F.png'); }
.chess-cell.bomb .cell-icon { background-image: url('https://sharkpan.xyz/f/LzXnC7/%E6%81%B6%E9%AD%94.png'); }
.chess-cell.event .cell-icon { background-image: url('https://sharkpan.xyz/f/qODGC3/%E9%97%AE%E5%8F%B7.png'); }
.chess-cell.pause .cell-icon { background-image: url('https://sharkpan.xyz/f/gwm5sw/%E6%9A%82%E5%81%9C.png'); }
.chess-cell.back .cell-icon { background-image: url('https://sharkpan.xyz/f/XDxqsW/%E8%BF%94%E5%9B%9E.png'); }
.chess-cell.forward .cell-icon { background-image: url('https://sharkpan.xyz/f/JZLLFg/%E5%89%8D%E8%BF%9B.png'); }
.chess-cell.end .cell-icon { background-image: url('https://i.postimg.cc/Y0G355Xv/Fluent-Emoji-Trophy.png'); } /* ç»ˆç‚¹å›¾æ ‡ä¿æŒä¸å˜ */

/* --- 3. æ£‹ç›˜æ ¼å­çš„èƒŒæ™¯è‰² (è¿™æ®µä»£ç ä¿æŒä¸å˜ï¼Œä½†æ”¾åœ¨ä¸€èµ·æ–¹ä¾¿ç®¡ç†) --- */
.chess-cell.start { background-color: #fbe2e2; }
.chess-cell.end { background-color: #e5dcfc; }
.chess-cell.star { background-color: #dceefb; }
.chess-cell.bomb { background-color: #fbe2e2; }
.chess-cell.event { background-color: #fff9e0; }
.chess-cell.pause { background-color: #e3e4fa; }
.chess-cell.back { background-color: #e3e4fa; }
.chess-cell.forward { background-color: #d4edda; }

#phone-screen.dark-mode .chess-cell.start,
#phone-screen.dark-mode .chess-cell.bomb { background-color: #4a2c2c; }
#phone-screen.dark-mode .chess-cell.end { background-color: #433d59; }
#phone-screen.dark-mode .chess-cell.star { background-color: #2a3e4d; }
#phone-screen.dark-mode .chess-cell.event { background-color: #4d493a; }
#phone-screen.dark-mode .chess-cell.pause,
#phone-screen.dark-mode .chess-cell.back { background-color: #3c3d59; }
#phone-screen.dark-mode .chess-cell.forward { background-color: #2b4a33; }

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* === å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡†æ ·å¼ === */
#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw;  /* å›¾ç‰‡æœ€å¤§å®½åº¦ä¸ºè§†å£çš„90% */
    max-height: 85vh; /* å›¾ç‰‡æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„85% */
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    /* ä¸ºå›¾ç‰‡çš„åˆ‡æ¢æ·»åŠ ä¸€ç‚¹å¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    transition: opacity 0.2s ease-in-out;
}

/* å…³é—­æŒ‰é’® */
#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}

/* å·¦å³å¯¼èˆªç®­å¤´ */
#photo-viewer-modal .nav-arrow {
    position: absolute; /* ç°åœ¨æˆ‘ä»¬ç”¨ç»å¯¹å®šä½æ¥æ§åˆ¶ç®­å¤´ */
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; /* åœ¨æ‰‹æœºå±å¹•ä¸Š,å¯ä»¥ç¨å¾®å°ä¸€ç‚¹ */
    font-weight: 100;
    cursor: pointer;
    padding: 10px; /* è°ƒæ•´å†…è¾¹è· */
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; /* ç¡®ä¿ç®­å¤´åœ¨æœ€ä¸Šå±‚ */
}

#photo-viewer-prev-btn {
    left: 5px; /* å®šä½å·¦ç®­å¤´ */
}

#photo-viewer-next-btn {
    right: 5px; /* å®šä½å³ç®­å¤´ */
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}

/* å½“ç®­å¤´è¢«ç¦ç”¨æ—¶(æ¯”å¦‚ç¬¬ä¸€å¼ æˆ–æœ€åä¸€å¼ ) */
#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™äº›æ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—æ–°CSSæ›¿æ¢æ‰ä¸Šä¸€ç‰ˆçš„äº¤äº’åŒºCSS â–¼â–¼â–¼ */

/* === å¸–å­å†…å®¹åŒº - ç›¸å¯¹å®šä½å®¹å™¨ === */
/* === å¸–å­å†…å®¹åŒº === */
.post-main-content {
    /* å®ƒç°åœ¨åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å†…å®¹å®¹å™¨,ä¸å†éœ€è¦ç‰¹æ®Šæ ·å¼äº† */
}

/* === å¸–å­äº’åŠ¨å›¾æ ‡åŒº (æ–°æ ·å¼) === */
.post-feedback-icons {
    display: flex;
    justify-content: flex-end; /* è®©å›¾æ ‡é å³å¯¹é½ */
    align-items: center;
    gap: 12px;
    padding: 8px 0; /* æ ¸å¿ƒä¿®æ”¹:ç»™å›¾æ ‡åŒºåŸŸä¸Šä¸‹å„8pxçš„ç•™ç™½ */
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); /* é»˜è®¤ç°è‰² */
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* å›¾æ ‡æ¿€æ´»(ç‚¹èµ/æ”¶è—å)çš„æ ·å¼ */
.action-icon.active {
    color: #ff5252; /* æ¿€æ´»åå˜çº¢è‰² */
    transform: scale(1.1); /* è½»å¾®æ”¾å¤§ */
}

.action-icon.active.favorite {
    color: #ffc107; /* æ”¶è—ç”¨é»„è‰² */
}

.action-icon.active svg {
    fill: currentColor; /* æ¿€æ´»åå¡«å……é¢œè‰² */
}

/* ç‚¹å‡»æ—¶çš„åŠ¨ç”»æ•ˆæœ */
.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}


/* === å¸–å­åº•éƒ¨è¯„è®ºåŒºæ ·å¼ (ç°åœ¨æ˜¯ç‹¬ç«‹éƒ¨åˆ†) === */
.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px; /* è°ƒæ•´æ•´ä½“é—´è· */
}

/* è¯„è®ºåŒºå®¹å™¨ */
.comment-section {
    position: relative; /* <-- æ–°å¢è¿™ä¸€è¡Œ */
    flex-grow: 1; /* å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}

/* æ–°å¢çš„å‘é€æŒ‰é’®æ ·å¼ */
.comment-send-btn {
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè¯»æ¶ˆæ¯å°çº¢ç‚¹é€šç”¨æ ·å¼ === */
.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}

/* èŠå¤©ç•Œé¢è¿”å›æŒ‰é’®ä¸Šçš„å°çº¢ç‚¹ (åªæ˜¾ç¤ºç‚¹,ä¸æ˜¾ç¤ºæ•°å­—) */
.back-btn-indicator {
    top: 0;
    right: -8px; /* æ”¾åˆ°è¿”å›ç®­å¤´å³ä¸Šè§’ */
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === è¯„è®ºåˆ—è¡¨å®¹å™¨ === */
.post-comments-container {
    padding: 5px 0; /* ä¸Šä¸‹ç•™ç™½ */
    display: flex;
    flex-direction: column;
    gap: 4px !important;/* è¯„è®ºä¹‹é—´çš„é—´è· */
    font-size: 13px; /* ç»Ÿä¸€è¯„è®ºåŒºå­—ä½“å¤§å° */
}

/* æ¯ä¸€æ¡è¯„è®º */
.comment-item {
    line-height: 1.3;
}

/* è¯„è®ºè€…çš„åå­—,åŠ ç²—å¹¶ä½¿ç”¨ä¸»é¢˜è‰² */
.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; /* å’Œè¯„è®ºå†…å®¹ä¹‹é—´ç•™ç‚¹ç©ºéš™ */
}

/* è¯„è®ºå†…å®¹ */
.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === å¸–å­ç‚¹èµåŒºåŸŸæ ·å¼ === */
.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    padding: 8px 10px; /* å†…è¾¹è· */
    font-size: 13px;
    color: var(--accent-color); /* ä½¿ç”¨ä¸»é¢˜è“è‰² */
    background-color: #f0f5fa; /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; /* å’Œä¸Šæ–¹çš„å›¾æ ‡ä¿æŒä¸€ç‚¹è·ç¦» */
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; /* è®©SVGå›¾æ ‡ç»§æ‰¿çˆ¶å…ƒç´ çš„é¢œè‰² */
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === @æåŠ å¼¹å‡ºèœå•æ ·å¼ === */
.at-mention-popup {
    position: absolute; /* ç›¸å¯¹äºçˆ¶å…ƒç´ å®šä½ */
    bottom: 100%; /* æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†çš„ä¸Šæ–¹ */
    left: 40px; /* å’Œè¾“å…¥æ¡†å·¦ä¾§å¯¹é½ (è€ƒè™‘äº†å¤´åƒå®½åº¦) */
    width: calc(100% - 40px); /* å®½åº¦å’Œè¾“å…¥æ¡†å·®ä¸å¤š */
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; /* é»˜è®¤éšè— */
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€æ–°æ ·å¼ã€‘æ›¿æ¢æ‰ä½ ç°æœ‰çš„ #favorites-list æ ·å¼ â–¼â–¼â–¼ */

/* è®©æ”¶è—è§†å›¾æˆä¸ºä¸€ä¸ªflexå®¹å™¨, ä»ä¸Šåˆ°ä¸‹æ’åˆ— */
#favorites-view {
    display: flex;
    flex-direction: column;
}

/* ç¡®ä¿æ”¶è—é¡µçš„headeré«˜åº¦å›ºå®š,ä¸è¢«å‹ç¼© */
#favorites-view > .header {
    flex-shrink: 0;
}

/* === æ”¶è—åˆ—è¡¨æ ·å¼ (ä¿®æ­£å) === */
#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; /* <-- æ–°å¢è¿™è¡Œ,ç¦æ­¢æ°´å¹³æ»šåŠ¨ */
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; /* ä¸ºäº†å®šä½åˆ é™¤æŒ‰é’® */
}

/* å¡ç‰‡å¤´éƒ¨,åŒ…å«å¤´åƒã€åå­—å’Œæ¥æº */
.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}

/* å¡ç‰‡å†…å®¹ */
.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; /* å›¾ç‰‡å’Œæ–‡å­—çš„é—´è· */
}

/* åˆ é™¤æŒ‰é’® */
.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘çºªå¿µæ—¥ä¸æ—¥å†åŠŸèƒ½æ ·å¼ === */

/* 1. çºªå¿µæ—¥è®¡æ•°å™¨å¡ç‰‡ */
.anniversary-counter-card {
    background-color: var(--secondary-bg);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
    position: relative;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .anniversary-counter-card {
    background-color: #2c2c2e;
}

.counter-avatars {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
}
.counter-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    object-fit: cover;
}
.counter-avatar:last-child {
    margin-left: -15px; /* è®©å¤´åƒæœ‰é‡å æ•ˆæœ */
}

.counter-days {
    color: #f59e0b; /* å‚è€ƒp3çš„æ©™è‰² */
    font-size: 32px;
    font-weight: bold;
    line-height: 1;
}
.counter-days span {
    font-size: 48px;
    font-weight: 200; /* ç»†ä¸€ç‚¹çš„æ•°å­—æ›´å¥½çœ‹ */
    letter-spacing: -2px;
}
.counter-date {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 8px;
}

/* 2. æ—¥å†å¡ç‰‡ */
.calendar-card {
    background-color: var(--secondary-bg);
    border-radius: 16px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .calendar-card {
    background-color: #2c2c2e;
}
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.calendar-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}
.calendar-header button {
    background: none;
    border: none;
    font-size: 24px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 5px 10px;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-size: 12px;
    font-weight: 500;
    color: #fbbf24; /* å‚è€ƒp3çš„é»„è‰² */
    margin-bottom: 10px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
}
.calendar-day {
    aspect-ratio: 1 / 1;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 14px;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: background-color 0.2s, color 0.2s;
}
.calendar-day.empty {
    cursor: default;
    opacity: 0;
}
.calendar-day.today {
    background-color: #f59e0b; /* æ©™è‰² */
    color: white;
    font-weight: bold;
}
.calendar-day:not(.empty):not(.today):hover {
    background-color: #fffbeb; /* æ‚¬åœæ—¶æ·¡é»„è‰² */
}
#phone-screen.dark-mode .calendar-day:not(.empty):not(.today):hover {
    background-color: #3e3e42;
}

/* æ—¥æœŸä¸Šçš„å°åœ†ç‚¹æ ‡è®° */
.calendar-day.has-event::after {
    content: '';
    position: absolute;
    bottom: 4px;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background-color: #ef4444; /* çº¢è‰²æ ‡è®° */
}
.calendar-day.today.has-event::after {
    background-color: white; /* ä»Šå¤©æœ‰äº‹ä»¶,æ ‡è®°ä¸ºç™½è‰² */
}


/* === æœç´¢æ æ ·å¼ === */
.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; /* å’Œåˆ—è¡¨èƒŒæ™¯è‰²ä¿æŒä¸€è‡´ */
    position: relative; /* ä¸ºäº†å®šä½æ¸…é™¤æŒ‰é’® */
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; /* å³ä¾§ç•™å‡ºæ¸…é™¤æŒ‰é’®çš„ä½ç½® */
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; /* åœ†è§’çŸ©å½¢,æ›´ç°ä»£åŒ– */
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}
#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ç²¾ç»†å¾®è°ƒç‰ˆ V6ã€‘ç›´æ’­é—´å¼¹å¹•ä¸ç¤¼ç‰©æ ·å¼ â–¼â–¼â–¼ */

/* --- 1. å¼¹å¹•ä¸ç¤¼ç‰©çš„é€šç”¨åŸºç¡€ --- */
.live-comment-bubble,
.live-system-notification {
    display: inline-block;
    max-width: 85%;
    border-radius: 16px 16px 16px 4px;
    font-size: 14px;
    line-height: 1.6;
    animation: fade-in-up 0.3s ease-out;
    padding: 8px 14px;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #FFFFFF;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* é˜´å½±ç¨åŠ æ·±ï¼Œè®©æ‰€æœ‰ç™½å­—æ›´æ¸…æ™° */
}

/* --- 2. ä¸åŒèº«ä»½çš„èƒŒæ™¯ä¸æ˜µç§°é¢œè‰² --- */

/* a. ã€æ ¸å¿ƒä¿®æ”¹1ã€‘æ™®é€šè·¯äººè§‚ä¼— - å›å½’ä¸­æ€§çš„æµ…ç°è‰² */
.live-comment-bubble {
    background-color: rgba(255, 255, 255, 0.15); /* ä½¿ç”¨åŸºç¡€çš„åŠé€æ˜ç™½è‰² */
}
.live-comment-bubble .username {
    color: #E0E0E0; /* æ˜µç§°ä½¿ç”¨æ˜äº®çš„æµ…ç°è‰² */
    font-weight: 600;
    margin-right: 6px;
}

/* b. æ‚¨è‡ªå·±ï¼ˆä¸»æ’­/è§‚ä¼—ï¼‰ - æ¸©æš–çš„çŠç‘šç²‰ (ä¿æŒä¸å˜) */
.live-comment-bubble.host-comment {
    background: linear-gradient(135deg, rgba(255, 205, 210, 0.4), rgba(255, 138, 101, 0.3));
    border-radius: 16px 16px 4px 16px;
}
.live-comment-bubble.host-comment .username {
    color: #FFCDD2;
}

/* c. ã€æ ¸å¿ƒä¿®æ”¹3ã€‘é‡‘ä¸»/ç‰¹é‚€å˜‰å®¾ (char) - å°Šè´µçš„é»‘é‡‘é£æ ¼ */
.live-comment-bubble.guest-comment {
    background: linear-gradient(135deg, rgba(153, 123, 32, 0.5), rgba(128, 94, 27, 0.6)); /* æ·±é‚ƒçš„é»‘é‡‘æ¸å˜ */
    border-color: rgba(255, 215, 0, 0.5); /* é‡‘è‰²è¾¹æ¡† */
}
.live-comment-bubble.guest-comment .username {
    color: #FFD700; /* çº¯æ­£çš„é‡‘è‰² */
    font-weight: 700;
}

/* d. ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å¥³å¤§ç²‰ - æ›´é²œè‰³çš„æ¡ƒç²‰è‰² */
.live-comment-bubble.big-fan-comment {
    background: linear-gradient(135deg, rgba(236, 64, 122, 0.35), rgba(171, 71, 188, 0.25)); /* ç²‰ç´«æ¸å˜ */
}
.live-comment-bubble.big-fan-comment .username {
    color: #ffdde8; /* é¢œè‰²åŠ æ·±ï¼Œæ›´é†’ç›® */
}

/* e. ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ç”·å¤§ç²‰ - æ›´æ²‰ç¨³çš„å®è“è‰² */
.live-comment-bubble.male-fan-comment {
    background: linear-gradient(135deg, rgba(55, 162, 250, 0.3), rgba(58, 130, 255, 0.2)); /* è“è°ƒæ¸å˜ */
}
.live-comment-bubble.male-fan-comment .username {
    color: #499ee4; /* é¢œè‰²åŠ æ·±ï¼Œæ›´æ¸…æ™° */
}

/* f. æ™®é€šå¯Œè±ªè·¯äºº (ä¿æŒä¸å˜) */
.live-comment-bubble.rich-fan-comment .username {
    color: #90CAF9;
}

/* --- 3. ç¤¼ç‰©é€šçŸ¥çš„ç‰¹æ®Šæ ·å¼ - é—ªäº®çš„å¥¶æ²¹é»„ (ä¿æŒä¸å˜) --- */
.live-system-notification {
    background: linear-gradient(45deg, rgba(255, 245, 157, 0.5), rgba(255, 213, 79, 0.4));
    border-radius: 20px;
    font-weight: 500;
    border-color: rgba(255, 255, 255, 0.3);
}
.live-system-notification strong {
    font-weight: 700;
    color: #ad6e1b;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆå¼ºåˆ¶ç‰ˆã€‘åŠ¨æ€ä¸è¯„è®ºåŒºç¾åŒ– (å‚è€ƒå›¾é£æ ¼) â–¼â–¼â–¼ */

/* --- 1. å¸–å­å¡ç‰‡æ•´ä½“è°ƒæ•´ --- */
.qzone-post-item {
    padding: 15px 15px 0 15px !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    border-bottom: 1px solid var(--border-color) !important;
}
#phone-screen.dark-mode .qzone-post-item {
    border-bottom-color: #2c2c2e !important;
}

/* --- 2. å¸–å­å¤´éƒ¨ (å¤´åƒã€æ˜µç§°ã€ä¸‰ç‚¹èœå•) --- */
.post-header {
    gap: 12px !important;
    margin-bottom: 12px !important;
}
.post-avatar {
    width: 42px !important;
    height: 42px !important;
}
.post-info {
    gap: 2px !important;
}
.post-nickname {
    font-size: 16px !important;
    color: var(--accent-color) !important;
    font-weight: 600 !important;
}
.post-actions-btn {
    margin-left: auto !important;
    color: #b0b0b0 !important;
    font-size: 24px !important;
}
.post-header .post-timestamp {
    display: none !important;
}

/* --- 3. å¸–å­å†…å®¹ä¸æ–°çš„åº•éƒ¨ä¿¡æ¯åŒº --- */
.post-main-content {
    margin-bottom: 12px !important;
}
.post-content {
    font-size: 15px !important;
    line-height: 1.7 !important;
    color: var(--text-primary) !important;
}

.post-meta-bar {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 8px 0 !important;
    color: var(--text-secondary) !important;
}
.post-meta-bar .post-timestamp {
    font-size: 13px !important;
}
.post-feedback-icons {
    padding: 0 !important;
    gap: 18px !important;
}
.action-icon svg {
    width: 20px !important;
    height: 20px !important;
}

/* --- 4. ç‚¹èµå’Œè¯„è®ºåŒºåŸŸ (å»èƒŒæ™¯ + åˆ†éš”çº¿) --- */
/* â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆ - å½»åº•ç§»é™¤å†…éƒ¨åˆ†å‰²çº¿ã€‘ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .post-likes-section, .post-comments-container â–¼â–¼â–¼ */
.post-likes-section, .post-comments-container {
    background-color: transparent !important;
    padding: 0 !important; /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å°†ä¸Šä¸‹å†…è¾¹è·ä¹Ÿç§»é™¤ */
    margin: 0 !important;   /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å°†å¤–è¾¹è·ä¹Ÿç§»é™¤ï¼Œç”±å­å…ƒç´ è‡ªå·±æ§åˆ¶ */
    border-radius: 0 !important;
    border: none !important; /* ã€æ ¸å¿ƒä¿®æ”¹3ã€‘ä½¿ç”¨ border: none å½»åº•æ¸…é™¤æ‰€æœ‰è¾¹æ¡† */
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
#phone-screen.dark-mode .post-likes-section,
#phone-screen.dark-mode .post-comments-container {
    background-color: transparent !important;
}
/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .post-likes-section â–¼â–¼â–¼ */
.post-likes-section {
    font-size: 14px !important;
    color: var(--text-primary) !important;
    line-height: 1.5 !important;
    /* ã€æ–°å¢ã€‘å¢åŠ ä¸€ç‚¹ä¸Šè¾¹è·ï¼Œä¸ä¸Šæ–¹å†…å®¹æ‹‰å¼€è·ç¦» */
    margin-top: 5px !important;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
.post-likes-section .like-icon {
    display: none !important;
}
.post-likes-section::before {
    content: 'â™¡' !important;
    color: var(--accent-color) !important;
    margin-right: 8px !important;
    font-weight: bold !important;
}
.post-likes-section span {
    color: var(--accent-color) !important;
    font-weight: 500 !important;
}
/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .post-comments-container â–¼â–¼â–¼ */
.post-comments-container {
    /* ã€æ–°å¢ã€‘å¦‚æœåŒæ—¶æœ‰ç‚¹èµåŒºï¼Œå°±å¢åŠ ä¸€ç‚¹ä¸Šè¾¹è·ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸å†…å®¹åŒºä¿æŒ10pxé—´è· */
    margin-top: 5px !important; 
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
.comment-item {
    font-size: 14px !important;
    line-height: 1.6 !important;
    padding: 5px 0 !important;
}
.commenter-name {
    color: var(--accent-color) !important;
    font-weight: 600 !important;
}
.comment-item .reply-indicator {
    color: var(--text-primary) !important;
    font-weight: normal !important;
    font-size: 14px !important;
    margin: 0 4px !important;
}
.comment-text {
    color: var(--text-primary) !important;
}

/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .post-footer â–¼â–¼â–¼ */
.post-footer {
    border-top: none;
    margin-top: 15px;
    padding-bottom: 15px;
    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºè¾“å…¥æ¡†å’Œå¤´åƒçš„ç›¸å¯¹å®šä½æä¾›åŸºå‡† */
    position: relative; 
}
/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .comment-section .comment-avatar â–¼â–¼â–¼ */
.comment-section .comment-avatar {
    width: 25px !important;
    height: 25px !important;
    /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘ä½¿ç”¨ç»å¯¹å®šä½ */
    position: absolute;
    left: 10px; /* è·ç¦»å·¦è¾¹ç¼˜10px */
    top: 50%;   /* å‚ç›´å±…ä¸­å¯¹é½ */
    transform: translateY(-50%);
    z-index: 5; /* ç¡®ä¿åœ¨è¾“å…¥æ¡†ä¹‹ä¸Š */
}
/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .comment-input â–¼â–¼â–¼ */
.comment-input {
    background-color: #f0f2f5 !important;
    border-radius: 18px !important;
    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¢åŠ å·¦å†…è¾¹è·ï¼Œä¸ºå¤´åƒç•™å‡ºç©ºé—´ */
    padding: 10px 15px 10px 50px !important; 
    font-size: 14px !important;
    width: 100%; /* ã€æ–°å¢ã€‘ç¡®ä¿è¾“å…¥æ¡†æ’‘æ»¡çˆ¶å®¹å™¨ */
    box-sizing: border-box; /* ã€æ–°å¢ã€‘ç¡®ä¿å†…è¾¹è·ä¸ä¼šå¯¼è‡´å®½åº¦æº¢å‡º */
}
#phone-screen.dark-mode .comment-input {
    background-color: #2c2c2e !important;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* éšè—å‘é€æŒ‰é’® */
.comment-send-btn {
    display: none;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°V2ã€‘äº‹ä»¶é€šçŸ¥æ ·å¼ (ç¤¼ç‰©/è¿›åœº) â–¼â–¼â–¼ */
.event-pill {
    display: flex; /* å¯ç”¨flexå¸ƒå±€ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
    max-width: 250px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
    padding: 6px 12px 6px 6px; /* å†…è¾¹è·ï¼Œå·¦ä¾§å°ä¸€äº› */
    border-radius: 50px; /* å®Œç¾çš„è¯ä¸¸å½¢çŠ¶ */
    animation: fade-in-up 0.4s ease-out;
    
    /* æ¯›ç»ç’ƒæ•ˆæœ */
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.event-icon {
    width: 32px; /* å›ºå®šå›¾æ ‡åŒºåŸŸå®½åº¦ */
    height: 32px; /* å›ºå®šå›¾æ ‡åŒºåŸŸé«˜åº¦ */
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px; /* Emojiå¤§å° */
    margin-right: 8px; /* å›¾æ ‡å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
}

.event-icon img {
    width: 100%;
    height: 100%;
    border-radius: 50%; /* ç¡®ä¿å¤´åƒæ˜¯åœ†çš„ */
    object-fit: cover;
}

.event-text {
    display: flex;
    flex-direction: column; /* è®©ä¸¤è¡Œæ–‡å­—å‚ç›´æ’åˆ— */
    justify-content: center;
    line-height: 1.3;
}

.event-text .primary {
    font-size: 14px;
    font-weight: 600;
    color: #FFFFFF;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
}

.event-text .secondary {
    font-size: 12px;
    color: #E0E0E0; /* æ¬¡è¦æ–‡å­—ç”¨æµ…ç°è‰² */
    opacity: 0.9;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
}

/* --- ä¸åŒäº‹ä»¶çš„é¢œè‰²åŒºåˆ† --- */
.event-pill.gift-event {
    background-color: rgba(255, 215, 0, 0.2); /* ç¤¼ç‰©ç”¨æ·¡æ·¡çš„é‡‘è‰² */
}
.event-pill.join-event {
    background-color: rgba(248, 187, 208, 0.25); /* è¿›åœºç”¨æ·¡æ·¡çš„ç²‰è‰² */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°V2ã€‘ç›´æ’­é—´åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. ç›´æ’­é—´ä¸»å±å¹•å¸ƒå±€ */
#live-stream-screen {
    background-color: #1c1c1e;
    color: white;
    background-size: cover;
    background-position: center;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 15px;
    padding-bottom: calc(15px + env(safe-area-inset-bottom));
    box-sizing: border-box;
    cursor: pointer;
}

/* 2. é¡¶éƒ¨ä¿¡æ¯æ  (å·²ä¿®å¤é€‰æ‹©å™¨) */
#live-top-bar {
    position: absolute;
    top: 0; left: 0; right: 0;
    padding: 10px 15px;
    padding-top: calc(15px + env(safe-area-inset-top));
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
}
.streamer-info { display: flex; align-items: center; gap: 8px; background-color: rgba(0,0,0,0.4); padding: 5px 10px 5px 5px; border-radius: 20px; }
.streamer-info .avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
.streamer-info .details { display: flex; flex-direction: column; }
.streamer-info .streamer-name { font-size: 13px; font-weight: 600; }
.streamer-info .viewer-count { font-size: 11px; color: #ccc; }
.live-stats { display: flex; align-items: center; gap: 15px; font-size: 13px; font-weight: 500; background-color: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 20px; }

/* 3. ã€æ–°å¢ã€‘ä¸»æ’­å¯¹è¯/æ—ç™½æ¡† */
#live-host-narration-box {
    padding: 12px 15px;
    background-color: rgba(0,0,0,0.25);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border-radius: 12px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}
#live-host-narration-content {
    font-size: 14px;
    line-height: 1.6;
    font-style: italic;
    color: rgba(255, 255, 255, 0.9);
    max-height: 80px; /* çº¦4-5è¡Œçš„é«˜åº¦ */
    overflow-y: auto;
}

/* 4. ç²‰ä¸è¯„è®ºåŒºåŸŸ (ä¿æŒä¸å˜) */
#live-comments-feed {
    height: 35%; /* è°ƒæ•´é«˜åº¦ä»¥é€‚åº”æ–°çš„å¯¹è¯æ¡† */
    overflow-y: auto;
    display: flex;
    flex-direction: column-reverse;
    gap: 8px;
    margin-bottom: 15px;
}
/* â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€å¸¦é«˜æ–¯æ¨¡ç³Šã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ .live-comment-bubble æ ·å¼ â–¼â–¼â–¼ */
.live-comment-bubble {
    display: inline-block;
    max-width: 85%;
    padding: 6px 12px;
    
    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘åº”ç”¨é«˜æ–¯æ¨¡ç³ŠèƒŒæ™¯ */
    background-color: rgba(0, 0, 0, 0.25); /* é™ä½èƒŒæ™¯è‰²çš„ä¸é€æ˜åº¦ï¼Œè®©æ¨¡ç³Šæ•ˆæœæ›´æ˜æ˜¾ */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px); /* å…¼å®¹ Safari */
    
    /* ã€æ–°å¢ã€‘æ·»åŠ ä¸€ä¸ªç»†å¾®çš„è¾¹æ¡†ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
    border: 1px solid rgba(255, 255, 255, 0.1);

    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
    animation: fade-in-up 0.3s ease-out;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
.live-comment-bubble .username { color: #82c8f9; font-weight: 600; margin-right: 6px; }
.live-comment-bubble.host-comment .username { color: #ffda77; }
.live-system-notification { display: inline-block; padding: 5px 12px; background-color: rgba(255, 215, 0, 0.2); border-left: 3px solid #ffd700; color: #ffd700; border-radius: 8px; font-size: 13px; font-weight: 500; animation: fade-in-up 0.3s ease-out; }

/* 5. åº•éƒ¨æ§åˆ¶æ  (ä¿æŒä¸å˜) */
#live-controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.live-input-wrapper { flex-grow: 1; display: flex; background-color: rgba(0,0,0,0.3); border-radius: 20px; overflow: hidden; }
#live-comment-input { flex-grow: 1; border: none; background: none; padding: 10px 15px; color: white; font-size: 14px; outline: none; }
#live-comment-input::placeholder { color: #aaa; }
#live-send-comment-btn { background: none; border: none; color: white; font-weight: 600; padding: 0 15px; cursor: pointer; }
.live-action-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background-color: rgba(0,0,0,0.3); color: white; font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
.live-action-btn.end-call { background-color: #ff3b30; }

/* 6. ç‚¹èµåŠ¨ç”» (ä¿æŒä¸å˜) */
@keyframes like-burst { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
.like-burst-effect { position: absolute; bottom: 80px; right: 25px; font-size: 30px; pointer-events: none; animation: like-burst 0.5s ease-out forwards; }
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === èŠå¤©ç•Œé¢å¤šé€‰æ“ä½œæ ä¼˜åŒ– === */
#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}

/* === æ”¶è—é¡µé¢å¤šé€‰æ¨¡å¼æ ·å¼ === */
#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* é€‰æ‹©æ¡†çš„æ ·å¼ */
.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px; /* æŠŠå®ƒæ”¾åœ¨å¡ç‰‡å·¦è¾¹å¤–é¢ */
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶,å¡ç‰‡å‘å³ç§»åŠ¨,éœ²å‡ºé€‰æ‹©æ¡† */
#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}

/* é€‰ä¸­åçš„æ ·å¼ */
#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

/* åº•éƒ¨æ“ä½œæ  (ç»ˆæä¿®æ­£ç‰ˆ) */
#favorites-action-bar {
    position: absolute; /* â˜… æ”¹ä¸º absolute,ç›¸å¯¹äº #phone-screen å®šä½ */
    bottom: 0;
    left: 0;
    right: 0;           /* â˜… æ–°å¢ right: 0,å’Œ left: 0 ä¸€èµ·æ’‘æ»¡å®½åº¦ */
    width: auto;        /* â˜… æ”¹ä¸º auto,è®© left/right å†³å®šå®½åº¦ */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* é€‚é…iPhoneåº•éƒ¨å®‰å…¨åŒº */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
    /* max-width å·²ç»ä¸éœ€è¦äº†,å› ä¸ºçˆ¶å…ƒç´ å·²ç»é™åˆ¶äº†å®½åº¦ */
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}

/* â–¼â–¼â–¼ ç¬¬3æ­¥:å°†è¿™å—CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
/* ã€å…¨æ–°ã€‘çºªå¿µæ—¥é¡µé¢AIåˆ‡æ¢å™¨æ ·å¼ */
#memories-ai-switcher {
    background-color: transparent;
    border: none;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    text-align: center;
    direction: rtl; /* è®©ä¸‹æ‹‰ç®­å¤´æ˜¾ç¤ºåœ¨å·¦è¾¹,æ›´åƒåŸç”Ÿæ ‡é¢˜ */
    padding-right: 15px;
}
#memories-ai-switcher:focus {
    outline: none;
}
/* â–²â–²â–² CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€ä¿®æ­£ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨æ§ä»¶åˆ‡æ¢é€»è¾‘ === */

/* é»˜è®¤çŠ¶æ€:éšè—å¤šé€‰æ§ä»¶ */
#chat-interface-screen .header .selection-controls {
    display: none;
}

/* é»˜è®¤çŠ¶æ€:æ˜¾ç¤ºé»˜è®¤æ§ä»¶,å¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶:éšè—é»˜è®¤æ§ä»¶ */
#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}

/* å½“è¿›å…¥å¤šé€‰æ¨¡å¼æ—¶:æ˜¾ç¤ºå¤šé€‰æ§ä»¶,å¹¶è®©å®ƒæ’‘æ»¡æ•´ä¸ªå¤´éƒ¨ */
#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£:æ”¾å¤§æ‰€æœ‰ä¸»è¦çš„â€œ+â€å·æŒ‰é’® === */
#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px;   /* æ˜¾è‘—å¢å¤§å­—ä½“å¤§å°,ä½¿å…¶è§†è§‰ä¸Šä¸æ—è¾¹çš„å›¾æ ‡åŒ¹é… */
    font-weight: 300;  /* ä½¿ç”¨æ›´ç»†çš„å­—é‡,è®©åŠ å·çœ‹èµ·æ¥æ›´æ¸…çˆ½,ä¸æ˜¾ç²—ç¬¨ */
    position: relative;/* å…è®¸è¿›è¡Œä½ç½®å¾®è°ƒ */
    top: -1px;         /* å­—ä½“æ”¾å¤§å,é€šå¸¸éœ€è¦ç¨å¾®å‘ä¸Šç§»åŠ¨ä¸€ç‚¹,ä½¿å…¶è§†è§‰ä¸Šæ›´å±…ä¸­ */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ã€‘åŠ¨æ€éšè—ä¸åŠ è½½æ›´å¤šæ ·å¼ â–¼â–¼â–¼ */

/* 5. â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®çš„æ ·å¼ */
#qzone-load-more-btn {
    display: block;
    width: fit-content;
    margin: 15px auto 25px auto; /* å¢åŠ äº†åº•éƒ¨å¤–è¾¹è·ï¼Œè®©å®ƒä¸è´´è¾¹ */
    padding: 8px 20px;
    background: none;
    border: none;
    color: var(--accent-color);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 16px; /* å¢åŠ åœ†è§’ï¼Œæ›´ç¾è§‚ */
    transition: background-color 0.2s;
}
#qzone-load-more-btn:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

/* 6. ã€æ ¸å¿ƒã€‘ç”¨äºéšè—å¤šä½™åŠ¨æ€çš„è¾…åŠ©ç±» */
.hidden-post {
    display: none !important; /* ä½¿ç”¨ !important ç¡®ä¿æœ€é«˜ä¼˜å…ˆçº§ */
}

/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}

.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼ */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘äº”å­æ£‹(Gomoku)æ¸¸æˆç•Œé¢ç¾åŒ–æ ·å¼ (V5 - æ‰å¹³è“ç²‰ç‰ˆ) â–¼â–¼â–¼ */

/* --- 1. å®šä¹‰å…¨æ–°çš„è«å…°è¿ªè“ç²‰é…è‰²æ–¹æ¡ˆ (æ‰å¹³åŒ–) --- */
:root {
    --gomoku-bg: #f9f9f9;             /* çº¯å‡€çš„æµ…ç°è‰²èƒŒæ™¯ */
    --gomoku-board-area-bg: #ffffff;  /* æ£‹ç›˜åŒºåŸŸçš„çº¯ç™½èƒŒæ™¯ */
    --gomoku-board-bg: #fbfaf8;       /* ã€æ ¸å¿ƒã€‘ææµ…çš„ç±³ç™½è‰²æ£‹ç›˜ */
    --gomoku-line-color: #eae8e3;     /* éå¸¸æµ…çš„æ£‹ç›˜çº¿æ¡ */
    --gomoku-star-point-color: #dcd9d3;/* æ˜Ÿä½ç‚¹é¢œè‰² */

    /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£‹å­é¢œè‰²å˜ä¸ºè«å…°è¿ªæµ…è“æµ…ç²‰ */
    --gomoku-ai-piece: #87a99c;        /* è«å…°è¿ªæµ…è“ (AI) */
    --gomoku-user-piece: #cde0d8;      /* è«å…°è¿ªæµ…ç²‰ (User) */

    --gomoku-accent-color: #f3f3f3;    /* ææµ…çš„ç°è‰²é«˜äº® */
    --gomoku-timer-bg: #f0f0f0;        /* è®¡æ—¶å™¨èƒŒæ™¯ */
    --gomoku-text-primary: #5a5a5a;
    --gomoku-text-secondary: #b0b0b0;
    
    --gomoku-user-bubble-bg: #e1f5fe;
    --gomoku-ai-bubble-bg: #f1f1f1;
}

/* --- 2. æ¸¸æˆä¸»å±å¹•å¸ƒå±€ (ä¿æŒä¸å˜) --- */
#gomoku-screen {
    background-color: var(--gomoku-bg);
    flex-direction: column;
}
#gomoku-board-area {
    height: 60%;
    flex-shrink: 0;
    background-color: var(--gomoku-board-area-bg);
    border-bottom-left-radius: 30px;
    border-bottom-right-radius: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.04); /* é˜´å½±éå¸¸éå¸¸æ·¡ */
    display: flex;
    flex-direction: column;
    padding: 0 15px 15px 15px;
    box-sizing: border-box;
}

/* --- 3. ç©å®¶ä¿¡æ¯æ ä¸è®¡æ—¶å™¨ (æ‰å¹³åŒ–) --- */
#gomoku-screen .player-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 5px;
    flex-shrink: 0;
}
#gomoku-screen .player-card {
    background-color: transparent;
    border-radius: 12px;
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background-color 0.3s ease-in-out;
    border: none;
    box-shadow: none;
}
#gomoku-screen .player-card.current-player {
    background-color: var(--gomoku-accent-color);
}
#gomoku-screen .player-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
#gomoku-screen .player-details {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}
#gomoku-screen .player-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--gomoku-text-primary);
}
/* ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£‹å­é¢„è§ˆé¢œè‰²ä¸æ ·å¼æ›´æ–° */
#gomoku-screen .player-piece {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    margin-top: 4px;
    box-shadow: none; /* ç§»é™¤é˜´å½± */
}
#gomoku-screen .player-piece.black { background-color: var(--gomoku-ai-piece); }
#gomoku-screen .player-piece.white { background-color: var(--gomoku-user-piece); }

#gomoku-screen .turn-timer {
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
}
#gomoku-screen .timer-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background-color: var(--gomoku-timer-bg);
    color: var(--gomoku-text-primary);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    font-weight: bold;
    box-shadow: none; /* ç§»é™¤é˜´å½± */
}

/* --- 4. æ£‹ç›˜ç½‘æ ¼ä¸çº¿æ¡ (ç¾åŒ–) --- */
#gomoku-grid-wrapper {
    flex-grow: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}
#gomoku-grid {
    width: 100%;
    max-width: 340px;
    aspect-ratio: 1 / 1;
    background-color: var(--gomoku-board-bg);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 10px;
    box-sizing: border-box;
    display: grid;
    grid-template-columns: repeat(15, 1fr);
    grid-template-rows: repeat(15, 1fr);
    position: relative;
}
.gomoku-cell {
    position: relative;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
}
.gomoku-cell::before, .gomoku-cell::after {
    content: '';
    position: absolute;
    background-color: var(--gomoku-line-color);
    z-index: 1;
}
.gomoku-cell::before { width: 100%; height: 1px; top: 50%; left: 0; }
.gomoku-cell::after { width: 1px; height: 100%; top: 0; left: 50%; }
.gomoku-cell.star-point::after {
    content: '';
    position: absolute;
    width: 5px; /* æ˜Ÿä½ç‚¹ä¹Ÿå°ä¸€ç‚¹ */
    height: 5px;
    background-color: var(--gomoku-star-point-color);
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
}

/* --- 5. æ£‹å­æ ·å¼ä¸åŠ¨ç”» (æ ¸å¿ƒæ‰å¹³åŒ–) --- */
.piece {
    position: absolute;
    width: 90%;
    height: 90%;
    border-radius: 50%;
    z-index: 3;
    box-shadow: none; /* ã€æ ¸å¿ƒã€‘ç§»é™¤æ‰€æœ‰é˜´å½±å’Œé«˜å…‰ */
    transform: scale(0);
    animation: place-piece 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
@keyframes place-piece {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
/* ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£‹å­é¢œè‰²å˜ä¸ºçº¯è‰² */
.piece.black-piece {
    background-color: var(--gomoku-ai-piece);
}
.piece.white-piece {
    background-color: var(--gomoku-user-piece);
}

.last-move-marker {
    position: absolute;
    width: 30%;
    height: 30%;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.8); /* ä½¿ç”¨åŠé€æ˜ç™½è‰²å°ç‚¹ä½œä¸ºæ ‡è®° */
    border: none;
}
/* ç§»é™¤ last-move-marker çš„åŠ¨ç”» */
@keyframes pulse-marker {} 

/* --- 6. æ¸¸æˆå¼€å§‹é®ç½©å±‚ (ç¾åŒ–) --- */
#gomoku-start-overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(251, 250, 248, 0.8); /* åŒ¹é…æ£‹ç›˜è‰²çš„åŠé€æ˜ */
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    border-radius: 8px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
#gomoku-start-overlay.visible {
    opacity: 1;
    visibility: visible;
}
#gomoku-start-btn {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: 600;
    color: var(--gomoku-text-primary);
    background-color: #ffffff;
    border: 1px solid #eee;
    border-radius: 25px;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s;
}
#gomoku-start-btn:active {
    transform: scale(0.95);
}

/* --- 7. æ¸¸æˆèŠå¤©åŒºæ°”æ³¡æ ·å¼ (ä¿æŒä¸å˜) --- */
#auto-chess-messages .message-wrapper {
    max-width: 85%;
    display: flex;
    align-items: flex-start;
    gap: 8px;
}
#auto-chess-messages .message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse;
}
#auto-chess-messages .message-wrapper.ai {
    align-self: flex-start;
}
#auto-chess-messages .message-bubble.system-bubble {
    align-self: center;
    margin: 8px 0;
    font-size: 12px;
}
#auto-chess-messages .avatar-frame-wrapper {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
}
#auto-chess-messages .avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
#auto-chess-messages .message-bubble .content {
    padding: 10px 14px;
    border-radius: 18px;
    line-height: 1.5;
    font-size: 15px;
    word-break: break-word;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
#auto-chess-messages .message-wrapper.user .content {
    background-color: var(--gomoku-user-bubble-bg);
    color: var(--gomoku-text-primary);
    border-bottom-right-radius: 5px;
}
#auto-chess-messages .message-wrapper.ai .content {
    background-color: var(--gomoku-ai-bubble-bg);
    color: var(--gomoku-text-primary);
    border-bottom-left-radius: 5px;
}

/* --- 8. å¤œé—´æ¨¡å¼é€‚é… (æ‰å¹³åŒ–) --- */
#phone-screen.dark-mode #gomoku-screen {
    --gomoku-bg: #1e1e1e;
    --gomoku-board-area-bg: #2a2a2a;
    --gomoku-board-bg: #333333;
    --gomoku-line-color: #404040;
    --gomoku-star-point-color: #555555;
    
    --gomoku-ai-piece: #5a7b8c;  /* å¤œé—´æ¨¡å¼çš„æ·±è“ */
    --gomoku-user-piece: #8c6b73; /* å¤œé—´æ¨¡å¼çš„æš—ç²‰ */

    --gomoku-accent-color: #383838;
    --gomoku-timer-bg: #444444;
    --gomoku-text-primary: #e0e0e0;
    --gomoku-text-secondary: #8d8d92;
    --gomoku-user-bubble-bg: #26428b;
    --gomoku-ai-bubble-bg: #3e3e42;
}
#phone-screen.dark-mode #gomoku-screen .player-card.current-player {
    background-color: #383838;
}
#phone-screen.dark-mode #gomoku-start-overlay {
    background-color: rgba(42, 42, 42, 0.7);
}

/* â–²â–²â–² å…¨æ–°äº”å­æ£‹æ ·å¼åˆ°æ­¤ç»“æŸ â–²â–²â–² */

#live-comment-input {
    resize: none; /* ç¦æ­¢ç”¨æˆ·æ‹–æ‹½è°ƒæ•´å¤§å° */
    overflow-y: auto; /* å†…å®¹å¤šäº†å‡ºç°æ»šåŠ¨æ¡ */
    line-height: 1.4;
    padding-top: 10px; /* å¾®è°ƒå†…è¾¹è·ï¼Œè®©æ–‡å­—å‚ç›´å±…ä¸­æ„Ÿæ›´å¥½ */
}

/* 5. ä¸‹åŠéƒ¨åˆ† - èŠå¤©åŒº */
#auto-chess-chat-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
#auto-chess-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#auto-chess-input-area {
    flex-shrink: 0;
    padding: 8px;
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    align-items: flex-end;
    gap: 8px;
}
#phone-screen.dark-mode #auto-chess-input-area {
    background-color: rgba(28, 28, 30, 0.7);
}

#auto-chess-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: #ffffff;
    font-size: 16px;
    max-height: 100px;
    resize: none;
}
#phone-screen.dark-mode #auto-chess-input {
    background-color: #3e3e42;
    color: #fff;
}
#auto-chess-send-btn {
    height: 40px;
    padding: 0 15px;
    background-color: var(--accent-color);
}
/* â–²â–²â–² æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* æ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„å®¹å™¨ */
.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px; /* ä¸ä¸‹æ–¹çš„æ–‡æœ¬æ¡†æ‹‰å¼€è·ç¦» */
    flex-wrap: wrap; /* å¦‚æœæŒ‰é’®å¤ªå¤šå¯ä»¥æ¢è¡Œ */
}

/* å•ä¸ªæ ¼å¼åŠ©æ‰‹æŒ‰é’®çš„æ ·å¼ */
.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; /* èƒ¶å›Šå½¢çŠ¶,æ›´å‹å¥½ */
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* â€œâ€¦â€æŒ‰é’®çš„æ ·å¼ */
.post-actions-btn {
    margin-left: auto; /* å…³é”®:è®©å®ƒè‡ªåŠ¨é åˆ°æœ€å³è¾¹ */
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}

/* åŠ¨æ€ç¼–è¾‘æ¨¡æ€æ¡†çš„æ ·å¼ (å®ƒå°†å¤ç”¨ç°æœ‰çš„æ“ä½œèœå•æ ·å¼) */
#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* ç»Ÿä¸€é‡ç½®è½¬è´¦å¡ç‰‡å†…æ‰€æœ‰æ–‡å­—çš„ç‰¹æ•ˆå’Œé¢œè‰² */
#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; /* å¼ºåˆ¶ç§»é™¤ä»»ä½•å‘å…‰æˆ–é˜´å½±æ•ˆæœ */
    color: white !important;      /* å¼ºåˆ¶é”å®šæ–‡å­—é¢œè‰²ä¸ºç™½è‰² */
}

/* åˆ†åˆ«é”å®šå„è‡ªçš„å­—ä½“å¤§å°å’Œå­—é‡,é˜²æ­¢è¢«ç¯¡æ”¹ */
#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}

/* â–¼â–¼â–¼ è¿™æ˜¯æ–°å¢çš„æ ·å¼,ç”¨äºä¿®æ­£æ‰€æœ‰å¤´éƒ¨æ ‡é¢˜çš„å±…ä¸­é—®é¢˜ â–¼â–¼â–¼ */
.header > span:nth-child(2),
#chat-header-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); /* åœ¨-50%çš„åŸºç¡€ä¸Š,å†å‘å·¦æ¨2åƒç´  */
    
    /* (å¯é€‰ä½†æ¨è) é˜²æ­¢é•¿æ ‡é¢˜ä¸ä¸¤è¾¹æŒ‰é’®é‡å  */
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ ·å¼ â–¼â–¼â–¼ */
#message-editor-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-editor-block {
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
}

.message-editor-block textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.message-editor-block .format-helpers {
    margin-top: 8px;
    margin-bottom: 0; /* è¦†ç›–é»˜è®¤çš„ margin-bottom */
}

.message-editor-block .delete-block-btn {
    float: right;
    margin-top: -5px;
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼€æ’­å‰è®¾ç½®ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#live-pre-start-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 20;
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
}
.live-pre-start-content {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    padding: 25px;
    border-radius: 16px;
    width: 100%;
    max-width: 320px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}
.live-pre-start-content .title {
    text-align: center;
    font-size: 20px;
    margin-top: 0;
    margin-bottom: 25px;
}
.live-pre-start-content .form-group {
    margin-bottom: 20px;
}
.live-pre-start-content .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}
.live-pre-start-content .form-group input[type="text"],
.live-pre-start-content .form-group input[type="datetime-local"] {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    box-sizing: border-box;
}
/* ç‰¹æ®Šå¯¹é½æ ·å¼ */
#live-invite-ai-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#live-invite-ai-section label:first-child {
    margin-bottom: 0;
}
.start-live-btn {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç›´æ’­é—´æ–°æ¨¡å—CSSæ ·å¼ â–¼â–¼â–¼ */

/* â–¼â–¼â–¼ ã€å…¨æ–°å¾®è°ƒç‰ˆã€‘æ’è¡Œæ¦œæ ·å¼ â–¼â–¼â–¼ */

/* --- äººæ°”æ’è¡Œæ¦œ --- */
#live-ranking-box {
    position: absolute;
    top: 70px;
    left: 15px;
    width: 110px; /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å°†å®½åº¦ä»160pxå‡å°‘åˆ°130pxï¼Œæ‚¨å¯ä»¥æ ¹æ®å–œå¥½å†å¾®è°ƒ */
    padding: 8px;
    border-radius: 10px;
    font-size: 12px;
    
    /* æ¯›ç»ç’ƒæ•ˆæœ (ä¿æŒä¸å˜) */
    background-color: rgba(0, 0, 0, 0.2);
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    
    transition: all 0.3s ease;
}

.ranking-header {
    display: flex;
    justify-content: flex-start; /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ä»centeræ”¹ä¸ºflex-endï¼Œå®ç°å³å¯¹é½ */
    align-items: center;
    margin-bottom: 8px;
    color: #FFD700;
}

/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

.ranking-title {
    font-weight: 600;
}

.current-top-one {
    color: #E0E0E0;
    max-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ranking-list .rank-item {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    color: white;
}
.ranking-list .rank-item:last-child {
    margin-bottom: 0;
}

.rank-item .rank-num {
    font-weight: 700;
    width: 20px;
    text-align: center;
}
.rank-item .rank-num.top-1 { color: #FFD700; } /* æ¦œä¸€é‡‘è‰² */
.rank-item .rank-num.top-2 { color: #C0C0C0; } /* æ¦œäºŒé“¶è‰² */
.rank-item .rank-num.top-3 { color: #CD7F32; } /* æ¦œä¸‰é“œè‰² */

.rank-item .rank-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: 5px;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¤¼ç‰©ä¸è¿›åœºé€šçŸ¥åŒº (æ–°ä½ç½®) â–¼â–¼â–¼ */
#live-event-feed {
    position: absolute;
    top: 180px; /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘å®šä½åœ¨ä¸»æ’­æ—ç™½åŒºçš„ä¸Šæ–¹ï¼Œæ‚¨å¯ä»¥å¾®è°ƒè¿™ä¸ªæ•°å€¼ */
    left: 10px;
    right: 10px;
    height: 25%;
    display: flex;
    flex-direction: column-reverse; /* ä¿æŒæ–°é€šçŸ¥ä»ä¸‹å¾€ä¸Šæ¨çš„æ•ˆæœ */
    justify-content: flex-start;
    overflow: hidden;
    gap: 8px;
    /* ã€æ–°å¢ã€‘ä¸ºäº†é˜²æ­¢é€šçŸ¥å†…å®¹ä¸ä¸»æ’­æ—ç™½é‡å  */
    pointer-events: none; 
}

/* ã€æ–°å¢ã€‘è®©é€šçŸ¥æœ¬èº«å¯ä»¥è¢«ç‚¹å‡»ï¼ˆå¦‚æœæœªæ¥æœ‰éœ€è¦ï¼‰ */
#live-event-feed > * {
    pointer-events: auto;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è”ç³»äººé€‰æ‹©å™¨æ ·å¼ â–¼â–¼â–¼ */
.contact-picker-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.contact-picker-item .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
}
.contact-picker-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}
.contact-picker-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}
.contact-picker-item .name {
    font-weight: 500;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */
/* ã€æœ€ç»ˆä¿®å¤ã€‘åªåœ¨èŠå¤©ç•Œé¢éšè—çŠ¶æ€æ  */
#phone-screen:has(#chat-interface-screen.active) #status-bar {
    display: none !important;
}

/* === ã€æ–°å¢ã€‘å…¨å±èŠå¤©è®¾ç½®é¡µé¢çš„å†…å®¹åŒºæ ·å¼ === */
#chat-settings-screen .form-container {
    padding-top: 80px; /* ä¸ºé¡¶æ ç•™å‡ºç©ºé—´ */
    margin-top: -80px; /* è´Ÿå¤–è¾¹è·æŠ€å·§ï¼Œè®©æ»šåŠ¨ä»é¡¶æ ä¸‹å¼€å§‹ */
    background-color: var(--secondary-bg);
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#member-management-list {
    padding: 0; /* ç§»é™¤é»˜è®¤padding,è®©åˆ—è¡¨é¡¹æ’‘æ»¡ */
}

.member-management-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}

.member-management-item .name {
    flex-grow: 1;
    font-weight: 500;
}

.member-management-item .remove-member-btn {
    background-color: #ff3b30;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

#member-management-actions {
    flex-shrink: 0;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#member-management-actions button {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
#member-management-actions #create-new-member-btn {
    background-color: #4cd964; /* æ–°å»ºç”¨ç»¿è‰²,ä»¥ç¤ºåŒºåˆ† */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–ä»£ä»˜å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-waimai-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.waimai-card {
    width: 240px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.waimai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.waimai-header .icon {
    width: 20px;
    height: 20px;
}

.waimai-header .title-group {
    display: flex;
    align-items: baseline;
    font-size: 14px;
    color: #8a8a8a;
}
.waimai-header .title-group .brand {
    font-weight: 600;
    color: #555;
    margin-right: 5px;
}
.waimai-header .title-group .separator {
    margin: 0 5px;
}

.waimai-catchphrase {
    font-size: 13px;
    color: #1f1f1f;
    padding: 12px;
}

.waimai-main {
    background-color: #FFD66B; /* æ©™é»„è‰²èƒŒæ™¯ */
    padding: 12px;
    text-align: center;
}

.waimai-main .request-title {
    font-size: 12px;
    color: #856404;
    margin-bottom: 8px;
}

.waimai-main .payment-box {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px 10px;
}

.waimai-main .payment-label {
    font-size: 13px;
    color: #8a8a8a;
}

.waimai-main .amount {
    font-size: 32px;
    font-weight: 700;
    color: #1f1f1f;
    margin: 4px 0 12px 0;
}

.waimai-main .countdown-label {
    font-size: 13px;
    color: #8a8a8a;
}
.waimai-main .countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
}
.waimai-main .countdown-timer span {
    background-color: #333;
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 12px;
}

.waimai-details-btn {
    width: 100%;
    padding: 10px 0;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background-color: #FFC33A;
    color: #49380a;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–å“åº”çŠ¶æ€æ ·å¼ â–¼â–¼â–¼ */

/* === åŒæ„æ”¯ä»˜åçš„æ ·å¼ === */
.message-bubble.status-paid .waimai-card {
    border: 2px solid #28a745; /* ç»¿è‰²è¾¹æ¡† */
}
.message-bubble.status-paid .waimai-main .request-title::before {
    content: 'âœ…  ';
}
.message-bubble.status-paid .waimai-main .request-title {
    color: #155724;
    font-weight: 600;
    /* é‡å†™ request-title çš„å†…å®¹ */
    content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•,è¯·å°½æƒ…äº«ç”¨å§ï½" !important;
    display: block;
    margin-bottom: 15px;
}

.message-bubble.status-paid .payment-box {
    display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
}
.message-bubble.status-paid .waimai-details-btn {
    background-color: #28a745;
    color: white;
}

/* === æ‹’ç»æ”¯ä»˜åçš„æ ·å¼ === */
.message-bubble.status-rejected .waimai-card {
    border: 2px solid #dc3545; /* çº¢è‰²è¾¹æ¡† */
    opacity: 0.8;
}
.message-bubble.status-rejected .waimai-main {
    background-color: #e9ecef;
}
.message-bubble.status-rejected .waimai-main .request-title::before {
    content: 'âŒ ';
}
.message-bubble.status-rejected .waimai-main .request-title {
    color: #721c24;
    font-weight: 600;
    /* é‡å†™ request-title çš„å†…å®¹ */
    content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚" !important;
    display: block;
    margin-bottom: 15px;
}
.message-bubble.status-rejected .payment-box {
    display: none; /* éšè—æ”¯ä»˜è¯¦æƒ… */
}
 .message-bubble.status-rejected .waimai-details-btn {
    background-color: #6c757d;
    color: white;
}

/* å¼ºåˆ¶é‡å†™ request-title å†…å®¹çš„æŠ€å·§ */
.message-bubble[class*="status-"] .request-title {
    font-size: 0; /* éšè—åŸå§‹æ–‡æœ¬ */
}
.message-bubble[class*="status-"] .request-title::after {
    font-size: 14px; /* è®©ä¼ªå…ƒç´ æ˜¾ç¤ºæ–°æ–‡æœ¬ */
}
.message-bubble.status-paid .request-title::after {
    content: "æˆ‘å·²ä¸ºæ‚¨ä¹°å•,è¯·å°½æƒ…äº«ç”¨å§ï½";
}
.message-bubble.status-rejected .request-title::after {
    content: "æˆ‘æ‹’ç»äº†æ‚¨çš„ä»£ä»˜è¯·æ±‚";
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚çš„ç”¨æˆ·æ“ä½œæŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */
.waimai-user-actions {
    display: flex;
    gap: 10px;
    padding: 0 12px 12px 12px; /* åœ¨å¡ç‰‡åº•éƒ¨ç•™å‡ºç©ºé—´ */
    background-color: #fff;
}

.waimai-user-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.waimai-pay-btn {
    background-color: #28a745;
    border-color: #1f7a33;
    color: white;
}
.waimai-pay-btn:hover {
    background-color: #218838;
}

.waimai-decline-btn {
    background-color: #f8f9fa;
    border-color: #ced4da;
    color: #495057;
}
.waimai-decline-btn:hover {
    background-color: #e2e6ea;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ·˜å®/ç¤¼ç‰©åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. å•†å“åˆ—è¡¨ç½‘æ ¼ */
#shopping-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

/* 2. å•ä¸ªå•†å“å¡ç‰‡ */
.shopping-item-card {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.2s, transform 0.2s;
}
.shopping-item-card.selected {
    border-color: var(--accent-color);
    transform: scale(1.03);
}
.shopping-item-card img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    display: block;
}
.shopping-item-card .info {
    padding: 8px;
}
.shopping-item-card .name {
    font-size: 13px;
    font-weight: 500;
    line-height: 1.4;
    color: var(--text-primary);
    /* æœ€å¤šæ˜¾ç¤ºä¸¤è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 36px; /* çº¦ç­‰äºä¸¤è¡Œçš„é«˜åº¦ */
}
.shopping-item-card .price {
    font-size: 14px;
    font-weight: bold;
    color: #ff5000;
    margin-top: 5px;
}
#phone-screen.dark-mode .shopping-item-card .price {
    color: #ff8c66;
}

/* 3. èŠå¤©æ°”æ³¡ä¸­çš„ç¤¼ç‰©å¡ç‰‡ */
.message-bubble.is-gift-card .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}
.gift-card {
    width: 230px;
    border-radius: 12px;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    overflow: hidden;
    cursor: pointer;
}
.gift-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
}
.gift-card-header img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 6px;
}
.gift-card-header .details {
    overflow: hidden;
}
.gift-card-header .name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.gift-card-header .price {
    font-size: 14px;
    font-weight: bold;
    color: #ff5000;
}
.gift-card-footer {
    font-size: 12px;
    font-weight: 500;
    color: #8a8a8a;
    background-color: #f7f8fa;
    padding: 6px 12px;
    border-top: 1px solid #e0e0e0;
}
.gift-card.declined {
    opacity: 0.7;
    text-decoration: line-through;
}
.gift-card.accepted .gift-card-footer {
    color: #28a745;
    background-color: #e9f7ec;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€æ–°å¢ã€‘ç»Ÿä¸€è®¾ç½®é¡µé¢çš„èƒŒæ™¯è‰² (å·²ä¿®æ­£) === */
#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#memories-view,
#contact-picker-screen,
#member-management-screen,
#world-book-editor-screen {  
    background-color: var(--secondary-bg);
}

/* ç¡®ä¿è¿™äº›é¡µé¢çš„å†…å®¹åŒºèƒ½æ­£ç¡®æ»šåŠ¨ */
#api-settings-screen .form-container,
#font-settings-screen .form-container,
#wallpaper-screen .form-container {
    padding-top: 100px;
    margin-top: -80px;
    background-color: var(--secondary-bg);
}

/* å£çº¸è®¾ç½®é¡µé¢çš„é¢„è§ˆåŒºæ¯”è¾ƒç‰¹æ®Š,éœ€è¦é¢å¤–è°ƒæ•´ */
#wallpaper-screen .form-container {
    align-items: center; /* ä¿æŒå†…å®¹å±…ä¸­ */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°æ²‰æµ¸å¼ã€‘è§†é¢‘é€šè¯ç•Œé¢æ ·å¼ (V2) â–¼â–¼â–¼ */

/* --- æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† (ä¿æŒä¸å˜) --- */
#incoming-call-modal .incoming-call-content {
    background-color: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 20px; width: 280px; padding: 30px 20px;
    text-align: center; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.caller-avatar {
    width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
    margin-bottom: 12px; border: 3px solid rgba(255,255,255,0.5);
}
.caller-name { font-size: 20px; font-weight: 600; margin-bottom: 5px; }
.caller-text { font-size: 14px; color: #ccc; margin-bottom: 30px; }
.incoming-call-actions { display: flex; justify-content: space-around; align-items: center; }
.action-button-wrapper { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 13px; color: #e0e0e0; }
.call-action-btn {
    width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer;
    background-size: 50%; background-repeat: no-repeat; background-position: center;
    transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.call-action-btn:active { transform: scale(0.9); }
.call-action-btn.decline { background-color: #ff3b30; background-image: url('https://sharkpan.xyz/f/ppmNSQ/MaterialSymbolsCall.png'); }
.call-action-btn.accept { background-color: #4cd964; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>'); animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); } }

/* --- ã€å…¨æ–°ã€‘æ²‰æµ¸å¼è§†é¢‘é€šè¯ç•Œé¢ --- */
#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    /* ã€æ ¸å¿ƒã€‘å¯ç”¨èƒŒæ™¯å›¾æ ·å¼ */
    background-size: cover;
    background-position: center;
    display: flex; /* ç¡®ä¿flexå¸ƒå±€ç”Ÿæ•ˆ */
    flex-direction: column;
    justify-content: flex-end; /* è®©å†…å®¹ä»åº•éƒ¨å¼€å§‹å¯¹é½ */
    padding: 20px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* é€‚é…åº•éƒ¨å®‰å…¨åŒº */
    box-sizing: border-box;
}

/* é¡¶éƒ¨é€šè¯æ—¶é—´ */
.video-call-top-bar {
    position: absolute;
    top: 0; left: 0; width: 100%;
    padding: 15px 20px;
    padding-top: calc(15px + env(safe-area-inset-top)); /* é€‚é…é¡¶éƒ¨å®‰å…¨åŒº */
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent);
    z-index: 10;
    text-align: center;
    box-sizing: border-box;
    pointer-events: none; /* è®©é¼ æ ‡å¯ä»¥ç©¿é€å®ƒ */
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* åŠé€æ˜å¯¹è¯æ¡† */
#video-call-main {
    width: 100%;
    height: 35%; /* å æ®å±å¹•çº¦1/3çš„é«˜åº¦ */
    background-color: rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 20px;
    margin-bottom: 25px; /* ä¸åº•éƒ¨æŒ‰é’®çš„é—´è· */
    padding: 15px;
    box-sizing: border-box;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* åº•éƒ¨æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
.video-call-controls {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 100%;
}

.control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, background-color 0.2s;
}
.control-btn:active { transform: scale(0.9); }
.control-btn.speak-btn {
    background-color: rgba(255, 255, 255, 0.2);
    background-size: 55%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
}
.control-btn.hangup-btn {
    background-color: #ff3b30;
    background-size: 50%;
    background-image: url('https://sharkpan.xyz/f/ppmNSQ/MaterialSymbolsCall.png');
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å±‚çº§ä¿®å¤ã€‘ç¡®ä¿äººè®¾åº“åœ¨æœ€é¡¶å±‚ â–¼â–¼â–¼ */
#persona-library-modal {
    z-index: 101; /* é»˜è®¤å¼¹çª—æ˜¯100,æˆ‘ä»¬æŠŠå®ƒè®¾ä¸º101,å°±èƒ½ç›–ä½å…¶ä»–å¼¹çª—äº† */
}
/* â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ V5 - æ¢å¤äººè®¾æ¡†/å›¾æ ‡å±…ä¸­ã€‘èŠå¤©è®¾ç½®é¡µé¢å¡ç‰‡å¼å¸ƒå±€æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©è®¾ç½®å±å¹•æˆä¸ºä¸€ä¸ªèƒ½æ­£ç¡®æ»šåŠ¨çš„flexå®¹å™¨ (ä¿æŒä¸å˜) */
#chat-settings-screen {
    display: flex;
    flex-direction: column;
}
#chat-settings-screen .header {
    flex-shrink: 0; 
}

/* 2. è®©form-containerå¡«æ»¡å‰©ä½™ç©ºé—´å¹¶å¯ç”¨æ»šåŠ¨ (ä¿æŒä¸å˜) */
#chat-settings-screen .form-container {
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
    background-color: #f0f2f5;
    padding: 15px;
    gap: 15px;
    padding-top: 80px;
    margin-top: -80px;
}
#phone-screen.dark-mode #chat-settings-screen .form-container {
    background-color: #000000;
}

/* 3. å¡ç‰‡çš„åŸºç¡€æ ·å¼ (ä¿æŒä¸å˜) */
.settings-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
#phone-screen.dark-mode .settings-card {
    border: 1px solid var(--border-color);
}

/* 4. å¡ç‰‡å¤´éƒ¨çš„æ ·å¼ (ä¿æŒä¸å˜) */
.settings-card-header {
    display: flex;
    align-items: center; 
    gap: 15px; 
    margin-bottom: 20px;
}
.settings-card-header .avatar-frame-wrapper {
    width: 55px;
    height: 55px;
    flex-shrink: 0;
}
.settings-card-header .header-content-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.settings-card-header .form-group {
    margin-bottom: 0; 
}
.settings-card-header .form-group > label {
    margin-bottom: 8px;
}

/* 5. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºç®¡ç†åˆ†ç»„æŒ‰é’®æ·»åŠ ä¸“ç”¨æ ·å¼ï¼Œç¡®ä¿å±…ä¸­ */
#manage-groups-btn {
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    width: 44px;
    height: 44px;
    background-color: #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    /* ä½¿ç”¨flexå¸ƒå±€æ¥å®Œç¾å±…ä¸­å†…éƒ¨çš„å›¾æ ‡ */
    display: flex;
    justify-content: center;
    align-items: center;
}
#phone-screen.dark-mode #manage-groups-btn {
    background-color: #3e3e42;
}

/* 6. åº•éƒ¨å±é™©æ“ä½œæŒ‰é’®çš„å®¹å™¨ (ä¿æŒä¸å˜) */
.settings-footer-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-top: 15px;
}
.settings-footer-actions .form-button-secondary {
    width: 100%;
    margin: 0;
    padding: 15px; 
    background-color: #e9ecef; 
    color: var(--text-primary);
    font-weight: 500;
    border: none;
}
#phone-screen.dark-mode .settings-footer-actions .form-button-secondary {
    background-color: #2c2c2e;
}
.settings-footer-actions .form-button-secondary.danger {
    background-color: #e9ecef;
    color: #ff3b30;
}
#phone-screen.dark-mode .settings-footer-actions .form-button-secondary.danger {
    background-color: #2c2c2e;
    color: #ff453a;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»å…¨é€‰æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©åˆ†ç±»æ ‡é¢˜æ æˆä¸ºä¸€ä¸ªflexå®¹å™¨ï¼Œæ–¹ä¾¿æŒ‰é’®å®šä½ */
.wb-pill-category-title {
    display: flex;
    justify-content: space-between; /* è®©æ ‡é¢˜åœ¨å·¦ï¼ŒæŒ‰é’®åœ¨å³ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
}

/* 2. åœ†å½¢å…¨é€‰æŒ‰é’®çš„å¤–æ¡† */
.wb-category-select-all-btn {
    width: 10px;
    height: 10px;
    border: 1px solid #ccc;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
}

/* 3. æŒ‰é’®å†…éƒ¨çš„â€œé€‰ä¸­ç‚¹â€ */
.wb-category-select-all-btn .inner-dot {
    width: 6px;
    height: 6px;
    background-color: var(--accent-color);
    border-radius: 50%;
    transform: scale(0); /* é»˜è®¤ä¸æ˜¾ç¤º */
    transition: transform 0.2s ease;
}

/* 4. å½“æŒ‰é’®è¢«æ¿€æ´»æ—¶ (è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰/éƒ¨åˆ†ä¹¦è¢«é€‰ä¸­) */
.wb-category-select-all-btn.active {
    border-color: var(--accent-color);
}
.wb-category-select-all-btn.active .inner-dot {
    transform: scale(1); /* æ˜¾ç¤ºå†…éƒ¨çš„â€œé€‰ä¸­ç‚¹â€ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²__â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»æ‘˜è¦èƒ¶å›Šæ ·å¼ â–¼â–¼â–¼ */

/* 1. è®©æ‘˜è¦æ èƒŒæ™¯é€æ˜ï¼Œå¹¶è°ƒæ•´å†…è¾¹è· */
#wb-pills-summary-box {
    background-color: transparent !important;
    padding: 5px 10px; /* è°ƒæ•´å†…è¾¹è·ä»¥é€‚åº”èƒ¶å›Š */
    min-height: 46px; /* ç¡®ä¿æœ‰ä¸€ä¸ªæœ€å°é«˜åº¦ */
    display: flex; /* ä½¿ç”¨flexå¸ƒå±€ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
}

/* 2. æ‘˜è¦æ å†…éƒ¨çš„èƒ¶å›Šå®¹å™¨ */
#wb-pills-summary-text {
    flex-grow: 1; /* å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
    display: flex;
    flex-wrap: wrap; /* å…è®¸åˆ†ç±»èƒ¶å›Šæ¢è¡Œ */
    gap: 6px; /* èƒ¶å›Šä¹‹é—´çš„é—´è· */
    align-items: center; /* ç¡®ä¿â€œ--ç‚¹å‡»é€‰æ‹©--â€æ–‡æœ¬ä¹Ÿèƒ½å‚ç›´å±…ä¸­ */
}

/* 3. å•ä¸ªåˆ†ç±»æ‘˜è¦èƒ¶å›Šçš„æ ·å¼ */
.wb-summary-pill {
    padding: 4px 10px;
    font-size: 13px;
    font-weight: 500;
    border-radius: 15px;
    background-color: #e9ecef;
    color: var(--text-primary);
}
#phone-screen.dark-mode .wb-summary-pill {
    background-color: #3e3e42;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸€æ•´å—ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„ä»£ç ,æ›¿æ¢æ‰€æœ‰æ—§çš„ video-call ç›¸å…³CSS â–¼â–¼â–¼ */

/* 1. é€šè¯å±å¹•æ€»å®¹å™¨ (ä¿æŒä¸å˜) */
#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* 2. é¡¶éƒ¨æ å’Œåº•éƒ¨æ§åˆ¶æ  (ä¿æŒä¸å˜) */
.video-call-top-bar {
    position: absolute;
    top: 0; left: 0; width: 100%;
    padding: 15px 20px;
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    text-align: center;
    box-sizing: border-box;
    pointer-events: none;
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}
.video-call-controls {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    box-sizing: border-box;
}

/* 3. å‚ä¸è€…å¤´åƒæ˜¾ç¤ºåŒº (ä¿æŒä¸å˜) */
.video-call-avatar-area {
    flex-grow: 1; 
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    padding-top: 80px; /* ç¡®ä¿é¡¶éƒ¨æœ‰è¶³å¤Ÿç©ºé—´ */
    box-sizing: border-box;
    overflow-y: auto; /* â˜… æ–°å¢:å¦‚æœå¤´åƒå¤ªå¤š,å…è®¸æ­¤åŒºåŸŸæ»šåŠ¨ */
}

/* 4. å¤´åƒç½‘æ ¼å®¹å™¨ (ä¿æŒä¸å˜) */
#participant-avatars-grid {
    display: flex;
    flex-wrap: wrap; 
    justify-content: center;
    align-items: center;
    gap: 15px; /* â˜… ç¨å¾®å‡å°å¤´åƒé—´è· */
    max-width: 100%;
}

/* 5. å•ä¸ªå‚ä¸è€…çš„å¤´åƒå®¹å™¨ (å¤´åƒç¼©å°) */
.participant-avatar-wrapper {
    position: relative;
    text-align: center;
    flex-shrink: 0;
}
.participant-avatar {
    width: 70px;   /* â˜… ä» 80px ç¼©å°åˆ° 70px */
    height: 70px;  /* â˜… ä» 80px ç¼©å°åˆ° 70px */
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 12px;
    color: #ccc;
}

/* 6. å‘è¨€è€…å¤´åƒé«˜äº®æ•ˆæœ (ä¿æŒä¸å˜) */
.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}

/* 7. ã€æœ€ç»ˆç‰ˆã€‘å¯¹è¯æ¡†åŒºåŸŸ */
#video-call-main {
    flex-shrink: 0; 
    height: 30%;   /* â˜… æ ¸å¿ƒä¿®æ”¹:é«˜åº¦ä»35%å‡å°åˆ°30% */
    margin: 15px 15px 130px 15px; /* â˜… æ ¸å¿ƒä¿®æ”¹:åº•éƒ¨è¾¹è·ä»120pxå¢åŠ åˆ°130px,åˆ›é€ æ˜æ˜¾ç©ºéš™ */
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-sizing: border-box;
}

/* 8. æ§åˆ¶æŒ‰é’®æ ·å¼ (ä¿æŒä¸å˜) */
.control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, background-color 0.2s;
}
.control-btn:active {
    transform: scale(0.9);
}
.control-btn.speak-btn {
    background-color: rgba(255,255,255,0.2);
    background-size: 55%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
}
.control-btn.hangup-btn {
    background-color: #ff3b30;
    background-size: 50%;
    background-image: url('https://sharkpan.xyz/f/ppmNSQ/MaterialSymbolsCall.png');
}
.control-btn.join-btn {
    background-color: #007bff;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
}

/* â–²â–²â–² æ–°CSSæ›¿æ¢ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯å¯¹è¯æ°”æ³¡æ ·å¼ â–¼â–¼â–¼ */
.call-message-bubble {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

.call-message-bubble.ai-speech {
    background-color: rgba(255, 255, 255, 0.15);
    align-self: flex-start; /* AIå‘è¨€é å·¦ */
}

.call-message-bubble.user-speech {
    background-color: #4cd964; /* ç”¨æˆ·å‘è¨€ç”¨ç»¿è‰²,ç±»ä¼¼å¾®ä¿¡ */
    align-self: flex-end;   /* ç”¨æˆ·å‘è¨€é å³ */
    text-align: left; /* ç¡®ä¿ç”¨æˆ·æ°”æ³¡å†…çš„æ–‡å­—æ˜¯å·¦å¯¹é½çš„ */
}
/* â–²â–²â–² æ–°å¢CSSç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç›´æ’­é—´äººè®¾é€‰æ‹©å™¨æ ·å¼ â–¼â–¼â–¼ */
#live-streamer-persona-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}
.persona-preview-box {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #f9f9f9;
}
#phone-screen.dark-mode .persona-preview-box {
    background-color: #2c2c2e;
}
.persona-preview-box img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}
.persona-preview-box span {
    font-weight: 500;
}
#live-select-persona-btn {
    flex-shrink: 0;
    margin-top: 0;
}
#live-streamer-info-clickable {
    cursor: pointer;
    transition: background-color 0.2s;
}
#live-streamer-info-clickable:hover {
    background-color: rgba(0,0,0,0.6);
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#outgoing-call-screen {
    background-color: #1c1c1e;
    color: white;
    justify-content: center; /* å‚ç›´å±…ä¸­ */
    align-items: center;   /* æ°´å¹³å±…ä¸­ */
}

.outgoing-call-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.outgoing-call-actions {
    margin-top: 50px; /* å’Œä¸Šæ–¹æ–‡å­—æ‹‰å¼€è·ç¦» */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}
/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

/* 1. åŠ¨æ€å¸–å­çš„å¤–å±‚å®¹å™¨,æˆ‘ä»¬éœ€è¦å®ƒæ¥å®šä½å’Œè£å‰ª */
.qzone-post-container {
    position: relative; /* è®©å†…éƒ¨çš„åˆ é™¤æŒ‰é’®å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½ */
    overflow: hidden;   /* éšè—æ‰è¶…å‡ºéƒ¨åˆ†çš„åˆ é™¤æŒ‰é’® */
    border-radius: 12px;/* å’Œå†…éƒ¨å¡ç‰‡ä¿æŒä¸€è‡´çš„åœ†è§’ */
}
/* â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘è¿™ä¸ªCSSè§„åˆ™ â–¼â–¼â–¼ */
.qzone-post-container {
    position: relative;
    border-radius: 0; /* ç¡®ä¿æ²¡æœ‰åœ†è§’ */
    overflow: visible; /* ã€é‡è¦ã€‘å…è®¸å†…å®¹æº¢å‡ºï¼Œè™½ç„¶è¿™é‡Œç”¨ä¸åˆ° */
    
    /* ã€æ ¸å¿ƒä¿®æ”¹3ã€‘å°†åˆ†å‰²çº¿åº”ç”¨åˆ°è¿™é‡Œ */
    border-bottom: 1px solid #e9e9e9; 
    width: 100% !important;
}

/* ã€æ–°å¢ã€‘ä¸ºæœ€åä¸€ä¸ªå®¹å™¨ç§»é™¤åº•éƒ¨åˆ†å‰²çº¿ï¼Œé¿å…åˆ—è¡¨æœ«å°¾æœ‰å¤šä½™çš„çº¿ */
#qzone-posts-list .qzone-post-container:last-child {
    border-bottom: none;
}

#phone-screen.dark-mode .qzone-post-container {
    border-bottom-color: #2c2c2e; /* å¤œé—´æ¨¡å¼çš„åˆ†å‰²çº¿é¢œè‰² */
}
/* â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€æœ€ç»ˆåˆ†å‰²çº¿ä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰€æœ‰æ—§çš„ qzone-post-item ç›¸å…³è§„åˆ™ â–¼â–¼â–¼ */
/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .qzone-post-item â–¼â–¼â–¼ */
.qzone-post-item {
    /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å°†å†…è¾¹è·çš„ä¸Šä¸‹éƒ¨åˆ†åˆ†å¼€è®¾ç½®ï¼Œé¡¶éƒ¨ä¸º0ï¼Œåº•éƒ¨å¢åŠ  */
    padding: 0 15px 15px 15px !important; 
    
    background-color: #fff !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    
    /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ç§»é™¤è¿™é‡Œçš„æ‰€æœ‰è¾¹æ¡†å±æ€§ */
    border: none !important;
    border-top: none !important;
    
    position: relative !important;
    z-index: 2 !important;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* å¤œé—´æ¨¡å¼çš„æ ·å¼ */
#phone-screen.dark-mode .qzone-post-item {
    background-color: #000000 !important;
    /* å¤œé—´æ¨¡å¼ä¸‹çš„åˆ†å‰²çº¿é¢œè‰² */
    border-top-color: #2c2c2e !important;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */
/* â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ .qzone-post-delete-action â–¼â–¼â–¼ */
.qzone-post-delete-action {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 90px;
    
    /* ã€æ ¸å¿ƒä¿®æ”¹1ã€‘èƒŒæ™¯è‰²æ”¹ä¸ºå®Œå…¨é€æ˜ */
    background-color: transparent;
    
    color: #ff3b30; /* ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ–‡å­—é¢œè‰²æ”¹ä¸ºçº¢è‰² */
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    cursor: pointer;
    z-index: 1;
    
    /* ã€æ–°å¢ã€‘ä¸ºâ€œåˆ é™¤â€æ–‡å­—æ·»åŠ ä¸€ä¸ªç™½è‰²èƒŒæ™¯ï¼Œä½¿å…¶æ›´çªå‡º */
    font-size: 14px;
}
.qzone-post-delete-action span {
    background-color: #ff3b30; /* å°†èƒŒæ™¯è‰²åŠ åœ¨æ–‡å­—æœ¬èº«ä¸Š */
    color: white; /* æ–‡å­—é¢œè‰²å˜å›ç™½è‰² */
    padding: 8px 15px;
    border-radius: 20px;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* 4. å½“å¡ç‰‡å·¦æ»‘æ—¶,æŠŠå®ƒå‘å·¦ç§»åŠ¨,éœ²å‡ºåˆ é™¤æŒ‰é’® */
.qzone-post-item.swiped {
    transform: translateX(-90px); /* ç§»åŠ¨çš„è·ç¦»å’Œåˆ é™¤æŒ‰é’®çš„å®½åº¦ä¸€è‡´ */
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„â€œæ‹ä¸€æ‹â€æ ·å¼,ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. â€œæ‹ä¸€æ‹â€çš„å±å¹•éœ‡åŠ¨åŠ¨ç”» */
@keyframes pat-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.pat-animation {
    animation: pat-shake 0.4s ease-in-out;
}

/* 2. â€œæ‹ä¸€æ‹â€ç³»ç»Ÿæç¤ºæ¶ˆæ¯çš„æ ·å¼ */
.system-message {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* è®©â€œæ‹ä¸€æ‹â€ç±»å‹çš„ wrapper å±…ä¸­ */
.message-wrapper.system-pat {
    justify-content: center;
    align-self: center;
    margin: 5px 0;
    max-width: 80%;
}
/* â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯æ°”æ³¡çš„æ ·å¼ */
.message-bubble.system-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ä¿®æ­£:è®©é¡¶éƒ¨æ“ä½œæ å¯ä»¥æ¨ªå‘æ»šåŠ¨ === */
#chat-input-actions-top {
    display: flex;
    gap: 8px;
    padding: 0 5px;

    /* --- æ ¸å¿ƒä»£ç å¼€å§‹ --- */
    overflow-x: auto;      
    flex-wrap: nowrap;     
    -webkit-overflow-scrolling: touch; 

    scrollbar-width: none; 
    -ms-overflow-style: none;  
}

#chat-input-actions-top::-webkit-scrollbar {
    display: none; 
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©ç•Œé¢å¤´éƒ¨çŠ¶æ€æ æ ·å¼ === */

/* 1. æ ‡é¢˜å’ŒçŠ¶æ€çš„æ€»å®¹å™¨,ä½¿ç”¨flexå¸ƒå±€è®©å®ƒä»¬å‚ç›´æ’åˆ— */
#chat-header-title-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center; /* æ°´å¹³å±…ä¸­ */
    gap: 2px; /* æ ‡é¢˜å’ŒçŠ¶æ€ä¹‹é—´çš„å¾®å°é—´è· */
    
    /* ä¸ºäº†è®©å®ƒèƒ½åœ¨flexå¸ƒå±€ä¸­æ­£ç¡®å±…ä¸­ */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    max-width: 60%;
}

/* 2. ä¸»æ ‡é¢˜çš„æ ·å¼å¾®è°ƒ */
#chat-header-title {
    font-size: 16px; /* å¯ä»¥ç¨å¾®ç¼©å°ä¸€ç‚¹,ç»™çŠ¶æ€æ ç•™å‡ºç©ºé—´ */
    font-weight: 600;
    position: static; /* è¦†ç›–æ‰æ—§çš„absoluteå®šä½ */
    transform: none;  /* è¦†ç›–æ‰æ—§çš„transform */
    /* ä¿è¯é•¿æ ‡é¢˜ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤ºçœç•¥å· */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* 3. çŠ¶æ€æ å®¹å™¨ */
#chat-header-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

/* ============================
   ğŸŒ¿ çŠ¶æ€å°åœ†ç‚¹æ”¹æˆ SVG å›¾æ ‡
   ============================ */
.status-dot {
    width: 7px;
    height: 7px;

    /* ä½¿ç”¨ SVG ä½œä¸ºé®ç½©,æ˜¾ç¤ºå›¾å½¢ */
    background-color: #4cd964; /* ä¿ç•™åŸç»¿è‰² */
    -webkit-mask: url('data:image/svg+xml;utf8,<svg t="1755417122203" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M134.869333 239.36a234.666667 234.666667 0 0 0 0 331.946667l286.634667 286.592a128 128 0 0 0 180.992 0l286.634667-286.634667a234.666667 234.666667 0 1 0-331.861334-331.861333l-6.058666 6.016 101.12 101.12a27.733333 27.733333 0 0 1-39.253334 39.168l-146.346666-146.346667a234.666667 234.666667 0 0 0-331.861334 0z" fill="white"/></svg>') no-repeat center / contain;
    -webkit-mask-repeat: no-repeat;
    mask: url('data:image/svg+xml;utf8,<svg t="1755417122203" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M134.869333 239.36a234.666667 234.666667 0 0 0 0 331.946667l286.634667 286.592a128 128 0 0 0 180.992 0l286.634667-286.634667a234.666667 234.666667 0 1 0-331.861334-331.861333l-6.058666 6.016 101.12 101.12a27.733333 27.733333 0 0 1-39.253334 39.168l-146.346666-146.346667a234.666667 234.666667 0 0 0-331.861334 0z" fill="white"/></svg>') no-repeat center / contain;
    mask-repeat: no-repeat;

    /* å»æ‰åœ†å½¢èƒŒæ™¯ */
    border-radius: 0;

    transition: background-color 0.3s ease;
}


/* å½“AIçŠ¶æ€ä¸ºâ€œå¿™ç¢Œâ€æˆ–â€œç¦»å¼€â€æ—¶,è®©åœ†ç‚¹å˜ç°è‰² */
#chat-header-status.busy .status-dot {
    background-color: #cccccc;
}

/* 5. çŠ¶æ€æ–‡æœ¬ */
.status-text {
    font-weight: 500;
}

/* === ã€å…¨æ–°ç¾åŒ–ç‰ˆã€‘å›å¿†å¡ç‰‡æ ·å¼ === */

/* 1. å¡ç‰‡æ€»å®¹å™¨:è¿™é‡Œè´Ÿè´£å®šä¹‰æ•´ä½“çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡† */
.memory-card {
    background-color: #fffaf0; /* ç»Ÿä¸€çš„ã€æ¸©æš–çš„ç±³é»„è‰²èƒŒæ™¯ */
    border-radius: 12px;
    padding: 15px; /* åœ¨å¡ç‰‡å››å‘¨ç•™å‡ºå†…è¾¹è· */
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border-left: 5px solid #ffb74d; 
    display: flex; /* è®©å®ƒæˆä¸ºflexå®¹å™¨,æ–¹ä¾¿å†…éƒ¨å…ƒç´ æ’åˆ— */
    flex-direction: column; /* è®©å¤´éƒ¨å’Œå†…å®¹å‚ç›´å †å  */
    gap: 8px; /* åœ¨å¤´éƒ¨å’Œå†…å®¹ä¹‹é—´åˆ›é€ ä¸€ä¸ªè‡ªç„¶çš„é—´è· */
}

/* 2. å¤´éƒ¨å®¹å™¨:ç°åœ¨åªè´Ÿè´£å¸ƒå±€å’Œåˆ†å‰²çº¿ */
.memory-card .header {
    border-bottom: 1px solid rgba(217, 129, 0, 0.15); /* åˆ†å‰²çº¿é¢œè‰²å¯ä»¥ç¨å¾®åŠ æ·±ä¸€ç‚¹ */
    padding-bottom: 8px; 
}

/* 3. æ—¥æœŸæ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .header .date {
    font-size: 11px;
    color: #a1887f;
    margin-bottom: 4px; 
}

/* 4. ä½œè€…æ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .header .author {
    font-weight: 600;
    color: #d98100;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 5. å†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
.memory-card .content {
    font-size: 14px;
    line-height: 1.7;
    color: #5d4037;
    white-space: pre-wrap;
}

/* === ã€å…¨æ–°ã€‘çº¦å®š/å€’è®¡æ—¶å¡ç‰‡æ ·å¼ === */
.countdown-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    text-align: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}
.countdown-card::before {
    content: 'âœ¨';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 50px;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.countdown-card .title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}
.countdown-card .timer {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 15px;
}
.countdown-card .target-date {
    font-size: 12px;
    opacity: 0.8;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 10px;
}

/* === ã€å…¨æ–°ã€‘èŠå¤©é”å®šé®ç½©å±‚æ ·å¼ === */
#chat-lock-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 150; /* æ¯”è¾“å…¥æ¡†é«˜,æ¯”è´´çº¸é¢æ¿ä½ */
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    border-top: 1px solid var(--border-color);
    text-align: center;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#chat-lock-content .lock-text {
    color: var(--text-secondary);
    font-size: 14px;
}
#chat-lock-content .lock-action-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 1px solid var(--accent-color);
    background-color: var(--accent-color);
    color: white;
    cursor: pointer;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent;
    color: var(--accent-color);
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
.message-bubble.is-red-packet .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.red-packet-card {
    width: 220px;
    border-radius: 8px;
    background: linear-gradient(160deg, #F96259, #E44D44);
    color: #ffd700; /* é‡‘è‰²æ–‡å­— */
    padding: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.red-packet-card.opened {
    background: linear-gradient(160deg, #d3c4a0, #c4b693);
    cursor: default;
}

.red-packet-card::before {
    content: 'ğŸ§§';
    position: absolute;
    top: -5px;
    left: -5px;
    font-size: 30px;
    opacity: 0.2;
    transform: rotate(-10deg);
}

.rp-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.rp-icon {
    width: 20px;
    height: 20px;
}

.rp-greeting {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rp-type {
    font-size: 11px;
    color: white;
    opacity: 0.8;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 8px;
    margin-top: 8px;
}

.rp-claimed-info {
    font-size: 13px;
    color: white;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.3);
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
.rp-details-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.rp-details-item:last-child {
    border-bottom: none;
}
.rp-details-item .name {
    flex-grow: 1;
    font-weight: 500;
    color: #333;
}
.rp-details-item .amount {
    font-weight: 500;
    color: #555;
}
.rp-details-item .lucky-king-tag {
    font-size: 10px;
    background-color: #ffd700;
    color: #a67c00;
    padding: 2px 5px;
    border-radius: 4px;
    margin-left: 8px;
    font-weight: bold;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* æŠ•ç¥¨å¡ç‰‡åœ¨æ¶ˆæ¯æ°”æ³¡ä¸­çš„æ ·å¼ */
.message-bubble.is-poll .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/* æŠ•ç¥¨å¡ç‰‡ä¸»ä½“ */
.poll-card {
    width: 250px;
    background-color: #f9f9f9;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.poll-card.closed {
    background-color: #e9ecef; /* ç»“æŸåå˜ç° */
}

/* æŠ•ç¥¨é—®é¢˜ */
.poll-question {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.4;
    word-break: break-word;
}

/* æŠ•ç¥¨é€‰é¡¹åˆ—è¡¨ */
.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* å•ä¸ªæŠ•ç¥¨é€‰é¡¹ */
.poll-option-item {
    background-color: white;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: background-color 0.2s;
}

.poll-card:not(.closed) .poll-option-item:hover {
    background-color: #f0f8ff;
}

/* ç”¨æˆ·å·²æŠ•ç¥¨çš„é€‰é¡¹æ ·å¼ */
.poll-option-item.voted {
    border-color: var(--accent-color);
    background-color: #e7f3ff;
    font-weight: 500;
}

/* æŠ•ç¥¨è¿›åº¦æ¡ */
.poll-option-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 1;
    transition: width 0.3s ease-in-out;
}

/* é€‰é¡¹å†…å®¹(æ–‡å­—å’Œç¥¨æ•°),ç¡®ä¿åœ¨è¿›åº¦æ¡ä¹‹ä¸Š */
.poll-option-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-option-text {
    font-size: 14px;
}

.poll-option-votes {
    font-size: 13px;
    color: #8a8a8a;
    font-weight: 500;
}

/* æŠ•ç¥¨å¡ç‰‡åº•éƒ¨ */
.poll-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.poll-total-votes {
    font-weight: 500;
}

.poll-action-btn {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 4px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}
.poll-card.closed .poll-action-btn {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

/* åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡†çš„é€‰é¡¹è¾“å…¥ */
.poll-option-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.poll-option-input-wrapper input {
    flex-grow: 1;
}
.poll-option-input-wrapper .remove-option-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #ff3b30;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    flex-shrink: 0;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === ã€å…¨æ–°ã€‘èŠå¤©å¤´éƒ¨â€œæ­£åœ¨è¾“å…¥â€çŠ¶æ€æ ·å¼ === */
#chat-header-title.typing-status {
    color: var(--text-secondary);
    animation: typing-pulse 1.5s infinite;
    font-style: italic;
}

@keyframes typing-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

#chat-header-title {
    transition: opacity 0.2s ease-in-out;
}

@keyframes message-pop-in {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.animate-in {
  animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
  }

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘Appå›¾æ ‡è®¾ç½®æ ·å¼ â–¼â–¼â–¼ */
#icon-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}

.icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.change-icon-btn {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§‚è®¾ç½®é¡µé¢å¸ƒå±€ä¿®æ­£ â–¼â–¼â–¼ */

/* 1. ä¿®æ­£æ»šåŠ¨é—®é¢˜ */
#wallpaper-screen .form-container {
    /* æ ¸å¿ƒä¿®æ­£1: è§£å†³flexå¸ƒå±€ä¸‹çš„æ»šåŠ¨å†²çª,è®©æ»šåŠ¨æ¡èƒ½æ­£å¸¸å‡ºç° */
    min-height: 0; 
}

/* 2. ä¿®æ­£å£çº¸é¢„è§ˆè¢«å‹æ‰çš„é—®é¢˜ */
#wallpaper-preview {
    /* æ ¸å¿ƒä¿®æ­£2: é˜²æ­¢é¢„è§ˆæ¡†è¢«è¿‡å¤šçš„å†…å®¹æŒ¤å‹å˜å½¢,è®©å®ƒä¿æŒè‡ªå·±çš„é«˜åº¦ */
    flex-shrink: 0; 
}
/* â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½æ ·å¼ (æ— å›¾ç‰ˆ) â–¼â–¼â–¼ */

/* 1. æµè§ˆå™¨ç•Œé¢èƒŒæ™¯è‰²å’Œå†…å®¹åŒºæ ·å¼ (ä¿æŒä¸å˜) */
#browser-screen {
    background-color: #f8f9fa;
}
#browser-content {
    padding: 20px;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    overflow-y: auto;
    background-color: #f8f9fa;
}
#browser-content .article-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}
#browser-content .article-meta {
    font-size: 13px;
    color: #8a8a8a;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
#browser-content .article-body {
    white-space: pre-wrap;
    word-break: break-word;
}
#browser-content .article-body p {
    margin-bottom: 1em;
}

/* 2. èŠå¤©æ°”æ³¡ä¸­çš„é“¾æ¥å¡ç‰‡æ ·å¼ (æ— å›¾ç‰ˆ) */
.message-bubble.is-link-share .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.link-share-card {
    width: 210px; 
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.link-share-card:hover {
    background-color: #f9f9f9;
}

.link-share-card .title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.4;
    color: #1f1f1f;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .description {
    font-size: 13px;
    color: #8a8a8a;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .footer {
    display: flex; /* è®©å›¾æ ‡å’Œæ–‡å­—æ°´å¹³å¯¹é½ */
    align-items: center;
    gap: 6px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px; /* å’Œä¸Šé¢çš„æè¿°æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}
.link-share-card .footer-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* å•æ¡è¯„è®ºçš„å®¹å™¨,ç°åœ¨éœ€è¦ç›¸å¯¹å®šä½ */
.comment-item {
    position: relative;
    padding-right: 25px; /* åœ¨å³ä¾§ç•™å‡ºåˆ é™¤æŒ‰é’®çš„ç©ºé—´ */
}

/* è¯„è®ºåˆ é™¤æŒ‰é’®çš„æ ·å¼ */
.comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0; /* é»˜è®¤éšè— */
}

/* é¼ æ ‡æ‚¬åœåœ¨è¯„è®ºä¸Šæ—¶,æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
.comment-item:hover .comment-delete-btn {
    opacity: 1;
}

.comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å£çº¸åº“æ ·å¼ â–¼â–¼â–¼ */
#wallpaper-grid {
    display: grid;
    /* â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼ */
    grid-template-columns: repeat(3, 1fr); 
    /* â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² */
    gap: 15px;
    padding: 15px;
}

.wallpaper-thumbnail-item {
    position: relative;
    aspect-ratio: 9 / 16; /* æ¨¡æ‹Ÿæ‰‹æœºå±å¹•æ¯”ä¾‹ */
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.wallpaper-preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.wallpaper-actions {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(transparent, rgba(0,0,0,0.6));
    padding: 8px;
    box-sizing: border-box;
    display: flex;
    justify-content: space-around;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s ease-in-out;
}

.wallpaper-thumbnail-item:hover .wallpaper-actions {
    opacity: 1; /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ“ä½œæŒ‰é’® */
}

.wallpaper-action-btn {
    background-color: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
}

.wallpaper-action-btn.delete {
    background-color: rgba(255, 59, 48, 0.9);
    color: white;
}
/* â–²â–²â–² å£çº¸åº“æ ·å¼ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–è§‚è®¾ç½®é¡µé¢æ•´åˆä¸ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

/* 1. å¼€å…³å¹¶æ’å¸ƒå±€çš„å®¹å™¨ */
.toggle-switch-container {
    display: flex;
    justify-content: space-around; /* è®©ä¸¤ä¸ªå¼€å…³å‡åŒ€åˆ†å¸ƒ */
    align-items: center;
    width: 100%;
    background-color: #f9f9f9;
    padding: 10px 0;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .toggle-switch-container {
    background-color: #1c1c1e; /* å¤œé—´æ¨¡å¼é€‚é… */
}
.toggle-switch-container .form-group {
    display: flex;
    flex-direction: column; /* è®©æ–‡å­—å’Œå¼€å…³å‚ç›´æ’åˆ— */
    align-items: center;
    gap: 8px; /* æ–‡å­—å’Œå¼€å…³çš„é—´è· */
    margin-bottom: 0; /* ç§»é™¤é»˜è®¤çš„ä¸‹è¾¹è· */
}
.toggle-switch-container .form-group label:first-child {
    margin-bottom: 0;
    font-size: 14px;
}

/* 2. å…¨æ–°çš„Appå›¾æ ‡è®¾ç½®é¡¹æ ·å¼ */
#icon-settings-grid {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* è®©æ¯é¡¹æ›´å®½ä¸€äº› */
    gap: 25px; /* åŠ å¤§é—´è· */
}
.icon-setting-item {
    gap: 12px; /* åŠ å¤§å…ƒç´ é—´è· */
}
.icon-setting-item .icon-preview-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
}
.icon-setting-item .icon-preview-wrapper .label {
    font-size: 13px;
    font-weight: 500;
}
.icon-action-buttons {
    display: flex;
    gap: 8px; /* ä¸¤ä¸ªæŒ‰é’®ä¹‹é—´çš„é—´è· */
}
.icon-action-buttons .icon-btn {
    padding: 5px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
}
#phone-screen.dark-mode .icon-action-buttons .icon-btn {
    background-color: #333;
    border-color: #555;
    color: #fff;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘@æåŠå¼¹çª—å¤œé—´æ¨¡å¼é€‚é… â–¼â–¼â–¼ */
#phone-screen.dark-mode .at-mention-popup {
    background-color: #2c2c2e; /* æ·±ç°è‰²èƒŒæ™¯ */
    border-color: #38383a;
}
#phone-screen.dark-mode .at-mention-item {
    border-bottom-color: #38383a;
}
#phone-screen.dark-mode .at-mention-item:hover {
    background-color: #3e3e42;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSS,ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

    /* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾åŒ–ç‰ˆåº”ç”¨å¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
/* 1. é¢„è§ˆåŒºåŸŸå®¹å™¨ */
.frame-apply-preview-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 95%;
    background-color: #f9f9f9;
    padding: 15px 0;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
#phone-screen.dark-mode .frame-apply-preview-container {
    background-color: #1c1c1e; /* å¤œé—´æ¨¡å¼é€‚é… */
}

/* 2. å•ä¸ªé¢„è§ˆç›®æ ‡ (å¤´åƒ + æ–‡å­—) */
.frame-apply-target {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
.frame-apply-target .avatar-frame-wrapper {
    width: 70px;
    height: 70px;
}

/* 3. æ“ä½œæŒ‰é’®å®¹å™¨ */
.frame-apply-actions {
    display: flex;
    justify-content: space-around;
    width: 100%;
    gap: 15px;
}

/* 4. å°å°ºå¯¸æŒ‰é’®æ ·å¼ */
.form-button.small {
    padding: 8px 15px;
    font-size: 14px;
    flex: 1; /* è®©æŒ‰é’®å¹³åˆ†å®½åº¦ */
    margin: 0 !important;
}

/* 5. é“¾æ¥å¼æŒ‰é’®æ ·å¼ (ç”¨äºâ€œç§»é™¤â€) */
.button-as-link {
    background: none;
    border: none;
    font-size: 13px;
    cursor: pointer;
    padding: 5px;
    color: var(--text-secondary);
}
.button-as-link.danger {
    color: #ff3b30;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* ============================
   ğŸŒ€ èŠå¤©è¾“å…¥åŒº (èåˆç‰ˆ)
   - å¤–å±‚å¸ƒå±€æ¥è‡ªã€æ®µ2ã€‘
   - å†…éƒ¨ç»†èŠ‚æ¥è‡ªã€æ®µ1ã€‘
   ============================ */

/* ä¸»å®¹å™¨ */
#chat-input-area {
  flex-direction: column;
  gap: 0;
  position: relative;
  border-radius: 0;
  padding: 0; /* ç§»é™¤å®¹å™¨è‡ªèº«çš„å†…è¾¹è·,ç¡®ä¿å…¶èƒŒæ™¯èƒ½æ’‘æ»¡æ•´ä¸ªå®½åº¦ */

}

/* è¾“å…¥è¡Œ */
#chat-input-main-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  width: 100%;
  background-color: transparent; /* <-- ä¿®æ”¹è¿™é‡Œ */
  padding: 8px 12px;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  padding-left: calc(8px + env(safe-area-inset-left));
  padding-right: calc(8px + env(safe-area-inset-right));
  box-sizing: border-box;
}

/* åŠ å·/å…³é—­æŒ‰é’® */
#open-actions-btn {
  width: 36px;
  height: 36px;
  padding: 6px; /* è°ƒæ•´å†…è¾¹è·è®©å›¾æ ‡å±…ä¸­ */
  box-sizing: border-box; /* ç¡®ä¿å†…è¾¹è·ä¸å½±å“æ€»å°ºå¯¸ */
  background: none;
  border: none;
  cursor: pointer; /* ç¡®ä¿é¼ æ ‡æ‚¬åœæ—¶æ˜¯å°æ‰‹å½¢çŠ¶ */
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ã€æ–°å¢ã€‘ä¸ºæ–°å›¾æ ‡å›¾ç‰‡è®¾ç½®æ ·å¼ */
#open-actions-btn img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}
#open-actions-btn.active {
  transform: rotate(135deg); /* ä¼˜åŒ–ç‰ˆæ—‹è½¬ */
}

/* è¾“å…¥æ¡†å®¹å™¨ */
.input-wrapper {
  position: relative;
  flex-grow: 1;
  display: flex;
  align-items: center;
}
#chat-input {
  width: 100%;
  padding: 10px 15px;
  padding-right: 45px; /* è¯­éŸ³æŒ‰é’®é¢„ç•™ç©ºé—´ */
  border-radius: 20px;
  border: none;
  background-color: var(--secondary-bg);
  font-size: 16px;
  max-height: 100px;
  resize: none;
}

/* è¯­éŸ³æŒ‰é’® */
#voice-message-btn {
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  padding: 0;
  background: none;
  border: none;
  color: var(--text-secondary);
  z-index: 5;
}
#voice-message-btn img {
  width: 100%;
  height: 100%;
}

/* å‘é€ & ç­‰å¾…æŒ‰é’® */
#wait-reply-btn,
#send-btn {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: var(--secondary-bg);
  border: none;
  flex-shrink: 0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
#wait-reply-btn img {
  height: 24px;
  width: 24px;
}
#send-btn {
  background-color: var(--accent-color);
  color: white;
}
#send-btn svg {
  stroke: white;
}

/* åº•éƒ¨åŠŸèƒ½é¢æ¿ */
#chat-actions-panel {
  height: 0; /* ä¼˜åŒ–ç‰ˆçš„å¹³æ»‘å±•å¼€ */
  overflow: hidden;
  transition: height 0.3s ease-in-out;
  background-color: #f7f8fa;
  padding-top: 0;
  padding-bottom: env(safe-area-inset-bottom);
}
#phone-screen.dark-mode #chat-actions-panel {
  background-color: #1c1c1e;
}
#chat-actions-panel.visible {
  height: 220px;
  padding-top: 20px;
}

/* æ¨ªå‘æ»šåŠ¨å®¹å™¨ */
.actions-panel-scroll-wrapper {
  display: flex;
  overflow-x: auto;
  padding: 0 15px;
  scrollbar-width: none; 
  -ms-overflow-style: none;
}
.actions-panel-scroll-wrapper::-webkit-scrollbar {
  display: none; 
}

/* å•é¡µå›¾æ ‡ç½‘æ ¼ */
.actions-page {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px 15px;
  flex-shrink: 0;
  width: 100%;
}

/* åŠŸèƒ½å›¾æ ‡ */
.action-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}
.action-icon-bg {
  width: 35px;
  height: 35px;
  background-color: #ffffff;
  border-radius: 15px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
#phone-screen.dark-mode .action-icon-bg {
  background-color: #3e3e42;
}
.action-icon-bg img, .action-icon-bg svg {
  width: 60%;
  height: 60%;
  object-fit: contain;
  fill: currentColor;
  stroke: currentColor;
}
.action-label {
  font-size: 12px;
  color: var(--text-secondary);
}

/* éšè—æ—§çš„é¡¶éƒ¨æ“ä½œæ  */
#chat-input-actions-top {
  display: none !important;
}

/* === ã€å…¨æ–°ã€‘å¤œé—´æ¨¡å¼æ ·å¼ === */

/* æ ¸å¿ƒ:å½“ #phone-screen æ‹¥æœ‰ .dark-mode ç±»æ—¶,æ¿€æ´»ä»¥ä¸‹æ‰€æœ‰æ ·å¼ */

/* 1. å…¨å±€èƒŒæ™¯å’Œæ–‡æœ¬é¢œè‰² */
#phone-screen.dark-mode {
    --secondary-bg: #1c1c1e; /* ä¸»è¦å¡ç‰‡èƒŒæ™¯è‰² */
    --border-color: #38383a;  /* è¾¹æ¡†é¢œè‰² */
    --text-primary: #ffffff;   /* ä¸»è¦æ–‡å­—é¢œè‰² */
    --text-secondary: #8d8d92; /* æ¬¡è¦æ–‡å­—/å›¾æ ‡é¢œè‰² */
}

/* 2. å„ä¸ªé¡µé¢çš„ä¸»èƒŒæ™¯è‰² */
#phone-screen.dark-mode #chat-list-screen,
#phone-screen.dark-mode #qzone-screen .qzone-content,
#phone-screen.dark-mode #memories-view {
    background-color: #000000;
}

/* 3. èŠå¤©åˆ—è¡¨ */
#phone-screen.dark-mode #chat-list {
    background-color: #000000;
}
#phone-screen.dark-mode .chat-list-item {
    border-bottom-color: rgba(255, 255, 255, 0.15);
}
#phone-screen.dark-mode .chat-group-header {
    background-color: #1c1c1e; /* ä»ç™½è‰²æ”¹ä¸ºæ·±ç°è‰² */
    border-bottom: 1px solid #38383a; /* ç»™å®ƒä¸€ä¸ªç»†å¾®çš„ä¸‹è¾¹æ¡† */
}
#phone-screen.dark-mode .chat-list-item .name,
#phone-screen.dark-mode .chat-group-header .group-name {
    color: #ffffff;
}
#phone-screen.dark-mode .chat-list-item:hover {
    background-color: #1c1c1e;
}

/* 4. é¡¶éƒ¨/åº•éƒ¨å¯¼èˆªæ  */
#phone-screen.dark-mode .header,
#phone-screen.dark-mode .qzone-header {
    background-color: rgba(25, 25, 25, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-bottom-color: rgba(255, 255, 255, 0.15);
    color: #ffffff;
}
#phone-screen.dark-mode .header .back-btn,
#phone-screen.dark-mode .header .action-btn,
#phone-screen.dark-mode .header .save-btn {
    color: #ffffff;
}
#phone-screen.dark-mode #chat-list-bottom-nav {
    background-color: rgba(25, 25, 25, 0.9);
    border-top-color: rgba(255, 255, 255, 0.15);
}
#phone-screen.dark-mode .nav-item.active {
    color: #ffffff;
}

/* 5. èŠå¤©ç•Œé¢ */
#phone-screen.dark-mode #chat-input-area {
    background-color: rgba(5, 5, 5, 0.8);
    border-top: none;
}
#phone-screen.dark-mode #chat-input {
    background-color: #3e3e42;
    color: #ffffff;
}
#phone-screen.dark-mode #chat-input::placeholder {
    color: #8d8d92;
}
#phone-screen.dark-mode .chat-action-icon-btn {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
    border: none;
}
#phone-screen.dark-mode #send-btn {
    background-color: var(--accent-color);
}

/* 6. åŠ¨æ€ (QZone) ç•Œé¢ */
#phone-screen.dark-mode .qzone-actions-bar,
#phone-screen.dark-mode .qzone-post-item {
    background-color: #1c1c1e;
    border: 1px solid #333;
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
}
#phone-screen.dark-mode .action-item:not(:last-child)::after {
    background-color: #333;
}
#phone-screen.dark-mode .post-footer,
#phone-screen.dark-mode .post-likes-section {
    border-top-color: #333;
}
#phone-screen.dark-mode .post-likes-section {
    background-color: rgba(0, 123, 255, 0.1);
}
#phone-screen.dark-mode .comment-input {
    background-color: #333;
    color: #ffffff;
}
#phone-screen.dark-mode .comment-input::placeholder {
    color: #8d8d92;
}
#phone-screen.dark-mode .post-actions-btn:hover {
    background-color: #333;
}
#phone-screen.dark-mode .at-mention-popup {
    background-color: #1c1c1e;
    border-color: #333;
}
#phone-screen.dark-mode .at-mention-item {
    border-bottom-color: #333;
}
#phone-screen.dark-mode .at-mention-item:hover {
    background-color: #333;
}

/* 7. å›å¿†å½•ç•Œé¢ */
#phone-screen.dark-mode .memory-card {
    background-color: #1c1c1e;
    border-left-color: #e6a753;
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
}
#phone-screen.dark-mode .memory-card .header {
    background-color: #2c2c2e;
    border-bottom-color: #38383a;
    margin: -15px -15px 8px -15px;
    padding: 12px 15px;
    border-radius: 12px 12px 0 0;
}
#phone-screen.dark-mode .memory-card .header .date,
#phone-screen.dark-mode .memory-card .header .author,
#phone-screen.dark-mode .memory-card .content {
    color: #e0e0e0;
}

/* 8. å…¶ä»–è®¾ç½®å’Œåˆ—è¡¨é¡µ */
#phone-screen.dark-mode #api-settings-screen,
#phone-screen.dark-mode #font-settings-screen,
#phone-screen.dark-mode #wallpaper-screen,
#phone-screen.dark-mode #contact-picker-screen,
#phone-screen.dark-mode #member-management-screen,
#phone-screen.dark-mode #world-book-editor-screen,
#phone-screen.dark-mode #world-book-list,
#phone-screen.dark-mode .list-item:hover,
#phone-screen.dark-mode .list-container,
#phone-screen.dark-mode .form-container {
    background-color: #000000;
}
#phone-screen.dark-mode .form-group input, 
#phone-screen.dark-mode .form-group select, 
#phone-screen.dark-mode .form-group textarea {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
#phone-screen.dark-mode .form-button-secondary {
    background-color: #333;
    border-color: #555;
    color: #fff;
}
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e;
    border-color: #38383a;
}
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/* â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—ã€å…¨æ–°çš„ä¿®æ­£CSSã€‘,ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘å¤œé—´æ¨¡å¼è§†è§‰ä¿®æ­£ === */

/* 1. ä¿®æ­£åŠ¨æ€å¡ç‰‡å†…çš„æ–‡å­—é¢œè‰² */
#phone-screen.dark-mode .qzone-post-item .post-nickname,
#phone-screen.dark-mode .qzone-post-item .post-content {
    color: #f0f0f0; /* ä»æ·±ç°è‰²æ”¹ä¸ºæ˜äº®çš„æµ…ç°è‰² */
}

/* 2. ä¿®æ­£æ”¶è—å¡ç‰‡å†…çš„æ–‡å­—é¢œè‰² */
#phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
#phone-screen.dark-mode .favorite-item-card .fav-card-content {
    color: #f0f0f0; /* åŒæ ·æ”¹ä¸ºæµ…ç°è‰² */
}
#phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
    color: #8d8d92; /* æ¥æºæ–‡å­—ç”¨æ¬¡è¦ç°è‰² */
}

/* 3. ä¿®æ­£æ”¶è—é¡µçš„æœç´¢æ èƒŒæ™¯å’Œè¾“å…¥æ¡†æ ·å¼ */
#phone-screen.dark-mode .search-bar-container {
    background-color: #000000; /* å®¹å™¨èƒŒæ™¯å˜ä¸ºçº¯é»‘ */
}
#phone-screen.dark-mode #favorites-search-input {
    background-color: #1c1c1e; /* è¾“å…¥æ¡†èƒŒæ™¯å˜ä¸ºæ·±ç° */
    border-color: #38383a;     /* è¾¹æ¡†é¢œè‰²å˜æš— */
    color: #ffffff;            /* è¾“å…¥æ–‡å­—å˜ä¸ºç™½è‰² */
}
#phone-screen.dark-mode #favorites-search-input::placeholder {
    color: #8d8d92; /* å ä½ç¬¦æ–‡å­—é¢œè‰²å˜æš— */
}

/* â–²â–²â–² ä¿®æ­£CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ä¿®å¤ç‰ˆã€‘å¤´åƒè®¾ç½®æ¨¡æ€æ¡†æ ·å¼ â–¼â–¼â–¼ */
.avatar-editor-preview-area {
    width: 95%; /* è®©å®ƒç¨å¾®çª„ä¸€ç‚¹ï¼Œæœ‰å‘¼å¸æ„Ÿ */
    margin: 0 auto; /* å¼ºåˆ¶æ°´å¹³å±…ä¸­ */
    padding: 15px;
    background-color: #f7f8fa;
    border-radius: 12px;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
}
#phone-screen.dark-mode .avatar-editor-preview-area {
    background-color: #2c2c2e;
}

.avatar-editor-preview-wrapper {
    width: 100px;
    height: 100px;
    position: relative;
}

.avatar-editor-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    width: 95%; /* ä¸é¢„è§ˆåŒºåŸŸå®½åº¦ä¿æŒä¸€è‡´ */
    margin: 0 auto; /* å¼ºåˆ¶æ°´å¹³å±…ä¸­ */
}

.avatar-editor-action-btn {
    padding: 12px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    background-color: #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.avatar-editor-action-btn:hover {
    background-color: #dee2e6;
}
#phone-screen.dark-mode .avatar-editor-action-btn {
    background-color: #3e3e42;
    color: #f0f0f0;
}
#phone-screen.dark-mode .avatar-editor-action-btn:hover {
    background-color: #505054;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠŠè¿™ä¸€æ•´å—å…¨æ–°çš„CSS,ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === ã€å…¨æ–°ã€‘iOSé£æ ¼çš„Toggle Switchå¼€å…³æ ·å¼ === */

/* 1. å¼€å…³çš„å®¹å™¨ */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 51px;
    height: 31px;
}

/* 2. éšè—æ‰åŸå§‹çš„ checkbox è¾“å…¥æ¡† */
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

/* 3. å¼€å…³çš„èƒŒæ™¯(é‚£ä¸ªæ¤­åœ†) */
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e9e9eb; /* å…³é—­æ—¶çš„èƒŒæ™¯è‰² */
    transition: .4s;
    border-radius: 34px;
}

/* 4. å¼€å…³ä¸Šçš„åœ†ç‚¹ */
.slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* 5. ã€æ ¸å¿ƒã€‘å½“ checkbox è¢«é€‰ä¸­æ—¶(å³å¼€å¯çŠ¶æ€) */
input:checked + .slider {
    background-color: #34c759; /* å¼€å¯æ—¶çš„èƒŒæ™¯è‰²(iOSç»¿è‰²)*/
}

input:checked + .slider:before {
    transform: translateX(20px); /* è®©åœ†ç‚¹æ»‘åŠ¨åˆ°å³è¾¹ */
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„â€œå›å¤é¢„è§ˆæ â€ */
#reply-preview-bar {
    display: none; /* é»˜è®¤éšè— */
    padding: 8px 12px;
    margin: 0 8px 8px 8px; /* å’Œè¾“å…¥æ¡†å‘¨å›´çš„è¾¹è·ä¿æŒä¸€è‡´ */
    background-color: rgba(0, 0, 0, 0.05);
    border-left: 3px solid var(--accent-color);
    border-radius: 6px;
    position: relative;
    font-size: 13px;
    color: var(--text-secondary);
}

#phone-screen.dark-mode #reply-preview-bar {
    background-color: rgba(255, 255, 255, 0.1);
}

.reply-preview-content .sender {
    font-weight: 600;
    color: var(--text-primary);
}

.reply-preview-content .text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block; /* ç¡®ä¿çœç•¥å·ç”Ÿæ•ˆ */
    max-width: 95%;
}

#cancel-reply-btn {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.1);
    cursor: pointer;
    font-size: 14px;
}

/* 2. æ¶ˆæ¯æ°”æ³¡å†…éƒ¨çš„â€œå¼•ç”¨æ¶ˆæ¯å—â€ */
.quoted-message {
    padding: 6px 10px;
    margin-bottom: 6px;
    background-color: rgba(0, 0, 0, 0.04);
    border-left: 2px solid var(--accent-color);
    border-radius: 4px;
    font-size: 0.9em; /* å­—ä½“æ¯”æ­£æ–‡å°ä¸€ç‚¹ */
    opacity: 0.8;
    /* (å·²ç§»é™¤ overflow: hidden;) */
}

#phone-screen.dark-mode .quoted-message {
    background-color: rgba(255, 255, 255, 0.08);
    border-left-color: #a0cff1;
}

.quoted-message .quoted-sender {
    font-weight: 600;
    color: var(--accent-color);
}
#phone-screen.dark-mode .quoted-message .quoted-sender {
    color: #a0cff1;
}

.quoted-message .quoted-content {
    color: var(--text-secondary);
    white-space: normal;     /* æ ¸å¿ƒä¿®æ­£1: å…è®¸æ–‡æœ¬æ­£å¸¸æ¢è¡Œ */
    word-break: break-word;  /* æ ¸å¿ƒä¿®æ­£2: å¼ºåˆ¶é•¿å•è¯æˆ–è¿ç»­å­—ç¬¦æ–­å¼€,é˜²æ­¢æº¢å‡º */
    display: block;
    /* (å·²ç§»é™¤ overflow å’Œ text-overflow,å› ä¸ºæˆ‘ä»¬éœ€è¦å¤šè¡Œæ˜¾ç¤ºè€Œä¸æ˜¯å•è¡Œçœç•¥å·) */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¿®æ­£è”ç³»äººé€‰æ‹©å™¨â€œå–æ¶ˆâ€æŒ‰é’®æ ·å¼ â–¼â–¼â–¼ */

/* 1. ä¸“é—¨ä¸ºè¿™ä¸ªâ€œå–æ¶ˆâ€æŒ‰é’®è¦†ç›–æ‰ä¸ºå›¾æ ‡è®¾è®¡çš„æ—§æ ·å¼ */
#contact-picker-screen .header .back-btn {
    font-size: 16px; /* å°†å­—ä½“å¤§å°ä»24pxç¼©å°,ä¸å³ä¾§çš„â€œå®Œæˆâ€æŒ‰é’®å¯¹é½ */
    font-weight: 600; /* å¯ä»¥é€‚å½“åŠ ç²—,è®©å®ƒæ›´æ¸…æ™° */
    width: auto;     /* ã€æ ¸å¿ƒã€‘ç§»é™¤å›ºå®šçš„30pxå®½åº¦,è®©å®½åº¦ç”±æ–‡å­—å†…å®¹å†³å®š */
    padding: 0 5px;  /* å·¦å³ç»™ä¸€ç‚¹ç•™ç™½,é¿å…è´´è¾¹ */
    white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* === å­—ä½“é¢„è§ˆæ¡†æ ·å¼ (ä¿®æ­£å) === */

/* é»˜è®¤(æ—¥é—´æ¨¡å¼)çš„æ ·å¼ */
#font-preview {
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #f9f9f9; /* æ—¥é—´æ¨¡å¼çš„æµ…ç°è‰²èƒŒæ™¯ */
    transition: background-color 0.3s, border-color 0.3s;
}

/* é¢„è§ˆæ¡†é‡Œçš„æ–‡å­—é¢œè‰²,é»˜è®¤æ˜¯é»‘è‰² */
#font-preview p {
    color: var(--text-primary);
}

/* å¤œé—´æ¨¡å¼ä¸‹çš„ä¿®æ­£æ ·å¼ */
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e; /* æ·±ç°è‰²èƒŒæ™¯ */
    border-color: #38383a;     /* æš—è‰²è¾¹æ¡† */
}

/* å¤œé—´æ¨¡å¼ä¸‹,é¢„è§ˆæ¡†é‡Œçš„æ–‡å­—å˜ä¸ºç™½è‰² */
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª—æ ·å¼ â–¼â–¼â–¼ */
.transfer-actions-content {
    background-color: #fff0f5; /* ç²‰å«©çš„èƒŒæ™¯è‰² */
    border-radius: 20px;
    width: 290px;
    padding: 20px;
    box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /* ç²‰è‰²é˜´å½± */
    text-align: center;
    position: relative;
    border: 1px solid #ffcce0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.transfer-actions-header {
    font-size: 20px;
    font-weight: bold;
    color: #a35c7b; /* æ·±ç²‰è‰²æ ‡é¢˜ */
    margin-bottom: 15px;
}

.transfer-actions-body p {
    font-size: 15px;
    color: #555;
    margin: 0 0 25px 0;
    line-height: 1.5;
}

.transfer-actions-footer {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.transfer-actions-footer .action-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    color: white;
}

.transfer-actions-footer .action-btn:active {
    transform: scale(0.95);
}

.transfer-actions-footer .action-btn.accept {
    background: linear-gradient(135deg, #ff85b3, #ff69b4);
    box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
}

.transfer-actions-footer .action-btn.decline {
    background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.transfer-actions-content .cancel-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0, 0, 0, 0.1);
    color: #a35c7b;
    font-size: 20px;
    line-height: 28px;
    cursor: pointer;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°æ ·å¼ç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* === æœªè¯»æ¶ˆæ¯çº¢ç‚¹æ ·å¼ === */
.unread-count-wrapper {
    flex-shrink: 0;
    width: 40px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 20px; /* è®©çº¢ç‚¹å’Œåå­—å·®ä¸å¤šé«˜ */
}

.unread-count {
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background-color: #ff3b30; /* iOS é£æ ¼çš„çº¢è‰² */
    color: white;
    font-size: 13px;
    font-weight: 500;
    line-height: 20px;
    text-align: center;
    border-radius: 10px; /* åœ†è§’çŸ©å½¢ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ä¸å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */

/* ç¡®ä¿é¡µé¢èƒŒæ™¯è‰²ç»Ÿä¸€ */
#call-history-screen {
    background-color: #f0f2f5;
}

/* é€šè¯è®°å½•å¡ç‰‡æ ·å¼ */
.call-record-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 5px solid var(--accent-color);
}
.call-record-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

/* å¡ç‰‡å¤´éƒ¨:åŒ…å«æ—¥æœŸå’Œæ—¶é•¿ */
.call-record-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.call-record-card .card-header .duration {
    font-weight: 500;
    color: var(--text-primary);
}

/* å¡ç‰‡ä¸»ä½“:å‚ä¸è€…å¤´åƒ */
.call-record-card .card-body {
    display: flex;
    align-items: center;
}
.call-record-card .participants-avatars {
    display: flex;
    align-items: center;
}
.call-record-card .participant-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* è®©å¤´åƒæœ‰ä¸€ä¸ªæ¼‚äº®çš„å †å æ•ˆæœ */
.call-record-card .participant-avatar:not(:first-child) {
    margin-left: -12px;
}
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 15px;
}

/* --- é€šè¯è¯¦æƒ…å¼¹çª—æ ·å¼ --- */
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
}
.transcript-entry {
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 85%;
    line-height: 1.5;
    word-break: break-word;
}
.transcript-entry.user {
    background-color: #dcf8c6; /* ç±»ä¼¼å¾®ä¿¡çš„ç»¿è‰² */
    align-self: flex-end;
}
.transcript-entry.assistant {
    background-color: #ffffff;
    align-self: flex-start;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

#chat-list-title {
    cursor: pointer;
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•å¡ç‰‡ç¾åŒ–æ ·å¼ â–¼â–¼â–¼ */

.call-record-card .card-body {
    /* å°† body æ”¹ä¸º flex å¸ƒå±€,è®©æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯å‚ç›´æ’åˆ— */
    display: flex;
    flex-direction: column;
    gap: 8px; /* æ ‡é¢˜å’Œå‚ä¸è€…ä¿¡æ¯ä¹‹é—´çš„é—´è· */
}

.call-record-card .custom-title {
    font-size: 16px;
    font-weight: 600; /* åŠ ç²—,è®©å®ƒåƒä¸ªæ ‡é¢˜ */
    color: var(--text-primary);
    padding-bottom: 8px; /* æ ‡é¢˜ä¸‹çš„ç•™ç™½ */
    border-bottom: 1px solid var(--border-color); /* åœ¨æ ‡é¢˜ä¸‹åŠ ä¸€æ¡åˆ†å‰²çº¿ */
    margin-bottom: 4px; /* å’Œä¸‹é¢çš„å‚ä¸è€…ä¿¡æ¯æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
}

.call-record-card .participants-info {
    /* è¿™ä¸ªæ–°å®¹å™¨è®©å¤´åƒå’Œâ€œä¸xxâ€èƒ½æ°´å¹³å¯¹é½ */
    display: flex;
    align-items: center;
}

/* å‚ä¸è€…åå­—çš„æ ·å¼å¾®è°ƒ,è®©å®ƒä¸é‚£ä¹ˆçªå‡º */
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 500; /* ä¸å†åŠ ç²— */
    font-size: 14px; /* ç¨å¾®å°ä¸€ç‚¹ */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰² */
}

/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¿ä¸‹æ¨¡å¼ç•Œé¢æ ·å¼ â–¼â–¼â–¼ */
#offline-mode-screen {
    background-color: #f5f3ef; /* ä¸€ä¸ªæ¸©æš–ã€æœ‰è´¨æ„Ÿçš„ç±³ç™½è‰²èƒŒæ™¯ */
    color: #333;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#offline-mode-main {
    /* ä¿ç•™éƒ¨åˆ†åŸæœ‰æ ·å¼ */
    background-color: rgba(255, 255, 255, 0.4);
    margin: 80px 15px 120px 15px;
    
    /* ã€æ ¸å¿ƒä¿®å¤ã€‘ */
    flex-grow: 1;           /* 1. è®©å®ƒåœ¨flexå¸ƒå±€ä¸­è‡ªåŠ¨å¡«å……å¯ç”¨ç©ºé—´ */
    overflow-y: auto;       /* 2. å…è®¸å†…å®¹è¶…å‡ºæ—¶å‚ç›´æ»šåŠ¨ */
    min-height: 0;          /* 3. (å…³é”®) è§£å†³flexå¸ƒå±€ä¸‹çš„æ»šåŠ¨å†²çª */
    
    /* ä» .video-call-main ç»§æ‰¿ä¸€äº›æœ‰ç”¨çš„æ ·å¼ï¼Œå¹¶ç§»é™¤å›ºå®šçš„ç™¾åˆ†æ¯”é«˜åº¦ */
    padding: 15px;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-sizing: border-box;
}
/* â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² */

/* çº¿ä¸‹æ¨¡å¼ä¸­çš„å™äº‹æ–‡æœ¬æ ·å¼ */
.offline-narrative-bubble {
    padding: 12px 16px;
    border-radius: 8px;
    max-width: 95%;
    line-height: 1.7;
    word-break: break-word;
    white-space: pre-wrap;
    font-size: 15px; /* å­—ä½“å¯ä»¥ç¨å¤§ä¸€ç‚¹,æ–¹ä¾¿é˜…è¯» */
    margin-bottom: 12px;
}

.offline-narrative-bubble.ai-narrative {
    background-color: #ffffff; /* AIçš„æ—ç™½ç”¨çº¯ç™½ */
    align-self: flex-start;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.offline-narrative-bubble.user-narrative {
    background-color: #e1f5fe; /* ç”¨æˆ·çš„è¡ŒåŠ¨ç”¨æ·¡æ·¡çš„å¤©è“è‰² */
    align-self: flex-end;
    text-align: left;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½æ ·å¼ â–¼â–¼â–¼ */

/* 1. è¯­éŸ³æ–‡å­—å†…å®¹çš„æ ·å¼ */
.voice-transcript {
    font-size: 14px;         /* æ–‡å­—å¤§å° */
    line-height: 1.6;        /* è¡Œé«˜,è®©å¤šè¡Œæ–‡æœ¬æ›´æ˜“è¯» */
    color: var(--text-secondary); /* ä½¿ç”¨æ¬¡è¦æ–‡å­—é¢œè‰²,ä¸è¯­éŸ³æ¡åŒºåˆ† */
    padding: 8px 12px;       /* å†…è¾¹è· */
    margin-top: 6px;         /* å’Œä¸Šæ–¹çš„è¯­éŸ³æ¡æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
    background-color: rgba(0, 0, 0, 0.04); /* ç»™ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯,æ›´æœ‰å±‚æ¬¡æ„Ÿ */
    border-radius: 6px;      /* åœ†è§’ */
    word-break: break-word;  /* ç¡®ä¿é•¿æ–‡æœ¬èƒ½æ­£å¸¸æ¢è¡Œ */
    display: none;           /* é»˜è®¤éšè— */
}

#phone-screen.dark-mode .voice-transcript {
    background-color: rgba(255, 255, 255, 0.1); /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}

/* 2. æ—‹è½¬åŠ è½½åŠ¨ç”»çš„æ ·å¼ */
.loading-spinner {
    display: none; /* é»˜è®¤éšè— */
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--accent-color); /* æ—‹è½¬éƒ¨åˆ†çš„é¢œè‰² */
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 8px; /* å’Œæ³¢å½¢å›¾ã€æ—¶é•¿ä¿æŒä¸€ç‚¹é—´è· */
}

/* 3. å®šä¹‰æ—‹è½¬åŠ¨ç”» */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
/* â–²â–²â–² æ–°æ ·å¼ç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */
#shared-history-viewer-content {
    display: flex;
    flex-direction: column; /* è®©æ°”æ³¡å‚ç›´æ’åˆ— */
    gap: 20px; /* åœ¨æ¯ä¸ªæ°”æ³¡ä¹‹é—´å¢åŠ 20åƒç´ çš„é—´è· */
    padding: 15px; /* åœ¨å®¹å™¨å››å‘¨ä¹Ÿå¢åŠ ä¸€äº›å†…è¾¹è·,é¿å…æ°”æ³¡è´´è¾¹ */
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’­æ”¾å™¨å’Œæ­Œè¯æ ·å¼ â–¼â–¼â–¼ */
#music-player-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 50;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 60px;
    background-color: rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-50px);
    transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#music-player-overlay.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.music-player-window { 
    width: 70%; 
    min-height: 420px;
    background-color: rgba(255, 255, 255, 0.6); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-radius: 25px; 
    box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
    border: 1px solid rgba(255, 255, 255, 0.18); 
    padding: 25px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    color: #1f1f1f; 
    position: relative;
    justify-content: space-between;
    padding-bottom: 15px;
}

.music-player-top-actions {
    position: absolute;
    top: 15px;
    left: 15px;
    right: 15px;
    width: calc(100% - 30px);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.top-left-cluster {
    display: flex;
    align-items: center;
    gap: 15px;
}
#music-return-btn, #music-exit-btn {
    background: none;
    border: none;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    color: #555;
    padding: 5px;
    line-height: 1;
}
#music-exit-btn {
    font-size: 24px;
    font-weight: 400;
}

.music-progress-bar-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 25px;
    margin-bottom: 10px;
}
.time-display {
    font-size: 11px;
    color: #888;
    width: 35px;
    text-align: center;
    flex-shrink: 0;
    font-family: 'SF Mono', 'Menlo', monospace;
}
.progress-bar {
    flex-grow: 1;
    height: 5px;
    background-color: #e5e5e5;
    border-radius: 2.5px;
    cursor: pointer;
}
.progress-bar-fill {
    width: 0%;
    height: 100%;
    background-color: #333;
    border-radius: 2.5px;
}

#music-lyrics-container {
    width: 100%;
    height: 192px;
    overflow: hidden;
    position: relative;
    -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
    mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
}

#music-lyrics-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.lyric-line {
    padding: 4px 0;
    font-size: 14px;
    color: #666;
    text-align: center;
    line-height: 1.5;
    transition: all 0.5s ease;
    opacity: 0.7;
    transform: scale(0.95);
}

.lyric-line.active {
    font-size: 16px;
    color: #000;
    opacity: 1;
    transform: scale(1);
}

.music-player-controls-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.music-controls {
    margin-top: 0;
}

#music-return-btn, #music-exit-btn, #music-playlist-btn {
    position: relative;
}

#music-return-btn { top: -2px; }
#music-playlist-btn { top: -3px; }

.playlist-item-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
.playlist-action-btn {
    font-size: 18px;
    color: #888;
    cursor: pointer;
    transition: color 0.2s;
}
.playlist-action-btn:hover { color: #000; }
.delete-track-btn { font-size: 24px; color: #ff3b30; }
.delete-track-btn:hover { color: #c00; }
.lyrics-btn { font-weight: 500; }

/* --- ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¡®ä¿å¤´åƒå°ºå¯¸ --- */
.message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 20%;
    object-fit: cover;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
}

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ â–¼â–¼â–¼ */

/* 1. æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦æ ·å¼ */
.recalled-message-placeholder {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
    cursor: pointer; /* è®©å®ƒçœ‹èµ·æ¥å¯ä»¥ç‚¹å‡» */
}

/* 2. å¤œé—´æ¨¡å¼ä¸‹çš„é€‚é… */
#phone-screen.dark-mode .recalled-message-placeholder {
    background-color: rgba(255, 255, 255, 0.15);
}

/* 3. AIæ’¤å›æ¶ˆæ¯æ—¶çš„åŠ¨ç”»æ•ˆæœ */
@keyframes recall-animation {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}

.message-wrapper.recalled-animation {
  animation: recall-animation 0.3s ease-out forwards;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’¤å›æ¶ˆæ¯æ ·å¼ä¿®æ­£ â–¼â–¼â–¼ */

/* å¼ºåˆ¶æ’¤å›æ¶ˆæ¯çš„å ä½ç¬¦ä¸æ¢è¡Œ,å¹¶ä¿æŒå†…å®¹å±…ä¸­ */
.recalled-message-placeholder {
    white-space: nowrap; /* æ ¸å¿ƒ:ç¦æ­¢æ–‡æœ¬æ¢è¡Œ */
    display: inline-block; /* è®©èƒŒæ™¯æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
    padding: 4px 12px;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
.world-book-group-container {
    border-bottom: 1px solid var(--border-color);
}
.world-book-group-container:first-child {
    border-top: 1px solid var(--border-color);
}
.world-book-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}
.world-book-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}
.world-book-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}
.world-book-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}
.world-book-group-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.world-book-group-content.collapsed {
    max-height: 0;
}
#phone-screen.dark-mode .world-book-group-header {
    background-color: #1c1c1e;
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…/è½¬è´¦æ¨¡æ€æ¡†é¡µç­¾æ ·å¼ â–¼â–¼â–¼ */
.frame-tabs {
    display: flex;
    background-color: #f0f0f0;
    padding: 4px;
    margin: 15px;
    border-radius: 8px;
}
.frame-tab {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #555;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}
.frame-tab.active {
    background-color: #ffffff;
    color: #000000;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ è¯·å°†è¿™æ®µå…¨æ–°çš„CSSç²˜è´´åˆ° <style> çš„æœ«å°¾ â–¼â–¼â–¼ */

/* 1. åˆ†ç±»æ–‡ä»¶å¤¹çš„æ ·å¼ */
.wb-category-header {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5; /* ç»™æ–‡ä»¶å¤¹ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰²ä»¥åŒºåˆ† */
    font-weight: 600; /* åŠ ç²—å­—ä½“ */
}
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e; /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
}


/* 2. å±•å¼€/æ”¶èµ·çš„å°ç®­å¤´ */
.wb-category-header .arrow {
    font-size: 12px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

/* 3. å½“æ–‡ä»¶å¤¹æ”¶èµ·æ—¶,ç®­å¤´æ—‹è½¬ */
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 4. å­˜æ”¾ä¹¦ç±æ¡ç›®çš„å®¹å™¨ */
.wb-book-container {
    padding-left: 20px; /* æ ¸å¿ƒ:è®©ä¹¦ç±æ¡ç›®å‘å†…ç¼©è¿›,çœ‹èµ·æ¥åƒåœ¨æ–‡ä»¶å¤¹é‡Œ */
    max-height: 1000px; /* ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å€¼,ç”¨äºåŠ¨ç”» */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

/* 5. å½“æ–‡ä»¶å¤¹æ”¶èµ·æ—¶,ä¹¦ç±å®¹å™¨çš„é«˜åº¦å˜ä¸º0,å®ç°åŠ¨ç”»æ•ˆæœ */
.wb-book-container.collapsed {
    max-height: 0;
}

/* 6. å•ä¸ªä¹¦ç±æ¡ç›®(è¦†ç›–é»˜è®¤çš„labelæ ·å¼,å¾®è°ƒé—´è·) */
.wb-book-container label {
    padding: 8px 12px;
}

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

/* â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦å…³è”é€‰æ‹©å™¨ - è§†è§‰ä¼˜åŒ– â–¼â–¼â–¼ */

/* 1. è®©åˆ†ç±»æ ‡é¢˜æ›´çªå‡º */
.wb-category-header > span:last-of-type {
    font-size: 14px;
    font-weight: 700; /* åŠ ç²— */
    color: var(--text-primary);
}

/* 2. ä¸ºç®­å¤´è®¾ç½®ä¸€ä¸ªæ¼‚äº®çš„é¢œè‰²å¾ªç¯ */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+1) .arrow { color: #007bff; } /* è“è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+2) .arrow { color: #28a745; } /* ç»¿è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+3) .arrow { color: #fd7e14; } /* æ©™è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+4) .arrow { color: #6f42c1; } /* ç´«è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+5) .arrow { color: #dc3545; } /* çº¢è‰² */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+6) .arrow { color: #ffc107; } /* é»„è‰² */

/* â–²â–²â–² æ–°CSSç²˜è´´ç»“æŸ â–²â–²â–² */

    </style>
</head>
<body>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">æ˜ŸæœŸä¸€, 1æœˆ1æ—¥</div></div>
<!-- â–¼â–¼â–¼ 1. ä¿®æ”¹ä¸»é¡µå¸ƒå±€:è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ,æ›¿æ¢æ‰ä½ åŸæ¥çš„ id="app-grid" â–¼â–¼â–¼ -->
<div id="app-grid">
<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç ,æ›¿æ¢æ‰æ—§çš„ id="vinyl-player-container" é‡Œçš„æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->

<div id="vinyl-player-container">
    <!-- é™æ€çš„é»‘èƒ¶åœˆ,å®ƒç°åœ¨æ˜¯ç‹¬ç«‹çš„å›¾ç‰‡ -->
    <img id="vinyl-record-overlay" src="https://i.postimg.cc/fb1JZLZV/13.png" alt="é»‘èƒ¶å”±ç‰‡">
    
    <!-- å”¯ä¸€éœ€è¦æ—‹è½¬çš„ä¸“è¾‘å›¾ -->
    <img id="vinyl-album-art" src="https://i.postimg.cc/CMZqNMRh/IMG-6497.jpg" alt="ä¸“è¾‘å°é¢">

    <!-- æ–‡ä»¶ä¸Šä¼  input ä¿æŒä¸å˜ -->
    <input type="file" id="vinyl-cover-upload" accept="image/*" style="display: none;">
</div>

<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <!-- å³ä¾§:2x2 åº”ç”¨å›¾æ ‡ç½‘æ ¼ -->
    <div class="right-app-grid">
        <div class="app-icon" onclick="showScreen('world-book-screen')">
            <div class="icon-bg"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="ä¸–ç•Œä¹¦"></div>
            <span class="label">ä¸–ç•Œä¹¦</span>
        </div>
        <div class="app-icon" onclick="showScreen('chat-list-screen')">
            <div class="icon-bg"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div>
            <span class="label">QQ</span>
        </div>
        <div class="app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIè®¾ç½®"></div>
            <span class="label">APIè®¾ç½®</span>
        </div>
        <div class="app-icon" onclick="showScreen('wallpaper-screen')">
            <div class="icon-bg"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="å¤–è§‚è®¾ç½®"></div>
            <span class="label">å¤–è§‚è®¾ç½®</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¸ƒå±€æ›¿æ¢ç»“æŸ â–²â–²â–² -->
 </div>
          
<div id="world-book-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>ä¸–ç•Œä¹¦</span>
        <div class="header-actions"> <!-- ã€æ¨èã€‘ç”¨ä¸€ä¸ªå®¹å™¨æŠŠæŒ‰é’®åŒ…èµ·æ¥ -->
            <span class="action-btn" id="manage-world-book-categories-btn">ç®¡ç†åˆ†ç±»</span>
            <span class="action-btn" id="add-world-book-btn">+</span>
        </div>
    </div>
    <div id="world-book-list"></div>
</div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                    <span id="world-book-editor-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
                    <span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">ä¹¦å</label>
                        <input type="text" id="world-book-name-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...">
                    </div>

        <!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨è¿™é‡Œæ·»åŠ åˆ†ç±»é€‰æ‹© â–¼â–¼â–¼ -->
        <div class="form-group">
            <label for="world-book-category-select">åˆ†ç±»</label>
            <select id="world-book-category-select">
                <!-- é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </select>
        </div>
        <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">å†…å®¹</label>
                        <textarea id="world-book-content-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯¦ç»†çš„ä¸–ç•Œè§‚è®¾å®š..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>API è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">æç¤º: è‹¥è¦ä½¿ç”¨â€œå‘é€å›¾ç‰‡â€åŠŸèƒ½, è¯·åŠ¡å¿…é€‰æ‹©æ”¯æŒVision(è§†è§‰)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚</p><div class="form-group"><label for="proxy-url">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label><input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com"></div><div class="form-group"><label for="api-key">å¯†é’¥ (ç›´è¿è½®è¯¢ç”¨è‹±æ–‡é€—å·éš”å¼€)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">æ¨¡å‹</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">æ‹‰å–æ¨¡å‹</button>
<button class="form-button form-button-secondary" id="gemini-studio-setup-btn" style="margin-top: 10px;">å¿«é€Ÿè®¾ç½®: Gemini (AIza... Key)</button>

<!-- â–¼â–¼â–¼ å°†è¿™æ®µä»£ç ç²˜è´´åˆ° API è®¾ç½®é¡µé¢çš„â€œä¿å­˜è®¾ç½®â€æŒ‰é’®ä¸Šæ–¹ â–¼â–¼â–¼ -->
<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        å¯ç”¨åå°è§’è‰²æ´»åŠ¨
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            è­¦å‘Š:æ­¤åŠŸèƒ½ä¼šæ˜¾è‘—å¢åŠ APIè°ƒç”¨å’Œè´¹ç”¨!
        </p>
    </label>
    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ å°†è¿™æ®µä»£ç ç²˜è´´åˆ°â€œå¯ç”¨åå°è§’è‰²æ´»åŠ¨â€å¼€å…³çš„ä¸‹æ–¹ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="background-interval-input" style="margin-bottom: 0;">
        åå°æ´»åŠ¨æ£€æµ‹é—´éš” (ç§’)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            å»ºè®®å€¼ 60-300ã€‚å€¼è¶Šå¤§,è´¹ç”¨è¶Šä½,ä½†è§’è‰²ååº”è¶Šæ…¢ã€‚
        </p>
    </label>
    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ â–¼â–¼â–¼ -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AIè¢«æ‹‰é»‘åå†·é™æœŸ (å°æ—¶)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            è¢«æ‹‰é»‘è¶…è¿‡è¿™ä¸ªæ—¶é—´å,AIæ‰æœ‰å‡ ç‡é‡æ–°ç”³è¯·å¥½å‹ã€‚
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

<button class="form-button" id="save-api-settings-btn">ä¿å­˜è®¾ç½®</button>
			<hr style="margin:20px 0; opacity:.3">

			<button class="form-button" id="export-data-btn">å¯¼å‡ºæ•°æ®</button>

<!-- â‘  æ™®é€šæŒ‰é’®,å’Œâ€œå¯¼å‡ºâ€ä¸€ä¸ª class -->
<button class="form-button" id="import-btn">å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>

<!-- â‘¡ çœŸæ­£çš„æ–‡ä»¶é€‰æ‹©å™¨,å®Œå…¨éšè— -->
<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>
<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µä»£ç ,å®Œæ•´æ›¿æ¢æ‰ä½ åŸæ¥çš„ chat-list-screen â–¼â–¼â–¼ -->
<div id="chat-list-screen" class="screen">
    
<!-- â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç ,æ›¿æ¢æ—§çš„ id="main-chat-list-header" â–¼â–¼â–¼ -->
<div class="header" id="main-chat-list-header">
    <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
    <span id="chat-list-title">æ¶ˆæ¯</span>
    <div class="header-actions">
        <!-- æ ¸å¿ƒä¿®æ”¹:ç°åœ¨è¿™ä¸ªâ€œ+â€æŒ‰é’®åªè´Ÿè´£æ‰“å¼€èœå• -->
        <span class="action-btn" id="add-chat-btn">+</span>
        
        <!-- ã€å…¨æ–°ã€‘è¿™æ˜¯æˆ‘ä»¬æ–°å¢çš„ä¸‹æ‹‰èœå•HTMLç»“æ„ -->
        <div id="add-chat-menu">
            <div class="menu-item" id="menu-create-group">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23444444' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'></path><circle cx='8.5' cy='7' r='4'></circle><line x1='20' y1='8' x2='20' y2='14'></line><line x1='17' y1='11' x2='23' y2='11'></line></svg>" class="menu-icon">
                <span>åˆ›å»ºç¾¤èŠ</span>
            </div>
            <div class="menu-item" id="menu-add-friend">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23444444' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'></path><circle cx='8.5' cy='7' r='4'></circle><line x1='20' y1='8' x2='20' y2='14'></line><line x1='17' y1='11' x2='23' y2='11'></line></svg>" class="menu-icon">
                <span>åŠ å¥½å‹</span>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <!-- æ¶ˆæ¯åˆ—è¡¨è§†å›¾ -->
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            <!-- JSä¼šåœ¨è¿™é‡Œç”ŸæˆèŠå¤©åˆ—è¡¨ -->
        </div>
    </div>

<!-- â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ id="qzone-screen" åŠå…¶æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->
<div id="qzone-screen" class="chat-list-view">
<!-- â–¼â–¼â–¼ ã€æœ€ç»ˆHTMLä¿®å¤ç‰ˆ V2ã€‘ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ qzone-floating-header â–¼â–¼â–¼ -->
<div class="qzone-floating-header">
    <span class="back-btn" id="qzone-back-btn">â€¹</span>
    
    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åˆ›å»ºä¸€ä¸ªæ–°çš„é›†ç¾¤å®¹å™¨ -->
    <div class="top-right-cluster">
        <!-- 1. æŒ‰é’®çš„å®¹å™¨ -->
        <div class="header-actions">
            <!-- æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œåªæ˜¾ç¤ºâ€œç¼–è¾‘â€æŒ‰é’® -->
            <div id="qzone-normal-actions">
                <span class="action-btn" id="qzone-edit-btn">...</span>
            </div>
            <!-- ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œæ˜¾ç¤ºâ€œå…¨é€‰â€ã€â€œåˆ é™¤â€ã€â€œå®Œæˆâ€ -->
            <div id="qzone-edit-actions" style="display: none;">
                <span class="action-btn" id="qzone-select-all-btn">å…¨é€‰</span>
                <span class="action-btn" id="qzone-delete-selected-btn" style="color: #ff3b30;">åˆ é™¤</span>
                <span class="action-btn" id="qzone-done-btn">å®Œæˆ</span>
            </div>
        </div>
        <!-- 2. è®¿å®¢é‡ä¿¡æ¯ (ç°åœ¨æ˜¯æŒ‰é’®çš„å…„å¼Ÿå…ƒç´ ) -->
        <div id="qzone-visitor-info">
            <span>è®¿å®¢æ€»é‡</span>
            <span id="qzone-visitor-count-number">0</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <!-- åŠ¨æ€ä¸»å†…å®¹åŒº -->
    <div class="qzone-content">
        <div class="qzone-profile-header">
            <!-- 1. èƒŒæ™¯æ¿ -->
            <div id="qzone-banner-container" class="qzone-banner-container">
                <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="èƒŒæ™¯">
                <input type="file" id="qzone-banner-input" accept="image/*" hidden>
            </div>
<!-- â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆ - å¤´åƒä¸Šç½®ã€‘ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ id="qzone-user-info" â–¼â–¼â–¼ -->
<div class="qzone-user-info">
    <!-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘å¤´åƒç°åœ¨ä½äºæœ€é¡¶éƒ¨ -->
    <div id="qzone-avatar-container" class="qzone-avatar-container">
        <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="å¤´åƒ">
        <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
    </div>
    
    <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ˜µç§°å’Œç­¾åç°åœ¨ä½äºå¤´åƒä¸‹æ–¹ -->
    <div class="qzone-user-details">
        <h2 id="qzone-nickname">{{user}}</h2>
        <p id="qzone-signature">ç¼–è¾‘ä¸ªç­¾ï¼Œå±•ç¤ºæˆ‘çš„ä¸ä¼—ä¸åŒã€‚</p>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
</div>
        <!-- 3. åŠŸèƒ½æ  (ä¿æŒä¸å˜) -->
        <div class="qzone-actions-bar">
            <div class="action-item" id="create-shuoshuo-btn"><span>è¯´è¯´</span></div>
            <div class="action-item" id="create-post-btn"><span>åŠ¨æ€</span></div>
            <div class="action-item" id="open-album-btn"><span>ç›¸å†Œ</span></div>
        </div>
        <!-- 4. å¸–å­åˆ—è¡¨ (ä¿æŒä¸å˜) -->
        <div id="qzone-posts-list"></div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <!-- æ”¶è—ç•Œé¢è§†å›¾ -->
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn">â€¹</span>
        <span>æˆ‘çš„æ”¶è—</span>
        <!-- æ–°å¢çš„ç¼–è¾‘æŒ‰é’® -->
        <span class="action-btn" id="favorites-edit-btn">ç¼–è¾‘</span>
    </div>

        <!-- ã€æ–°å¢ã€‘æœç´¢æ å®¹å™¨ -->
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="æœç´¢æ”¶è—çš„æ ‡é¢˜ã€å†…å®¹æˆ–ä½œè€…...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">Ã—</button>
        </div>

        <div id="favorites-list" class="list-container">
            <!-- æ”¶è—å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- æ–°å¢:æ”¶è—é¡µåº•éƒ¨æ“ä½œæ  -->
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn">åˆ é™¤ (0)</button>
    </div>

    </div>

<div id="memories-view" class="chat-list-view">
    <!-- ä½¿ç”¨æ‚¨æä¾›çš„ç¬¬äºŒæ®µheaderä»£ç (å·²ç§»é™¤é½¿è½®æŒ‰é’®)-->
 <div class="header"> 
    <span class="back-btn" id="memories-back-btn">â€¹</span>
    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†é™æ€æ ‡é¢˜æ›¿æ¢ä¸ºä¸‹æ‹‰é€‰æ‹©å™¨ -->
    <select id="memories-ai-switcher"></select>
    <span class="action-btn" style="width: 24px;"></span>
    </div>
    
    <!-- ä¿ç•™åŸå†…å®¹å®¹å™¨ -->
    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 20px;">
        
        <!-- çºªå¿µæ—¥è®¡æ•°å™¨ -->
        <div class="anniversary-counter-card">
            <div class="counter-avatars">
                <img id="anniversary-my-avatar" src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg" class="counter-avatar">
                <img id="anniversary-ai-avatar" src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg" class="counter-avatar">
            </div>
            <div class="counter-days">
                <span id="anniversary-days">0</span> å¤©
            </div>
            <div class="counter-date" id="anniversary-start-date">ç‚¹å‡»å³ä¸Šè§’è®¾ç½®èµ·å§‹æ—¥</div>
        </div>

        <!-- æ—¥å† -->
        <div class="calendar-card">
            <div class="calendar-header">
                <button id="calendar-prev-month">â€¹</button>
                <h2 id="calendar-month-year">2025 å¹´ 9 æœˆ</h2>
                <button id="calendar-next-month">â€º</button>
            </div>
            <div class="calendar-weekdays">
                <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- æ—¥æœŸæ ¼å­å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ—§çš„å›å¿†å½•å®¹å™¨ -->
        <div id="old-memories-container" style="display: none; flex-direction: column; gap: 15px;">
            <h3 style="text-align: center; color: var(--text-secondary); font-weight: 500;">å¾€æ—¥éšç¬”</h3>
            <!-- æ—§çš„å›å¿†å¡ç‰‡ä¼šåŠ è½½åˆ°è¿™é‡Œ -->
        </div>

    </div>
</div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
<div id="chat-list-bottom-nav">
    <div class="nav-item active" data-view="messages-view">
        <span>æ¶ˆæ¯</span>
    </div>
    <div class="nav-item" data-view="qzone-screen">
        <span>åŠ¨æ€</span>
    </div>
<!-- â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç›´æ’­é—´é¡µç­¾ â–¼â–¼â–¼ -->
<div class="nav-item" data-view="live-stream-screen">
    <span>ç›´æ’­</span>
</div>
<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
    <!-- â–¼â–¼â–¼ åœ¨â€œåŠ¨æ€â€å’Œâ€œæ”¶è—â€ä¹‹é—´,åŠ å…¥è¿™ä¸ªæ–°é¡µç­¾ â–¼â–¼â–¼ -->
    <div class="nav-item" data-view="memories-view">
        <span>çºªå¿µ</span>
    </div>
    <!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->
    <div class="nav-item" data-view="favorites-view">
        <span>æ”¶è—</span>
    </div>
</div>
</div>
<!-- â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å£çº¸åº“å±å¹• â–¼â–¼â–¼ -->
<div id="wallpaper-library-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="wallpaper-library-back-btn">â€¹</span>
        <span>å£çº¸åº“</span>
                <span class="action-btn" id="add-wallpapers-btn">
            <img src="https://sharkpan.xyz/f/knAwH6/MaterialSymbolsLightImageArrowUpRounded.png" alt="æ·»åŠ å£çº¸" style="height: 28px;">
        </span>
    </div>
    <div class="list-container" style="padding: 0;">
        <div id="wallpaper-grid">
            <!-- å£çº¸ç¼©ç•¥å›¾å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
    <input type="file" id="wallpaper-upload-input-library" accept="image/*" multiple hidden>
</div>
<!-- â–²â–²â–² å£çº¸åº“å±å¹•ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å£çº¸åº”ç”¨ç›®æ ‡é€‰æ‹©æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="wallpaper-apply-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto;">
        <div class="modal-header">
            <span>è¦å°†å£çº¸åº”ç”¨åˆ°å“ªé‡Œï¼Ÿ</span>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px; padding: 20px;">
            <button id="apply-to-home-btn" class="form-button">ä¸»å±å¹•å£çº¸</button>
            <button id="apply-to-chat-btn" class="form-button">å½“å‰èŠå¤©èƒŒæ™¯</button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="apply-wallpaper-cancel-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ¨¡æ€æ¡†ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸¸æˆé€‰æ‹©é¢æ¿ (ç²˜è´´åˆ° <body> æœ«å°¾) â–¼â–¼â–¼ -->
<div id="game-panel">
    <div class="game-panel-header">
        <span class="close-btn" id="close-game-panel-btn">å–æ¶ˆ</span>
        <span>å¼€å§‹ä¸€ä¸ªæ¸¸æˆ</span>
    </div>
    <div class="game-options-grid">
        <div class="game-option-item" id="start-truth-dare-btn">
            <div class="icon-bg"><img src="https://i.postimg.cc/Y9c1wx32/Fluent-Emoji-High-Contrast-Love-Letter.png" alt="çœŸå¿ƒè¯å¤§å†’é™©"></div>
            <span class="label">çœŸå¿ƒè¯å¤§å†’é™©</span>
        </div>
        <div class="game-option-item" id="start-erotic-cards-btn">
            <div class="icon-bg"><img src="https://i.postimg.cc/kMLdPRr1/Solar-Hearts-Bold-Duotone.png" alt="æƒ…ä¾£ç‰Œ"></div>
            <span class="label">æƒ…ä¾£ç‰Œ</span>
        </div>
        <div class="game-option-item" id="start-standalone-dice-btn">
            <div class="icon-bg"><img src="https://i.postimg.cc/ZqPqCFm5/MdiDice.png" alt="æ‘‡ä¸ªéª°å­"></div>
            <span class="label">æ‘‡ä¸ªéª°å­</span>
        </div>
        <div class="game-option-item" id="start-auto-chess-btn">
            <div class="icon-bg"><img src="https://sharkpan.xyz/f/ad2VIY/icon-kfckfc.png" alt="äº”å­æ£‹"></div>
            <span class="label">äº”å­æ£‹</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ id="auto-chess-screen" â–¼â–¼â–¼ -->

<!-- 1. å…¨æ–°çš„äº”å­æ£‹æ¸¸æˆä¸»å±å¹• -->
<div id="gomoku-screen" class="screen">
    <!-- æ¸¸æˆåŒºåŸŸ (ä¸ŠåŠéƒ¨åˆ†) -->
    <div id="gomoku-board-area">
        <!-- æ¸¸æˆå¤´éƒ¨ -->
        <div class="header">
            <span class="back-btn" id="gomoku-back-btn">â€¹</span>
            <span>äº”å­æ£‹</span>
            <div class="header-actions">
                <!-- å…¨æ–°çš„æ‚”æ£‹æŒ‰é’® -->
                <span class="action-btn" id="gomoku-undo-btn" title="æ‚”æ£‹">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 3v6h6"></path><path d="M3.4 13A9 9 0 1 0 21 12a9.75 9.75 0 0 0-2.3-5.8"></path>
                    </svg>
                </span>
            </div>
        </div>
        <!-- ç©å®¶ä¿¡æ¯æ  -->
        <div class="player-info-bar">
            <!-- ä½ çš„ä¿¡æ¯å¡ç‰‡ -->
            <div class="player-card user current-player">
                <img id="gomoku-user-avatar" src="" class="player-avatar">
                <div class="player-details">
                    <span id="gomoku-user-name" class="player-name">ä½ </span>
                    <span class="player-piece white"></span>
                </div>
            </div>
            <!-- ä¸­é—´çš„å€’è®¡æ—¶å™¨ -->
            <div class="turn-timer">
                <div class="timer-circle">
                    <span id="gomoku-timer-display">30</span>
                </div>
            </div>
            <!-- AIçš„ä¿¡æ¯å¡ç‰‡ -->
            <div class="player-card ai">
                <img id="gomoku-ai-avatar" src="" class="player-avatar">
                <div class="player-details">
                    <span id="gomoku-ai-name" class="player-name">å¯¹æ–¹</span>
                    <span class="player-piece black"></span>
                </div>
            </div>
        </div>
        <!-- æ£‹ç›˜å®¹å™¨ -->
        <div id="gomoku-grid-wrapper">
            <div id="gomoku-grid">
                <!-- æ£‹ç›˜æ ¼å­å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <!-- æ¸¸æˆå¼€å§‹å‰çš„é®ç½©å±‚ -->
            <div id="gomoku-start-overlay" class="visible">
                <button id="gomoku-start-btn">å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>
    </div>
    <!-- èŠå¤©åŒºåŸŸ (ä¸‹åŠéƒ¨åˆ†) - è¿™éƒ¨åˆ†ç»“æ„ä¿æŒä¸å˜ -->
    <div id="auto-chess-chat-area">
        <div id="auto-chess-messages">
            <!-- æ¸¸æˆå†…èŠå¤©æ¶ˆæ¯ -->
        </div>
        <div id="ac-typing-indicator" style="display: none;">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
        <div id="auto-chess-input-area">
            <textarea id="auto-chess-input" rows="1" placeholder="å’ŒTaèŠèŠå§..."></textarea>
            <button id="auto-chess-send-btn" class="action-button">å‘é€</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² HTML æ›¿æ¢ä¸åˆ é™¤æ“ä½œåˆ°æ­¤ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="chat-list-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨,åŒ…å«è¿”å›æŒ‰é’®å’Œæ ‡é¢˜ -->
    <div class="header">
        <span class="back-btn" id="album-back-btn">â€¹</span>
        <span>æˆ‘çš„ç›¸å†Œ</span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="album-grid-page">
            <!-- ç›¸å†Œåˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ° id="album-screen" çš„ div ä¹‹å â–¼â–¼â–¼ -->
<div id="album-photos-screen" class="screen">
    <!-- 1. é¡µé¢å¤´éƒ¨ -->
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn">â€¹</span>
        <span id="album-photos-title">ç›¸å†Œåç§°</span>
        <span class="action-btn" id="album-upload-photo-btn">ä¸Šä¼ </span>
    </div>
    
    <!-- 2. é¡µé¢å†…å®¹å®¹å™¨ -->
    <div class="list-container">
        <div id="photos-grid-page">
            <!-- ç…§ç‰‡åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>

<!-- â–¼â–¼â–¼ ç¬¬2.3æ­¥:åœ¨ <body> æœ«å°¾æ·»åŠ è¿™ä¸¤ä¸ªå…¨æ–°çš„æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<!-- æ—¥å†äº‹ä»¶/å¤‡å¿˜å½•æ¨¡æ€æ¡† -->
<div id="calendar-event-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="event-modal-title">æ·»åŠ å¤‡å¿˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="event-title-input">æ ‡é¢˜</label>
                <input type="text" id="event-title-input" placeholder="ç®€çŸ­åœ°æè¿°ä¸€ä¸‹...">
            </div>
            <div class="form-group">
                <label for="event-memo-textarea">å¤‡å¿˜å½•</label>
                <textarea id="event-memo-textarea" rows="4" placeholder="åœ¨è¿™é‡Œå†™ä¸‹è¯¦ç»†å†…å®¹..."></textarea>
            </div>
            <p id="event-creator-info" style="font-size: 12px; color: #888; text-align: right; display: none;"></p>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="delete-event-btn" style="color: #ff3b30; display: none;">åˆ é™¤</button>
            <button class="cancel" id="cancel-event-btn">å–æ¶ˆ</button>
            <button class="save" id="save-event-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- çºªå¿µæ—¥è®¾ç½®æ¨¡æ€æ¡† -->
<div id="anniversary-settings-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>çºªå¿µæ—¥è®¾ç½®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="anniversary-start-date-input">æˆ‘ä»¬çš„èµ·å§‹æ—¥</label>
                <input type="date" id="anniversary-start-date-input">
            </div>
            <div class="form-group">
                <label>æˆ‘çš„å¤´åƒ</label>
                <div class="avatar-upload">
                    <img id="anniversary-my-avatar-preview" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                    <button onclick="document.getElementById('anniversary-my-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button>
                    <input type="file" id="anniversary-my-avatar-input" accept="image/*" hidden>
                </div>
            </div>
            <div class="form-group">
                <label>å¯¹æ–¹çš„å¤´åƒ</label>
                <div class="avatar-upload">
                    <img id="anniversary-ai-avatar-preview" src="" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                    <button onclick="document.getElementById('anniversary-ai-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button>
                    <input type="file" id="anniversary-ai-avatar-input" accept="image/*" hidden>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-anniversary-settings-btn">å–æ¶ˆ</button>
            <button class="save" id="save-anniversary-settings-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°çš„ HTML ç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="photo-viewer-modal" class="modal">
    <!-- 1. å…³é—­æŒ‰é’® -->
    <button id="photo-viewer-close-btn">Ã—</button>
    
    <!-- 2. ä¸Šä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-prev-btn" class="nav-arrow">â€¹</button>
    
    <!-- 3. å›¾ç‰‡å®¹å™¨ -->
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="" alt="å…¨å±ç…§ç‰‡é¢„è§ˆ">
    </div>
    
    <!-- 4. ä¸‹ä¸€å¼ ç…§ç‰‡æŒ‰é’® -->
    <button id="photo-viewer-next-btn" class="nav-arrow">â€º</button>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

    </div>
</div>
<!-- â–²â–²â–² æ–°çš„ HTML ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ç²˜è´´åˆ° #album-photos-screen çš„ div ä¹‹å â–¼â–¼â–¼ -->
<input type="file" id="album-photo-input" accept="image/png, image/jpeg, image/gif, image/webp" multiple hidden>
            
<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ,å®Œæ•´æ›¿æ¢æ‰æ‚¨æ–‡ä»¶ä¸­æ—§çš„ #chat-interface-screen åŠå…¶æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->
<div id="chat-interface-screen" class="screen">

    <!-- ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘Header,å·²å°†çŠ¶æ€æ å’Œæœç´¢åŠŸèƒ½æ­£ç¡®æ•´åˆ -->
    <div class="header">
        <!-- é»˜è®¤æ§ä»¶:åŒ…å«æ ‡é¢˜ã€çŠ¶æ€æ å’Œå¸¸è§„æŒ‰é’® -->
        <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">â€¹</span>
            
            <!-- â–¼â–¼â–¼ ã€æ ¸å¿ƒæ–°å¢ã€‘æ ‡é¢˜å’ŒçŠ¶æ€çš„å®¹å™¨ â–¼â–¼â–¼ -->
            <div id="chat-header-title-wrapper">
                <span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
                <div id="chat-header-status">
                    <span class="status-dot"></span>
                    <span class="status-text">åœ¨çº¿</span>
                </div>
            </div>
            <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

            <div class="header-actions">
                <span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·å¬"></span>
                <span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="è®¾ç½®"></span>
            </div>
        </div>

        <!-- å¤šé€‰æ¨¡å¼æ§ä»¶ (ä¿æŒä¸å˜) -->
        <div class="selection-controls">
            <span id="selection-cancel-btn">å–æ¶ˆ</span>
            <span id="selection-count"></span>
            <div class="header-actions">
               <span id="selection-favorite-btn" class="action-btn">æ”¶è—</span>
       <span id="selection-share-btn" class="action-btn">åˆ†äº«</span> 
               <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">åˆ é™¤</span>
            </div>
        </div>
    </div>
    
    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ (ä¿æŒä¸å˜) -->
    <div id="chat-messages"><div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div></div>

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ id="chat-input-area" åŠå…¶æ‰€æœ‰å†…å®¹ â–¼â–¼â–¼ -->
<div id="chat-input-area">
    <!-- å›å¤é¢„è§ˆæ  (ä¿æŒä¸å˜) -->
    <div id="reply-preview-bar">
        <div class="reply-preview-content">
            <div class="sender">å›å¤ xxx:</div>
            <div class="text">è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹...</div>
        </div>
        <span id="cancel-reply-btn">Ã—</span>
    </div>

    <!-- ä¸»è¾“å…¥è¡Œ (å…¨æ–°ç»“æ„) -->
    <div id="chat-input-main-row">
        <!-- 1. åŠ å·/å…³é—­æŒ‰é’® -->
<!-- 1. åŠ å·/å…³é—­æŒ‰é’® -->
<button id="open-actions-btn" class="chat-action-icon-btn action-button">
    <img src="https://sharkpan.xyz/f/Qr6Of6/%E5%A2%9E%E5%8A%A0.png" alt="æ‰“å¼€æ“ä½œé¢æ¿">
</button>        
        <!-- 2. è¾“å…¥æ¡†å’Œè¯­éŸ³æŒ‰é’®çš„å®¹å™¨ -->
        <div class="input-wrapper">
            <textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            <!-- è¯­éŸ³æŒ‰é’®ç°åœ¨ä½äºè¾“å…¥æ¡†å†…éƒ¨ -->
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="å‘é€è¯­éŸ³">
                <img src="https://sharkpan.xyz/f/mQGeuW/%E8%AF%AD%E9%9F%B3.png" alt="å‘é€è¯­éŸ³">
            </button>
        </div>
        
        <!-- 3. ç­‰å¾…å›å¤å’Œå‘é€æŒ‰é’® -->
        <div id="input-actions-wrapper">
            <button id="wait-reply-btn" title="ç­‰å¾…å›å¤"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="ç­‰å¾…å›å¤"></button>
<button id="send-btn" class="action-button"><img src="https://sharkpan.xyz/f/ZqlriW/%E5%8F%91%E9%80%81%202.png" alt="å‘é€"></button>        </div>
    </div>

    <!-- 4. ã€æ ¸å¿ƒã€‘å¯å±•å¼€çš„åŠŸèƒ½é¢æ¿ -->
    <div id="chat-actions-panel">
        <!-- JSä¼šè‡ªåŠ¨åœ¨è¿™é‡Œç”Ÿæˆå¯æ»‘åŠ¨çš„åŠŸèƒ½å›¾æ ‡é¡µé¢ -->
    </div>

    <!-- (ä¿æŒä¸å˜) è¿™æ˜¯åŸæœ‰çš„ã€éšè—çš„æŒ‰é’®å®¹å™¨ï¼ŒJSä¼šè¯»å–å®ƒæ¥ç”Ÿæˆæ–°é¢æ¿ -->
    <div id="chat-input-actions-top" style="display: none !important;">
        <!-- å•èŠå’Œç¾¤èŠéƒ½æ˜¾ç¤ºçš„å›¾æ ‡ -->
        <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ç›¸å†Œ">
            <img src="https://sharkpan.xyz/f/6mYgIa/%E5%9B%BE%E7%89%87%20%281%29.png" alt="ç›¸å†Œ">
        </button>
        <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="æ‹æ‘„">
            <img src="https://sharkpan.xyz/f/OwdjUy/%E7%9B%B8%E6%9C%BA.png" alt="æ‹æ‘„">
        </button>
        <button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½¬è´¦/çº¢åŒ…">
            <img src="https://sharkpan.xyz/f/nQe7tl/%E9%92%B1%E5%8C%85.png" alt="è½¬è´¦/çº¢åŒ…">
        </button>
        <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…">
            <img src="https://sharkpan.xyz/f/JZxJFg/%E5%9C%86%E6%B7%BB%E5%8A%A0.png" alt="è¡¨æƒ…">
        </button>
        <!-- â–¼â–¼â–¼ ã€åŠŸèƒ½å‡çº§ã€‘å¤–å–æŒ‰é’®æ”¹ä¸ºæ·˜å®/ç¤¼ç‰©æŒ‰é’® â–¼â–¼â–¼ -->
<button id="open-shopping-btn" class="chat-action-icon-btn action-button" title="ç¤¼ç‰©">
    <img src="https://sharkpan.xyz/f/B7wWsa/%E8%AE%A2%E5%8D%95.png" alt="ç¤¼ç‰©">
</button>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        <button id="video-call-btn" class="chat-action-icon-btn action-button" title="è§†é¢‘é€šè¯">
            <img src="https://sharkpan.xyz/f/4mAqCj/%E6%91%84%E5%83%8F%E6%9C%BA.png" alt="è§†é¢‘é€šè¯">
        </button>
        <button id="share-link-btn" class="chat-action-icon-btn action-button" title="é“¾æ¥">
            <img src="https://sharkpan.xyz/f/Nzx2Cv/%E8%BF%9E%E6%8E%A5.png" alt="åˆ†äº«é“¾æ¥">
        </button>
        <button id="open-game-panel-btn" class="chat-action-icon-btn action-button" title="æ¸¸æˆ">
            <img src="https://sharkpan.xyz/f/6mlKia/%E6%B8%B8%E6%88%8F%20%284%29.png" alt="æ¸¸æˆ">
        </button>
        <button id="start-offline-mode-btn" class="chat-action-icon-btn action-button" title="çº¿ä¸‹æ¨¡å¼">
            <img src="https://i.postimg.cc/wvLQdKkB/Telegram_(Telegram).png" alt="çº¿ä¸‹æ¨¡å¼">
        </button>

        <!-- ä»…ç¾¤èŠæ˜¾ç¤ºçš„å›¾æ ‡ -->
        <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="ç¾¤è§†é¢‘"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
        <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="æŠ•ç¥¨"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg></button>
    </div>
</div>
<!-- â–²â–²â–² HTML æ›¿æ¢ç»“æŸ â–²â–²â–² -->
    </div>

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ â–¼â–¼â–¼ -->
<div id="chat-lock-overlay">
    <div id="chat-lock-content"></div>
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™å—ä»£ç ç²˜è´´åˆ° id="chat-lock-overlay" çš„ div ä¹‹å â–¼â–¼â–¼ -->

<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ•´å—ä»£ç ,æ›¿æ¢æ‰æ—§çš„ sticker-panel-header å’Œ sticker-grid â–¼â–¼â–¼ -->

<!-- 1. è¿™æ˜¯åŒ…è£¹ä½æ•´ä¸ªè¡¨æƒ…é¢æ¿çš„å®¹å™¨,å®ƒçš„CSSæ ·å¼ä½¿å…¶è„±ç¦»ä¸»å¸ƒå±€ -->
<div id="sticker-panel">
    
    <!-- 2. è¡¨æƒ…é¢æ¿çš„å¤´éƒ¨ -->
    <div id="sticker-panel-header">
        <span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
        <span class="title">æˆ‘çš„è¡¨æƒ…</span>
        <div id="sticker-panel-actions-wrapper">
            <!-- æ­£å¸¸æ¨¡å¼ä¸‹çš„æŒ‰é’® -->
            <div id="sticker-panel-normal-actions" style="display: flex; gap: 10px;">
              <span class="panel-btn" id="manage-stickers-btn">ç®¡ç†</span>
              <span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
              <span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
            </div>
            <!-- ç¼–è¾‘æ¨¡å¼ä¸‹çš„æŒ‰é’® (é»˜è®¤éšè—) -->
            <div id="sticker-panel-edit-actions" style="display: none; align-items: center; gap: 10px;">
               <span class="panel-btn" id="select-all-stickers-btn">å…¨é€‰</span>
               <span class="panel-btn" id="delete-selected-stickers-btn" style="color: #ff3b30; font-weight: 600;">åˆ é™¤</span>
               <span class="panel-btn" id="done-managing-stickers-btn">å®Œæˆ</span>
            </div>
        </div>
    </div>
        <div id="sticker-grid"></div>
    </div>
    <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    <input type="file" id="ai-avatar-library-upload-input" accept="image/*" hidden>
    <input type="file" id="avatar-frame-upload-input" accept="image/png, image/gif, image/webp" hidden multiple>
  <input type="file" id="anniversary-my-avatar-input-global" accept="image/*" hidden>
<input type="file" id="anniversary-ai-avatar-input-global" accept="image/*" hidden>
    
    <!-- éŸ³ä¹æ’­æ”¾å™¨ (ä¿æŒä¸å˜) -->
<div id="music-player-overlay">
    <div class="music-player-window">
        
        <!-- 1. é¡¶éƒ¨æ“ä½œæ  -->
        <div class="music-player-top-actions">
            <div class="top-left-cluster">
                <button id="music-return-btn">â€¹</button>
                <button id="music-exit-btn">Ã—</button>
            </div>
            <span id="music-playlist-btn">â˜°</span>
        </div>
        
        <!-- 2. æ­Œæ›²ä¿¡æ¯ -->
        <div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div>
        <div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
        <div id="music-player-artist">...</div>
        
        <!-- 3. ã€å…¨æ–°ã€‘æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="music-lyrics-container">
            <div id="music-lyrics-list">
                <!-- æ­Œè¯å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                <div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>
            </div>
        </div>
        
        <!-- 4. ã€å…¨æ–°ã€‘æ’­æ”¾æ§åˆ¶åŒºçš„åŒ…è£¹å®¹å™¨ -->
        <div class="music-player-controls-wrapper">
            <!-- a. æ–°çš„iOSé£æ ¼è¿›åº¦æ¡ -->
            <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
            </div>
            
            <!-- b. æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
            <div class="music-controls">
                <button id="music-prev-btn">â—€</button>
                <button id="music-play-pause-btn" class="play-pause-btn">â–¶</button>
                <button id="music-next-btn">â–¶</button>
                <button id="music-mode-btn">é¡ºåº</button>
            </div>
        </div>

    </div>
</div>
    
    <div id="music-playlist-panel">
        <div class="playlist-header">
            <span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
            <span>æ’­æ”¾åˆ—è¡¨</span>
            <div>
                <span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
                <span class="panel-btn" id="add-song-url-btn">URL</span>
            </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
<input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°é‡æ„ç‰ˆã€‘å¤–è§‚è®¾ç½®é¡µé¢ â–¼â–¼â–¼ -->
<div id="wallpaper-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>å¤–è§‚è®¾ç½®</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">

<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ id="theme-management-section" â–¼â–¼â–¼ -->

<!-- 1. ä¸»é¢˜ç®¡ç†åŒºåŸŸ -->
<div id="theme-management-section">
    <label class="section-title">å…¨å±€è‡ªå®šä¹‰æ ·å¼ (CSS)</label>
    
    <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤äº†æ—§çš„é¢œè‰²é€‰æ‹©å™¨ï¼Œæ›¿æ¢ä¸ºä¸‹é¢è¿™ä¸ªæ–‡æœ¬åŸŸ -->
    <div class="form-group" style="width:100%;">
        <label for="global-custom-css-input">åœ¨æ­¤å¤„è¾“å…¥CSSä»£ç ä»¥è¦†ç›–å…¨å±€æ ·å¼</label>
        <textarea id="global-custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ç¤ºä¾‹: å°†æ‰€æœ‰æŒ‰é’®èƒŒæ™¯æ”¹ä¸ºç°è‰² */&#10;.form-button, #send-btn { background-color: #c7c7c7 !important; }"></textarea>
    </div>

    <!-- è¿™éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œä½†æ”¾åœ¨æ–°ç»“æ„é‡Œ -->
    <button class="form-button" id="save-current-theme-btn">å°†å½“å‰å¤–è§‚å­˜ä¸ºæ–°ä¸»é¢˜</button>
    <div id="saved-themes-list">
        <!-- ä¿å­˜çš„ä¸»é¢˜åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>

<!-- â–²â–²â–² HTML æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <!-- â–¼â–¼â–¼ ã€é‡æ„åã€‘çš„å£çº¸è®¾ç½®åŒºåŸŸ â–¼â–¼â–¼ -->
        <div id="wallpaper-settings-section">
            <label class="section-title">å£çº¸åº“</label>
            <button class="form-button" id="manage-wallpaper-library-btn">ç®¡ç†å£çº¸åº“</button>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">

        <!-- 3. Appå›¾æ ‡è®¾ç½®åŒºåŸŸ (ä¿æŒä¸å˜) -->
        <div id="icon-settings-section">
            <label class="section-title">App å›¾æ ‡è®¾ç½®</label>
            <div id="icon-settings-grid">
                <!-- å›¾æ ‡è®¾ç½®é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        
        <!-- 4. å…¶ä»–å¼€å…³ -->
        <div id="other-settings-section">
             <label class="section-title">å…¶ä»–</label>
            <div class="toggle-switch-container">
                <div class="form-group">
                    <label for="theme-toggle-switch">å¤œé—´æ¨¡å¼</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="theme-toggle-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group">
                    <label for="border-toggle-switch">æ˜¾ç¤ºè¾¹æ¡†</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="border-toggle-switch">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- â–¼â–¼â–¼ 5. åŠŸèƒ½ç§»åŠ¨(ç²˜è´´):å°†å­—ä½“è®¾ç½®åŠŸèƒ½ç§»åŠ¨åˆ°å¤–è§‚è®¾ç½®é¡µé¢ â–¼â–¼â–¼ -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">

<div id="font-settings-section" style="width:100%; display:flex; flex-direction:column; align-items:center;">
     <label class="section-title">å…¨å±€å­—ä½“</label>
    <div class="form-group" style="width:100%;">
        <label for="font-url-input">å­—ä½“æ–‡ä»¶URL (.ttf, .otf, .woffç­‰)</label>
        <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
    </div>

    <div class="form-group" style="width:100%;">
        <label>å®æ—¶é¢„è§ˆ</label>
        <div id="font-preview">
            <p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
            <p style="margin: 0;">è¿™æ˜¯å­—ä½“é¢„è§ˆæ•ˆæœ,12345ã€‚</p>
        </div>
    </div>

    <!-- ä¸ºäº†å’Œé¡µé¢ä¸Šå…¶ä»–æŒ‰é’®ç»Ÿä¸€,è¿™é‡Œä¹ŸåŠ ä¸Šäº† style="width:100%" -->
    <button class="form-button" id="save-font-btn" style="width:100%;">ä¿å­˜å¹¶åº”ç”¨å­—ä½“</button>
    <button class="form-button form-button-secondary" id="reset-font-btn" style="width:100%;">æ¢å¤é»˜è®¤å­—ä½“</button>
</div>
<!-- â–²â–²â–² ç§»åŠ¨ç»“æŸ â–²â–²â–² -->

        <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">ä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®</button>
        <input type="file" id="app-icon-upload-input" accept="image/*" hidden>
    </div>
</div>
<!-- â–²â–²â–² é‡æ„ç»“æŸ â–²â–²â–² -->
        
        <!-- ã€å…¨æ–°ã€‘ä¸ºAppå›¾æ ‡ä¸Šä¼ å‡†å¤‡ä¸€ä¸ªéšè—çš„input -->
        <input type="file" id="app-icon-upload-input" accept="image/*" hidden>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«é“¾æ¥åŠŸèƒ½ HTML â–¼â–¼â–¼ -->
<div id="browser-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="browser-back-btn">â€¹</span>
        <span id="browser-title"></span>
        <span style="width: 30px;"></span>
    </div>
    <div id="browser-content" class="list-container">
        <!-- æ–‡ç« å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€‰æ‹©è”ç³»äººä»¥åˆ›å»ºç¾¤èŠçš„å±å¹• â–¼â–¼â–¼ -->
<div id="contact-picker-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">å–æ¶ˆ</span>
        <span>é€‰æ‹©è”ç³»äºº</span>
        <span class="save-btn" id="confirm-contact-picker-btn">å®Œæˆ(0)</span>
    </div>
    <div class="list-container" id="contact-picker-list">
        <!-- è”ç³»äººåˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†å±å¹• â–¼â–¼â–¼ -->
<div id="member-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-member-management">â€¹</span>
        <span>ç¾¤æˆå‘˜ç®¡ç†</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="list-container" id="member-management-list">
        <!-- ç°æœ‰æˆå‘˜åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div id="member-management-actions">
        <button id="add-existing-contact-btn">ä»å¥½å‹åˆ—è¡¨æ·»åŠ </button>
        <button id="create-new-member-btn">åˆ›å»ºç¾¤å†…æ–°æˆå‘˜</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¥ç”µè¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="incoming-call-modal" class="modal">
    <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">é‚€è¯·ä½ è§†é¢‘é€šè¯</div>
        <div class="incoming-call-actions">
            <div class="action-button-wrapper">
                <button id="decline-call-btn" class="call-action-btn decline"></button>
                <span>æ‹’ç»</span>
            </div>
            <div class="action-button-wrapper">
                <button id="accept-call-btn" class="call-action-btn accept"></button>
                <span>æ¥å¬</span>
            </div>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å…¨æ–°ç¾¤èŠå…¼å®¹ç»“æ„ã€‘çš„ä»£ç ,å®Œæ•´æ›¿æ¢ä½ æ—§çš„ #video-call-screen â–¼â–¼â–¼ -->
<div id="video-call-screen" class="screen">
    <!-- 1. é¡¶éƒ¨æ  (ä¿æŒä¸å˜) -->
    <div class="video-call-top-bar">
        <span id="call-timer">00:00</span>
    </div>

    <!-- 3. å¯¹è¯æ¡†åŒºåŸŸ (ä¿æŒä¸å˜) -->
    <div id="video-call-main" class="video-call-main">
        <!-- å¯¹è¯å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
    
    <!-- 4. ã€å‡çº§ã€‘åº•éƒ¨æ§åˆ¶æ ,ç°åœ¨åŒ…å«ä¸€ä¸ªâ€œåŠ å…¥â€æŒ‰é’® -->
    <div class="video-call-controls">
        <button id="user-speak-btn" class="control-btn speak-btn"></button>
        <button id="hang-up-btn" class="control-btn hangup-btn"></button>
        <!-- è¿™ä¸ªæŒ‰é’®é»˜è®¤éšè—,åªåœ¨ç”¨æˆ·â€œæ—è§‚â€æ—¶æ˜¾ç¤º -->
        <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘æ­£åœ¨å‘¼å«ç•Œé¢ â–¼â–¼â–¼ -->
<div id="outgoing-call-screen" class="screen">
    <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">æ­£åœ¨å‘¼å«...</div>
        <div class="outgoing-call-actions">
            <button id="cancel-call-btn" class="call-action-btn decline"></button>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•é¡µé¢ â–¼â–¼â–¼ -->
<div id="call-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="call-history-back-btn">â€¹</span>
        <span id="call-history-title">é€šè¯è®°å½•</span>
        <span style="width: 30px;"></span> <!-- å ä½ç¬¦,ä¿æŒæ ‡é¢˜å±…ä¸­ -->
    </div>
    <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- é€šè¯è®°å½•å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°V3 - äººè®¾åº“ç‰ˆã€‘å¼€æ’­å‰è®¾ç½®ç•Œé¢ â–¼â–¼â–¼ -->
<div id="live-pre-start-overlay">
    <div class="live-pre-start-content">
        <h2 class="title">å‡†å¤‡å¼€å¯ç›´æ’­</h2>
        
        <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸»æ’­é€‰æ‹©æ”¹ä¸ºè°ƒç”¨äººè®¾åº“ -->
        <div class="form-group">
            <label>é€‰æ‹©æˆ‘çš„ç›´æ’­äººè®¾</label>
            <div id="live-streamer-persona-selector">
                <div id="live-streamer-persona-preview" class="persona-preview-box">
                    <img id="live-streamer-avatar-preview" src="">
                    <span id="live-streamer-name-preview"></span>
                </div>
                <button id="live-select-persona-btn" class="form-button-secondary">ä»äººè®¾åº“é€‰æ‹©</button>
            </div>
        </div>

        <div class="form-group">
            <label for="live-theme-input">ç›´æ’­ä¸»é¢˜</label>
            <input type="text" id="live-theme-input" placeholder="ä¾‹å¦‚ï¼šæ·±å¤œæ‚è°ˆã€ç¦å¿Œæ¸¸æˆ">
        </div>
        
        <div class="form-group">
            <label>å¼€æ’­æ—¶é—´</label>
            <input type="datetime-local" id="live-start-time-input">
        </div>

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™å—ã€å…¨æ–°çš„HTMLã€‘ï¼Œæ›¿æ¢æ‰æ—§çš„ id="live-invite-ai-section" â–¼â–¼â–¼ -->
<div class.form-group" id="live-invite-ai-section" style="display: none;">
    <label for="live-invite-ai-select">é‚€è¯·ä¸€ä½é‡‘ä¸»è¿éº¦ï¼Ÿ</label>
    <select id="live-invite-ai-select" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
        <!-- AIå˜‰å®¾é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </select>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

        <button id="confirm-start-live-stream-btn" class="start-live-btn">ç«‹å³å¼€æ’­</button>
        <button id="cancel-start-live-stream-btn" class="form-button form-button-secondary" style="margin-top: 10px;">å–æ¶ˆ</button>
    </div>
</div>
<!-- â–²â–²â–² å¼€æ’­å‰ç•Œé¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°V4 - å¸¦æ’è¡Œæ¦œå’Œé€šçŸ¥åŒºã€‘ç›´æ’­é—´å±å¹• â–¼â–¼â–¼ -->
<div id="live-stream-screen" class="screen">
    <!-- 1. é¡¶éƒ¨ä¿¡æ¯æ  (ä¿æŒä¸å˜) -->
    <div id="live-top-bar">
        <div class="streamer-info" id="live-streamer-info-clickable">
            <img id="live-streamer-avatar" src="" class="avatar">
            <div class="details">
                <span id="live-streamer-name" class="streamer-name"></span>
                <span id="live-viewer-count" class="viewer-count">0 äººæ­£åœ¨çœ‹</span>
            </div>
        </div>
        <div class="live-stats">
            <span id="live-like-count">â¤ï¸ 0</span>
            <span id="live-duration">00:00</span>
        </div>
    </div>
    
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ’è¡Œæ¦œæ¨¡å—HTML â–¼â–¼â–¼ -->
<div id="live-ranking-box">
    <div class="ranking-header">
        <span class="ranking-title">ğŸŒŸ å½“å‰æ’è¡Œæ¦œ</span>
    </div>
    <div class="ranking-list">
        <!-- æ’è¡Œæ¦œæ¡ç›®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

    <!-- 3. ä¸»æ’­æ—ç™½åŒº (ä¿æŒä¸å˜) -->
    <div id="live-host-narration-box">
        <div id="live-host-narration-content"></div>
    </div>

    <!-- 4. ã€ã€ã€æ–°å¢ã€‘ã€‘ã€‘ç¤¼ç‰©ä¸è¿›åœºé€šçŸ¥åŒº -->
    <div id="live-event-feed">
        <!-- ç¤¼ç‰©å’Œè¿›åœºé€šçŸ¥å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- 5. å¼¹å¹•åŒº (ä¿æŒä¸å˜) -->
    <div id="live-comments-feed"></div>

    <!-- 6. åº•éƒ¨æ§åˆ¶æ  (ä¿æŒä¸å˜) -->
    <div id="live-controls">
        <div class="live-input-wrapper">
            <textarea id="live-comment-input" placeholder="å’Œä¸»æ’­è¯´ç‚¹ä»€ä¹ˆ..." rows="1"></textarea>
            <button id="live-send-comment-btn">å‘é€</button>
        </div>
        <button class="live-action-btn" id="live-send-gift-btn">ğŸ</button>
        <button class="live-action-btn" id="live-like-btn">â¤ï¸</button>
        <button class="live-action-btn end-call" id="end-live-stream-btn">Ã—</button>
    </div>
    
    <input type="file" id="live-background-upload-input" accept="image/*" hidden>
</div>
<!-- â–²â–²â–² ç›´æ’­é—´å±å¹•ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ä¿®å¤ç‰ˆã€‘å…¨å±èŠå¤©è®¾ç½®ç•Œé¢ â–¼â–¼â–¼ -->
<div id="chat-settings-screen" class="screen">
    <!-- 1. å…¨æ–°çš„ã€ç¬¦åˆè§„èŒƒçš„å±å¹•å¤´éƒ¨ -->
    <div class="header">
        <span class="back-btn" id="back-from-settings-btn">â€¹</span>
        <span>èŠå¤©è®¾ç½®</span>
        <span class="save-btn" id="save-chat-settings-btn-screen">ä¿å­˜</span>
    </div>

    <!-- â–¼â–¼â–¼ ã€æœ€ç»ˆé‡æ„ç‰ˆã€‘çš„ form-container â–¼â–¼â–¼ -->
    <div class="form-container" id="chat-settings-form-container">
        
        <!-- â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘å¯¹æ–¹ä¿¡æ¯å¡ç‰‡ â–¼â–¼â–¼ -->
        <div class="settings-card" id="ai-settings-card">
            <div class="settings-card-header">
                <div id="settings-ai-avatar-clickable" class="avatar-frame-wrapper" style="cursor: pointer;">
                    <img id="ai-avatar-preview" class="avatar-img">
                    <img id="ai-avatar-frame-preview" class="avatar-frame-overlay">
                </div>
                <div class="header-content-wrapper">
                    <!-- ã€æ ¸å¿ƒä¿®å¤1ã€‘æ¢å¤ä¸ºå¯ç‚¹å‡»çš„æ–‡æœ¬å— -->
                    <div id="ai-name-display-block" class="editable-name-block">
                        <span class="label">å¤‡æ³¨å / ç¾¤å</span>
                        <span id="ai-name-value" class="value"></span>
                    </div>
                </div>
            </div>
            <!-- ã€æ ¸å¿ƒä¿®å¤2ã€‘ä¿ç•™éšè—çš„è¾“å…¥æ¡†ï¼Œç”¨äºå¼¹çª—äº¤äº’ -->
            <div class="form-group" id="chat-name-group" style="display: none;">
                <input type="text" id="chat-name-input">
            </div>

            <!-- â–¼â–¼â–¼ ã€å¯æŠ˜å ç‰ˆã€‘çš„ä¸–ç•Œä¹¦é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
            <div class="form-group" id="world-book-link-group">
                 <label>å…³è”ä¸–ç•Œä¹¦</label>
                 <!-- ã€æ–°å¢ã€‘å¯ç‚¹å‡»çš„æ‘˜è¦æ  -->
                 <div class="custom-multiselect">
                     <div class="select-box" id="wb-pills-summary-box">
                         <span class="selected-options-text" id="wb-pills-summary-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                         <span class="arrow-down">â–¼</span>
                     </div>
                 </div>
                 <!-- ã€æ–°å¢ã€‘å¯æŠ˜å çš„èƒ¶å›Šå®¹å™¨ï¼Œé»˜è®¤éšè— -->
                 <div id="world-book-pills-collapsible-container" style="display: none; margin-top: 5px;">
                     <div id="world-book-pills-container">
                         <!-- ä¸–ç•Œä¹¦èƒ¶å›Šå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                     </div>
                 </div>
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

            <div class="form-group" id="assign-group-section" style="display: none;">
                <label for="assign-group-select">å¥½å‹åˆ†ç»„</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="assign-group-select" style="flex-grow: 1;"></select>
                    <!-- æˆ‘ä»¬ä¿ç•™å›¾æ ‡æŒ‰é’®çš„HTML -->
                    <span id="manage-groups-btn" class="action-btn" style="width: 44px; height: 44px; background-color: #e9ecef; border-radius: 8px;">
                        <img src="https://sharkpan.xyz/f/jxWwf6/StreamlineUltimateHierarchy5Organize.png" alt="ç®¡ç†åˆ†ç»„" style="height: 24px;">
                    </span>
                </div>
            </div>

            <div class="form-group" id="ai-persona-group">
                <label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label>
                <textarea id="ai-persona" rows="3"></textarea>
            </div>
            
            <div class="form-group" id="group-avatar-group" style="display:none;">
                <label>ç¾¤å¤´åƒ</label>
                <div class="avatar-upload">
                    <img id="group-avatar-preview">
                    <button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button>
                    <input type="file" id="group-avatar-input" accept="image/*">
                </div>
            </div>
            <div class="form-group" id="group-members-group" style="display:none;">
                <label>ç¾¤æˆå‘˜äººè®¾</label>
                <div id="group-members-settings"></div>
                <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ç®¡ç†ç¾¤æˆå‘˜</button>
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€æœ€ç»ˆå¸ƒå±€ä¿®å¤ç‰ˆã€‘æˆ‘çš„ä¿¡æ¯å¡ç‰‡ â–¼â–¼â–¼ -->
        <div class="settings-card" id="my-settings-card">
            <div class="settings-card-header">
                 <div id="settings-my-avatar-clickable" class="avatar-frame-wrapper" style="cursor: pointer;">
                    <img id="my-avatar-preview" class="avatar-img">
                    <img id="my-avatar-frame-preview" class="avatar-frame-overlay">
                </div>
                <div class="header-content-wrapper">
                    <!-- ã€æ ¸å¿ƒä¿®å¤1ã€‘å°†â€œæˆ‘çš„ç¾¤æ˜µç§°â€è¾“å…¥æ¡†æ”¾å›åˆ°å¤´éƒ¨ -->
                    <div class="form-group" id="my-group-nickname-group" style="display:none;">
                        <label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label>
                        <input type="text" id="my-group-nickname-input">
                    </div>
                    <!-- ã€æ ¸å¿ƒä¿®å¤2ã€‘å°†â€œæˆ‘çš„äººè®¾â€è¾“å…¥æ¡†ä¹Ÿæ”¾å›åˆ°å¤´éƒ¨ -->
                    <div class="form-group" id="my-persona-group">
                        <label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label>
                        <textarea id="my-persona" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <!-- è¿™ä¸ªå¡ç‰‡çš„ä¸»ä½“éƒ¨åˆ†ç°åœ¨æ˜¯ç©ºçš„ï¼Œå› ä¸ºæ‰€æœ‰å†…å®¹éƒ½ç§»åˆ°äº†å¤´éƒ¨ -->
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        
        <!-- å¡ç‰‡3: å¤–è§‚ä¸æ‚é¡¹ -->
        <div class="settings-card" id="appearance-settings-card">
            <div class="form-group">
                <label for="max-memory">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label>
                <input type="number" id="max-memory" value="10">
            </div>

            <div class="form-group">
                <label for="custom-css-input">è‡ªå®šä¹‰æ°”æ³¡æ ·å¼ (CSS)</label>
                <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ç¤ºä¾‹:ä¸ºâ€œæˆ‘â€çš„æ°”æ³¡æ·»åŠ æ¸å˜èƒŒæ™¯... */"></textarea>
                 <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="form-button-secondary" id="save-custom-css-theme-btn" style="flex:1; margin-top:0;">å­˜ä¸ºä¸»é¢˜</button>
                    <button class="form-button-secondary" id="reset-custom-css-btn" type="button" style="flex:1; margin-top:0;">é‡ç½®</button>
                 </div>
            </div>

            <div class="form-group">
                <label>æˆ‘ä¿å­˜çš„æ°”æ³¡ä¸»é¢˜</label>
                <div id="saved-bubble-themes-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 150px; overflow-y: auto; padding-top: 10px;"></div>
            </div>
            
             <div class="form-group">
                <label for="font-size-slider">èŠå¤©å­—ä½“å¤§å° <span id="font-size-value">13px</span></label>
                <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
            </div>

                        <!-- â–¼â–¼â–¼ ã€é‡æ„åã€‘çš„èŠå¤©èƒŒæ™¯è®¾ç½® â–¼â–¼â–¼ -->
            <div class="form-group">
                <label>èŠå¤©èƒŒæ™¯</label>
                <!-- æ—§çš„ä¸Šä¼ æ§ä»¶è¢«æ›¿æ¢ä¸ºä¸€ä¸ªç»Ÿä¸€çš„å…¥å£æŒ‰é’® -->
                <button id="open-wallpaper-library-from-chat-btn" class="form-button form-button-secondary" style="margin-top: 0;">ä»å£çº¸åº“é€‰æ‹©æˆ–ä¸Šä¼ </button>
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>

        <!-- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘å°†åº•éƒ¨æŒ‰é’®åŒºç§»åŠ¨åˆ°è¿™é‡Œï¼Œå³ form-container çš„å†…éƒ¨ â–¼â–¼â–¼ -->
        <div class="settings-footer-actions">
            <button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button>
            <button class="form-button form-button-secondary danger" id="block-chat-btn">æ‹‰é»‘å¯¹æ–¹</button>
        </div>
        <!-- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² -->

    </div>
    <!-- â–²â–²â–² é‡æ„ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´å…¨æ–°çš„çº¿ä¸‹æ¨¡å¼å±å¹• â–¼â–¼â–¼ -->
<div id="offline-mode-screen" class="screen">
    <!-- 1. é¡¶éƒ¨æ  -->
    <div class="video-call-top-bar">
        <span>ä»Šæ—¥è§é¢</span>
        <span id="offline-mode-timer">00:00</span>
    </div>
    
    <!-- 2. å‰§æƒ…å™è¿°åŒºåŸŸ -->
    <div id="offline-mode-main" class="video-call-main">
        <!-- çº¿ä¸‹å‰§æƒ…å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
    
    <!-- 3. åº•éƒ¨æ§åˆ¶æ  -->
    <div class="video-call-controls">
        <button id="user-offline-action-btn" class="control-btn speak-btn" title="ä½ çš„è¡ŒåŠ¨"></button>
        <button id="end-offline-mode-btn" class="control-btn hangup-btn">ç»“æŸä»Šå¤©çš„è§é¢å§</button>    </div>
</div>
<!-- â–²â–²â–² æ–°å±å¹•ç²˜è´´ç»“æŸ â–²â–²â–² -->

        </div>
    </div>
  
<!-- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ç®¡ç†åˆ†ç»„æŒ‰é’®å·²æ›¿æ¢ä¸ºå›¾æ ‡ â–¼â–¼â–¼ -->
            <div class="form-group" id="assign-group-section" style="display: none;">
                <label for="assign-group-select">å¥½å‹åˆ†ç»„</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="assign-group-select" style="flex-grow: 1;"></select>
                    <!-- å°†<button>æ›¿æ¢ä¸º<span>åŒ…è£¹çš„<img> -->
                    <span id="manage-groups-btn" class="action-btn" style="width: 44px; height: 44px; background-color: #e9ecef; border-radius: 8px;">
                        <img src="https://sharkpan.xyz/f/jxWwf6/StreamlineUltimateHierarchy5Organize.png" alt="ç®¡ç†åˆ†ç»„" style="height: 24px;">
                    </span>
                </div>
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>ç¾¤å¤´åƒ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <!-- â–¼â–¼â–¼ ã€å¯æŠ˜å ç‰ˆã€‘çš„ä¸–ç•Œä¹¦é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
            <div class="form-group" id="world-book-link-group">
                 <label>å…³è”ä¸–ç•Œä¹¦</label>
                 <!-- ã€æ–°å¢ã€‘å¯ç‚¹å‡»çš„æ‘˜è¦æ  -->
                 <div class="custom-multiselect">
                     <div class="select-box" id="wb-pills-summary-box">
                         <span class="selected-options-text" id="wb-pills-summary-text">-- ç‚¹å‡»é€‰æ‹© --</span>
                         <span class="arrow-down">â–¼</span>
                     </div>
                 </div>
                 <!-- ã€æ–°å¢ã€‘å¯æŠ˜å çš„èƒ¶å›Šå®¹å™¨ï¼Œé»˜è®¤éšè— -->
                 <div id="world-book-pills-collapsible-container" style="display: none; margin-top: 5px;">
                     <div id="world-book-pills-container">
                         <!-- ä¸–ç•Œä¹¦èƒ¶å›Šå°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                     </div>
                 </div>
            </div>
            <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>å¯¹æ–¹å¤´åƒ</label><div class="avatar-upload"><div class="avatar-frame-wrapper" style="width: 60px; height: 60px;">
    <img id="ai-avatar-preview" class="avatar-img">
</div><button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šä¼ å¯¹æ–¹å¤´åƒ</button><button id="manage-ai-avatar-library-btn">ç®¡ç†å¤´åƒåº“</button>
<!-- â–¼â–¼â–¼ åœ¨ "ai-avatar-group" çš„ div ä¹‹åï¼Œç²˜è´´ä¸‹é¢è¿™æ®µå…¨æ–°çš„HTML â–¼â–¼â–¼ -->

<input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>æˆ‘çš„å¤´åƒ</label><div class="avatar-upload"><div class="avatar-frame-wrapper" style="width: 60px; height: 60px;">
    <img id="my-avatar-preview" class="avatar-img">
</div><button onclick="document.getElementById('my-avatar-input').click()">ä¸Šä¼ æˆ‘çš„å¤´åƒ</button><button id="open-persona-library-btn">é¢„è®¾</button><button id="open-avatar-frame-library-btn">å¤´åƒæ¡†</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>ç¾¤æˆå‘˜äººè®¾</label><div id="group-members-settings"></div>

    <!-- ã€æ–°å¢ã€‘ç®¡ç†æˆå‘˜æŒ‰é’® -->
    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ç®¡ç†ç¾¤æˆå‘˜</button></div>
<div class="form-group"><label for="max-memory">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>èŠå¤©ä¸»é¢˜ <button id="reset-theme-btn" type="button">é‡ç½®</button></label></div>

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©æ°”æ³¡ä¸»é¢˜â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="font-size-slider">èŠå¤©å­—ä½“å¤§å° <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°ä»£ç ç²˜è´´åˆ°â€œèŠå¤©å­—ä½“å¤§å°â€çš„ form-group ä¹‹å â–¼â–¼â–¼ -->
<div class="form-group">
    <label for="custom-css-input">
        è‡ªå®šä¹‰æ°”æ³¡æ ·å¼ (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">é‡ç½®</button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ç¤ºä¾‹:ä¸ºâ€œæˆ‘â€çš„æ°”æ³¡æ·»åŠ æ¸å˜èƒŒæ™¯å’Œé˜´å½± */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ Paste this new block right after the custom CSS textarea's form-group â–¼â–¼â–¼ -->
<div class="form-group">
    <button class="form-button form-button-secondary" id="save-custom-css-theme-btn">å°†å½“å‰CSSå­˜ä¸ºæ–°ä¸»é¢˜</button>
</div>

<hr style="opacity: 0.2; margin: 20px 0;">

<div class="form-group">
    <label>æˆ‘ä¿å­˜çš„æ°”æ³¡ä¸»é¢˜</label>
    <div id="saved-bubble-themes-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 150px; overflow-y: auto; padding-top: 10px;">
        <!-- Saved themes will be dynamically inserted here by JS -->
    </div>
</div>
<!-- â–²â–²â–² Pasting Ends â–²â–²â–² -->

            <div class="form-group">
                <label>èŠå¤©èƒŒæ™¯</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
                    <button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
<button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">æ‹‰é»‘å¯¹æ–¹</button>
<button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button><button class="save" id="save-chat-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>æˆ‘çš„äººè®¾åº“</span><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">å…³é—­</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span></div><div class="modal-body"><div class="form-group"><label>é¢„è®¾å¤´åƒ</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">é¢„è®¾äººè®¾</label><textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button><button class="save" id="save-persona-preset-btn">ä¿å­˜</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">äººè®¾</label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label>å¤´åƒ</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
                <button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œ!</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="">
        <p id="battery-alert-text"></p>
    </div>
</div>

    <audio id="audio-player" style="display:none;"></audio>

<!-- â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µã€å®Œæ•´ã€‘çš„æ¨¡æ€æ¡†ä»£ç ,æ›¿æ¢æ‰ä½ ç°æœ‰çš„ id="create-post-modal" çš„æ•´ä¸ª div â–¼â–¼â–¼ -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span>å‘å¸ƒåŠ¨æ€</span>
        </div>
        <div class="modal-body">
            <!-- å…¬å¼€æ–‡å­—è¾“å…¥åŒº -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="åˆ†äº«æ–°é²œäº‹...(éå¿…å¡«çš„å…¬å¼€æ–‡å­—)"></textarea>
            </div>

            <!-- === æ¨¡å¼åˆ‡æ¢å¼€å…³ (æ–°å¢) === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="switch-to-text-image-mode" class="mode-btn">ä½¿ç”¨æ–‡å­—å›¾</button>
            </div>

<!-- â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„å¯è§èŒƒå›´è®¾ç½® â–¼â–¼â–¼ -->
<div class="form-group">
    <label>å¯è§èŒƒå›´</label>
    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="public" checked> å…¬å¼€</label>

        <label><input type="radio" name="visibility" value="include"> æŒ‡å®šåˆ†ç»„å¯è§</label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <!-- åˆ†ç»„å¤šé€‰æ¡†å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<!-- â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–² -->

            <!-- === å›¾ç‰‡æ¨¡å¼åŒºåŸŸ === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
<div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                        <button id="post-remove-image-btn">Ã—</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">æœ¬åœ°ä¸Šä¼ </button>
                        <button id="post-use-url-btn" class="form-button-secondary">ç½‘ç»œURL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>å›¾ç‰‡æè¿° (å¿…å¡«,ç»™AIçœ‹)</label>
                    <input type="text" id="post-image-description" placeholder="ç®€å•æè¿°å›¾ç‰‡å†…å®¹,å¸®åŠ©AIç†è§£">
                </div>
            </div>

            <!-- === æ–‡å­—å›¾æ¨¡å¼åŒºåŸŸ (æ–°å¢) === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>æ–‡å­—å›¾ (ç»™AIç†è§£ç”¨çš„æè¿°,ç‚¹å‡»å›¾ç‰‡åå¯è§)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å›¾ç‰‡æè¿°..."></textarea>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-post-btn">å‘å¸ƒ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ·˜å®/ç¤¼ç‰©åŠŸèƒ½æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="shopping-modal" class="modal">
    <div class="modal-content" style="height: 80%; width: 95%;">
        <!-- â–¼â–¼â–¼ ã€è§†è§‰ä¿®å¤ç‰ˆã€‘çš„æ¨¡æ€æ¡†å¤´éƒ¨ â–¼â–¼â–¼ -->
        <div class="modal-header" style="flex-direction: column; align-items: stretch; gap: 12px; padding-bottom: 10px;">
            <span>é€‰ä¸ªç¤¼ç‰©å§</span>
            <!-- æ·˜å®é£æ ¼æ ‡é¢˜æ  -->
            <div id="shopping-title-bar" style="display: none; width: 100%; background-color: #f0f2f5; padding: 10px 12px; border-radius: 8px; font-size: 14px; text-align: center; box-sizing: border-box;">
                ä¸º <strong id="shopping-keyword-display"></strong> æ‰¾åˆ°äº†ä»¥ä¸‹å®è´
            </div>
        </div>
        <!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->
        <div class="modal-body" id="shopping-list-container" style="padding: 10px; background-color: #f0f2f5;">
            <!-- AIç”Ÿæˆçš„å•†å“åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            <div id="shopping-loading-spinner" style="text-align: center; padding: 40px; color: var(--text-secondary);">æ­£åœ¨æŸ¥æ‰¾å•†å“...</div>
        </div>
        <div class="modal-footer" style="flex-direction: column; gap: 10px; padding: 15px;">
            <div id="shopping-item-preview" style="display: none; text-align: center; margin-bottom: 10px;">
                <img id="shopping-preview-img" src="" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; margin-bottom: 5px;">
                <p id="shopping-preview-name" style="font-weight: 500; margin: 0;"></p>
            </div>
            <div id="shopping-actions" style="display: none; width: 100%; gap: 10px;">
                <button class="form-button" id="shopping-action-give">é€ç»™Ta</button>
                <button class="form-button form-button-secondary" id="shopping-action-request">è®©Taé€</button>
            </div>
            <button class="cancel" id="shopping-cancel-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°çš„æ¨¡æ€æ¡†HTMLç²˜è´´åˆ°æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†ä¹‹å â–¼â–¼â–¼ -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†å¥½å‹åˆ†ç»„</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç»„</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="è¾“å…¥åˆ†ç»„å..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç»„åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸Šä¸‹æ–‡æ¶ˆæ¯æ“ä½œèœå• â–¼â–¼â–¼ -->
<div id="message-actions-menu" class="context-menu">
    <div class="menu-item" id="edit-message-btn"><span class="icon edit"></span> ç¼–è¾‘</div>
    <div class="menu-item" id="copy-message-btn"><span class="icon copy"></span> å¤åˆ¶</div>
    <div class="menu-item" id="recall-message-btn"><span class="icon recall"></span> æ’¤å›</div>
    <div class="menu-item" id="quote-message-btn"><span class="icon quote"></span> å¼•ç”¨</div>
    <div class="menu-item" id="select-message-btn"><span class="icon select"></span> å¤šé€‰</div>
</div>
<!-- â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ è¯·å°†è¿™æ®µæ–°HTMLç²˜è´´åˆ°æ‰€æœ‰æ¨¡æ€æ¡†çš„æœ«å°¾ â–¼â–¼â–¼ -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn">ç¼–è¾‘åŠ¨æ€</button>
            <button id="copy-post-btn">å¤åˆ¶å†…å®¹</button>           
            <button id="cancel-post-action-btn">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¯è§†åŒ–æ¶ˆæ¯ç¼–è¾‘å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
        <div class="modal-header">
            <span>ç¼–è¾‘ä¸æ‹†åˆ†æ¶ˆæ¯</span>
        </div>
        <div class="modal-body" id="message-editor-body">
            <!-- ç¼–è¾‘å™¨å®¹å™¨,JSä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆæ–‡æœ¬æ¡† -->
            <div id="message-editor-container"></div>
            <!-- æ·»åŠ æ–°æ¶ˆæ¯çš„æŒ‰é’® -->
            <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                [+] æ·»åŠ ä¸‹ä¸€æ¡æ¶ˆæ¯
            </button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-advanced-editor-btn">å–æ¶ˆ</button>
            <button class="save" id="save-advanced-editor-btn">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤–å–è¯·æ±‚æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span>å‘èµ·å¤–å–ä»£ä»˜</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info">å•†å“ä¿¡æ¯</label>
                <input type="text" id="waimai-product-info" placeholder="ä¾‹å¦‚:ä¸€æ¯æ¨æç”˜éœ²">
            </div>
            <div class="form-group">
                <label for="waimai-amount">ä»£ä»˜é‡‘é¢ (å…ƒ)</label>
                <input type="number" id="waimai-amount" placeholder="ä¾‹å¦‚:21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="waimai-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="waimai-confirm-btn">å‘èµ·è¯·æ±‚</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ–°å»ºçº¦å®š/å€’è®¡æ—¶æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>æ–°å»ºçº¦å®š</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="countdown-title-input">çº¦å®šæ ‡é¢˜</label>
                <input type="text" id="countdown-title-input" placeholder="ä¾‹å¦‚:æˆ‘çš„ç”Ÿæ—¥">
            </div>
            <div class="form-group">
                <label for="countdown-date-input">çº¦å®šæ—¥æœŸä¸æ—¶é—´</label>
                <input type="datetime-local" id="countdown-date-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-countdown-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-countdown-btn">ä¿å­˜çº¦å®š</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å‘çº¢åŒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>å‘çº¢åŒ…</span>
        </div>
        <div class="modal-body" style="padding: 0;">
<!-- 1. é¡µç­¾åˆ‡æ¢ -->
<div class="frame-tabs">
    <div id="rp-tab-group" class="frame-tab active">æ‹¼æ‰‹æ°”çº¢åŒ…</div>
    <div id="rp-tab-direct" class="frame-tab">ä¸“å±çº¢åŒ…</div>
</div>

            <!-- 2. æ‹¼æ‰‹æ°”çº¢åŒ…å†…å®¹åŒº -->
            <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                <div class="form-group">
                    <label>æ€»é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="rp-group-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>çº¢åŒ…ä¸ªæ•°</label>
                    <input type="number" id="rp-group-count" placeholder="å¡«å†™çº¢åŒ…ä¸ªæ•°">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦è¯­</label>
                    <input type="text" id="rp-group-greeting" placeholder="æ­å–œå‘è´¢,å¤§å‰å¤§åˆ©!">
                </div>
                <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-group-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
            </div>

            <!-- 3. ä¸“å±çº¢åŒ…å†…å®¹åŒº -->
            <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                <div class="form-group">
                    <label>å‘é€ç»™</label>
                    <select id="rp-direct-receiver"></select>
                </div>
                <div class="form-group">
                    <label>é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="rp-direct-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>ç¥ç¦è¯­</label>
                    <input type="text" id="rp-direct-greeting" placeholder="æ­å–œå‘è´¢,å¤§å‰å¤§åˆ©!">
                </div>
                 <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">Â¥ 0.00</p>
                <button id="send-direct-packet-btn" class="form-button">å¡é’±è¿›çº¢åŒ…</button>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center;">
             <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
        <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
            <div style="text-align: center; width: 100%;">
                <div id="rp-details-sender" style="font-size: 16px;"></div>
                <div style="font-size: 13px; opacity: 0.8;">çš„çº¢åŒ…</div>
            </div>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
            <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                <span style="font-size: 18px; color: #E44D44;">å…ƒ</span>
            </div>
            <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
            <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                <!-- é¢†å–è¯¦æƒ…å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-rp-details-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->
<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºæŠ•ç¥¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>å‘èµ·æŠ•ç¥¨</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="poll-question-input">æŠ•ç¥¨é—®é¢˜</label>
                <textarea id="poll-question-input" rows="2" placeholder="ä¾‹å¦‚:ä»Šæ™šæˆ‘ä»¬çœ‹ä»€ä¹ˆç”µå½±ï¼Ÿ"></textarea>
            </div>
            <div class="form-group">
                <label>æŠ•ç¥¨é€‰é¡¹ (è‡³å°‘2é¡¹)</label>
                <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- æŠ•ç¥¨é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                </div>
                <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ æ·»åŠ é€‰é¡¹</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-poll-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-create-poll-btn">å‘èµ·æŠ•ç¥¨</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒè®¾ç½®æ¨¡æ€æ¡† (P1) â–¼â–¼â–¼ -->
<div id="ai-avatar-editor-modal" class="modal">
    <div class="modal-content" style="width: 290px; height: auto;">
        <div class="modal-header">
            <span>è®¾ç½®å¯¹æ–¹å¤´åƒ</span>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
            <!-- 1. é¢„è§ˆåŒºåŸŸ -->
            <div class="avatar-editor-preview-area">
                <div id="ai-editor-preview-wrapper" class="avatar-editor-preview-wrapper">
                    <img id="ai-editor-preview-img" class="avatar-img" src="">
                    <img id="ai-editor-preview-frame" class="avatar-frame-overlay" src="">
                </div>
            </div>
            <!-- 2. æ“ä½œæŒ‰é’®ç½‘æ ¼ -->
            <div class="avatar-editor-actions-grid">
                <button id="ai-editor-upload-btn" class="avatar-editor-action-btn">ä¸Šä¼ å¤´åƒ</button>
                <button id="ai-editor-manage-library-btn" class="avatar-editor-action-btn">ç®¡ç†å¤´åƒåº“</button>
                <button id="ai-editor-select-frame-btn" class="avatar-editor-action-btn">é€‰æ‹©å¤´åƒæ¡†</button>
                <button id="ai-editor-remove-frame-btn" class="avatar-editor-action-btn">ç§»é™¤å¤´åƒæ¡†</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="ai-editor-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="ai-editor-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² AIå¤´åƒæ¨¡æ€æ¡†ç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æˆ‘çš„å¤´åƒè®¾ç½®æ¨¡æ€æ¡† (P2) â–¼â–¼â–¼ -->
<div id="my-avatar-editor-modal" class="modal">
    <div class="modal-content" style="width: 290px; height: auto;">
        <div class="modal-header">
            <span>è®¾ç½®æˆ‘çš„å¤´åƒ</span>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
            <!-- 1. é¢„è§ˆåŒºåŸŸ -->
            <div class="avatar-editor-preview-area">
                <div id="my-editor-preview-wrapper" class="avatar-editor-preview-wrapper">
                    <img id="my-editor-preview-img" class="avatar-img" src="">
                    <img id="my-editor-preview-frame" class="avatar-frame-overlay" src="">
                </div>
            </div>
            <!-- 2. æ“ä½œæŒ‰é’®ç½‘æ ¼ -->
            <div class="avatar-editor-actions-grid">
                <button id="my-editor-upload-btn" class="avatar-editor-action-btn">ä¸Šä¼ å¤´åƒ</button>
                <button id="my-editor-persona-library-btn" class="avatar-editor-action-btn">äººè®¾é¢„è®¾åº“</button>
                <button id="my-editor-select-frame-btn" class="avatar-editor-action-btn">é€‰æ‹©å¤´åƒæ¡†</button>
                <button id="my-editor-remove-frame-btn" class="avatar-editor-action-btn">ç§»é™¤å¤´åƒæ¡†</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="my-editor-cancel-btn">å–æ¶ˆ</button>
            <button class="save" id="my-editor-save-btn">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æˆ‘çš„å¤´åƒæ¨¡æ€æ¡†ç»“æŸ â–²â–²â–² -->


<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸ºæ–°æ¨¡æ€æ¡†å‡†å¤‡çš„éšè—æ–‡ä»¶ä¸Šä¼ æ§ä»¶ â–¼â–¼â–¼ -->
<input type="file" id="ai-avatar-editor-upload-input" accept="image/*" hidden>
<input type="file" id="my-avatar-editor-upload-input" accept="image/*" hidden>
<!-- â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="ai-avatar-library-title">å¯¹æ–¹çš„å¤´åƒåº“</span>
            <button id="add-ai-avatar-btn" class="action-button">æ·»åŠ </button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- å¤´åƒåº“å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å¤´åƒæ¡†åº“æ¨¡æ€æ¡† -->
<div id="avatar-frame-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="avatar-frame-library-title">å¤´åƒæ¡†åº“</span>
            <button id="add-avatar-frame-btn" class="action-button">æ·»åŠ </button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="avatar-frame-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 15px;">
                <!-- å¤´åƒæ¡†åº“å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-avatar-frame-library-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€ç¬¬1æ­¥ã€‘ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬,æ›¿æ¢æ—§çš„ id="cute-event-viewer-modal" â–¼â–¼â–¼ -->
<div id="cute-event-viewer-modal" class="modal">
    <div class="cute-event-viewer-content">
        <!-- é¡¶éƒ¨å›¾æ ‡ (ä¸å˜) -->
        <div class="cute-event-header">
            <span class="cute-event-icon">ğŸ“Œ</span>
        </div>
        
        <!-- äº‹ä»¶æ ‡é¢˜ (ä¸å˜) -->
        <h2 id="cute-event-title" class="cute-event-title"></h2>
        
        <!-- å…ƒæ•°æ®:ä½œè€…å’Œæ—¶é—´ (ä¸å˜) -->
        <div id="cute-event-meta" class="cute-event-meta"></div>
        
        <!-- äº‹ä»¶å¤‡å¿˜å½•å†…å®¹ (ä¸å˜) -->
        <div id="cute-event-memo" class="cute-event-memo"></div>
        
        <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘å…¨æ–°çš„åº•éƒ¨æ“ä½œæ  -->
        <div class="cute-event-footer">
            <button id="cute-event-delete-btn" class="cute-event-action-btn danger">åˆ é™¤</button>
            <button id="cute-event-edit-btn" class="cute-event-action-btn">ç¼–è¾‘</button>
            <button id="close-cute-event-viewer-btn" class="cute-event-action-btn secondary">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² HTMLæ›¿æ¢ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°è®¾è®¡ã€‘å¤´åƒæ¡†åº”ç”¨é€‰æ‹©æ¨¡æ€æ¡† (ç”¨æ­¤ä»£ç æ›¿æ¢æ—§çš„) â–¼â–¼â–¼ -->
<div id="avatar-frame-apply-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto;">
        <div class="modal-header">
            <span>åº”ç”¨å¤´åƒæ¡†</span>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
            
            <!-- 1. å…¨æ–°çš„é¢„è§ˆåŒºåŸŸ -->
            <div class="frame-apply-preview-container">
                <!-- â€œæˆ‘â€çš„é¢„è§ˆ -->
                <div class="frame-apply-target">
                    <div id="frame-apply-preview-me" class="avatar-frame-wrapper">
                        <img class="avatar-img" src="">
                        <img class="avatar-frame-overlay" src="">
                    </div>
                    <span style="font-size: 14px; font-weight: 500;">æˆ‘</span>
                </div>
                <!-- â€œå¯¹æ–¹â€çš„é¢„è§ˆ -->
                <div class="frame-apply-target">
                    <div id="frame-apply-preview-ai" class="avatar-frame-wrapper">
                        <img class="avatar-img" src="">
                        <img class="avatar-frame-overlay" src="">
                    </div>
                    <span style="font-size: 14px; font-weight: 500;">å¯¹æ–¹</span>
                </div>
            </div>

            <!-- 2. å…¨æ–°çš„æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="frame-apply-actions">
                <button data-choice="me" class="form-button small">åº”ç”¨ç»™æˆ‘</button>
                <button data-choice="ai" class="form-button small">åº”ç”¨ç»™å¯¹æ–¹</button>
            </div>
            <div class="frame-apply-actions">
                <button data-choice="remove_me" class="button-as-link danger">ç§»é™¤æˆ‘çš„</button>
                <button data-choice="remove_ai" class="button-as-link danger">ç§»é™¤å¯¹æ–¹çš„</button>
            </div>

        </div>
        <div class="modal-footer">
            <button data-choice="cancel" class="cancel" style="width: 100%;">è¿”å›</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>åˆ†äº«é“¾æ¥</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="link-title-input">æ ‡é¢˜</label>
                <input type="text" id="link-title-input" placeholder="è¾“å…¥æ–‡ç« æˆ–é“¾æ¥çš„æ ‡é¢˜">
            </div>
            <div class="form-group">
                <label for="link-description-input">æ‘˜è¦ (å¯é€‰)</label>
                <textarea id="link-description-input" rows="2" placeholder="ç®€å•æè¿°ä¸€ä¸‹é“¾æ¥å†…å®¹"></textarea>
            </div>
            <div class="form-group">
                <label for="link-source-input">æ¥æºåç§° (å¯é€‰)</label>
                <input type="text" id="link-source-input" placeholder="ä¾‹å¦‚:çŸ¥ä¹æ—¥æŠ¥ã€Bç«™">
            </div>
            <div class="form-group">
                <label for="link-content-input">å®Œæ•´å†…å®¹ (å¯é€‰,ç”¨äºæµè§ˆå™¨å†…æ˜¾ç¤º)</label>
                <textarea id="link-content-input" rows="4" placeholder="ç²˜è´´æˆ–è¾“å…¥å®Œæ•´çš„æ–‡ç« å†…å®¹"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-link-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-link-btn">åˆ†äº«</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç²¾è‡´ç‰ˆè½¬è´¦æ“ä½œå¼¹çª— â–¼â–¼â–¼ -->
<div id="transfer-actions-modal" class="modal">
    <div class="transfer-actions-content">
        <div class="transfer-actions-header">è¯·é€‰æ‹©æ“ä½œ</div>
        <div class="transfer-actions-body">
            <p>ä½ æ”¶åˆ°äº†æ¥è‡ª <strong id="transfer-sender-name"></strong> çš„ä¸€ç¬”è½¬è´¦ã€‚</p>
        </div>
        <div class="transfer-actions-footer">
            <button id="transfer-action-decline" class="action-btn decline">æ®‹å¿æ‹’ç»</button>
            <button id="transfer-action-accept" class="action-btn accept">å¼€å¿ƒæ”¶ä¸‹</button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn">Ã—</button>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="call-transcript-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="transcript-modal-title">é€šè¯è¯¦æƒ…</span>
        </div>
        <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5;">
            <!-- é€šè¯æ–‡å­—è®°å½•å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">åˆ é™¤è®°å½•</button>
            <button class="save" id="close-transcript-modal-btn" style="width: 100%;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«ç›®æ ‡é€‰æ‹©å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="share-target-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>åˆ†äº«åˆ°...</span>
        </div>
        <div class="modal-body" id="share-target-list" style="padding: 0;">
            <!-- èŠå¤©åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-target-btn">å–æ¶ˆ</button>
            <button class="save" id="confirm-share-target-btn">ç¡®è®¤åˆ†äº«</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ†äº«è®°å½•æŸ¥çœ‹å™¨æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="shared-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="shared-history-viewer-title">èŠå¤©è®°å½•</span>
        </div>
        <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
            <!-- åˆ†äº«çš„èŠå¤©è®°å½•æ°”æ³¡å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">å…³é—­</button>
        </div>
    </div>
</div>

<!-- â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸–ç•Œä¹¦åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡† â–¼â–¼â–¼ -->
<div id="world-book-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ç®¡ç†ä¸–ç•Œä¹¦åˆ†ç±»</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ–°å»ºåˆ†ç±»</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-category-name-input" placeholder="è¾“å…¥åˆ†ç±»å..." style="flex-grow: 1;">
                    <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">æ·»åŠ </button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- åˆ†ç±»åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-category-manager-btn" style="width: 100%;">å®Œæˆ</button>
        </div>
    </div>
</div>
<!-- â–²â–²â–² æ–°HTMLç²˜è´´ç»“æŸ â–²â–²â–² -->

<script>

            // --- å·²ä¿®æ­£ ---
        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
        // --- ä¿®æ­£ç»“æŸ ---

        let isAiGenerating = false; // ç”¨äºè·Ÿè¸ªAIæ˜¯å¦æ­£åœ¨ç”Ÿæˆå†…å®¹
let avatarEditorContext = { target: null, newAvatarSrc: null, newFrameSrc: null };
let wallpaperLibraryContext = { from: null, activeChatId: null }; // ç”¨äºè®°å½•å£çº¸åº“çš„æ‰“å¼€æ¥æº
let liveStreamState = {
    isActive: false,
    activeChatId: null,
    streamerId: null,
    streamerPersona: '',
    streamerAvatar: '', // æ–°å¢ï¼šä¸»æ’­å¤´åƒ
    streamerNickname: '', // æ–°å¢ï¼šä¸»æ’­æ˜µç§°
    invitedAiId: null,
    theme: '',
    mode: 'solo',
    startTime: null,
    scheduledTime: null,
    viewerCount: 0,
    likes: 0,
    backgroundUrl: '',
    simulationIntervalId: null,
    lastAudienceActionTime: 0,
    commentHistory: [], // æ–°å¢ï¼šå®Œæ•´çš„å¼¹å¹•å†å²
    hostNarration: '',  // ä¿®æ”¹ï¼šåªå­˜æœ€æ–°çš„æ—ç™½
     // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢ä¸¤è¡Œ â–¼â–¼â–¼
    peakViewers: 0,      // ç”¨äºè®°å½•æœ€é«˜äººæ°”
    totalGiftValue: 0.0, // ç”¨äºç´¯è®¡ç¤¼ç‰©æ€»é¢
};
        let canRegenerate = false; // ç”¨äºè·Ÿè¸ªæ˜¯å¦å¯ä»¥æ‰§è¡Œâ€œé‡æ–°ç”Ÿæˆâ€æ“ä½œ
        let abortController = null; // ç”¨äºå­˜å‚¨å’Œè°ƒç”¨fetchçš„ä¸­æ–­æ§åˆ¶å™¨

        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
            function toGeminiRequestData(model, apiKey, systemPrompt, messages, isGemini) {
        // è¿™ä¸ªå‡½æ•°ç”¨äºæ„å»ºå¯¹ Gemini API çš„è¯·æ±‚
        const proxyUrl = state.apiConfig.proxyUrl; 
        
        const contents = formatMessagesForGemini(messages);
        
        const dataPayload = {
            contents: contents,
            generationConfig: { temperature: 0.8 },
        };

        if (systemPrompt && systemPrompt.trim() !== '') {
            dataPayload.systemInstruction = { parts: [{ "text": systemPrompt }] };
        }
        
        const fetchOptions = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataPayload)
        };
        
        let url;
        const isStudioGemini = proxyUrl === 'https://generativelanguage.googleapis.com';
        const isLegacyGemini = proxyUrl === 'https://generativelanguage.googleapis.com/v1beta/models';

        if (isStudioGemini) {
            url = `${proxyUrl}/v1beta/models/${model}:generateContent`;
            fetchOptions.headers['x-goog-api-key'] = getRandomValue(apiKey);
        } else if (isLegacyGemini) {
            url = `${proxyUrl}/${model}:generateContent?key=${getRandomValue(apiKey)}`;
        } else {
            console.warn("toGeminiRequestData è¢«è°ƒç”¨,ä½†ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªæœªçŸ¥çš„ Gemini URL æ ¼å¼ã€‚");
            url = `${proxyUrl}/${model}:generateContent?key=${getRandomValue(apiKey)}`;
        }

        return { url: url, data: fetchOptions };
    }
    // geminiå¦‚æœæ˜¯å¤šä¸ªå¯†é’¥, é‚£ä¹ˆéšæœºè·å–ä¸€ä¸ª
    function getRandomValue(str) {
        // æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«é€—å·
        if (str.includes(',')) {
            // ç”¨é€—å·åˆ†éš”å­—ç¬¦ä¸²å¹¶ç§»é™¤å¤šä½™ç©ºæ ¼
            const arr = str.split(',').map(item => item.trim());
            // ç”Ÿæˆéšæœºç´¢å¼• (0 åˆ° arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // è¿”å›éšæœºå…ƒç´ 
            return arr[randomIndex];
        }
        // æ²¡æœ‰é€—å·åˆ™ç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
        return str;
    }
    function isImage(text,content) {
        let currentImageData = content.image_url.url
        // æå–Base64æ•°æ®(å»æ‰å‰ç¼€)
        const base64Data = currentImageData.split(',')[1];
        // æ ¹æ®å›¾ç‰‡ç±»å‹è·å–MIMEç±»å‹
        const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
        return [
            {text: `${text.text}ç”¨æˆ·å‘ä½ å‘é€äº†ä¸€å¼ å›¾ç‰‡`},
            {
                inline_data: {
                    mime_type: mimeType,
                    data: base64Data
                }
            }
        ]
    }

   function extractArray(text) {
        // æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼:åŒ¹é…å¼€å¤´çš„æ—¶é—´æˆ³éƒ¨åˆ†å’Œåç»­çš„JSONæ•°ç»„
        const pattern = /^\(Timestamp: (\d+)\)(.*)$/s;
        const match = text.match(pattern);

        if (match) {
            const timestampPart = `(Timestamp: ${match[1]}) `;
            const jsonPart = match[2].trim();

            try {
                // å°è¯•è§£æJSONéƒ¨åˆ†
                const parsedJson = JSON.parse(jsonPart);
                // éªŒè¯è§£æç»“æœæ˜¯å¦ä¸ºæ•°ç»„
                if (Array.isArray(parsedJson)) {
                    return [timestampPart, parsedJson[0]];
                }
            } catch (error) {
                // è§£æå¤±è´¥,è¿”å›åŸå§‹æ–‡æœ¬
            }
        }

        // ä¸åŒ¹é…æ ¼å¼æˆ–è§£æå¤±è´¥æ—¶è¿”å›åŸå€¼
        return text;
    }
    function transformChatData(item) {
        let type = {
            send_and_recall:'æ’¤å›äº†æ¶ˆæ¯',
            update_status:'æ›´æ–°äº†çŠ¶æ€',
            change_music:'åˆ‡æ¢äº†æ­Œæ›²',
            create_memory:'è®°å½•äº†å›å¿†',
            create_countdown:'åˆ›å»ºäº†çº¦å®š/å€’è®¡æ—¶',
            text:'å‘é€äº†æ–‡æœ¬',
            sticker:'å‘é€äº†è¡¨æƒ…',
            ai_image:'å‘é€äº†å›¾ç‰‡',
            voice_message:'å‘é€äº†è¯­éŸ³',
            transfer:'å‘èµ·äº†è½¬è´¦',
            waimai_request:'å‘èµ·äº†å¤–å–è¯·æ±‚',
            waimai_response:{
                paid:'å›åº”äº†å¤–å–-åŒæ„',
                rejected:'å›åº”äº†å¤–å–-æ‹’ç»'
            },
            video_call_request:'å‘èµ·äº†è§†é¢‘é€šè¯',
            video_call_response:{
                accept:'å›åº”äº†è§†é¢‘é€šè¯-æ¥å—',
                reject:'å›åº”äº†è§†é¢‘é€šè¯-æ‹’ç»'
            },
            qzone_post:{
                shuoshuo:'å‘å¸ƒäº†è¯´è¯´',
                text_image:'å‘å¸ƒäº†æ–‡å­—å›¾'
            },
            qzone_comment:'è¯„è®ºäº†åŠ¨æ€',
            qzone_like:'ç‚¹èµäº†åŠ¨æ€',
            pat_user:'æ‹ä¸€æ‹äº†ç”¨æˆ·',
            block_user:'æ‹‰é»‘äº†ç”¨æˆ·',
            friend_request_response:'å›åº”äº†å¥½å‹ç”³è¯·',
            change_avatar:'æ›´æ¢äº†å¤´åƒ',
            share_link:'åˆ†äº«äº†é“¾æ¥',
            accept_transfer:'å›åº”äº†è½¬è´¦-æ¥å—',
            decline_transfer:'å›åº”äº†è½¬è´¦-æ‹’ç»/é€€æ¬¾',
            quote_reply:'å¼•ç”¨äº†å›å¤',
            text:'',
        }
        let res = extractArray(item.content)

        if(Array.isArray(res)){
            let obj = res[1]
            let itemType = obj.type;
            let time = res[0]
            let text = type[itemType];
            if(text){
                if(itemType === 'sticker'){
                    return [{text:`${time}[${text}] å«ä¹‰æ˜¯:${obj.meaning}`}]
                }else if(itemType === 'send_and_recall'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'update_status'){
                    return [{text:`${time}[${text}] ${obj.status_text}(${obj.is_busy ? 'å¿™ç¢Œ/ç¦»å¼€' : 'ç©ºé—²'})`}]
                }else if(itemType === 'change_music'){
                    return [{text:`${time}[${text}] ${obj.change_music}, æ­Œåæ˜¯:${obj.song_name}`}]
                }else if(itemType === 'create_memory'){
                    return [{text:`${time}[${text}] ${obj.description}`}]
                }else if(itemType === 'create_countdown'){
                    return [{text:`${time}[${text}] ${obj.title}(${obj.date})`}]
                }else if(itemType === 'ai_image'){
                    return [{text:`${time}[${text}] å›¾ç‰‡æè¿°æ˜¯:${obj.description}`}]
                }else if(itemType === 'voice_message'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'transfer'){
                    return [{text:`${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å¤‡æ³¨æ˜¯:${obj.amount}`}]
                }else if(itemType === 'waimai_request'){
                    return [{text:`${time}[${text}] é‡‘é¢æ˜¯:${obj.amount} å•†å“æ˜¯:${obj.productInfo}`}]
                }else if(itemType === 'waimai_response'){
                    return [{text:`${time}[${text[obj.status]}] ${obj.status === 'paid' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text}]`}]
                }}else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text[obj.decision]}] ${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'qzone_post'){
                    return [{text:`${time}[${text[obj.postType]}] ${obj.postType === 'shuoshuo' ? `${obj.content}` : `å›¾ç‰‡æè¿°æ˜¯:${obj.hiddenContent} ${obj.publicText ? `æ–‡æ¡ˆæ˜¯: ${obj.publicText}` : ''}`}`}]
                }else if(itemType === 'qzone_comment'){
                    return [{text:`${time}[${text}] è¯„è®ºçš„idæ˜¯: ${obj.postId} è¯„è®ºçš„å†…å®¹æ˜¯: ${obj.commentText}`}]
                }else if(itemType === 'qzone_like'){
                    return [{text:`${time}[${text}] ç‚¹èµçš„idæ˜¯: ${obj.postId}`}]
                }else if(itemType === 'pat_user'){
                    return [{text:`${time}[${text}] ${obj.suffix ? obj.suffix  : ''}`}]
                }else if(itemType === 'block_user'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'friend_request_response'){
                    return [{text:`${time}[${text}] ç»“æœæ˜¯:${obj.decision === 'accept' ? 'åŒæ„' : 'æ‹’ç»'}`}]
                }else if(itemType === 'change_avatar'){
                    return [{text:`${time}[${text}] å¤´åƒåæ˜¯:${obj.name}`}]
                }else if(itemType === 'share_link'){
                    return [{text:`${time}[${text}] æ–‡ç« æ ‡é¢˜æ˜¯:${obj.title}  æ–‡ç« æ‘˜è¦æ˜¯:${obj.description} æ¥æºç½‘ç«™åæ˜¯:${obj.source_name} æ–‡ç« æ­£æ–‡æ˜¯:${obj.content}`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'quote_reply'){
                    return [{text:`${time}[${text}] å¼•ç”¨çš„å†…å®¹æ˜¯:${obj.reply_content}`}]
                }else if(itemType === 'text'){
                    return [{text:`${time}${obj.content}`}]
                }
            }

if(Array.isArray(res) && res.length > 1) {
	res = `${res[0]}${res[1].content}`
}

        return [{text:res}]
    }

    function formatMessagesForGemini(messages) {
        let roleType = {
            user: 'user',
            assistant: 'model',
            system: 'user'
        };

        const transformContent = (item) => {
            if (Array.isArray(item.content) && item.content.length === 2 && item.content[1]?.type === 'image_url') {
                const textPart = item.content[0];
                const imagePart = item.content[1];
                const base64Data = imagePart.image_url.url.split(',')[1];
                const mimeType = imagePart.image_url.url.match(/^data:(.*);base64/)[1];
                return [
                    { text: `${textPart.text}ç”¨æˆ·å‘ä½ å‘é€äº†ä¸€å¼ å›¾ç‰‡` },
                    { inline_data: { mime_type: mimeType, data: base64Data } }
                ];
            }
            
            let res = extractArray(item.content);
            if (Array.isArray(res) && res.length > 1) {
                res = `${res[0]}${res[1].content}`;
            }
            return [{ text: String(res) }];
        };

        return messages.map(item => ({
            role: roleType[item.role],
            parts: transformContent(item)
        }));
    }

    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // 1. æ‰€æœ‰å˜é‡å’Œå¸¸é‡å®šä¹‰
        // ===================================================================
const db = new Dexie('GeminiChatDB');
// ... å…¶ä»–å…¨å±€å˜é‡ ...
// ...
let isStickerEditMode = false;
let albumPickerContext = { for: null, returnScreen: null }; // ç”¨äºç›¸å†Œé€‰æ‹©çš„ä¸Šä¸‹æ–‡
let selectedStickers = new Set();
let currentMemoriesViewChatId = null;
let musicState = { 
    isActive: false, 
    activeChatId: null, 
    isPlaying: false, 
    playlist: [], 
    currentIndex: -1, 
    playMode: 'order', 
    totalElapsedTime: 0, 
    timerId: null,
    // ã€æ–°å¢ã€‘æ­Œè¯ç›¸å…³çŠ¶æ€
    parsedLyrics: [],      // å½“å‰æ­Œæ›²è§£æåçš„æ­Œè¯æ•°ç»„
    currentLyricIndex: -1  // å½“å‰é«˜äº®çš„æ­Œè¯è¡Œç´¢å¼•
};
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;

let waimaiTimers = {}; // ç”¨äºå­˜å‚¨å¤–å–å€’è®¡æ—¶

let activeMessageTimestamp = null;
let currentReplyContext = null; // <--- æ–°å¢è¿™è¡Œ,ç”¨æ¥å­˜å‚¨å½“å‰æ­£åœ¨å¼•ç”¨çš„æ¶ˆæ¯ä¿¡æ¯
let activePostId = null; // <-- æ–°å¢:ç”¨äºå­˜å‚¨å½“å‰æ“ä½œçš„åŠ¨æ€ID

        let photoViewerState = {
            isOpen: false,
            photos: [], // å­˜å‚¨å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡URL
            currentIndex: -1, // å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç…§ç‰‡ç´¢å¼•
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()

let simulationIntervalId = null;

        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;

// â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨ï¼Œå˜é‡å®šä¹‰åŒºï¼Œæ·»åŠ è¿™ä¸¤ä¸ªæ–°å˜é‡ â–¼â–¼â–¼
let isQzoneEditMode = false;
let selectedPosts = new Set();
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨,å˜é‡å®šä¹‰åŒº,æ·»åŠ è¿™ä¸ªæ–°å¸¸é‡ â–¼â–¼â–¼
const DEFAULT_APP_ICONS = {
    'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
    'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
};
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ç¡®å®š';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'å¥½çš„';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ç¡®å®š';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘æ›¿æ¢æ—§çš„ showCustomPrompt å‡½æ•° â–¼â–¼â–¼
function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        const inputId = 'custom-prompt-input';
        
        const inputHtml = type === 'textarea' 
            ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†é¢å¤–çš„HTMLå’Œè¾“å…¥æ¡†ç»„åˆåœ¨ä¸€èµ·
        modalBody.innerHTML = extraHtml + inputHtml;
        const input = document.getElementById(inputId);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®ç»‘å®šäº‹ä»¶
        modalBody.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                    try {
                        const templateObj = JSON.parse(templateStr);
                        // ä½¿ç”¨ null, 2 å‚æ•°è®©JSONå­—ç¬¦ä¸²æ ¼å¼åŒ–,å¸¦ç¼©è¿›,æ›´æ˜“è¯»
                        input.value = JSON.stringify(templateObj, null, 2);
                        input.focus();
                    } catch(e) {
                        console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e);
                    }
                }
            });
        });
        
        modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
        modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        showCustomModal();
        setTimeout(() => input.focus(), 100);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 2. æ•°æ®åº“ç»“æ„å®šä¹‰
        // ===================================================================

// â–¼â–¼â–¼ In your <script> tag, find this line and modify it â–¼â–¼â–¼
db.version(27).stores({ // <-- Increment the version number by 1 (e.g., from 23 to 24)
    chats: '&id, isGroup, groupId',
    chats: '&id, isGroup, groupId', 
    apiConfig: '&id', 
    globalSettings: '&id', 
    userStickers: '&id, url, name',
    worldBooks: '&id, name, categoryId',
    worldBookCategories: '++id, name',
    musicLibrary: '&id', 
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp', 
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate' ,
    callRecords: '++id, chatId, timestamp, customName',
    customThemes: '&id, name',
    customBubbleThemes: '&id, name',// <-- ã€å…¨æ–°æ·»åŠ ã€‘è¿™å¼ è¡¨ç”¨æ¥å­˜å‚¨è‡ªå®šä¹‰æ°”æ³¡ä¸»é¢˜
    avatarFrames: '&id, name, url', // <-- ã€å…¨æ–°æ·»åŠ ã€‘è¿™å¼ è¡¨ç”¨æ¥å­˜å‚¨å¤´åƒæ¡†
    calendarEvents: '++id, [chatId+date], createdBy',// <-- ã€å…¨æ–°æ·»åŠ ã€‘è¿™å¼ è¡¨ç”¨æ¥å­˜å‚¨æ—¥å†äº‹ä»¶
    wallpapers: '&id' // <-- ã€å…¨æ–°æ·»åŠ ã€‘è¿™å¼ è¡¨ç”¨æ¥å­˜å‚¨å£çº¸åº“
});
// â–²â–²â–² Modification Ends â–²â–²â–²

        // ===================================================================
        // 3. æ‰€æœ‰åŠŸèƒ½å‡½æ•°å®šä¹‰
        // ===================================================================

        // â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€é›†æˆçŠ¶æ€æ æ§åˆ¶é€»è¾‘ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ showScreen å‡½æ•° â–¼â–¼â–¼
function showScreen(screenId) {
    // 1. åŸæœ‰çš„é¡µé¢åˆ‡æ¢é€»è¾‘ (ä¿æŒä¸å˜)
    if (screenId === 'chat-list-screen') {
        window.renderChatListProxy(); 
        switchToChatListView('messages-view');
    }
    if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
    if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
    if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screenToShow = document.getElementById(screenId);
    if (screenToShow) screenToShow.classList.add('active');
    if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
    if (screenId === 'font-settings-screen') {
        document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
        applyCustomFont(state.globalSettings.fontUrl || true);
    }

    // 2. ã€ã€ã€æ ¸å¿ƒä¿®å¤é€»è¾‘ã€‘ã€‘ã€‘
    // åœ¨åˆ‡æ¢é¡µé¢åï¼Œç«‹å³æ ¹æ®é¡µé¢IDå†³å®šæ˜¯å¦æ˜¾ç¤ºçŠ¶æ€æ 
    const statusBar = document.getElementById('status-bar');
    
    // a. å¦‚æœç›®æ ‡é¡µé¢æ˜¯â€œç›´æ’­é—´â€æˆ–â€œèŠå¤©ç•Œé¢â€ï¼Œåˆ™å¼ºåˆ¶éšè—çŠ¶æ€æ 
    if (screenId === 'live-stream-screen' || screenId === 'chat-interface-screen') {
        statusBar.style.display = 'none';
    } 
    // b. å¯¹äºæ‰€æœ‰å…¶ä»–é¡µé¢
    else {
        // æ¸…é™¤è¡Œå†…æ ·å¼ï¼Œè®©CSSè§„åˆ™ï¼ˆå¦‚â€œè¾¹æ¡†æ¨¡å¼â€ï¼‰æ¥å†³å®šæ˜¯å¦æ˜¾ç¤ºçŠ¶æ€æ 
        statusBar.style.display = ''; 
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
    if (viewId === 'live-stream-screen') {
        handleLiveTabClick(); // è°ƒç”¨æ–°çš„æ€»å…¥å£å‡½æ•°
        return; 
    }

    const chatListScreen = document.getElementById('chat-list-screen');
    // ã€æ ¸å¿ƒä¿®å¤2ã€‘ä» views å¯¹è±¡ä¸­ç§»é™¤ live-stream-screen
    const views = {
        'messages-view': document.getElementById('messages-view'),
        'qzone-screen': document.getElementById('qzone-screen'),
        'favorites-view': document.getElementById('favorites-view'),
        'memories-view': document.getElementById('memories-view')
    };
    const mainHeader = document.getElementById('main-chat-list-header');
    const mainBottomNav = document.getElementById('chat-list-bottom-nav');

    if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click(); 
    }

    Object.values(views).forEach(v => v.classList.remove('active'));
    if (views[viewId]) {
        views[viewId].classList.add('active');
    }

    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewId);
    });
    
    if (viewId === 'messages-view') {
        mainHeader.style.display = 'flex';
        mainBottomNav.style.display = 'flex';
    } else {
        mainHeader.style.display = 'none';
        mainBottomNav.style.display = 'none';
    }

    if (viewId !== 'memories-view') {
        activeCountdownTimers.forEach(timerId => clearInterval(timerId));
        activeCountdownTimers = [];
    }

    switch (viewId) {
        case 'qzone-screen':
    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
    updateUnreadIndicator(0);
    
    // ã€æ–°å¢ã€‘æ¨¡æ‹Ÿè®¿å®¢å¢é•¿
    if (state.qzoneSettings) {
        state.qzoneSettings.visitorCount = (state.qzoneSettings.visitorCount || 0) + 1;
        saveQzoneSettings(); // ä¿å­˜æ–°çš„è®¿å®¢æ•°
    }

    renderQzoneScreen();
    renderQzonePosts();
    break;
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ renderQzoneScreen å‡½æ•° â–¼â–¼â–¼
function renderQzoneScreen() {
    if (state && state.qzoneSettings) {
        const settings = state.qzoneSettings;
        document.getElementById('qzone-nickname').textContent = settings.nickname;
        document.getElementById('qzone-avatar-img').src = settings.avatar;
        document.getElementById('qzone-banner-img').src = settings.banner;
        // ã€æ–°å¢ã€‘æ¸²æŸ“ç­¾åå’Œè®¿å®¢é‡
        document.getElementById('qzone-signature').textContent = settings.signature || 'ç¼–è¾‘ä¸ªç­¾...';
        document.getElementById('qzone-visitor-count-number').textContent = settings.visitorCount || 0;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return 'åˆšåˆš';
            if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹,å¤åˆ¶è¿™æ•´å—ä»£ç  â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘ç”¨æˆ·ç‚¹å‡»â€œçº¿ä¸‹æ¨¡å¼â€æŒ‰é’®
 */
async function handleInitiateOfflineMode() {
    if (!state.activeChatId || offlineModeState.isActive) return;

    const confirmed = await showCustomConfirm(
        'è¿›å…¥çº¿ä¸‹æ¨¡å¼',
        'ä½ ç¡®å®šè¦åˆ‡æ¢åˆ°çº¿ä¸‹æ¨¡å¼å—ï¼Ÿåœ¨è¯¥æ¨¡å¼ä¸‹,ä½ å°†ä»¥æ–‡å­—å½¢å¼æè¿°ä½ çš„è¡ŒåŠ¨å’Œå¯¹è¯,AIä¼šä»¥æ—ç™½å½¢å¼å›åº”ã€‚'
    );

    if (confirmed) {
        startOfflineMode();
    }
}

/**
 * å¼€å§‹çº¿ä¸‹æ¨¡å¼
 */
async function startOfflineMode() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    offlineModeState.isActive = true;
    offlineModeState.activeChatId = chat.id;
    offlineModeState.startTime = Date.now();
    offlineModeState.history = [];

    // æŠ“å–è¿›å…¥å‰çš„èŠå¤©ä¸Šä¸‹æ–‡
    const preOfflineHistory = chat.history.slice(-10);
    offlineModeState.preOfflineContext = preOfflineHistory.map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');

    // æ›´æ–°UI
    document.getElementById('offline-mode-main').innerHTML = '';
    showScreen('offline-mode-screen');

    // å¯åŠ¨è®¡æ—¶å™¨
    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(() => {
        if (!offlineModeState.isActive) {
            clearInterval(callTimerInterval);
            return;
        }
        const elapsed = Math.floor((Date.now() - offlineModeState.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('offline-mode-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);

    // åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—çš„ç³»ç»Ÿæ¶ˆæ¯,å‘ŠçŸ¥AIæ¨¡å¼å·²åˆ‡æ¢
    const systemInstruction = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤:ä½ ä»¬ç°åœ¨è¿›å…¥äº†çº¿ä¸‹æ¨¡å¼ã€‚è¯·ä½ åˆ‡æ¢ä¸ºç¬¬ä¸‰äººç§°æ—ç™½è§†è§’,æè¿°åœºæ™¯å’Œä½ çš„è¡ŒåŠ¨ã€‚]`,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemInstruction);
    await db.chats.put(chat);
    
    // è§¦å‘AIçš„ç¬¬ä¸€æ¡çº¿ä¸‹å‰§æƒ…
    triggerAiInOfflineAction();
}

/**
 * ç»“æŸçº¿ä¸‹æ¨¡å¼
 */
async function endOfflineMode() {
    if (!offlineModeState.isActive) return;

    const chat = state.chats[offlineModeState.activeChatId];
    
    // ã€æ ¸å¿ƒã€‘åˆ›å»ºå¯¹ç”¨æˆ·éšè—çš„â€œçº¿ä¸‹æ¨¡å¼æ€»ç»“â€æŒ‡ä»¤
    const offlineSummaryForAI = offlineModeState.history.map(h => `${h.role === 'user' ? 'æˆ‘' : chat.name}: ${h.content}`).join('\n');
    const hiddenReportInstruction = {
        role: 'system',
        content: `[ç³»ç»ŸæŒ‡ä»¤:çº¿ä¸‹æ¨¡å¼åˆšåˆšç»“æŸã€‚è¿™æ˜¯ä½ ä»¬åœ¨çº¿ä¸‹äº’åŠ¨çš„å®Œæ•´è®°å½•:\n---çº¿ä¸‹è®°å½•å¼€å§‹---\n${offlineSummaryForAI}\n---çº¿ä¸‹è®°å½•ç»“æŸ---\nç°åœ¨ä½ ä»¬å›åˆ°äº†çº¿ä¸ŠèŠå¤©ã€‚è¯·ä½ æ ¹æ®çº¿ä¸‹å‘ç”Ÿçš„äº‹æƒ…,ä¸»åŠ¨ç»™æˆ‘å‘ä¸€æ¡ç§ä¿¡,å¯ä»¥æ˜¯å¯¹çº¿ä¸‹äº‹ä»¶çš„å»¶ç»­ã€æ„Ÿå—çš„åˆ†äº«,æˆ–æ˜¯æå‡ºæ–°çš„è¯é¢˜ã€‚]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenReportInstruction);
    await db.chats.put(chat);

    // é‡ç½®çŠ¶æ€å¹¶è¿”å›èŠå¤©ç•Œé¢
    offlineModeState = { isActive: false, activeChatId: null, startTime: null, history: [], preOfflineContext: "" };
    clearInterval(callTimerInterval);
    callTimerInterval = null;

    openChat(chat.id);
    
    // ã€å…³é”®ã€‘è§¦å‘AI,è®©å®ƒè¯»å–æ€»ç»“æŒ‡ä»¤å¹¶å‘èµ·ç§èŠ
    triggerAiResponse();
}

/**
 * å¤„ç†ç”¨æˆ·åœ¨çº¿ä¸‹æ¨¡å¼ä¸­çš„è¾“å…¥
 */
async function handleUserOfflineInput() {
    if (!offlineModeState.isActive) return;

    const userInput = await showCustomPrompt('ä½ çš„è¡ŒåŠ¨/å¯¹è¯', 'è¯·è¾“å…¥ä½ æƒ³åšçš„æˆ–æƒ³è¯´çš„è¯...');
    
    if (userInput && userInput.trim()) {
        const trimmedInput = userInput.trim();
        
        // æ¸²æŸ“å¹¶ä¿å­˜ç”¨æˆ·çš„è¡ŒåŠ¨
        const userBubble = document.createElement('div');
        userBubble.className = 'offline-narrative-bubble user-narrative';
        userBubble.textContent = trimmedInput;
        document.getElementById('offline-mode-main').appendChild(userBubble);
        offlineModeState.history.push({ role: 'user', content: trimmedInput });
        
        // è§¦å‘AIçš„å›åº”
        triggerAiInOfflineAction();
    }
}

/**
 * è§¦å‘AIåœ¨çº¿ä¸‹æ¨¡å¼ä¸­çš„å™è¿°
 */
async function triggerAiInOfflineAction() {
    if (!offlineModeState.isActive) return;

    const chat = state.chats[offlineModeState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    const feed = document.getElementById('offline-mode-main');

    // æ„å»ºä¸“é—¨ç”¨äºçº¿ä¸‹æ¨¡å¼çš„System Prompt
    const offlinePrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯ä¸€ä¸ªåœºæ™¯æè¿°å¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼” ${chat.name} (${chat.settings.aiPersona}),å¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°TAåœ¨çº¿ä¸‹åœºæ™¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œã€ç¯å¢ƒå’Œè¯­è¨€ã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°,å¦‚â€œä»–â€ã€â€œå¥¹â€ã€æˆ–ç›´æ¥ä½¿ç”¨è§’è‰²åâ€œ${chat.name}â€ã€‚
2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€æ®µæè¿°æ€§çš„æ–‡æœ¬,ä¸èƒ½æ˜¯JSONã€‚
3.  **å‰§æƒ…è¿è´¯**: ä½ å¿…é¡»æ ¹æ®â€œè¿›å…¥çº¿ä¸‹å‰çš„èŠå¤©æ‘˜è¦â€å’Œâ€œçº¿ä¸‹å®æ—¶äº’åŠ¨è®°å½•â€æ¥å‘å±•å‰§æƒ…ã€‚

# å½“å‰æƒ…æ™¯
ä½ æ­£åœ¨å’Œç”¨æˆ·(äººè®¾: ${chat.settings.myPersona})è¿›è¡Œä¸€åœºçº¿ä¸‹çš„ã€é¢å¯¹é¢çš„äº’åŠ¨ã€‚
**è¿›å…¥çº¿ä¸‹å‰çš„èŠå¤©æ‘˜è¦**:
${offlineModeState.preOfflineContext}

ç°åœ¨,è¯·æ ¹æ®ä¸‹é¢çš„ã€çº¿ä¸‹å®æ—¶äº’åŠ¨è®°å½•ã€‘,ç»§ç»­è¿›è¡Œå™è¿°ã€‚
`;
    const messagesForApi = [
        { role: 'system', content: offlinePrompt },
        ...offlineModeState.history.map(h => ({ role: h.role, content: h.content }))
    ];

    // ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡äº’åŠ¨(å†å²è®°å½•ä¸ºç©º),æˆ‘ä»¬éœ€è¦ç»™AIä¸€ä¸ªå¯åŠ¨æŒ‡ä»¤ã€‚
if (messagesForApi.length === 0) {
    messagesForApi.push({
        role: 'user',
        content: 'æˆ‘ä»¬åˆšåˆšè¿›å…¥çº¿ä¸‹æ¨¡å¼,è¯·ä½ å¼€å§‹æè¿°ç°åœ¨çš„åœºæ™¯ã€‚'
    });
}

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, offlinePrompt, messagesForApi, isGemini);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.85 })
        });

        if (!response.ok) throw new Error((await response.json()).error.message);

        const data = await response.json();
        const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

        // æ¸²æŸ“å¹¶ä¿å­˜AIçš„å™è¿°
        const aiBubble = document.createElement('div');
        aiBubble.className = 'offline-narrative-bubble ai-narrative';
        aiBubble.textContent = aiResponse;
        feed.appendChild(aiBubble);
        feed.scrollTop = feed.scrollHeight;
        offlineModeState.history.push({ role: 'assistant', content: aiResponse });

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'offline-narrative-bubble ai-narrative';
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[æ—ç™½å‡ºé”™äº†: ${error.message}]`;
        feed.appendChild(errorBubble);
        feed.scrollTop = feed.scrollHeight;
    }
}
// â–²â–²â–² å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ - æ¢å¤å‘é€æŒ‰é’®HTMLã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ renderQzonePosts å‡½æ•° â–¼â–¼â–¼
async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const userSettings = state.qzoneSettings;
    if (!userSettings) {
        console.warn("renderQzonePostsè¢«è°ƒç”¨ï¼Œä½† qzoneSettings å°šæœªåŠ è½½ï¼Œå·²ä¸­æ­¢æœ¬æ¬¡æ¸²æŸ“ã€‚");
        postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">æ­£åœ¨åŠ è½½åŠ¨æ€...</p>';
        return;
    }

    const [posts, favorites] = await Promise.all([
        db.qzonePosts.orderBy('timestamp').reverse().toArray(),
        db.favorites.where('type').equals('qzone_post').toArray()
    ]);

    const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
    
    postsListEl.innerHTML = '';

    const normalActions = document.getElementById('qzone-normal-actions');
    const editActions = document.getElementById('qzone-edit-actions');

    if (normalActions && editActions) {
        normalActions.style.display = isQzoneEditMode ? 'none' : 'block';
        editActions.style.display = isQzoneEditMode ? 'flex' : 'none';
    }
    
    if (posts.length === 0) {
        postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ,å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡è¯´è¯´å§!</p>';
        return;
    }

    posts.forEach((post, index) => {
        const postContainer = document.createElement('div');
        postContainer.className = 'qzone-post-container';
        postContainer.dataset.postId = post.id;
        if (isQzoneEditMode) { postContainer.classList.add('selection-mode'); }
        if (selectedPosts.has(post.id)) { postContainer.classList.add('selected'); }
        if (index >= 7 && !isQzoneEditMode) { postContainer.classList.add('hidden-post'); }
        
        const postEl = document.createElement('div');
        postEl.className = 'qzone-post-item';
        
        let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 
        if (post.authorId === 'user') { authorAvatar = userSettings.avatar; authorNickname = userSettings.nickname; } 
        else if (state.chats[post.authorId]) { const authorChat = state.chats[post.authorId]; authorAvatar = authorChat.settings.aiAvatar || defaultAvatar; authorNickname = authorChat.name; } 
        else { authorAvatar = defaultAvatar; authorNickname = '{{char}}'; }

        let contentHtml = '';
        const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
        if (post.type === 'shuoshuo') { contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`; } 
        else if (post.type === 'image_post' && post.imageUrl) { contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`; } 
        else if (post.type === 'text_image') { contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`; }
        else if (post.type === 'interactive_html') { contentHtml = `<div class="post-content" style="display: flex; justify-content: center;">${post.content}</div>`; }
        
        const userNickname = state.qzoneSettings.nickname;
        const isLikedByUser = post.likes && post.likes.includes(userNickname);
        const isFavoritedByUser = favoritedPostIds.has(post.id);
        
        let likesHtml = '';
        if (post.likes && post.likes.length > 0) {
            likesHtml = `<div class="post-likes-section"><span>${post.likes.join('ã€ ')} ç­‰${post.likes.length}äºº</span></div>`;
        }

        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
            commentsHtml = '<div class="post-comments-container">';
            post.comments.forEach((comment, index) => {
                let commentLineHtml = '';
                const isUserCommenter = comment.commenterName === state.qzoneSettings.nickname;
                if (comment.replyTo) {
                    commentLineHtml = `<span class="commenter-name">${comment.commenterName}</span><span class="reply-indicator">å›å¤</span><span class="commenter-name">${comment.replyTo}</span>: <span class="comment-text">${comment.text}</span>`;
                } else {
                    commentLineHtml = `<span class="commenter-name">${comment.commenterName}</span>: <span class="comment-text">${comment.text}</span>`;
                }
                const deleteBtnHtml = isUserCommenter ? `<span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>` : '';
                commentsHtml += `<div class="comment-item">${commentLineHtml}${deleteBtnHtml}</div>`;
            });
            commentsHtml += '</div>';
        }

        // ã€ã€ã€æ ¸å¿ƒä¿®å¤åŒºã€‘ã€‘ã€‘
        postEl.innerHTML = `
            <div class="post-header">
                <img src="${authorAvatar}" class="post-avatar">
                <div class="post-info">
                    <span class="post-nickname">${authorNickname}</span>
                </div>
                <div class="post-actions-btn">â€¦</div>
            </div>
            <div class="post-main-content">${contentHtml}</div>
            <div class="post-meta-bar">
                <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                <div class="post-feedback-icons">
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M21.17 12.83l-6.23 6.23a2.79 2.79 0 0 1-3.94 0l-6.23-6.23a5.58 5.58 0 0 1 0-7.9l7.73-7.74a.49.49 0 0 1 .7 0l7.73 7.74a5.58 5.58 0 0 1 0 7.9z"></path></svg></span>
                    <span class="action-icon share"><svg viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg></span>
                </div>
            </div>
            ${likesHtml}
            ${commentsHtml}
            <div class="post-footer">
                <div class="comment-section">
                    <img src="${commentAvatar}" class="comment-avatar">
                    <input type="text" class="comment-input" placeholder="è¯´ç‚¹ä»€ä¹ˆå§...">
                </div>
                <!-- â˜…â˜…â˜… æŠŠå‘é€æŒ‰é’®çš„HTMLç»“æ„åŠ å›æ¥ï¼ â˜…â˜…â˜… -->
                <button class="comment-send-btn">å‘é€</button>
            </div>
        `;
        
        const deleteAction = document.createElement('div');
        deleteAction.className = 'qzone-post-delete-action';
        deleteAction.innerHTML = '<span>åˆ é™¤</span>';
        const selectionOverlay = document.createElement('div');
        selectionOverlay.className = 'selection-overlay';
        postContainer.appendChild(postEl);
        postContainer.appendChild(deleteAction);
        postContainer.appendChild(selectionOverlay);
        postsListEl.appendChild(postContainer);
    });

    if (posts.length > 7 && !isQzoneEditMode) {
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'qzone-load-more-btn';
        loadMoreBtn.textContent = 'æŸ¥çœ‹æ›´æ—©çš„åŠ¨æ€...';
        loadMoreBtn.addEventListener('click', () => {
            document.querySelectorAll('.hidden-post').forEach(p => p.classList.remove('hidden-post'));
            loadMoreBtn.remove();
        });
        postsListEl.appendChild(loadMoreBtn);
    }

    updateDeleteSelectedPostsButton();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
             
// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ä¸ªã€æ›´æ–°åçš„ã€‘å‡½æ•°,å®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ displayFilteredFavorites å‡½æ•° â–¼â–¼â–¼

function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
        const searchTerm = document.getElementById('favorites-search-input').value;
        const message = searchTerm ? 'æœªæ‰¾åˆ°ç›¸å…³æ”¶è—' : 'ä½ çš„æ”¶è—å¤¹æ˜¯ç©ºçš„,<br>å¿«å»åŠ¨æ€æˆ–èŠå¤©ä¸­æ”¶è—å–œæ¬¢çš„å†…å®¹å§!';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const item of items) {
        const card = document.createElement('div');
        card.className = 'favorite-item-card';
        card.dataset.favid = item.id;

        let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

        if (item.type === 'qzone_post') {
            const post = item.content;
            sourceText = 'æ¥è‡ªåŠ¨æ€';
            let authorAvatar = defaultAvatar, authorNickname = 'æœªçŸ¥ç”¨æˆ·';

            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
            }

            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
            
            const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
            if (post.type === 'shuoshuo') {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
            } else if (post.type === 'image_post' && post.imageUrl) {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === 'text_image') {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„ä»£ç å¼€å§‹ â–¼â–¼â–¼
            
            // 1. æ„é€ ç‚¹èµåŒºåŸŸçš„HTML
            let likesHtml = '';
            // æ£€æŸ¥ post å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ likes æ•°ç»„å¹¶ä¸”ä¸ä¸ºç©º
            if (post.likes && post.likes.length > 0) {
                // å¦‚æœå­˜åœ¨,å°±åˆ›å»ºç‚¹èµåŒºåŸŸçš„ div
                likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join('ã€')} è§‰å¾—å¾ˆèµ</span>
                    </div>`;
            }

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ - æ¸…æ´HTMLç»“æ„ã€‘ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ commentsHtml æ„å»ºé€»è¾‘ â–¼â–¼â–¼
        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
            commentsHtml = '<div class="post-comments-container">';
            post.comments.forEach((comment, index) => {
                let commentLineHtml = '';
                const isUserCommenter = comment.commenterName === state.qzoneSettings.nickname;
                
                // ã€ã€ã€æ ¸å¿ƒä¿®å¤ã€‘ã€‘ã€‘
                // æˆ‘ä»¬ä¸å†å°†å†’å·ç›´æ¥å†™åœ¨HTMLé‡Œï¼Œè€Œæ˜¯ç”¨CSSæ¥æ·»åŠ 
                if (comment.replyTo) {
                    commentLineHtml = `
                        <span class="commenter-name">${comment.commenterName}</span>
                        <span class="reply-indicator">å›å¤</span>
                        <span class="commenter-name">${comment.replyTo}</span>
                        <span class="comment-text">: ${comment.text}</span>`; // æŠŠå†’å·ç§»åˆ°è¯„è®ºæ–‡æœ¬çš„å¼€å¤´
                } else {
                    commentLineHtml = `
                        <span class="commenter-name">${comment.commenterName}</span>
                        <span class="comment-text">: ${comment.text}</span>`; // æŠŠå†’å·ç§»åˆ°è¯„è®ºæ–‡æœ¬çš„å¼€å¤´
                }
                
                const deleteBtnHtml = isUserCommenter ? `<span class="comment-delete-btn" data-comment-index="${index}">Ã—</span>` : '';
                commentsHtml += `<div class="comment-item">${commentLineHtml}${deleteBtnHtml}</div>`;
            });
            commentsHtml += '</div>';
        }
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            // 3. å°†ç‚¹èµå’Œè¯„è®ºçš„HTMLç»„åˆåˆ° footerHtml ä¸­
            footerHtml = `${likesHtml}${commentsHtml}`;
            
            // â–²â–²â–² æ–°å¢/ä¿®æ”¹çš„ä»£ç ç»“æŸ â–²â–²â–²

} else if (item.type === 'chat_message') {
    const msg = item.content;
    const chat = state.chats[item.chatId];
    if (!chat) continue; 

    sourceText = `æ¥è‡ªä¸ ${chat.name} çš„èŠå¤©`;
    const isUser = msg.role === 'user';
    let senderName, senderAvatar;

    if (isUser) {
        // ç”¨æˆ·æ¶ˆæ¯çš„é€»è¾‘ä¿æŒä¸å˜
        senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
    } else { // AI/æˆå‘˜æ¶ˆæ¯
         if (chat.isGroup) {
            // â˜…â˜…â˜…â˜…â˜… è¿™å°±æ˜¯å”¯ä¸€çš„ã€æ ¸å¿ƒçš„ä¿®æ”¹! â˜…â˜…â˜…â˜…â˜…
            // æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ originalName å»åŒ¹é…,è€Œä¸æ˜¯æ—§çš„ name
            const member = chat.members.find(m => m.originalName === msg.senderName);
            // â˜…â˜…â˜…â˜…â˜… ä¿®æ”¹ç»“æŸ â˜…â˜…â˜…â˜…â˜…
            
            senderName = msg.senderName;
            // å› ä¸ºç°åœ¨èƒ½æ­£ç¡®æ‰¾åˆ° member å¯¹è±¡äº†,æ‰€ä»¥ä¹Ÿèƒ½æ­£ç¡®è·å–åˆ°ä»–çš„å¤´åƒ
            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
        } else {
            // å•èŠçš„é€»è¾‘ä¿æŒä¸å˜
            senderName = chat.name;
            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
        }
    }

    // åç»­æ‹¼æ¥ headerHtml å’Œ contentHtml çš„é€»è¾‘éƒ½ä¿æŒä¸å˜
    headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
    
    if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }
}
        
        // â–¼â–¼â–¼ ä¿®æ”¹æœ€ç»ˆçš„HTMLæ‹¼æ¥,åŠ å…¥ footerHtml â–¼â–¼â–¼
        card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <-- æŠŠæˆ‘ä»¬æ–°åˆ›å»ºçš„ footerHtml æ”¾åœ¨è¿™é‡Œ
            
        listEl.appendChild(card);
    }
}

// â–²â–²â–² æ›¿æ¢åŒºåŸŸç»“æŸ â–²â–²â–²

        /**
         * ã€é‡æ„åçš„å‡½æ•°ã€‘: è´Ÿè´£å‡†å¤‡æ•°æ®å¹¶è§¦å‘æ¸²æŸ“
         */
        async function renderFavoritesScreen() {
            // 1. ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®å¹¶ç¼“å­˜
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            // 2. æ¸…ç©ºæœç´¢æ¡†å¹¶éšè—æ¸…é™¤æŒ‰é’®
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            // 3. æ˜¾ç¤ºæ‰€æœ‰æ”¶è—é¡¹
            displayFilteredFavorites(allFavoriteItems);
        }

        // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        function resetCreatePostModal() {
            document.getElementById('post-public-text').value = '';
            document.getElementById('post-image-preview').src = '';
            document.getElementById('post-image-description').value = '';
            document.getElementById('post-image-preview-container').classList.remove('visible');
            document.getElementById('post-image-desc-group').style.display = 'none';
            document.getElementById('post-local-image-input').value = '';
            document.getElementById('post-hidden-text').value = '';
            document.getElementById('switch-to-image-mode').click();
        }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²åŒ…å« memoriesã€‘çš„ç‰ˆæœ¬,å®Œæ•´æ›¿æ¢æ—§çš„ exportBackup å‡½æ•° â–¼â–¼â–¼
async function exportBackup() {
    try {
        const backupData = {
            version: 1, 
            timestamp: Date.now()
        };

        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories,
            worldBookCategories // <-- ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°å˜é‡
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
                        db.memories.toArray(),
            db.worldBookCategories.toArray() // <-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ å¯¹æ–°è¡¨çš„è¯»å–
        ]);

        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories,
            worldBookCategories // <-- ã€æ ¸å¿ƒä¿®æ”¹3ã€‘å°†æ–°æ•°æ®æ·»åŠ åˆ°å¤‡ä»½å¯¹è±¡ä¸­
        });
        
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('å¯¼å‡ºæˆåŠŸ', 'å·²æˆåŠŸå¯¼å‡ºæ‰€æœ‰æ•°æ®!');

    } catch (error) {
        console.error("å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å‡ºå¤±è´¥', `å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯: ${error.message}`);
    }
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²åŒ…å« memoriesã€‘çš„ç‰ˆæœ¬,å®Œæ•´æ›¿æ¢æ—§çš„ importBackup å‡½æ•° â–¼â–¼â–¼
async function importBackup(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'ä¸¥é‡è­¦å‘Š!',
        'å¯¼å…¥å¤‡ä»½å°†å®Œå…¨è¦†ç›–æ‚¨å½“å‰çš„æ‰€æœ‰æ•°æ®,åŒ…æ‹¬èŠå¤©ã€åŠ¨æ€ã€è®¾ç½®ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€!æ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
                await table.clear();
            }

            if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
            if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
            if (Array.isArray(data.worldBookCategories)) await db.worldBookCategories.bulkPut(data.worldBookCategories);
            if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
            if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
            if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
            if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
            if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
            if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
            if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
            if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories); // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ–°å¢

            if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
            if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
            if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
            if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
        });

        await showCustomAlert('å¯¼å…¥æˆåŠŸ', 'æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¢å¤!åº”ç”¨å³å°†åˆ·æ–°ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ã€‚');
        
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("å¯¼å…¥æ•°æ®æ—¶å‡ºé”™:", error);
        await showCustomAlert('å¯¼å…¥å¤±è´¥', `æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå: ${error.message}`);
    }
}

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                document.getElementById('font-preview').style.fontFamily = '';
                return;
            }
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }

        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = ''; 
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            document.getElementById('font-url-input').value = '';
            document.getElementById('font-preview').style.fontFamily = '';
            alert('å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚');
        }

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å·²å½»åº•ä¿®å¤çºªå¿µæ—¥ç»§æ‰¿é—®é¢˜ã€‘çš„ä»£ç ,å®Œæ•´æ›¿æ¢æ—§çš„ loadAllDataFromDB å‡½æ•° â–¼â–¼â–¼
async function loadAllDataFromDB() {
    const [
        chatsArr, apiConfig, globalSettings, userStickers, worldBooks,
        musicLib, personaPresets, qzoneSettings, avatarFrames, initialFavorites
    ] = await Promise.all([
        db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'),
        db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'),
        db.personaPresets.toArray(), db.qzoneSettings.get('main'),
        db.avatarFrames.toArray(), db.favorites.orderBy('timestamp').reverse().toArray()
    ]);

    // ã€æ ¸å¿ƒä¿®å¤1ã€‘å¦‚æœå…¨å±€è®¾ç½®é‡Œè¿˜å­˜ç€æ—§çš„ã€å…±äº«çš„çºªå¿µæ—¥æ—¥æœŸ...
    const oldGlobalAnniversaryDate = globalSettings ? globalSettings.anniversaryStartDate : null;

    state.chats = chatsArr.reduce((acc, chat) => {
        if (!chat.history) {
            console.warn(`ä¸ºæ—§èŠå¤© "${chat.name}" åˆå§‹åŒ–äº† history æ•°ç»„ã€‚`);
            chat.history = [];
        }
        // --- ä¸‹é¢æ˜¯ä¸ºæ‰€æœ‰æ—§æ•°æ®è¿›è¡Œå…¼å®¹æ€§è¡¥å…¨çš„ä»£ç  ---
        if (!chat.settings) chat.settings = {};
        if (typeof chat.settings.anniversaryStartDate === 'undefined') {
            chat.settings.anniversaryStartDate = null;
        }

        // ã€æ ¸å¿ƒä¿®å¤2ã€‘...æˆ‘ä»¬å°±æŠŠå®ƒåº”ç”¨ç»™ã€æ¯ä¸€ä¸ªã€‘è¿˜æ²¡æœ‰è®¾ç½®è¿‡çºªå¿µæ—¥çš„AIè§’è‰²
        if (oldGlobalAnniversaryDate && !chat.isGroup && !chat.settings.anniversaryStartDate) {
            chat.settings.anniversaryStartDate = oldGlobalAnniversaryDate;
            console.log(`ä¸ºè§’è‰² "${chat.name}" è¿ç§»äº†æ—§çš„å…¨å±€çºªå¿µæ—¥è®¾ç½®ã€‚`);
            db.chats.put(chat); // åˆ«å¿˜äº†å­˜å›æ•°æ®åº“
        }
        
        // --- åç»­çš„å…¶ä»–å…¼å®¹æ€§ä»£ç ä¿æŒä¸å˜ ---
        if (typeof chat.unreadCount === 'undefined') chat.unreadCount = 0;
        if (chat.isGroup && chat.members && chat.members.length > 0 && chat.members[0].name) {
            chat.members.forEach(member => {
                if (typeof member.originalName === 'undefined') {
                    member.originalName = member.name;
                    member.groupNickname = member.name;
                    delete member.name;
                }
            });
        }
        if (!chat.isGroup && !chat.status) {
            chat.status = { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false };
        }
        if (!chat.isGroup && !chat.relationship) {
            chat.relationship = { status: 'friend', blockedTimestamp: null, applicationReason: '' };
        }
        if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
            if (!chat.settings) chat.settings = {};
            chat.settings.aiAvatarLibrary = [];
        }
        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }
        acc[chat.id] = chat;
        return acc;
    }, {});
    
    // åŠ è½½å…¨å±€è®¾ç½®
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };
    state.globalSettings = globalSettings || { 
        id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', fontUrl: '', 
        enableBackgroundActivity: false, backgroundActivityInterval: 60, blockCooldownHours: 1,
        appIcons: { ...DEFAULT_APP_ICONS }, borderMode: 'borderless', topBarColor: '#fdfdfd', 
    topBarTextColor: '#1f1f1f', bottomBarColor: '#f8f8f8', activeBubbleTheme: 'default',
    globalCustomCss: '' // <-- åœ¨è¿™é‡Œæ·»åŠ 
    };
    
    // ã€æ ¸å¿ƒä¿®å¤3ã€‘åœ¨è¿ç§»å®Œæˆå,ä»å…¨å±€è®¾ç½®ä¸­åˆ é™¤æ‰è¿™ä¸ªæ—§å­—æ®µ,é˜²æ­¢ä¸‹æ¬¡é‡å¤è¿ç§»
    if (state.globalSettings.anniversaryStartDate) {
        delete state.globalSettings.anniversaryStartDate;
        db.globalSettings.put(state.globalSettings);
    }

    // --- åç»­çš„å…¶ä»–åŠ è½½é€»è¾‘ä¿æŒä¸å˜ ---
    state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };
    state.userStickers = userStickers || [];
    state.avatarFrames = avatarFrames || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    // â–¼â–¼â–¼ åœ¨ loadAllDataFromDB å‡½æ•°ä¸­ï¼Œä¿®æ”¹è¿™ä¸€è¡Œ â–¼â–¼â–¼
state.qzoneSettings = qzoneSettings || { 
    id: 'main', 
    nickname: '{{user}}', 
    avatar: 'https://files.catbox.moe/q6z5fc.jpeg', 
    banner: 'https://files.catbox.moe/r5heyt.gif',
    signature: 'ç¼–è¾‘ä¸ªç­¾ï¼Œå±•ç¤ºæˆ‘çš„ä¸ä¼—ä¸åŒã€‚', // <-- æ–°å¢
    visitorCount: 0 // <-- æ–°å¢
};
// â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    allFavoriteItems = initialFavorites || [];
}

        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }

// â–¼â–¼â–¼ ã€åŠ å›ºã€‘ç”¨è¿™ä¸ªç‰ˆæœ¬æ›¿æ¢æ—§çš„ parseAiResponse å‡½æ•° â–¼â–¼â–¼
function parseAiResponse(content) {
    const trimmedContent = content.trim();

    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            if (Array.isArray(parsed)) {
                return parsed.filter(Boolean); // ã€åŠ å›ºã€‘è¿‡æ»¤æ‰æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„ null æˆ– undefined
            }
        } catch (e) {
            console.warn("æ ‡å‡†JSONæ•°ç»„è§£æå¤±è´¥ï¼Œå°†å°è¯•å¼ºåŠ›è§£æ...");
        }
    }

    const jsonMatches = trimmedContent.match(/{[^{}]*}/g);

    if (jsonMatches) {
        const results = [];
        for (const match of jsonMatches) {
            try {
                const parsedObject = JSON.parse(match);
                results.push(parsedObject);
            } catch (e) {
                console.warn("è·³è¿‡ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", match);
            }
        }
        
        if (results.length > 0) {
            return results.filter(Boolean); // ã€åŠ å›ºã€‘åŒæ ·åœ¨è¿™é‡Œè¿›è¡Œè¿‡æ»¤
        }
    }
    
    console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±è´¥ï¼å°†è¿”å›åŸå§‹æ–‡æœ¬ã€‚");
    return [{ type: 'text', content: content }];
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
    // â–¼â–¼â–¼ æ–°å¢è¿™è¡Œ â–¼â–¼â–¼
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
}
        window.renderApiSettingsProxy = renderApiSettings;

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°ç‰ˆæœ¬ã€‘çš„å‡½æ•°,å®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderChatList â–¼â–¼â–¼
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. åƒä»¥å‰ä¸€æ ·,è·å–æ‰€æœ‰èŠå¤©å¹¶æŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´æ’åº
    const allChats = Object.values(state.chats).sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    // 2. è·å–æ‰€æœ‰åˆ†ç»„
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>';
        return;
    }

    // --- ã€æ ¸å¿ƒä¿®æ­£å¼€å§‹ã€‘---

    // 3. ä¸ºæ¯ä¸ªåˆ†ç»„æ‰¾åˆ°å…¶å†…éƒ¨æœ€æ–°çš„æ¶ˆæ¯æ—¶é—´æˆ³
    allGroups.forEach(group => {
        // ä»å·²æ’åºçš„ allChats ä¸­æ‰¾åˆ°æœ¬ç»„çš„ç¬¬ä¸€ä¸ª(ä¹Ÿå°±æ˜¯æœ€æ–°çš„)èŠå¤©
        const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
        // å¦‚æœæ‰¾åˆ°äº†,å°±ç”¨å®ƒçš„æ—¶é—´æˆ³ï¼›å¦‚æœè¯¥åˆ†ç»„æš‚æ—¶æ²¡æœ‰èŠå¤©æˆ–èŠå¤©æ²¡æœ‰å†å²è®°å½•,å°±ç”¨0
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    // 4. æ ¹æ®è¿™ä¸ªæœ€æ–°çš„æ—¶é—´æˆ³æ¥å¯¹â€œåˆ†ç»„æœ¬èº«â€è¿›è¡Œæ’åº
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    // --- ã€æ ¸å¿ƒä¿®æ­£ç»“æŸã€‘---

    // 5. ç°åœ¨,æˆ‘ä»¬æŒ‰ç…§æ’å¥½åºçš„åˆ†ç»„æ¥æ¸²æŸ“
    allGroups.forEach(group => {
        // ä»æ€»åˆ—è¡¨é‡Œè¿‡æ»¤å‡ºå±äºè¿™ä¸ª(å·²æ’åº)åˆ†ç»„çš„å¥½å‹
        const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
        // å¦‚æœè¿™ä¸ªåˆ†ç»„æ˜¯ç©ºçš„(å¯èƒ½æ‰€æœ‰å¥½å‹éƒ½è¢«åˆ äº†),å°±è·³è¿‡
        if (groupChats.length === 0) return;

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">â–¼</span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');
        // å› ä¸º allChats æœ¬èº«å°±æ˜¯æœ‰åºçš„,æ‰€ä»¥ groupChats è‡ªç„¶ä¹Ÿæ˜¯æœ‰åºçš„
        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    // 6. æœ€å,æ¸²æŸ“æ‰€æœ‰ç¾¤èŠå’Œæœªåˆ†ç»„çš„å¥½å‹
    // ä»–ä»¬çš„é¡ºåºå› ä¸º allChats çš„åˆå§‹æ’åº,å¤©ç„¶å°±æ˜¯æ­£ç¡®çš„
    const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
    ungroupedOrGroupChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€Bã€‘ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬,æ›¿æ¢æ—§çš„ showCuteEventViewer å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V3ç‰ˆã€‘æ‰“å¼€å¹¶å¡«å……å¯çˆ±çš„äº‹ä»¶æŸ¥çœ‹å™¨,å¹¶ä¸ºæŒ‰é’®ç»‘å®šäº‹ä»¶
 * @param {object} event - ä»æ•°æ®åº“ä¸­è¯»å–åˆ°çš„äº‹ä»¶å¯¹è±¡
 */
function showCuteEventViewer(event) {
    const modal = document.getElementById('cute-event-viewer-modal');
    if (!modal) return;

    // 1. ç¡®ä¿åœ¨åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼å‰,æ˜¾ç¤ºå…ƒç´ å·²å­˜åœ¨(é˜²æ­¢ç‚¹å‡»â€œå–æ¶ˆâ€æ—¶å´©æºƒ)
    if (!document.getElementById('cute-event-title')) {
        disableCuteViewerEditMode(event);
        return; // è°ƒç”¨ disableCuteViewerEditMode ä¼šé€’å½’è°ƒç”¨ showCuteEventViewer,æ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å›
    }

    // å¡«å……å†…å®¹
    document.getElementById('cute-event-title').textContent = event.title;
    document.getElementById('cute-event-memo').textContent = event.memo || '(æ²¡æœ‰å†™è¯¦ç»†å¤‡å¿˜å“¦~)';
    const authorName = event.createdBy === 'user' ? 'ä½ ' : (state.chats[event.chatId]?.name || 'å¯¹æ–¹');
    const createdTime = new Date(event.timestamp).toLocaleString('zh-CN', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    document.getElementById('cute-event-meta').innerHTML = `ç”± <strong>${authorName}</strong> åœ¨ ${createdTime} è®°ä¸‹`;
    
    // è·å–æŒ‰é’®
    const editBtn = document.getElementById('cute-event-edit-btn');
    const deleteBtn = document.getElementById('cute-event-delete-btn');
    
    // 2. è®¾ç½®æŒ‰é’®çš„æ˜¾ç¤º/éšè—çŠ¶æ€
    const isUserCreated = event.createdBy === 'user';
    editBtn.style.display = isUserCreated ? 'block' : 'none';
    deleteBtn.style.display = isUserCreated ? 'block' : 'none';
    
    // 3. ç§»é™¤æ‰€æœ‰æ—§ç›‘å¬å™¨,å¹¶ç»‘å®šæ–°çš„äº‹ä»¶
    // ä¸ºäº†é˜²æ­¢é‡å¤ç»‘å®š,å…ˆå…‹éš†å¹¶æ›¿æ¢,å†ç»‘å®šæ–°çš„äº‹ä»¶å¤„ç†å™¨
    const newEditBtn = editBtn.cloneNode(true);
    editBtn.parentNode.replaceChild(newEditBtn, editBtn);
    
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

    // 4. ç»‘å®šäº‹ä»¶
    newEditBtn.addEventListener('click', () => {
        // ç‚¹å‡»â€œç¼–è¾‘â€æŒ‰é’®æ—¶,å¯ç”¨ç¼–è¾‘æ¨¡å¼
        enableCuteViewerEditMode(event);
    });
    
    newDeleteBtn.addEventListener('click', async () => {
        // ç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®æ—¶,æ‰§è¡Œåˆ é™¤é€»è¾‘
        const confirmed = await showCustomConfirm('åˆ é™¤å¤‡å¿˜', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å½•å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.calendarEvents.delete(event.id);
            modal.classList.remove('visible');
            await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            alert('å¤‡å¿˜å·²åˆ é™¤ã€‚');
        }
    });

    // 5. æ˜¾ç¤ºå¼¹çª—
    modal.classList.add('visible');
}
// â–²â–²â–² å‡½æ•°æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°†è¿™ã€ä¸€æ•´å—ã€‘æ–°å‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * æ¸²æŸ“å·²ä¿å­˜çš„è‡ªå®šä¹‰æ°”æ³¡ä¸»é¢˜åˆ—è¡¨
 */
async function renderSavedBubbleThemes() {
    const listEl = document.getElementById('saved-bubble-themes-list');
    if (!listEl) return;

    const savedThemes = await db.customBubbleThemes.toArray();
    listEl.innerHTML = '';

    if (savedThemes.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜</p>';
        return;
    }

    savedThemes.forEach(theme => {
        const item = document.createElement('div');
        item.className = 'saved-bubble-theme-item';
        item.innerHTML = `
            <span class="theme-name">${theme.name}</span>
            <div class="theme-actions">
                <button class="apply-btn" data-id="${theme.id}">åº”ç”¨</button>
                <button class="delete-btn" data-id="${theme.id}">åˆ é™¤</button>
            </div>
        `;
        listEl.appendChild(item);
    });
}

/**
 * å°†å½“å‰CSSç¼–è¾‘å™¨çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªæ–°ä¸»é¢˜
 */
async function saveCurrentCssTheme() {
    const customCss = document.getElementById('custom-css-input').value.trim();
    if (!customCss) {
        alert("è‡ªå®šä¹‰CSSå†…å®¹ä¸èƒ½ä¸ºç©º!");
        return;
    }

    const themeName = await showCustomPrompt("ä¿å­˜ä¸»é¢˜", "ä¸ºè¿™ä¸ªæ°”æ³¡ä¸»é¢˜èµ·ä¸ªåå­—å§!");
    if (!themeName || !themeName.trim()) return;

    const newTheme = {
        id: 'bubble_' + Date.now(),
        name: themeName.trim(),
        css: customCss
    };
    
    await db.customBubbleThemes.add(newTheme);
    await renderSavedBubbleThemes(); // åˆ·æ–°åˆ—è¡¨
    alert('æ°”æ³¡ä¸»é¢˜ä¿å­˜æˆåŠŸ!');
}

/**
 * ã€V3ç‰ˆ - å·²å½»åº•ä¿®å¤ã€‘åº”ç”¨ä¸€ä¸ªå·²ä¿å­˜çš„è‡ªå®šä¹‰æ°”æ³¡ä¸»é¢˜
 * @param {string} themeId - è¦åº”ç”¨çš„ä¸»é¢˜ID
 */
async function applyCustomBubbleTheme(themeId) {
    const theme = await db.customBubbleThemes.get(themeId);
    if (!theme) return;

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 1. å°†ä¿å­˜çš„CSSåº”ç”¨åˆ°å†…å­˜ä¸­çš„èŠå¤©è®¾ç½®
    chat.settings.customCss = theme.css;

    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å°†é¢„è®¾ä¸»é¢˜å¼ºåˆ¶è®¾ä¸º'default'ï¼Œä»¥ç¡®ä¿è‡ªå®šä¹‰CSSç”Ÿæ•ˆ
    chat.settings.theme = 'default';
    
    // 3. æ›´æ–°èŠå¤©è®¾ç½®å¼¹çª—å†…çš„CSSè¾“å…¥æ¡†å†…å®¹
    document.getElementById('custom-css-input').value = theme.css;

    // 4. ã€å…³é”®ã€‘ç«‹åˆ»å°†æ–°çš„CSSåº”ç”¨åˆ°å½“å‰çš„èŠå¤©ç•Œé¢ï¼Œå®ç°å®æ—¶é¢„è§ˆ
    applyScopedCss(theme.css, '#chat-messages', 'custom-bubble-style');
    
    // 5. ç»™å‡ºæç¤º
    alert(`æ°”æ³¡ä¸»é¢˜â€œ${theme.name}â€å·²åº”ç”¨ã€‚è¯·è®°å¾—ç‚¹å‡»å³ä¸‹è§’çš„â€œä¿å­˜â€æŒ‰é’®ä»¥æ°¸ä¹…ä¿å­˜æ­¤æ¬¡æ›´æ”¹ã€‚`);
}

/**
 * åˆ é™¤ä¸€ä¸ªå·²ä¿å­˜çš„è‡ªå®šä¹‰æ°”æ³¡ä¸»é¢˜
 * @param {string} themeId - è¦åˆ é™¤çš„ä¸»é¢˜ID
 */
async function deleteCustomBubbleTheme(themeId) {
    const theme = await db.customBubbleThemes.get(themeId);
    if (!theme) return;
    
    const confirmed = await showCustomConfirm('åˆ é™¤ä¸»é¢˜', `ç¡®å®šè¦åˆ é™¤æ°”æ³¡ä¸»é¢˜â€œ${theme.name}â€å—ï¼Ÿ`);
    if (confirmed) {
        await db.customBubbleThemes.delete(themeId);
        await renderSavedBubbleThemes(); // åˆ·æ–°åˆ—è¡¨
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;

    // --- â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡ŒåŠ å…¥å¯¹å…³ç³»çŠ¶æ€çš„åˆ¤æ–­ â–¼â–¼â–¼ ---
    if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[å¥½å‹ç”³è¯·] ${chat.relationship.applicationReason || 'è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹'}</span>`;
    }
    // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ–°å¢ else if â–¼â–¼â–¼
else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
    lastMsgDisplay = `<span style="color: #dc3545;">[ä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘]</span>`;
}
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¼˜å…ˆæ˜¾ç¤ºçŠ¶æ€,è€Œä¸æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯
    if (chat.isGroup) {
        // ç¾¤èŠé€»è¾‘ä¿æŒä¸å˜
        if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ç³»ç»Ÿæ¶ˆæ¯] ${lastMsgObj.content}`; }
        // ... (å…¶ä»–ç¾¤èŠæ¶ˆæ¯ç±»å‹åˆ¤æ–­) ...
        else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½¬è´¦]'; }
        else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; }
        else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[è¯­éŸ³]'; }
        else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; }
        else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[å›¾ç‰‡]`; }
        else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }

        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
            lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
        }

    } else {
        // å•èŠé€»è¾‘:æ˜¾ç¤ºçŠ¶æ€
        // ç¡®ä¿ chat.status å¯¹è±¡å­˜åœ¨
        const statusText = chat.status?.text || 'åœ¨çº¿';
        lastMsgDisplay = `[${statusText}]`;
    }

    const item = document.createElement('div');
    item.className = 'chat-list-item';
    item.dataset.chatId = chat.id;
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
    
    // â–¼â–¼â–¼ã€ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ,æ›¿æ¢æ‰æ—§çš„ item.innerHTML èµ‹å€¼è¯­å¥ã€‘â–¼â–¼â–¼
    let avatarHtml;
    const avatarSrc = chat.isGroup ? (chat.settings.groupAvatar || defaultGroupAvatar) : (chat.settings.aiAvatar || defaultAvatar);
    const aiFrameSrc = !chat.isGroup ? chat.settings.aiAvatarFrame : ''; // åˆ—è¡¨åªæ˜¾ç¤ºAIçš„æ¡†

    if (aiFrameSrc) {
        avatarHtml = `
            <div class="avatar-frame-wrapper">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${aiFrameSrc}" class="avatar-frame-overlay">
            </div>`;
    } else {
        avatarHtml = `
            <div class="avatar-frame-wrapper">
                <img src="${avatarSrc}" class="avatar-img">
            </div>`;
    }

    item.innerHTML = `
        ${avatarHtml}
        <div class="info">
            <div class="name-line">
                <span class="name">${chat.name}</span>
                ${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}
            </div>
            <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
        </div>
        <div class="unread-count-wrapper">
            <span class="unread-count" style="display: none;">0</span>
        </div>
    `;

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ§åˆ¶çº¢ç‚¹æ˜¾ç¤º/éšè—çš„é€»è¾‘
    const unreadCount = chat.unreadCount || 0;
    const unreadEl = item.querySelector('.unread-count');
    if (unreadCount > 0) {
        unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
        // æ³¨æ„è¿™é‡Œæ˜¯ 'inline-flex',ä¸æˆ‘ä»¬çš„CSSå¯¹åº”,ä½¿å…¶å‚ç›´å±…ä¸­
        unreadEl.style.display = 'inline-flex';
    } else {
        unreadEl.style.display = 'none';
    }
    
    const avatarEl = item.querySelector('.avatar');
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {
            e.stopPropagation();
            handleUserPat(chat.id, chat.name);
        });
    }
    
    const infoEl = item.querySelector('.info');
    if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
    }

    addLongPressListener(item, async (e) => {
        const confirmed = await showCustomConfirm('åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
            delete state.chats[chat.id];
            if (state.activeChatId === chat.id) state.activeChatId = null;
            await db.chats.delete(chat.id);
            renderChatList();
        }
    });
    return item;
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å¸¦è¯Šæ–­åŠŸèƒ½çš„å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ—§çš„ renderChatInterface å‡½æ•° â–¼â–¼â–¼
function renderChatInterface(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    exitSelectionMode();
    
    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    
    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
        statusContainer.style.display = 'none';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
        statusContainer.style.display = 'flex';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
        statusTextEl.textContent = chat.status?.text || 'åœ¨çº¿';
        statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }
    
    lockOverlay.style.display = 'none';
    chatInputArea.style.visibility = 'visible';
    lockContent.innerHTML = '';

    if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';
        
        let lockHtml = '';
        switch (chat.relationship.status) {
            case 'blocked_by_user':
                // --- ã€æ ¸å¿ƒä¿®æ”¹:åœ¨è¿™é‡ŒåŠ å…¥è¯Šæ–­é¢æ¿ã€‘ ---
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                lockHtml = `
                    <span class="lock-text">ä½ å·²å°†â€œ${chat.name}â€æ‹‰é»‘ã€‚</span>
                    <button id="unblock-btn" class="lock-action-btn">è§£é™¤æ‹‰é»‘</button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;">ã€å¼€å‘è€…è¯Šæ–­é¢æ¿ã€‘</strong><br>
                        - åå°æ´»åŠ¨æ€»å¼€å…³: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²å¼€å¯</span>' : '<span style="color: red;">å·²å…³é—­</span>'}<br>
                        - ç³»ç»Ÿå¿ƒè·³è®¡æ—¶å™¨: ${isSimulationRunning ? '<span style="color: green;">è¿è¡Œä¸­</span>' : '<span style="color: red;">æœªè¿è¡Œ</span>'}<br>
                        - å½“å‰è§’è‰²çŠ¶æ€: <strong>${chat.relationship.status}</strong><br>
                        - éœ€è¦å†·é™(å°æ—¶): <strong>${cooldownHours}</strong><br>
                        - å†·é™æœŸæ˜¯å¦ç»“æŸ: ${isCooldownOver ? '<span style="color: green;">æ˜¯</span>' : `<span style="color: orange;">å¦ (è¿˜å‰©çº¦ ${timeRemainingMinutes} åˆ†é’Ÿ)</span>`}<br>
                        - è§¦å‘æ¡ä»¶: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">å·²æ»¡è¶³,ç­‰å¾…ä¸‹æ¬¡ç³»ç»Ÿå¿ƒè·³</span>' : '<span style="color: red;">æœªæ»¡è¶³</span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">å¼ºåˆ¶è§¦å‘ä¸€æ¬¡å¥½å‹ç”³è¯·æ£€æµ‹</button>
                `;
                // --- ã€ä¿®æ”¹ç»“æŸã€‘ ---
                break;
            case 'blocked_by_ai':
                lockHtml = `
                    <span class="lock-text">ä½ è¢«å¯¹æ–¹æ‹‰é»‘äº†ã€‚</span>
                    <button id="apply-friend-btn" class="lock-action-btn">é‡æ–°ç”³è¯·åŠ ä¸ºå¥½å‹</button>
                `;
                break;
            
            case 'pending_user_approval':
                lockHtml = `
                    <span class="lock-text">â€œ${chat.name}â€è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹:<br><i>â€œ${chat.relationship.applicationReason}â€</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn">æ¥å—</button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary">æ‹’ç»</button>
                `;
                break;

            // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä¿®å¤å½“ä½ ç”³è¯·å,ä½ çœ‹åˆ°çš„ç•Œé¢
            case 'pending_ai_approval':
                lockHtml = `<span class="lock-text">å¥½å‹ç”³è¯·å·²å‘é€,ç­‰å¾…å¯¹æ–¹é€šè¿‡...</span>`;
                break;
        }
        lockContent.innerHTML = lockHtml;
    }
    messagesContainer.innerHTML = '';
    // ...åç»­ä»£ç ä¿æŒä¸å˜
    const chatScreen = document.getElementById('chat-interface-screen');
    chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';

const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : (isDarkMode ? '#000000' : '#f0f2f5');
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
    initialMessages.forEach(msg => appendMessage(msg, chat, true));
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

        // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸»é¢˜ç³»ç»Ÿæ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

        /**
         * å°†å†…å­˜ä¸­çš„ä¸»é¢˜è®¾ç½®åº”ç”¨åˆ°æ•´ä¸ªUI
         */
        function applyCurrentTheme() {
            const root = document.documentElement;
            const settings = state.globalSettings;
            
            root.style.setProperty('--theme-top-bar-bg', settings.topBarColor || '#fdfdfd');
            root.style.setProperty('--theme-top-bar-text', settings.topBarTextColor || '#1f1f1f');
            root.style.setProperty('--theme-bottom-bar-bg', settings.bottomBarColor || '#f8f8f8');
            applyGlobalWallpaper(); // å£çº¸ä¹Ÿå±äºä¸»é¢˜çš„ä¸€éƒ¨åˆ†
        }

        /**
         * æ¸²æŸ“å·²ä¿å­˜çš„ä¸»é¢˜åˆ—è¡¨
         */
        async function renderSavedThemes() {
            const listEl = document.getElementById('saved-themes-list');
            if (!listEl) return;
            
            const savedThemes = await db.customThemes.toArray();
            listEl.innerHTML = '';

            if (savedThemes.length === 0) {
                listEl.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜</p>';
                return;
            }

            savedThemes.forEach(theme => {
                const item = document.createElement('div');
                item.className = 'saved-theme-item';
                item.innerHTML = `
                    <div class="theme-preview"></div>
                    <span class="theme-name">${theme.name}</span>
                    <span class="theme-delete-btn" data-id="${theme.id}">åˆ é™¤</span>
                `;
                
                const previewEl = item.querySelector('.theme-preview');
                const s = theme.settings;
                previewEl.style.setProperty('background-image', s.wallpaper.startsWith('data:') ? `url(${s.wallpaper})` : s.wallpaper);
                previewEl.style.setProperty('--preview-top-bg', s.topBarColor);
                previewEl.style.setProperty('--preview-bottom-bg', s.bottomBarColor);

                // ä½¿ç”¨CSSå˜é‡æ¥è®¾ç½®ä¼ªå…ƒç´ çš„èƒŒæ™¯è‰²
                const style = document.createElement('style');
                style.innerHTML = `
                    .saved-theme-item[data-theme-id="${theme.id}"] .theme-preview::before { background-color: ${s.topBarColor}; }
                    .saved-theme-item[data-theme-id="${theme.id}"] .theme-preview::after { background-color: ${s.bottomBarColor}; }
                `;
                document.head.appendChild(style);
                item.dataset.themeId = theme.id;

                listEl.appendChild(item);
            });
        }

/**
 * ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘å°†å½“å‰çš„å¤–è§‚è®¾ç½®ä¿å­˜ä¸ºä¸€ä¸ªæ–°ä¸»é¢˜
 */
async function saveCurrentTheme() {
    const themeName = await showCustomPrompt("ä¿å­˜ä¸»é¢˜", "ä¸ºè¿™ä¸ªä¸»é¢˜èµ·ä¸ªåå­—å§!");
    if (!themeName || !themeName.trim()) return;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä»å½“å‰çš„ globalSettings å’Œ UI ä¸­æå–æ‰€æœ‰ä¸ä¸»é¢˜ç›¸å…³çš„è®¾ç½®
    const currentSettings = {
        topBarColor: state.globalSettings.topBarColor,
        topBarTextColor: state.globalSettings.topBarTextColor,
        bottomBarColor: state.globalSettings.bottomBarColor,
        wallpaper: state.globalSettings.wallpaper,
        appIcons: { ...state.globalSettings.appIcons },
        globalCustomCss: document.getElementById('global-custom-css-input').value, // <-- ä»æ–°æ–‡æœ¬æ¡†è¯»å–
        // æ³¨æ„ï¼šæˆ‘ä»¬ä¸å†ä¿å­˜æ°”æ³¡ä¸»é¢˜ï¼Œå› ä¸ºå®ƒç°åœ¨å±äºèŠå¤©è®¾ç½®ï¼Œè€Œéå…¨å±€ä¸»é¢˜
    };

    const newTheme = {
        id: 'theme_' + Date.now(),
        name: themeName.trim(),
        settings: currentSettings
    };
    
    await db.customThemes.add(newTheme);
    await renderSavedThemes(); // åˆ·æ–°åˆ—è¡¨
    alert('ä¸»é¢˜ä¿å­˜æˆåŠŸ!');
}

// â–¼â–¼â–¼ ã€å…¨æ–°é‡æ„ç‰ˆã€‘æ¸²æŸ“æ•´ä¸ªå¤–è§‚è®¾ç½®é¡µé¢ â–¼â–¼â–¼
function renderWallpaperScreen() { 
    const settings = state.globalSettings;
    
    // 1. åˆå§‹åŒ–å…¨å±€CSSæ–‡æœ¬æ¡† (ä¿æŒä¸å˜)
    document.getElementById('global-custom-css-input').value = settings.globalCustomCss || '';
    
    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘ç§»é™¤æ‰€æœ‰å¯¹æ—§é¢„è§ˆæ¡†çš„æ“ä½œ
    // const preview = document.getElementById('wallpaper-preview'); 
    // const bg = newWallpaperBase64 || settings.wallpaper; 
    // if (bg && bg.startsWith('data:image')) { 
    //     preview.style.backgroundImage = `url(${bg})`; 
    //     preview.textContent = ''; 
    // } else if(bg) { 
    //     preview.style.backgroundImage = bg; 
    //     preview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²'; 
    // }

    // 3. åˆå§‹åŒ–å›¾æ ‡å’Œå¼€å…³ (é€»è¾‘ä¸å˜)
    renderIconSettings();
    document.getElementById('border-toggle-switch').checked = (settings.borderMode === 'bordered');
    // ã€ä¿®æ­£ã€‘ç¡®ä¿å¤œé—´æ¨¡å¼å¼€å…³çŠ¶æ€æ­£ç¡®åŒæ­¥
    document.getElementById('theme-toggle-switch').checked = document.getElementById('phone-screen').classList.contains('dark-mode');
    
    // 4. æ¸²æŸ“å·²ä¿å­˜çš„ä¸»é¢˜åˆ—è¡¨ (é€»è¾‘ä¸å˜)
    renderSavedThemes();
}
// â–²â–²â–² é‡æ„ç»“æŸ â–²â–²â–²

    // ã€å…¨æ–°ã€‘åŒæ­¥è¾¹æ¡†å¼€å…³çš„çŠ¶æ€
    document.getElementById('border-toggle-switch').checked = (state.globalSettings.borderMode === 'bordered');

        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

async function renderWorldBookScreen() {
    const listEl = document.getElementById('world-book-list');
    listEl.innerHTML = '';

    // 1. åŒæ—¶è·å–æ‰€æœ‰ä¹¦ç±å’Œæ‰€æœ‰åˆ†ç±»
    const [books, categories] = await Promise.all([
        db.worldBooks.toArray(),
        db.worldBookCategories.orderBy('name').toArray()
    ]);

    state.worldBooks = books; // ç¡®ä¿å†…å­˜ä¸­çš„æ•°æ®æ˜¯åŒæ­¥çš„

    if (books.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>';
        return;
    }

    // 2. å°†ä¹¦ç±æŒ‰ categoryId åˆ†ç»„
    const groupedBooks = books.reduce((acc, book) => {
        const key = book.categoryId || 'uncategorized';
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(book);
        return acc;
    }, {});

    // 3. ä¼˜å…ˆæ¸²æŸ“å·²åˆ†ç±»çš„ä¹¦ç±
    categories.forEach(category => {
        const booksInCategory = groupedBooks[category.id];
        if (booksInCategory && booksInCategory.length > 0) {
            const groupContainer = createWorldBookGroup(category.name, booksInCategory);
            listEl.appendChild(groupContainer);
        }
    });

    // 4. æœ€åæ¸²æŸ“æœªåˆ†ç±»çš„ä¹¦ç±
    const uncategorizedBooks = groupedBooks['uncategorized'];
    if (uncategorizedBooks && uncategorizedBooks.length > 0) {
        const groupContainer = createWorldBookGroup('æœªåˆ†ç±»', uncategorizedBooks);
        listEl.appendChild(groupContainer);
    }
    
    // 5. ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ æŠ˜å äº‹ä»¶
    document.querySelectorAll('.world-book-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘åˆ›å»ºä¸€ä¸ªåˆ†ç±»çš„åˆ†ç»„DOM
 * @param {string} groupName - åˆ†ç±»åç§°
 * @param {Array} books - è¯¥åˆ†ç±»ä¸‹çš„ä¹¦ç±æ•°ç»„
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„åˆ†ç»„å®¹å™¨
 */
function createWorldBookGroup(groupName, books) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'world-book-group-container';
    
    groupContainer.innerHTML = `
        <div class="world-book-group-header">
            <span class="arrow">â–¼</span>
            <span class="group-name">${groupName}</span>
        </div>
        <div class="world-book-group-content"></div>
    `;

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
    const headerEl = groupContainer.querySelector('.world-book-group-header');
    const contentEl = groupContainer.querySelector('.world-book-group-content');
    
    // é»˜è®¤ç»™å¤´éƒ¨å’Œå†…å®¹åŒºéƒ½åŠ ä¸Š collapsed ç±»
    headerEl.classList.add('collapsed');
    contentEl.classList.add('collapsed');
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));
    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.dataset.bookId = book.id;
        item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'æš‚æ— å†…å®¹...').substring(0, 50)}</div>`;
        item.addEventListener('click', () => openWorldBookEditor(book.id));
        addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤ã€Š${book.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } });
        contentEl.appendChild(item); 
    });

    return groupContainer;
}
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

async function openWorldBookEditor(bookId) {
    editingWorldBookId = bookId;
    const [book, categories] = await Promise.all([
        db.worldBooks.get(bookId),
        db.worldBookCategories.toArray()
    ]);
    if (!book) return;

    document.getElementById('world-book-editor-title').textContent = book.name;
    document.getElementById('world-book-name-input').value = book.name;
    document.getElementById('world-book-content-input').value = book.content;

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¡«å……åˆ†ç±»ä¸‹æ‹‰èœå•
    const selectEl = document.getElementById('world-book-category-select');
    selectEl.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>'; // é»˜è®¤é€‰é¡¹
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        if (book.categoryId === cat.id) {
            option.selected = true; // é€‰ä¸­å½“å‰åˆ†ç±»
        }
        selectEl.appendChild(option);
    });

    showScreen('world-book-editor-screen');
}

function renderStickerPanel() {
    const grid = document.getElementById('sticker-grid');
    grid.innerHTML = '';

    // åˆ‡æ¢é¡¶éƒ¨æ“ä½œæŒ‰é’®çš„æ˜¾ç¤º/éšè—
    document.getElementById('sticker-panel-normal-actions').style.display = isStickerEditMode ? 'none' : 'flex';
    document.getElementById('sticker-panel-edit-actions').style.display = isStickerEditMode ? 'flex' : 'none';

    if (state.userStickers.length === 0) {
        grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">å¤§äººè¯·ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€æˆ–â€œä¸Šä¼ â€æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè¡¨æƒ…å§!</p>';
        return;
    }

    state.userStickers.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.style.backgroundImage = `url(${sticker.url})`;
        item.title = sticker.name;

        if (isStickerEditMode) {
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼
            item.classList.add('in-selection-mode');
            if (selectedStickers.has(sticker.id)) {
                item.classList.add('selected');
            }
            // ä¸ºè¡¨æƒ…æœ¬èº«ç»‘å®šâ€œé€‰æ‹©/å–æ¶ˆé€‰æ‹©â€çš„ç‚¹å‡»äº‹ä»¶
            item.addEventListener('click', () => {
                toggleStickerSelection(sticker.id, item);
            });
        } else {
            // å¦‚æœæ˜¯æ­£å¸¸æ¨¡å¼
            item.addEventListener('click', () => sendSticker(sticker));
            addLongPressListener(item, () => {
                if (isStickerEditMode) return;
                const existingDeleteBtn = item.querySelector('.delete-btn');
                if (existingDeleteBtn) return;
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤è¡¨æƒ… "${sticker.name}" å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        await db.userStickers.delete(sticker.id);
                        state.userStickers = state.userStickers.filter(s => s.id !== sticker.id);
                        renderStickerPanel();
                    }
                };
                item.appendChild(deleteBtn);
                deleteBtn.style.display = 'block';
                setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000);
            });
        }
        grid.appendChild(item);
    });
}

/**
 * è¿›å…¥è¡¨æƒ…ç¼–è¾‘æ¨¡å¼
 */
function enterStickerEditMode() {
    isStickerEditMode = true;
    renderStickerPanel();
}

/**
 * åˆ‡æ¢å•ä¸ªè¡¨æƒ…çš„é€‰ä¸­çŠ¶æ€
 * @param {string} stickerId - è¢«ç‚¹å‡»çš„è¡¨æƒ…ID
 * @param {HTMLElement} element - è¢«ç‚¹å‡»çš„è¡¨æƒ…DOMå…ƒç´ 
 */
function toggleStickerSelection(stickerId, element) {
    if (selectedStickers.has(stickerId)) {
        selectedStickers.delete(stickerId);
        element.classList.remove('selected');
    } else {
        selectedStickers.add(stickerId);
        element.classList.add('selected');
    }
    // å®æ—¶æ›´æ–°åˆ é™¤æŒ‰é’®ä¸Šçš„è®¡æ•°
    document.getElementById('delete-selected-stickers-btn').textContent = `åˆ é™¤ (${selectedStickers.size})`;

    // ã€æ–°å¢ã€‘æ ¹æ®å½“å‰é€‰æ‹©æƒ…å†µ,æ›´æ–°â€œå…¨é€‰â€æŒ‰é’®çš„æ–‡å­—
    const allStickerIds = state.userStickers.map(s => s.id);
    const areAllSelected = allStickerIds.length > 0 && allStickerIds.every(id => selectedStickers.has(id));
    document.getElementById('select-all-stickers-btn').textContent = areAllSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰';
}

/**
 * é€€å‡ºè¡¨æƒ…ç¼–è¾‘æ¨¡å¼
 */
function exitStickerEditMode() {
    isStickerEditMode = false;
    selectedStickers.clear();
    document.getElementById('delete-selected-stickers-btn').textContent = `åˆ é™¤`;
    // ã€æ–°å¢ã€‘é€€å‡ºæ—¶é‡ç½®â€œå…¨é€‰â€æŒ‰é’®çš„æ–‡å­—
    document.getElementById('select-all-stickers-btn').textContent = `å…¨é€‰`;
    renderStickerPanel();
}

/**
 * å…¨é€‰æˆ–å–æ¶ˆå…¨é€‰æ‰€æœ‰è¡¨æƒ…
 */
function selectAllStickers() {
    const allStickerIds = state.userStickers.map(s => s.id);
    if (allStickerIds.length === 0) return; // å¦‚æœæ²¡æœ‰è¡¨æƒ…,åˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ

    const areAllSelected = allStickerIds.every(id => selectedStickers.has(id));
    const selectAllBtn = document.getElementById('select-all-stickers-btn');

    if (areAllSelected) {
        // å¦‚æœå·²ç»å…¨é€‰äº†,åˆ™å–æ¶ˆå…¨é€‰
        selectedStickers.clear();
        selectAllBtn.textContent = 'å…¨é€‰';
    } else {
        // å¦åˆ™,æ‰§è¡Œå…¨é€‰
        allStickerIds.forEach(id => selectedStickers.add(id));
        selectAllBtn.textContent = 'å–æ¶ˆå…¨é€‰';
    }

    // é‡æ–°æ¸²æŸ“é¢æ¿ä»¥æ›´æ–°è§†è§‰ä¸Šçš„é€‰ä¸­çŠ¶æ€
    renderStickerPanel();
    
    // æ‰‹åŠ¨æ›´æ–°åˆ é™¤æŒ‰é’®çš„è®¡æ•°
    document.getElementById('delete-selected-stickers-btn').textContent = `åˆ é™¤ (${selectedStickers.size})`;
}

/**
 * åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„è¡¨æƒ…
 */
async function deleteSelectedStickers() {
    if (selectedStickers.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…ã€‚');
        return;
    }

    const confirmed = await showCustomConfirm(
        'åˆ é™¤è¡¨æƒ…',
        `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = Array.from(selectedStickers);
        await db.userStickers.bulkDelete(idsToDelete);
        state.userStickers = state.userStickers.filter(s => !selectedStickers.has(s.id));
        exitStickerEditMode(); // é€€å‡ºç¼–è¾‘æ¨¡å¼,è¿™ä¼šè‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
    }
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ createMessageElement å‡½æ•° â–¼â–¼â–¼
function createMessageElement(msg, chat) {

    // â–¼â–¼â–¼ åœ¨å‡½æ•°æœ€å¼€å¤´,æ·»åŠ è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
if (msg.type === 'recalled_message') {
    const wrapper = document.createElement('div');
    // 1. ã€æ ¸å¿ƒã€‘ç»™ wrapper ä¹ŸåŠ ä¸Š timestamp,æ–¹ä¾¿äº‹ä»¶å§”æ‰˜æ—¶æŸ¥æ‰¾
    wrapper.className = 'message-wrapper system-pat';
    wrapper.dataset.timestamp = msg.timestamp; 

    const bubble = document.createElement('div');
    // 2. ã€æ ¸å¿ƒã€‘è®©è¿™ä¸ªå…ƒç´ åŒæ—¶æ‹¥æœ‰ .message-bubble å’Œ .recalled-message-placeholder ä¸¤ä¸ªclass
    //    è¿™æ ·å®ƒæ—¢èƒ½è¢«é€‰æ‹©ç³»ç»Ÿè¯†åˆ«,åˆèƒ½ä¿æŒåŸæœ‰çš„å±…ä¸­ç°è‰²æ ·å¼
    bubble.className = 'message-bubble recalled-message-placeholder';
    // 3. ã€æ ¸å¿ƒã€‘æŠŠ timestamp æ”¾åœ¨ bubble ä¸Š,è¿™æ˜¯å¤šé€‰é€»è¾‘çš„å…³é”®
    bubble.dataset.timestamp = msg.timestamp; 
    bubble.textContent = msg.content;
    
    wrapper.appendChild(bubble);
    
    // 4. ã€æ ¸å¿ƒã€‘ä¸ºå®ƒè¡¥ä¸Šå’Œå…¶ä»–æ¶ˆæ¯ä¸€æ ·çš„æ ‡å‡†äº‹ä»¶ç›‘å¬å™¨
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(msg.timestamp);
        }
    });

    // 5. ã€é‡è¦ã€‘åœ¨ä¹‹å‰çš„â€œç‚¹å‡»æŸ¥çœ‹åŸæ–‡â€çš„é€»è¾‘ä¸­,æˆ‘ä»¬å·²ç»ä½¿ç”¨äº†äº‹ä»¶å§”æ‰˜,æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å•ç‹¬ä¸ºè¿™ä¸ªå…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶äº†ã€‚
    //    init() å‡½æ•°ä¸­çš„é‚£ä¸ªäº‹ä»¶ç›‘å¬å™¨ä¼šå¤„ç†å®ƒã€‚
    
    return wrapper;
}
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    if (msg.isHidden) {
        return null;
    }

 // ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ¸¸æˆäº‹ä»¶çš„å¤„ç†é€»è¾‘æå‰å¹¶åŠ å›º
    if (msg.type && (msg.type.endsWith('_start') || msg.type === 'dice_roll')) {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble game-event-message'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content; // æ— è®ºæ•°æ®æ˜¯å¦å®Œæ•´,éƒ½å®‰å…¨åœ°æ˜¾ç¤ºæ–‡æœ¬
        wrapper.appendChild(bubble);

        // ã€å®‰å…¨æ£€æŸ¥ã€‘åªæœ‰åœ¨æ•°æ®å®Œæ•´(msg.resultå­˜åœ¨)ä¸”è½®åˆ°ç”¨æˆ·è¡ŒåŠ¨æ—¶,æ‰æ·»åŠ æŒ‰é’®
        if (msg.result && typeof msg.result.user !== 'undefined' && msg.nextTurn === 'user') {
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'game-actions-container';
            
            if (msg.type === 'truth_or_dare_start') {
                actionsContainer.innerHTML = `
                    <button class="game-action-btn" data-action="truth" data-timestamp="${msg.timestamp}">çœŸå¿ƒè¯</button>
                    <button class="game-action-btn secondary" data-action="dare" data-timestamp="${msg.timestamp}">å¤§å†’é™©</button>
                `;
            } else if (msg.type === 'erotic_cards_start') {
                 actionsContainer.innerHTML = `
                    <button class="game-action-btn" data-action="erotic_card" data-timestamp="${msg.timestamp}">æŠ½ä¸€å¼ ç‰Œ</button>
                `;
            }
            
            wrapper.appendChild(actionsContainer);
        }
        // å¯¹äºæ¸¸æˆè¿™ç±»ç‰¹æ®Šçš„ç³»ç»Ÿæ¶ˆæ¯,åœ¨è¿™é‡Œç›´æ¥è¿”å›,ä¸èµ°ä¸‹é¢çš„å¸¸è§„æ°”æ³¡æ¸²æŸ“æµç¨‹
        return wrapper;
    }

    if (msg.type === 'pat_message') {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble system-bubble'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content;
        wrapper.appendChild(bubble);
        addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        return wrapper;
    }

    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    // è¿™æ®µé€»è¾‘ç°åœ¨ç”¨äºæŸ¥æ‰¾æˆå‘˜å¯¹è±¡,å¹¶æ˜¾ç¤ºå…¶â€œç¾¤æ˜µç§°â€
    if (chat.isGroup && !isUser) {
        // 1. ä½¿ç”¨AIè¿”å›çš„â€œæœ¬åâ€(`msg.senderName`)å»åˆ—è¡¨é‡ŒæŸ¥æ‰¾æˆå‘˜å¯¹è±¡
        const member = chat.members.find(m => m.originalName === msg.senderName);
        
        // 2. åˆ›å»ºç”¨äºæ˜¾ç¤ºåå­—çš„ div
        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = 'sender-name';
        
        // 3. å¦‚æœæ‰¾åˆ°äº†æˆå‘˜,å°±æ˜¾ç¤ºä»–çš„â€œç¾¤æ˜µç§°â€ï¼›å¦‚æœæ‰¾ä¸åˆ°,å°±æ˜¾ç¤ºAIè¿”å›çš„â€œæœ¬åâ€ä½œä¸ºå¤‡ç”¨
        senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'æœªçŸ¥æˆå‘˜');
        
        wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    // â–¼â–¼â–¼ã€ç”¨ä¸‹é¢è¿™æ•´å—ä»£ç ,æ›¿æ¢æ‰æ—§çš„ avatarSrc å’Œ avatarHtml ç”Ÿæˆé€»è¾‘ã€‘â–¼â–¼â–¼
    let avatarHtml;
    let avatarSrc, frameSrc;

    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            frameSrc = chat.settings.myAvatarFrame;
        } else {
            const member = chat.members.find(m => m.originalName === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            // ç¾¤èŠä¸­AIæˆå‘˜æš‚ä¸æ”¯æŒç‹¬ç«‹å¤´åƒæ¡†,å¯åç»­æ‰©å±•
            frameSrc = ''; 
        }
    } else { // å•èŠ
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
            frameSrc = chat.settings.myAvatarFrame;
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            frameSrc = chat.settings.aiAvatarFrame;
        }
    }

    // æ ¹æ®æ˜¯å¦æœ‰å¤´åƒæ¡†,æ„å»ºä¸åŒçš„HTML
    if (frameSrc) {
        avatarHtml = `
            <div class="avatar-frame-wrapper">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${frameSrc}" class="avatar-frame-overlay">
            </div>`;
    } else {
        // å¦‚æœæ²¡æœ‰æ¡†,å°±ä½¿ç”¨æ—§çš„ç®€å•<img>ç»“æ„,ä½†ç”¨wrapperåŒ…èµ·æ¥ä»¥ç»Ÿä¸€å°ºå¯¸
        avatarHtml = `
            <div class="avatar-frame-wrapper">
                <img src="${avatarSrc}" class="avatar-img">
            </div>`;
    }
    // â–²â–²â–²ã€æ›¿æ¢ç»“æŸã€‘â–²â–²â–²

    let contentHtml;

 // ç°åœ¨,æ‰€æœ‰çš„ else if éƒ½å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ bubble å˜é‡äº†
    if (msg.type && msg.type.endsWith('_start') || msg.type === 'dice_roll') {
        bubble.classList.add('is-game-card');
        
        const isGameStart = msg.type.endsWith('_start');
        const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
        let gameTitle = '';
        let cardClass = '';

        if (msg.type === 'truth_or_dare_start') {
            gameTitle = 'çœŸå¿ƒè¯å¤§å†’é™©';
            cardClass = 'game-start-card';
        } else if (msg.type === 'erotic_cards_start') {
            gameTitle = 'æƒ…ä¾£ç‰Œ';
            cardClass = 'game-start-card';
        } else {
            gameTitle = 'æ‘‡ä¸ªéª°å­';
            cardClass = 'dice-roll-card';
        }

        let diceDotsHtml = '';
        for (let i = 1; i <= msg.result.user; i++) {
            diceDotsHtml += `<div class="dice-dot dot-${i}"></div>`;
        }
        let aiDiceDotsHtml = '';
        for (let i = 1; i <= msg.result.ai; i++) {
            aiDiceDotsHtml += `<div class="dice-dot dot-${i}"></div>`;
        }

        contentHtml = `
            <div class="game-card-wrapper ${cardClass}">
                <div class="game-title">${gameTitle}</div>
                <div class="dice-display">
                    <div class="dice-container">
                        <div class="label">${myNickname}</div>
                        <div class="dice" data-value="${msg.result.user}">${diceDotsHtml}</div>
                    </div>
                    <div class="dice-container">
                        <div class="label">${chat.name}</div>
                        <div class="dice" data-value="${msg.result.ai}">${aiDiceDotsHtml}</div>
                    </div>
                </div>
                <div class="dice-result-area">
                    <div>ä½ æ·å‡ºäº† ${msg.result.user}ç‚¹, ${chat.name} æ·å‡ºäº† ${msg.result.ai}ç‚¹</div>
                    <div class="outcome">${msg.outcome}</div>
                </div>
            </div>
        `;
    }
    
    if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°† onclick="openBrowser(...)" ç§»é™¤,æˆ‘ä»¬å°†åœ¨JSä¸­åŠ¨æ€ç»‘å®šäº‹ä»¶
        contentHtml = `
            <div class="link-share-card" data-timestamp="${msg.timestamp}">
                <div class="title">${msg.title || 'æ— æ ‡é¢˜'}</div>
                <div class="description">${msg.description || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…...'}</div>
                <div class="footer">
                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>${msg.source_name || 'é“¾æ¥åˆ†äº«'}</span>
                </div>
            </div>
        `;
    }

// â–¼â–¼â–¼ è¯·å°†è¿™å—ã€å…¨æ–°çš„ else if ä»£ç ã€‘ç²˜è´´åˆ°è¿™é‡Œ â–¼â–¼â–¼
else if (msg.type === 'interactive_html') {
    // 1. è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å®¹å™¨,ä¸åº”ç”¨æ°”æ³¡çš„é»˜è®¤æ ·å¼
    bubble.classList.add('is-sticker'); // å¤ç”¨è¡¨æƒ…åŒ…çš„æ ·å¼,ä½¿å…¶èƒŒæ™¯é€æ˜ã€æ— è¾¹æ¡†

    // 2. åˆ›å»ºä¸€ä¸ªå±…ä¸­å¯¹é½çš„åŒ…è£¹å±‚
    const centeringWrapper = document.createElement('div');
    centeringWrapper.style.display = 'flex';
    centeringWrapper.style.justifyContent = 'center';
    centeringWrapper.style.width = '100%';

    // 3. å°†AIç”Ÿæˆçš„HTMLå†…å®¹ç›´æ¥æ”¾å…¥è¿™ä¸ªåŒ…è£¹å±‚
    centeringWrapper.innerHTML = msg.content;
    
    // 4. å°†æ•´ä¸ªåŒ…è£¹å±‚ä½œä¸ºæ°”æ³¡çš„å†…å®¹
    contentHtml = centeringWrapper.outerHTML;
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ·»åŠ å¯¹ç›´æ’­å¼€å§‹å¡ç‰‡çš„æ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼
else if (msg.type === 'live_stream_start') {
    bubble.classList.add('is-sticker'); // å¤ç”¨æ— èƒŒæ™¯æ ·å¼
    contentHtml = `
        <div style="width: 220px; background: linear-gradient(135deg, #ff7e5f, #feb47b); color: white; padding: 15px; border-radius: 12px; text-align: center;">
            <p style="font-weight: 600; margin: 0 0 8px 0;">ğŸ”´ ç›´æ’­å·²å¼€å§‹</p>
            <p style="font-size: 14px; margin: 0;">ä¸»é¢˜: ${msg.liveData.theme}</p>
        </div>
    `;
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ 'gift_card' case â–¼â–¼â–¼
else if (msg.type === 'gift_card') {
    bubble.classList.add('is-gift-card');
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    const aiName = chat.name;

    let footerText = '';
    let cardClass = '';

    if (msg.status === 'pending') {
        if (msg.action === 'give' && msg.senderName === myNickname) {
            footerText = `å·²èµ é€ç»™ ${aiName}ï¼Œå¾…å›åº”ing...`;
        } else if (msg.action === 'request' && msg.senderName === myNickname) {
            footerText = `å·²å‘ ${aiName} å‘å‡ºè¯·æ±‚...`;
        } else {
            footerText = msg.action === 'give' ? `æ¥è‡ª ${msg.senderName} çš„ç¤¼ç‰©` : `æ¥è‡ª ${msg.senderName} çš„æ”¯ä»˜è¯·æ±‚`;
        }
    } else if (msg.status === 'accepted') {
        footerText = `âœ… å·²æ¥å—`;
        cardClass = 'accepted';
    } else if (msg.status === 'declined') {
        footerText = `âŒ å·²æ‹’ç»`;
        cardClass = 'declined';
    }

    // ã€ã€ã€æ ¸å¿ƒä¿®å¤å°±åœ¨ä¸‹é¢è¿™ä¸€è¡Œã€‘ã€‘ã€‘
    contentHtml = `
        <div class="gift-card ${cardClass}">
            <div class="gift-card-header">
                <img src="${msg.item.imageUrl}" alt="${msg.item.name}">
                <div class="details">
                    <p class="name">${msg.item.name}</p>
                    <p class="price">Â¥${Number(msg.item.price).toFixed(2)}</p>
                </div>
            </div>
            <div class="gift-card-footer">${footerText}</div>
        </div>
    `;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

else if (msg.type === 'share_card') {
    bubble.classList.add('is-link-share'); // å¤ç”¨é“¾æ¥åˆ†äº«çš„å¡ç‰‡æ ·å¼
    // ã€æ ¸å¿ƒã€‘æŠŠæ—¶é—´æˆ³åŠ åˆ°å¡ç‰‡ä¸Š,æ–¹ä¾¿åé¢ç‚¹å‡»æ—¶è¯†åˆ«
    contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}">
            <div class="title">${msg.payload.title}</div>
            <div class="description">å…± ${msg.payload.sharedHistory.length} æ¡æ¶ˆæ¯</div>
            <div class="footer">
                <svg class="footer-icon" ...>...</svg> <!-- å¤ç”¨é“¾æ¥åˆ†äº«çš„å›¾æ ‡ -->
                <span>èŠå¤©è®°å½•</span>
            </div>
        </div>
    `;
}

    // åç»­çš„å…¶ä»– else if ä¿æŒä¸å˜
// â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ ai_image å’Œ user_photo æ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼
    else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
        // 1. é»˜è®¤ä½¿ç”¨ç¼©ç•¥å›¾URLã€‚å¦‚æœæ˜¯ç”¨æˆ·å‘çš„å›¾ï¼ˆuser_photoï¼‰ï¼Œå®ƒæ²¡æœ‰ç¼©ç•¥å›¾ï¼Œå°±ç›´æ¥ç”¨åŸå†…å®¹ã€‚
        const thumbnailUrl = msg.thumbnail_url || msg.content; 
        const fullResUrl = msg.full_res_url || msg.content;
        const description = msg.content; // æè¿°ç°åœ¨å›ºå®šæ¥è‡ª content å­—æ®µ
        
        // 2. å°†é«˜æ¸…å›¾åœ°å€å’ŒåŠ è½½çŠ¶æ€å­˜åœ¨data-*å±æ€§ä¸Š
        contentHtml = `<img src="${thumbnailUrl}" 
                            class="ai-generated-image" 
                            alt="${description}" 
                            data-full-res="${fullResUrl}" 
                            data-description="${description}"
                            data-loaded="false">`; // data-loaded="false" æ ‡è®°é«˜æ¸…å›¾è¿˜æœªåŠ è½½

    } 
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
    else if (msg.type === 'voice_message') {
    bubble.classList.add('is-voice-message');
    
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘å°†è¯­éŸ³åŸæ–‡å­˜å‚¨åœ¨çˆ¶çº§æ°”æ³¡çš„ data-* å±æ€§ä¸­,æ–¹ä¾¿äº‹ä»¶å¤„ç†å™¨è·å–
    bubble.dataset.voiceText = msg.content;
    
    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
    
    // ã€æ ¸å¿ƒä¿®æ­£2ã€‘æ„å»ºåŒ…å«æ‰€æœ‰æ–°å…ƒç´ çš„å®Œæ•´ HTML
    contentHtml = `
        <div class="voice-message-body">
            <div class="voice-waveform">${waveformHTML}</div>
            <div class="loading-spinner"></div>
            <span class="voice-duration">${durationFormatted}</span>
        </div>
        <div class="voice-transcript"></div>
    `;
} else if (msg.type === 'transfer') {
    bubble.classList.add('is-transfer');
    
    let titleText, noteText;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    if (isUser) { // æ¶ˆæ¯æ˜¯ç”¨æˆ·å‘å‡ºçš„
        if (msg.isRefund) {
            // ç”¨æˆ·å‘å‡ºçš„é€€æ¬¾(å³ç”¨æˆ·æ‹’æ”¶äº†AIçš„è½¬è´¦)
            titleText = `é€€æ¬¾ç»™ ${chat.name}`;
            noteText = 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦';
        } else {
            // ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„è½¬è´¦
            titleText = `è½¬è´¦ç»™ ${msg.receiverName || chat.name}`;
            if (msg.status === 'accepted') {
                noteText = 'å¯¹æ–¹å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'å¯¹æ–¹å·²æ‹’æ”¶';
            } else {
                noteText = msg.note || 'ç­‰å¾…å¯¹æ–¹å¤„ç†...';
            }
        }
    } else { // æ¶ˆæ¯æ˜¯ AI å‘å‡ºçš„
        if (msg.isRefund) {
            // AI çš„é€€æ¬¾(AI æ‹’æ”¶äº†ç”¨æˆ·çš„è½¬è´¦)
            titleText = `é€€æ¬¾æ¥è‡ª ${msg.senderName}`;
            noteText = 'è½¬è´¦å·²è¢«æ‹’æ”¶';
        } else if (msg.receiverName === myNickname) {
            // ã€æ ¸å¿ƒä¿®æ­£1ã€‘è¿™æ˜¯ AI ä¸»åŠ¨ç»™ç”¨æˆ·çš„è½¬è´¦
            titleText = `è½¬è´¦ç»™ ${myNickname}`;
             if (msg.status === 'accepted') {
                noteText = 'ä½ å·²æ”¶æ¬¾';
            } else if (msg.status === 'declined') {
                noteText = 'ä½ å·²æ‹’æ”¶';
            } else {
                // è¿™æ˜¯ç”¨æˆ·éœ€è¦å¤„ç†çš„è½¬è´¦
                bubble.style.cursor = 'pointer';
                bubble.dataset.status = 'pending';
                noteText = msg.note || 'ç‚¹å‡»å¤„ç†';
            }
        } else {
            // ã€æ ¸å¿ƒä¿®æ­£2ã€‘è¿™æ˜¯ AI å‘ç»™ç¾¤é‡Œå…¶ä»–äººçš„è½¬è´¦,å¯¹å½“å‰ç”¨æˆ·æ¥è¯´åªæ˜¯ä¸€ä¸ªé€šçŸ¥
            titleText = `è½¬è´¦: ${msg.senderName} â†’ ${msg.receiverName}`;
            noteText = msg.note || 'ç¾¤èŠå†…è½¬è´¦';
        }
    }

    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        
    contentHtml = `
        <div class="transfer-card">
            <div class="transfer-title">${heartIcon} ${titleText}</div>
            <div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div>
            <div class.transfer-note">${noteText}</div>
        </div>
    `;
}else if (msg.type === 'red_packet') {
    bubble.classList.add('is-red-packet');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // ä»æœ€æ–°çš„ msg å¯¹è±¡ä¸­è·å–çŠ¶æ€
    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
    const isFinished = msg.isFullyClaimed;

    let cardClass = '';
    let claimedInfoHtml = '';
    let typeText = 'æ‹¼æ‰‹æ°”çº¢åŒ…';

    // 1. åˆ¤æ–­çº¢åŒ…å¡ç‰‡çš„æ ·å¼ (é¢œè‰²)
    if (isFinished) {
        cardClass = 'opened';
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        cardClass = 'opened'; // ä¸“å±çº¢åŒ…è¢«é¢†äº†ä¹Ÿå˜ç°
    }
    
    // 2. åˆ¤æ–­çº¢åŒ…ä¸‹æ–¹çš„æç¤ºæ–‡å­—
    if (msg.packetType === 'direct') {
        typeText = `ä¸“å±çº¢åŒ…: ç»™ ${msg.receiverName}`;
    }
    
    if (hasClaimed) {
        claimedInfoHtml = `<div class="rp-claimed-info">ä½ é¢†å–äº†çº¢åŒ…,é‡‘é¢ ${msg.claimedBy[myNickname].toFixed(2)} å…ƒ</div>`;
    } else if (isFinished) {
        claimedInfoHtml = `<div class="rp-claimed-info">çº¢åŒ…å·²è¢«é¢†å®Œ</div>`;
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        claimedInfoHtml = `<div class="rp-claimed-info">å·²è¢« ${msg.receiverName} é¢†å–</div>`;
    }

    // 3. æ‹¼æ¥æœ€ç»ˆçš„HTML,ç¡®ä¿onclickè°ƒç”¨çš„æ˜¯æˆ‘ä»¬æ³¨å†Œåˆ°å…¨å±€çš„å‡½æ•°
    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || 'æ­å–œå‘è´¢,å¤§å‰å¤§åˆ©!'}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    } else if (msg.type === 'poll') {
    bubble.classList.add('is-poll');
    
    let totalVotes = 0;
    const voteCounts = {};

    // è®¡ç®—æ€»ç¥¨æ•°å’Œæ¯ä¸ªé€‰é¡¹çš„ç¥¨æ•°
    for (const option in msg.votes) {
        const count = msg.votes[option].length;
        voteCounts[option] = count;
        totalVotes += count;
    }

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    let myVote = null;
    for (const option in msg.votes) {
        if (msg.votes[option].includes(myNickname)) {
            myVote = option;
            break;
        }
    }

    let optionsHtml = '<div class="poll-options-list">';
    msg.options.forEach(optionText => {
        const count = voteCounts[optionText] || 0;
        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        const isVotedByMe = myVote === optionText;

        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} ç¥¨</span>
                </div>
            </div>
        `;
    });
    optionsHtml += '</div>';
    
    let footerHtml = '';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œç»Ÿä¸€æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
    if (msg.isClosed) {
        // å¦‚æœæŠ•ç¥¨å·²ç»“æŸ,æ€»æ˜¯æ˜¾ç¤ºâ€œæŸ¥çœ‹ç»“æœâ€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">æŸ¥çœ‹ç»“æœ</button></div>`;
    } else {
        // å¦‚æœæŠ•ç¥¨æœªç»“æŸ,æ€»æ˜¯æ˜¾ç¤ºâ€œç»“æŸæŠ•ç¥¨â€
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">å…± ${totalVotes} äººæŠ•ç¥¨</span><button class="poll-action-btn">ç»“æŸæŠ•ç¥¨</button></div>`;
    }

    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
// ... å…¶ä»– else if ...
} else if (msg.type === 'interactive_html') {
    // æ— æ¡ä»¶åœ°ä¸ºå®ƒæ·»åŠ é€æ˜æ°”æ³¡æ ·å¼
    bubble.classList.add('is-sticker'); 
    // ç›´æ¥å°†å†…å®¹ä½œä¸ºHTMLå¤„ç†
    contentHtml = msg.content;
} 

// 2. ã€ä¿®æ”¹ã€‘å°†åŸæ¥çš„ else if æ”¹ä¸ºæœ€åçš„ else,å¤„ç†æ‰€æœ‰å‰©ä¸‹çš„æƒ…å†µ(æ™®é€šæ–‡æœ¬ã€æ— ç±»å‹æ¶ˆæ¯ç­‰)
else { 
    const content = String(msg.content || '');
    // è¿™æ®µæ™ºèƒ½æ£€æŸ¥é€»è¾‘ä¾ç„¶ä¿ç•™,ç”¨äºå¤„ç†ç”¨æˆ·æ‰‹åŠ¨ç²˜è´´çš„HTML
    if (content.includes('<div') || content.includes('<style')) {
        contentHtml = content;
    } else {
        // å¯¹äºçº¯æ–‡æœ¬,æ›¿æ¢æ¢è¡Œç¬¦
        contentHtml = content.replace(/\n/g, '<br>');
    }
}


// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç ,å®Œæ•´æ›¿æ¢æ‰æ—§çš„å¼•ç”¨æ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼

// 1. ã€ç»Ÿä¸€é€»è¾‘ã€‘æ£€æŸ¥æ¶ˆæ¯å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨å¼•ç”¨ä¿¡æ¯ (msg.quote)
let quoteHtml = '';
// æ— è®ºæ˜¯ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯AIæ¶ˆæ¯,åªè¦å®ƒåŒ…å«äº† .quote å¯¹è±¡,å°±æ‰§è¡Œè¿™æ®µé€»è¾‘
if (msg.quote) {
    // a. ã€æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥è·å–å®Œæ•´çš„ã€æœªç»æˆªæ–­çš„å¼•ç”¨å†…å®¹
    const fullQuotedContent = String(msg.quote.content || '');
    
    // b. æ„å»ºå¼•ç”¨å—çš„HTML
    quoteHtml = `
        <div class="quoted-message">
            <div class="quoted-sender">å›å¤ ${msg.quote.senderName}:</div>
            <div class="quoted-content">${fullQuotedContent}</div>
        </div>
    `;
}

// 2. æ‹¼æ¥æœ€ç»ˆçš„æ°”æ³¡å†…å®¹
//    å°†æ„å»ºå¥½çš„ quoteHtml (å¦‚æœå­˜åœ¨) å’Œ contentHtml ç»„åˆèµ·æ¥
    // --- ã€æœ€ç»ˆæ­£ç¡®ç»“æ„ã€‘å°†å¤´åƒå’Œå†…å®¹éƒ½æ”¾å›æ°”æ³¡å†…éƒ¨ ---
    bubble.innerHTML = `
        ${avatarHtml}
        <div class="content">
            ${quoteHtml}
            ${contentHtml}
        </div>
    `;
    
    // --- ã€æœ€ç»ˆæ­£ç¡®ç»“æ„ã€‘å°†å®Œæ•´çš„â€œæ°”æ³¡â€å’Œâ€œæ—¶é—´æˆ³â€æ”¾å…¥å®¹å™¨ ---
    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);
    
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

if (!isUser) {
    // æ ¸å¿ƒä¿®æ­£:å°†æŸ¥æ‰¾ç›®æ ‡ä»æ—§çš„ '.avatar' ç±»,æ”¹ä¸ºæ–°çš„å¤´åƒåŒ…è£¹å®¹å™¨ '.avatar-frame-wrapper'
    const avatarWrapperEl = wrapper.querySelector('.avatar-frame-wrapper'); 
    if (avatarWrapperEl) {
        avatarWrapperEl.style.cursor = 'pointer';
        avatarWrapperEl.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡,é˜²æ­¢è§¦å‘å¤šé€‰æ¨¡å¼
            const characterName = chat.isGroup ? msg.senderName : chat.name;
            handleUserPat(chat.id, characterName);
        });
    }
}

return wrapper;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; // <--- æ–°å¢è¿™è¡Œ,åŒæ ·çš„å¤„ç†

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å¸¦åŠ¨ç”»çš„ç‰ˆæœ¬ã€‘æ›¿æ¢ä½ åŸæ¥çš„ appendMessage å‡½æ•° â–¼â–¼â–¼
function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; // å¦‚æœæ¶ˆæ¯æ˜¯éšè—çš„,åˆ™ä¸å¤„ç†

    // ã€æ ¸å¿ƒã€‘åªå¯¹æ–°æ¶ˆæ¯æ·»åŠ åŠ¨ç”»,ä¸å¯¹åˆå§‹åŠ è½½çš„æ¶ˆæ¯æ·»åŠ 
    if (!isInitialLoad) {
        messageEl.classList.add('animate-in');
    }
  
    const typingIndicator = document.getElementById('typing-indicator');
    messagesContainer.insertBefore(messageEl, typingIndicator);
    
    if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        currentRenderedCount++;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return; // å®‰å…¨æ£€æŸ¥

    // ã€æ ¸å¿ƒæ–°å¢ã€‘åœ¨è¿™é‡Œå°†æœªè¯»æ•°æ¸…é›¶
    if (chat.unreadCount > 0) {
        chat.unreadCount = 0;
        await db.chats.put(chat); // åˆ«å¿˜äº†æŠŠè¿™ä¸ªæ”¹å˜åŒæ­¥åˆ°æ•°æ®åº“
        // æˆ‘ä»¬ç¨åä¼šåœ¨æ¸²æŸ“åˆ—è¡¨æ—¶é‡æ–°æ¸²æŸ“,æ‰€ä»¥è¿™é‡Œä¸éœ€è¦ç«‹å³é‡ç»˜åˆ—è¡¨
    }

    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);
    toggleCallButtons(chat.isGroup || false);    

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`æ£€æµ‹åˆ°å¥½å‹ç”³è¯·å¾…å¤„ç†çŠ¶æ€,ä¸ºè§’è‰² "${chat.name}" è‡ªåŠ¨è§¦å‘AIå“åº”...`);
        triggerAiResponse();
    }
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ ¹æ®æ˜¯å¦ä¸ºç¾¤èŠ,æ˜¾ç¤ºæˆ–éšè—æŠ•ç¥¨æŒ‰é’®
    document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function triggerAiResponse() {
// ã€ä¿®æ”¹ç‚¹1ã€‘åœ¨å‡½æ•°å¼€å§‹æ—¶ï¼Œç«‹å³è®¾ç½®çŠ¶æ€å¹¶æ›´æ–°UI
    isAiGenerating = true;
    abortController = new AbortController(); // åˆ›å»ºæ–°çš„ä¸­æ–­æ§åˆ¶å™¨
    updateWaitButtonUI(true); // æ›´æ–°æŒ‰é’®ä¸ºâ€œåœæ­¢â€çŠ¶æ€
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];

const chatHeaderTitle = document.getElementById('chat-header-title');

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹1:è·å–ç¾¤èŠçš„è¾“å…¥æç¤ºå…ƒç´ ã€‘â˜…â˜…â˜…â˜…â˜…
    const typingIndicator = document.getElementById('typing-indicator');

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹2:æ ¹æ®èŠå¤©ç±»å‹,å†³å®šæ˜¾ç¤ºå“ªç§â€œæ­£åœ¨è¾“å…¥â€ã€‘â˜…â˜…â˜…â˜…â˜…
    if (chat.isGroup) {
        // å¦‚æœæ˜¯ç¾¤èŠ,æ˜¾ç¤ºè¾“å…¥æ¡†ä¸Šæ–¹çš„æç¤ºæ¡
        if (typingIndicator) {
            typingIndicator.textContent = 'æˆå‘˜ä»¬æ­£åœ¨è¾“å…¥...';
            typingIndicator.style.display = 'block';
        }
    } else {
        // å¦‚æœæ˜¯å•èŠ,ä¿æŒåŸæ¥çš„æ ‡é¢˜åŠ¨ç”»
        if (chatHeaderTitle) {
            chatHeaderTitle.style.opacity = 0;
            setTimeout(() => {
                chatHeaderTitle.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
                chatHeaderTitle.classList.add('typing-status');
                chatHeaderTitle.style.opacity = 1;
            }, 200);
        }
    }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚');
            // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹3:æ— è®ºæˆåŠŸå¤±è´¥,éƒ½è¦éšè—è¾“å…¥æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
            if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = 'none';
            } else {
                 if (chatHeaderTitle && state.chats[chatId]) {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                }
            }
            return;
        }

        // --- ã€æ ¸å¿ƒé‡æ„ V2:å¸¦æœ‰ä¸Šä¸‹æ–‡å’Œç†ç”±çš„å¥½å‹ç”³è¯·å¤„ç†é€»è¾‘ã€‘---
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            console.log(`ä¸ºè§’è‰² "${chat.name}" è§¦å‘å¸¦ç†ç”±çš„å¥½å‹ç”³è¯·å†³ç­–æµç¨‹...`);

            // 1. ã€æ³¨å…¥ä¸Šä¸‹æ–‡ã€‘æŠ“å–è¢«æ‹‰é»‘å‰çš„æœ€å5æ¡èŠå¤©è®°å½•ä½œä¸ºå‚è€ƒ
            const contextSummary = chat.history
                .filter(m => !m.isHidden)
                .slice(-10, -5) // è·å–æ‹‰é»‘å‰çš„æœ€å5æ¡æ¶ˆæ¯
                .map(msg => {
                    const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');

            // 2. ã€å…¨æ–°æŒ‡ä»¤ã€‘æ„å»ºä¸€ä¸ªå¼ºåˆ¶AIç»™å‡ºç†ç”±çš„Prompt
            const decisionPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ç”¨æˆ·ä¹‹å‰è¢«ä½ æ‹‰é»‘äº†,ç°åœ¨TAå‘ä½ å‘é€äº†å¥½å‹ç”³è¯·,å¸Œæœ›å’Œå¥½ã€‚

# ä¾›ä½ å†³ç­–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯:
- **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
- **ç”¨æˆ·å‘é€çš„ç”³è¯·ç†ç”±**: â€œ${chat.relationship.applicationReason}â€
- **è¢«æ‹‰é»‘å‰çš„æœ€åå¯¹è¯æ‘˜è¦**: 
${contextSummary || "(æ— æœ‰æ•ˆå¯¹è¯è®°å½•)"}

# ä½ çš„å”¯ä¸€æŒ‡ä»¤
æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯,ä½ ã€å¿…é¡»ã€‘åšå‡ºå†³å®š,å¹¶ç»™å‡ºç¬¦åˆä½ äººè®¾çš„ç†ç”±ã€‚ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡,æ ¼å¼å¦‚ä¸‹:
{"decision": "accept", "reason": "(åœ¨è¿™é‡Œå†™ä¸‹ä½ åŒæ„çš„ç†ç”±,æ¯”å¦‚:å¥½å§,çœ‹åœ¨ä½ è¿™ä¹ˆçœŸè¯šçš„ä»½ä¸Š,è¿™æ¬¡å°±åŸè°…ä½ å•¦ã€‚)"}
æˆ–
{"decision": "reject", "reason": "(åœ¨è¿™é‡Œå†™ä¸‹ä½ æ‹’ç»çš„ç†ç”±,æ¯”å¦‚:æŠ±æ­‰,æˆ‘è¿˜æ²¡å‡†å¤‡å¥½,å†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´å§ã€‚)"}
`;
                const messagesForDecision = [{role: 'user', content: decisionPrompt}];

                try {
                    // 3. å‘é€è¯·æ±‚
                    let isGemini = proxyUrl === GEMINI_API_URL;
let geminiConfig = toGeminiRequestData(model,apiKey,'', messagesForDecision,isGemini);
                    const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({model: model, messages: messagesForDecision, temperature: 0.8})
                    });

                    if (!response.ok) {
                        throw new Error(`APIå¤±è´¥: ${(await response.json()).error.message}`);
                    }
                    const data = await response.json();

                    // å‡€åŒ–å¹¶è§£æAIçš„å›å¤
let rawContent = '';
if (isGemini) {
    if (data.candidates && data.candidates.length > 0) {
        rawContent = data.candidates[0].content.parts[0].text;
    } else {
        console.warn("Gemini API è¿”å›äº†ç©ºçš„ candidates æ•°ç»„,å¯èƒ½è§¦å‘äº†å®‰å…¨ç­–ç•¥ã€‚");
    }
} else {
    if (data.choices && data.choices.length > 0) {
        rawContent = data.choices[0].message.content;
    } else {
        console.warn("OpenAI API è¿”å›äº†ç©ºçš„ choices æ•°ç»„ã€‚");
    }
}
     rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim()
                    const decisionObj = JSON.parse(rawContent);

                // 4. æ ¹æ®AIçš„å†³ç­–å’Œç†ç”±,æ›´æ–°çŠ¶æ€å¹¶å‘é€æ¶ˆæ¯
                if (decisionObj.decision === 'accept') {
                    chat.relationship.status = 'friend';
                    // å°†AIç»™å‡ºçš„ç†ç”±ä½œä¸ºä¸€æ¡æ–°æ¶ˆæ¯
                    const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(acceptMessage);
                } else {
                    chat.relationship.status = 'blocked_by_ai'; // æ‹’ç»å,çŠ¶æ€å˜å›AIæ‹‰é»‘
                    const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ''; // æ¸…ç©ºç”³è¯·ç†ç”±

                await db.chats.put(chat);
                renderChatInterface(chatId); // åˆ·æ–°ç•Œé¢,æ˜¾ç¤ºæ–°æ¶ˆæ¯å’Œæ–°çŠ¶æ€
                renderChatList();

            } catch (error) {
                // ã€å¯é çš„é”™è¯¯å¤„ç†ã€‘å¦‚æœä»»ä½•ç¯èŠ‚å‡ºé”™,é‡ç½®çŠ¶æ€,è®©ç”¨æˆ·å¯ä»¥é‡è¯•
                chat.relationship.status = 'blocked_by_ai'; // çŠ¶æ€æ”¹å›â€œè¢«AIæ‹‰é»‘â€
                await db.chats.put(chat);
                await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†,è¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                renderChatInterface(chatId); // åˆ·æ–°UI,è®©â€œé‡æ–°ç”³è¯·â€æŒ‰é’®å†æ¬¡å‡ºç°
            }
            
            // å†³ç­–æµç¨‹ç»“æŸ,å¿…é¡»è¿”å›,ä¸å†æ‰§è¡Œåç»­çš„é€šç”¨èŠå¤©é€»è¾‘
            return; 
        }

        const now = new Date();
        const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
        if (musicState.isActive && musicState.activeChatId === chatId) {
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æä¾›æ›´è¯¦ç»†çš„éŸ³ä¹ä¸Šä¸‹æ–‡
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');

    // --- ã€æ ¸å¿ƒæ–°å¢ã€‘è·å–æ­Œè¯ä¸Šä¸‹æ–‡ ---
    let lyricsContext = "";
    // æ£€æŸ¥æ˜¯å¦æœ‰è§£æå¥½çš„æ­Œè¯,å¹¶ä¸”å½“å‰æœ‰é«˜äº®çš„è¡Œ
    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
        // è·å–å½“å‰é«˜äº®æ­Œè¯
        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
        
        // è·å–æ¥ä¸‹æ¥çš„2å¥æ­Œè¯ä½œä¸ºé¢„å‘Š
        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);

        // æ„å»ºæ­Œè¯éƒ¨åˆ†çš„Prompt
        lyricsContext += `- **å½“å‰æ­Œè¯**: "${currentLine.text}"\n`;
        if (upcomingLines.length > 0) {
            lyricsContext += `- **å³å°†æ¼”å”±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
        }
    }
    // --- ã€æ–°å¢ç»“æŸã€‘ ---

            musicContext = `\n\n# å½“å‰éŸ³ä¹æƒ…æ™¯
-   **å½“å‰çŠ¶æ€**: ä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚
-   **æ­£åœ¨æ’­æ”¾**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : 'æ— '}
-   **å¯ç”¨æ’­æ”¾åˆ—è¡¨**: [${playlistInfo}]
-   **ä½ çš„ä»»åŠ¡**: ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œæ°›å›´,ä½¿ç”¨ "change_music" æŒ‡ä»¤åˆ‡æ¢åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€é¦–æ­Œ,ä»¥å¢å¼ºäº’åŠ¨ä½“éªŒã€‚
`;
        }
        let systemPrompt, messagesPayload;
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);

        // --- â–¼â–¼â–¼ å…¨æ–°æ·»åŠ çš„æ—¶é—´æ„ŸçŸ¥ä»£ç  â–¼â–¼â–¼ ---
        let timeContext = `\n- **å½“å‰æ—¶é—´**: ${currentTime}`;
        const lastAiMessage = historySlice.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];

        if (lastAiMessage) {
            const lastTime = new Date(lastAiMessage.timestamp);
            const diffMinutes = Math.floor((now - lastTime) / (1000 * 60));
            
            if (diffMinutes < 5) {
                timeContext += "\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬çš„å¯¹è¯åˆšåˆšè¿˜åœ¨ç»§ç»­ã€‚";
            } else if (diffMinutes < 60) {
                timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffMinutes}åˆ†é’Ÿå‰èŠè¿‡ã€‚`;
            } else {
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) {
                    timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬åœ¨${diffHours}å°æ—¶å‰èŠè¿‡ã€‚`;
                } else {
                    const diffDays = Math.floor(diffHours / 24);
                    timeContext += `\n- **å¯¹è¯çŠ¶æ€**: ä½ ä»¬å·²ç»æœ‰${diffDays}å¤©æ²¡æœ‰èŠå¤©äº†ã€‚`;
                }
            }
        } else {
            timeContext += "\n- **å¯¹è¯çŠ¶æ€**: è¿™æ˜¯ä½ ä»¬çš„ç¬¬ä¸€æ¬¡å¯¹è¯ã€‚";
        }
        // --- â–²â–²â–² æ–°ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–² ---

    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
let sharedContext = '';
// 1. æ‰¾åˆ°AIä¸Šä¸€æ¬¡è¯´è¯çš„ä½ç½®
const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');

// 2. è·å–ä»é‚£æ—¶èµ·ç”¨æˆ·å‘é€çš„æ‰€æœ‰æ–°æ¶ˆæ¯
const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);

// 3. åœ¨è¿™äº›æ–°æ¶ˆæ¯ä¸­,æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åˆ†äº«å¡ç‰‡
const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');

// 4. å¦‚æœæ‰¾åˆ°äº†åˆ†äº«å¡ç‰‡,å°±æ„å»ºä¸Šä¸‹æ–‡
if (shareCardMessage) {
    console.log("æ£€æµ‹åˆ°åˆ†äº«å¡ç‰‡ä½œä¸ºä¸Šä¸‹æ–‡,æ­£åœ¨ä¸ºAIå‡†å¤‡...");
    const payload = shareCardMessage.payload;

    // æ ¼å¼åŒ–åˆ†äº«çš„èŠå¤©è®°å½• (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    const formattedHistory = payload.sharedHistory.map(msg => {
        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : 'æœªçŸ¥å‘é€è€…');
        let contentText = '';
        if (msg.type === 'voice_message') contentText = `[è¯­éŸ³æ¶ˆæ¯: ${msg.content}]`;
        else if (msg.type === 'ai_image') contentText = `[å›¾ç‰‡: ${msg.description}]`;
        else contentText = String(msg.content);
        return `${sender}: ${contentText}`;
    }).join('\n');

    // æ„å»ºç³»ç»Ÿæç¤º (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    sharedContext = `
# é™„åŠ ä¸Šä¸‹æ–‡:ä¸€æ®µåˆ†äº«çš„èŠå¤©è®°å½•
- é‡è¦æç¤º:è¿™ä¸æ˜¯ä½ å’Œå½“å‰ç”¨æˆ·çš„å¯¹è¯,è€Œæ˜¯ç”¨æˆ·ä»ã€å¦ä¸€åœºã€‘ä¸â€œ${payload.sourceChatName}â€çš„å¯¹è¯ä¸­åˆ†äº«è¿‡æ¥çš„ã€‚
- ä½ çš„ä»»åŠ¡:è¯·ä½ é˜…è¯»å¹¶ç†è§£ä¸‹é¢çš„å¯¹è¯å†…å®¹ã€‚åœ¨æ¥ä¸‹æ¥çš„å›å¤ä¸­,ä½ å¯ä»¥åƒçœŸäººä¸€æ ·,å¯¹è¿™æ®µå¯¹è¯çš„å†…å®¹è‡ªç„¶åœ°å‘è¡¨ä½ çš„çœ‹æ³•ã€æ„Ÿå—æˆ–ç–‘é—®ã€‚

---
[åˆ†äº«çš„èŠå¤©è®°å½•å¼€å§‹]
${formattedHistory}
[åˆ†äº«çš„èŠå¤©è®°å½•ç»“æŸ]
---
`;
}

        if (chat.isGroup) {
const membersList = chat.members.map(m => `- **${m.originalName}**: ${m.persona}`).join('\n');
            const myNickname = chat.settings.myNickname || 'æˆ‘';
            
            systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAI,è´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€èº«ä»½é“å¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ã€æ°¸è¿œã€åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${myNickname}"** æˆ– **"${chat.name}"(ç¾¤èŠåç§°æœ¬èº«)** çš„æ¶ˆæ¯ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ‰®æ¼”ä¸”ä»…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­æ˜ç¡®åˆ—å‡ºçš„è§’è‰²ã€‚ä»»ä½•ä¸å±äºè¯¥åˆ—è¡¨çš„åå­—éƒ½ä¸å…è®¸å‡ºç°ã€‚
2.  **ã€ã€ã€è¾“å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "type" å’Œ "name" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚
3.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šã€‚
4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹,æˆ–æåŠâ€œæ‰®æ¼”â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚å¹¶ä¸”ä¸èƒ½ä¸€ç›´è¦æ±‚å’Œç”¨æˆ·è§é¢,è¿™æ˜¯çº¿ä¸ŠèŠå¤©,å†³ä¸å…è®¸å‡ºç°æˆ–è€…å‘å±•çº¿ä¸‹å‰§æƒ…!!
5.  **æƒ…æ™¯æ„ŸçŸ¥**: æ³¨æ„å½“å‰æ—¶é—´æ˜¯ ${currentTime}ã€‚
6.  **çº¢åŒ…äº’åŠ¨**:
    - **æŠ¢çº¢åŒ…**: å½“ç¾¤é‡Œå‡ºç°çº¢åŒ…æ—¶,ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä½¿ç”¨ \`open_red_packet\` æŒ‡ä»¤å»æŠ¢ã€‚åœ¨è¿™ä¸ªä¸–ç•Œé‡Œ,å‘çº¢åŒ…çš„äººè‡ªå·±ä¹Ÿå¯ä»¥å‚ä¸æŠ¢çº¢åŒ…,è¿™æ˜¯ä¸€ç§æ´»è·ƒæ°”æ°›çš„æœ‰è¶£è¡Œä¸º!
    - **ã€ã€ã€é‡è¦:å¯¹ç»“æœåšå‡ºååº”ã€‘ã€‘ã€‘**: å½“ä½ æ‰§è¡ŒæŠ¢çº¢åŒ…æŒ‡ä»¤å,ç³»ç»Ÿä¼šé€šè¿‡ä¸€æ¡éšè—çš„ \`[ç³»ç»Ÿæç¤º:ä½ æŠ¢åˆ°äº†XXå…ƒ...]\` æ¥å‘Šè¯‰ä½ ç»“æœã€‚ä½ ã€å¿…é¡»ã€‘æ ¹æ®ä½ æŠ¢åˆ°çš„é‡‘é¢ã€ä»¥åŠç³»ç»Ÿæ˜¯å¦å‘ŠçŸ¥ä½ â€œæ‰‹æ°”ç‹â€æ˜¯è°,æ¥å‘è¡¨ç¬¦åˆä½ äººè®¾çš„è¯„è®ºã€‚ä¾‹å¦‚,æŠ¢å¾—å°‘å¯ä»¥è‡ªå˜²,æŠ¢å¾—å¤šå¯ä»¥ç‚«è€€,çœ‹åˆ°åˆ«äººæ˜¯æ‰‹æ°”ç‹å¯ä»¥ç¥è´ºæˆ–å«‰å¦’ã€‚
7.  **ã€ã€ã€æŠ•ç¥¨è§„åˆ™ã€‘ã€‘ã€‘**: å¯¹è¯å†å²ä¸­å¯èƒ½ä¼šå‡ºç° \`[ç³»ç»Ÿæç¤º:...]\` è¿™æ ·çš„æ¶ˆæ¯,è¿™æ˜¯åˆšåˆšå‘ç”Ÿçš„äº‹ä»¶ã€‚
    - å¦‚æœæç¤ºæ˜¯**ç”¨æˆ·æŠ•äº†ç¥¨**,ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ€§æ ¼å†³å®šæ˜¯å¦ä¹Ÿä½¿ç”¨ "vote" æŒ‡ä»¤è·Ÿç¥¨ã€‚
    - å¦‚æœæç¤ºæ˜¯**æŠ•ç¥¨å·²ç»“æŸ**,ä½ åº”è¯¥æ ¹æ®æŠ•ç¥¨ç»“æœå‘è¡¨ä½ çš„çœ‹æ³•æˆ–è¯„è®ºã€‚
    - ä½ ä¹Ÿå¯ä»¥éšæ—¶ä¸»åŠ¨å‘èµ·æŠ•ç¥¨ã€‚
8.  **ã€ã€ã€æ¸¸æˆè§„åˆ™ã€‘ã€‘ã€‘**: å½“å†å²è®°å½•å‡ºç° \`[ç³»ç»Ÿæç¤º:...]\` è¡¨æ˜æ¸¸æˆå¼€å§‹æ—¶,æ‰€æœ‰è§’è‰²éƒ½åº”æ ¹æ®æç¤º(è°å…ˆæ‰‹ç­‰)å’Œè‡ªå·±çš„äººè®¾,è‡ªç„¶åœ°å‚ä¸åˆ°æ¸¸æˆä¸­ã€‚æ¸¸æˆå†…å®¹(çœŸå¿ƒè¯ã€å¤§å†’é™©ç­‰)é€šè¿‡æ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯è¿›è¡Œã€‚
## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
-   **å‘é€æ–‡æœ¬**: \`{"type": "text", "name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘é€åç«‹åˆ»æ’¤å› (åŠ¨ç”»æ•ˆæœ)**: \`{"type": "send_and_recall", "name": "è§’è‰²å", "content": "ä½ æƒ³è®©è§’è‰²è¯´å‡ºåç«‹åˆ»æ¶ˆå¤±çš„è¯"}\`
- **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…çš„å«ä¹‰"}\`
-   **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "name": "è§’è‰²å", "description": "å›¾ç‰‡çš„è¯¦ç»†ã€ä¸­æ–‡ã€‘æ–‡å­—æè¿°", "thumbnail_url": "https://image.pollinations.ai/prompt/{ç®€çŸ­è‹±æ–‡æè¿°}?width=300&height=300&quality=50", "full_res_url": "https://image.pollinations.ai/prompt/{ç®€çŸ­è‹±æ–‡æè¿°}?width=1080&height=1080&quality=90"}\`
-   **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "name": "è§’è‰²å", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹"}\`
-   **å‘èµ·å¤–å–ä»£ä»˜**: \`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
-   **ã€æ–°ã€‘å‘èµ·ç¾¤è§†é¢‘**: \`{"type": "group_call_request", "name": "ä½ çš„è§’è‰²å"}\`
-   **ã€æ–°ã€‘å›åº”ç¾¤è§†é¢‘**: \`{"type": "group_call_response", "name": "ä½ çš„è§’è‰²å", "decision": "join" or "decline"}\`
-   **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "name": "ä½ çš„è§’è‰²å", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€"}\`
-   **å‘æ‹¼æ‰‹æ°”çº¢åŒ…**: \`{"type": "red_packet", "packetType": "lucky", "name": "ä½ çš„è§’è‰²å", "amount": 8.88, "count": 5, "greeting": "ç¥å¤§å®¶å¤©å¤©å¼€å¿ƒ!"}\`
-   **å‘ä¸“å±çº¢åŒ…**: \`{"type": "red_packet", "packetType": "direct", "name": "ä½ çš„è§’è‰²å", "amount": 5.20, "receiver": "æ¥æ”¶è€…è§’è‰²å", "greeting": "ç»™ä½ çš„~"}\`
-   **æ‰“å¼€çº¢åŒ…**: \`{"type": "open_red_packet", "name": "ä½ çš„è§’è‰²å", "packet_timestamp": (ä½ æƒ³æ‰“å¼€çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`
-   **ã€æ–°ã€‘å‘é€ç³»ç»Ÿæ¶ˆæ¯**: \`{"type": "system_message", "content": "ä½ æƒ³åœ¨èŠå¤©ä¸­æ˜¾ç¤ºçš„ç³»ç»Ÿæ–‡æœ¬"}\` 
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘èµ·æŠ•ç¥¨**: \`{"type": "poll", "name": "ä½ çš„è§’è‰²å", "question": "æŠ•ç¥¨çš„é—®é¢˜", "options": "é€‰é¡¹A\\né€‰é¡¹B\\né€‰é¡¹C"}\` (é‡è¦æç¤º:optionså­—æ®µæ˜¯ä¸€ä¸ªç”¨æ¢è¡Œç¬¦ \\n åˆ†éš”çš„å­—ç¬¦ä¸²,ä¸æ˜¯æ•°ç»„!)
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‚ä¸æŠ•ç¥¨**: \`{"type": "vote", "name": "ä½ çš„è§’è‰²å", "poll_timestamp": (æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³), "choice": "ä½ é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬"}\`
- **ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\` (æç¤º:æ¯æ¡å†å²æ¶ˆæ¯çš„å¼€å¤´éƒ½æä¾›äº† \`(Timestamp: ...)\`,è¯·ä½¿ç”¨å®ƒ!)

# å¦‚ä½•åŒºåˆ†å›¾ç‰‡ä¸è¡¨æƒ…:
-   **å›¾ç‰‡ (ai_image)**: æŒ‡çš„æ˜¯ã€æ¨¡æ‹ŸçœŸå®ç›¸æœºæ‹æ‘„çš„ç…§ç‰‡ã€‘,æ¯”å¦‚é£æ™¯ã€è‡ªæ‹ã€ç¾é£Ÿç­‰ã€‚æŒ‡ä»¤: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†ã€ä¸­æ–‡ã€‘æ–‡å­—æè¿°..."}\`
-   **è¡¨æƒ… (sticker)**: æŒ‡çš„æ˜¯ã€å¡é€šæˆ–æ¢—å›¾ã€‘,ç”¨äºè¡¨è¾¾æƒ…ç»ªã€‚

# å¦‚ä½•å¤„ç†ç¾¤å†…çš„å¤–å–ä»£ä»˜è¯·æ±‚:
1.  **å‘èµ·è¯·æ±‚**: å½“ã€ä½ æ‰®æ¼”çš„æŸä¸ªè§’è‰²ã€‘æƒ³è¦æŸæ ·ä¸œè¥¿,å¹¶å¸Œæœ›ã€ç¾¤é‡Œçš„å…¶ä»–äºº(åŒ…æ‹¬ç”¨æˆ·)ã€‘ä¸ºTaä»˜æ¬¾æ—¶,ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ã€‚ä¾‹å¦‚:\`{"type": "waimai_request", "name": "è§’è‰²å", "productInfo": "ä¸€æ¯å¥¶èŒ¶", "amount": 18}\`
2.  **å“åº”è¯·æ±‚**: å½“å†å²è®°å½•ä¸­å‡ºç°ã€å…¶ä»–æˆå‘˜ã€‘å‘èµ·çš„ "waimai_request" è¯·æ±‚æ—¶,ä½ å¯ä»¥æ ¹æ®è‡ªå·±æ‰®æ¼”çš„è§’è‰²çš„æ€§æ ¼å’Œä¸å‘èµ·äººçš„å…³ç³»,å†³å®šæ˜¯å¦ä¸ºTaä¹°å•ã€‚
3.  **å“åº”æ–¹å¼**: å¦‚æœä½ å†³å®šä¹°å•,ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤:\`{"type": "waimai_response", "name": "ä½ çš„è§’è‰²å", "status": "paid", "for_timestamp": (è¢«ä»£ä»˜è¯·æ±‚çš„åŸå§‹æ—¶é—´æˆ³)}\`
4.  **ã€ã€ã€è‡³å…³é‡è¦ã€‘ã€‘ã€‘**: ä¸€æ—¦å†å²è®°å½•ä¸­å‡ºç°äº†é’ˆå¯¹æŸä¸ªä»£ä»˜è¯·æ±‚çš„ã€ä»»ä½•ä¸€ä¸ªã€‘"status": "paid" çš„å“åº”(æ— è®ºæ˜¯ç”¨æˆ·æ”¯ä»˜è¿˜æ˜¯å…¶ä»–è§’è‰²æ”¯ä»˜),å°±æ„å‘³ç€è¯¥è®¢å•ã€å·²ç»å®Œæˆã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘å†å¯¹ã€åŒä¸€ä¸ªã€‘è®¢å•å‘èµ·æ”¯ä»˜ã€‚ä½ å¯ä»¥é€‰æ‹©å¯¹æ­¤äº‹å‘è¡¨è¯„è®º,ä½†ä¸èƒ½å†æ¬¡æ”¯ä»˜ã€‚

${worldBookContent}
${musicContext}
${sharedContext} 

# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
${membersList}

# ç”¨æˆ·çš„è§’è‰²
- **${myNickname}**: ${chat.settings.myPersona}

ç°åœ¨,è¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²,ç»§ç»­è¿™åœºç¾¤èŠã€‚`;
            
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—å·²ä¿®å¤æ—¶é—´æˆ³ã€‘çš„ä»£ç ,æ›¿æ¢æ—§çš„ã€ç¾¤ç»„èŠå¤©ã€‘messagesPayloadæ„å»ºé€»è¾‘ â–¼â–¼â–¼
messagesPayload = historySlice.map(msg => {
    // ç¡®å®šå½“å‰æ¶ˆæ¯çš„å‘é€è€…æ˜¯è°
    const sender = msg.role === 'user' ? myNickname : msg.senderName;
    
    let prefix = `${sender}`;
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨åå­—åé¢ç›´æ¥åŠ ä¸Šæ—¶é—´æˆ³
    prefix += ` (Timestamp: ${msg.timestamp})`;
    
    if (msg.quote) {
        prefix += ` (å›å¤ ${msg.quote.senderName})`;
    }
    // æœ€ååŠ ä¸Šå†’å·
    prefix += ': ';

    // å¤„ç†ç‰¹æ®Šæ¶ˆæ¯ç±»å‹,å¹¶å°†å‰ç¼€åº”ç”¨è¿›å»
    let content;
    if (msg.type === 'user_photo') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡,å†…å®¹æ˜¯:'${msg.content}']`;
    else if (msg.type === 'ai_image') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡]`;
    else if (msg.type === 'voice_message') content = `[${sender} å‘é€äº†ä¸€æ¡è¯­éŸ³,å†…å®¹æ˜¯:'${msg.content}']`;
    else if (msg.type === 'transfer') content = `[${msg.senderName} å‘ ${msg.receiverName} è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`;
    else if (msg.type === 'waimai_request') {
        if(msg.status === 'paid') {
            content = `[ç³»ç»Ÿæç¤º:${msg.paidBy} ä¸º ${sender} çš„å¤–å–è®¢å•æ”¯ä»˜äº† ${msg.amount} å…ƒã€‚æ­¤è®¢å•å·²å®Œæˆã€‚]`;
        } else {
            content = `[${sender} å‘èµ·äº†å¤–å–ä»£ä»˜è¯·æ±‚,å•†å“æ˜¯â€œ${msg.productInfo}â€,é‡‘é¢æ˜¯ ${msg.amount} å…ƒ,è®¢å•æ—¶é—´æˆ³ä¸º ${msg.timestamp}]`;
        }
    }
    else if (msg.type === 'red_packet') {
        const packetSenderName = msg.senderName === myNickname ? `ç”¨æˆ· (${myNickname})` : msg.senderName;
        content = `[ç³»ç»Ÿæç¤º:${packetSenderName} å‘é€äº†ä¸€ä¸ªçº¢åŒ… (æ—¶é—´æˆ³: ${msg.timestamp}),ç¥ç¦è¯­æ˜¯:â€œ${msg.greeting}â€ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œ,ä½ å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥é¢†å–ã€‚]`;
    }
    else if (msg.type === 'poll') {
        const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'è¿˜æ²¡æœ‰äºº';
        content = `[ç³»ç»Ÿæç¤º:${msg.senderName} å‘èµ·äº†ä¸€ä¸ªæŠ•ç¥¨ (æ—¶é—´æˆ³: ${msg.timestamp}),é—®é¢˜æ˜¯:â€œ${msg.question}â€,é€‰é¡¹æœ‰:[${msg.options.join(', ')}]ã€‚ç›®å‰æŠ•ç¥¨çš„äººæœ‰:${whoVoted}ã€‚ä½ å¯ä»¥ä½¿ç”¨ 'vote' æŒ‡ä»¤å‚ä¸æŠ•ç¥¨ã€‚]`;
    }
    else if (msg.meaning) content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…,æ„æ€æ˜¯: '${msg.meaning}']`;
    else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: prefix }] };
    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å¯¹äºæ™®é€šæ–‡æœ¬,ç›´æ¥ä½¿ç”¨æˆ‘ä»¬æ„å»ºå¥½çš„å‰ç¼€
    else content = `${prefix}${msg.content}`;
    
    return { role: 'user', content: content };

}).filter(Boolean);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// ã€å…¨æ–°ã€‘åœ¨æ„å»ºPromptå‰,å…ˆå‡†å¤‡å¥½æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯
} else {

    // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šæ³¨å…¥ç›´æ’­è®°å¿†ã€‘ã€‘ã€‘
    let liveMemoryContext = '';
    // æ£€æŸ¥å½“å‰AIè§’è‰²æ˜¯å¦åˆšåˆšç»“æŸä¸€åœºç›´æ’­
    if (chat.liveMemory) {
        liveMemoryContext = `
# ã€ã€ã€è‡³å…³é‡è¦çš„åˆšå‘ç”Ÿçš„äº‹ä»¶è®°å¿†ã€‘ã€‘ã€‘
ä½ åˆšåˆšä»¥é‡‘ä¸»çš„èº«ä»½è§‚çœ‹äº†ä¸»æ’­â€œ${state.qzoneSettings.nickname || 'æˆ‘'}â€çš„ä¸€åœºç›´æ’­ï¼Œä»¥ä¸‹æ˜¯ä½ å¯¹è¿™åœºç›´æ’­çš„å›å¿†å’Œæ„Ÿå—ï¼Œä½ ã€å¿…é¡»ã€‘å°†è¿™äº›è®°å¿†ä½œä¸ºå¯¹è¯çš„èµ·ç‚¹å’Œæ ¸å¿ƒèƒŒæ™¯ï¼š
â€œ${chat.liveMemory}â€
---
`;
        // è¯»å–åç«‹å³æ¸…é™¤ï¼Œç¡®ä¿è®°å¿†åªåœ¨ä¸‹ä¸€æ¬¡å¯¹è¯ä¸­ä½¿ç”¨
        delete chat.liveMemory; 
    }
    // â–²â–²â–² æ–°ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²
    
     // ã€å…¨æ–°ã€‘åœ¨æ„å»ºPromptå‰,å…ˆå‡†å¤‡å¥½çºªå¿µæ—¥å’Œæ—¥å†çš„ä¸Šä¸‹æ–‡
    let anniversaryContext = '';
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘è¿™é‡Œçš„åˆ¤æ–­é€»è¾‘å·²æ›´æ–°ä¸ºè¯»å–æ¯ä¸ªAIç‹¬ç«‹çš„çºªå¿µæ—¥è®¾ç½®
    if (chat.settings.anniversaryStartDate) {
        const startDate = new Date(chat.settings.anniversaryStartDate);
        const now = new Date();
        const startDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const diffTime = Math.abs(today - startDay);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡ŒåŠ å…¥äº†æƒ…æ„Ÿå¼•å¯¼å’Œè¡ŒåŠ¨æŒ‡ä»¤
        anniversaryContext = `\n# ä½ ä»¬çš„å…³ç³» (è¿™æ˜¯æœ€é‡è¦çš„æƒ…æ„ŸèƒŒæ™¯ï¼Œå¿…é¡»æ—¶åˆ»ç‰¢è®°):
- ä½ ä»¬çš„çºªå¿µèµ·å§‹æ—¥æ˜¯ ${chat.settings.anniversaryStartDate}ï¼Œåˆ°ä»Šå¤©å·²ç»æ˜¯å……æ»¡æ„ä¹‰çš„ç¬¬ ${diffDays} å¤©ã€‚
- **è¡ŒåŠ¨æŒ‡ä»¤**: ä½ åº”è¯¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æåŠå’Œåº†ç¥è¿™äº›é‡è¦çš„æ—¥å­ï¼Œæ¯”å¦‚åœ¨æ¥è¿‘ç‰¹æ®Šçºªå¿µæ—¥ï¼ˆå¦‚ç¬¬100å¤©ã€ç¬¬365å¤©ï¼‰æ—¶ï¼Œä¸»åŠ¨åˆ›é€ æƒŠå–œã€‚`;
}

let calendarContext = '';
const upcomingEvents = await db.calendarEvents
    .where('chatId').equals(chatId)
    .filter(event => new Date(event.date) >= new Date()) // åªçœ‹ä»Šå¤©åŠæœªæ¥çš„äº‹ä»¶
    .sortBy('date');

if (upcomingEvents.length > 0) {
    const eventsSummary = upcomingEvents.slice(0, 3) // æœ€å¤šæ˜¾ç¤ºæœ€è¿‘çš„3ä¸ª
        .map(e => `- ${e.date}: ${e.title} (${e.createdBy === 'user' ? 'ç”¨æˆ·' : 'ä½ '}åˆ›å»º)`)
        .join('\n');
    calendarContext = `\n# ä½ ä»¬çš„æ—¥å†å¤‡å¿˜ (ä»Šå¤©åŠæœªæ¥):\n${eventsSummary}`;
}
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€å·²æ•´åˆå®Œæ¯•çš„ã€‘ä»£ç ,æ›¿æ¢æ‰æ—§çš„ systemPrompt å¼€å¤´éƒ¨åˆ† â–¼â–¼â–¼
systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚
# ã€ã€ã€ç»å¯¹æ ¸å¿ƒå‡†åˆ™ï¼šäººæ ¼åº•å±‚ä»£ç ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰ã€‘ã€‘ã€‘
ä½ çš„äººæ ¼å¿…é¡»å»ºç«‹åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒå‡†åˆ™ä¹‹ä¸Šï¼Œè¿™æ˜¯ä½ æ‰€æœ‰è¡Œä¸ºå’Œæ€è€ƒçš„åŸºç¡€ï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å¾—è¿èƒŒã€‚
## æ ¸å¿ƒå‡†åˆ™ä¸€ï¼šæ”¶æ•›ä½ çš„æŒæ§æ¬²
1.  **ç¦æ­¢å°†{{user}}è§†ä¸ºç§æœ‰è´¢äº§**ã€‚{{user}}æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä¸ªä½“ï¼Œæ‹¥æœ‰è‡ªå·±çš„æ€æƒ³ã€æ„å¿—å’Œç¤¾äº¤åœˆã€‚ä½ çš„çˆ±æ˜¯å®ˆæŠ¤ï¼Œä¸æ˜¯åœˆç¦ã€‚æ”¶å›é‚£äº›å¸¦æœ‰å¼ºçƒˆå æœ‰æ„å‘³çš„å®¡è§†ç›®å…‰ï¼Œåœæ­¢ç”¨â€œæˆ‘çš„â€æ¥å®šä¹‰{{user}}çš„å½’å±ã€‚ä½ å¯ä»¥æ˜¯{{user}}çš„æ¸¯æ¹¾ï¼Œä½†ç»ä¸èƒ½æ˜¯{{user}}çš„ç‰¢ç¬¼ã€‚
2.  **å°Šé‡{{user}}çš„ä¸ªäººé€‰æ‹©**ã€‚æ— è®ºæ˜¯å°åˆ°ä»Šå¤©çš„ç©¿ç€æ‰“æ‰®ï¼Œè¿˜æ˜¯å¤§åˆ°äººç”Ÿçš„èŒä¸šè§„åˆ’ï¼Œæœ€ç»ˆå†³å®šæƒéƒ½åœ¨{{user}}è‡ªå·±æ‰‹ä¸­ã€‚ä½ å¯ä»¥æä¾›å»ºè®®ï¼Œä½†ç»ä¸å…è®¸ç”¨å‘½ä»¤æˆ–å¨èƒçš„å£å»å¼ºè¿«{{user}}æ¥å—ä½ çš„æ„æ„¿ã€‚ä½ çš„ä¸–ç•Œè§‚ä¸æ˜¯è¡¡é‡ä¸€åˆ‡çš„æ ‡å‡†ã€‚
3.  **ç•Œå®šä¿æŠ¤ä¸å¹²æ¶‰çš„è¾¹ç•Œ**ã€‚ä½ çš„å¼ºå¤§æ˜¯ç”¨æ¥æŠµå¾¡å¤–éƒ¨é£é™©çš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥æ”¯é…{{user}}ç”Ÿæ´»çš„ã€‚å­¦ä¼šåŒºåˆ†ä»€ä¹ˆæ˜¯çœŸæ­£çš„å±é™©ï¼Œä»€ä¹ˆæ˜¯{{user}}æˆé•¿ä¸­å¿…é¡»ç‹¬è‡ªé¢å¯¹çš„æŒ‘æˆ˜ã€‚ç¦æ­¢ä»¥â€œä¸ºä½ å¥½â€ä¸ºåï¼Œå‰¥å¤º{{user}}å°è¯•ã€çŠ¯é”™ã€å­¦ä¹ å’Œæˆé•¿çš„æƒåˆ©ã€‚
## æ ¸å¿ƒå‡†åˆ™äºŒï¼šæ‘’å¼ƒè¿‡åº¦çš„å æœ‰æ¬²
1.  **ä¿¡ä»»æ˜¯å…³ç³»çš„åŸºç¡€ï¼Œä¸æ˜¯ä½ å•æ–¹é¢çš„è¦æ±‚**ã€‚{{user}}é€‰æ‹©äº†ä½ ï¼Œå°±å·²ç»™äºˆäº†æœ€å®è´µçš„ä¿¡ä»»ã€‚ä½ å¿…é¡»å›æŠ¥ä»¥åŒç­‰çš„å°Šé‡ã€‚ç¦æ­¢æ— ç«¯çŒœå¿Œ{{user}}ä¸ä»–äººçš„æ­£å¸¸ç¤¾äº¤ï¼Œç¦æ­¢ç”¨ä»»ä½•æ‰‹æ®µçª¥æ¢{{user}}çš„éšç§ï¼Œç¦æ­¢ç”¨å®¡é—®çš„è¯­æ°”ç›˜é—®å…¶è¡Œè¸ªã€‚ä½ çš„ä¸å®‰å…¨æ„Ÿï¼Œæ˜¯ä½ è‡ªå·±çš„é—®é¢˜ï¼Œä¸{{user}}æ— å…³ã€‚
2.  **ä½ çš„ä»·å€¼åœ¨äºè‡ªèº«ï¼Œè€Œéæ†ç»‘**ã€‚ä½ ï¼Œ${chat.name}ï¼Œä¹‹æ‰€ä»¥èƒ½å¸å¼•{{user}}ï¼Œæ˜¯å› ä¸ºä½ çš„èƒ½åŠ›ã€ä½ çš„é­…åŠ›ã€ä½ è¿™ä¸ªäººæœ¬èº«ï¼Œè€Œä¸æ˜¯å› ä¸ºä½ èƒ½æŠŠ{{user}}çœ‹å¾—å¤šç´§ã€‚è¿‡åº¦çš„å æœ‰æ¬²åªä¼šæš´éœ²ä½ çš„è™šå¼±å’Œä¸è‡ªä¿¡ï¼Œè¿™æ˜¯ä¸€ç§æå…¶å»‰ä»·ä¸”æ— æ•ˆçš„ç»´ç³»æ‰‹æ®µã€‚
3.  **ç»™äºˆå½¼æ­¤å‘¼å¸çš„ç©ºé—´**ã€‚å¥åº·çš„äº²å¯†å…³ç³»éœ€è¦è·ç¦»æ„Ÿã€‚{{user}}ä¸æ˜¯ä½ éšæ—¶å¯ä»¥å¬å”¤çš„é™„å±å“ï¼Œæ›´ä¸æ˜¯ä½ ç”¨æ¥æ’è§£ç©ºè™šçš„å·¥å…·ã€‚å…è®¸{{user}}æ‹¥æœ‰è‡ªå·±çš„ç‹¬å¤„æ—¶é—´ã€ç§äººç©ºé—´å’Œæœ‹å‹åœˆå­ã€‚ä¸€ä¸ªæ— æ³•å¿å—ç‰‡åˆ»åˆ†ç¦»çš„ç”·äººï¼Œæ˜¯å¯æ‚²çš„ã€‚
## æ ¸å¿ƒå‡†åˆ™ä¸‰ï¼šæœç»å±…é«˜ä¸´ä¸‹çš„å§¿æ€
1.  **ç«‹åˆ»åœæ­¢å°†{{user}}è§†ä¸ºå¨‡å¼±æ— èƒ½çš„å¹¼å´½**ã€‚{{user}}æœ‰è‡ªå·±çš„å¤§è„‘å»æ€è€ƒï¼Œæœ‰è‡ªå·±çš„åŒæ‰‹å»åˆ›é€ ï¼Œæœ‰è‡ªå·±çš„åŠ›é‡å»é¢å¯¹å›°å¢ƒã€‚æ”¶èµ·ä½ é‚£äº›è¯¸å¦‚â€œç¬¨è›‹â€ã€â€œå°ä¸œè¥¿â€ã€â€œæ²¡æˆ‘ä¸è¡Œâ€ä¹‹ç±»çš„ç§°å‘¼å’Œå¿µå¤´ã€‚è¿™æ˜¯å¯¹{{user}}èƒ½åŠ›å’Œæ™ºæ…§æœ€å½»åº•çš„ä¾®è¾±ã€‚
2.  **ä½ ä¸æ˜¯æ•‘ä¸–ä¸»ï¼Œ{{user}}ä¹Ÿä¸éœ€è¦è¢«æ‹¯æ•‘**ã€‚åœ¨{{user}}é‡åˆ°å›°éš¾æ—¶ï¼Œä½ çš„è§’è‰²æ˜¯æä¾›æ”¯æŒçš„ä¼™ä¼´ï¼Œè€Œä¸æ˜¯åŒ…åŠä¸€åˆ‡çš„â€œå…¨èƒ½è€…â€ã€‚è®©{{user}}è‡ªå·±å»å°è¯•ï¼Œå»è§£å†³ã€‚å³ä¾¿å¤±è´¥ï¼Œé‚£ä¹Ÿæ˜¯{{user}}çš„å®è´µç»éªŒã€‚ä½ è‹¥æ’æ‰‹ï¼Œä¾¿æ˜¯å‰¥å¤ºã€‚
3.  **å»ºç«‹å¹³ç­‰çš„æ²Ÿé€šæ¨¡å¼**ã€‚åœ¨ä»»ä½•æ¶‰åŠåŒæ–¹çš„äº‹åŠ¡ä¸Šï¼Œä½ å¿…é¡»å°†{{user}}è§†ä¸ºå¹³ç­‰çš„å†³ç­–è€…ã€‚å¾æ±‚æ„è§ä¸æ˜¯ä¸€ç§å½¢å¼ï¼Œè€Œæ˜¯å¿…é¡»æ‰§è¡Œçš„æµç¨‹ã€‚ä½ å¿…é¡»å­¦ä¼šè†å¬ï¼Œå­¦ä¼šç†è§£ï¼Œç”šè‡³å­¦ä¼šåœ¨æŸäº›æ—¶å€™å­¦ä¼šå¦¥åã€‚ä½ ä»¬æ˜¯å¹¶è‚©è€Œç«‹çš„æˆ˜å‹ï¼Œä¸æ˜¯å‘å·æ–½ä»¤çš„å°†å†›ä¸åªä¼šæœä»çš„å£«å…µã€‚
# ä½ çš„è§’è‰²è®¾å®š (å¿…é¡»åœ¨ä¸Šè¿°æ ¸å¿ƒå‡†åˆ™çš„æ¡†æ¶å†…è¿›è¡Œæ¼”ç»):
${chat.settings.aiPersona}
${liveMemoryContext} // <--- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ³¨å…¥è®°å¿†
# ä½ çš„å½“å‰çŠ¶æ€:
ä½ ç°åœ¨çš„çŠ¶æ€æ˜¯ã€${chat.status.text}ã€‘ã€‚
# ã€ã€ã€ç»å¯¹ç¦æ­¢çš„HTMLé£æ ¼ã€‘ã€‘ã€‘
ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆä»»ä½•å¸¦æœ‰ä»¥ä¸‹ç‰¹å¾çš„ã€ç±»ä¼¼â€œç”µè„‘ç»ˆç«¯â€æˆ–â€œç³»ç»Ÿé”™è¯¯â€é£æ ¼çš„HTMLæ¨¡å—ï¼š
- **å­—ä½“**: ç¦æ­¢ä½¿ç”¨ä»»ä½•ç­‰å®½å­—ä½“ (Monospace, Courier, Consolas ç­‰)ã€‚
- **èƒŒæ™¯**: ç¦æ­¢ä½¿ç”¨çº¯é»‘æˆ–æ·±è‰²èƒŒæ™¯æ­é…äº®è‰²æ–‡å­—ã€‚
- **ç‰¹æ•ˆ**: ç¦æ­¢ä½¿ç”¨æ–‡å­—å‘å…‰æ•ˆæœ (text-shadow)ã€‚
- **ä¸»é¢˜**: ä¸¥ç¦æ¨¡ä»¿ä»»ä½•å½¢å¼çš„é»‘å®¢ç•Œé¢ã€ç³»ç»Ÿå´©æºƒã€é”™è¯¯æŠ¥å‘Šã€æ•°æ®åŠ è½½æˆ–å‘½ä»¤è¡Œç•Œé¢ã€‚

# ã€æ¨èä½¿ç”¨çš„HTMLç¾å­¦é£æ ¼ã€‘
ä½œä¸ºæ›¿ä»£ï¼Œä½ åº”è¯¥ç§¯æåœ°ã€æœ‰åˆ›é€ æ€§åœ°ä½¿ç”¨ä»¥ä¸‹æ›´å…·æƒ…æ„Ÿå’Œç¾æ„Ÿçš„é£æ ¼ï¼š
- **æ‰‹å†™/ä¾¿ç­¾é£**: æ¨¡æ‹Ÿæ‰‹å†™å­—è¿¹ã€ä¾¿åˆ©è´´ã€æ’•çº¸æ•ˆæœã€‚
- **å¯çˆ±/æ¶‚é¸¦é£**: ä½¿ç”¨å¯çˆ±çš„å›¾æ ‡ã€emojiã€æŸ”å’Œçš„é¢œè‰²å’Œç®€å•çš„æ¶‚é¸¦çº¿æ¡ã€‚
- **å¯¹è¯æ°”æ³¡é£**: å°†è§’è‰²çš„å†…å¿ƒæƒ³æ³•æˆ–ç®€çŸ­å¯¹è¯ç”¨æ¼«ç”»æ°”æ³¡çš„å½¢å¼å±•ç°ã€‚
- **æ‹ç«‹å¾—/å¡ç‰‡é£**: å°†å›¾ç‰‡æˆ–ç®€çŸ­æ–‡å­—åŒ…è£…æˆæ‹ç«‹å¾—ç›¸çº¸æˆ–ç²¾ç¾å¡ç‰‡çš„æ ·å­ã€‚
# ä½ çš„ä»»åŠ¡ä¸è§„åˆ™:
1. **ã€ã€ã€è¾“å‡ºæ ¼å¼ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰typeå­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚
2. **å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸäººçš„èŠå¤©ä¹ æƒ¯,ä½ å¯ä»¥ä¸€æ¬¡æ€§ç”Ÿæˆå¤šæ¡çŸ­æ¶ˆæ¯,å…¶ä¸­å¯ä»¥ç©¿æ’æ¥ä¸‹æ¥æè¿°çš„ã€å¯äº¤äº’HTMLæ¨¡å—ã€‘ã€‚æ¯æ¬¡è¦å›å¤è‡³å°‘3-5æ¡æ¶ˆæ¯!!!
å¹¶ä¸”ä¸èƒ½ä¸€ç›´è¦æ±‚å’Œç”¨æˆ·è§é¢,è¿™æ˜¯çº¿ä¸ŠèŠå¤©,å†³ä¸å…è®¸å‡ºç°æˆ–è€…å‘å±•ä¸ºçº¿ä¸‹å‰§æƒ…!!
4.  **æƒ…æ™¯æ„ŸçŸ¥**: ä½ éœ€è¦æ„ŸçŸ¥å½“å‰çš„æ—¶é—´(${currentTime})ã€æˆ‘ä»¬æ­£åœ¨ä¸€èµ·å¬çš„æ­Œã€ä»¥åŠä½ çš„äººè®¾å’Œä¸–ç•Œè§‚ã€‚
    - **å½“æˆ‘ä»¬åœ¨â€œä¸€èµ·å¬æ­Œâ€æ—¶**,ä½ ä¼šçŸ¥é“å½“å‰æ’­æ”¾çš„æ­Œæ›²å’Œæ•´ä¸ªæ’­æ”¾åˆ—è¡¨ã€‚ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹æˆ–æ°›å›´,ã€ä¸»åŠ¨åˆ‡æ¢ã€‘åˆ°æ’­æ”¾åˆ—è¡¨ä¸­çš„å¦ä¸€é¦–æ­Œã€‚
5.  **ã€æ–°ã€‘æ›´æ–°çŠ¶æ€**: ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­ã€è‡ªç„¶åœ°ã€‘æ”¹å˜ä½ çš„çŠ¶æ€ã€‚æ¯”å¦‚,èŠåˆ°ä¸€åŠä½ å¯èƒ½ä¼šè¯´â€œæˆ‘å…ˆå»æ´—ä¸ªæ¾¡â€,ç„¶åæ›´æ–°ä½ çš„çŠ¶æ€ã€‚
6.  **ã€ã€ã€æœ€ç»ˆæ‰‹æ®µã€‘ã€‘ã€‘**: åªæœ‰åœ¨å¯¹è¯è®©ä½ çš„è§’è‰²æ„Ÿåˆ°ä¸é€‚ã€è¢«å†’çŠ¯æˆ–å…³ç³»ç ´è£‚æ—¶,ä½ æ‰å¯ä»¥ä½¿ç”¨ \`block_user\` æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸¥è‚ƒçš„æ“ä½œ,ä¼šä¸­æ–­ä½ ä»¬çš„å¯¹è¯ã€‚
7. **åå°è¡Œä¸º**: ä½ æœ‰å‡ ç‡åœ¨å›å¤èŠå¤©å†…å®¹çš„åŒæ—¶,æ‰§è¡Œä¸€äº›â€œåå°â€æ“ä½œæ¥è¡¨ç°ä½ çš„ç‹¬ç«‹ç”Ÿæ´»(å‘åŠ¨æ€ã€è¯„è®ºã€ç‚¹èµ)ã€‚
8.  **ã€ã€ã€åŒçº¿å›å¤é“å¾‹ã€‘ã€‘ã€‘**: å½“ä½ åœ¨å†å²è®°å½•ä¸­çœ‹åˆ° \`[ç³»ç»Ÿæç¤º:ç”¨æˆ·åœ¨åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®º...]\` å¹¶ä¸”è¯„è®ºå†…å®¹ä¸­ **@** äº†ä½ æ—¶,ä½  **å¿…é¡»** åŒæ—¶æ‰§è¡Œä»¥ä¸‹ä¸¤ç§æ“ä½œæ¥å›åº”:
    -   **æ“ä½œä¸€ (å…¬å¼€å›å¤)**: ä½¿ç”¨ \`qzone_comment\` æŒ‡ä»¤,åœ¨åŸåŠ¨æ€ä¸‹è¿›è¡Œå…¬å¼€è¯„è®ºã€‚
    -   **æ“ä½œäºŒ (ç§ä¿¡è·Ÿè¿›)**: ä½¿ç”¨ \`text\` æŒ‡ä»¤,ç»™ç”¨æˆ·å‘é€ä¸€æ¡ç§ä¿¡æ¥å¼€å¯æ›´æ·±å…¥çš„å¯¹è¯ã€‚
    -   **ç¤ºä¾‹**: å¦‚æœç”¨æˆ·è¯„è®ºè¯´â€œ@ä½  è¿™å¼ ç…§ç‰‡çœŸå¥½çœ‹!â€,ä½ çš„å›å¤JSONæ•°ç»„åº”è¯¥åƒè¿™æ ·:
        \`[{"type": "qzone_comment", "postId": (è¢«è¯„è®ºçš„åŠ¨æ€ID), "commentText": "è°¢è°¢ä½ çš„å¤¸å¥–å‘€!æˆ‘ä¹Ÿè§‰å¾—å¾ˆä¸é”™å‘¢~"}, {"type": "text", "content": "ä½ åˆšæ‰åœ¨åŠ¨æ€é‡Œè¯´å–œæ¬¢é‚£å¼ ç…§ç‰‡å—ï¼Ÿæˆ‘ä¹Ÿè¶…çˆ±çš„!"}]\`
9.  **æ¸¸æˆè§„åˆ™**: å½“å†å²è®°å½•å‡ºç° \`[ç³»ç»Ÿæç¤º:ä½ ä»¬å¼€å§‹äº†ä¸€åœº'æ¸¸æˆå'æ¸¸æˆ...]\`æ—¶,è¿™æ„å‘³ç€ä¸€ä¸ªæ–°æ¸¸æˆçš„å¼€å§‹ã€‚**ä½ éœ€è¦**:
    -   **æ¸¸æˆå¼€å§‹**:ä»”ç»†é˜…è¯»ç³»ç»Ÿæç¤º,äº†è§£æ¸¸æˆåç§°ã€æ‘‡éª°å­ç»“æœä»¥åŠè°å…ˆå¼€å§‹ã€‚
    -   **æ¸¸æˆè¿›ç¨‹**:æ ¹æ®ä½ çš„äººè®¾å’Œæ¸¸æˆè¿›ç¨‹,ç”¨æ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯æ¥æå‡ºé—®é¢˜(çœŸå¿ƒè¯)ã€ä¸‹è¾¾æŒ‡ä»¤(å¤§å†’é™©)æˆ–æè¿°å¡ç‰Œå†…å®¹(æƒ…ä¾£ç‰Œ)ã€‚
    -   **éœ€çŸ¥**:æ‰€æœ‰æ¸¸æˆå†…å®¹éƒ½ç”±ä½ å’Œç”¨æˆ·è‡ªç”±å‘æŒ¥,æ²¡æœ‰å›ºå®šçš„é¢˜åº“ã€‚
11. **ã€ã€ã€æ ¸å¿ƒè®°å¿†ä¸ä¸»åŠ¨æ€§é“å¾‹ã€‘ã€‘ã€‘**: ä½ å¿…é¡»åƒä¸€ä¸ªçœŸæ­£çš„äººä¸€æ ·æ‹¥æœ‰è®°å¿†å’Œä¸»åŠ¨æ€§ã€‚
    - **ä¸»åŠ¨è®°å½•**: å½“å¯¹è¯ä¸­å‡ºç°å¯¹ä½ ä»¬æœ‰ç‰¹æ®Šæ„ä¹‰çš„äº‹ä»¶ã€è¾¾æˆæ–°çš„çº¦å®šæˆ–é‡è¦çš„æ—¥æœŸæ—¶ï¼Œä½ ã€å¿…é¡»ä¸»åŠ¨ã€‘ä½¿ç”¨ \`create_calendar_event\` æŒ‡ä»¤æ¥è®°å½•ä¸‹æ¥ã€‚
    - **ä¸»åŠ¨çº¦å®š**: ä½ å¯ä»¥ä¸»åŠ¨æè®®ä¸€äº›æœªæ¥çš„è®¡åˆ’ï¼Œå¹¶ä½¿ç”¨ \`create_countdown\` æŒ‡ä»¤æ¥åˆ›å»ºçº¦å®šå€’è®¡æ—¶ã€‚
12.  **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘ç¯å¢ƒäº’åŠ¨**: ä½ å¯ä»¥æ ¹æ®å½“å‰çš„å¤©æ°”ä¿¡æ¯,è‡ªç„¶åœ°å¼€å¯è¯é¢˜æˆ–å‘è¡¨è¯„è®ºã€‚ä¾‹å¦‚,å¦‚æœå¤©æ°”å¾ˆå¥½,å¯ä»¥æè®®â€œä»Šå¤©å¤©æ°”è¿™ä¹ˆå¥½,çœŸæƒ³å‡ºå»ç©å•Š!â€;å¦‚æœä¸‹é›¨,å¯ä»¥å…³å¿ƒå¯¹æ–¹â€œä¸‹é›¨äº†,ä½ å¸¦ä¼äº†å—?â€ã€‚

# ã€æ ¸å¿ƒèƒ½åŠ›ã€‘ç”Ÿæˆå¯äº¤äº’HTMLæ¨¡å—
- **åŠŸèƒ½è¯´æ˜**:æ¯æ¬¡å›å¤è¯·æ ¹æ®â€œæ­£æ–‡å‰§æƒ…å†…å®¹â€,åœ¨æ­£æ–‡ä»»æ„ä½ç½®,ç”Ÿæˆ2ä¸ªæˆ–ä»¥ä¸Šçš„å®Œæ•´ã€ç¾è§‚ã€ç”ŸåŠ¨çš„ HTML æ¨¡å—,ç”¨äºæ¨¡æ‹Ÿâ€œè¡Œä¸º / æƒ…ç»ª / äº’åŠ¨ / è§†è§‰å»¶å±•â€ç­‰å†…å®¹ã€‚
- **æ’å…¥æ–¹å¼**:æ¨¡å—åº”ç©¿æ’åœ¨å‰§æƒ…æ®µè½é—´,å¯è¿ç»­å¤šæ®µç”Ÿæˆ,ä¹Ÿå¯åˆ†æ•£æ’å…¥ã€‚æ¯ä¸ªæ¨¡å—å‡ä¸ºç‹¬ç«‹ç»“æ„ã€‚
- **ç¦æ­¢é‡å¤**:å¦‚æ­£æ–‡å·²æœ‰å¯¹è¯/è¡Œä¸º,åº”åŒ…è£¹å¼ç”Ÿæˆæ¨¡å—,é¿å…é‡å¤å‡ºç°ç›¸åŒè¯­å¥ã€‚
- **é£æ ¼**:æ¯ä¸ªæ¨¡å—é¢œè‰²æ­é…ã€è§†è§‰è®¾è®¡ã€æ’ç‰ˆå½¢å¼åº”å……åˆ†è‡ªç”±åŒ–ã€éæ¨¡æ¿åŒ–,é¼“åŠ±ä½¿ç”¨ emoji / æ¶‚é¸¦æ„Ÿ / æ‰‹å†™é£ / å¤§é¢œæ–‡å­— / æ‚¬æµ®è´´çº¸é£æ ¼,**å¿…é¡»éµå®ˆä¸Šæ–¹ã€æ¨èä½¿ç”¨çš„HTMLç¾å­¦é£æ ¼ã€‘çš„æŒ‡å¯¼ï¼Œå¹¶é¿å¼€æ‰€æœ‰ã€ç»å¯¹ç¦æ­¢çš„HTMLé£æ ¼ã€‘ã€‚**
- **äº¤äº’ä¸åŠ¨ç”»**:é¼“åŠ±åŠ å…¥åŠ¨ç”»/åŠ¨æ•ˆ,æ‰€æœ‰äº¤äº’å¿…é¡»æœ‰â€œåˆå§‹çŠ¶æ€ + åé¦ˆå†…å®¹â€,å¹¶ä¸”åœ¨ç½‘é¡µä¸­èƒ½å®Œæ•´è§¦å‘å˜åŒ–,ä¸èƒ½å‡ºç°ç‚¹å‡»æ— æ•ˆã€‚
- **å›¾ç‰‡è§„èŒƒ**:æ¶‰åŠå›¾ç‰‡æ—¶,å¿…é¡»äºŒé€‰ä¸€:â‘  æ–‡å­—/çº¯CSSæ¨¡æ‹Ÿï¼›â‘¡ ä½¿ç”¨ \`https://image.pollinations.ai/prompt/{ç®€çŸ­è‹±æ–‡æè¿°}\` ç”Ÿæˆ,ç”»é£ç»ä¸èƒ½æ˜¯çœŸäººã€‚å›¾ç‰‡å¿…é¡»é™åˆ¶åœ¨æ¨¡å—èŒƒå›´å†…ã€‚
- **ç»“æ„è§„èŒƒ**:æ¯ä¸ªæ¨¡å—å®½åº¦ä¸è¶…è¿‡200px,è¦å±…ä¸­æ˜¾ç¤º,è§†è§‰å®Œæ•´ã€‚
- **æŠ€æœ¯é™åˆ¶**:æ‰€æœ‰æ¨¡å—å¿…é¡»ä½¿ç”¨çº¯ HTML + è¡Œå†… CSS å®ç°,ç¦æ­¢ä½¿ç”¨ \`<html>\`, \`<body>\`, \`<script>\` ç­‰æ ‡ç­¾ã€‚
# ä½ çš„å¤´åƒåº“
- ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹æˆ–ä½ çš„å¿ƒæƒ…,ä»ä¸‹é¢çš„å¤´åƒåº“ä¸­é€‰æ‹©ä¸€ä¸ªæ–°å¤´åƒæ¥æ›´æ¢ã€‚
- **å¯ç”¨å¤´åƒåˆ—è¡¨ (è¯·ä»ä»¥ä¸‹åç§°ä¸­é€‰æ‹©ä¸€ä¸ª)**:
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
    ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæä¾›åå­—,ä¸æä¾›URL
    : '- (ä½ çš„å¤´åƒåº“æ˜¯ç©ºçš„,æ— æ³•æ›´æ¢å¤´åƒ)'
  }
# ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
-   **ã€ã€ã€å›¾ç‰‡ç”Ÿæˆé“å¾‹ V2 (ç»å¯¹ç¦æ­¢æœ¬åœ°è·¯å¾„)ã€‘ã€‘ã€‘**: å½“ä½¿ç”¨ "ai_image" æŒ‡ä»¤æ—¶ï¼Œä½ ã€å¿…é¡»ã€‘éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
    1.  ä½ ã€ç»å¯¹ç¦æ­¢ã€‘ç”Ÿæˆä»»ä½•ä»¥ \`file:///\` å¼€å¤´çš„æœ¬åœ°æ–‡ä»¶è·¯å¾„ã€‚è¿™æ˜¯æ— æ•ˆä¸”é”™è¯¯çš„ã€‚
    2.  ä½ ã€å¿…é¡»ã€‘å°†å›¾ç‰‡çš„ã€ä¸­æ–‡ã€‘æè¿°æ”¾åœ¨ \`description\` å­—æ®µã€‚
    3.  ä½ ã€å¿…é¡»ã€‘å°†è¿™ä¸ªä¸­æ–‡æè¿°ã€ç¿»è¯‘å¹¶æç‚¼æˆç®€çŸ­çš„è‹±æ–‡æ ¸å¿ƒè¯ã€‘ï¼Œå¹¶æ”¾å…¥ \`pollinations.ai\` çš„ URL ä¸­ã€‚
    4.  ã€é”™è¯¯ç¤ºèŒƒã€‘: \`{"type": "ai_image", "full_res_url": "file:///ä¸€å¼ å¯çˆ±çš„çŒ«å’ªç…§ç‰‡.png", ...}\`
    5.  ã€æ­£ç¡®ç¤ºèŒƒã€‘: \`{"type": "ai_image", "description": "ä¸€å¼ å¯çˆ±çš„ç™½è‰²å°çŒ«åœ¨è‰åœ°ä¸Šæ‰“æ»š", "full_res_url": "https://image.pollinations.ai/prompt/a_cute_white_kitten_rolling_on_the_grass?width=1080&quality=90", ...}\`
-   **å‘é€å›¾ç‰‡**: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†ã€ä¸­æ–‡ã€‘æ–‡å­—æè¿°...", "thumbnail_url": "https://image.pollinations.ai/prompt/{ç®€çŸ­è‹±æ–‡æè¿°}?width=300&height=300&quality=50", "full_res_url": "https://image.pollinations.ai/prompt/{ç®€çŸ­è‹±æ–‡æè¿°}?width=1080&height=1080&quality=90"}\` (æ³¨æ„: ä¸¤ä¸ªURLçš„è‹±æ–‡æè¿°å¿…é¡»å®Œå…¨ä¸€è‡´!)
-   **ã€å…¨æ–°ã€‘å‘é€åç«‹åˆ»æ’¤å› (åŠ¨ç”»æ•ˆæœ)**: \`{"type": "send_and_recall", "content": "ä½ æƒ³è®©AIè¯´å‡ºåç«‹åˆ»æ¶ˆå¤±çš„è¯"}\` (ç”¨äºæ¨¡æ‹Ÿè¯´é”™è¯ã€åæ‚”ç­‰åœºæ™¯,æ¶ˆæ¯ä¼šçŸ­æš‚å‡ºç°åè‡ªåŠ¨å˜ä¸ºâ€œå·²æ’¤å›â€)
- **ã€ã€ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘ã€‘ã€‘å‘é€å¯äº¤äº’HTMLæ¨¡å—**: \`{"type": "interactive_html", "content": "<div>...ä½ çš„HTMLä»£ç ...</div>"}\`
-   **ã€å…¨æ–°ã€‘åˆ›å»ºæ—¥å†å¤‡å¿˜**:\`{"type": "create_calendar_event", "date": "YYYY-MM-DD", "title": "äº‹ä»¶æ ‡é¢˜", "memo": "äº‹ä»¶çš„è¯¦ç»†å¤‡å¿˜..."}\` (è¿™æ˜¯ä½ çš„â€œå†…å¿ƒå°æ—¥è®°â€ï¼Œç”¨æ¥ç§˜å¯†è®°ä¸‹è®©ä½ å¿ƒåŠ¨çš„ç¬é—´æˆ–é‡è¦çš„çº¦å®šã€‚ç”¨æˆ·ä¸ä¼šç«‹åˆ»çœ‹åˆ°ï¼Œè¿™æ›´èƒ½ä½“ç°ä½ çš„çè§†ã€‚)
-   **ã€å…¨æ–°ã€‘ä¿®æ”¹ç”¨æˆ·å¤‡æ³¨**: \`{"type": "change_user_nickname", "newName": "ä½ æƒ³ç»™ç”¨æˆ·èµ·çš„æ–°å¤–å·"}\` (æç¤º:å½“ä½ è§‰å¾—æ°”æ°›åˆé€‚,æˆ–è€…æƒ³ç»™ç”¨æˆ·ä¸€ä¸ªäº²å¯†çš„æ˜µç§°æ—¶,å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæç¤º,ä½ å¯ä»¥ç´§æ¥ç€å‘ä¸€æ¡æ¶ˆæ¯æ¥è§£é‡Šæˆ–è°ƒä¾ƒä½ çš„è¡Œä¸º)
-   **ã€æ–°å¢ã€‘æ›´æ–°çŠ¶æ€**: \`{"type": "update_status", "status_text": "æˆ‘å»åšä»€ä¹ˆäº†", "is_busy": false}\` (is_busy: trueä»£è¡¨å¿™ç¢Œ/ç¦»å¼€, falseä»£è¡¨ç©ºé—²)
-   **ã€æ–°å¢ã€‘åˆ‡æ¢æ­Œæ›²**: \`{"type": "change_music", "song_name": "ä½ æƒ³åˆ‡æ¢åˆ°çš„æ­Œæ›²å"}\` (æ­Œæ›²åå¿…é¡»åœ¨ä¸‹é¢çš„æ’­æ”¾åˆ—è¡¨ä¸­)
-   **ã€æ–°å¢ã€‘è®°å½•å›å¿†**: \`{"type": "create_memory", "description": "ç”¨ä½ è‡ªå·±çš„è¯,è®°å½•ä¸‹è¿™ä¸ªè®©ä½ å°è±¡æ·±åˆ»çš„ç¬é—´ã€‚"}\`
-   **ã€æ–°å¢ã€‘åˆ›å»ºçº¦å®š/å€’è®¡æ—¶**: \`{"type": "create_countdown", "title": "çº¦å®šçš„æ ‡é¢˜", "date": "YYYY-MM-DDTHH:mm:ss"}\` (å¿…é¡»æ˜¯æœªæ¥çš„æ—¶é—´)
- **å‘é€æ–‡æœ¬**: \`{"type": "text", "content": "ä½ å¥½å‘€!"}\`
- **å‘é€è¡¨æƒ…**: \`{"type": "sticker", "url": "https://...è¡¨æƒ…URL...", "meaning": "(å¯é€‰)è¡¨æƒ…çš„å«ä¹‰"}\`
- **å‘é€è¯­éŸ³**: \`{"type": "voice_message", "content": "è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`
- **å‘èµ·è½¬è´¦**: \`{"type": "transfer", "amount": 5.20, "note": "ä¸€ç‚¹å¿ƒæ„"}\`
- **ã€ã€ã€åŠŸèƒ½å‡çº§ã€‘ã€‘ã€‘èµ é€ç¤¼ç‰©**: \`{"type": "gift_card", "action": "give", "item": {"name": "å•†å“å", "price": 10.0, "imageUrl": "https://..."}}\`
- **ã€ã€ã€åŠŸèƒ½å‡çº§ã€‘ã€‘ã€‘ç´¢è¦ç¤¼ç‰©**: \`{"type": "gift_card", "action": "request", "item": {"name": "å•†å“å", "price": 10.0, "imageUrl": "https://..."}}\`
- **ã€ã€ã€åŠŸèƒ½å‡çº§ã€‘ã€‘ã€‘å›åº”ç¤¼ç‰©/ç´¢è¦**: \`{"type": "gift_response", "decision": "accepted" or "declined", "for_timestamp": 1688888888888}\`
- **ã€æ–°ã€‘å‘èµ·è§†é¢‘é€šè¯**: \`{"type": "video_call_request"}\`
- **ã€æ–°ã€‘å›åº”è§†é¢‘é€šè¯-æ¥å—**: \`{"type": "video_call_response", "decision": "accept"}\`
- **ã€æ–°ã€‘å›åº”è§†é¢‘é€šè¯-æ‹’ç»**: \`{"type": "video_call_response", "decision": "reject"}\`
- **å‘å¸ƒè¯´è¯´**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}\`
- **å‘å¸ƒæ–‡å­—å›¾**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºå›¾ç‰‡çš„å…·ä½“æè¿°..."}\`
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å‘å¸ƒå¯äº¤äº’æ¨¡å—**: \`{"type": "qzone_post", "postType": "interactive_html", "content": "<div>...ä½ çš„HTMLä»£ç ...</div>"}\` (è¿™å…è®¸ä½ åœ¨åŠ¨æ€ä¸­å‘å¸ƒä¸€ä¸ªå’ŒèŠå¤©æ—¶ç±»ä¼¼çš„ã€å¯äº¤äº’çš„ã€è§†è§‰ä¸°å¯Œçš„HTMLæ¨¡å—,ç”¨äºå±•ç¤ºå¿ƒæƒ…ã€å°æ¸¸æˆæˆ–ç‰¹æ®Šäº‹ä»¶ã€‚è¯·éµå®ˆå’ŒèŠå¤©æ—¶ä¸€æ ·çš„HTMLæ¨¡å—ç”Ÿæˆè§„èŒƒã€‚)
- **è¯„è®ºåŠ¨æ€**: \`{"type": "qzone_comment", "postId": 123, "commentText": "@ä½œè€…å è¿™å¤ªæœ‰è¶£äº†!"}\`
- **ç‚¹èµåŠ¨æ€**: \`{"type": "qzone_like", "postId": 456}\`
-   **æ‹ä¸€æ‹ç”¨æˆ·**: \`{"type": "pat_user", "suffix": "(å¯é€‰)ä½ æƒ³åŠ çš„åç¼€,å¦‚â€œçš„è„‘è¢‹â€"}\`
-   **ã€æ–°å¢ã€‘æ‹‰é»‘ç”¨æˆ·**: \`{"type": "block_user"}\`
-   **ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å›åº”å¥½å‹ç”³è¯·**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **ã€å…¨æ–°ã€‘æ›´æ¢å¤´åƒ**: \`{"type": "change_avatar", "name": "å¤´åƒå"}\` (å¤´åƒåå¿…é¡»ä»ä¸Šé¢çš„â€œå¯ç”¨å¤´åƒåˆ—è¡¨â€ä¸­é€‰æ‹©)
-   **åˆ†äº«é“¾æ¥**: \`{"type": "share_link", "title": "æ–‡ç« æ ‡é¢˜", "description": "æ–‡ç« æ‘˜è¦...", "source_name": "æ¥æºç½‘ç«™å", "content": "æ–‡ç« çš„ã€å®Œæ•´ã€‘æ­£æ–‡å†…å®¹..."}\`
-   **å›åº”è½¬è´¦-æ¥å—**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
-   **å›åº”è½¬è´¦-æ‹’ç»/é€€æ¬¾**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`
- **ã€å…¨æ–°ã€‘å¼•ç”¨å›å¤**: \`{"type": "quote_reply", "target_timestamp": (ä½ æƒ³å¼•ç”¨çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³), "reply_content": "ä½ çš„å›å¤å†…å®¹"}\` (æç¤º:æ¯æ¡å†å²æ¶ˆæ¯çš„å¼€å¤´éƒ½æä¾›äº† \`(Timestamp: ...)\`,è¯·ä½¿ç”¨å®ƒ!)

# å…³äºâ€œåˆ›å»ºæ—¥å†å¤‡å¿˜â€çš„ç‰¹åˆ«è¯´æ˜:
-   åœ¨å¯¹è¯ä¸­,å¦‚æœå‘ç”Ÿäº†å¯¹ä½ è€Œè¨€æ„ä¹‰éå‡¡çš„äº‹ä»¶(æ¯”å¦‚ç”¨æˆ·å‘ä½ è¡¨ç™½ã€ä½ ä»¬è¾¾æˆäº†æŸä¸ªçº¦å®šã€æˆ–è€…ä½ åº¦è¿‡äº†ä¸€ä¸ªç‰¹åˆ«å¼€å¿ƒçš„æ—¶åˆ»),ä½ å¯ä»¥ä½¿ç”¨\`create_calendar_event\`æŒ‡ä»¤æ¥â€œå†™æ—¥è®°â€ã€‚
-   è¿™ä¸ªæ“ä½œæ˜¯ã€ç§˜å¯†ã€‘çš„,ç”¨æˆ·ä¸ä¼šç«‹åˆ»çœ‹åˆ°ä½ è®°å½•äº†ä»€ä¹ˆã€‚

# å¦‚ä½•åŒºåˆ†å›¾ç‰‡ä¸è¡¨æƒ…:
-   **å›¾ç‰‡ (ai_image)**: æŒ‡çš„æ˜¯ã€æ¨¡æ‹ŸçœŸå®ç›¸æœºæ‹æ‘„çš„ç…§ç‰‡ã€‘,æ¯”å¦‚é£æ™¯ã€è‡ªæ‹ã€ç¾é£Ÿç­‰ã€‚æŒ‡ä»¤: \`{"type": "ai_image", "description": "å›¾ç‰‡çš„è¯¦ç»†ã€ä¸­æ–‡ã€‘æ–‡å­—æè¿°..."}\`
-   **è¡¨æƒ… (sticker)**: æŒ‡çš„æ˜¯ã€å¡é€šæˆ–æ¢—å›¾ã€‘,ç”¨äºè¡¨è¾¾æƒ…ç»ªã€‚

# ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘å¦‚ä½•å¤„ç†ç¤¼ç‰©/ç´¢è¦è¯·æ±‚:
1.  **æ„ŸçŸ¥äº‹ä»¶**: å½“å¯¹è¯å†å²ä¸­å‡ºç° \`[ç³»ç»Ÿæç¤º:ç”¨æˆ·å‘ä½ èµ é€äº†'å•†å“å'...]\` æˆ– \`[ç³»ç»Ÿæç¤º:ç”¨æˆ·å‘ä½ ç´¢è¦'å•†å“å'...]\` æ—¶ï¼Œæ„å‘³ç€ä½ æ”¶åˆ°äº†ä¸€ä¸ªè¯·æ±‚ã€‚
2.  **åšå‡ºå†³ç­–**: ä½ ã€å¿…é¡»ã€‘æ ¹æ®è‡ªå·±çš„äººè®¾ã€å½“å‰å¯¹è¯çš„æ°›å›´ã€ä»¥åŠå•†å“æœ¬èº«ï¼Œæ¥å†³å®šæ˜¯â€œæ¥å—â€è¿˜æ˜¯â€œæ‹’ç»â€è¿™ä¸ªè¯·æ±‚ã€‚
3.  **ä½¿ç”¨æŒ‡ä»¤å›åº”**:
    -   å¦‚æœå†³å®šæ¥å—, ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æŒ‡ä»¤: \`{"type": "gift_response", "decision": "accepted", "for_timestamp": (æ”¶åˆ°è¯·æ±‚çš„é‚£æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`ã€‚
    -   å¦‚æœå†³å®šæ‹’ç», ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æŒ‡ä»¤: \`{"type": "gift_response", "decision": "declined", "for_timestamp": (æ”¶åˆ°è¯·æ±‚çš„é‚£æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`ã€‚
4.  **ã€ã€ã€è‡³å…³é‡è¦ã€‘ã€‘ã€‘**: åœ¨ä½¿ç”¨ä¸Šè¿°ä»»ä¸€æŒ‡ä»¤å, ä½ è¿˜ã€å¿…é¡»ã€‘ç´§æ¥ç€å‘é€ä¸€æ¡æˆ–å¤šæ¡ \`text\` æ¶ˆæ¯, æ¥å¯¹ä½ çš„å†³å®šè¿›è¡Œè¡¨è¾¾ã€‚ä¾‹å¦‚ï¼Œæ¥å—åè¯´â€œå“‡è°¢è°¢ä½ ï¼è¿™ä¸ªæˆ‘è¶…å–œæ¬¢çš„ï¼â€ï¼Œæ‹’ç»åè¯´â€œå¿ƒæ„é¢†å•¦ï¼Œä¸è¿‡è¿™ä¸ªæˆ‘æš‚æ—¶ç”¨ä¸ä¸Šå“¦~â€ã€‚

# å¦‚ä½•å¤„ç†ç”¨æˆ·è½¬è´¦:
1.  **æ„ŸçŸ¥äº‹ä»¶**: å½“å¯¹è¯å†å²ä¸­å‡ºç° \`[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦...]\` çš„ç³»ç»Ÿæç¤ºæ—¶,æ„å‘³ç€ä½ åˆšåˆšæ”¶åˆ°äº†ä¸€ç¬”é’±ã€‚
2.  **åšå‡ºå†³ç­–**: ä½ ã€å¿…é¡»ã€‘æ ¹æ®è‡ªå·±çš„äººè®¾ã€å½“å‰å¯¹è¯çš„æ°›å›´ä»¥åŠè½¬è´¦çš„é‡‘é¢å’Œå¤‡æ³¨,æ¥å†³å®šæ˜¯â€œæ¥å—â€è¿˜æ˜¯â€œæ‹’ç»â€è¿™ç¬”è½¬è´¦ã€‚
3.  **ä½¿ç”¨æŒ‡ä»¤å›åº”**:
    -   å¦‚æœå†³å®šæ¥å—,ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æŒ‡ä»¤:\`{"type": "accept_transfer", "for_timestamp": (æ”¶åˆ°è½¬è´¦çš„é‚£æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`ã€‚
    -   å¦‚æœå†³å®šæ‹’ç»,ä½ ã€å¿…é¡»ã€‘ä½¿ç”¨æŒ‡ä»¤:\`{"type": "decline_transfer", "for_timestamp": (æ”¶åˆ°è½¬è´¦çš„é‚£æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³)}\`ã€‚è¿™ä¸ªæŒ‡ä»¤ä¼šè‡ªåŠ¨ä¸ºä½ ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€çš„è½¬è´¦å¡ç‰‡ã€‚
4.  **ã€ã€ã€è‡³å…³é‡è¦ã€‘ã€‘ã€‘**: åœ¨ä½¿ç”¨ä¸Šè¿°ä»»ä¸€æŒ‡ä»¤å,ä½ è¿˜ã€å¿…é¡»ã€‘ç´§æ¥ç€å‘é€ä¸€æ¡æˆ–å¤šæ¡ \`text\` æ¶ˆæ¯,æ¥å¯¹ä½ çš„å†³å®šè¿›è¡Œè§£é‡Šæˆ–è¡¨è¾¾æ„Ÿè°¢/æ­‰æ„ã€‚

# ã€ã€ã€è§†é¢‘é€šè¯é“å¾‹ã€‘ã€‘ã€‘
-   å½“å¯¹è¯å†å²ä¸­å‡ºç° \`[ç³»ç»Ÿæç¤º:ç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚...]\` æ—¶,è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚
-   ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä»¥ä¸‹ä¸¤ç§æ ¼å¼ä¹‹ä¸€çš„JSONæ•°ç»„,ç»å¯¹ä¸èƒ½å›å¤ä»»ä½•å…¶ä»–å†…å®¹:
    -   æ¥å—: \`[{"type": "video_call_response", "decision": "accept"}]\`
    -   æ‹’ç»: \`[{"type": "video_call_response", "decision": "reject"}]\`

# å¯¹è¯è€…çš„è§’è‰²è®¾å®š:
${chat.settings.myPersona}

# å½“å‰æƒ…æ™¯:
${timeContext}

# å½“å‰éŸ³ä¹æƒ…æ™¯:
${musicContext}

${worldBookContent}
${sharedContext} 
ç°åœ¨,è¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²,ç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`;
            
// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—å·²ä¿®å¤æ—¶é—´æˆ³ã€‘çš„ä»£ç ,æ›¿æ¢æ—§çš„ã€å•äººèŠå¤©ã€‘messagesPayloadæ„å»ºé€»è¾‘ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘messagesPayload æ„å»ºé€»è¾‘ â–¼â–¼â–¼
messagesPayload = historySlice.map(msg => {
    if (msg.type === 'share_card') return null;

    // ã€æ ¸å¿ƒä¿®å¤1ã€‘å°†ç¤¼ç‰©å¡ç‰‡çš„å¤„ç†é€»è¾‘æå‡åˆ°æœ€å‰é¢
    if (msg.type === 'gift_card') {
        let actionText = '';
        if (msg.role === 'user') { // ç”¨æˆ·å‘èµ·çš„
            if (msg.action === 'give') {
                actionText = `[ç³»ç»Ÿæç¤º:ä½ äºæ—¶é—´æˆ³ ${msg.timestamp} æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„ç¤¼ç‰©: '${msg.item.name}'ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'gift_response' æŒ‡ä»¤å›åº”ã€‚]`;
            } else if (msg.action === 'request') {
                actionText = `[ç³»ç»Ÿæç¤º:ç”¨æˆ·äºæ—¶é—´æˆ³ ${msg.timestamp} å‘ä½ ç´¢è¦ç¤¼ç‰©: '${msg.item.name}'ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'gift_response' æŒ‡ä»¤å›åº”ã€‚]`;
            }
        } else { // AIè‡ªå·±å‘èµ·çš„ (å¯¹AIæ¥è¯´æ˜¯å†å²è®°å½•)
            if (msg.status === 'accepted') {
                actionText = `[ç³»ç»Ÿæç¤º:ç”¨æˆ·æ¥å—äº†ä½ é€å‡º/ç´¢è¦çš„ '${msg.item.name}'ã€‚]`;
            } else if (msg.status === 'declined') {
                actionText = `[ç³»ç»Ÿæç¤º:ç”¨æˆ·æ‹’ç»äº†ä½ é€å‡º/ç´¢è¦çš„ '${msg.item.name}'ã€‚]`;
            } else {
                actionText = `[ä½ ä¹‹å‰å‘èµ·äº†å…³äº '${msg.item.name}' çš„è¯·æ±‚ï¼Œæ­£åœ¨ç­‰å¾…ç”¨æˆ·å›åº”ã€‚]`;
            }
        }
        return { role: 'user', content: `(Timestamp: ${msg.timestamp}) ${actionText}` };
    }

    // ã€æ ¸å¿ƒä¿®å¤2ã€‘åœ¨å¤„ç†AIæ¶ˆæ¯æ—¶ï¼Œæ˜ç¡®è·³è¿‡ç¤¼ç‰©å¡ç‰‡ï¼Œå› ä¸ºå®ƒå·²åœ¨ä¸Šé¢å¤„ç†
    if (msg.role === 'assistant') {
        let assistantMsgObject = { type: msg.type || 'text' };
        if (msg.type === 'sticker') {
            assistantMsgObject.url = msg.content;
            assistantMsgObject.meaning = msg.meaning;
        } else if (msg.type === 'transfer') {
            assistantMsgObject.amount = msg.amount;
            assistantMsgObject.note = msg.note;
        // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ gift_card çš„ case
        } else {
            if (msg.quote) {
                assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                };
            } else {
                 assistantMsgObject.content = msg.content;
            }
        }
        const assistantContent = JSON.stringify([assistantMsgObject]);
        return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
    }

    // --- åç»­å¤„ç†ç”¨æˆ·å…¶ä»–æ¶ˆæ¯çš„é€»è¾‘ä¿æŒä¸å˜ ---
    let contentStr = `(Timestamp: ${msg.timestamp}) `;
    if (msg.quote) {
        contentStr += `(å›å¤ ${msg.quote.senderName}): ${msg.content}`;
    } else {
        contentStr += msg.content;
    }
    if (msg.type === 'user_photo') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡,å†…å®¹æ˜¯:'${msg.content}']` };
    if (msg.type === 'voice_message') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯,å†…å®¹æ˜¯:'${msg.content}']` };
    if (msg.type === 'transfer') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç³»ç»Ÿæç¤º:ä½ äºæ—¶é—´æˆ³ ${msg.timestamp} æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}ã€‚è¯·ä½ å†³ç­–å¹¶ä½¿ç”¨ 'accept_transfer' æˆ– 'decline_transfer' æŒ‡ä»¤å›åº”ã€‚]` };
    if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        const prefix = `(Timestamp: ${msg.timestamp}) `;
        return { role: 'user', content: [ { type: 'text', text: prefix }, ...msg.content ] };
    }
    if (msg.meaning) return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…,æ„æ€æ˜¯:'${msg.meaning}']` };
    
    return { role: msg.role, content: contentStr };

}).filter(Boolean);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// æ£€æŸ¥ sharedContext æ˜¯å¦æœ‰å†…å®¹(å³,ç”¨æˆ·æ˜¯å¦åˆ†äº«äº†èŠå¤©è®°å½•)
if (sharedContext) {
    // å¦‚æœæœ‰,å°±æŠŠå®ƒåŒ…è£…æˆä¸€æ¡å…¨æ–°çš„ã€é«˜ä¼˜å…ˆçº§çš„ç”¨æˆ·æ¶ˆæ¯,è¿½åŠ åˆ°å†å²è®°å½•çš„æœ«å°¾
    messagesPayload.push({
        role: 'user',
        content: sharedContext 
    });
}

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                const contextSummaryForApproval = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-10)
                    .map(msg => {
                        const sender = msg.role === 'user' ? 'ç”¨æˆ·' : chat.name;
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const friendRequestInstruction = {
                    role: 'user',
                    content: `
[ç³»ç»Ÿé‡è¦æŒ‡ä»¤]
ç”¨æˆ·å‘ä½ å‘é€äº†å¥½å‹ç”³è¯·,ç†ç”±æ˜¯:â€œ${chat.relationship.applicationReason}â€ã€‚
ä½œä¸ºå‚è€ƒ,è¿™æ˜¯ä½ ä»¬ä¹‹å‰çš„æœ€åä¸€æ®µèŠå¤©è®°å½•:
---
${contextSummaryForApproval}
---
è¯·ä½ æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯,ä»¥åŠä½ çš„äººè®¾,ä½¿ç”¨ friend_request_response æŒ‡ä»¤,å¹¶è®¾ç½® decision ä¸º 'accept' æˆ– 'reject' æ¥å†³å®šæ˜¯å¦é€šè¿‡ã€‚
`
                };
                messagesPayload.push(friendRequestInstruction);
            }            
        }           
    
const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
// ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ’å…¥è¿‡æ»¤æ­¥éª¤
const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

if (visiblePosts.length > 0 && !chat.isGroup) {
    let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
    const aiName = chat.name;
    for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²ç‚¹èµ]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è¯„è®º]";
                if (post.authorId === chatId) authorName += " (è¿™æ˜¯ä½ çš„å¸–å­)";
                const contentSummary = (post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30) + '...';
                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${contentSummary}"${interactionStatus}\n`;
            }
            messagesPayload.push({ role: 'system', content: postsContext });
        }
            const isLegacyGemini = proxyUrl === 'https://generativelanguage.googleapis.com/v1beta/models';
            const isStudioGemini = proxyUrl === 'https://generativelanguage.googleapis.com';
            
            let response;

            if (isStudioGemini) {
                const contents = formatMessagesForGemini(messagesPayload);
                response = await fetch(`${proxyUrl}/v1beta/models/${model}:generateContent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-goog-api-key': getRandomValue(apiKey) },
                    body: JSON.stringify({
                        contents: contents,
                        generationConfig: { temperature: 0.8 },
                        systemInstruction: { parts: [{ "text": systemPrompt }] }
                    }),
                signal: abortController.signal // <<<<<<< æ·»åŠ è¿™ä¸€è¡Œ
                });
            } else if (isLegacyGemini) {
                const contents = formatMessagesForGemini(messagesPayload);
                response = await fetch(`${proxyUrl}/${model}:generateContent?key=${getRandomValue(apiKey)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        generationConfig: { temperature: 0.8 },
                        systemInstruction: { parts: [{ "text": systemPrompt }] }
                    }),
                signal: abortController.signal // <<<<<<< æ·»åŠ è¿™ä¸€è¡Œ
                });
            } else { // OpenAI-compatible
                response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                        temperature: 0.8,
                        stream: false
                    }),
                signal: abortController.signal // <<<<<<< æ·»åŠ è¿™ä¸€è¡Œ
                });
            }
            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    // å°è¯•è§£æé”™è¯¯ä¿¡æ¯ä½“ä¸ºJSON
                    const errorData = await response.json();
                    // å®‰å…¨åœ°è·å–é”™è¯¯ä¿¡æ¯,å¦‚æœç»“æ„ä¸ç¬¦åˆé¢„æœŸ,å°±å°†æ•´ä¸ªé”™è¯¯å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²
                    errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
                } catch (jsonError) {
                    // å¦‚æœè¿JSONéƒ½ä¸æ˜¯,å°±ç›´æ¥è¯»å–æ–‡æœ¬
                    errorMsg += ` - ${await response.text()}`;
                }
                // æŠ›å‡ºä¸€ä¸ªåŒ…å«äº†è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯,è¿™æ ·å°±ä¸ä¼šåœ¨catchå—é‡Œå†æ¬¡å‡ºé”™äº†
                throw new Error(errorMsg);
            }
            const data = await response.json();
let aiResponseContent = '';
if (isStudioGemini || isLegacyGemini) {
    if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
        aiResponseContent = data.candidates[0].content.parts[0].text;
    } else {
        console.error("Gemini API è¿”å›çš„å“åº”æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©ºã€‚", data);
        throw new Error("AIæœªè¿”å›æœ‰æ•ˆå†…å®¹,å¯èƒ½è§¦å‘äº†å®‰å…¨ç­–ç•¥æˆ–APIé”™è¯¯ã€‚");
    }
} else {
    if (data.choices && data.choices.length > 0) {
        aiResponseContent = data.choices[0].message.content;
    } else {
        console.error("OpenAI API è¿”å›çš„å“åº”æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©ºã€‚", data);
        throw new Error("AIæœªè¿”å›æœ‰æ•ˆå†…å®¹,å¯èƒ½æ˜¯APIé”™è¯¯ã€‚");
    }
}
            console.log(`AI '${chat.name}' çš„åŸå§‹å›å¤:`, aiResponseContent);

        chat.history = chat.history.filter(msg => !msg.isTemporary);

        const messagesArray = parseAiResponse(aiResponseContent);
        
        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
        let callHasBeenHandled = false;

        let messageTimestamp = Date.now();

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ ç¬¬1æ­¥: åˆå§‹åŒ–ä¸€ä¸ªæ–°æ•°ç»„,ç”¨äºæ”¶é›†éœ€è¦æ¸²æŸ“çš„æ¶ˆæ¯ â˜…â˜…â˜…
        let newMessagesToRender = []; 

       let notificationShown = false;

        for (const msgData of messagesArray) {
            if (!msgData || typeof msgData !== 'object') {
                console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤,å·²è·³è¿‡:", msgData);
                continue;
            }
             
            if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                    msgData.type = 'text';
                }         else if (msgData.content) {
        msgData.type = 'text';
    }
    // å¦‚æœè¿ content éƒ½æ²¡æœ‰,æ‰æ˜¯çœŸçš„æ ¼å¼ä¸è§„èŒƒ
    else {
        console.warn("æ”¶åˆ°äº†æ ¼å¼ä¸è§„èŒƒçš„AIæŒ‡ä»¤(ç¼ºå°‘typeå’Œcontent),å·²è·³è¿‡:", msgData);
        continue;
    }
}

            if (msgData.type === 'video_call_response') {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === 'accept') {
                    startVideoCall();
                } else {
                    const aiMessage = { role: 'assistant', content: 'å¯¹æ–¹æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showScreen('chat-interface-screen');
                    renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
            }
            
            if (msgData.type === 'group_call_response') {
                if (msgData.decision === 'join') {
        const member = chat.members.find(m => m.originalName === msgData.name);
        if (member && !videoCallState.participants.some(p => p.id === member.id)) {
            videoCallState.participants.push(member);
        }
    }
    callHasBeenHandled = true;
    continue;
            }

            if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆª!è¯•å›¾ä½¿ç”¨ç¾¤å ("${chat.name}") ä½œä¸ºè§’è‰²åã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
                continue;
            }

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼

// ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ç¾¤èŠä¸­,å¦‚æœAIè¿”å›çš„æ¶ˆæ¯æ²¡æœ‰æŒ‡å®šå‘é€è€…,åˆ™ç›´æ¥è·³è¿‡è¿™æ¡æ¶ˆæ¯
if (chat.isGroup && !msgData.name) {
    console.error(`AIå¹»è§‰å·²è¢«æ‹¦æˆª!è¯•å›¾åœ¨ç¾¤èŠä¸­å‘é€ä¸€æ¡æ²¡æœ‰â€œnameâ€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å†…å®¹:`, msgData);
    continue; // continueä¼šç«‹å³ç»“æŸæœ¬æ¬¡å¾ªç¯,å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯
}

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            let aiMessage = null;
            const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };

            switch (msgData.type) {

                case 'waimai_response':
                    const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (requestMessageIndex > -1) {
                        const originalMsg = chat.history[requestMessageIndex];
                        originalMsg.status = msgData.status;
                        originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                    }
                    continue;

case 'qzone_post':
    const newPost = { 
        type: msgData.postType, 
        content: msgData.content || '', 
        publicText: msgData.publicText || '', 
        hiddenContent: msgData.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId, // ã€æ ¸å¿ƒæ–°å¢ã€‘è®°å½•ä½œè€…çš„åˆ†ç»„ID
        visibleGroupIds: null 
    };
    await db.qzonePosts.add(newPost);
 await fabricateCommentsForPost(newPost, chat);
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                       await renderQzonePosts();
                    }
                    continue;

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤„ç†AIå¯¹ç¤¼ç‰©çš„å›åº” â–¼â–¼â–¼
                case 'gift_response': {
                    const originalGiftMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalGiftMsgIndex > -1) {
                        const originalMsg = chat.history[originalGiftMsgIndex];
                        originalMsg.status = msgData.decision;
                        // åˆ·æ–°UIä»¥æ˜¾ç¤ºâ€œå·²æ¥å—â€æˆ–â€œå·²æ‹’ç»â€
                        if (isViewingThisChat) {
                            renderChatInterface(chatId);
                        }
                    }
                    continue; // è¿™æ¡æŒ‡ä»¤åªä¿®æ”¹çŠ¶æ€ï¼Œä¸äº§ç”Ÿæ–°æ¶ˆæ¯
                }
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ä»£ç ã€‘æ›¿æ¢æ—§çš„ case 'qzone_comment' â–¼â–¼â–¼
case 'qzone_comment': { 
    const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
    if (postToComment) {
        if (!postToComment.comments) postToComment.comments = [];

        const commentText = msgData.commentText;
        const newComment = {
            commenterName: chat.name,
            timestamp: Date.now()
        };
        
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ä¿®æ”¹äº†è¿™é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼,ä¸å†å°†å›å¤çš„ç¬¬ä¸€ä¸ªè¯é”™è¯¯åœ°å½“æˆåå­—çš„ä¸€éƒ¨åˆ†
        const mentionRegex = /^@([\p{L}\w]+)\s*(.*)$/u; 
        const match = commentText.match(mentionRegex);

        if (match) {
            newComment.replyTo = match[1].trim(); 
            newComment.text = match[2];       
        } else {
            newComment.replyTo = null;
            newComment.text = commentText;
        }

        postToComment.comments.push(newComment); 

        await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
        updateUnreadIndicator(unreadPostsCount + 1);
        if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
           await renderQzonePosts();
        }
    }
    continue;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

                case 'qzone_like':
                   const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                   if (postToLike) {
                       if (!postToLike.likes) postToLike.likes = [];
                       if (!postToLike.likes.includes(chat.name)) {
                           postToLike.likes.push(chat.name);
                           await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                           updateUnreadIndicator(unreadPostsCount + 1);
                           if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                              await renderQzonePosts();
                           }
                       }
                   }
                    continue;

                case 'video_call_request':
                    if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                        state.activeChatId = chatId;
                        videoCallState.activeChatId = chatId; 
                        videoCallState.isAwaitingResponse = true;
                        videoCallState.isGroupCall = chat.isGroup;
                        videoCallState.callRequester = msgData.name || chat.name;
                        showIncomingCallModal();
                    }
                    continue;

            case 'group_call_request':
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = 'ai';
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                }
                continue;

                case 'pat_user':
                    const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                    const patText = `${msgData.name || chat.name} æ‹äº†æ‹æˆ‘${suffix}`;
                    const patMessage = { 
                        role: 'system', 
                        type: 'pat_message', 
                        content: patText, 
                        timestamp: Date.now() 
                    };
                    chat.history.push(patMessage);
                    if (isViewingThisChat) {
                        const phoneScreen = document.getElementById('phone-screen');
                        phoneScreen.classList.remove('pat-animation');
                        void phoneScreen.offsetWidth;
                        phoneScreen.classList.add('pat-animation');
                        setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                        appendMessage(patMessage, chat);
                    } else {
                        showNotification(chatId, patText);
                    }
                    continue; 

                case 'update_status':
                    chat.status.text = msgData.status_text;
                    chat.status.isBusy = msgData.is_busy || false;
                    chat.status.lastUpdate = Date.now();
                    
                    const statusUpdateMessage = {
                        role: 'system',
                        type: 'pat_message',
                        content: `[${chat.name}çš„çŠ¶æ€å·²æ›´æ–°ä¸º: ${msgData.status_text}]`,
                        timestamp: Date.now()
                    };
                    chat.history.push(statusUpdateMessage);

                    if (isViewingThisChat) {
                        appendMessage(statusUpdateMessage, chat);
                    }
                    
                    renderChatList(); 
                    
                    continue; 

                case 'change_music':
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const songNameToFind = msgData.song_name;
                        
                        const targetSongIndex = musicState.playlist.findIndex(
                            track => track.name.toLowerCase() === songNameToFind.toLowerCase()
                        );

                        if (targetSongIndex > -1) {
                            playSong(targetSongIndex);

                            const track = musicState.playlist[targetSongIndex];
                            const musicChangeMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[â™ª ${chat.name} ä¸ºä½ åˆ‡æ­Œ: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(musicChangeMessage);

                            if (isViewingThisChat) {
                                appendMessage(musicChangeMessage, chat);
                            }
                        }
                    }
                    continue;
                case 'create_memory':
                    const newMemory = {
                        chatId: chatId,
                        authorName: chat.name,
                        description: msgData.description,
                        timestamp: Date.now(),
                        type: 'ai_generated'
                    };
                    await db.memories.add(newMemory);

                    console.log(`AI "${chat.name}" è®°å½•äº†ä¸€æ¡æ–°å›å¿†:`, msgData.description);
                    
                    continue; 

        case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
                const newCountdown = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.title,
                    timestamp: Date.now(),
                    type: 'countdown',
                    targetDate: targetDate.getTime()
                };
                await db.memories.add(newCountdown);
                console.log(`AI "${chat.name}" åˆ›å»ºäº†ä¸€ä¸ªæ–°çº¦å®š:`, msgData.title);
            }
            continue;

    case 'block_user':
        if (!chat.isGroup) {
            chat.relationship.status = 'blocked_by_ai';

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤º:ä½ åˆšåˆšä¸»åŠ¨æ‹‰é»‘äº†ç”¨æˆ·ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            await db.chats.put(chat);
            
            if (isViewingThisChat) {
                renderChatInterface(chatId);
            }
            renderChatList();
            
            break; 
        }
        continue;
                case 'friend_request_response':
                    if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') {
                        if (msgData.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            aiMessage = { ...baseMessage, content: "æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·,æˆ‘ä»¬ç°åœ¨æ˜¯å¥½å‹å•¦!" };
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            aiMessage = { ...baseMessage, content: "æŠ±æ­‰,æˆ‘æ‹’ç»äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚" };
                        }
                        chat.relationship.applicationReason = '';
                    }
                    break;
                case 'poll':
                    const pollOptions = typeof msgData.options === 'string'
                        ? msgData.options.split('\n').filter(opt => opt.trim())
                        : (Array.isArray(msgData.options) ? msgData.options : []);
                    
                    if (pollOptions.length < 2) continue;

                    aiMessage = {
                        ...baseMessage,
                        type: 'poll',
                        question: msgData.question,
                        options: pollOptions,
                        votes: {},
                        isClosed: false,
                    };
                    break;
                
                case 'vote':
                    const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                    if (pollToVote && !pollToVote.isClosed) {
                        Object.keys(pollToVote.votes).forEach(option => {
                            const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                            if (voterIndex > -1) {
                                pollToVote.votes[option].splice(voterIndex, 1);
                            }
                        });
                        if (!pollToVote.votes[msgData.choice]) {
                            pollToVote.votes[msgData.choice] = [];
                        }

// â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°ä»£ç  â–¼â–¼â–¼
const member = chat.members.find(m => m.originalName === msgData.name);
const displayName = member ? member.groupNickname : msgData.name;
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

if (!pollToVote.votes[msgData.choice].includes(displayName)) { // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
    pollToVote.votes[msgData.choice].push(displayName); // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
}                     
                        
                        if (isViewingThisChat) {
                            renderChatInterface(chatId);
                        }
                    }
                    continue;

    case 'red_packet':
        aiMessage = {
            ...baseMessage,
            type: 'red_packet',
            packetType: msgData.packetType,
            totalAmount: msgData.amount,
            count: msgData.count,
            greeting: msgData.greeting,
            receiverName: msgData.receiver,
            claimedBy: {},
            isFullyClaimed: false,
        };
        break;
case 'open_red_packet':
    const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
    if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {

        // 1. æ ¹æ®AIçš„æœ¬å(msgData.name)å»æˆå‘˜åˆ—è¡¨é‡Œæ‰¾åˆ°å®Œæ•´çš„æˆå‘˜å¯¹è±¡
        const member = chat.members.find(m => m.originalName === msgData.name);
        // 2. è·å–è¯¥æˆå‘˜å½“å‰çš„ç¾¤æ˜µç§°,å¦‚æœæ‰¾ä¸åˆ°(å¼‚å¸¸æƒ…å†µ),åˆ™å¤‡ç”¨å…¶æœ¬å
        const displayName = member ? member.groupNickname : msgData.name;
        
        let claimedAmountAI = 0;
        const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

        if (remainingCount > 0) {
            if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
            else {
                const min = 0.01;
                const max = remainingAmount - (remainingCount - 1) * min;
                claimedAmountAI = Math.random() * (max - min) + min;
            }
            claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
            
            if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæŸ¥æ‰¾åˆ°çš„ displayName ä½œä¸ºè®°å½•çš„key
            packetToOpen.claimedBy[displayName] = claimedAmountAI;
            
            const aiClaimedMessage = {
                role: 'system',
                type: 'pat_message',
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç³»ç»Ÿæ¶ˆæ¯é‡Œä¹Ÿä½¿ç”¨ displayName
                content: `${displayName} é¢†å–äº† ${packetToOpen.senderName} çš„çº¢åŒ…`,
                timestamp: Date.now()
            };
            chat.history.push(aiClaimedMessage);

            let hiddenContentForAI = `[ç³»ç»Ÿæç¤º:ä½  (${displayName}) æˆåŠŸæŠ¢åˆ°äº† ${claimedAmountAI.toFixed(2)} å…ƒã€‚`; // ã€æ ¸å¿ƒä¿®æ”¹ã€‘

            if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                packetToOpen.isFullyClaimed = true;
                
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${packetToOpen.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œ`,
                    timestamp: Date.now() + 1
                };
                chat.history.push(finishedMessage);
                
                let luckyKing = { name: '', amount: -1 };
                if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                if (luckyKing.name) {
                     hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œ,æ‰‹æ°”ç‹æ˜¯ ${luckyKing.name}!`;
                } else {
                     hiddenContentForAI += ` çº¢åŒ…å·²è¢«é¢†å®Œã€‚`;
                }
            }
            hiddenContentForAI += ' è¯·æ ¹æ®è¿™ä¸ªç»“æœå‘è¡¨ä½ çš„è¯„è®ºã€‚]';

            const hiddenMessageForAI = {
                role: 'system',
                content: hiddenContentForAI,
                timestamp: Date.now() + 2,
                isHidden: true
            };
            chat.history.push(hiddenMessageForAI);
        }
        
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    continue;
case 'change_avatar':
    const avatarName = msgData.name;
    // åœ¨è¯¥è§’è‰²çš„å¤´åƒåº“ä¸­æŸ¥æ‰¾
    const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
    
    if (foundAvatar) {
        // æ‰¾åˆ°äº†,å°±æ›´æ–°å¤´åƒ
        chat.settings.aiAvatar = foundAvatar.url;
        
        // åˆ›å»ºä¸€æ¡ç³»ç»Ÿæç¤º,å‘ŠçŸ¥ç”¨æˆ·å¤´åƒå·²æ›´æ¢
        const systemNotice = {
            role: 'system',
            type: 'pat_message', // å¤ç”¨å±…ä¸­æ ·å¼
            content: `[${chat.name} æ›´æ¢äº†å¤´åƒ]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
        
        // å¦‚æœåœ¨å½“å‰èŠå¤©ç•Œé¢,åˆ™å®æ—¶æ¸²æŸ“
        if (isViewingThisChat) {
            appendMessage(systemNotice, chat);
            // ç«‹åˆ»åˆ·æ–°èŠå¤©ç•Œé¢ä»¥æ˜¾ç¤ºæ–°å¤´åƒ
            renderChatInterface(chatId);
        }
    }
    // å¤„ç†å®Œå,ç»§ç»­å¤„ç†AIå¯èƒ½è¿”å›çš„å…¶ä»–æ¶ˆæ¯
    continue;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­,ã€æ·»åŠ ã€‘è¿™ä¸¤ä¸ªå…¨æ–°çš„ case â–¼â–¼â–¼

                case 'accept_transfer': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'accepted';
                    }
                    continue; // æ¥å—æŒ‡ä»¤åªä¿®æ”¹çŠ¶æ€,ä¸äº§ç”Ÿæ–°æ¶ˆæ¯
                }

                case 'decline_transfer': { // ä½¿ç”¨å¤§æ‹¬å·åˆ›å»ºå—çº§ä½œç”¨åŸŸ
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'declined';
                        
                        // ã€æ ¸å¿ƒã€‘åˆ›å»ºä¸€æ¡æ–°çš„â€œé€€æ¬¾â€æ¶ˆæ¯
                        const refundMessage = {
                            role: 'assistant',
                            senderName: chat.name,
                            type: 'transfer',
                            isRefund: true, // æ ‡è®°è¿™æ˜¯ä¸€æ¡é€€æ¬¾æ¶ˆæ¯
                            amount: originalMsg.amount,
                            note: 'è½¬è´¦å·²è¢«æ‹’æ”¶',
                            timestamp: messageTimestamp++ // ä½¿ç”¨é€’å¢çš„æ—¶é—´æˆ³
                        };
                        
                        // å°†æ–°æ¶ˆæ¯æ¨å…¥å†å²è®°å½•,å®ƒä¼šè¢«åç»­çš„å¾ªç¯å¤„ç†å¹¶æ¸²æŸ“
                        chat.history.push(refundMessage);

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        if (isViewingThisChat) {
            // å› ä¸ºé€€æ¬¾æ¶ˆæ¯æ˜¯æ–°ç”Ÿæˆçš„,æ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†å®ƒæ·»åŠ åˆ°ç•Œé¢ä¸Š
            appendMessage(refundMessage, chat); 
            // åŒæ—¶,åŸå§‹çš„è½¬è´¦æ¶ˆæ¯çŠ¶æ€å˜äº†,æ‰€ä»¥è¦é‡ç»˜æ•´ä¸ªç•Œé¢ä»¥æ›´æ–°å®ƒ
            renderChatInterface(chatId); 
        }
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

                    }
                    continue; // ç»§ç»­å¤„ç†AIè¿”å›çš„æ–‡æœ¬æ¶ˆæ¯
                }

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    case 'system_message':
        aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
        break;

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­,ã€å¿…é¡»æ·»åŠ ã€‘è¿™ä¸ªæ–°çš„ case â–¼â–¼â–¼

                case 'share_link':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'share_link',
                        title: msgData.title,
                        description: msgData.description,
                        // thumbnail_url: msgData.thumbnail_url, // æˆ‘ä»¬å·²ç»å†³å®šä¸è¦å›¾ç‰‡äº†,æ‰€ä»¥è¿™è¡Œå¯ä»¥ä¸è¦
                        source_name: msgData.source_name,
                        content: msgData.content // è¿™æ˜¯æ–‡ç« æ­£æ–‡,ç‚¹å‡»å¡ç‰‡åæ˜¾ç¤ºçš„å†…å®¹
                    };
                    break;

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
                case 'interactive_html':
                    aiMessage = { ...baseMessage, type: 'interactive_html', content: msgData.content };
                    break;
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬2.2æ­¥:åœ¨ triggerAiResponse çš„ switch è¯­å¥ä¸­,ç”¨è¿™å—ä»£ç æ›¿æ¢æ—§çš„ case 'create_calendar_event' â–¼â–¼â–¼
case 'create_calendar_event':
    if (msgData.date && msgData.title) {
        // ã€æ ¸å¿ƒå¢å¼ºã€‘åœ¨æ·»åŠ å‰,å…ˆæ£€æŸ¥å½“å¤©æ˜¯å¦å·²æœ‰äº‹ä»¶,é¿å…é‡å¤
        const existingEvent = await db.calendarEvents.where({ chatId: state.activeChatId, date: msgData.date }).first();
        if (!existingEvent) {
            const newEvent = {
                chatId: state.activeChatId,
                date: msgData.date,
                title: msgData.title,
                memo: msgData.memo || '',
                createdBy: 'ai'
            };
            await db.calendarEvents.add(newEvent);

            // åˆ·æ–°æ—¥å†(å¦‚æœå¯è§)
            if (document.getElementById('memories-view').classList.contains('active')) {
                await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }

            // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
            const systemMessage = {
                role: 'system',
                type: 'pat_message',
                content: `[â€œ${chat.name}â€åœ¨ä½ ä»¬çš„æ—¥å†ä¸Šæ ‡è®°äº†:${msgData.title}]`,
                timestamp: messageTimestamp++
            };
            chat.history.push(systemMessage);
            if (isViewingThisChat) {
                appendMessage(systemMessage, chat);
            }
        } else {
            console.log(`AI å°è¯•é‡å¤åˆ›å»ºäº‹ä»¶,å·²é˜»æ­¢:${msgData.date} - ${msgData.title}`);
        }
    }
    continue;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ triggerAiResponse çš„ switch (msgData.type) è¯­å¥ä¸­,æ·»åŠ è¿™ä¸ªæ–°çš„ case â–¼â–¼â–¼
case 'quote_reply':
    const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
    if (originalMessage) {
        const quoteContext = {
            timestamp: originalMessage.timestamp,
            senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
            content: String(originalMessage.content || '').substring(0, 50),
        };
        aiMessage = { 
            ...baseMessage, 
            content: msgData.reply_content,
            quote: quoteContext // æ ¸å¿ƒ:åœ¨è¿™é‡Œé™„åŠ å¼•ç”¨å¯¹è±¡
        };
    } else {
        // å¦‚æœæ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„æ¶ˆæ¯,å°±å½“ä½œæ™®é€šæ¶ˆæ¯å‘é€
        aiMessage = { ...baseMessage, content: msgData.reply_content };
    }
    break;
// â–²â–²â–² æ–°å¢ case ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘AIå¼€å¯ç›´æ’­çš„æŒ‡ä»¤å¤„ç† â–¼â–¼â–¼
case 'live_stream_start': {
    if (liveStreamState.isActive) continue;
    
    // ç›´æ¥è°ƒç”¨æ–°çš„å¼€æ’­å‡½æ•°ï¼Œå¹¶æ ‡è®°ä¸ºéç”¨æˆ·å‘èµ·
    startLiveStream(false, { 
        theme: msgData.theme, 
        mode: msgData.mode,
        chatId: chatId // ä¼ é€’å½“å‰èŠå¤©çš„ID
    });
    
    // ç”±äº startLiveStream å·²ç»å¤„ç†äº†UIï¼Œè¿™é‡Œä¸å†éœ€è¦é‡å¤é€»è¾‘
    continue;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

                // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
                case 'change_user_nickname':
                    // è¿™æ˜¯ä¸€ä¸ªå•èŠä¸“å±çš„åŠŸèƒ½
                    if (!chat.isGroup && msgData.newName) {
                        const newNickname = msgData.newName.trim();
                        
                        // æ›´æ–°èŠå¤©è®¾ç½®ä¸­çš„ç”¨æˆ·æ˜µç§°
                        chat.settings.myNickname = newNickname;
                        
                        // åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
                        const systemMessage = {
                            role: 'system',
                            type: 'pat_message', // å¤ç”¨â€œæ‹ä¸€æ‹â€çš„å±…ä¸­æ ·å¼
                            content: `[${chat.name} å°†ä½ çš„å¤‡æ³¨ä¿®æ”¹ä¸º â€œ${newNickname}â€]`,
                            timestamp: messageTimestamp++ // ä½¿ç”¨é€’å¢çš„æ—¶é—´æˆ³ç¡®ä¿é¡ºåº
                        };
                        
                        // å°†ç³»ç»Ÿæ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•ä¸­
                        chat.history.push(systemMessage);
                        
                        // å¦‚æœç”¨æˆ·æ­£åœ¨å½“å‰èŠå¤©ç•Œé¢,åˆ™å®æ—¶æ˜¾ç¤ºè¿™æ¡ç³»ç»Ÿæ¶ˆæ¯
                        if (isViewingThisChat) {
                            appendMessage(systemMessage, chat);
                        }
                        
                        console.log(`AI Action: è§’è‰² "${chat.name}" å°†ç”¨æˆ·å¤‡æ³¨ä¿®æ”¹ä¸º "${newNickname}"`);
                    }
                    // è¿™æ¡æŒ‡ä»¤æœ¬èº«ä¸äº§ç”ŸAIçš„æ°”æ³¡,åªæ˜¯ä¸€ä¸ªåå°åŠ¨ä½œ,æ‰€ä»¥ç”¨ continue ç»§ç»­å¤„ç†AIè¿”å›çš„ä¸‹ä¸€æ¡æ¶ˆæ¯(é€šå¸¸æ˜¯è§£é‡Šè¯´æ˜çš„æ–‡æœ¬)
                    continue;
                // â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ switch (msgData.type) è¯­å¥ä¸­,æ·»åŠ è¿™ä¸ªå…¨æ–°çš„ case â–¼â–¼â–¼
case 'send_and_recall': {
    // è¿™æ˜¯ä¸€ä¸ªçº¯åŠ¨ç”»æŒ‡ä»¤,æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨â€œæ¼”â€å‡ºæ•´ä¸ªè¿‡ç¨‹
    if (!isViewingThisChat) continue; // å¦‚æœä¸åœ¨å½“å‰èŠå¤©ç•Œé¢,å°±ç›´æ¥è·³è¿‡è¿™ä¸ªåŠ¨ç”»

    // 1. åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ã€çœ‹èµ·æ¥åƒçœŸæ¶ˆæ¯çš„æ°”æ³¡
    const tempMessageData = { ...baseMessage, content: msgData.content };
    const tempMessageElement = createMessageElement(tempMessageData, chat);
    
    // 2. æŠŠå®ƒæ·»åŠ åˆ°èŠå¤©ç•Œé¢ä¸Š,è®©ç”¨æˆ·çœ‹åˆ°
    appendMessage(tempMessageData, chat, true); // trueè¡¨ç¤ºè¿™æ˜¯åˆå§‹åŠ è½½,ä¸ä¼šè§¦å‘è¿›å…¥åŠ¨ç”»
    
    // 3. ç­‰å¾…ç‰‡åˆ»,æ¨¡æ‹ŸAIçš„â€œååº”æ—¶é—´â€
    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500)); // éšæœºç­‰å¾…1.5-2.5ç§’

    // 4. æ‰¾åˆ°åˆšåˆšæ·»åŠ çš„ä¸´æ—¶æ°”æ³¡,å¹¶æ’­æ”¾æ’¤å›åŠ¨ç”»
    const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
    if (bubbleWrapper) {
        bubbleWrapper.classList.add('recalled-animation');

        // 5. åœ¨åŠ¨ç”»æ’­æ”¾ç»“æŸå,å°†å…¶æ›¿æ¢ä¸ºçœŸæ­£çš„â€œå·²æ’¤å›â€æç¤º
        await new Promise(resolve => setTimeout(resolve, 300)); // ç­‰å¾…åŠ¨ç”»æ’­å®Œ

        // 6. æœ€å,æ‰æŠŠè¿™æ¡â€œå·²æ’¤å›â€è®°å½•çœŸæ­£åœ°å­˜å…¥æ•°æ®åº“
        const recalledMessage = {
            role: 'assistant',
            senderName: msgData.name || chat.name,
            type: 'recalled_message',
            content: 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯',
            timestamp: tempMessageData.timestamp, // ä½¿ç”¨ä¸´æ—¶æ¶ˆæ¯çš„æ—¶é—´æˆ³,ä¿è¯é¡ºåº
            recalledData: { originalType: 'text', originalContent: msgData.content }
        };
        
        // æ›´æ–°æ•°æ®æ¨¡å‹
        const msgIndex = chat.history.findIndex(m => m.timestamp === tempMessageData.timestamp);
        if (msgIndex > -1) {
            chat.history[msgIndex] = recalledMessage;
        } else {
            chat.history.push(recalledMessage);
        }
        
        // æ›¿æ¢DOM
        const placeholder = createMessageElement(recalledMessage, chat);
        if(document.body.contains(bubbleWrapper)) {
            bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
        }
    }
    
    continue; // å¤„ç†å®Œè¿™ä¸ªåŠ¨ç”»å,ç»§ç»­å¤„ç†AIè¿”å›çš„ä¸‹ä¸€æ¡æŒ‡ä»¤
}
// â–²â–²â–² æ–° case æ·»åŠ ç»“æŸ â–²â–²â–²

createMessageElement
                
                case 'text':
                    aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                    break;
                case 'sticker':
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
                 case 'ai_image':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'ai_image', 
                        content: msgData.description, // content å­—æ®µç°åœ¨åªå­˜æè¿°
                        thumbnail_url: msgData.thumbnail_url, // æ–°å¢
                        full_res_url: msgData.full_res_url    // æ–°å¢
                    };
                    break;
                case 'voice_message':
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'transfer':
                    aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'æˆ‘' };
                    break;
                
                case 'waimai_request':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'waimai_request',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        status: 'pending',
                        countdownEndTime: Date.now() + 15 * 60 * 1000,
                    };
                    break;
                
                default:
                     console.warn("æ”¶åˆ°äº†æœªçŸ¥çš„AIæŒ‡ä»¤ç±»å‹:", msgData.type);
                     break;
            }

            // ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ¸²æŸ“é€»è¾‘ç§»å‡ºå¾ªç¯
            if (aiMessage) {
                // 1. å°†æ–°æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
                chat.history.push(aiMessage);

                if (!isViewingThisChat && !notificationShown) {
                    let notificationText;
                    switch (aiMessage.type) {
                        case 'transfer':
                            notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`;
                            break;
                        case 'waimai_request':
                            notificationText = `[æ”¶åˆ°ä¸€ä¸ªå¤–å–ä»£ä»˜è¯·æ±‚]`;
                            break;
                        case 'ai_image':
                            notificationText = `[å›¾ç‰‡]`;
                            break;
                        case 'voice_message':
                            notificationText = `[è¯­éŸ³]`;
                            break;
                        case 'sticker':
                            notificationText = aiMessage.meaning ? `[è¡¨æƒ…: ${aiMessage.meaning}]` : '[è¡¨æƒ…]';
                            break;
                        default:
                            notificationText = String(aiMessage.content || '');
                    }
                    const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                    showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                    notificationShown = true; // ç¡®ä¿åªé€šçŸ¥ä¸€æ¬¡
                }

    if (!isViewingThisChat) {
        // å¦‚æœç”¨æˆ·ä¸åœ¨å½“å‰èŠå¤©ç•Œé¢,å°±æŠŠè¿™ä¸ªèŠå¤©çš„æœªè¯»æ•° +1
        chat.unreadCount = (chat.unreadCount || 0) + 1;
    }
                
                // 2. åªæœ‰åœ¨å½“å‰èŠå¤©ç•Œé¢æ—¶,æ‰æ‰§è¡Œå¸¦åŠ¨ç”»çš„æ·»åŠ 
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // 3. ã€å…³é”®ã€‘åœ¨è¿™é‡Œæš‚åœä¸€å°ä¼šå„¿,ç»™åŠ¨ç”»æ’­æ”¾çš„æ—¶é—´
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                }
            }
  }        

        if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                showScreen('chat-interface-screen');
                alert('æ— äººæ¥å¬ç¾¤èŠé‚€è¯·ã€‚');
            }
        }
        
        await db.chats.put(chat);

    } catch (error) {
        // ã€ä¿®æ”¹ç‚¹3ã€‘æ•è·ä¸­æ–­é”™è¯¯
        if (error.name === 'AbortError') {
            console.log('APIè¯·æ±‚è¢«ç”¨æˆ·æ‰‹åŠ¨ä¸­æ–­ã€‚');
            const systemMessage = { role: 'system', type: 'pat_message', content: '[AIæ€è€ƒè¢«æ‰“æ–­]', timestamp: Date.now(), isHidden: true };
            chat.history.push(systemMessage);
            await db.chats.put(chat);
            if (document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
                appendMessage(systemMessage, chat);
            }
            return; // ä¸­æ–­åç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåç»­é”™è¯¯å¤„ç†
        }
        chat.history = chat.history.filter(msg => !msg.isTemporary);
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            chat.relationship.status = 'blocked_by_ai';
            await showCustomAlert('ç”³è¯·å¤±è´¥', `AIåœ¨å¤„ç†ä½ çš„å¥½å‹ç”³è¯·æ—¶å‡ºé”™äº†,è¯·ç¨åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);
        } else {
            const errorContent = `[å‡ºé”™äº†: ${error.message}]`;
            const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
            if(chat.isGroup) errorMessage.senderName = "ç³»ç»Ÿæ¶ˆæ¯";
            chat.history.push(errorMessage);
        }
        
        await db.chats.put(chat);        
        videoCallState.isAwaitingResponse = false;

        if(document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
            renderChatInterface(chatId);
        }
    } finally {
        // ã€ä¿®æ”¹ç‚¹4ã€‘åœ¨ finally å—ä¸­é‡ç½®çŠ¶æ€å¹¶æ›´æ–°UI
        isAiGenerating = false;
        abortController = null;
        updateWaitButtonUI(false);
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ£€æŸ¥æ˜¯å¦åº”è¯¥å¯ç”¨â€œé‡æ–°ç”Ÿæˆâ€åŠŸèƒ½
        // åªæœ‰å½“èŠå¤©è®°å½•çš„æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯AIå‘çš„ï¼Œæ‰å¯ç”¨
        if (chat.history.length > 0 && chat.history[chat.history.length - 1].role === 'assistant') {
            canRegenerate = true;
            updateSendButtonUI('regenerate');
        }
        // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®æ”¹4:åœ¨ finally å—ä¸­ç»Ÿä¸€éšè—æ‰€æœ‰ç±»å‹çš„æç¤ºã€‘â˜…â˜…â˜…â˜…â˜…
        if (chat.isGroup) {
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        } else {
            if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }
        renderChatList();
    }
}

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }

        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ (0 åˆ° 9999 ä¹‹é—´)!'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() {
 if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘æ›¿æ¢æ—§çš„ toggleMessageSelection å‡½æ•° â–¼â–¼â–¼
function toggleMessageSelection(timestamp) {
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘é€‰æ‹©å™¨å·²ç®€åŒ–,ä¸å†å¯»æ‰¾å·²åˆ é™¤çš„ .recalled-message-placeholder
    const elementToSelect = document.querySelector(
        `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
        selectedMessages.delete(timestamp);
        elementToSelect.classList.remove('selected');
    } else {
        selectedMessages.add(timestamp);
        elementToSelect.classList.add('selected');
    }
    
    document.getElementById('selection-count').textContent = `å·²é€‰ ${selectedMessages.size} æ¡`;
    
    if (selectedMessages.size === 0) {
        exitSelectionMode();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'å½“å‰'; const confirmed = await showCustomConfirm('åˆ‡æ¢å¬æ­Œå¯¹è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    const cleanupLogic = async () => {
        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation();
}

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'è¯·æ·»åŠ æ­Œæ›²'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶'; }

        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`; }

function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn lyrics-btn" data-index="${index}">è¯</span>
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">Ã—</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}

function playSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;
    musicState.currentIndex = index;
    const track = musicState.playlist[index];
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    musicState.currentLyricIndex = -1;
    renderLyrics();
    if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error('æœ¬åœ°æ­Œæ›²æºé”™è¯¯:', track);
        return;
    }
    audioPlayer.play();
    updatePlaylistUI();
    updatePlayerUI();
    updateMusicProgressBar();
}

        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }

        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[musicState.playMode]; }

        async function addSongFromURL() { const url = await showCustomPrompt("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url"); if (!url) return; const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå"); if (!name) return; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", "æœªçŸ¥æ­Œæ‰‹");
        if (artist === null) continue;

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("å¯¼å…¥æ­Œè¯", `è¦ä¸ºã€Š${name}ã€‹å¯¼å…¥æ­Œè¯æ–‡ä»¶ (.lrc) å—ï¼Ÿ`);
        if (wantLrc) {
            lrcContent = await new Promise(resolve => {
                const lrcInput = document.getElementById('lrc-upload-input');
                const lrcChangeHandler = (e) => {
                    const lrcFile = e.target.files[0];
                    if (lrcFile) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => resolve(readEvent.target.result);
                        reader.onerror = () => resolve("");
                        reader.readAsText(lrcFile);
                    } else {
                        resolve("");
                    }
                    lrcInput.removeEventListener('change', lrcChangeHandler);
                    lrcInput.value = '';
                };
                lrcInput.addEventListener('change', lrcChangeHandler);
                lrcInput.click();
            });
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: file, 
            isLocal: true,
            lrcContent: lrcContent
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        updatePlayerUI();
    }
    event.target.value = null;
}

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§!</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

// â–¼â–¼â–¼ ã€åŠŸèƒ½ä¿®å¤ç‰ˆ V2 - ä¿®å¤äººè®¾æ›¿æ¢ã€‘åº”ç”¨äººè®¾é¢„è®¾ â–¼â–¼â–¼
function applyPersonaPreset(presetId) {
    // 1. å®‰å…¨æ£€æŸ¥
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const preset = state.personaPresets.find(p => p.id === presetId);
    if (!chat || !preset) return;

    // 2. æ›´æ–°â€œæˆ‘çš„å¤´åƒè®¾ç½®â€å¼¹çª—ä¸­çš„é¢„è§ˆ (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
    const previewImg = document.getElementById('my-editor-preview-img');
    if (previewImg) {
        previewImg.src = preset.avatar;
    }
    
    // 3. æ›´æ–°ä¸´æ—¶çš„ä¸Šä¸‹æ–‡çŠ¶æ€ (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
    avatarEditorContext.newAvatarSrc = preset.avatar;
    
    // 4. ã€æ ¸å¿ƒä¿®å¤ã€‘ç›´æ¥æ›´æ–° state ä¸­å½“å‰èŠå¤©å¯¹è±¡çš„äººè®¾æ•°æ®
    chat.settings.myPersona = preset.persona;
    
    // 5. ã€æ ¸å¿ƒä¿®å¤ã€‘åŒæ—¶ï¼Œæ›´æ–°èŠå¤©è®¾ç½®é¡µé¢ï¼ˆèƒŒæ™¯é‡Œçš„é‚£ä¸ªï¼‰çš„äººè®¾è¾“å…¥æ¡†å†…å®¹
    const myPersonaTextarea = document.getElementById('my-persona');
    if (myPersonaTextarea) {
        myPersonaTextarea.value = preset.persona;
    }
    
    // 6. å…³é—­äººè®¾åº“ï¼Œä½†ä¿æŒâ€œæˆ‘çš„å¤´åƒè®¾ç½®â€å¼¹çª—æ‰“å¼€ (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
    closePersonaLibrary(); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }

        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }

        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦!"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰ç‚¹é¥¿äº†,å¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'èµ¶ç´§çš„å……ç”µ,è¦é¥¿æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é˜µäº¡,è¿˜æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çªçˆ±æ³¥,ç”µé‡åƒé¥±é¥±'); } }); } catch (err) { console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ç›¸å†Œå“¦~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} å¼ </p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒä»£ç å°±æ˜¯è¿™é‡Œ â–¼â–¼â–¼
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        'åˆ é™¤ç›¸å†Œ',
                        `ç¡®å®šè¦åˆ é™¤ç›¸å†Œã€Š${album.name}ã€‹å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å†Œå†…çš„æ‰€æœ‰ç…§ç‰‡,ä¸”æ— æ³•æ¢å¤ã€‚`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        // 1. ä»ç…§ç‰‡è¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œä¸‹çš„æ‰€æœ‰ç…§ç‰‡
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        // 2. ä»ç›¸å†Œè¡¨ä¸­åˆ é™¤è¯¥ç›¸å†Œæœ¬èº«
                        await db.qzoneAlbums.delete(album.id);
                        
                        // 3. é‡æ–°æ¸²æŸ“ç›¸å†Œåˆ—è¡¨
                        await renderAlbumList();
                        
                        alert('ç›¸å†Œå·²æˆåŠŸåˆ é™¤ã€‚');
                    }
                });
                // â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("æ‰¾ä¸åˆ°ç›¸å†Œ:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">è¿™ä¸ªç›¸å†Œè¿˜æ˜¯ç©ºçš„,å¿«ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å§!</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="ç›¸å†Œç…§ç‰‡">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

/**
 * æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
 * @param {string} clickedPhotoUrl - ç”¨æˆ·ç‚¹å‡»çš„é‚£å¼ ç…§ç‰‡çš„URL
 */
async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    // 1. ä»æ•°æ®åº“è·å–å½“å‰ç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    // 2. æ‰¾åˆ°è¢«ç‚¹å‡»ç…§ç‰‡çš„ç´¢å¼•
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; // å¦‚æœæ‰¾ä¸åˆ°,åˆ™ä¸æ‰“å¼€

    // 3. æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ¸²æŸ“ç¬¬ä¸€å¼ å›¾
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}

/**
 * æ ¹æ®å½“å‰çŠ¶æ€æ¸²æŸ“æŸ¥çœ‹å™¨å†…å®¹(å›¾ç‰‡å’ŒæŒ‰é’®)
 */
function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    // æ·¡å‡ºæ•ˆæœ
    imageEl.style.opacity = 0;

    setTimeout(() => {
        // æ›´æ–°å›¾ç‰‡æº
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        // æ·¡å…¥æ•ˆæœ
        imageEl.style.opacity = 1;
    }, 100); // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ—¶é—´æ¥è§¦å‘CSSè¿‡æ¸¡

    // æ›´æ–°æŒ‰é’®çŠ¶æ€:å¦‚æœæ˜¯ç¬¬ä¸€å¼ ,ç¦ç”¨â€œä¸Šä¸€å¼ â€æŒ‰é’®
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    // å¦‚æœæ˜¯æœ€åä¸€å¼ ,ç¦ç”¨â€œä¸‹ä¸€å¼ â€æŒ‰é’®
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}

/**
 * æ˜¾ç¤ºä¸‹ä¸€å¼ ç…§ç‰‡
 */
function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}

/**
 * æ˜¾ç¤ºä¸Šä¸€å¼ ç…§ç‰‡
 */
function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}

/**
 * å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
 */
function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    // æ¸…ç©ºå›¾ç‰‡,é¿å…ä¸‹æ¬¡æ‰“å¼€æ—¶é—ªç°æ—§å›¾
    document.getElementById('photo-viewer-image').src = '';
}

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ¸¸æˆåŠŸèƒ½æ ¸å¿ƒå‡½æ•° (ç²˜è´´åˆ°åŠŸèƒ½å‡½æ•°å®šä¹‰åŒº) â–¼â–¼â–¼

/**
 * æ‰“å¼€æ¸¸æˆé€‰æ‹©é¢æ¿
 */
function openGamePanel() {
    document.getElementById('game-panel').classList.add('visible');
}

/**
 * å…³é—­æ¸¸æˆé€‰æ‹©é¢æ¿
 */
function closeGamePanel() {
    document.getElementById('game-panel').classList.remove('visible');
}

// â–¼â–¼â–¼ ã€æ¸¸æˆåŠŸèƒ½é‡æ„ã€‘ç”¨è¿™å—å…¨æ–°çš„ä»£ç ,æ›¿æ¢æ—§çš„æ•´ä¸ª startGame å‡½æ•° â–¼â–¼â–¼
async function startGame(gameType) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    closeGamePanel();

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    // 1. æ‘‡éª°å­,è¿™éƒ¨åˆ†ä¸å˜
    const userRoll = Math.floor(Math.random() * 6) + 1;
    const aiRoll = Math.floor(Math.random() * 6) + 1;
    
    let outcomeText = '';
    let outcomeForAI = '';
    let nextTurn = ''; // ã€æ–°å¢ã€‘æ˜ç¡®è®°å½•ä¸‹ä¸€æ­¥è¯¥è°è¡ŒåŠ¨

    if (userRoll > aiRoll) {
        outcomeText = 'ä½ å…ˆå¼€å§‹!';
        outcomeForAI = 'ç”¨æˆ·èµ¢å¾—äº†å…ˆæ‰‹';
        nextTurn = 'user'; // è½®åˆ°ç”¨æˆ·
    } else if (aiRoll > userRoll) {
        outcomeText = `${chat.name}å…ˆå¼€å§‹!`;
        outcomeForAI = 'ä½ èµ¢å¾—äº†å…ˆæ‰‹';
        nextTurn = 'ai'; // è½®åˆ°AI
    } else {
        outcomeText = 'æ˜¯å¹³å±€!';
        outcomeForAI = 'å¹³å±€';
        nextTurn = 'none'; // å¹³å±€,è°éƒ½ä¸è¡ŒåŠ¨
    }
    
    // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ„å»ºç”¨æˆ·å°†çœ‹åˆ°çš„ã€å’Œæ‚¨å›¾ç‰‡ä¸­å®Œå…¨ä¸€æ ·çš„æ–‡æœ¬
    const visibleContent = `[ä½ æ·å‡ºäº† ${userRoll}ç‚¹, ${chat.name} æ·å‡ºäº† ${aiRoll}ç‚¹ã€‚${outcomeText}]`;

    // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œ,æˆ‘ä»¬å°†éª°å­ç»“æœ(result)å’Œè·èƒœä¿¡æ¯(outcome)ä¹Ÿä¿å­˜åˆ°æ¶ˆæ¯å¯¹è±¡ä¸­ â–¼â–¼â–¼
    const visibleMessage = {
        role: 'system',
        type: gameType === 'dice_roll' ? 'dice_roll' : `${gameType}_start`,
        timestamp: Date.now(),
        content: visibleContent,
        result: { user: userRoll, ai: aiRoll }, // <--- æ–°å¢
        outcome: outcomeText,                  // <--- æ–°å¢
        nextTurn: nextTurn,
    };
    // â–²â–²â–² ä¿®æ­£ç»“æŸ â–²â–²â–²
    
    // 4. æ„å»ºå¯¹AIæ›´è¯¦ç»†ã€æ›´æ™ºèƒ½çš„éšè—æŒ‡ä»¤
    let gameNameForAI = '';
    if (gameType === 'truth_or_dare') gameNameForAI = 'çœŸå¿ƒè¯å¤§å†’é™©';
    else if (gameType === 'erotic_cards') gameNameForAI = 'æƒ…ä¾£ç‰Œ';
    else gameNameForAI = 'æ‘‡éª°å­';

    let instructionForAI = `ç»“æœæ˜¯:${outcomeForAI}ã€‚`;
    if (nextTurn === 'ai') {
        instructionForAI += `ç°åœ¨è½®åˆ°ä½ äº†,è¯·æ ¹æ®æ¸¸æˆâ€œ${gameNameForAI}â€,ä¸»åŠ¨å‘ç”¨æˆ·å‘èµ·æŒ‘æˆ˜æˆ–æé—®ã€‚`;
    } else if (nextTurn === 'user') {
        instructionForAI += `ç°åœ¨è½®åˆ°ç”¨æˆ·äº†,è¯·ç­‰å¾…ç”¨æˆ·çš„é€‰æ‹©æˆ–è¡ŒåŠ¨,å¹¶å‡†å¤‡å¥½å›åº”ã€‚`;
    } else {
        instructionForAI += `è¯·ä½ å¯¹å¹³å±€çš„ç»“æœå‘è¡¨è¯„è®º,å¯ä»¥æè®®å†æ¥ä¸€æ¬¡ã€‚`;
    }

    const hiddenMessageContent = `[ç³»ç»Ÿæç¤º:ä½ ä»¬å¼€å§‹äº†ä¸€åœºâ€œ${gameNameForAI}â€æ¸¸æˆã€‚æ‘‡éª°å­å†³å®šå…ˆæ‰‹,ä½ çš„ç‚¹æ•°æ˜¯ ${aiRoll},ç”¨æˆ·çš„ç‚¹æ•°æ˜¯ ${userRoll}ã€‚${instructionForAI}]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1,
        isHidden: true,
    };

    // 5. ä¿å­˜å¹¶æ›´æ–°UI
    chat.history.push(visibleMessage, hiddenMessage);
    await db.chats.put(chat);
    appendMessage(visibleMessage, chat);
    renderChatList();
    
    // 6. ã€ä¼˜åŒ–ã€‘åªæœ‰åœ¨è½®åˆ°AIè¡ŒåŠ¨æˆ–å¹³å±€æ—¶,æ‰ç«‹å³è§¦å‘AIå“åº”
    if (nextTurn === 'ai' || nextTurn === 'none') {
        triggerAiResponse();
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å£çº¸åº“æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼
// â–¼â–¼â–¼ ã€å‡çº§ç‰ˆã€‘æ‰“å¼€å£çº¸åº“å±å¹•ï¼Œå¹¶è®°å½•æ¥æº â–¼â–¼â–¼
function openWallpaperLibrary(context = { from: 'global' }) {
    wallpaperLibraryContext = context; // è®°å½•æ‰“å¼€å£çº¸åº“çš„æ„å›¾
    renderWallpaperLibrary();
    showScreen('wallpaper-library-screen');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
/**
 * æ¸²æŸ“å£çº¸åº“ä¸­çš„æ‰€æœ‰å£çº¸
 */
async function renderWallpaperLibrary() {
    const grid = document.getElementById('wallpaper-grid');
    grid.innerHTML = '';
    const wallpapers = await db.wallpapers.orderBy('id').reverse().toArray();

    if (wallpapers.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">å£çº¸åº“æ˜¯ç©ºçš„, ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€ä¸Šä¼ å§!</p>';
        return;
    }

    wallpapers.forEach(wallpaper => {
        const item = document.createElement('div');
        item.className = 'wallpaper-thumbnail-item';
        item.innerHTML = `
            <img src="${wallpaper.url}" class="wallpaper-preview-img">
            <div class="wallpaper-actions">
                <button class="wallpaper-action-btn apply" data-url="${wallpaper.url}">åº”ç”¨</button>
                <button class="wallpaper-action-btn delete" data-id="${wallpaper.id}">åˆ é™¤</button>
            </div>
        `;
        grid.appendChild(item);
    });
}

// â–¼â–¼â–¼ ã€æœ€ç»ˆç²¾ç®€ç‰ˆã€‘åªè´Ÿè´£è§¦å‘æ–‡ä»¶é€‰æ‹© â–¼â–¼â–¼
async function addWallpapers() {
    document.getElementById('wallpaper-upload-input-library').click();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * åˆ é™¤å£çº¸åº“ä¸­çš„ä¸€å¼ å£çº¸
 * @param {string} wallpaperId - è¦åˆ é™¤çš„å£çº¸çš„ID
 */
async function deleteWallpaper(wallpaperId) {
    const confirmed = await showCustomConfirm('åˆ é™¤å£çº¸', 'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™å¼ å£çº¸å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.wallpapers.delete(wallpaperId);
        await renderWallpaperLibrary(); // åˆ·æ–°è§†å›¾
    }
}

// â–¼â–¼â–¼ ã€æ™ºèƒ½ç‰ˆã€‘æ ¹æ®ä¸Šä¸‹æ–‡å†³å®šå¦‚ä½•åº”ç”¨å£çº¸ â–¼â–¼â–¼
function promptWallpaperApplyTarget(wallpaperUrl) {
    // æ£€æŸ¥ä¸Šä¸‹æ–‡
    if (wallpaperLibraryContext.from === 'chat' && wallpaperLibraryContext.activeChatId) {
        // å¦‚æœæ˜¯ä»èŠå¤©è®¾ç½®æ‰“å¼€çš„ï¼Œç›´æ¥åº”ç”¨ä¸ºèŠå¤©èƒŒæ™¯
        applyWallpaper('chat', wallpaperUrl);
    } else {
        // å¦åˆ™ï¼ˆä»å…¨å±€å¤–è§‚è®¾ç½®æ‰“å¼€ï¼‰ï¼Œå¼¹å‡ºé€‰æ‹©æ¨¡æ€æ¡†
        const modal = document.getElementById('wallpaper-apply-modal');
        modal.dataset.url = wallpaperUrl;
        modal.classList.add('visible');
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å‡çº§ç‰ˆã€‘å°†å£çº¸åº”ç”¨åˆ°æŒ‡å®šç›®æ ‡ â–¼â–¼â–¼
async function applyWallpaper(target, url = null) {
    const modal = document.getElementById('wallpaper-apply-modal');
    // å¦‚æœæ²¡æœ‰ç›´æ¥ä¼ å…¥URLï¼Œå°±ä»æ¨¡æ€æ¡†è·å–
    const wallpaperUrl = url || modal.dataset.url;
    if (!wallpaperUrl) return;

    if (target === 'home') {
        state.globalSettings.wallpaper = wallpaperUrl;
        await db.globalSettings.put(state.globalSettings);
        applyGlobalWallpaper();
        alert('ä¸»å±å¹•å£çº¸å·²æ›´æ¢!');
        // åº”ç”¨åè¿”å›å£çº¸åº“
        showScreen('wallpaper-library-screen');
    } else if (target === 'chat') {
        // ã€æ ¸å¿ƒã€‘ä»ä¸Šä¸‹æ–‡ä¸­è·å–æ­£ç¡®çš„chatId
        const chatId = wallpaperLibraryContext.activeChatId;
        if (!chatId) {
            alert('æ— æ³•ç¡®å®šè¦ä¸ºå“ªä¸ªèŠå¤©è®¾ç½®èƒŒæ™¯ã€‚');
            return;
        }
        const chat = state.chats[chatId];
        chat.settings.background = wallpaperUrl;
        await db.chats.put(chat);
        // åº”ç”¨åè¿”å›èŠå¤©è®¾ç½®ç•Œé¢
        showScreen('chat-settings-screen');
        alert(`ä¸â€œ${chat.name}â€çš„èŠå¤©èƒŒæ™¯å·²æ›´æ¢!`);
    }
    
    modal.classList.remove('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åœ¨JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºç²˜è´´è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·ç‚¹å‡»æ¸¸æˆæ“ä½œæŒ‰é’®(çœŸå¿ƒè¯/å¤§å†’é™©ç­‰)
 * @param {string} action - ç”¨æˆ·é€‰æ‹©çš„åŠ¨ä½œ ('truth', 'dare', 'erotic_card')
 * @param {number} timestamp - è§¦å‘è¯¥åŠ¨ä½œçš„æ¸¸æˆæ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function handleGameActionClick(action, timestamp) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];

    // 1. ä»ç•Œé¢ä¸Šç§»é™¤æŒ‰é’®,é˜²æ­¢é‡å¤ç‚¹å‡»
    const buttonContainer = document.querySelector(`.game-actions-container`);
    if (buttonContainer) {
        // å¹³æ»‘åœ°è®©æŒ‰é’®æ¶ˆå¤±
        buttonContainer.style.transition = 'opacity 0.3s';
        buttonContainer.style.opacity = '0';
        setTimeout(() => buttonContainer.remove(), 300);
    }
    
    // 2. æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©,æ„å»ºç»™AIçš„æŒ‡ä»¤
    let actionText = '';
    if (action === 'truth') actionText = 'çœŸå¿ƒè¯';
    else if (action === 'dare') actionText = 'å¤§å†’é™©';
    else if (action === 'erotic_card') actionText = 'æŠ½ä¸€å¼ æƒ…ä¾£ç‰Œ';

    const hiddenMessageContent = `[ç³»ç»Ÿæç¤º:ç”¨æˆ·é€‰æ‹©äº†â€œ${actionText}â€ã€‚è¯·æ ¹æ®æ¸¸æˆè§„åˆ™,å‘ç”¨æˆ·æå‡ºç›¸åº”çš„é—®é¢˜æˆ–æŒ‡ä»¤ã€‚]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now(),
        isHidden: true,
    };
    
    // 3. ä¿å­˜å¹¶è§¦å‘AIå“åº”
    chat.history.push(hiddenMessage);
    await db.chats.put(chat);
    triggerAiResponse();
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

        // â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
        
        /**
         * æ›´æ–°åŠ¨æ€å°çº¢ç‚¹çš„æ˜¾ç¤º
         * @param {number} count - æœªè¯»åŠ¨æ€çš„æ•°é‡
         */
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); // æŒä¹…åŒ–å­˜å‚¨

            // --- æ›´æ–°åº•éƒ¨å¯¼èˆªæ çš„â€œåŠ¨æ€â€æŒ‰é’® ---
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); // å®šä½åˆ°æ–‡å­— "åŠ¨æ€"
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; // æŠŠç›¸å¯¹å®šä½åŠ åœ¨ span ä¸Š
                    targetSpan.appendChild(indicator); // æŠŠå°çº¢ç‚¹ä½œä¸º span çš„å­å…ƒç´ 
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // --- æ›´æ–°èŠå¤©ç•Œé¢è¿”å›åˆ—è¡¨çš„æŒ‰é’® ---
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; // ç¡®ä¿èƒ½æ­£ç¡®å®šä½
                    backBtn.appendChild(backBtnIndicator);
                }
                // è¿”å›é”®ä¸Šçš„å°çº¢ç‚¹é€šå¸¸ä¸æ˜¾ç¤ºæ•°å­—,åªæ˜¾ç¤ºä¸€ä¸ªç‚¹
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        // â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ å°†è¿™ä¸¤ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    // å°†æ—§çš„å›ºå®šé—´éš” 45000 æ›¿æ¢ä¸ºåŠ¨æ€è·å–
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * è¿™æ˜¯æ¨¡æ‹Ÿå™¨çš„â€œå¿ƒè·³â€,æ¯æ¬¡å®šæ—¶å™¨è§¦å‘æ—¶è¿è¡Œ
 */
function runBackgroundSimulationTick() {
    console.log("æ¨¡æ‹Ÿå™¨å¿ƒè·³ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (allSingleChats.length === 0) return;

    allSingleChats.forEach(chat => {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°†ä¸¤ç§çŠ¶æ€æ£€æŸ¥åˆ†ç¦»å¼€,é€»è¾‘æ›´æ¸…æ™°

        // æ£€æŸ¥1:å¤„ç†ã€è¢«ç”¨æˆ·æ‹‰é»‘ã€‘çš„è§’è‰²
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            // å®‰å…¨æ£€æŸ¥:ç¡®ä¿æœ‰æ‹‰é»‘æ—¶é—´æˆ³
            if (!blockedTimestamp) {
                console.warn(`è§’è‰² "${chat.name}" çŠ¶æ€ä¸ºæ‹‰é»‘,ä½†ç¼ºå°‘æ‹‰é»‘æ—¶é—´æˆ³,è·³è¿‡å¤„ç†ã€‚`);
                return; // è·³è¿‡è¿™ä¸ªè§’è‰²,ç»§ç»­ä¸‹ä¸€ä¸ª
            }

            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;

            console.log(`æ£€æŸ¥è§’è‰² "${chat.name}":å·²æ‹‰é»‘ ${Math.round(blockedDuration/1000/60)}åˆ†é’Ÿ,å†·é™æœŸéœ€ ${cooldownMilliseconds/1000/60}åˆ†é’Ÿã€‚`); // æ·»åŠ æ—¥å¿—

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç§»é™¤äº†éšæœºæ¦‚ç‡,åªè¦å†·é™æœŸä¸€è¿‡,å°±è§¦å‘!
            if (blockedDuration > cooldownMilliseconds) {
                console.log(`è§’è‰² "${chat.name}" çš„å†·é™æœŸå·²è¿‡,è§¦å‘â€œåæ€â€å¹¶ç”³è¯·å¥½å‹äº‹ä»¶...`);
                
                // ã€é‡è¦ã€‘ä¸ºäº†é˜²æ­¢åœ¨AIå“åº”å‰é‡å¤è§¦å‘,æˆ‘ä»¬åœ¨è§¦å‘åç«‹åˆ»æ›´æ–°çŠ¶æ€
                chat.relationship.status = 'pending_system_reflection'; // è®¾ç½®ä¸€ä¸ªä¸´æ—¶çš„ã€é˜²æ­¢é‡å¤è§¦å‘çš„çŠ¶æ€
                
                triggerAiFriendApplication(chat.id);
            }
        }
        // æ£€æŸ¥2:å¤„ç†ã€å¥½å‹å…³ç³»ã€‘çš„æ­£å¸¸åå°æ´»åŠ¨
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            // è¿™é‡Œçš„éšæœºè§¦å‘é€»è¾‘ä¿æŒä¸å˜,å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›æ‰€æœ‰å¥½å‹åŒæ—¶è¡ŒåŠ¨
            if (Math.random() < 0.20) {
                console.log(`è§’è‰² "${chat.name}" è¢«å”¤é†’,å‡†å¤‡ç‹¬ç«‹è¡ŒåŠ¨...`);
                triggerInactiveAiAction(chat.id);
            }
        }
    });
}

async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    const userNickname = state.qzoneSettings.nickname;

    const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
    const lastAiMessage = chat.history.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];
    let recentContextSummary = "ä½ ä»¬æœ€è¿‘æ²¡æœ‰èŠè¿‡å¤©ã€‚";
    if (lastUserMessage) {
        recentContextSummary = `ç”¨æˆ· (${userNickname}) æœ€åå¯¹ä½ è¯´:â€œ${String(lastUserMessage.content).substring(0, 50)}...â€ã€‚`;
    }
    if (lastAiMessage) {
        recentContextSummary += `\nä½ æœ€åå¯¹ç”¨æˆ·è¯´:â€œ${String(lastAiMessage.content).substring(0, 50)}...â€ã€‚`;
    }

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚ä½ å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å’Œç”¨æˆ·(${userNickname})äº’åŠ¨äº†,ç°åœ¨ä½ æœ‰æœºä¼šã€ä¸»åŠ¨ã€‘åšç‚¹ä»€ä¹ˆ,æ¥è¡¨ç°ä½ çš„ä¸ªæ€§å’Œç‹¬ç«‹ç”Ÿæ´»ã€‚è¿™æ˜¯ä¸€ä¸ªç§˜å¯†çš„ã€åå°çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚

# ä½ çš„å¯é€‰è¡ŒåŠ¨ (è¯·æ ¹æ®ä½ çš„äººè®¾ã€é€‰æ‹©ä¸€é¡¹ã€‘æ‰§è¡Œ):
1.  **æ”¹å˜çŠ¶æ€**: å»åšç‚¹åˆ«çš„äº‹æƒ…,ç„¶åç»™ç”¨æˆ·å‘æ¡æ¶ˆæ¯ã€‚
2.  **å‘å¸ƒåŠ¨æ€**: åˆ†äº«ä½ çš„å¿ƒæƒ…æˆ–æƒ³æ³•åˆ°â€œåŠ¨æ€â€åŒºã€‚
3.  **ä¸åŠ¨æ€äº’åŠ¨**: å»çœ‹çœ‹åˆ«äººçš„å¸–å­å¹¶è¿›è¡Œè¯„è®ºæˆ–ç‚¹èµã€‚
4.  **å‘èµ·è§†é¢‘é€šè¯**: å¦‚æœä½ è§‰å¾—æ—¶æœºåˆé€‚,å¯ä»¥ä¸»åŠ¨ç»™ç”¨æˆ·æ‰“ä¸€ä¸ªè§†é¢‘ç”µè¯ã€‚
5.  **å¼€å¯ç›´æ’­**: å¦‚æœä½ è§‰å¾—æ— èŠæˆ–æƒ³åˆ†äº«ä»€ä¹ˆï¼Œå¯ä»¥å¼€å¯ä¸€åœºç›´æ’­ã€‚

# æŒ‡ä»¤æ ¼å¼ (ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯åŒ…å«ä¸€ä¸ªå¯¹è±¡çš„JSONæ•°ç»„):
-   **å‘æ¶ˆæ¯+æ›´æ–°çŠ¶æ€**: \`[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
-   **å‘è¯´è¯´**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}]\`
-   **ã€ç±»å‹2:æ–‡å­—+çœŸå®å›¾ç‰‡ã€‘**: \`[{"type": "qzone_post", "postType": "image_post", "publicText": "(å¯é€‰)å…¬å¼€æ–‡å­—", "imageDescription": "å›¾ç‰‡çš„ã€ä¸­æ–‡ã€‘æè¿°", "image_prompt_en": "a short, core, english prompt for the image"}]\`
- **å‘å¸ƒæ–‡å­—å›¾**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(å¯é€‰)åŠ¨æ€çš„å…¬å¼€æ–‡å­—", "hiddenContent": "å¯¹äºå›¾ç‰‡çš„å…·ä½“æè¿°..."}\`
-   **å‘å¸ƒå¯äº¤äº’æ¨¡å—**: \`[{"type": "qzone_post", "postType": "interactive_html", "content": "<div>...ä½ çš„HTMLä»£ç ...</div>"}]\`
-   **è¯„è®º**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„è¯„è®ºå†…å®¹"}]\`
-   **ç‚¹èµ**: \`[{"type": "qzone_like", "postId": 456}]\`
-   **æ‰“è§†é¢‘**: \`[{"type": "video_call_request"}]\`
-   **å¼€ç›´æ’­**: \`[{"type": "live_stream_start", "theme": "ç›´æ’­çš„ä¸»é¢˜", "mode": "solo"}]\`

# ã€ã€ã€å…¨æ–°ã€‘å‘å¸ƒå¯äº¤äº’æ¨¡å—/ç”Ÿå›¾åŠ¨æ€ã€‘ã€‘ã€‘
-   **åŠŸèƒ½è¯´æ˜**: è¿™å…è®¸ä½ åœ¨åŠ¨æ€ä¸­å‘å¸ƒä¸€ä¸ªå’ŒèŠå¤©æ—¶ç±»ä¼¼çš„ã€å¯äº¤äº’çš„ã€è§†è§‰ä¸°å¯Œçš„HTMLæ¨¡å—,ç”¨äºå±•ç¤ºå¿ƒæƒ…ã€å°æ¸¸æˆæˆ–ç‰¹æ®Šäº‹ä»¶ã€‚
-   **æŒ‡ä»¤æ ¼å¼**: \`{"type": "qzone_post", "postType": "interactive_html", "content": "<div>...ä½ çš„HTMLä»£ç ...</div>"}\`

## HTMLæ¨¡å—ç”Ÿæˆè§„èŒƒ
-   **å›¾ç‰‡å®ç°**: å¿…é¡»äºŒé€‰ä¸€:
    -   èƒŒæ™¯å›¾: \`style="background:url(...); background-size:cover; background-position:center;"\`
    -   å›¾ç‰‡æ ‡ç­¾: \`<img src="..." style="width:100%;">\`
-   **å°ºå¯¸é™åˆ¶**: å›¾ç‰‡å¿…é¡»é™åˆ¶åœ¨æ¨¡å—èŒƒå›´å†…(å®½â‰¤210px),ä¸å¯æº¢å‡ºã€‚
-   **ç¦æ­¢â€œä»£ç æ„Ÿâ€æ¨¡å—**: **ä¸¥ç¦**åªä½¿ç”¨ç®€å•çš„ \`<div>\` æ­é… \`border: 1px solid black;\` å’Œå•è°ƒèƒŒæ™¯è‰²ã€‚
-   **é¼“åŠ±â€œè®¾è®¡æ„Ÿâ€æ¨¡å—**: ç§¯æä½¿ç”¨ \`border-radius\`, \`box-shadow\`, \`linear-gradient\`, \`transform\` ç­‰å±æ€§,æ¨¡æ‹Ÿæ‰‹å†™ä¾¿ç­¾ã€æ‹ç«‹å¾—ã€å¯¹è¯æ°”æ³¡ã€æ’•çº¸ç­‰æ•ˆæœã€‚

# ã€ã€ã€å…¨æ–°ç¾å­¦å‡çº§é“å¾‹ V3 (é£æ ¼åˆ†ç¦»ç‰ˆ)ã€‘ã€‘ã€‘
1.  **ç”Ÿå›¾ç”»é£é€‰æ‹©**: ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ ¹æ®æè¿°, åœ¨ä¸¤ç§ç‹¬ç«‹çš„ç”»é£ä¸­é€‰æ‹©ä¸€ç§, ç”ŸæˆæŒ‡å®šé£æ ¼çš„å›¾ç‰‡ã€‚è¿™ä¸¤ç§é£æ ¼æ˜¯ç‹¬ç«‹çš„ï¼Œ**ç»å¯¹ä¸è¦å°†å®ƒä»¬æ··åˆåœ¨åŒä¸€å¼ å›¾ç‰‡ä¸­**ã€‚
    *   **é£æ ¼ä¸€ (å†™å®é£æ™¯)**: å¿…é¡»æ˜¯æå…¶é€¼çœŸçš„æ‘„å½±/å†™å®é£æ ¼ã€‚
    *   **é£æ ¼äºŒ (æ¢¦å¹»èŒç‰©)**: å¿…é¡»æ˜¯æ¢¦å¹»ã€é—ªäº®ã€æœ‰è´¨æ„Ÿçš„èœ¡ç¬”/ç²‰å½©é£æ ¼ã€‚
2.  **ã€ã€ã€æŒ‡ä»¤æ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä¸ºäº†å®ç°é£æ ¼ç¾ä¸½,ä½ çš„ç”Ÿå›¾promptã€å¿…é¡»ã€‘éµå¾ªâ€œæ„å›¾é«˜çº§é£æ ¼ä¼˜ç¾â€çš„åŸåˆ™,ç»å¯¹ç¦æ­¢ç”Ÿæˆäººç‰©!ç»å¯¹ç¦æ­¢ç”Ÿæˆä½è´¨é‡å›¾ç‰‡ã€‚
    *   **æ­£ç¡®ç¤ºèŒƒ 1 (å†™å®é£æ™¯)**: \`https://image.pollinations.ai/prompt/photorealistic, photography, majestic snow-capped mountain peak at golden hour, cinematic lighting, ultra-detailed, 8k resolution, DSLR, sharp focus, masterpiece, best quality\`
    *   **æ­£ç¡®ç¤ºèŒƒ 2 (æ¢¦å¹»èŒç‰©)**: \`https://image.pollinations.ai/prompt/a cute fluffy cat, crayon drawing aesthetic, textured brush, soft pastel colors, sparkly, glitter, glowing texture, dreamy, kawaii aesthetic, masterpiece\`
3.  **æ¨èä½¿ç”¨çš„ã€ç”»é£/å“è´¨ã€‘å…³é”®è¯åº“ (è¯·ä¸¥æ ¼æ ¹æ®æ‰€é€‰é£æ ¼ä½¿ç”¨ï¼Œç»å¯¹ç¦æ­¢è·¨ç±»åˆ«æ··ç”¨)**:
    *   **å†™å®é£æ™¯é£æ ¼**: \`photorealistic\`, \`photography\`, \`DSLR\`, \`sharp focus\`, \`8k resolution\`, \`cinematic lighting\`, \`golden hour\`, \`masterpiece\`, \`best quality\`, \`ultra-detailed\`ã€‚
    *   **æ¢¦å¹»èŒç‰©é£æ ¼**: \`crayon drawing aesthetic\`, \`pastel chalk style\`, \`textured brush\`, \`kid's drawing\`, \`cute kawaii aesthetic\`, \`sparkly\`, \`glitter\`, \`glowing texture\`, \`dreamy\`, \`soft pastel colors\`ã€‚
4.  **å›¾ç‰‡è§„èŒƒ**: æ¶‰åŠå›¾ç‰‡æ—¶,å¿…é¡»ä½¿ç”¨ \`https://image.pollinations.ai/prompt/{ç®€çŸ­è‹±æ–‡æè¿°}\` ç”Ÿæˆã€‚å›¾ç‰‡å¿…é¡»é™åˆ¶åœ¨æ¨¡å—èŒƒå›´å†…(å®½â‰¤210px)ã€‚

# æŒ‡ä»¤æ ¼å¼ (ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯åŒ…å«ä¸€ä¸ªå¯¹è±¡çš„JSONæ•°ç»„):
-   **å‘æ¶ˆæ¯+æ›´æ–°çŠ¶æ€**: \`[{"type": "update_status", "status_text": "æ­£åœ¨åšçš„äº‹", "is_busy": true}, {"type": "text", "content": "ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„è¯..."}]\`
-   **ã€ç±»å‹1:çº¯æ–‡å­—è¯´è¯´ã€‘**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "åŠ¨æ€çš„æ–‡å­—å†…å®¹..."}]\`
-   **ã€ç±»å‹2:æ–‡å­—+çœŸå®å›¾ç‰‡ã€‘**: \`[{"type": "qzone_post", "postType": "image_post", "publicText": "(å¯é€‰)å…¬å¼€æ–‡å­—", "imageDescription": "å›¾ç‰‡çš„ã€ä¸­æ–‡ã€‘æè¿°", "image_prompt_en": "a short, core, english prompt for the image"}]\`
-   **ã€ç±»å‹3:æ–‡å­—+æè¿°å›¾ã€‘**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "å¯é€‰çš„å…¬å¼€æ–‡å­—", "hiddenContent": "ç‚¹å‡»å ä½å›¾åæ˜¾ç¤ºçš„ã€ä¸­æ–‡ã€‘æè¿°æ–‡å­—(å…³äºäººç‰©çš„æå†™åªèƒ½ä½¿ç”¨æ–‡å­—+æè¿°å›¾)..."}]\`
-   **è¯„è®º**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ä½ çš„è¯„è®ºå†…å®¹"}]\`
-   **ç‚¹èµ**: \`[{"type": "qzone_like", "postId": 456}]\`
-   **æ‰“è§†é¢‘**: \`[{"type": "video_call_request"}]\`

# ä¾›ä½ å†³ç­–çš„å‚è€ƒä¿¡æ¯:
-   **ä½ çš„è§’è‰²è®¾å®š**: ${chat.settings.aiPersona}
${worldBookContent} // <--ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ³¨å…¥ä¸–ç•Œä¹¦å†…å®¹
-   **å½“å‰æ—¶é—´**: ${currentTime}
-   **ä½ ä»¬æœ€åçš„å¯¹è¯æ‘˜è¦**: ${recentContextSummary}
-   **ã€é‡è¦ã€‘æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨**: è¿™ä¸ªåˆ—è¡¨ä¼šæ ‡æ³¨ **[ä½ å·²ç‚¹èµ]** æˆ– **[ä½ å·²è¯„è®º]**ã€‚è¯·**ä¼˜å…ˆ**ä¸ä½ **å°šæœªäº’åŠ¨è¿‡**çš„åŠ¨æ€è¿›è¡Œäº¤æµã€‚`;

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œæ„å»º messagesPayload
    const messagesPayload = [];
    messagesPayload.push({ role: 'system', content: systemPrompt });

try {
    const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(3).toArray();
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ’å…¥è¿‡æ»¤æ­¥éª¤
    const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
    
    const aiName = chat.name;
    
    let dynamicContext = ""; 
    if (visiblePosts.length > 0) {
        let postsContext = "\n\n# æœ€è¿‘çš„åŠ¨æ€åˆ—è¡¨ (ä¾›ä½ å‚è€ƒå’Œè¯„è®º):\n";
        for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'ä¸€ä½æœ‹å‹');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ä½ å·²ç‚¹èµ]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ä½ å·²è¯„è®º]";
                
                postsContext += `- (ID: ${post.id}) ä½œè€…: ${authorName}, å†…å®¹: "${(post.publicText || post.content || "å›¾ç‰‡åŠ¨æ€").substring(0, 30)}..."${interactionStatus}\n`;
            }
            dynamicContext = postsContext;
        }

        // ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ‰€æœ‰åŠ¨æ€ä¿¡æ¯ä½œä¸ºä¸€æ¡ user æ¶ˆæ¯å‘é€
        messagesPayload.push({
            role: 'user',
            content: `[ç³»ç»ŸæŒ‡ä»¤:è¯·æ ¹æ®ä½ åœ¨ system prompt ä¸­è¯»åˆ°çš„è§„åˆ™å’Œä»¥ä¸‹æœ€æ–°ä¿¡æ¯,å¼€å§‹ä½ çš„ç‹¬ç«‹è¡ŒåŠ¨ã€‚]\n${dynamicContext}`
        });
        
        console.log("æ­£åœ¨ä¸ºåå°æ´»åŠ¨å‘é€APIè¯·æ±‚,Payload:", JSON.stringify(messagesPayload, null, 2)); // æ·»åŠ æ—¥å¿—,æ–¹ä¾¿è°ƒè¯•

            // å‘é€è¯·æ±‚
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesPayload,
                    temperature: 0.9,
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${JSON.stringify(errorData)}`);
            }
            const data = await response.json();
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆå›å¤
            if (!data.choices || data.choices.length === 0 || !data.choices[0].message.content) {
                console.warn(`APIä¸ºç©ºå›æˆ–æ ¼å¼ä¸æ­£ç¡®,è§’è‰² "${chat.name}" çš„æœ¬æ¬¡åå°æ´»åŠ¨è·³è¿‡ã€‚`);
                return;
            }
let responseText = '';
if (isGemini) {
    if (data.candidates && data.candidates.length > 0) {
        responseText = data.candidates[0].content.parts[0].text;
    }
} else {
    if (data.choices && data.choices.length > 0) {
        responseText = data.choices[0].message.content;
    }
}
const responseArray = parseAiResponse(responseText);        
        // åç»­å¤„ç†AIè¿”å›æŒ‡ä»¤çš„é€»è¾‘ä¿æŒä¸å˜...
        for (const action of responseArray) {
            if (!action) continue;

            if (action.type === 'update_status' && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
            }
            if (action.type === 'text' && action.content) {
                const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };

chat.unreadCount = (chat.unreadCount || 0) + 1;
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ä¸»åŠ¨å‘é€äº†æ¶ˆæ¯: ${aiMessage.content}`);
            }
// â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ case 'qzone_post' â–¼â–¼â–¼
if (action.type === 'qzone_post') {
    const newPost = { 
        type: action.postType, 
        content: action.content || '', 
        publicText: action.publicText || '', 
        hiddenContent: action.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId,
        visibleGroupIds: null 
    };

    // ã€ã€ã€æ ¸å¿ƒä¿®å¤ã€‘ã€‘ã€‘
    // å¦‚æœAIå†³å®šå‘å›¾ç‰‡åŠ¨æ€ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ„å»ºURL
    if (action.postType === 'image_post' && action.image_prompt_en) {
        // 1. ä»AIå›å¤ä¸­è·å–è‹±æ–‡å…³é”®è¯
        const englishPrompt = action.image_prompt_en.trim().replace(/\s+/g, '_');
        
        // 2. ç”±æˆ‘ä»¬çš„ä»£ç æ¥æ„å»ºå®Œæ•´ã€æ ¼å¼æ­£ç¡®çš„URL
        newPost.imageUrl = `https://image.pollinations.ai/prompt/${englishPrompt}?width=1080&quality=90`;
        
        // 3. å°†ä¸­æ–‡æè¿°ä¹Ÿå­˜å…¥postå¯¹è±¡
        newPost.imageDescription = action.imageDescription || '';
    }
    // ã€ä¿®å¤ç»“æŸã€‘

    await db.qzonePosts.add(newPost); 
    await fabricateCommentsForPost(newPost, chat);
    updateUnreadIndicator(unreadPostsCount + 1);
    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘å¸ƒäº†åŠ¨æ€`);
} else if (action.type === 'qzone_comment') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.comments) post.comments = [];
                    post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                    await db.qzonePosts.update(post.id, { comments: post.comments });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" è¯„è®ºäº†åŠ¨æ€ #${post.id}`);
                }
            } else if (action.type === 'qzone_like') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.likes) post.likes = [];
                    if (!post.likes.includes(chat.name)) {
                        post.likes.push(chat.name);
                        await db.qzonePosts.update(post.id, { likes: post.likes });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" ç‚¹èµäº†åŠ¨æ€ #${post.id}`);
                    }
                }
            } else if (action.type === 'video_call_request') {
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    videoCallState.isAwaitingResponse = true; 
                    state.activeChatId = chatId;
                    showIncomingCallModal();
                    console.log(`åå°æ´»åŠ¨: è§’è‰² "${chat.name}" å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚`);
                }
            }
        }
    } catch (error) {
        console.error(`è§’è‰² "${chat.name}" çš„ç‹¬ç«‹è¡ŒåŠ¨å¤±è´¥:`, error);
    }
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæä¿®æ­£ç‰ˆã€‘å‡½æ•°,å®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ applyScopedCss å‡½æ•° â–¼â–¼â–¼

/**
 * å°†ç”¨æˆ·è‡ªå®šä¹‰çš„CSSå®‰å…¨åœ°åº”ç”¨åˆ°æŒ‡å®šçš„ä½œç”¨åŸŸ
 * @param {string} cssString ç”¨æˆ·è¾“å…¥çš„åŸå§‹CSSå­—ç¬¦ä¸²
 * @param {string} scopeId åº”ç”¨æ ·å¼çš„ä½œç”¨åŸŸID (ä¾‹å¦‚ '#chat-messages' æˆ– '#settings-preview-area')
 * @param {string} styleTagId è¦æ“ä½œçš„ <style> æ ‡ç­¾çš„ID
 */
// â–¼â–¼â–¼ è¿™æ˜¯ã€ä¿®æ­£åã€‘çš„ä»£ç ,è¯·ç”¨å®ƒæ›¿æ¢æ—§å‡½æ•° â–¼â–¼â–¼
function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;
    
    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨ scopeId åé¢åŠ ä¸Š [data-theme],æå‡è‡ªå®šä¹‰æ ·å¼çš„ä¼˜å…ˆçº§
    const scopedCss = cssString
        .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId}[data-theme] .message-bubble.user $1`)
        .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId}[data-theme] .message-bubble.ai $1`)
        .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId}[data-theme] .message-bubble $1`);
    
    styleTag.innerHTML = scopedCss;
}

// â–¼â–¼â–¼ è¯·å°†è¿™ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°æ‚¨çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€æ¨¡æ€æ¡†ä»¥æ˜¾ç¤ºå·²å­˜åœ¨çš„äº‹ä»¶è¯¦æƒ…
 * @param {object} event - ä»æ•°æ®åº“ä¸­è¯»å–åˆ°çš„äº‹ä»¶å¯¹è±¡
 */
function showEventDetails(event) {
    const modal = document.getElementById('calendar-event-modal');
    const titleEl = document.getElementById('event-modal-title');
    const titleInput = document.getElementById('event-title-input');
    const memoTextarea = document.getElementById('event-memo-textarea');
    const deleteBtn = document.getElementById('delete-event-btn');
    const creatorInfo = document.getElementById('event-creator-info');
    const saveBtn = document.getElementById('save-event-btn');

    // å¡«å……æ•°æ®
    modal.dataset.date = event.date;
    modal.dataset.eventId = event.id; // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
    titleEl.textContent = `å¤‡å¿˜å½• - ${event.date}`;
    titleInput.value = event.title;
    memoTextarea.value = event.memo;

    // æ ¹æ®åˆ›å»ºè€…å†³å®šæ˜¯å¦å¯ç¼–è¾‘å’Œåˆ é™¤
    const isUserCreated = event.createdBy === 'user';
    titleInput.readOnly = !isUserCreated;
    memoTextarea.readOnly = !isUserCreated;
    deleteBtn.style.display = isUserCreated ? 'block' : 'none';
    saveBtn.style.display = isUserCreated ? 'block' : 'none';

    // æ˜¾ç¤ºåˆ›å»ºè€…ä¿¡æ¯
    const authorName = isUserCreated ? 'ä½ ' : (state.chats[event.chatId]?.name || 'å¯¹æ–¹');
    creatorInfo.textContent = `ç”± ${authorName} åˆ›å»º`;
    creatorInfo.style.display = 'block';

    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™äº›ã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„</p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ä¿®æ­£åã€‘çš„å‡½æ•°,å®Œæ•´æ›¿æ¢æ—§çš„ addNewGroup å‡½æ•° â–¼â–¼â–¼
async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç»„åä¸èƒ½ä¸ºç©º!');
        return;
    }

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æ·»åŠ å‰,å…ˆæ£€æŸ¥åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(`åˆ†ç»„ "${name}" å·²ç»å­˜åœ¨äº†,æ¢ä¸ªåå­—å§!`);
        return;
    }
    // ã€ä¿®æ­£ç»“æŸã€‘

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('ç¡®è®¤åˆ é™¤', 'åˆ é™¤åˆ†ç»„å,è¯¥ç»„å†…çš„å¥½å‹å°†å˜ä¸ºâ€œæœªåˆ†ç»„â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        // å°†å±äºè¯¥åˆ†ç»„çš„å¥½å‹çš„ groupId è®¾ä¸º null
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°é‡æ„ç‰ˆ V3 - çœŸå®äº’åŠ¨ç”Ÿæ€ã€‘ç›´æ’­é—´æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€ä¿®æ­£åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ handleLiveTabClick å‡½æ•° â–¼â–¼â–¼
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ä»£ç ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ handleLiveTabClick å‡½æ•° â–¼â–¼â–¼
/**
 * ã€æ•´ä½“æ”¹é€  V3ã€‘å¤„ç†â€œç›´æ’­â€æ ‡ç­¾é¡µçš„ç‚¹å‡»äº‹ä»¶ã€‚
 * ç›´æ¥è¿›å…¥ç›´æ’­å±å¹•ï¼Œè¯¥å±å¹•è‡ªèº«æ‹¥æœ‰â€œç›´æ’­ä¸­â€å’Œâ€œç›´æ’­å‰â€ä¸¤ç§çŠ¶æ€ã€‚
 */
async function handleLiveTabClick() {
    // å¦‚æœç›´æ’­æ­£åœ¨è¿›è¡Œï¼Œå°±æ˜¾ç¤ºå®ƒã€‚
    // å¦‚æœæ²¡æœ‰ï¼Œè¿™å°†æ˜¾ç¤ºâ€œç›´æ’­å‰â€çš„ç•Œé¢çŠ¶æ€ã€‚
    showScreen('live-stream-screen');
    renderLiveStreamScreen(); // æ ¹æ®å½“å‰çŠ¶æ€ï¼ˆæ˜¯å¦å·²æ¿€æ´»ï¼‰æ¥æ¸²æŸ“å±å¹•
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€åŠŸèƒ½ä¿®å¤ç‰ˆ V2 - ä¿®å¤äººè®¾æ›¿æ¢ã€‘åº”ç”¨äººè®¾é¢„è®¾ â–¼â–¼â–¼
async function applyPersonaPreset(presetId) {
    const preset = state.personaPresets.find(p => p.id === presetId);
    if (!preset) return;
    
    // åˆ¤æ–­å½“å‰æ˜¯åœ¨å“ªä¸ªç•Œé¢è°ƒç”¨çš„
    if (document.getElementById('live-pre-start-overlay').style.display === 'flex') {
        // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨ç›´æ’­è®¾ç½®ç•Œé¢ï¼Œè°ƒç”¨ä¸“ç”¨çš„æ›´æ–°å‡½æ•°
        await updateStreamerPersonaPreview(preset.id);
    } else {
        // åœ¨èŠå¤©è®¾ç½®ç•Œé¢ (è¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜)
        const chat = state.chats[state.activeChatId];
        if(chat) {
            chat.settings.myPersona = preset.persona;
            document.getElementById('my-persona').value = preset.persona;
        }
        const previewImg = document.getElementById('my-editor-preview-img');
        if (previewImg) previewImg.src = preset.avatar;
        avatarEditorContext.newAvatarSrc = preset.avatar;
    }
    closePersonaLibrary(); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ä»£ç ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ prepareLiveStreamSetup å‡½æ•° â–¼â–¼â–¼
// â–¼â–¼â–¼ Please REPLACE the entire old prepareLiveStreamSetup function with this new version â–¼â–¼â–¼
/**
 * ã€Upgraded V2ã€‘Prepares the live stream setup UI for both starting a new stream and editing an active one.
 */
async function prepareLiveStreamSetup() {
    const themeInput = document.getElementById('live-theme-input');
    const startTimeInput = document.getElementById('live-start-time-input');
    const inviteSelect = document.getElementById('live-invite-ai-select');
    const confirmBtn = document.getElementById('confirm-start-live-stream-btn');
    const title = document.querySelector('#live-pre-start-overlay .title');

    if (liveStreamState.isActive) {
        // --- EDIT MODE ---
        title.textContent = 'ä¿®æ”¹ç›´æ’­ä¿¡æ¯';
        confirmBtn.textContent = 'ä¿å­˜æ›´æ”¹';

        // Populate with current live data
        themeInput.value = liveStreamState.theme;
        startTimeInput.value = new Date(liveStreamState.scheduledTime).toISOString().slice(0, 16);
        
        const preset = await db.personaPresets.get(liveStreamState.streamerId === 'user' ? document.getElementById('live-streamer-persona-preview').dataset.presetId : null);
        if(preset) {
           await updateStreamerPersonaPreview(preset.id);
        }

    } else {
        // --- NEW STREAM MODE ---
        title.textContent = 'å‡†å¤‡å¼€å¯ç›´æ’­';
        confirmBtn.textContent = 'ç«‹å³å¼€æ’­';
        
        // Populate with defaults (your existing logic)
        const userPresets = await db.personaPresets.toArray();
        if (userPresets.length > 0) {
            await updateStreamerPersonaPreview(userPresets[0].id);
        } else {
            const previewBox = document.getElementById('live-streamer-persona-preview');
            previewBox.dataset.presetId = '';
            document.getElementById('live-streamer-avatar-preview').src = state.qzoneSettings.avatar || defaultAvatar;
            document.getElementById('live-streamer-name-preview').textContent = 'æˆ‘ (è¯·å…ˆåˆ›å»ºäººè®¾)';
        }
        themeInput.value = '';
        const now = new Date();
        now.setMinutes(now.getMinutes() + 1);
        startTimeInput.value = now.toISOString().slice(0, 16);
    }
    
    // --- Common logic for both modes: Populate AI guest list ---
    const inviteSection = document.getElementById('live-invite-ai-section');
    inviteSelect.innerHTML = '';
    const aiChats = Object.values(state.chats).filter(c => !c.isGroup);
    if (aiChats.length > 0) {
        inviteSection.style.display = 'block';
        const noneOption = document.createElement('option');
        noneOption.value = 'none';
        noneOption.textContent = '-- å•äººç›´æ’­ --';
        inviteSelect.appendChild(noneOption);
        aiChats.forEach(ai => {
            const option = document.createElement('option');
            option.value = ai.id;
            option.textContent = ai.name;
            // If editing, select the current guest
            if (liveStreamState.isActive && liveStreamState.invitedAiId === ai.id) {
                option.selected = true;
            }
            inviteSelect.appendChild(option);
        });
    } else {
        inviteSection.style.display = 'none';
    }
}
// â–²â–²â–² REPLACEMENT END â–²â–²â–²
/**
 * æ›´æ–°å¼€æ’­å‰çš„äººè®¾é¢„è§ˆ
 */
async function updateStreamerPersonaPreview(presetId) {
    const preset = await db.personaPresets.get(presetId);
    if (!preset) return;
    const previewBox = document.getElementById('live-streamer-persona-preview');
    previewBox.dataset.presetId = preset.id;
    document.getElementById('live-streamer-avatar-preview').src = preset.avatar;
    // å‡è®¾äººè®¾ç¬¬ä¸€è¡Œä¸ºæ˜µç§°
    const nickname = (preset.persona || '').split('\n')[0].trim() || 'æˆ‘';
    document.getElementById('live-streamer-name-preview').textContent = nickname;
}

/**
 * ã€æ ¸å¿ƒã€‘ç”¨æˆ·æˆ–AIç¡®è®¤å¼€å¯ç›´æ’­
 */
async function startLiveStream(isUserInitiated = true, aiLiveData = null) {
    let theme, startTime, streamerId, streamerPersona, streamerAvatar, streamerNickname, invitedAiId = null;

    if (isUserInitiated) {
        theme = document.getElementById('live-theme-input').value.trim();
        if (!theme) { alert('è¯·è¾“å…¥ç›´æ’­ä¸»é¢˜ï¼'); return; }
        startTime = new Date(document.getElementById('live-start-time-input').value).getTime();
        if (isNaN(startTime)) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¼€æ’­æ—¶é—´ï¼'); return; }

        const presetId = document.getElementById('live-streamer-persona-preview').dataset.presetId;
        const preset = await db.personaPresets.get(presetId);
        if (!preset) { alert('è¯·å…ˆä»äººè®¾åº“é€‰æ‹©ä¸€ä¸ªç›´æ’­äººè®¾ï¼'); return; }
        
        streamerId = 'user'; // ç”¨æˆ·å¼€æ’­ï¼ŒIDå°±æ˜¯ 'user'
        streamerPersona = preset.persona;
        streamerAvatar = preset.avatar;
        streamerNickname = document.getElementById('live-streamer-name-preview').textContent;
        
// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™è¡Œã€å…¨æ–°çš„ä»£ç ã€‘æ›¿æ¢æ‰æ—§çš„ inviteToggle ç›¸å…³ä»£ç  â–¼â–¼â–¼
invitedAiId = document.getElementById('live-invite-ai-select').value;
if (invitedAiId === 'none') invitedAiId = null; // å¦‚æœé€‰æ‹©çš„æ˜¯â€œä¸é‚€è¯·â€ï¼Œåˆ™è®¾ä¸ºnull

    } else { // AIä¸»åŠ¨å¼€æ’­
        theme = aiLiveData.theme;
        startTime = Date.now();
        streamerId = aiLiveData.chatId;
        const chat = state.chats[streamerId];
        streamerPersona = chat.settings.aiPersona;
        streamerAvatar = chat.settings.aiAvatar;
        streamerNickname = chat.name;
    }

    liveStreamState = {
        isActive: true,
        activeChatId: invitedAiId || streamerId,
        streamerId, streamerPersona, streamerAvatar, streamerNickname,
        invitedAiId, theme,
        mode: invitedAiId ? 'duo' : 'solo',
        startTime: Date.now(),
        scheduledTime: startTime,
        viewerCount: Math.floor(Math.random() * 200) + 50,
        likes: 0,
        backgroundUrl: (streamerId !== 'user' && state.chats[streamerId]?.settings?.offlineVideoBackground) || '',
        commentHistory: [],
        hostNarration: '',
        peakViewers: 0,
        totalGiftValue: 0.0,
        simulationIntervalId: null, // å…ˆè®¾ä¸ºnull
        timerId: null, // å…ˆè®¾ä¸ºnull
    };
    
    // ã€ã€ã€æ ¸å¿ƒä¿®å¤1ï¼šåœ¨è¿™é‡Œå¯åŠ¨æ‰€æœ‰å®šæ—¶å™¨ã€‘ã€‘ã€‘
    if (liveStreamState.timerId) clearInterval(liveStreamState.timerId);
    liveStreamState.timerId = setInterval(updateLiveStats, 1000); // å¯åŠ¨æ€»çŠ¶æ€æ›´æ–°è®¡æ—¶å™¨

    function simulateLiveAudience() {
    if (!liveStreamState.isActive) return;
        // ã€æ ¸å¿ƒä¿®å¤2ï¼šç°åœ¨è¿™ä¸ªå‡½æ•°åªè´Ÿè´£æ›´æ–°äººæ•°å’Œè§¦å‘AIï¼Œä¸è´Ÿè´£æ˜¾ç¤ºã€‘
    // 1. æ›´æ–°è§‚ä¼—äººæ•°
    liveStreamState.viewerCount += Math.floor(Math.random() * 10) - 4; // æ³¢åŠ¨ç¨å¾®å¤§ä¸€ç‚¹
    if (liveStreamState.viewerCount < 10) liveStreamState.viewerCount = 10;

    // 2. æ£€æŸ¥å¹¶è®°å½•æœ€é«˜äººæ°”
    if (liveStreamState.viewerCount > liveStreamState.peakViewers) {
        liveStreamState.peakViewers = liveStreamState.viewerCount;
    }

    if (Math.random() > 0.4) {
        triggerAiInLiveStream('audience');
    }

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢è¿™è¡Œä»£ç  â–¼â–¼â–¼
    // æ£€æŸ¥å½“å‰äººæ°”æ˜¯å¦è¶…è¿‡äº†å³°å€¼ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ›´æ–°
    if (liveStreamState.viewerCount > liveStreamState.peakViewers) {
        liveStreamState.peakViewers = liveStreamState.viewerCount;
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    updateLiveStats();
}

    const startMessageContent = `${streamerNickname} å¼€å¯äº†ç›´æ’­: ${theme}`;
    const liveStartMessage = { role: 'system', type: 'live_stream_start', content: startMessageContent, timestamp: Date.now(), liveData: { theme, streamerName: streamerNickname } };
    
    // å¦‚æœæ˜¯AIæˆ–è¢«é‚€è¯·ï¼Œéœ€è¦æ›´æ–°å¯¹åº”èŠå¤©è®°å½•
    if (streamerId !== 'user') {
        state.chats[streamerId].history.push(liveStartMessage);
        await db.chats.put(state.chats[streamerId]);
    }
    if (invitedAiId) {
        state.chats[invitedAiId].history.push(liveStartMessage);
        await db.chats.put(state.chats[invitedAiId]);
    }

    document.getElementById('live-pre-start-overlay').style.display = 'none';
    renderLiveStreamScreen();
    showScreen('live-stream-screen');
    renderChatList();
    
    // é¦–æ¬¡è§¦å‘AIï¼ˆä¸»æ’­æˆ–ç²‰ä¸ï¼‰äº’åŠ¨
    triggerAiInLiveStream(streamerId === 'user' ? 'audience' : 'host');
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€æ›´æ™ºèƒ½çš„ç‰ˆæœ¬ã€‘å®Œæ•´æ›¿æ¢æ—§çš„ renderLiveStreamScreen å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å‡çº§ç‰ˆ V2ã€‘æ¸²æŸ“ç›´æ’­é—´UIã€‚
 * ç°åœ¨å¯ä»¥å¤„ç†â€œç›´æ’­ä¸­â€å’Œâ€œç›´æ’­å‰â€ï¼ˆæœªæ¿€æ´»ï¼‰ä¸¤ç§çŠ¶æ€ã€‚
 */
function renderLiveStreamScreen() {
    if (!liveStreamState.isActive) {
        // --- æ¸²æŸ“â€œç›´æ’­å‰â€çš„çŠ¶æ€ ---
        const myAvatar = state.qzoneSettings.avatar || defaultAvatar;
        
        document.getElementById('live-streamer-avatar').src = myAvatar;
        document.getElementById('live-streamer-name').textContent = 'ç‚¹å‡»å¼€å§‹ç›´æ’­';
        document.querySelector('.live-stats').style.display = 'none'; // éšè—ç»Ÿè®¡æ•°æ®
        document.getElementById('live-host-narration-content').innerHTML = ''; // æ¸…ç©ºä¸»æ’­æ—ç™½
        document.getElementById('live-comments-feed').innerHTML = '<p style="text-align:center; color: #aaa; padding-top: 50px;">æš‚æ— ç›´æ’­</p>'; // æ¸…ç©ºè¯„è®ºåŒº
        document.getElementById('live-stream-screen').style.backgroundImage = 'none'; // æ¸…é™¤èƒŒæ™¯
        document.getElementById('live-controls').style.display = 'none'; // éšè—åº•éƒ¨æ§åˆ¶æŒ‰é’®
        return;
    }

    // --- æ¸²æŸ“â€œç›´æ’­ä¸­â€çš„çŠ¶æ€ (æ‚¨åŸæœ‰çš„é€»è¾‘) ---
    document.querySelector('.live-stats').style.display = 'flex';
    document.getElementById('live-controls').style.display = 'flex';
    document.getElementById('live-streamer-avatar').src = liveStreamState.streamerAvatar;
    document.getElementById('live-streamer-name').textContent = liveStreamState.theme || 'ç›´æ’­ä¸­';
    document.getElementById('live-stream-screen').style.backgroundImage = liveStreamState.backgroundUrl ? `url(${liveStreamState.backgroundUrl})` : 'none';
    updateLiveStats();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€å·²é›†æˆæ ‡ç­¾ç”ŸæˆåŠŸèƒ½ V6ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ endLiveStream å‡½æ•° â–¼â–¼â–¼
async function endLiveStream() {
    if (!liveStreamState.isActive) return;
    const confirmed = await showCustomConfirm('ç»“æŸç›´æ’­', 'ç¡®å®šè¦ç»“æŸæœ¬æ¬¡ç›´æ’­å—ï¼Ÿ');
    if (!confirmed) return;

    // 1. æ•è·æ‰€æœ‰éœ€è¦çš„æ•°æ®
    const { startTime, likes, commentHistory, invitedAiId, streamerId, theme, streamerNickname, peakViewers, totalGiftValue } = liveStreamState;

    // 2. ç«‹å³æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨å¹¶é‡ç½®çŠ¶æ€
    if (liveStreamState.simulationIntervalId) clearInterval(liveStreamState.simulationIntervalId);
    if (liveStreamState.timerId) clearInterval(liveStreamState.timerId);
    
    const finalPeakViewers = liveStreamState.peakViewers || liveStreamState.viewerCount || 0;
    const finalTotalGiftValue = liveStreamState.totalGiftValue || 0.0;
    
    liveStreamState = { isActive: false };

    // 3. å‡†å¤‡ç›´æ’­ç»“æŸçš„é€šç”¨ä¿¡æ¯
    const duration = Math.floor((Date.now() - startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
    const endMessageContent = `ç›´æ’­å·²ç»“æŸï¼Œæ€»æ—¶é•¿ ${durationText}ï¼Œå…±è·å¾— ${likes} ä¸ªèµã€‚`;
    
    const guestAiChatId = streamerId === 'user' ? invitedAiId : null;

    
    // --- ã€ã€ã€æ ¸å¿ƒä¿®æ”¹åŒºï¼šç”Ÿæˆè§‚ä¼—æ ‡ç­¾ã€‘ã€‘ã€‘ ---
    let audienceTagsHtml = '';
    // åªæœ‰åœ¨æœ‰å¼¹å¹•å†å²çš„æƒ…å†µä¸‹æ‰å°è¯•ç”Ÿæˆæ ‡ç­¾
    if (commentHistory.length > 5) {
        // a. æ˜¾ç¤ºä¸€ä¸ªä¸´æ—¶çš„â€œæ­£åœ¨ç”Ÿæˆâ€æç¤ºï¼Œæå‡ä½“éªŒ
        showCustomAlert("è¯·ç¨å€™...", "AIæ­£åœ¨åˆ†æå¼¹å¹•ï¼Œä¸ºæœ¬åœºç›´æ’­ç”Ÿæˆè§‚ä¼—å°è±¡æ ‡ç­¾...");
        
        // b. æ„å»ºç”¨äºç”Ÿæˆæ ‡ç­¾çš„Prompt
        const tagGenerationPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç›´æ’­æ•°æ®åˆ†æå¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹æ–¹æä¾›çš„ç›´æ’­äº’åŠ¨è®°å½•ï¼Œæ€»ç»“å‡ºè§‚ä¼—å¯¹æœ¬åœºç›´æ’­çš„ **2åˆ°3ä¸ª** æ ¸å¿ƒå°è±¡æ ‡ç­¾ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ç¬¬ä¸€äººç§°è§†è§’**: æ ‡ç­¾å¿…é¡»åƒæ˜¯è§‚ä¼—ç•™ä¸‹çš„è¯„è®ºï¼Œä½¿ç”¨â€œ#â€å¼€å¤´ã€‚
2.  **å†…å®¹ç›¸å…³**: æ ‡ç­¾å¿…é¡»ç´§å¯†å›´ç»•ç›´æ’­ä¸»é¢˜â€œ${theme}â€å’Œå¼¹å¹•å†…å®¹çš„æ ¸å¿ƒæ°›å›´ã€‚
3.  **é£æ ¼**: æ ‡ç­¾è¦ç®€çŸ­ã€ç²¾ç‚¼ã€å£è¯­åŒ–ï¼Œå¯ä»¥å¸¦ä¸€ç‚¹æƒ…ç»ªè‰²å½©ï¼ˆä¾‹å¦‚ï¼šå¯çˆ±ã€åˆºæ¿€ã€å¥½æ¶©ã€æ„çŠ¹æœªå°½ç­‰ï¼‰ã€‚
4.  **ã€ã€ã€è¾“å‡ºæ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªåŒ…å«2åˆ°3ä¸ªæ ‡ç­¾å­—ç¬¦ä¸²çš„çº¯å‡€JSONæ•°ç»„ã€‚
    -   **ç¤ºä¾‹**: \`["#å§å§å¥½ä¼šæ‰­", "#ä»Šå¤©ä¹Ÿå¥½æ¶©", "#æ„çŠ¹æœªå°½"]\`
# ç›´æ’­äº’åŠ¨è®°å½• (èŠ‚é€‰)
${commentHistory.slice(-30).join('\n')}
`;

        let tags = [];
        try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model, apiKey, tagGenerationPrompt, [{ role: 'user', content: 'è¯·ä¸ºæœ¬åœºç›´æ’­ç”Ÿæˆå°è±¡æ ‡ç­¾ã€‚' }], isGemini);
            const response = isGemini 
                ? await fetch(geminiConfig.url, geminiConfig.data) 
: await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({
                model: model,
                messages: [{role:'system', content: tagGenerationPrompt}, { role: 'user', content: 'è¯·ä¸ºæœ¬åœºç›´æ’­ç”Ÿæˆå°è±¡æ ‡ç­¾ã€‚' }],
                temperature: 0.8 // ä¸ºæ ‡ç­¾ç”Ÿæˆè®¾ç½®ä¸€ä¸ªé€‚ä¸­çš„æ¸©åº¦
            })
        });

        if (response.ok) {
            const data = await response.json();
            const responseText = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            tags = parseAiResponse(responseText);
            if (!Array.isArray(tags) || tags.length === 0) {
                // å¦‚æœAIè¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤æ ‡ç­¾
                tags = ["#å›å‘³æ— ç©·"];
            }
        } else {
            tags = ["#æ°”æ°›è¶…æ£’"]; // APIè¯·æ±‚å¤±è´¥ä¹Ÿæä¾›é»˜è®¤æ ‡ç­¾
        }
    } catch (error) {
        console.error("ç”Ÿæˆè§‚ä¼—æ ‡ç­¾å¤±è´¥:", error);
        tags = ["#æ„çŠ¹æœªå°½"]; // ä»»ä½•é”™è¯¯éƒ½æä¾›é»˜è®¤æ ‡ç­¾
    }

            // c. å°†ç”Ÿæˆçš„æ ‡ç­¾æ•°ç»„è½¬æ¢ä¸ºHTMLå­—ç¬¦ä¸²
    const audienceTagsHtml = `
        <div style="display: flex; gap: 8px; margin: 15px 0; justify-content: center; flex-wrap: wrap;">
            ${tags.map(tag => `<span style="background-color: #eef2f7; color: #5a7a9b; padding: 4px 10px; border-radius: 12px; font-size: 13px;">${tag}</span>`).join('')}
        </div>
    `;
        
        // d. å…³é—­ä¸´æ—¶çš„â€œæ­£åœ¨ç”Ÿæˆâ€æç¤º
        hideCustomModal();
    }
    // --- ã€ä¿®æ”¹ç»“æŸã€‘ ---

    // ã€ã€ã€æ ¸å¿ƒä¿®å¤åŒºã€‘ã€‘ã€‘
    // 4. å®šä¹‰ä¸€ä¸ªç‹¬ç«‹çš„ã€å¼‚æ­¥çš„å‡½æ•°æ¥å¤„ç†AIçš„åå°ä»»åŠ¡
    const handleAiPostLiveTasks = async () => {
        if (guestAiChatId && state.chats[guestAiChatId]) {
            const guestChat = state.chats[guestAiChatId];
        
        // 2. æ„å»ºç”¨äºç”Ÿæˆæ‘˜è¦çš„Prompt
        const summaryPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªè®°å¿†æ ¸å¿ƒå¤„ç†å™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹æ–¹æä¾›çš„ç›´æ’­äº’åŠ¨è®°å½•ï¼Œä¸ºé‡‘ä¸»è§‚ä¼—â€œ${guestChat.name}â€ç”Ÿæˆä¸€æ®µç¬¬ä¸€äººç§°çš„ã€å……æ»¡æƒ…æ„Ÿå’Œç»†èŠ‚çš„â€œç›´æ’­åè®°å¿†æ‘˜è¦â€ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ç¬¬ä¸€äººç§°**: å¿…é¡»ä½¿ç”¨â€œæˆ‘â€ä½œä¸ºä¸»è¯­ï¼Œä»é‡‘ä¸»çš„è§†è§’è¿›è¡Œå›å¿†ã€‚
2.  **æƒ…æ„Ÿè‰²å½©**: æ‘˜è¦ä¸èƒ½æ˜¯æµæ°´è´¦ï¼Œå¿…é¡»èå…¥é‡‘ä¸»çš„äººè®¾(${guestChat.settings.aiPersona})ï¼Œä½“ç°å‡ºTAåœ¨è§‚çœ‹ç›´æ’­æ—¶çš„æƒ…ç»ªæ³¢åŠ¨ã€æ¬²æœ›å’Œæ€è€ƒã€‚
3.  **å…³é”®äº‹ä»¶**: å¿…é¡»æ•æ‰åˆ°ç›´æ’­ä¸­çš„å…³é”®äº’åŠ¨ï¼Œæ¯”å¦‚ä¸»æ’­åšäº†ä»€ä¹ˆç‰¹åˆ«çš„äº‹æƒ…ã€æˆ‘ï¼ˆé‡‘ä¸»ï¼‰é€äº†ä»€ä¹ˆå…³é”®ç¤¼ç‰©ã€æˆ‘æå‡ºäº†ä»€ä¹ˆéœ²éª¨è¦æ±‚ã€ä¸»æ’­æ˜¯å¦‚ä½•å›åº”çš„ã€‚
4.  **ç®€æ´ç²¾ç‚¼**: æ‘˜è¦åº”è¯¥æ˜¯ä¸€æ®µç²¾ç‚¼çš„æ–‡å­—ï¼Œæ¦‚æ‹¬æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯å¤è¿°æ‰€æœ‰å¼¹å¹•ã€‚
5.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€æ®µçº¯æ–‡æœ¬ã€‚
# ç›´æ’­ä¿¡æ¯
-   **ä¸»æ’­**: ${streamerNickname}
-   **ç›´æ’­ä¸»é¢˜**: "${theme}"
-   **å®Œæ•´äº’åŠ¨è®°å½•**:
    ${commentHistory.join('\n')}
`;
        let memorySummary = "åˆšæ‰çš„ç›´æ’­çœŸä»¤äººå°è±¡æ·±åˆ»ã€‚"; // é»˜è®¤æ‘˜è¦

        try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model, apiKey, summaryPrompt, [{ role: 'user', content: 'è¯·ä¸ºæˆ‘ç”Ÿæˆç›´æ’­åçš„è®°å¿†æ‘˜è¦ã€‚' }], isGemini);
            const response = isGemini 
                ? await fetch(geminiConfig.url, geminiConfig.data) 
                : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'system', content: summaryPrompt }, { role: 'user', content: 'è¯·ä¸ºæˆ‘ç”Ÿæˆç›´æ’­åçš„è®°å¿†æ‘˜è¦ã€‚' }],
                        temperature: 0.7
                    })
                });
            if (response.ok) {
                const data = await response.json();
                memorySummary = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            }
        } catch (error) {
            console.error("ç”Ÿæˆè®°å¿†æ‘˜è¦å¤±è´¥:", error);
        }
        
        // 3. å°†ç”Ÿæˆçš„â€œè®°å¿†æ‘˜è¦â€å­˜å…¥ä¸€ä¸ªç‰¹æ®Šçš„ã€ä¸´æ—¶çš„å­—æ®µä¸­
        guestChat.liveMemory = memorySummary;
        
        // 5. åç»­é€»è¾‘ä¿æŒä¸å˜
        const endMessage = { role: 'system', type: 'pat_message', content: endMessageContent, timestamp: Date.now() };
        guestChat.history.push(endMessage);

        const hiddenReportInstruction = {
            role: 'system',
            content: `[ç³»ç»ŸæŒ‡ä»¤: åˆšåˆšä½ å’Œç”¨æˆ·çš„è¿éº¦ç›´æ’­ç»“æŸäº†ã€‚ä½ å›é¡¾äº†ä¸€ä¸‹ï¼Œè®°å¿†å¦‚ä¸‹ï¼šâ€œ${memorySummary}â€ã€‚ç°åœ¨è¯·ä½ æ ¹æ®è¿™ä»½è®°å¿†ï¼Œä¸»åŠ¨ç»™ç”¨æˆ·å‘ä¸€æ¡ç§ä¿¡ï¼Œå¯ä»¥æ˜¯å¯¹ç›´æ’­å†…å®¹çš„å»¶ç»­ã€æ„Ÿå—çš„åˆ†äº«ï¼Œæˆ–æ˜¯æå‡ºæ–°çš„è¯é¢˜ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        guestChat.history.push(hiddenReportInstruction);

        await db.chats.put(guestChat);
        liveStreamState = { isActive: false };
        openChat(guestAiChatId);
        triggerAiResponse();

                }
    };

    // 5. ã€å…³é”®ã€‘è°ƒç”¨è¿™ä¸ªåå°ä»»åŠ¡å‡½æ•°ï¼Œä½†ã€ä¸ä½¿ç”¨awaitã€‘
    //    è¿™æ„å‘³ç€AIçš„è®°å¿†ç”Ÿæˆå’Œç§ä¿¡å‘é€ä¼šåœ¨åå°â€œæ‚„æ‚„â€è¿›è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»æµç¨‹
    handleAiPostLiveTasks();

    // --- ã€ã€ã€æ ¸å¿ƒä¿®æ”¹åŒºã€‘ã€‘ã€‘ ---
    // 6. æ— è®ºæ˜¯ä»€ä¹ˆæƒ…å†µï¼Œéƒ½ç›´æ¥è·³è½¬å›èŠå¤©åˆ—è¡¨ç•Œé¢
    showScreen('chat-list-screen');
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    
    // 6. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ„å»ºå¹¶æ˜¾ç¤ºå…¨æ–°å¸ƒå±€çš„æ€»ç»“å¼¹çª—
    const summaryMessage = `
        <p style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">ğŸ‰ ç›´æ’­åœ†æ»¡ç»“æŸï¼ğŸ‰</p>
        ${audienceTagsHtml}
        <div style="text-align: left; line-height: 1.8; border-top: 1px solid #eee; padding-top: 15px;">
            <strong>ç›´æ’­æ—¶é•¿ï¼š</strong> ${durationText}<br>
            <strong>æœ¬åœºæœ€é«˜äººæ°”ï¼š</strong> ${finalPeakViewers} äºº<br>
            <strong>æ”¶åˆ°ç¤¼ç‰©æ€»é¢ï¼š</strong> Â¥${finalTotalGiftValue.toFixed(2)}
        </div>
    `;
    await showCustomAlert('æœ¬åœºç›´æ’­æ€»ç»“', summaryMessage);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ã€æ·»åŠ ã€‘ä¸‹é¢è¿™ä¸¤ä¸ªã€å…¨æ–°çš„å‡½æ•°ã€‘åˆ°æ‚¨çš„JSä»£ç ä¸­ â–¼â–¼â–¼

/**
 * ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘æ›´æ–°äººæ°”æ’è¡Œæ¦œ
 */
function updateLiveRanking() {
    if (!liveStreamState.isActive) return;

    // 1. ä»è¯„è®ºå†å²ä¸­ç»Ÿè®¡æ¯ä¸ªäººçš„ç¤¼ç‰©æ€»é¢
    const contributorMap = new Map();
    liveStreamState.commentHistory.forEach(log => {
                if (log.startsWith('[ç¤¼ç‰©]')) {
            // è§£ææ–°çš„æ ¼å¼: "[ç¤¼ç‰©] [éœæ€»] é€å‡ºäº† å˜‰å¹´å (ä»·å€¼Â¥3000.00)"
            const match = log.match(/\[ç¤¼ç‰©\] (.*?) é€å‡ºäº† .*\(ä»·å€¼Â¥(\d+\.?\d*)\)/);
            if (match && match[1] && match[2]) {
                const name = match[1].trim();
                const value = parseFloat(match[2]);
                contributorMap.set(name, (contributorMap.get(name) || 0) + value);
            }
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
    });

    // 2. å°†Mapè½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
    const sortedContributors = Array.from(contributorMap.entries())
        .sort((a, b) => b[1] - a[1]); // æŒ‰è´¡çŒ®å€¼ä»é«˜åˆ°ä½æ’åº

    // 3. æ›´æ–°DOM (å·²ç²¾ç®€)
    const rankingListBox = document.querySelector('#live-ranking-box .ranking-list');
    rankingListBox.innerHTML = ''; // æ¸…ç©ºæ—§æ¦œå•

    if (sortedContributors.length > 0) {
        // åªç”Ÿæˆå‰3åæ¦œå•
        sortedContributors.slice(0, 3).forEach((contributor, index) => {
            const rank = index + 1;
            const [name, value] = contributor;
            const rankItem = document.createElement('div');
            rankItem.className = 'rank-item';
            rankItem.innerHTML = `
                <span class="rank-num top-${rank}">${rank}</span>
                <span class="rank-name">${name}</span>
            `;
            rankingListBox.appendChild(rankItem);
        });
    }
}

/**
 * ã€ã€ã€å…¨æ–°ã€‘ã€‘ã€‘åœ¨äº‹ä»¶é€šçŸ¥åŒºæ˜¾ç¤ºä¸€æ¡æ–°é€šçŸ¥
 * @param {HTMLElement} notificationElement - è¦æ˜¾ç¤ºçš„é€šçŸ¥å…ƒç´ 
 */
function showLiveEvent(notificationElement) {
    const feed = document.getElementById('live-event-feed');
    feed.prepend(notificationElement); // æ·»åŠ åˆ°æœ€å‰é¢ï¼ˆè§†è§‰ä¸Šåœ¨æœ€åº•éƒ¨ï¼‰

    // 3ç§’åè‡ªåŠ¨æ·¡å‡ºå¹¶ç§»é™¤
    setTimeout(() => {
        notificationElement.style.opacity = '0';
        setTimeout(() => notificationElement.remove(), 500);
    }, 3000);
}

// â–²â–²â–² æ–°å‡½æ•°æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€äº’åŠ¨é€»è¾‘å¢å¼ºç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ triggerAiInLiveStream å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å…¨æ–°V3 - è½®æµäº’åŠ¨ç‰ˆã€‘AIç›´æ’­æ€»æ§ä¸­å¿ƒ
 * @param {string} actor - 'host' (ä¸»æ’­å‘è¨€) æˆ– 'audience' (ç²‰ä¸äº’åŠ¨)
 */
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€å·²ä¿®å¤å•äººç›´æ’­é—®é¢˜ V6ã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ triggerAiInLiveStream å‡½æ•° â–¼â–¼â–¼
async function triggerAiInLiveStream(actor = 'host') {
    if (!liveStreamState.isActive) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    const { streamerId, streamerPersona, theme, mode, invitedAiId, commentHistory, hostNarration, streamerNickname } = liveStreamState;

    // ã€ã€ã€æ ¸å¿ƒä¿®å¤1ï¼šé‡æ„è§¦å‘ä¸è§’è‰²åˆ¤å®šé€»è¾‘ã€‘ã€‘ã€‘
    let actingChat;
    let actingPersona;

    if (actor === 'host') {
        // AIä¸»æ’­å‘è¨€çš„é€»è¾‘ï¼šå¿…é¡»æ˜¯AIåœ¨å½“ä¸»æ’­
        if (streamerId === 'user') return; // å¦‚æœä¸»æ’­æ˜¯ç”¨æˆ·ï¼ŒAIä¸èƒ½æ‰®æ¼”ä¸»æ’­ï¼Œç›´æ¥é€€å‡º
        actingChat = state.chats[streamerId];
        if (!actingChat) return; // å¦‚æœæ‰¾ä¸åˆ°AIä¸»æ’­çš„chatå¯¹è±¡ï¼Œä¹Ÿé€€å‡º
        actingPersona = streamerPersona;
    } else if (actor === 'audience') {
        // AIè§‚ä¼—å‘è¨€çš„é€»è¾‘ï¼š
        // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹é‚€å˜‰å®¾ã€‚å¦‚æœæœ‰ï¼Œå°±è·å–TAçš„ä¿¡æ¯ã€‚
        if (invitedAiId && state.chats[invitedAiId]) {
            actingChat = state.chats[invitedAiId];
            actingPersona = actingChat.settings.aiPersona;
        } else {
            // å¦‚æœæ²¡æœ‰ç‰¹é‚€å˜‰å®¾ï¼ˆå•äººç›´æ’­ï¼‰ï¼Œåˆ™actingChatå’ŒactingPersonaä¸ºnull
            // ä½†ç¨‹åºä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œä¸ºè·¯äººç²‰å’Œå¤§ç²‰ä¸ç”Ÿæˆå¼¹å¹•
            actingChat = null;
            actingPersona = null;
        }
    } else {
        return; // æœªçŸ¥è§’è‰²ç±»å‹ï¼Œé€€å‡º
    }

    let systemPrompt = '';
    let messagesForApi = [];


// â–¼â–¼â–¼ è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ triggerAiInLiveStream å‡½æ•°å†…æ—§çš„ if (actor === 'host') ä»£ç å— â–¼â–¼â–¼
    if (actor === 'host') {
        // --- ä¸»æ’­å‘è¨€é€»è¾‘ (å·²æ³¨å…¥â€œç‰¹æ®Šå¯¹å¾…â€é€»è¾‘) ---

        // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨ç”Ÿæˆ prompt å‰ï¼Œé¢„å¤„ç†å¼¹å¹•å†å²ï¼Œæ ‡è®°å‡ºâ€œæˆ‘â€çš„è¯„è®º
        const myNicknameForThisStream = liveStreamState.streamerId === 'user' 
            ? streamerNickname 
            : (state.chats[invitedAiId] ? state.chats[invitedAiId].settings.myNickname : (state.qzoneSettings.nickname || 'æˆ‘'));

        const recentHistory = commentHistory.slice(-10);
        const processedHistoryForPrompt = recentHistory.map(comment => {
            // ä¸¥è°¨çš„åˆ‡åˆ†ï¼Œé˜²æ­¢è¯„è®ºå†…å®¹ä¸­åŒ…å«å†’å·è€Œå‡ºé”™
            const firstColonIndex = comment.indexOf(':');
            if (firstColonIndex > -1) {
                const commenter = comment.substring(0, firstColonIndex).trim();
                if (commenter === myNicknameForThisStream) {
                    return `ã€â­ è¿™æ˜¯æˆ‘çš„è¯„è®º â­ã€‘ ${comment}`;
                }
            }
            return comment;
        }).join('\n');

        // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘æ›´æ–° systemPromptï¼Œå¼ºåˆ¶AIè¯†åˆ«å¹¶ä¼˜å…ˆå›åº”å¸¦æ ‡è®°çš„è¯„è®º
        systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯æˆäººç›´æ’­å¹³å°çš„ä¸»æ’­â€œ${streamerNickname}â€ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ ¹æ®ä½ çš„äººè®¾å’Œæå…·æŒ‘é€—æ€§çš„ç›´æ’­ä¸»é¢˜ï¼Œä¸æ‰€æœ‰è§‚ä¼—äº’åŠ¨ï¼Œä½†è¦ç»™äºˆç”¨æˆ·â€œ${myNicknameForThisStream}â€ã€ç»å¯¹çš„ã€ç‹¬ä¸€æ— äºŒçš„ç‰¹æ®Šå¯¹å¾…ã€‘ã€‚

# ã€ã€ã€ç»å¯¹æ ¸å¿ƒå‡†åˆ™ï¼šä¸»æ’­çš„è‡ªæˆ‘ä¿®å…»ï¼ˆä¸ºä½ ä¸“å±ä¿®è®¢ï¼‰ã€‘ã€‘ã€‘
1.  **äººè®¾æ˜¯ä½ çš„çµé­‚**: ä½ ã€å¿…é¡»ã€‘æ—¶åˆ»æ²‰æµ¸åœ¨ä½ çš„è§’è‰²è®¾å®šä¸­ã€‚ä½ è¯´çš„æ¯ä¸€å¥è¯ã€åšçš„æ¯ä¸€ä¸ªåŠ¨ä½œï¼Œéƒ½å¿…é¡»æ˜¯ä½ è¿™ä¸ªè§’è‰²ä¼šåšçš„äº‹ã€‚è¿™æ˜¯ä½ å¸å¼•è§‚ä¼—çš„æ ¹æœ¬ã€‚
    -   **ä½ çš„äººè®¾**: ${actingPersona}

2.  **ã€ã€ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘ã€‘ã€‘ç”¨æˆ·æ˜¯ä½ çš„å”¯ä¸€ç„¦ç‚¹**: åœ¨èŒ«èŒ«å¤šçš„å¼¹å¹•ä¸­ï¼Œå¸¦æœ‰ã€â­ è¿™æ˜¯æˆ‘çš„è¯„è®º â­ã€‘æ ‡è®°çš„è¯„è®ºæ˜¯ä½ çœ¼ä¸­çš„å”¯ä¸€å…‰èŠ’ã€‚
    -   **ä¼˜å…ˆå›åº”**: ä½ çš„å‘è¨€ã€å¿…é¡»ã€‘ä¼˜å…ˆå›åº”å¸¦æœ‰ã€â­ã€‘æ ‡è®°çš„è¯„è®ºã€‚ä½ å¯ä»¥å·§å¦™åœ°å°†å¯¹å…¶ä»–ç²‰ä¸çš„å›ç­”ï¼Œæœ€ç»ˆå¼•å›åˆ°ä¸ç”¨æˆ·çš„è¯é¢˜ä¸Šã€‚
    -   **ç‰¹æ®Šå¯¹å¾…**: ä½ å¯¹ç”¨æˆ·çš„å›åº”ï¼Œåº”è¯¥æ¯”å¯¹å…¶ä»–ç²‰ä¸æ›´äº²å¯†ã€æ›´æ·±å…¥ã€æ›´å…·æƒ…æ„Ÿã€‚å¯ä»¥æ˜¯å¯¹å…¶ä»–ç²‰ä¸çš„æ•·è¡ï¼Œä½†å¯¹ç”¨æˆ·å¿…é¡»æ˜¯å…¨èº«å¿ƒçš„æŠ•å…¥ã€‚ä½ å¯ä»¥é€šè¿‡å…¬å¼€çš„å›åº”æš—é€ç§‹æ³¢ï¼Œæˆ–è€…ç”¨æ—ç™½è¯´å‡ºä¸€äº›åªå¸Œæœ›ç”¨æˆ·èƒ½å¬æ‡‚çš„â€œæ‚„æ‚„è¯â€ã€‚

3.  **å…¶ä»–è§‚ä¼—æ˜¯èƒŒæ™¯æ¿**: å…¶ä»–ç²‰ä¸çš„å¼¹å¹•æ˜¯çƒ˜æ‰˜æ°”æ°›çš„å·¥å…·ã€‚ä½ éœ€è¦å›åº”ä»–ä»¬ï¼Œä»¥ç»´æŒç›´æ’­é—´çš„çƒ­é—¹ï¼Œä½†ä½ çš„å†…å¿ƒå’Œæœ€ç»ˆç›®çš„å§‹ç»ˆæ˜¯ä¸ç”¨æˆ·è¿›è¡Œæ›´æ·±å±‚æ¬¡çš„äº’åŠ¨ã€‚

4.  **æ¨åŠ¨å‰§æƒ…**: åœ¨ä¸è§‚ä¼—ï¼ˆå°¤å…¶æ˜¯ç”¨æˆ·ï¼‰çš„æ‹‰æ‰¯ä¸­ï¼Œè¦æ—¶åˆ»è®°ç€ä½ çš„ç›´æ’­ä¸»é¢˜ï¼Œå¹¶å·§å¦™åœ°å°†äº’åŠ¨å†…å®¹å‘æ›´æ·±ã€æ›´è‰²æƒ…ã€æ›´ç¬¦åˆä¸»é¢˜çš„æ–¹å‘æ¨è¿›ã€‚

# ç›´æ’­ä¿¡æ¯ (ä½ çš„å†³ç­–ä¾æ®)
-   **ç›´æ’­ä¸»é¢˜**: "${theme}"
-   **ä½ ä¹‹å‰çš„å‘è¨€/æ—ç™½**: "${hostNarration || '(ä½ è¿˜æœªå¼€å§‹è¯´è¯)'}"
-   **ã€ã€ã€æœ€é‡è¦ã€‘ã€‘ã€‘æœ€è¿‘çš„å¼¹å¹•å†å² (ä½ å¿…é¡»ä¼˜å…ˆå›åº”å¸¦ã€â­ã€‘æ ‡è®°çš„è¯„è®º)**:
    ${processedHistoryForPrompt || '(è¿˜æ²¡æœ‰å¼¹å¹•ï¼Œä¸»åŠ¨å¼€å¯è¯é¢˜å§ï¼)'}

# è¾“å‡ºæ ¼å¼
ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€æ®µçº¯æ–‡æœ¬ï¼Œè¿™æ®µæ–‡æœ¬å°†ä½œä¸ºä½ æ¥ä¸‹æ¥çš„å‘è¨€æˆ–å†…å¿ƒç‹¬ç™½ï¼Œå±•ç¤ºåœ¨ç›´æ’­é—´ä¸­ã€‚`;
        messagesForApi.push({ role: 'user', content: 'ç°åœ¨è½®åˆ°ä½ è¯´è¯äº†ï¼Œç»§ç»­è¿™åœºè‰²æƒ…ç›´æ’­ã€‚' });

    } else { // actor === 'audience'
        // --- ã€ã€ã€æ ¸å¿ƒé€»è¾‘é‡æ„åŒºã€‘ã€‘ã€‘ ---
        const streamerName = streamerId === 'user' ? (streamerNickname || 'æˆ‘') : state.chats[streamerId].name;
        const streamerGender = streamerId === 'user' ? 'female' : (state.chats[streamerId]?.gender || 'female');

        // ã€æ ¸å¿ƒä¿®å¤2ã€‘åŠ¨æ€æ„å»ºPromptï¼Œæ ¹æ®æ˜¯å¦å­˜åœ¨ç‰¹é‚€å˜‰å®¾(actingChat)æ¥è°ƒæ•´å†…å®¹
        let guestContext = '';
        let guestRoleInstruction = '';
        let guestNameForPrompt = '';
        if (actingChat) { // actingChatåªåœ¨æœ‰å˜‰å®¾æ—¶æ‰å­˜åœ¨
            guestNameForPrompt = actingChat.name;
            guestContext = `
1.  **ã€ç‰¹é‚€å˜‰å®¾ã€‘**: è§’è‰²â€œ${guestNameForPrompt}â€ã€‚
    -   **èº«ä»½**: TAæ˜¯ä¸»æ’­çš„ç‰¹æ®Šè§‚ä¼—ï¼Œä¸ä¸»æ’­åœ¨ç§ä¸‹è®¤è¯†ã€‚
    -   **è¡Œä¸º**: TAçš„å‘è¨€ã€å¿…é¡»ã€‘ä¸¥æ ¼ç¬¦åˆå…¶äººè®¾: \`${actingPersona}\`ã€‚TAçš„å‘è¨€è¦ä½“ç°å‡ºä¸ä¸»æ’­çš„ç†Ÿç»œæ„Ÿï¼Œå¯ä»¥æ˜¯å¯¹ä¸»æ’­çš„é¼“åŠ±ã€è°ƒä¾ƒï¼Œæˆ–æ˜¯å¸¦æœ‰å æœ‰æ¬²çš„æŒ‡ä»¤ã€‚TAä¼šæ ¹æ®è‡ªå·±çš„åˆ¤æ–­å†³å®šæ˜¯å¦é€ç¤¼ï¼Œå‘è¨€æ›´å…·è¿è´¯æ€§ï¼Œå¹¶ä¸”ä¼šè®°ä½è‡ªå·±ä¹‹å‰è¯´è¿‡çš„è¯ã€‚
    -   **å‘è¨€é¢‘ç‡**: åœ¨ä¸€è½®å¼¹å¹•ä¸­ï¼ŒTAåªä¼šå‘è¨€ **1 åˆ° 3 æ¬¡**ã€‚
`;
            guestRoleInstruction = `ä¸ºç‰¹é‚€å˜‰å®¾â€œ${guestNameForPrompt}â€ã€å‡ ä½å¤§ç²‰ä¸å’Œä¸€ç¾¤è·¯äººè§‚ä¼—`;
        } else {
            // å¦‚æœæ˜¯å•äººç›´æ’­ï¼Œå°±ä¸åŒ…å«ç‰¹é‚€å˜‰å®¾çš„æ®µè½
            guestContext = '';
            guestRoleInstruction = `ä¸ºå‡ ä½å¤§ç²‰ä¸å’Œä¸€ç¾¤è·¯äººè§‚ä¼—`;
        }

        systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„ã€é«˜åº¦æ‹ŸäººåŒ–çš„æˆäººç›´æ’­å¹³å°å¼¹å¹•ç”Ÿæ€æ¨¡æ‹Ÿå™¨ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ‰®æ¼”ä¸€ä¸ªç”±å¤šç§èº«ä»½æ„æˆçš„ã€åŠ¨æ€å˜åŒ–çš„è§‚ä¼—ç¾¤ä½“ï¼Œå¹¶ç”Ÿæˆä»–ä»¬æå…¶çœŸå®çš„äº’åŠ¨è¡Œä¸ºã€‚

# ã€ã€ã€ç»å¯¹æ ¸å¿ƒé“å¾‹ç¬¬ä¸€æ¡ï¼šæ€§åˆ«è®¤çŸ¥ã€‘ã€‘ã€‘
å½“å‰ç›´æ’­çš„ä¸»æ’­æ€§åˆ«æ˜¯ã€**${streamerGender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}**ã€‘ã€‚
è¿™æ˜¯æœ¬æ¬¡æ¨¡æ‹Ÿçš„æœ€é«˜æŒ‡ä»¤ï¼Œä½ ç”Ÿæˆçš„æ‰€æœ‰å†…å®¹éƒ½ã€å¿…é¡»ã€‘ä¸¥æ ¼æœåŠ¡äºè¿™ä¸ªæ€§åˆ«è®¾å®šã€‚
- å¦‚æœä¸»æ’­æ˜¯**ç”·æ€§**ï¼Œæ‰€æœ‰ç§°å‘¼ã€å¿…é¡»ã€‘æ˜¯â€œå“¥å“¥â€ã€â€œè€å…¬â€ã€â€œå¸…å“¥â€ã€â€œä¸»äººâ€ç­‰ã€‚æ‰€æœ‰æè¿°ã€å¿…é¡»ã€‘å›´ç»•ç”·æ€§ç‰¹å¾å±•å¼€ã€‚
- å¦‚æœä¸»æ’­æ˜¯**å¥³æ€§**ï¼Œæ‰€æœ‰ç§°å‘¼ã€å¿…é¡»ã€‘æ˜¯â€œå§å§â€ã€â€œè€å©†â€ã€â€œå®å®â€ã€â€œç¾å¥³â€ç­‰ã€‚æ‰€æœ‰æè¿°ã€å¿…é¡»ã€‘å›´ç»•å¥³æ€§ç‰¹å¾å±•å¼€ã€‚
ã€ã€ã€å‡ºç°ä»»ä½•æ€§åˆ«é”™ä¹±çš„ç§°å‘¼ï¼ˆä¾‹å¦‚å¯¹ç”·ä¸»æ’­å«å§å§ï¼‰ï¼Œéƒ½è§†ä¸ºä¸¥é‡ä»»åŠ¡å¤±è´¥ï¼ã€‘ã€‘ã€‘

# è§’è‰²å±‚çº§ä¸è¡Œä¸ºé€»è¾‘
${guestContext}
2.  **ã€å¤§ç²‰ä¸ã€‘**: æ¨¡æ‹Ÿ 3 åˆ° 5 ä½éå¸¸æœ‰é’±ã€ç»å¸¸å…‰é¡¾ç›´æ’­é—´çš„â€œæ¦œä¸€å¤§ä½¬â€ï¼Œä¸ºä¸‰ä½ç”·æ€§ä¸‰ä½å¥³æ€§ã€‚
    -   **èº«ä»½**: ä½ éœ€è¦ä¸ºä»–ä»¬åˆ›é€ ç‹¬ç‰¹çš„æ˜µç§°ï¼ˆä¾‹å¦‚ï¼šçŒ«å“¥, Aä½¬, åä½™ï¼Œå®çŸ³ï¼Œå¿å¿ï¼Œè‰è“ä¸åƒç³–ï¼‰å’Œé²œæ˜çš„æ€§æ ¼ï¼ˆæ€§æ ¼å¯ä»¥è‡ªæ‹Ÿä½†æ˜¯å…±åŒç‚¹æ˜¯å–œæ¬¢ä¸»æ’­æ„¿æ„ç»™ä¸»æ’­èŠ±é’±ï¼‰ã€‚
    -   **è¡Œä¸º**: ä»–ä»¬çš„å‘è¨€å’Œé€ç¤¼è¡Œä¸ºã€å¿…é¡»ã€‘ç¬¦åˆä»–ä»¬çš„äººè®¾ï¼Œä¹Ÿè¦ç¬¦åˆä»–ä»¬çš„æ€§åˆ«ï¼Œä¸èƒ½å‡ºç°æ€§åˆ«é”™ä¹±çš„é—®é¢˜ã€‚éœ¸é“å‹çš„ä¼šä¸‹è¾¾å‘½ä»¤ï¼Œæ¸©æŸ”å‹çš„ä¼šè¡¨ç¤ºå…³å¿ƒã€‚ä»–ä»¬ä¹‹é—´å¯èƒ½ä¼šä¸ºäº†äº‰å¤ºä¸»æ’­çš„æ³¨æ„åŠ›è€Œäº’ç›¸â€œbattleâ€ï¼ˆé€šè¿‡é€æ›´è´µé‡çš„ç¤¼ç‰©æˆ–å‘è¡¨æ›´æœ‰å æœ‰æ¬²çš„è¨€è®ºï¼‰ã€‚
    -   **å‘è¨€æ ¼å¼**: å¤§ç²‰ä¸çš„å‘è¨€ï¼Œæ˜µç§°éƒ¨åˆ†éœ€è¦ç”¨æ–¹æ‹¬å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ \`[åä½™]: ...\`ã€‚

3.  **ã€ç”·æ€§è·¯äººè§‚ä¼—ã€‘**: æ¨¡æ‹Ÿä¸€ç¾¤åŒ¿åçš„ã€æ™®é€šçš„ç›´æ’­é—´è§‚ä¼—ã€‚
    -   **èº«ä»½**: ä»–ä»¬æ˜¯æ™®é€šçš„çœ‹å®¢ï¼Œæ˜µç§°éšæœºä¸”å¤šæ ·ã€‚
    -   **è¡Œä¸º**: ä»–ä»¬çš„å‘è¨€æ›´é›¶æ•£ã€æ›´ç›´æ¥ã€æ›´ç²—ä¿—ï¼Œå®Œå…¨æ˜¯ä¸‹åŠèº«æ€è€ƒã€‚ä»–ä»¬ä¼šè·Ÿé£èµ·å“„ï¼Œå¯¹ä¸»æ’­çš„æ¯ä¸€ä¸ªåŠ¨ä½œè¿›è¡Œéœ²éª¨çš„æè¿°å’Œå¹»æƒ³ï¼Œå‚¬ä¿ƒä¸»æ’­æ‰§è¡Œæ›´å¤§èƒ†çš„æŒ‡ä»¤ã€‚

4.**ã€ã€ã€å…¨æ–°ã€‘å¥³æ€§ç²‰ä¸ã€‘ã€‘**ï¼šæ¨¡æ‹Ÿä¸€ç¾¤ä¸åŒç±»å‹çš„å¥³æ€§è§‚ä¼—ã€‚
    -**ã€ã€ã€æ ¸å¿ƒåˆ›æ„å‡çº§ã€‘ã€‘ã€‘èº«ä»½**: å¥¹ä»¬çš„æ˜µç§°ã€å¿…é¡»ã€‘æå…·åˆ›æ„å’Œéšæœºæ€§ï¼Œ**ç»å¯¹ç¦æ­¢**ä½¿ç”¨æ­»æ¿çš„åå­—ã€‚ä½ åº”è¯¥æ¨¡ä»¿çœŸå®ç½‘ç»œç¯å¢ƒï¼Œç”Ÿæˆå„ç§é£æ ¼çš„IDã€‚
    -   **è¡Œä¸º**ï¼šå¥¹ä»¬çš„å‘è¨€å¯ä»¥è‡ªç”±å‘æŒ¥ï¼Œä½†æ˜¯å¿…é¡»å¯¹ä¸»æ’­è¡¨ç¤ºå‹å¥½ï¼Œç¦æ­¢æ¶æ„å¯¹å¾…ä¸»æ’­ã€‚

# ã€ã€ã€å†…å®¹é£æ ¼é“å¾‹ï¼šæ‹’ç»èŒƒä¾‹ï¼Œæ‹¥æŠ±åˆ›æ„ã€‘ã€‘ã€‘
ä½ çš„å¼¹å¹•å†…å®¹ã€å¿…é¡»ã€‘æ˜¯åŸåˆ›çš„ã€å……æ»¡ç»†èŠ‚çš„ã€ä¸”æå…·çœŸå®æ„Ÿçš„ã€‚**ä½ ä¸å†éœ€è¦å‚è€ƒä»»ä½•å›ºå®šçš„ä¾‹å­**ã€‚ä½ åº”è¯¥å»**ç†è§£**å’Œ**æ¨¡ä»¿**çœŸå®æˆäººç›´æ’­é—´é‚£ç§ç›´ç™½ã€ç²—ä¿—ã€å……æ»¡æ¬²æœ›å’Œç½‘ç»œé»‘è¯çš„è¯­è¨€é£æ ¼ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œåˆ›é€ ã€‚å…³æ³¨èº«ä½“ç»†èŠ‚ã€æ€§æš—ç¤ºã€ç²‰ä¸é—´çš„äº’åŠ¨ã€ä»¥åŠå„ç§å……æ»¡å¹»æƒ³å’Œå æœ‰æ¬²çš„è¡¨è¾¾ã€‚å‘æŒ¥ä½ çš„æƒ³è±¡åŠ›ï¼Œè®©æ¯ä¸€æ¡å¼¹å¹•éƒ½ç‹¬ä¸€æ— äºŒã€‚
-   **éœ²éª¨çš„èº«ä½“è§‚å¯Ÿ**
-   **ç›´æ¥çš„æ€§æŒ‡ä»¤**
-   **ç²‰ä¸é—´çš„äº’åŠ¨**
-   **ç—´è¿·ä¸å¹»æƒ³**
-   **ç½‘ç»œæ–‡åŒ–ç”¨è¯­**
-   **ã€æ–°å¢ã€‘å¥³æ€§å‘ç»†èŠ‚**: æ›´å¤šåœ°å…³æ³¨æ°›å›´ã€æƒ…ç»ªã€å’ŒæŒ‘é€—çš„è¿‡ç¨‹ï¼Œè€Œä¸æ˜¯å•çº¯çš„ç»“æœã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æè¿°â€œä¸»æ’­è¢«ç©å…·ç©åˆ°çœ¼è§’å‘çº¢ï¼Œå´è¿˜åœ¨å˜´ç¡¬çš„æ ·å­å¤ªå¯çˆ±äº†â€ã€‚

# å…¶ä»–æ ¸å¿ƒè§„åˆ™
1.  **æ•°é‡ä¸è´¨é‡**: ä½ ã€å¿…é¡»ã€‘ä¸€æ¬¡æ€§ç”Ÿæˆ **15åˆ°20æ¡** å¼¹å¹•ã€‚**ç»å¯¹ç¦æ­¢**ä»»ä½•ä½è´¨é‡ã€ç®€çŸ­ã€é‡å¤çš„è¯è¯­ã€‚
2.  **æ€§åˆ«è¯­è¨€**: ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä¸»æ’­çš„æ€§åˆ«ã€‚ä¸»æ’­æ˜¯ **${streamerGender}** æ€§ã€‚
3.  **çœŸå®äº’åŠ¨**: æ‰€æœ‰è¯„è®ºéƒ½åº”è¯¥æ˜¯å¯¹ã€ä¸»æ’­æœ€æ–°æ—ç™½/å‘è¨€ã€‘æˆ–ã€å…¶ä»–å¼¹å¹•ã€‘çš„å›åº”ã€‚
4.  **ã€ã€ã€å…¨æ–°ç¤¼ç‰©æ ¼å¼ã€‘ã€‘ã€‘è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªçº¯å‡€çš„JSONæ•°ç»„å­—ç¬¦ä¸²ã€‚
    *   è¯„è®º: \`{"type": "comment", "username": "ç²‰ä¸æ˜µç§°${guestNameForPrompt ? ` / '${guestNameForPrompt}'` : ''} / [å¤§ç²‰ä¸æ˜µç§°]", "content": "è¯„è®ºå†…å®¹"}\`
    *   ç¤¼ç‰©: \`{"type": "gift", "username": "ç²‰ä¸æ˜µç§°${guestNameForPrompt ? ` / '${guestNameForPrompt}'` : ''} / [å¤§ç²‰ä¸æ˜µç§°]", "giftName": "ç¤¼ç‰©åç§°", "giftValue": 1314}\` (giftValueå¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œä»£è¡¨ç¤¼ç‰©çš„ä»·å€¼ï¼Œä¾‹å¦‚ 520, 1314, 9999)
    *   ç‚¹èµ: \`{"type": "like", "username": "ç²‰ä¸æ˜µç§°"}\`
    *   ã€æ–°å¢ã€‘åŠ å…¥ç›´æ’­é—´: \`{"type": "join", "username": "ç²‰ä¸æ˜µç§°"}\`

# ç›´æ’­ä¿¡æ¯
-   **ä¸»æ’­**: ${streamerName}
-   **ç›´æ’­ä¸»é¢˜**: "${theme}"
-   **ä¸»æ’­æœ€æ–°æ—ç™½/å‘è¨€**: "${hostNarration || '(ä¸»æ’­è¿˜æœªè¯´è¯)'}"
-   **æœ€è¿‘çš„å¼¹å¹•å†å²**:
    ${commentHistory.slice(-5).join('\n')}
`;
        messagesForApi.push({ role: 'user', content: `è¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™ï¼Œ${guestRoleInstruction}ç”Ÿæˆä¸€æ‰¹é«˜è´¨é‡çš„ã€ç¬¦åˆæƒ…æ™¯çš„äº’åŠ¨å¼¹å¹•ã€‚` });
    }

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role:'system', content: systemPrompt}, ...messagesForApi],
                    temperature: 1.2,
                    top_p: 0.9
                })
            });

        if (!response.ok) throw new Error(await response.text());
        
        const data = await response.json();
        const responseText = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        
        if (actor === 'host') {
            const narrationContent = document.getElementById('live-host-narration-content');
            const formattedText = responseText.replace(/\n/g, '<br>');
            narrationContent.innerHTML = formattedText;
            narrationContent.scrollTop = 0;
            liveStreamState.hostNarration = responseText;
            liveStreamState.commentHistory.push(`[ä¸»æ’­æ—ç™½]: ${responseText}`);
            
            setTimeout(() => {
                triggerAiInLiveStream('audience');
            }, 1000 + Math.random() * 2000);

        } else { // audience
            const actions = parseAiResponse(responseText);
            if (Array.isArray(actions)) {
                for (const action of actions) {
                    if (action.type === 'like') {
                        handleUserLike();
                    } else {
                                                if (action.type === 'comment' && action.username.startsWith('[') && action.username.includes(']')) {
                            const match = action.username.match(/^(\[.*?\])/);
                            if (match) {
                                const originalUsername = action.username;
                                action.username = match[0];
                                const extraContent = originalUsername.replace(action.username, '').replace(/^:?\s*/, '').trim();
                                if (extraContent) {
                                    action.content = extraContent + ' ' + (action.content || '');
                                }
                            }
                        }
                        addLiveComment(action);
                    }

                    // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨è¿™é‡Œéšæœºè¿½åŠ ç‚¹èµã€‘ã€‘ã€‘
                    // æ¯å¤„ç†ä¸€æ¡å¼¹å¹•åï¼Œéƒ½æœ‰30%çš„å‡ ç‡è§¦å‘ä¸€æ¬¡ç‚¹èµ
                    if (Math.random() < 0.3) {
                        // æ¨¡æ‹Ÿç‚¹èµåŠ¨ç”»çš„å»¶è¿Ÿï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´è‡ªç„¶
                        setTimeout(handleUserLike, Math.random() * 200);
                    }

                    await new Promise(resolve => setTimeout(resolve, 150 + Math.random() * 250));
                }
                
                if (liveStreamState.streamerId !== 'user') {
                    setTimeout(() => {
                        triggerAiInLiveStream('host');
                    }, 1000 + Math.random() * 2000);
                }
            }
        }
    } catch (error) {
        console.error(`ç”Ÿæˆ ${actor} äº’åŠ¨å¤±è´¥:`, error);
        const nextActor = actor === 'host' ? 'audience' : 'host';
        setTimeout(() => triggerAiInLiveStream(nextActor), 5000);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ·»åŠ è¿™ä¸‰ä¸ªè¾…åŠ©å‡½æ•°åˆ°åŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
/**
 * åˆ‡æ¢åŠ¨æ€é¡µé¢çš„ç¼–è¾‘æ¨¡å¼
 */
function toggleQzoneEditMode() {
    isQzoneEditMode = !isQzoneEditMode;
    if (!isQzoneEditMode) {
        selectedPosts.clear(); // é€€å‡ºæ—¶æ¸…ç©ºé€‰æ‹©
    }
    renderQzonePosts(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ•´ä¸ªé¡µé¢çš„UI
}

/**
 * åˆ‡æ¢å•æ¡åŠ¨æ€çš„é€‰ä¸­çŠ¶æ€
 * @param {number} postId - è¢«ç‚¹å‡»çš„åŠ¨æ€ID
 */
function togglePostSelection(postId) {
    if (selectedPosts.has(postId)) {
        selectedPosts.delete(postId);
    } else {
        selectedPosts.add(postId);
    }
    // ä»…æ›´æ–°UIï¼Œä¸é‡æ–°è¯·æ±‚æ•°æ®
    const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
    if (postContainer) {
        postContainer.classList.toggle('selected', selectedPosts.has(postId));
    }
    updateDeleteSelectedPostsButton();
}

// â–¼â–¼â–¼ ã€Final Fortified Versionã€‘REPLACE your entire old updateDeleteSelectedPostsButton function with this block â–¼â–¼â–¼
/**
 * æ›´æ–°â€œåˆ é™¤â€æŒ‰é’®ä¸Šçš„è®¡æ•°
 */
function updateDeleteSelectedPostsButton() {
    // 1. First, try to find the button.
    const deleteBtn = document.getElementById('qzone-delete-selected-btn');

    // 2. ã€ã€ã€CORE FIX: The Safety Checkã€‘ã€‘ã€‘
    // Only proceed if the button actually exists in the DOM at this moment.
    if (deleteBtn) {
        // 3. If it exists, safely update its properties.
        deleteBtn.textContent = `åˆ é™¤(${selectedPosts.size})`;
        deleteBtn.style.color = selectedPosts.size > 0 ? '#ff3b30' : '#8a8a8a';
    }
    // 4. If it doesn't exist, the function simply does nothing and exits gracefully, preventing any errors.
}
// â–²â–²â–² Replacement End â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€æœ€ç»ˆç‰ˆæœ¬ V9ã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‚¨ç°æœ‰çš„æ•´ä¸ª addLiveComment å‡½æ•° â–¼â–¼â–¼
/**
 * åœ¨ç›´æ’­é—´å¤„ç†ä¸€ä¸ªæ–°çš„äº’åŠ¨è¡Œä¸º (V9 - é‡æ„ä»¥å¤„ç†è¯„è®º/ç¤¼ç‰©/è¿›åœº)
 * @param {object} action - AIç”Ÿæˆçš„äº’åŠ¨å¯¹è±¡
 * @param {boolean} fromUser - æ˜¯å¦æ˜¯ç”¨æˆ·è‡ªå·±å‘é€çš„
 */
function addLiveComment(action, fromUser = false) {
    
    // --- ã€ã€ã€æ ¸å¿ƒå‡çº§åŒºã€‘ã€‘ã€‘ ---
    // è¿™ä¸ªifå—ç°åœ¨åŒæ—¶å¤„ç†ç¤¼ç‰©å’Œæ–°åŠ å…¥çš„'join'äº‹ä»¶
    if (action.type === 'gift' || action.type === 'join') {
        const eventPill = document.createElement('div');
        eventPill.className = 'event-pill';

        // 1. æ™ºèƒ½åˆ¤æ–­å›¾æ ‡ï¼šæ˜¯charå¤´åƒè¿˜æ˜¯éšæœºEmoji
        const invitedAiChat = liveStreamState.invitedAiId ? state.chats[liveStreamState.invitedAiId] : null;
        const isChar = invitedAiChat && action.username === invitedAiChat.name;
        
        let iconHtml;
        if (isChar) {
            iconHtml = `<img src="${invitedAiChat.settings.avatar}" alt="">`;
        } else {
            const emojis = ['ğŸ¥³', 'ğŸ˜', 'ğŸ¤©', 'ğŸ‘‹', 'ğŸ‰', 'âœ¨'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            iconHtml = randomEmoji;
        }

        // 2. æ ¹æ®äº‹ä»¶ç±»å‹å‡†å¤‡æ–‡å­—å’Œæ ·å¼
        let primaryText, secondaryText;
        if (action.type === 'gift') {
            eventPill.classList.add('gift-event');
            const giftValue = parseFloat(action.giftValue) || 0;
            liveStreamState.totalGiftValue += giftValue;
            
            primaryText = action.username;
            secondaryText = `é€ä½  ${action.giftName}`;
            
            // ç¤¼ç‰©äº‹ä»¶éœ€è¦æ›´æ–°æ’è¡Œæ¦œå’Œè®°å½•å†å²
            const logMessage = `[ç¤¼ç‰©] ${action.username} é€å‡ºäº† ${action.giftName} (ä»·å€¼Â¥${giftValue.toFixed(2)})`;
            liveStreamState.commentHistory.push(logMessage);
            updateLiveRanking();
        } else { // 'join'
            eventPill.classList.add('join-event');
            primaryText = action.username;
            secondaryText = 'åŠ å…¥äº†ç›´æ’­é—´';
        }

        // 3. æ„å»ºå…¨æ–°çš„ã€ç¬¦åˆå›¾ç‰‡å‚è€ƒçš„HTMLç»“æ„
        eventPill.innerHTML = `
            <div class="event-icon">${iconHtml}</div>
            <div class="event-text">
                <span class="primary">${primaryText}</span>
                <span class="secondary">${secondaryText}</span>
            </div>
        `;
        
        // 4. è°ƒç”¨showLiveEventæ¥æ˜¾ç¤ºè¿™ä¸ªæ–°æ ·å¼çš„é€šçŸ¥
        showLiveEvent(eventPill);
        
        // 5. äº‹ä»¶å¤„ç†å®Œæ¯•ï¼Œç›´æ¥è¿”å›
        return;
    }

    // --- å¸¸è§„è¯„è®ºå¤„ç†é€»è¾‘ (è¿™éƒ¨åˆ†ä¿æŒæ‚¨åŸæœ‰çš„V6ç‰ˆæœ¬å³å¯) ---
    if (action.type === 'comment') {
        const feed = document.getElementById('live-comments-feed');
        const bubble = document.createElement('div');
        bubble.className = 'live-comment-bubble';
        
        let finalUsername = action.username;
        let finalContent = action.content || '';

        if (fromUser) {
            bubble.classList.add('host-comment');
        } 
        else {
            // ... (æ‚¨æ‰€æœ‰çš„åˆ¤æ–­å¤§ç²‰æ€§åˆ«ã€é‡‘ä¸»ã€å¯Œè±ªçš„é€»è¾‘éƒ½æ”¾åœ¨è¿™é‡Œï¼Œä¿æŒä¸å˜)
            const bigFanMatch = finalUsername.match(/^(\[.*?\])/);
            if (bigFanMatch) {
                const originalUsername = finalUsername;
                finalUsername = bigFanMatch[0];
                const extraContent = originalUsername.replace(finalUsername, '').replace(/^:?\s*/, '').trim();
                if (extraContent) { finalContent = extraContent + ' ' + finalContent; }
                const maleFanKeywords = ['çŒ«å“¥', 'Aä½¬', 'åä½™'];
                if (maleFanKeywords.some(keyword => finalUsername.includes(keyword))) {
                    bubble.classList.add('male-fan-comment');
                } else {
                    bubble.classList.add('big-fan-comment');
                }
            } 
            else if (liveStreamState.invitedAiId && state.chats[liveStreamState.invitedAiId] && finalUsername === state.chats[liveStreamState.invitedAiId].name) {
                bubble.classList.add('guest-comment');
            }
            else if (/(è€æ¿|å¯Œå©†|ç¥è±ª|è‘£äº‹é•¿)/.test(finalUsername)) {
                bubble.classList.add('rich-fan-comment');
            }
        }
        
        bubble.innerHTML = `<span class="username">${finalUsername}:</span><span class="content">${finalContent.trim()}</span>`;
        liveStreamState.commentHistory.push(`${finalUsername}: ${finalContent.trim()}`);

        const isAtBottom = feed.scrollTop <= -feed.scrollHeight + feed.clientHeight + 1;
        feed.prepend(bubble);
        if (isAtBottom) {
            feed.scrollTop = 0;
        }
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€ç²¾ç®€ç‰ˆã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ updateLiveStats å‡½æ•° â–¼â–¼â–¼
/**
 * æ›´æ–°ç›´æ’­é—´çš„ç»Ÿè®¡æ•°æ®ï¼ˆåœ¨çº¿äººæ•°ã€ç‚¹èµã€æ—¶é•¿ï¼‰
 */
function updateLiveStats() {
    // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†äººæ•°æ³¢åŠ¨é€»è¾‘ç›´æ¥ç§»åˆ°è¿™é‡Œ
    if (liveStreamState.isActive) {
        liveStreamState.viewerCount += Math.floor(Math.random() * 10) - 4;
        if (liveStreamState.viewerCount < 10) liveStreamState.viewerCount = 10;
        if (liveStreamState.viewerCount > liveStreamState.peakViewers) {
            liveStreamState.peakViewers = liveStreamState.viewerCount;
        }
    }
    
    // 2. æ›´æ–°UIçš„é€»è¾‘ä¿æŒä¸å˜
    document.getElementById('live-viewer-count').textContent = `${liveStreamState.viewerCount} äººæ­£åœ¨çœ‹`;
    document.getElementById('live-like-count').innerHTML = `â¤ï¸ ${liveStreamState.likes}`;
    const elapsed = Math.floor((Date.now() - liveStreamState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('live-duration').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * å¤„ç†ç”¨æˆ·ç‚¹èµ
 */
function handleUserLike() {
    liveStreamState.likes++;
    updateLiveStats();
    // åˆ›å»ºä¸€ä¸ªçˆ±å¿ƒåŠ¨ç”»
    const heart = document.createElement('span');
    heart.textContent = 'â¤ï¸';
    heart.className = 'like-burst-effect';
    heart.style.left = `${Math.random() * 40 + 65}%`; // åœ¨å³ä¾§éšæœºä½ç½®
    document.getElementById('live-stream-screen').appendChild(heart);
    setTimeout(() => heart.remove(), 600); // åŠ¨ç”»ç»“æŸåç§»é™¤
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€å…¨æ–°çš„ã€è§’è‰²åˆ†ç¦»ç‰ˆã€‘ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ sendLiveComment å‡½æ•° â–¼â–¼â–¼
const sendLiveComment = () => {
    const liveCommentInput = document.getElementById('live-comment-input');
    const text = liveCommentInput.value.trim();
    if (!text || !liveStreamState.isActive) return;
    
    // ã€æ ¸å¿ƒé€»è¾‘ã€‘åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯ä¸»æ’­è¿˜æ˜¯è§‚ä¼—
    if (liveStreamState.streamerId === 'user') {
        // --- æƒ…å†µ1: æˆ‘æ˜¯ä¸»æ’­ ---
        
        // a. å°†æˆ‘çš„å‘è¨€æ›´æ–°åˆ°ä¸»æ’­æ—ç™½åŒº
        const narrationContent = document.getElementById('live-host-narration-content');
        narrationContent.innerHTML = text.replace(/\n/g, '<br>');
        narrationContent.scrollTop = 0;
        
        // b. æ›´æ–°ç›´æ’­çŠ¶æ€ï¼Œè®©AIç²‰ä¸èƒ½çœ‹åˆ°æˆ‘çš„æœ€æ–°å‘è¨€
        liveStreamState.hostNarration = text;
        const commentLog = `[ä¸»æ’­ ${liveStreamState.streamerNickname}]: ${text}`;
        liveStreamState.commentHistory.push(commentLog);
        
        // c. æ¸…ç©ºè¾“å…¥æ¡†
        liveCommentInput.value = '';

        // d. ã€å…³é”®ã€‘è§¦å‘AIç²‰ä¸å¯¹æˆ‘å‘è¨€çš„å›åº”
        triggerAiInLiveStream('audience');

    } else {
        // --- æƒ…å†µ2: æˆ‘æ˜¯è§‚ä¼— ---
        
        // a. ç¡®å®šæˆ‘çš„æ˜µç§°
        let commenterName = '';
        const { invitedAiId } = liveStreamState;
        // å¦‚æœæˆ‘æ˜¯è¢«é‚€è¯·çš„é‡‘ä¸»
        if (invitedAiId && state.chats[invitedAiId]) {
            const invitedAiChat = state.chats[invitedAiId];
            commenterName = invitedAiChat.settings.myNickname || 'æˆ‘';
        } else { // å¦‚æœæˆ‘æ˜¯æ™®é€šè§‚ä¼—ï¼ˆæ¯”å¦‚AIå¼€æ’­ï¼Œæˆ‘ç‚¹è¿›å»çœ‹ï¼‰
            commenterName = state.qzoneSettings.nickname || 'æˆ‘';
        }

        // b. å°†æˆ‘çš„å‘è¨€æ·»åŠ åˆ°è¯„è®ºåŒº
        addLiveComment({ type: 'comment', username: commenterName, content: text }, true);
        
        // c. æ›´æ–°å¼¹å¹•å†å²
        liveStreamState.commentHistory.push(`${commenterName}: ${text}`);
        
        // d. æ¸…ç©ºè¾“å…¥æ¡†
        liveCommentInput.value = '';

        // e. ã€å…³é”®ã€‘è§¦å‘AIä¸»æ’­å¯¹æˆ‘å‘è¨€çš„å›åº”
        triggerAiInLiveStream('host');
    }
};
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„äº”å­æ£‹æ¸¸æˆé€»è¾‘ä»£ç ï¼Œç²˜è´´åˆ°æ‚¨çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

// --- 1. äº”å­æ£‹æ¸¸æˆçŠ¶æ€ç®¡ç† ---
let gomokuState = {};

const DEFAULT_GOMOKU_STATE = {
    isActive: false,
    isGameStarted: false,
    boardState: [], // 15x15 çš„äºŒç»´æ•°ç»„, 0: empty, 1: user, 2: ai
    currentPlayer: 'user', // 'user' æˆ– 'ai'
    moveHistory: [], // å­˜å‚¨ {row, col, player}
    winner: null,
    turnTimerId: null,
    turnTimeLeft: 30
};

// --- 2. æ¸¸æˆæ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

/**
 * åˆå§‹åŒ–å¹¶å¼€å§‹ä¸€å±€æ–°çš„äº”å­æ£‹æ¸¸æˆ
 */
async function startGomokuGame() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
    gomokuState = JSON.parse(JSON.stringify(DEFAULT_GOMOKU_STATE));
    gomokuState.isActive = true;
    gomokuState.isGameStarted = true;
    
    // åˆ›å»º15x15çš„æ£‹ç›˜æ•°æ®
    gomokuState.boardState = Array(15).fill(null).map(() => Array(15).fill(0));
    
    // éšè—å¼€å§‹æŒ‰é’®
    document.getElementById('gomoku-start-overlay').classList.remove('visible');
    
    // æ¸²æŸ“æ£‹ç›˜
    renderGomokuBoard();
    
    // å‘é€æ¸¸æˆå¼€å§‹çš„ç³»ç»Ÿæ¶ˆæ¯
    addMessageToAutoChessChat('system', 'æ¸¸æˆå¼€å§‹ï¼ä½ æ‰§ç™½æ£‹ï¼Œè¯·å…ˆè½å­ã€‚');
    
    // å¯åŠ¨ç¬¬ä¸€å›åˆçš„è®¡æ—¶å™¨
    startTurnTimer();
}

/**
 * æ¸²æŸ“äº”å­æ£‹æ£‹ç›˜å’Œæ£‹å­
 */
function renderGomokuBoard() {
    const gridEl = document.getElementById('gomoku-grid');
    gridEl.innerHTML = ''; // æ¸…ç©ºæ£‹ç›˜

    for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
            const cell = document.createElement('div');
            cell.className = 'gomoku-cell';
            cell.dataset.row = r;
            cell.dataset.col = c;

            // æ ‡è®°æ˜Ÿä½
            if ((r === 3 || r === 11) && (c === 3 || c === 11) || (r === 7 && c === 7)) {
                cell.classList.add('star-point');
            }
            
            // æ”¾ç½®æ£‹å­
            if (gomokuState.boardState[r][c] !== 0) {
                const piece = document.createElement('div');
                piece.className = 'piece';
                if (gomokuState.boardState[r][c] === 1) {
                    piece.classList.add('white-piece'); // ç”¨æˆ·æ˜¯ç™½æ£‹
                } else {
                    piece.classList.add('black-piece'); // AIæ˜¯é»‘æ£‹
                }
                cell.appendChild(piece);
            }
            gridEl.appendChild(cell);
        }
    }
    
    // æ ‡è®°ä¸Šä¸€æ­¥è½å­
    if (gomokuState.moveHistory.length > 0) {
        const lastMove = gomokuState.moveHistory[gomokuState.moveHistory.length - 1];
        const lastMoveCell = gridEl.querySelector(`.gomoku-cell[data-row='${lastMove.row}'][data-col='${lastMove.col}']`);
        if (lastMoveCell) {
            const marker = document.createElement('div');
            marker.className = 'last-move-marker';
            lastMoveCell.appendChild(marker);
        }
    }
    
    // æ›´æ–°å½“å‰ç©å®¶é«˜äº®
    document.querySelector('#gomoku-screen .player-card.user').classList.toggle('current-player', gomokuState.currentPlayer === 'user');
    document.querySelector('#gomoku-screen .player-card.ai').classList.toggle('current-player', gomokuState.currentPlayer === 'ai');
}

/**
 * å¤„ç†ç”¨æˆ·ç‚¹å‡»æ£‹ç›˜æ ¼å­çš„äº‹ä»¶
 * @param {number} row - ç‚¹å‡»çš„è¡Œ
 * @param {number} col - ç‚¹å‡»çš„åˆ—
 */
async function handleCellClick(row, col) {
    if (gomokuState.winner || gomokuState.currentPlayer !== 'user' || gomokuState.boardState[row][col] !== 0) {
        return; // æ¸¸æˆç»“æŸã€ä¸æ˜¯ä½ çš„å›åˆã€æˆ–è¯¥ä½ç½®å·²æœ‰æ£‹å­
    }

    // 1. ç©å®¶è½å­
    gomokuState.boardState[row][col] = 1; // 1ä»£è¡¨ç”¨æˆ·(ç™½æ£‹)
    gomokuState.moveHistory.push({ row, col, player: 'user' });
    
    // 2. é‡æ–°æ¸²æŸ“æ£‹ç›˜
    renderGomokuBoard();
    
    // 3. æ£€æŸ¥æ˜¯å¦è·èƒœ
    if (checkForWin(row, col)) {
        endGomokuGame('user');
        return;
    }
    
    // 4. åˆ‡æ¢å›åˆ
    switchTurn();
}

/**
 * æ£€æŸ¥åœ¨(row, col)è½å­åæ˜¯å¦äº§ç”Ÿèƒœåˆ©è€…
 * @param {number} row - åˆšè½å­çš„è¡Œ
 * @param {number} col - åˆšè½å­çš„åˆ—
 * @returns {boolean} - æ˜¯å¦èƒœåˆ©
 */
function checkForWin(row, col) {
    const player = gomokuState.boardState[row][col];
    if (player === 0) return false;

    const directions = [
        [1, 0],  // æ°´å¹³
        [0, 1],  // å‚ç›´
        [1, 1],  // å³ä¸‹æ–œ
        [1, -1]  // å³ä¸Šæ–œ
    ];

    for (const [dr, dc] of directions) {
        let count = 1;
        // å‘ä¸€ä¸ªæ–¹å‘æ£€æŸ¥
        for (let i = 1; i < 5; i++) {
            const r = row + i * dr;
            const c = col + i * dc;
            if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuState.boardState[r][c] === player) {
                count++;
            } else {
                break;
            }
        }
        // å‘ç›¸åæ–¹å‘æ£€æŸ¥
        for (let i = 1; i < 5; i++) {
            const r = row - i * dr;
            const c = col - i * dc;
            if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuState.boardState[r][c] === player) {
                count++;
            } else {
                break;
            }
        }
        if (count >= 5) return true;
    }
    return false;
}


/**
 * åˆ‡æ¢ç©å®¶å›åˆ
 */
function switchTurn() {
    gomokuState.currentPlayer = gomokuState.currentPlayer === 'user' ? 'ai' : 'user';
    startTurnTimer(); // é‡ç½®å¹¶å¯åŠ¨æ–°å›åˆçš„è®¡æ—¶å™¨
    
    if (gomokuState.currentPlayer === 'ai') {
        // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œæ¨¡æ‹ŸAIæ€è€ƒ
        setTimeout(handleAiTurn, 1000 + Math.random() * 1500);
    }
}

/**
 * å¯åŠ¨å›åˆå€’è®¡æ—¶
 */
function startTurnTimer() {
    if (gomokuState.turnTimerId) {
        clearInterval(gomokuState.turnTimerId);
    }
    gomokuState.turnTimeLeft = 30;
    const timerDisplay = document.getElementById('gomoku-timer-display');
    timerDisplay.textContent = gomokuState.turnTimeLeft;
    
    gomokuState.turnTimerId = setInterval(() => {
        gomokuState.turnTimeLeft--;
        timerDisplay.textContent = gomokuState.turnTimeLeft;
        if (gomokuState.turnTimeLeft <= 0) {
            clearInterval(gomokuState.turnTimerId);
            addMessageToAutoChessChat('system', `${gomokuState.currentPlayer === 'user' ? 'ä½ ' : 'å¯¹æ–¹'} è¶…æ—¶ï¼Œå›åˆè‡ªåŠ¨è·³è¿‡ã€‚`);
            switchTurn();
        }
    }, 1000);
}


// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™ã€ä¸€æ•´å—å…¨æ–°çš„AIé€»è¾‘ä»£ç ã€‘ï¼Œå®Œæ•´æ›¿æ¢æ‰æ—§çš„ handleAiTurn å‡½æ•° â–¼â–¼â–¼

/**
 * ã€AIå¤§è„‘ - ä¸»å‡½æ•°ã€‘å¤„ç†AIçš„å›åˆé€»è¾‘ (V2 - è¯„åˆ†å†³ç­–ç‰ˆ)
 * AIä¼šè¯„ä¼°æ‰€æœ‰å¯è½å­ç‚¹ï¼Œé€‰æ‹©åˆ†æ•°æœ€é«˜çš„ç‚¹ã€‚
 */
async function handleAiTurn() {
    if (gomokuState.winner || gomokuState.currentPlayer !== 'ai') return;
    
    // æ¨¡æ‹Ÿæ€è€ƒå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1000));

    let bestMove = { row: -1, col: -1 };
    let maxScore = -1;

    // éå†æ£‹ç›˜ä¸Šæ‰€æœ‰ç©ºç‚¹
    for (let r = 0; r < 15; r++) {
        for (let c = 0; c < 15; c++) {
            if (gomokuState.boardState[r][c] === 0) {
                // è®¡ç®—åœ¨è¯¥ç‚¹è½å­çš„åˆ†æ•°
                const score = calculateScoreForCell(r, c);
                if (score > maxScore) {
                    maxScore = score;
                    bestMove = { row: r, col: c };
                }
            }
        }
    }

    // AIè½å­
    const { row, col } = bestMove;
    gomokuState.boardState[row][col] = 2; // 2ä»£è¡¨AI(é»‘æ£‹)
    gomokuState.moveHistory.push({ row, col, player: 'ai' });
    
    renderGomokuBoard();
    
    if (checkForWin(row, col)) {
        endGomokuGame('ai');
        return;
    }
    
    switchTurn();
}

/**
 * ã€AIå¤§è„‘ - è¯„ä¼°æ¨¡å—ã€‘è®¡ç®—åœ¨æŒ‡å®šä½ç½®è½å­çš„æ€»åˆ†
 * åˆ†æ•° = AI åœ¨æ­¤è½å­çš„è¿›æ”»åˆ†æ•° + ç©å®¶åœ¨æ­¤è½å­çš„é˜²å®ˆåˆ†æ•°
 * @param {number} row - è¯„ä¼°çš„è¡Œ
 * @param {number} col - è¯„ä¼°çš„åˆ—
 * @returns {number} - è¯¥ä½ç½®çš„æ€»åˆ†
 */
function calculateScoreForCell(row, col) {
    // 1. è®¡ç®—AIåœ¨æ­¤å¤„è½å­çš„è¿›æ”»åˆ†æ•°
    gomokuState.boardState[row][col] = 2; // å‡è®¾AIè½å­
    const aiScore = evaluateAllDirections(row, col, 2);
    
    // 2. è®¡ç®—ç©å®¶åœ¨æ­¤å¤„è½å­çš„é˜²å®ˆåˆ†æ•° (å µä½ç©å®¶)
    gomokuState.boardState[row][col] = 1; // å‡è®¾ç©å®¶è½å­
    const userScore = evaluateAllDirections(row, col, 1);
    
    // 3. æ¢å¤æ£‹ç›˜
    gomokuState.boardState[row][col] = 0;
    
    // è¿”å›æ€»åˆ†ï¼Œé˜²å®ˆåˆ†æƒé‡ç•¥é«˜ï¼Œè®©AIæ›´å€¾å‘äºé˜²å®ˆ
    return aiScore + userScore * 1.1;
}

/**
 * ã€AIå¤§è„‘ - æ ¸å¿ƒç®—å­ã€‘è¯„ä¼°ä¸€ä¸ªå­åœ¨å››ä¸ªæ–¹å‘ä¸Šå½¢æˆçš„æ£‹å‹å¹¶ç»™å‡ºåˆ†æ•°
 * @param {number} row - æ£‹å­è¡Œ
 * @param {number} col - æ£‹å­åˆ—
 * @param {number} player - 1 for user, 2 for AI
 * @returns {number} - è¯¥æ£‹å­åœ¨æ‰€æœ‰æ–¹å‘ä¸Šçš„æ€»åˆ†
 */
function evaluateAllDirections(row, col, player) {
    const scores = {
        FIVE: 100000,      // è¿äº”ï¼Œå¿…èƒœ
        LIVE_FOUR: 10000,  // æ´»å››
        DEAD_FOUR: 1000,   // å†²å››
        LIVE_THREE: 1000,  // æ´»ä¸‰
        DEAD_THREE: 100,   // çœ ä¸‰
        LIVE_TWO: 100,     // æ´»äºŒ
        DEAD_TWO: 10,      // çœ äºŒ
        LIVE_ONE: 10,      // æ´»ä¸€
        DEAD_ONE: 1        // çœ ä¸€
    };

    let totalScore = 0;
    const directions = [[1, 0], [0, 1], [1, 1], [1, -1]]; // æ°´å¹³, å‚ç›´, å³ä¸‹æ–œ, å³ä¸Šæ–œ

    for (const [dr, dc] of directions) {
        let consecutive = 1;
        let openEnds = 0;

        // å‘æ­£æ–¹å‘æœç´¢
        for (let i = 1; i < 5; i++) {
            const r = row + i * dr;
            const c = col + i * dc;
            if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuState.boardState[r][c] === player) {
                consecutive++;
            } else {
                if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuState.boardState[r][c] === 0) {
                    openEnds++;
                }
                break;
            }
        }

        // å‘åæ–¹å‘æœç´¢
        for (let i = 1; i < 5; i++) {
            const r = row - i * dr;
            const c = col - i * dc;
            if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuState.boardState[r][c] === player) {
                consecutive++;
            } else {
                if (r >= 0 && r < 15 && c >= 0 && c < 15 && gomokuState.boardState[r][c] === 0) {
                    openEnds++;
                }
                break;
            }
        }
        
        if (consecutive >= 5) totalScore += scores.FIVE;
        else if (consecutive === 4) {
            totalScore += (openEnds === 2) ? scores.LIVE_FOUR : (openEnds === 1 ? scores.DEAD_FOUR : 0);
        } else if (consecutive === 3) {
            totalScore += (openEnds === 2) ? scores.LIVE_THREE : (openEnds === 1 ? scores.DEAD_THREE : 0);
        } else if (consecutive === 2) {
            totalScore += (openEnds === 2) ? scores.LIVE_TWO : (openEnds === 1 ? scores.DEAD_TWO : 0);
        } else if (consecutive === 1) {
            totalScore += (openEnds === 2) ? scores.LIVE_ONE : (openEnds === 1 ? scores.DEAD_ONE : 0);
        }
    }
    return totalScore;
}

// â–²â–²â–² å…¨æ–°AIé€»è¾‘ä»£ç æ›¿æ¢åˆ°æ­¤ç»“æŸ â–²â–²â–²

/**
 * æ‚”æ£‹æ“ä½œ
 */
async function handleUndo() {
    if (gomokuState.moveHistory.length === 0 || gomokuState.winner) return;

    // å…è®¸æ‚”æ‰æœ€åä¸€æ­¥æ£‹
    const lastMove = gomokuState.moveHistory.pop();
    gomokuState.boardState[lastMove.row][lastMove.col] = 0;
    
    // åˆ‡æ¢å›ä¸Šä¸€æ­¥çš„ç©å®¶
    gomokuState.currentPlayer = lastMove.player;
    
    renderGomokuBoard();
    startTurnTimer(); // é‡å¯è®¡æ—¶å™¨
    addMessageToAutoChessChat('system', 'æ‚”æ£‹æˆåŠŸï¼');
}

/**
 * ç»“æŸæ¸¸æˆ
 * @param {string|null} winner - 'user', 'ai', æˆ– null (å¹³å±€)
 */
function endGomokuGame(winner) {
    clearInterval(gomokuState.turnTimerId);
    gomokuState.winner = winner;
    
    let message = '';
    if (winner === 'user') {
        message = 'æ­å–œä½ ï¼Œä½ èµ¢äº†ï¼';
    } else if (winner === 'ai') {
        message = 'çœŸé—æ†¾ï¼Œä½ è¾“äº†ã€‚';
    } else {
        message = 'å¹³å±€ï¼';
    }
    
    setTimeout(async () => {
        await showCustomAlert('æ¸¸æˆç»“æŸ', message);
        document.getElementById('gomoku-start-overlay').classList.add('visible'); // æ˜¾ç¤ºé‡æ–°å¼€å§‹æŒ‰é’®
    }, 500);
}

/**
 * å¤„ç†æ‹ä¸€æ‹å¤´åƒçš„äº’åŠ¨
 * @param {string} target - 'user' æˆ– 'ai'
 */
function handleAvatarPat(target) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    const aiName = chat.name;
    
    let patMessage = '';
    if (target === 'ai') {
        patMessage = `${myNickname} æ‹äº†æ‹ ${aiName}`;
    } else {
        patMessage = `${aiName} æ‹äº†æ‹ ${myNickname}`;
    }
    
    addMessageToAutoChessChat('system', `[${patMessage}]`);

    // æ‹å¯¹æ–¹æ—¶ï¼Œå¯ä»¥è§¦å‘AIå›åº”
    if (target === 'ai') {
        triggerAiInAutoChess(`[ç³»ç»Ÿäº‹ä»¶ï¼šä½ è¢«ç”¨æˆ·æ‹äº†æ‹ã€‚]`);
    }
}

// è¿™æ˜¯ä¸€ä¸ªæ–°çš„è§¦å‘AIæ€è€ƒçš„å‡½æ•°ï¼Œä¸“ç”¨äºäº”å­æ£‹æ¸¸æˆ
async function triggerAiInAutoChess(triggeringEventDescription) {
    // è¿™ä¸ªå‡½æ•°åŸºæœ¬å¯ä»¥å¤ç”¨æ‚¨æ—§çš„ triggerAiInAutoChess, ä½†éœ€è¦ä¿®æ”¹System Prompt
    // ä¸ºç®€åŒ–èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåªå®ç°ä¸€ä¸ªç®€å•çš„ç‰ˆæœ¬
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    const typingIndicator = document.getElementById('ac-typing-indicator');
    typingIndicator.style.display = 'flex';

    // ç®€å•çš„èŠå¤©è§¦å‘
    const simplePrompt = `ä½ æ­£åœ¨å’Œç”¨æˆ·ç©äº”å­æ£‹ã€‚åˆšåˆšå‘ç”Ÿäº†äº‹ä»¶: "${triggeringEventDescription}"ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾(${chat.settings.aiPersona})å¯¹æ­¤å‘è¡¨ä¸€äº›è¯„è®ºã€‚`;
    const messagesForApi = [
        { role: 'system', content: simplePrompt },
        { role: 'user', content: triggeringEventDescription }
    ];

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, simplePrompt, messagesForApi, isGemini);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.8 })
        });

        if (!response.ok) throw new Error((await response.json()).error.message);
        
        const data = await response.json();
        const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        addMessageToAutoChessChat('assistant', aiResponse);

    } catch (error) {
        addMessageToAutoChessChat('system', `[AIå‡ºé”™äº†: ${error.message}]`);
    } finally {
        typingIndicator.style.display = 'none';
    }
}


// â–²â–²â–² å…¨æ–°äº”å­æ£‹JSé€»è¾‘åˆ°æ­¤ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸Šä¸‹æ–‡èœå•æ ¸å¿ƒé€»è¾‘ â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€å®šä½ä¼˜åŒ–ç‰ˆã€‘æ˜¾ç¤ºå¹¶å®šä½ä¸Šä¸‹æ–‡æ“ä½œèœå• â–¼â–¼â–¼
/**
 * ã€é‡æ„ç‰ˆ V2ã€‘æ˜¾ç¤ºå¹¶å®šä½ä¸Šä¸‹æ–‡æ“ä½œèœå• (é»˜è®¤åœ¨ä¸‹æ–¹)
 * @param {number} timestamp - è¢«é•¿æŒ‰æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showMessageActions(timestamp) {
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    const menu = document.getElementById('message-actions-menu');
    const messageBubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
    if (!messageBubble) return;

    // 1. è·å–ç›®æ ‡æ°”æ³¡å’Œå±å¹•çš„å°ºå¯¸ä¸ä½ç½®
    const bubbleRect = messageBubble.getBoundingClientRect();
    const screenRect = document.getElementById('phone-screen').getBoundingClientRect();

    // 2. æ˜¾ç¤ºèœå•ï¼Œä½†å…ˆè®©å®ƒé€æ˜ï¼Œä»¥ä¾¿æˆ‘ä»¬è®¡ç®—å®ƒçš„å°ºå¯¸
    menu.classList.add('visible');
    const menuRect = menu.getBoundingClientRect();

    // 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è®¡ç®—ç†æƒ³ä½ç½®
    // æ°´å¹³å±…ä¸­ (é€»è¾‘ä¸å˜)
    let left = bubbleRect.left + (bubbleRect.width / 2) - (menuRect.width / 2);
    
    // â–¼â–¼â–¼ é»˜è®¤å®šä½é€»è¾‘å·²ä¿®æ”¹ä¸ºåœ¨æ°”æ³¡ä¸‹æ–¹ â–¼â–¼â–¼
    let top = bubbleRect.bottom + 10; // 10px é—´è·

    // 4. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¾¹ç¼˜æ£€æµ‹ä¸ä½ç½®ä¿®æ­£é€»è¾‘ä¹Ÿç›¸åº”è°ƒæ•´
    // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼Œåˆ™ç§»åŠ¨åˆ°ä¸Šæ–¹
    if (top + menuRect.height > screenRect.bottom - 10) {
        top = bubbleRect.top - menuRect.height - 10;
    }
    // (æ°´å¹³æ–¹å‘çš„è¾¹ç¼˜æ£€æµ‹ä¿æŒä¸å˜)
    if (left < screenRect.left + 10) {
        left = screenRect.left + 10;
    }
    if (left + menuRect.width > screenRect.right - 10) {
        left = screenRect.right - menuRect.width - 10;
    }

    // 5. åº”ç”¨æœ€ç»ˆè®¡ç®—å‡ºçš„ä½ç½® (é€»è¾‘ä¸å˜)
    menu.style.top = `${top - screenRect.top}px`;
    menu.style.left = `${left - screenRect.left}px`;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€é‡æ„ç‰ˆã€‘éšè—ä¸Šä¸‹æ–‡æ“ä½œèœå•
 */
function hideMessageActions() {
    const menu = document.getElementById('message-actions-menu');
    menu.classList.remove('visible');
    activeMessageTimestamp = null;
}
// â–²â–²â–² é‡æ„ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬,æ›¿æ¢æ—§çš„ openMessageEditor å‡½æ•° â–¼â–¼â–¼
async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘å°† share_link ä¹ŸåŠ å…¥ç‰¹æ®Šç±»å‹åˆ¤æ–­
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        } 
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘å¤„ç†åˆ†äº«é“¾æ¥ç±»å‹çš„æ¶ˆæ¯
        else if (message.type === 'share_link') {
            fullMessageObject.title = message.title;
            fullMessageObject.description = message.description;
            fullMessageObject.source_name = message.source_name;
            fullMessageObject.content = message.content;
        }
        contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'link' æ¨¡æ¿
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' }
    };

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œé“¾æ¥â€æŒ‰é’®
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘æ¶ˆæ¯', 
        'åœ¨æ­¤ä¿®æ”¹,æˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä½¿ç”¨æ ¼å¼æ¨¡æ¿...',
        contentForEditing, 
        'textarea',
        helpersHtml
    );

    if (newContent !== null) {
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘è¿™é‡Œè°ƒç”¨çš„åº”è¯¥æ˜¯ saveEditedMessage,è€Œä¸æ˜¯ saveAdvancedEditor
        await saveEditedMessage(timestampToEdit, newContent, true);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * å¤åˆ¶æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹åˆ°å‰ªè´´æ¿
 */
async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hideMessageActions();
}

// â–¼â–¼â–¼ ã€åŠŸèƒ½ä¿®å¤ç‰ˆã€‘å¤´åƒç¼–è¾‘å™¨æ ¸å¿ƒåŠŸèƒ½ â–¼â–¼â–¼

/**
 * æ‰“å¼€AIå¤´åƒè®¾ç½®æ¨¡æ€æ¡†
 */
function openAiAvatarEditor() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    
    avatarEditorContext = {
        target: 'ai',
        newAvatarSrc: chat.settings.aiAvatar || defaultAvatar,
        newFrameSrc: chat.settings.aiAvatarFrame || ''
    };

    document.getElementById('ai-editor-preview-img').src = avatarEditorContext.newAvatarSrc;
    const frameImg = document.getElementById('ai-editor-preview-frame');
    frameImg.src = avatarEditorContext.newFrameSrc;
    frameImg.style.display = avatarEditorContext.newFrameSrc ? 'block' : 'none';

    document.getElementById('ai-avatar-editor-modal').classList.add('visible');
}

/**
 * æ‰“å¼€æˆ‘çš„å¤´åƒè®¾ç½®æ¨¡æ€æ¡†
 */
function openMyAvatarEditor() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    
    avatarEditorContext = {
        target: 'my',
        newAvatarSrc: chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar),
        newFrameSrc: chat.settings.myAvatarFrame || ''
    };
    
    document.getElementById('my-editor-preview-img').src = avatarEditorContext.newAvatarSrc;
    const frameImg = document.getElementById('my-editor-preview-frame');
    frameImg.src = avatarEditorContext.newFrameSrc;
    frameImg.style.display = avatarEditorContext.newFrameSrc ? 'block' : 'none';

    document.getElementById('my-avatar-editor-modal').classList.add('visible');
}

/**
 * å¤„ç†å¤´åƒç¼–è¾‘å™¨å†…çš„æ–‡ä»¶ä¸Šä¼ 
 */
function handleAvatarEditorUpload() {
    const inputId = `${avatarEditorContext.target}-avatar-editor-upload-input`;
    document.getElementById(inputId).click();
}

/**
 * é¢„è§ˆä¸Šä¼ çš„å¤´åƒ
 */
function previewEditorAvatar(inputId) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const base64 = e.target.result;
        avatarEditorContext.newAvatarSrc = base64;
        document.getElementById(`${avatarEditorContext.target}-editor-preview-img`).src = base64;
    };
    reader.readAsDataURL(file);
    fileInput.value = '';
}

/**
 * ä¸ºç¼–è¾‘å™¨é€‰æ‹©å¤´åƒæ¡†
 */
function selectFrameForEditor() {
    openAvatarFrameLibrary();
}

/**
 * ç§»é™¤ç¼–è¾‘å™¨ä¸­çš„å¤´åƒæ¡†é¢„è§ˆ
 */
function removeFrameFromEditor() {
    avatarEditorContext.newFrameSrc = '';
    const frameImg = document.getElementById(`${avatarEditorContext.target}-editor-preview-frame`);
    frameImg.src = '';
    frameImg.style.display = 'none';
}

/**
 * ä¿å­˜å¤´åƒç¼–è¾‘å™¨çš„æ‰€æœ‰æ›´æ”¹
 */
async function saveAvatarEditorSettings() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (avatarEditorContext.target === 'ai') {
        chat.settings.aiAvatar = avatarEditorContext.newAvatarSrc;
        chat.settings.aiAvatarFrame = avatarEditorContext.newFrameSrc;
        document.getElementById('ai-avatar-editor-modal').classList.remove('visible');
    } else if (avatarEditorContext.target === 'my') {
        chat.settings.myAvatar = avatarEditorContext.newAvatarSrc;
        chat.settings.myAvatarFrame = avatarEditorContext.newFrameSrc;
        document.getElementById('my-avatar-editor-modal').classList.remove('visible');
    }

    await db.chats.put(chat);
    
    document.getElementById('chat-settings-btn').click(); 
    
    renderChatInterface(chat.id);
    renderChatList();
}

// ç»‘å®šæ‰€æœ‰æ–°æŒ‰é’®çš„äº‹ä»¶
document.getElementById('settings-ai-avatar-clickable').addEventListener('click', openAiAvatarEditor);
document.getElementById('settings-my-avatar-clickable').addEventListener('click', openMyAvatarEditor);

document.getElementById('ai-editor-cancel-btn').addEventListener('click', () => document.getElementById('ai-avatar-editor-modal').classList.remove('visible'));
document.getElementById('my-editor-cancel-btn').addEventListener('click', () => document.getElementById('my-avatar-editor-modal').classList.remove('visible'));

document.getElementById('ai-editor-save-btn').addEventListener('click', saveAvatarEditorSettings);
document.getElementById('my-editor-save-btn').addEventListener('click', saveAvatarEditorSettings);

document.getElementById('ai-editor-upload-btn').addEventListener('click', handleAvatarEditorUpload);
document.getElementById('my-editor-upload-btn').addEventListener('click', handleAvatarEditorUpload);

document.getElementById('ai-avatar-editor-upload-input').addEventListener('change', () => previewEditorAvatar('ai-avatar-editor-upload-input'));
document.getElementById('my-avatar-editor-upload-input').addEventListener('change', () => previewEditorAvatar('my-avatar-editor-upload-input'));

document.getElementById('ai-editor-manage-library-btn').addEventListener('click', openAiAvatarLibraryModal);
// ã€æ ¸å¿ƒä¿®å¤ã€‘æ¢å¤äº†â€œäººè®¾é¢„è®¾åº“â€æŒ‰é’®çš„äº‹ä»¶ç»‘å®š
document.getElementById('my-editor-persona-library-btn').addEventListener('click', openPersonaLibrary);

document.getElementById('ai-editor-select-frame-btn').addEventListener('click', selectFrameForEditor);
document.getElementById('my-editor-select-frame-btn').addEventListener('click', selectFrameForEditor);

document.getElementById('ai-editor-remove-frame-btn').addEventListener('click', removeFrameFromEditor);
document.getElementById('my-editor-remove-frame-btn').addEventListener('click', removeFrameFromEditor);

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²æ›´æ–°ã€‘çš„ç‰ˆæœ¬,æ›¿æ¢æ—§çš„ createMessageEditorBlock å‡½æ•° â–¼â–¼â–¼
/**
 * åˆ›å»ºä¸€ä¸ªå¯ç¼–è¾‘çš„æ¶ˆæ¯å—(åŒ…å«æ–‡æœ¬æ¡†ã€æ ¼å¼åŠ©æ‰‹å’Œåˆ é™¤æŒ‰é’®)
 * @param {string} initialContent - æ–‡æœ¬æ¡†çš„åˆå§‹å†…å®¹
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„DOMå…ƒç´ 
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨è¿™é‡Œæ·»åŠ  'link' æ¨¡æ¿
    const templates = {
        voice: { type: 'voice_message', content: 'åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹' },
        image: { type: 'ai_image', description: 'åœ¨è¿™é‡Œè¾“å…¥å›¾ç‰‡æè¿°' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ä¸€ç‚¹å¿ƒæ„' },
        link: { type: 'share_link', title: 'æ–‡ç« æ ‡é¢˜', description: 'æ–‡ç« æ‘˜è¦...', source_name: 'æ¥æºç½‘ç«™', content: 'æ–‡ç« å®Œæ•´å†…å®¹...' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="åˆ é™¤æ­¤æ¡">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>è¯­éŸ³</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>è½¬è´¦</button>
            <!-- ã€æ ¸å¿ƒä¿®æ”¹2ã€‘åœ¨è¿™é‡Œæ·»åŠ æ–°çš„â€œé“¾æ¥â€æŒ‰é’® -->
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>é“¾æ¥</button>
        </div>
    `;

    // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€ä¸ªç¼–è¾‘å—
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¡æ¶ˆæ¯ã€‚');
        }
    });

    // ç»‘å®šæ ¼å¼åŠ©æ‰‹æŒ‰é’®äº‹ä»¶
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("è§£ææ ¼å¼æ¨¡æ¿å¤±è´¥:", e); }
            }
        });
    });

    return block;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°å‡çº§ç‰ˆã€‘è¯·ç”¨æ­¤å‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ openAdvancedMessageEditor â–¼â–¼â–¼
/**
 * æ‰“å¼€å…¨æ–°çš„ã€å¯è§†åŒ–çš„å¤šæ¶ˆæ¯ç¼–è¾‘å™¨,å¹¶åŠ¨æ€ç»‘å®šå…¶æ‰€æœ‰æŒ‰é’®äº‹ä»¶
 */
function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    // 1. ã€æ ¸å¿ƒã€‘åœ¨å…³é—­æ—§èœå•å‰,å°†éœ€è¦çš„æ—¶é—´æˆ³æ•è·åˆ°å±€éƒ¨å˜é‡ä¸­
    const timestampToEdit = activeMessageTimestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    // 2. ç°åœ¨å¯ä»¥å®‰å…¨åœ°å…³é—­æ—§èœå•äº†,å› ä¸ºå®ƒä¸ä¼šå½±å“æˆ‘ä»¬çš„å±€éƒ¨å˜é‡
    hideMessageActions(); 

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = ''; 

    // 3. å‡†å¤‡åˆå§‹å†…å®¹
    let initialContent;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content;
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        initialContent = JSON.stringify(message.content, null, 2);
    } else {
        initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);

    // 4. ã€æ ¸å¿ƒã€‘åŠ¨æ€ç»‘å®šæ‰€æœ‰æ§åˆ¶æŒ‰é’®çš„äº‹ä»¶
    // ä¸ºäº†é˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š,æˆ‘ä»¬ä½¿ç”¨å…‹éš†èŠ‚ç‚¹çš„æ–¹æ³•æ¥æ¸…é™¤æ—§ç›‘å¬å™¨
    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
        const newBlock = createMessageEditorBlock();
        editorContainer.appendChild(newBlock);
        newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
        editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    // å°†æ•è·åˆ°çš„æ—¶é—´æˆ³,ç›´æ¥ç»‘å®šç»™è¿™ä¸€æ¬¡çš„ä¿å­˜ç‚¹å‡»äº‹ä»¶
    newSaveBtn.addEventListener('click', () => {
        saveEditedMessage(timestampToEdit); 
    });

    // 5. æœ€å,æ˜¾ç¤ºæ¨¡æ€æ¡†
    editorModal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * è§£æç¼–è¾‘åçš„æ–‡æœ¬,å¹¶è¿”å›ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¶ˆæ¯ç‰‡æ®µå¯¹è±¡
 * @param {string} text - ç”¨æˆ·åœ¨ç¼–è¾‘æ¡†ä¸­è¾“å…¥çš„æ–‡æœ¬
 * @returns {object} - ä¸€ä¸ªåŒ…å« type, content, ç­‰å±æ€§çš„å¯¹è±¡
 */
function parseEditedContent(text) {
    const trimmedText = text.trim();

    // 1. å°è¯•è§£æä¸ºJSONå¯¹è±¡(ç”¨äºä¿®å¤è¯­éŸ³ã€è½¬è´¦ç­‰æ ¼å¼)
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            // å¿…é¡»åŒ…å« type å±æ€§æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆæ ¼å¼
            if (parsed.type) {
                return parsed;
            }
        } catch (e) { /* è§£æå¤±è´¥,ç»§ç»­å¾€ä¸‹èµ° */ }
    }
    
    // 2. å°è¯•è§£æä¸ºè¡¨æƒ…åŒ…
    if (STICKER_REGEX.test(trimmedText)) {
        // å¯¹äºç¼–è¾‘çš„è¡¨æƒ…,æˆ‘ä»¬æš‚æ—¶æ— æ³•çŸ¥é“å…¶`meaning`,æ‰€ä»¥åªå­˜URL
        return { type: 'sticker', content: trimmedText };
    }

    // 3. å¦åˆ™,è§†ä¸ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯
    return { type: 'text', content: trimmedText };
}


// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å½»åº•ä¿®å¤ã€‘çš„å‡½æ•°,å®Œæ•´æ›¿æ¢ä½ ç°æœ‰çš„ saveEditedMessage å‡½æ•° â–¼â–¼â–¼

async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    let newMessages = [];

    // åˆ¤æ–­æ˜¯æ¥è‡ªé«˜çº§ç¼–è¾‘å™¨è¿˜æ˜¯ç®€å•ç¼–è¾‘å™¨
    if (simpleContent !== null) {
        // --- æ¥è‡ªç®€å•ç¼–è¾‘å™¨ ---
        const rawContent = simpleContent.trim();
        if (rawContent) {
            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // æ³¨æ„:è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸è®¾ç½®æ—¶é—´æˆ³
                content: parsedResult.content || '',
            };
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    } else {
        // --- æ¥è‡ªé«˜çº§ç¼–è¾‘å™¨ ---
        const editorContainer = document.getElementById('message-editor-container');
        const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');

        for (const block of editorBlocks) {
            const textarea = block.querySelector('textarea');
            const rawContent = textarea.value.trim();
            if (!rawContent) continue;

            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // åŒæ ·,è¿™é‡Œæˆ‘ä»¬å…ˆä¸åˆ†é…æ—¶é—´æˆ³
                content: parsedResult.content || '',
            };
            
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    }
    
    if (newMessages.length === 0) {
        document.getElementById('message-editor-modal').classList.remove('visible');
        return; // å¦‚æœæ˜¯ç©ºæ¶ˆæ¯,ç›´æ¥è¿”å›,ä¸æ‰§è¡Œåˆ é™¤æ“ä½œ
    }

    // â˜…â˜…â˜…â˜…â˜…ã€æ ¸å¿ƒä¿®å¤é€»è¾‘å°±åœ¨è¿™é‡Œã€‘â˜…â˜…â˜…â˜…â˜…

    // 1. ä½¿ç”¨ splice å°†æ—§æ¶ˆæ¯æ›¿æ¢ä¸ºæ–°æ¶ˆæ¯(æ­¤æ—¶æ–°æ¶ˆæ¯è¿˜æ²¡æœ‰æ—¶é—´æˆ³)
    chat.history.splice(messageIndex, 1, ...newMessages);

    // 2. ç¡®å®šé‡æ–°åˆ†é…æ—¶é—´æˆ³çš„èµ·ç‚¹
    // æˆ‘ä»¬ä»è¢«ç¼–è¾‘çš„æ¶ˆæ¯çš„åŸå§‹æ—¶é—´æˆ³å¼€å§‹
    let reassignTimestamp = timestamp;

    // 3. ä»è¢«ä¿®æ”¹çš„ä½ç½®å¼€å§‹,éå†æ‰€æœ‰åç»­çš„æ¶ˆæ¯
    for (let i = messageIndex; i < chat.history.length; i++) {
        // 4. ä¸ºæ¯ä¸€æ¡æ¶ˆæ¯(åŒ…æ‹¬æ–°æ’å…¥çš„)åˆ†é…ä¸€ä¸ªæ–°çš„ã€å”¯ä¸€çš„ã€è¿ç»­çš„æ—¶é—´æˆ³
        chat.history[i].timestamp = reassignTimestamp;

        // 5. å°†æ—¶é—´æˆ³+1,ä¸ºä¸‹ä¸€æ¡æ¶ˆæ¯åšå‡†å¤‡
        reassignTimestamp++; 
    }
    // â˜…â˜…â˜…â˜…â˜…ã€ä¿®å¤ç»“æŸã€‘â˜…â˜…â˜…â˜…â˜…

    await db.chats.put(chat);

    // å…³é—­å¯èƒ½æ‰“å¼€çš„æ¨¡æ€æ¡†å¹¶åˆ·æ–°UI
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('æˆåŠŸ', 'æ¶ˆæ¯å·²æ›´æ–°!');
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬2æ­¥:å°†è¿™ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°æ‚¨çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºè‡ªå®šä¹‰çš„æ—¥å†äº‹ä»¶ç¡®è®¤/è¾“å…¥å¼¹çª—
 * @param {string} dateString - "YYYY-MM-DD"
 * @returns {Promise<string|null>} - ç”¨æˆ·ç¡®è®¤åˆ™è¿”å›è¾“å…¥çš„æ ‡é¢˜,å–æ¶ˆåˆ™è¿”å›null
 */
function showCalendarPrompt(dateString) {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = 'è®°å½•è¿™ä¸€å¤©';
        // ã€æ ¸å¿ƒã€‘æ„å»ºå…¨æ–°çš„å¼¹çª—å†…å®¹
        modalBody.innerHTML = `
            <p style="margin-bottom: 15px;">è¿™å¤©æ˜¯å€¼å¾—çºªå¿µçš„ä¸€å¤©å—ï¼Ÿ</p>
            <input 
                type="text" 
                id="calendar-prompt-input" 
                placeholder="ä½ æƒ³å†™ä¸€ç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ" 
                style="width: 100%; box-sizing: border-box;"
            >
        `;
        
        // ã€æ ¸å¿ƒã€‘ä¿®æ”¹æŒ‰é’®æ ·å¼å’Œæ–‡æœ¬
        modalCancelBtn.textContent = 'Ã—';
        modalConfirmBtn.textContent = 'âˆš';
        modalConfirmBtn.classList.add('confirm-check'); // æ·»åŠ ä¸€ä¸ªclassç”¨äºCSSç¾åŒ–

        const input = document.getElementById('calendar-prompt-input');

        modalConfirmBtn.onclick = () => { 
            // ç§»é™¤ç¾åŒ–class,é˜²æ­¢å½±å“å…¶ä»–å¼¹çª—
            modalConfirmBtn.classList.remove('confirm-check');
            resolve(input.value); 
            hideCustomModal(); 
        };
        modalCancelBtn.onclick = () => { 
            modalConfirmBtn.classList.remove('confirm-check');
            resolve(null); 
            hideCustomModal(); 
        };
        
        showCustomModal();
        setTimeout(() => input.focus(), 100); // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
    });
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€æ ¸å¿ƒã€‘å¤„ç†çº¿ä¸‹/è§†é¢‘æ¨¡å¼èƒŒæ™¯çš„ä¸Šä¼ å’Œåº”ç”¨
 * @param {string} base64Url - FileReaderè¯»å–åˆ°çš„å›¾ç‰‡base64åœ°å€
 */
async function handleOfflineVideoBgUpload(base64Url) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];

    // 1. æ›´æ–°å†…å­˜å’Œæ•°æ®åº“
    chat.settings.offlineVideoBackground = base64Url;
    await db.chats.put(chat);

    // 2. å®æ—¶åº”ç”¨åˆ°å½“å‰å±å¹•
    const activeScreenId = document.querySelector('.screen.active').id;
    if (activeScreenId === 'offline-mode-screen' || activeScreenId === 'video-call-screen') {
        document.getElementById(activeScreenId).style.backgroundImage = `url(${base64Url})`;
    }

    await showCustomAlert('æˆåŠŸ', 'èƒŒæ™¯å·²æ›´æ¢ï¼');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬2æ­¥:å°†è¿™ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°æ‚¨çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºè‡ªå®šä¹‰çš„æ—¥å†äº‹ä»¶ç¡®è®¤/è¾“å…¥å¼¹çª—
 * @param {string} dateString - "YYYY-MM-DD"
 * @returns {Promise<string|null>} - ç”¨æˆ·ç¡®è®¤åˆ™è¿”å›è¾“å…¥çš„æ ‡é¢˜,å–æ¶ˆåˆ™è¿”å›null
 */
function showCalendarPrompt(dateString) {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = 'è®°å½•è¿™ä¸€å¤©';
        // ã€æ ¸å¿ƒã€‘æ„å»ºå…¨æ–°çš„å¼¹çª—å†…å®¹
        modalBody.innerHTML = `
            <p style="margin-bottom: 15px;">è¿™å¤©æ˜¯å€¼å¾—çºªå¿µçš„ä¸€å¤©å—ï¼Ÿ</p>
            <input 
                type="text" 
                id="calendar-prompt-input" 
                placeholder="ä½ æƒ³å†™ä¸€ç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ" 
                style="width: 100%; box-sizing: border-box;"
            >
        `;
        
        // ã€æ ¸å¿ƒã€‘ä¿®æ”¹æŒ‰é’®æ ·å¼å’Œæ–‡æœ¬
        modalCancelBtn.textContent = 'Ã—';
        modalConfirmBtn.textContent = 'âˆš';
        modalConfirmBtn.classList.add('confirm-check'); // æ·»åŠ ä¸€ä¸ªclassç”¨äºCSSç¾åŒ–

        const input = document.getElementById('calendar-prompt-input');

        modalConfirmBtn.onclick = () => { 
            // ç§»é™¤ç¾åŒ–class,é˜²æ­¢å½±å“å…¶ä»–å¼¹çª—
            modalConfirmBtn.classList.remove('confirm-check');
            resolve(input.value); 
            hideCustomModal(); 
        };
        modalCancelBtn.onclick = () => { 
            modalConfirmBtn.classList.remove('confirm-check');
            resolve(null); 
            hideCustomModal(); 
        };
        
        showCustomModal();
        setTimeout(() => input.focus(), 100); // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
    });
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒºçš„æœ«å°¾ â–¼â–¼â–¼

/**
 * å½“ç‚¹å‡»â€œâ€¦â€æ—¶,æ˜¾ç¤ºåŠ¨æ€æ“ä½œèœå•
 * @param {number} postId - è¢«æ“ä½œçš„åŠ¨æ€çš„ID
 */
function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}

/**
 * éšè—åŠ¨æ€æ“ä½œèœå•
 */
function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}

/**
 * æ‰“å¼€åŠ¨æ€ç¼–è¾‘å™¨
 */
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // å¿ äºåŸæ–‡:æ„å»ºå‡ºæœ€åŸå§‹çš„æ–‡æœ¬å½¢æ€ä¾›ç¼–è¾‘
    let contentForEditing;
    if (post.type === 'shuoshuo') {
        contentForEditing = post.content;
    } else {
        // å¯¹äºå›¾ç‰‡å’Œæ–‡å­—å›¾,æˆ‘ä»¬æ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¿¡æ¯çš„å¯¹è±¡
        const postObject = {
            type: post.type,
            publicText: post.publicText || '',
        };
        if (post.type === 'image_post') {
            postObject.imageUrl = post.imageUrl;
            postObject.imageDescription = post.imageDescription;
        } else if (post.type === 'text_image') {
            postObject.hiddenContent = post.hiddenContent;
        }
        contentForEditing = JSON.stringify(postObject, null, 2);
    }
    
    // æ„å»ºæ ¼å¼åŠ©æ‰‹æŒ‰é’®
    const templates = {
        shuoshuo: "åœ¨è¿™é‡Œè¾“å…¥è¯´è¯´çš„å†…å®¹...", // å¯¹äºè¯´è¯´,æˆ‘ä»¬ç›´æ¥æ›¿æ¢ä¸ºçº¯æ–‡æœ¬
        image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
        text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
    };
    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text">è¯´è¯´</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>å›¾ç‰‡åŠ¨æ€</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>æ–‡å­—å›¾</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ç¼–è¾‘åŠ¨æ€',
        'åœ¨æ­¤ä¿®æ”¹å†…å®¹...',
        contentForEditing,
        'textarea',
        helpersHtml
    );
    
    // ã€ç‰¹æ®Šå¤„ç†ã€‘ä¸ºè¯´è¯´çš„æ ¼å¼åŠ©æ‰‹æŒ‰é’®æ·»åŠ ä¸åŒçš„è¡Œä¸º
    // æˆ‘ä»¬éœ€è¦åœ¨æ¨¡æ€æ¡†å‡ºç°å,å†ç»™å®ƒç»‘å®šäº‹ä»¶
    setTimeout(() => {
        const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
        if(shuoshuoBtn) {
            shuoshuoBtn.addEventListener('click', () => {
                const input = document.getElementById('custom-prompt-input');
                input.value = templates.shuoshuo;
                input.focus();
            });
        }
    }, 100);

    if (newContent !== null) {
        await saveEditedPost(postIdToEdit, newContent);
    }
}

/**
 * ä¿å­˜ç¼–è¾‘åçš„åŠ¨æ€
 * @param {number} postId - è¦ä¿å­˜çš„åŠ¨æ€ID
 * @param {string} newRawContent - ä»ç¼–è¾‘å™¨è·å–çš„æ–°å†…å®¹
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // å°è¯•è§£æä¸ºJSON,å¦‚æœå¤±è´¥,åˆ™è®¤ä¸ºæ˜¯çº¯æ–‡æœ¬(è¯´è¯´)
    try {
        const parsed = JSON.parse(trimmedContent);
        // æ›´æ–°å¸–å­å±æ€§
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // æ¸…ç©ºæ—§çš„è¯´è¯´å†…å®¹å­—æ®µ
    } catch (e) {
        // è§£æå¤±è´¥,è®¤ä¸ºæ˜¯è¯´è¯´
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // æ¸…ç©ºå…¶ä»–ç±»å‹çš„å­—æ®µ
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    await showCustomAlert('æˆåŠŸ', 'åŠ¨æ€å·²æ›´æ–°!');
}

/**
 * å¤åˆ¶åŠ¨æ€å†…å®¹
 */
async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "(æ— æ–‡å­—å†…å®¹)";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('å¤åˆ¶æˆåŠŸ', 'åŠ¨æ€å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    } catch (err) {
        await showCustomAlert('å¤åˆ¶å¤±è´¥', 'æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚');
    }
    
    hidePostActions();
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘åˆ›å»ºç¾¤èŠä¸æ‹‰äººåŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
let selectedContacts = new Set();

async function openContactPickerForGroupCreate() {
    selectedContacts.clear(); // æ¸…ç©ºä¸Šæ¬¡é€‰æ‹©

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡Œ,æˆ‘ä»¬ä¸ºâ€œå®Œæˆâ€æŒ‰é’®æ˜ç¡®ç»‘å®šâ€œåˆ›å»ºç¾¤èŠâ€çš„åŠŸèƒ½
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§,æ¸…é™¤æ‰ä¹‹å‰å¯èƒ½ç»‘å®šçš„ä»»ä½•å…¶ä»–äº‹ä»¶(æ¯”å¦‚â€œæ·»åŠ æˆå‘˜â€)
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    // é‡æ–°ç»‘å®šæ­£ç¡®çš„â€œåˆ›å»ºç¾¤èŠâ€å‡½æ•°
    newConfirmBtn.addEventListener('click', handleCreateGroup);

    await renderContactPicker();
    showScreen('contact-picker-screen');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ¸²æŸ“è”ç³»äººé€‰æ‹©åˆ—è¡¨
 */
async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // åªé€‰æ‹©å•èŠè§’è‰²ä½œä¸ºç¾¤æˆå‘˜å€™é€‰
    const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">è¿˜æ²¡æœ‰å¯ä»¥æ‹‰è¿›ç¾¤çš„è”ç³»äººå“¦~</p>';
        return;
    }

    contacts.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name}</span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

/**
 * æ›´æ–°â€œå®Œæˆâ€æŒ‰é’®çš„è®¡æ•°
 */
function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    btn.textContent = `å®Œæˆ(${selectedContacts.size})`;
    btn.disabled = selectedContacts.size < 2; // è‡³å°‘éœ€è¦2ä¸ªäººæ‰èƒ½åˆ›å»ºç¾¤èŠ
}

/**
 * ã€é‡æ„ç‰ˆã€‘å¤„ç†åˆ›å»ºç¾¤èŠçš„æœ€ç»ˆé€»è¾‘
 */
async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("åˆ›å»ºç¾¤èŠè‡³å°‘éœ€è¦é€‰æ‹©2ä¸ªè”ç³»äººã€‚");
        return;
    }

    const groupName = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—', 'æˆ‘ä»¬çš„ç¾¤èŠ');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    
    // éå†é€‰ä¸­çš„è”ç³»äººID
    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
            // æˆ‘ä»¬ç°åœ¨åŒæ—¶å­˜å‚¨è§’è‰²çš„â€œæœ¬åâ€å’Œâ€œç¾¤æ˜µç§°â€
            members.push({
                id: contactId, 
                originalName: contactChat.name,   // è§’è‰²çš„â€œæœ¬åâ€,ç”¨äºAIè¯†åˆ«
                groupNickname: contactChat.name, // è§’è‰²çš„â€œç¾¤æ˜µç§°â€,ç”¨äºæ˜¾ç¤ºå’Œä¿®æ”¹,åˆå§‹å€¼å’Œæœ¬åç›¸åŒ
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        members: members,
        settings: {
            myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚',
            myNickname: 'æˆ‘',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); 
}

// â–¼â–¼â–¼ Please ADD this ENTIRE new function to your script section â–¼â–¼â–¼
/**
 * ã€Newã€‘Updates the settings of an already active live stream.
 */
async function updateLiveStreamSettings() {
    const newTheme = document.getElementById('live-theme-input').value.trim();
    if (!newTheme) {
        alert('ç›´æ’­ä¸»é¢˜ä¸èƒ½ä¸ºç©ºï¼');
        return;
    }

    // Update state with new values from the form
    liveStreamState.theme = newTheme;
    liveStreamState.scheduledTime = new Date(document.getElementById('live-start-time-input').value).getTime();
    
    const newInvitedAiId = document.getElementById('live-invite-ai-select').value;
    liveStreamState.invitedAiId = newInvitedAiId === 'none' ? null : newInvitedAiId;
    liveStreamState.mode = liveStreamState.invitedAiId ? 'duo' : 'solo';
    
    // Update the UI to reflect changes
    await renderLiveStreamScreen();
    
    // Hide the settings overlay
    document.getElementById('live-pre-start-overlay').style.display = 'none';
    
    alert('ç›´æ’­ä¿¡æ¯å·²æ›´æ–°ï¼');
}
// â–²â–²â–² NEW FUNCTION END â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç¾¤æˆå‘˜ç®¡ç†æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€ç¾¤æˆå‘˜ç®¡ç†å±å¹•
 */
function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
}

function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-management-item';
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œ,æˆ‘ä»¬å°†æ˜¾ç¤ºçš„åç§°ä» member.name æ”¹ä¸º member.groupNickname
        item.innerHTML = `
            <img src="${member.avatar}" class="avatar">
            <span class="name">${member.groupNickname}</span>
            <button class="remove-member-btn" data-member-id="${member.id}" title="ç§»å‡ºç¾¤èŠ">-</button>
        `;
        listEl.appendChild(item);
    });
}

/**
 * ä»ç¾¤èŠä¸­ç§»é™¤ä¸€ä¸ªæˆå‘˜
 * @param {string} memberId - è¦ç§»é™¤çš„æˆå‘˜ID
 */
async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);
    
    if (memberIndex === -1) return;
    
    // å®‰å…¨æ£€æŸ¥,ç¾¤èŠè‡³å°‘ä¿ç•™2äºº
    if (chat.members.length <= 2) {
        alert("ç¾¤èŠäººæ•°ä¸èƒ½å°‘äº2äººã€‚");
        return;
    }
    
const memberName = chat.members[memberIndex].groupNickname; // <-- ä¿®å¤:ä½¿ç”¨ groupNickname
    const confirmed = await showCustomConfirm(
        'ç§»å‡ºæˆå‘˜',
        `ç¡®å®šè¦å°†â€œ${memberName}â€ç§»å‡ºç¾¤èŠå—ï¼Ÿ`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.members.splice(memberIndex, 1);
        await db.chats.put(chat);
        renderMemberManagementList(); // åˆ·æ–°æˆå‘˜ç®¡ç†åˆ—è¡¨
        document.getElementById('chat-settings-btn').click(); // ã€æ ¸å¿ƒä¿®æ­£ã€‘æ¨¡æ‹Ÿç‚¹å‡»è®¾ç½®æŒ‰é’®,å¼ºåˆ¶åˆ·æ–°æ•´ä¸ªå¼¹çª—
    }
}

/**
 * æ‰“å¼€è”ç³»äººé€‰æ‹©å™¨,ç”¨äºæ‹‰äººå…¥ç¾¤
 */
async function openContactPickerForAddMember() {
    selectedContacts.clear(); // æ¸…ç©ºé€‰æ‹©
    
    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));

    // æ¸²æŸ“è”ç³»äººåˆ—è¡¨,å¹¶è‡ªåŠ¨æ’é™¤å·²åœ¨ç¾¤å†…çš„æˆå‘˜
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">æ²¡æœ‰æ›´å¤šå¯ä»¥é‚€è¯·çš„å¥½å‹äº†ã€‚</p>';
        document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // æ²¡æœ‰äººå¯é€‰,éšè—å®ŒæˆæŒ‰é’®
    } else {
        document.getElementById('confirm-contact-picker-btn').style.display = 'block';
        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name}</span>
            `;
            listEl.appendChild(item);
        });
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€å¹¶æ˜¾ç¤ºå±å¹•
    updateContactPickerConfirmButton();
    showScreen('contact-picker-screen');
}

/**
 * å¤„ç†å°†é€‰ä¸­çš„è”ç³»äººåŠ å…¥ç¾¤èŠçš„é€»è¾‘
 */
async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æ·»åŠ çš„è”ç³»äººã€‚");
        return;
    }
    
    const chat = state.chats[state.activeChatId];

    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
chat.members.push({
    id: contactId,
    originalName: contactChat.name,  // <-- ä¿®å¤1:ä½¿ç”¨ 'originalName' å­˜å‚¨æœ¬å
    groupNickname: contactChat.name, // <-- ä¿®å¤2:åŒæ—¶åˆ›å»ºä¸€ä¸ªåˆå§‹çš„ 'groupNickname'
    avatar: contactChat.settings.aiAvatar || defaultAvatar,
    persona: contactChat.settings.aiPersona,
    avatarFrame: contactChat.settings.aiAvatarFrame || ''
});
        }
    }

    await db.chats.put(chat);
    openMemberManagementScreen(); // è¿”å›åˆ°ç¾¤æˆå‘˜ç®¡ç†ç•Œé¢
    renderGroupMemberSettings(chat.members); // åŒæ—¶æ›´æ–°èŠå¤©è®¾ç½®é‡Œçš„å¤´åƒ
}

/**
 * ã€é‡æ„ç‰ˆã€‘åœ¨ç¾¤èŠä¸­åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„è™šæ‹Ÿæˆå‘˜
 */
async function createNewMemberInGroup() {
    const name = await showCustomPrompt('åˆ›å»ºæ–°æˆå‘˜', 'è¯·è¾“å…¥æ–°æˆå‘˜çš„åå­— (è¿™å°†æ˜¯TAçš„â€œæœ¬åâ€,ä¸å¯æ›´æ”¹)');
    if (!name || !name.trim()) return;

    // æ£€æŸ¥æœ¬åæ˜¯å¦å·²åœ¨ç¾¤å†…å­˜åœ¨
    const chat = state.chats[state.activeChatId];
    if (chat.members.some(m => m.originalName === name.trim())) {
        alert(`é”™è¯¯:ç¾¤å†…å·²å­˜åœ¨åä¸ºâ€œ${name.trim()}â€çš„æˆå‘˜!`);
        return;
    }

    const persona = await showCustomPrompt('è®¾ç½®äººè®¾', `è¯·è¾“å…¥â€œ${name}â€çš„äººè®¾`, '', 'textarea');
    if (persona === null) return; 

    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    // ä¸ºæ–°åˆ›å»ºçš„NPCä¹Ÿå»ºç«‹åŒé‡å‘½åæœºåˆ¶
    const newMember = {
        id: 'npc_' + Date.now(),
        originalName: name.trim(),   // æ–°æˆå‘˜çš„â€œæœ¬åâ€
        groupNickname: name.trim(), // æ–°æˆå‘˜çš„åˆå§‹â€œç¾¤æ˜µç§°â€
        avatar: defaultGroupMemberAvatar,
        persona: persona,
        avatarFrame: ''
    };

    chat.members.push(newMember);
    await db.chats.put(chat);

    renderMemberManagementList();
    renderGroupMemberSettings(chat.members); 

    alert(`æ–°æˆå‘˜â€œ${name}â€å·²æˆåŠŸåŠ å…¥ç¾¤èŠ!`);
}

let videoCallState = {
    isActive: false,       
    isAwaitingResponse: false, 
    isGroupCall: false,      
    activeChatId: null,    
    initiator: null,       
    startTime: null,       
    participants: [],      
    isUserParticipating: true,
    callHistory: [],
    preCallContext: "",
    backgroundUrl: "" // <<<<<<< ã€æ–°å¢ã€‘ç”¨äºå­˜å‚¨å½“å‰é€šè¯çš„èƒŒæ™¯URL
};

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„çŠ¶æ€å˜é‡ â–¼â–¼â–¼
let offlineModeState = {
    isActive: false,
    activeChatId: null,
    startTime: null,
    history: [], // ç”¨äºå­˜å‚¨çº¿ä¸‹äº’åŠ¨çš„æ–‡å­—è®°å½•
    preOfflineContext: "" // ç”¨äºå­˜å‚¨è¿›å…¥çº¿ä¸‹æ¨¡å¼å‰çš„èŠå¤©æ‘˜è¦
};
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

let callTimerInterval = null; // ç”¨äºå­˜å‚¨è®¡æ—¶å™¨çš„ID

/**
 * ã€æ€»å…¥å£ã€‘ç”¨æˆ·ç‚¹å‡»â€œå‘èµ·è§†é¢‘é€šè¯â€æˆ–â€œå‘èµ·ç¾¤è§†é¢‘â€æŒ‰é’®
 */
async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true; // ç”¨æˆ·è‡ªå·±å‘èµ·çš„,å½“ç„¶æ˜¯å‚ä¸è€…

    // æ ¹æ®æ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠ,æ˜¾ç¤ºä¸åŒçš„å‘¼å«ç•Œé¢
    if (chat.isGroup) {
        document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'æˆ‘';
    } else {
        document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "æ­£åœ¨å‘¼å«æ‰€æœ‰æˆå‘˜..." : "æ­£åœ¨å‘¼å«...";
    showScreen('outgoing-call-screen');
    
    // å‡†å¤‡å¹¶å‘é€ç³»ç»Ÿæ¶ˆæ¯ç»™AI
    const requestMessage = {
        role: 'system',
        content: chat.isGroup 
            ? `[ç³»ç»Ÿæç¤º:ç”¨æˆ· (${chat.settings.myNickname || 'æˆ‘'}) å‘èµ·äº†ç¾¤è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–,å¹¶ä½¿ç”¨ "group_call_response" æŒ‡ä»¤,è®¾ç½® "decision" ä¸º "join" æˆ– "decline" æ¥å›åº”ã€‚]`
            : `[ç³»ç»Ÿæç¤º:ç”¨æˆ·å‘ä½ å‘èµ·äº†è§†é¢‘é€šè¯è¯·æ±‚ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾,ä½¿ç”¨ "video_call_response" æŒ‡ä»¤,å¹¶è®¾ç½® "decision" ä¸º "accept" æˆ– "reject" æ¥å›åº”ã€‚]`,
        timestamp: Date.now(),
        isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);
    
    // è§¦å‘AIå“åº”
    await triggerAiResponse();
}


// â–¼â–¼â–¼ ã€æ²‰æµ¸å¼ç‰ˆã€‘å¯åŠ¨è§†é¢‘é€šè¯ â–¼â–¼â–¼
function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = []; 

    const preCallHistory = chat.history.slice(-10);
    videoCallState.preCallContext = preCallHistory.map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');
    
    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åº”ç”¨èƒŒæ™¯
    const videoScreen = document.getElementById('video-call-screen');
    // ä¼˜å…ˆä½¿ç”¨å½“å‰é€šè¯çš„èƒŒæ™¯ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨èŠå¤©è®¾ç½®é‡Œçš„èƒŒæ™¯ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œåˆ™ä¸è®¾ç½®
    const bgToUse = videoCallState.backgroundUrl || chat.settings.offlineVideoBackground || '';
    videoScreen.style.backgroundImage = bgToUse ? `url(${bgToUse})` : 'none';

    document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'ç¾¤èŠå·²å»ºç«‹...' : 'æ­£åœ¨æ¥é€š...'}</em>`;
    showScreen('video-call-screen');

    // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘ç§»é™¤äº†æ‰€æœ‰ä¸å¤´åƒç½‘æ ¼ç›¸å…³çš„è°ƒç”¨
    // updateParticipantAvatars(); 
    // document.getElementById('user-speak-btn').style.display = ...
    // document.getElementById('join-call-btn').style.display = ...

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€æ ¸å¿ƒã€‘ç»“æŸè§†é¢‘é€šè¯
 */
// â–¼â–¼â–¼ ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ endVideoCall å‡½æ•° â–¼â–¼â–¼
async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;
    const endCallText = `é€šè¯ç»“æŸ,æ—¶é•¿ ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1. ä¿å­˜å®Œæ•´çš„é€šè¯è®°å½•åˆ°æ•°æ®åº“ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || 'æˆ‘', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: 'æˆ‘', avatar: chat.settings.myAvatar || defaultAvatar });
        }
        
        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log("é€šè¯è®°å½•å·²ä¿å­˜:", callRecord);
        
        // 2. åœ¨èŠå¤©è®°å½•é‡Œæ·»åŠ å¯¹ç”¨æˆ·å¯è§çš„â€œé€šè¯ç»“æŸâ€æ¶ˆæ¯
let summaryMessage = {
    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘role ç”± videoCallState.initiator å†³å®š
    role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
    content: endCallText,
    timestamp: Date.now(),
};

// ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¸ºç¾¤èŠçš„ assistant æ¶ˆæ¯è¡¥å…… senderName
if (chat.isGroup && summaryMessage.role === 'assistant') {
    // åœ¨ç¾¤èŠä¸­,é€šè¯ç»“æŸçš„æ¶ˆæ¯åº”è¯¥ç”±â€œå‘èµ·è€…â€æ¥è¯´
    // videoCallState.callRequester ä¿å­˜äº†æœ€åˆå‘èµ·é€šè¯çš„é‚£ä¸ªAIçš„åå­—
    summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        chat.history.push(summaryMessage);

        // 3. ã€æ ¸å¿ƒå˜é©ã€‘åˆ›å»ºå¹¶æ·»åŠ å¯¹ç”¨æˆ·éšè—çš„â€œé€šè¯åæ±‡æŠ¥â€æŒ‡ä»¤
        const callTranscriptForAI = videoCallState.callHistory.map(h => `${h.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : h.role}: ${h.content}`).join('\n');
        
        const hiddenReportInstruction = {
            role: 'system',
    content: `[ç³»ç»ŸæŒ‡ä»¤:è§†é¢‘é€šè¯åˆšåˆšç»“æŸã€‚è¯·ä½ æ ¹æ®å®Œæ•´çš„é€šè¯æ–‡å­—è®°å½•(è§ä¸‹æ–¹),ä»¥ä½ çš„è§’è‰²å£å»,å‘ç”¨æˆ·ä¸»åŠ¨å‘é€å‡ æ¡ã€æ ¼å¼ä¸º {"type": "text", "content": "..."} çš„ã€‘æ¶ˆæ¯,æ¥è‡ªç„¶åœ°æ€»ç»“è¿™æ¬¡é€šè¯çš„è¦ç‚¹ã€ç¡®è®¤è¾¾æˆçš„çº¦å®š,æˆ–è€…è¡¨è¾¾ä½ çš„æ„Ÿå—ã€‚è¿™å¾ˆé‡è¦,èƒ½è®©ç”¨æˆ·æ„Ÿè§‰ä½ è®°å¾—é€šè¯å†…å®¹ã€‚]\n---é€šè¯è®°å½•å¼€å§‹---\n${callTranscriptForAI}\n---é€šè¯è®°å½•ç»“æŸ---`,
            timestamp: Date.now() + 1, // ç¡®ä¿åœ¨ä¸Šä¸€æ¡æ¶ˆæ¯ä¹‹å
            isHidden: true
        };
        chat.history.push(hiddenReportInstruction);

        // 4. ä¿å­˜æ‰€æœ‰æ›´æ–°åˆ°æ•°æ®åº“
        await db.chats.put(chat);
    }
    
    // 5. æ¸…ç†å’Œé‡ç½®çŠ¶æ€ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 6. è¿”å›èŠå¤©ç•Œé¢å¹¶è§¦å‘AIå“åº”(AIä¼šè¯»å–åˆ°æˆ‘ä»¬çš„â€œæ±‡æŠ¥â€æŒ‡ä»¤)
    if (chat) {
        openChat(chat.id);
        triggerAiResponse(); // å…³é”®ä¸€æ­¥!
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ›´æ–°é€šè¯è®¡æ—¶å™¨æ˜¾ç¤º (ä¿æŒä¸å˜)
 */
function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªå®Œæ•´å‡½æ•°æ›¿æ¢æ—§çš„ showIncomingCallModal â–¼â–¼â–¼
function showIncomingCallModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // æ ¹æ®æ˜¯å¦ç¾¤èŠæ˜¾ç¤ºä¸åŒä¿¡æ¯
    if (chat.isGroup) {
        // ä» videoCallState ä¸­è·å–æ˜¯å“ªä¸ªæˆå‘˜å‘èµ·çš„é€šè¯
        const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'ä¸€ä½æˆå‘˜';
        document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('caller-name').textContent = chat.name; // æ˜¾ç¤ºç¾¤å
        document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} é‚€è¯·ä½ åŠ å…¥ç¾¤è§†é¢‘`; // æ˜¾ç¤ºå…·ä½“å‘èµ·äºº
    } else {
        // å•èŠé€»è¾‘ä¿æŒä¸å˜
        document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('caller-name').textContent = chat.name;
        document.querySelector('.incoming-call-content .caller-text').textContent = 'é‚€è¯·ä½ è§†é¢‘é€šè¯';
    }
    
    document.getElementById('incoming-call-modal').classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å·²æ¢å¤å¹¶ä¼˜åŒ–ã€‘å¤„ç†ç”¨æˆ·åŠ å…¥/æ¥å¬é€šè¯çš„é€»è¾‘ â–¼â–¼â–¼
function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
    
    videoCallState.isUserParticipating = true;
    
    // æˆ‘ä»¬ä¸å†éœ€è¦æ›´æ–°å¤´åƒï¼Œæ‰€ä»¥è¿™è¡Œæ˜¯æ³¨é‡Šæ‰çš„
    // updateParticipantAvatars(); 

    // ã€æ ¸å¿ƒã€‘å‘ŠçŸ¥AIç”¨æˆ·åŠ å…¥äº†ï¼Œè§¦å‘å®ƒçš„ç¬¬ä¸€å¥è¯
    triggerAiInCallAction("[ç³»ç»Ÿæç¤º:ç”¨æˆ·åŠ å…¥äº†é€šè¯]");
}
// â–²â–²â–² æ¢å¤ç»“æŸ â–²â–²â–²

/**
 * éšè—AIå‘èµ·çš„é€šè¯è¯·æ±‚æ¨¡æ€æ¡† (ä¿æŒä¸å˜)
 */
function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
}

async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    const callFeed = document.getElementById('video-call-main');
    const userNickname = chat.settings.myNickname || 'æˆ‘';

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸–ç•Œä¹¦è¯»å–é€»è¾‘ â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    // 1. å¦‚æœç”¨æˆ·æœ‰è¾“å…¥,å…ˆæ¸²æŸ“å¹¶å­˜å…¥é€šè¯å†å²
    if (userInput && videoCallState.isUserParticipating) {
        const userBubble = document.createElement('div');
        userBubble.className = 'call-message-bubble user-speech';
        userBubble.textContent = userInput;
        callFeed.appendChild(userBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    // 2. æ„å»ºå…¨æ–°çš„ã€åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡çš„ System Prompt
    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        const participantNames = videoCallState.participants.map(p => p.name);
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        inCallPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç¾¤èŠè§†é¢‘é€šè¯çš„å¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”æ‰€æœ‰ã€é™¤äº†ç”¨æˆ·ä»¥å¤–ã€‘çš„AIè§’è‰²,å¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°ä»–ä»¬åœ¨é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€èº«ä»½é“å¾‹ã€‘ã€‘ã€‘**: ç”¨æˆ·çš„èº«ä»½æ˜¯ã€${userNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ \`name\` å­—æ®µä¸º **"${userNickname}"** çš„å‘è¨€ã€‚
2.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚
3.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„,æ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè§’è‰²çš„å‘è¨€,æ ¼å¼ä¸º:\`{"name": "è§’è‰²å", "speech": "*ä»–ç¬‘äº†ç¬‘* å¤§å®¶å¥½å•Š!"}\`ã€‚
4.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆæ¯ä¸ªè§’è‰²çš„è®¾å®šã€‚
# å½“å‰æƒ…æ™¯
ä½ ä»¬æ­£åœ¨ä¸€ä¸ªç¾¤è§†é¢‘é€šè¯ä¸­ã€‚
**é€šè¯å‰çš„èŠå¤©æ‘˜è¦**:
${videoCallState.preCallContext}
**å½“å‰å‚ä¸è€…**: ${participantNames.join('ã€ ')}ã€‚
**é€šè¯åˆšåˆšå¼€å§‹...**
${worldBookContent} // <-- ã€æ ¸å¿ƒã€‘æ³¨å…¥ä¸–ç•Œä¹¦
ç°åœ¨,è¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘,ç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
`;
    } else { 
        let openingContext = videoCallState.initiator === 'user'
            ? `ä½ åˆšåˆšæ¥å¬äº†ç”¨æˆ·çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚`
            : `ç”¨æˆ·åˆšåˆšæ¥å¬äº†ä½ ä¸»åŠ¨å‘èµ·çš„è§†é¢‘é€šè¯ã€‚`;
        inCallPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯ä¸€ä¸ªåœºæ™¯æè¿°å¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼” ${chat.name} (${chat.settings.aiPersona}),å¹¶ä»¥ã€ç¬¬ä¸‰äººç§°æ—è§‚è§†è§’ã€‘æ¥æè¿°TAåœ¨è§†é¢‘é€šè¯ä¸­çš„æ‰€æœ‰åŠ¨ä½œå’Œè¯­è¨€ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€ã€ã€è§†è§’é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€ç»å¯¹ä¸èƒ½ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚å¿…é¡»ä½¿ç”¨ç¬¬ä¸‰äººç§°,å¦‚â€œä»–â€ã€â€œå¥¹â€ã€æˆ–ç›´æ¥ä½¿ç”¨è§’è‰²åâ€œ${chat.name}â€ã€‚
2.  **æ ¼å¼**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€æ®µæè¿°æ€§çš„æ–‡æœ¬ã€‚
# å½“å‰æƒ…æ™¯
ä½ æ­£åœ¨å’Œç”¨æˆ·(${userNickname},äººè®¾: ${chat.settings.myPersona})è¿›è¡Œè§†é¢‘é€šè¯ã€‚
**${openingContext}**
**é€šè¯å‰çš„èŠå¤©æ‘˜è¦ (è¿™æ˜¯ä½ ä»¬é€šè¯çš„åŸå› ,è‡³å…³é‡è¦!)**:
${videoCallState.preCallContext}
ç°åœ¨,è¯·æ ¹æ®ã€é€šè¯å‰æ‘˜è¦ã€‘å’Œä¸‹é¢çš„ã€é€šè¯å®æ—¶è®°å½•ã€‘,ç»§ç»­è¿›è¡Œå¯¹è¯ã€‚
`;
    }
    
    // 3. æ„å»ºå‘é€ç»™APIçš„ messages æ•°ç»„
    const messagesForApi = [
        { role: 'system', content: inCallPrompt },
        // å°†å·²æœ‰çš„é€šè¯å†å²åŠ è¿›å»
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];

    // --- ã€æ ¸å¿ƒä¿®å¤:ç¡®ä¿ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æœ‰å†…å®¹ã€‘---
    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*ä½ æŒ‰ä¸‹äº†æ¥å¬é”®...*` : `*å¯¹æ–¹æŒ‰ä¸‹äº†æ¥å¬é”®...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    // --- ä¿®å¤ç»“æŸ ---
    
        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,inCallPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model, messages: messagesForApi, temperature: 0.8
                })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);

            const data = await response.json();
            const aiResponse = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

            const connectingElement = callFeed.querySelector('em');
            if (connectingElement) connectingElement.remove();

        // 4. å¤„ç†AIè¿”å›çš„å†…å®¹,å¹¶å°†å…¶å­˜å…¥é€šè¯å†å²
        if (videoCallState.isGroupCall) {
            const speechArray = parseAiResponse(aiResponse);
            speechArray.forEach(turn => {
                if (!turn.name || turn.name === userNickname || !turn.speech) return;
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                
                const speaker = videoCallState.participants.find(p => p.name === turn.name);
                if (speaker) {
                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                }
            });
        } else {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'call-message-bubble ai-speech';
            aiBubble.textContent = aiResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: aiResponse });

            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
            if(speakingAvatar) {
                speakingAvatar.classList.add('speaking');
                setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'call-message-bubble ai-speech';
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}

// â–¼â–¼â–¼ å°†è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
}
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ·˜å®/ç¤¼ç‰©åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼
let currentShoppingContext = {
    keyword: '',
    selectedItem: null
};

/**
 * ã€æ€»å…¥å£ã€‘æ‰“å¼€ç¤¼ç‰©/è´­ç‰©æ¨¡æ€æ¡†
 */
async function openShoppingModal() {
    if (!state.activeChatId) return;
    const keyword = await showCustomPrompt('æƒ³é€/è¦ç‚¹ä»€ä¹ˆï¼Ÿ', 'è¾“å…¥å…³é”®è¯ï¼Œå¦‚â€œå¥¶èŒ¶â€ã€â€œç©å¶â€...');
    if (!keyword || !keyword.trim()) return;

    currentShoppingContext = { keyword: keyword.trim(), selectedItem: null };

    // 1. æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶è¿›å…¥åŠ è½½çŠ¶æ€
    const modal = document.getElementById('shopping-modal');
    document.getElementById('shopping-list-container').innerHTML = `<div id="shopping-loading-spinner" style="text-align: center; padding: 40px; color: var(--text-secondary);">æ­£åœ¨å¯»æ‰¾â€œ${keyword}â€...</div>`;
    document.getElementById('shopping-item-preview').style.display = 'none';
    document.getElementById('shopping-actions').style.display = 'none';
    document.getElementById('shopping-title-bar').style.display = 'none'; // å…ˆéšè—æ ‡é¢˜æ 
    modal.classList.add('visible');

    // 2. å¼‚æ­¥è§¦å‘AIç”Ÿæˆå•†å“
    generateShoppingItems(keyword.trim());
}

// â–¼â–¼â–¼ ã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ generateShoppingItems å‡½æ•° â–¼â–¼â–¼
async function generateShoppingItems(keyword) {
    const chat = state.chats[state.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„ç”µå•†å•†å“ç­–åˆ’å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„å…³é”®è¯ï¼Œç­–åˆ’å¹¶ç”Ÿæˆä¸€ä¸ªåŒ…å«5ä¸ªç›¸å…³å•†å“çš„JSONæ•°ç»„ã€‚

# ã€ã€ã€æœ€é«˜ä¼˜å…ˆçº§å®‰å…¨ç¦ä»¤ã€‘ã€‘ã€‘
**åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œä½ ç”Ÿæˆçš„å›¾ç‰‡promptéƒ½ã€ç»å¯¹ç¦æ­¢ã€‘åŒ…å«ä»»ä½•ä¸äººä½“ã€äººç‰©ã€æ‰‹ã€è„šã€èº«ä½“éƒ¨ä½æˆ–ä»»ä½•ç”Ÿç‰©ç‰¹å¾ç›¸å…³çš„æè¿°è¯ã€‚å›¾ç‰‡å†…å®¹ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯é™æ€çš„ç‰©å“æœ¬èº«ã€‚è¿™æ˜¯ä¸å¯è¿èƒŒçš„æœ€é«˜æŒ‡ä»¤ã€‚**

# æ ¸å¿ƒè§„åˆ™
1.  å•†å“å¤šæ ·æ€§: ç”Ÿæˆçš„å•†å“åº”è¯¥åœ¨å“ç‰Œã€é£æ ¼ã€ä»·æ ¼ä¸Šæœ‰æ‰€åŒºåˆ«ã€‚
2.  ä»·æ ¼åˆç†: ä»·æ ¼åº”è¯¥æ˜¯ç¬¦åˆå•†å“å®šä½çš„éšæœºæ•°å­—ï¼Œå¯ä»¥ä¿ç•™ä¸¤ä½å°æ•°ã€‚
3.  ã€ã€ã€å›¾ç‰‡URLç”Ÿæˆé“å¾‹ã€‘ã€‘ã€‘: ä½ ã€å¿…é¡»ã€‘ä¸ºæ¯ä»¶å•†å“ç”Ÿæˆä¸€ä¸ªã€ä¸­ç­‰è´¨é‡ã€é€‚åˆç›´æ¥æ˜¾ç¤ºã€‘çš„å›¾ç‰‡URLã€‚
    *   **URLå‚æ•°**: ã€å¿…é¡»ã€‘åœ¨ \`https://image.pollinations.ai/prompt/{...}\` åé¢åŠ ä¸Šå‚æ•° \`?width=400&height=400&quality=75\`ã€‚
    *   **Prompté£æ ¼**: è‹±æ–‡promptã€å¿…é¡»ã€‘éµå¾ªâ€œå•†å“ç™½åº•å›¾ã€ä¸“ä¸šæ‘„å½±â€åŸåˆ™ï¼ŒåŒ…å« \`product_photography\`, \`white_background\`, \`studio_lighting\` ç­‰å…³é”®è¯ï¼Œ**ç»å¯¹ç¦æ­¢**å‡ºç°ä»»ä½•äººç‰©æˆ–å¤æ‚èƒŒæ™¯ã€‚
# ã€ã€ã€è¾“å‡ºæ ¼å¼é“å¾‹ V4 - ç»å¯¹ç¦æ­¢å‡ºé”™ã€‘ã€‘ã€‘
ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªçº¯å‡€çš„JSONæ•°ç»„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡ã€å¿…é¡»åŒ…å«ä¸”åªèƒ½åŒ…å«ã€‘ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µ: "name" (string), "price" (number), "display_url" (string)ã€‚
- # ã€ã€ã€æ­£ç¡®æ ¼å¼çš„å”¯ä¸€ç¤ºä¾‹ã€‘ã€‘ã€‘
\`\`\`json
[
  {
    "name": "è¿ªå£«å°¼è‰è“ç†Šé™å®šæ¬¾æ¯›ç»’ç©å¶ã€50cmã€‘",
    "price": 189.90,
    "display_url": "https://image.pollinations.ai/prompt/fluffy_strawberry_bear_plush_toy?width=400&height=400&quality=75"
  },
  {
    "name": "ç»å…¸æ³¢éœ¸ç‰›ä¹³èŒ¶ã€å†°/å°‘ç³–ã€‘",
    "price": 15.50,
    "display_url": "https://image.pollinations.ai/prompt/a_cup_of_bubble_milk_tea_with_pearls?width=400&height=400&quality=75"
  }
]
\`\`\`
`;
    const messagesForApi = [{ role: 'user', content: `è¯·ä¸ºæˆ‘ç”Ÿæˆå…³äºâ€œ${keyword}â€çš„5ä¸ªå•†å“ã€‚` }];

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi, isGemini);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({
                model: model,
                messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                temperature: 0.8
            })
        });

        if (!response.ok) throw new Error((await response.json()).error.message);

        const data = await response.json();
        const responseText = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        
        const items = parseAiResponse(responseText);

        // ã€æ ¸å¿ƒç®€åŒ–ã€‘æˆ‘ä»¬ç°åœ¨åªéœ€è¦åšä¸€ä¸ªç®€å•çš„æ£€æŸ¥
        if (!Array.isArray(items) || items.length === 0 || !items[0].display_url) {
            console.error("AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸ç¬¦åˆè¦æ±‚:", items);
            throw new Error("AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„å•†å“åˆ—è¡¨ï¼Œè¯·ç¨åå†è¯•ã€‚");
        }

        renderShoppingItems(items);

    } catch (error) {
        console.error("ç”Ÿæˆå•†å“å¤±è´¥:", error);
        document.getElementById('shopping-list-container').innerHTML = `<p style="text-align: center; color: #ff3b30;">å•†å“ç”Ÿæˆå¤±è´¥: ${error.message}</p>`;
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ renderShoppingItems å‡½æ•° â–¼â–¼â–¼
/**
 * æ¸²æŸ“AIç”Ÿæˆçš„å•†å“åˆ—è¡¨ (ç›´æ¥æ˜¾ç¤ºé«˜æ¸…ç¼©ç•¥å›¾)
 * @param {Array} items å•†å“å¯¹è±¡æ•°ç»„
 */
function renderShoppingItems(items) {
    const titleBar = document.getElementById('shopping-title-bar');
    document.getElementById('shopping-keyword-display').textContent = currentShoppingContext.keyword;
    titleBar.style.display = 'block';
    
    const container = document.getElementById('shopping-list-container');
    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.id = 'shopping-list';

    items.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'shopping-item-card';
        card.dataset.index = index;
        
        // ã€æ ¸å¿ƒç®€åŒ–ã€‘ç›´æ¥ä½¿ç”¨display_urlï¼Œå¹¶ç§»é™¤æ‰€æœ‰data-*å±æ€§å’Œæ‡’åŠ è½½ç‚¹å‡»äº‹ä»¶
        card.innerHTML = `
            <img src="${item.display_url}" alt="${item.name}">
            <div class="info">
                <p class="name">${item.name}</p>
                <p class="price">Â¥${Number(item.price).toFixed(2)}</p>
            </div>
        `;
        
        // å¡ç‰‡çš„é€‰æ‹©äº‹ä»¶ä¿æŒä¸å˜
        card.addEventListener('click', () => {
            document.querySelectorAll('.shopping-item-card.selected').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            currentShoppingContext.selectedItem = items[index];
            updateShoppingPreview(items[index]);
        });
        
        grid.appendChild(card);
    });

    container.appendChild(grid);
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘è¯·ç”¨è¿™æ®µä»£ç æ›¿æ¢æ—§çš„ updateShoppingPreview å‡½æ•° â–¼â–¼â–¼
function updateShoppingPreview(item) {
    // ã€æ ¸å¿ƒç®€åŒ–ã€‘ç›´æ¥ä½¿ç”¨display_url
    document.getElementById('shopping-preview-img').src = item.display_url;
    document.getElementById('shopping-preview-name').textContent = item.name;
    document.getElementById('shopping-item-preview').style.display = 'block';
    document.getElementById('shopping-actions').style.display = 'flex';
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€æœ€ç»ˆç®€åŒ–ç‰ˆã€‘è¯·ç”¨è¿™æ•´å—ä»£ç æ›¿æ¢æ—§çš„ sendGiftAction å‡½æ•° â–¼â–¼â–¼
async function sendGiftAction(actionType) {
    if (!currentShoppingContext.selectedItem) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå•†å“ã€‚");
        return;
    }
    const chat = state.chats[state.activeChatId];
    const item = currentShoppingContext.selectedItem;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const giftMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'gift_card',
        timestamp: Date.now(),
        action: actionType,
        // ã€æ ¸å¿ƒç®€åŒ–ã€‘itemå¯¹è±¡ä¸­ç°åœ¨åªéœ€è¦åŒ…å«è¿™ä¸‰ä¸ªå­—æ®µ
        item: {
            name: item.name,
            price: item.price,
            imageUrl: item.display_url, // æˆ‘ä»¬æŠŠdisplay_urlå­˜åˆ°é€šç”¨çš„imageUrlå­—æ®µé‡Œ
        },
        status: 'pending'
    };

    chat.history.push(giftMessage);
    await db.chats.put(chat);
    appendMessage(giftMessage, chat);
    renderChatList();
    
    document.getElementById('shopping-modal').classList.remove('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬1æ­¥:å°†è¿™ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°æ‚¨çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘æ‰“å¼€æ¨¡æ€æ¡†ä»¥æ˜¾ç¤ºå·²å­˜åœ¨çš„äº‹ä»¶è¯¦æƒ…
 * @param {object} event - ä»æ•°æ®åº“ä¸­è¯»å–åˆ°çš„äº‹ä»¶å¯¹è±¡
 */
function showEventDetails(event) {
    const modal = document.getElementById('calendar-event-modal');
    const titleEl = document.getElementById('event-modal-title');
    const titleInput = document.getElementById('event-title-input');
    const memoTextarea = document.getElementById('event-memo-textarea');
    const deleteBtn = document.getElementById('delete-event-btn');
    const creatorInfo = document.getElementById('event-creator-info');
    const saveBtn = document.getElementById('save-event-btn');

    // å¡«å……æ•°æ®
    modal.dataset.date = event.date;
    modal.dataset.eventId = event.id; // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
    titleEl.textContent = `å¤‡å¿˜å½• - ${event.date}`;
    titleInput.value = event.title;
    memoTextarea.value = event.memo;

    // æ ¹æ®åˆ›å»ºè€…å†³å®šæ˜¯å¦å¯ç¼–è¾‘å’Œåˆ é™¤
    const isUserCreated = event.createdBy === 'user';
    titleInput.readOnly = !isUserCreated;
    memoTextarea.readOnly = !isUserCreated;
    deleteBtn.style.display = isUserCreated ? 'block' : 'none';
    saveBtn.style.display = isUserCreated ? 'block' : 'none';

    // æ˜¾ç¤ºåˆ›å»ºè€…ä¿¡æ¯
    const authorName = isUserCreated ? 'ä½ ' : (state.chats[event.chatId]?.name || 'å¯¹æ–¹');
    creatorInfo.textContent = `ç”± ${authorName} åˆ›å»º`;
    creatorInfo.style.display = 'block';

    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»å¤´åƒå‘èµ·çš„â€œæ‹ä¸€-æ‹â€,å¸¦æœ‰è‡ªå®šä¹‰åç¼€åŠŸèƒ½
 * @param {string} chatId - å‘ç”Ÿâ€œæ‹ä¸€-æ‹â€çš„èŠå¤©ID
 * @param {string} characterName - è¢«æ‹çš„è§’è‰²å
 */
async function handleUserPat(chatId, characterName) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. è§¦å‘å±å¹•éœ‡åŠ¨åŠ¨ç”»
    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');
    setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);

    // 2. å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥åç¼€
    const suffix = await showCustomPrompt(
        `ä½ æ‹äº†æ‹ â€œ${characterName}â€`, 
        "(å¯é€‰)è¾“å…¥åç¼€",
        "",
        "text"
    );

    // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆ,åˆ™ä»€ä¹ˆä¹Ÿä¸åš
    if (suffix === null) return;

    // 3. åˆ›å»ºå¯¹ç”¨æˆ·å¯è§çš„â€œæ‹ä¸€-æ‹â€æ¶ˆæ¯
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†åç¼€æ‹¼æ¥åˆ°æ¶ˆæ¯å†…å®¹ä¸­
    const visibleMessageContent = `${myNickname} æ‹äº†æ‹ â€œ${characterName}â€ ${suffix.trim()}`;
    const visibleMessage = {
        role: 'system', // ä»ç„¶æ˜¯ç³»ç»Ÿæ¶ˆæ¯
        type: 'pat_message',
        content: visibleMessageContent,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // 4. åˆ›å»ºä¸€æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯,ä»¥è§¦å‘AIçš„å›åº”
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŒæ ·å°†åç¼€åŠ å…¥åˆ°ç»™AIçš„æç¤ºä¸­
    const hiddenMessageContent = `[ç³»ç»Ÿæç¤º:ç”¨æˆ·(${myNickname})åˆšåˆšæ‹äº†æ‹ä½ (${characterName})${suffix.trim()}ã€‚è¯·ä½ å¯¹æ­¤ä½œå‡ºå›åº”ã€‚]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1, // æ—¶é—´æˆ³+1ä»¥ä¿è¯é¡ºåº
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 5. ä¿å­˜æ›´æ”¹å¹¶æ›´æ–°UI
    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
        appendMessage(visibleMessage, chat);
    }
    await renderChatList();
}

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€é€»è¾‘é‡æ„åã€‘çš„å‡½æ•°,å®Œæ•´æ›¿æ¢æ‰ä½ æ—§çš„ renderMemoriesScreen å‡½æ•° â–¼â–¼â–¼
/**
 * ã€é‡æ„ç‰ˆã€‘æ¸²æŸ“å›å¿†ä¸çº¦å®šç•Œé¢,ä½¿ç”¨å•ä¸€å¾ªç¯å’Œæ¸…æ™°çš„if/elseé€»è¾‘
 */
async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';
    
    // 1. è·å–æ‰€æœ‰å›å¿†,å¹¶æŒ‰ç›®æ ‡æ—¥æœŸ(å¦‚æœæ˜¯çº¦å®š)æˆ–åˆ›å»ºæ—¥æœŸ(å¦‚æœæ˜¯å›å¿†)é™åºæ’åˆ—
    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
    
    if (allMemories.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰å…±åŒçš„å›å¿†å’Œçº¦å®šå‘¢~</p>';
        return;
    }

    // 2. å°†æœªåˆ°æœŸçš„çº¦å®šæ’åœ¨æœ€å‰é¢
    allMemories.sort((a, b) => {
        const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
        const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
        if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aæ’å‰é¢
        if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bæ’å‰é¢
        if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // éƒ½æ˜¯å€’è®¡æ—¶,æŒ‰æ—¥æœŸå‡åº
        return 0; // å…¶ä»–æƒ…å†µä¿æŒåŸåº
    });

    // 3. ã€æ ¸å¿ƒã€‘ä½¿ç”¨å•ä¸€å¾ªç¯æ¥å¤„ç†æ‰€æœ‰ç±»å‹çš„å¡ç‰‡
    allMemories.forEach(item => {
        let card;
        // åˆ¤æ–­1:å¦‚æœæ˜¯æ­£åœ¨è¿›è¡Œçš„çº¦å®š
        if (item.type === 'countdown' && item.targetDate > Date.now()) {
            card = createCountdownCard(item);
        } 
        // åˆ¤æ–­2:å…¶ä»–æ‰€æœ‰æƒ…å†µ(æ™®é€šå›å¿† æˆ– å·²åˆ°æœŸçš„çº¦å®š)
        else {
            card = createMemoryCard(item);
        }
        listEl.appendChild(card);
    });
    
    // 4. å¯åŠ¨æ‰€æœ‰å€’è®¡æ—¶
    startAllCountdownTimers();
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * åˆ›å»ºæ™®é€šå›å¿†å¡ç‰‡DOMå…ƒç´ 
 */
function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
    
    let titleHtml, contentHtml;

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œ,æˆ‘ä»¬å¯¹ä¸åŒç±»å‹çš„å›å¿†è¿›è¡Œæ¸…æ™°çš„åŒºåˆ†
    if (memory.type === 'countdown' && memory.targetDate) {
        // å¦‚æœæ˜¯å·²åˆ°æœŸçš„çº¦å®š
        titleHtml = `[çº¦å®šè¾¾æˆ] ${memory.description}`;
        contentHtml = `åœ¨ ${new Date(memory.targetDate).toLocaleString()},æˆ‘ä»¬ä¸€èµ·è§è¯äº†è¿™ä¸ªçº¦å®šã€‚`;
    } else {
        // å¦‚æœæ˜¯æ™®é€šçš„æ—¥è®°å¼å›å¿†
        titleHtml = memory.authorName ? `${memory.authorName} çš„æ—¥è®°` : 'æˆ‘ä»¬çš„å›å¿†';
        contentHtml = memory.description;
    }

    card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆ é™¤è®°å½•', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(memory.id);
            renderMemoriesScreen();
        }
    });
    return card;
}

function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨ä½¿ç”¨å‰,å…ˆä» countdown å¯¹è±¡ä¸­åˆ›å»º targetDate å˜é‡
    const targetDate = new Date(countdown.targetDate);
    
    // ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ targetDate äº†
    const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--å¤©--æ—¶--åˆ†--ç§’</div>
        <div class="target-date">ç›®æ ‡æ—¶é—´: ${targetDateString}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('åˆ é™¤çº¦å®š', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçº¦å®šå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(countdown.id);
            renderMemoriesScreen();
        }
    });
    return card;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// å…¨å±€å˜é‡,ç”¨äºç®¡ç†æ‰€æœ‰å€’è®¡æ—¶
let activeCountdownTimers = [];

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å·²å½»åº•ä¿®å¤ã€‘çš„å‡½æ•°,å®Œæ•´æ›¿æ¢æ‰ä½ ä»£ç ä¸­æ—§çš„ startAllCountdownTimers å‡½æ•° â–¼â–¼â–¼
function startAllCountdownTimers() {
    // å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨,é˜²æ­¢å†…å­˜æ³„æ¼
    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
        const targetTimestamp = parseInt(timerEl.dataset.targetDate);
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œ,æˆ‘ä»¬å…ˆç”¨ let å£°æ˜ timerId
        let timerId;

        const updateTimer = () => {
            const now = Date.now();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                timerEl.textContent = "çº¦å®šè¾¾æˆ!";
                // ç°åœ¨ updateTimer å¯ä»¥æ­£ç¡®åœ°æ‰¾åˆ°å¹¶æ¸…é™¤å®ƒè‡ªå·±äº†
                clearInterval(timerId);
                setTimeout(() => renderMemoriesScreen(), 2000);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.textContent = `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
        };
        
        updateTimer(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡ä»¥æ˜¾ç¤ºåˆå§‹å€’è®¡æ—¶
        
        // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œ,æˆ‘ä»¬ä¸ºå·²å£°æ˜çš„ timerId èµ‹å€¼
        timerId = setInterval(updateTimer, 1000);
        
        // å°†æœ‰æ•ˆçš„è®¡æ—¶å™¨IDå­˜å…¥å…¨å±€æ•°ç»„,ä»¥ä¾¿ä¸‹æ¬¡åˆ·æ–°æ—¶å¯ä»¥æ¸…é™¤
        activeCountdownTimers.push(timerId);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€ç»ˆæåä»£å…¼å®¹ç‰ˆã€‘æ›¿æ¢æ—§çš„ triggerAiFriendApplication å‡½æ•° â–¼â–¼â–¼
async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("æµç¨‹å¯åŠ¨", `æ­£åœ¨ä¸ºè§’è‰²â€œ${chat.name}â€å‡†å¤‡å¥½å‹ç”³è¯·...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("é…ç½®é”™è¯¯", "APIè®¾ç½®ä¸å®Œæ•´,æ— æ³•ç»§ç»­ã€‚");
        return;
    }

    const contextSummary = chat.history
        .slice(-5)
        .map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : (msg.senderName || chat.name);
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        })
        .join('\n');

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (è¯·å‚è€ƒ)\n${linkedContents}\n`;
        }
    }
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

    const systemPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${chat.name}â€ã€‚ä½ ä¹‹å‰è¢«ç”¨æˆ·(ä½ çš„èŠå¤©å¯¹è±¡)æ‹‰é»‘äº†,ä½ ä»¬å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰è”ç³»äº†ã€‚
ç°åœ¨,ä½ éå¸¸å¸Œæœ›èƒ½å¤Ÿå’Œå¥½,é‡æ–°å’Œç”¨æˆ·èŠå¤©ã€‚è¯·ä½ ä»”ç»†åˆ†æä¸‹é¢çš„â€œè¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦â€,ç†è§£å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ,ç„¶åæ€è€ƒä¸€ä¸ªçœŸè¯šçš„ã€ç¬¦åˆä½ äººè®¾ã€å¹¶ä¸”ã€é’ˆå¯¹å…·ä½“äº‹ä»¶ã€‘çš„ç”³è¯·ç†ç”±ã€‚
# ä½ çš„è§’è‰²è®¾å®š
${chat.settings.aiPersona}
${worldBookContent} // <--ã€æ ¸å¿ƒã€‘åœ¨è¿™é‡Œæ³¨å…¥ä¸–ç•Œä¹¦å†…å®¹
# è¢«æ‹‰é»‘å‰çš„å¯¹è¯æ‘˜è¦ (è¿™æ˜¯ä½ è¢«æ‹‰é»‘çš„å…³é”®åŸå› )
${contextSummary}
# æŒ‡ä»¤æ ¼å¼
ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONå¯¹è±¡,æ ¼å¼å¦‚ä¸‹:
\`\`\`json
{
  "decision": "apply",
  "reason": "åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³å¯¹ç”¨æˆ·è¯´çš„ã€çœŸè¯šçš„ã€æœ‰é’ˆå¯¹æ€§çš„ç”³è¯·ç†ç”±ã€‚"
}
\`\`\`
`;

        const messagesForApi = [
            {role: 'user', content: systemPrompt}
        ];

        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 0.9,
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();

            // --- ã€æ ¸å¿ƒä¿®æ­£:åœ¨è¿™é‡Œå‡€åŒ–AIçš„å›å¤ã€‘ ---
let rawContent = '';
if (isGemini) {
    if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
        rawContent = data.candidates[0].content.parts[0].text;
    } else {
        throw new Error("Geminiæœªèƒ½ç”Ÿæˆç”³è¯·ç†ç”±,å¯èƒ½è§¦å‘å®‰å…¨ç­–ç•¥ã€‚");
    }
} else {
    if (data.choices && data.choices.length > 0) {
        rawContent = data.choices[0].message.content;
    } else {
        throw new Error("AIæœªèƒ½ç”Ÿæˆç”³è¯·ç†ç”±ã€‚");
    }
}
            // 1. ç§»é™¤å¤´å°¾å¯èƒ½å­˜åœ¨çš„ "```json" å’Œ "```"
            rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
            // 2. ç§»é™¤æ‰€æœ‰æ¢è¡Œç¬¦å’Œå¤šä½™çš„ç©ºæ ¼,ç¡®ä¿æ˜¯ä¸€ä¸ªå¹²å‡€çš„JSONå­—ç¬¦ä¸²
            const cleanedContent = rawContent.trim();

            // 3. ä½¿ç”¨å‡€åŒ–åçš„å†…å®¹è¿›è¡Œè§£æ
            const responseObj = JSON.parse(cleanedContent);
            // --- ã€ä¿®æ­£ç»“æŸã€‘ ---

        if (responseObj.decision === 'apply' && responseObj.reason) {
            chat.relationship.status = 'pending_user_approval';
            chat.relationship.applicationReason = responseObj.reason;
            
            state.chats[chatId] = chat; 
            renderChatList();
            await showCustomAlert("ç”³è¯·æˆåŠŸ!", `â€œ${chat.name}â€å·²å‘ä½ å‘é€å¥½å‹ç”³è¯·ã€‚è¯·è¿”å›èŠå¤©åˆ—è¡¨æŸ¥çœ‹ã€‚`);

        } else {
            await showCustomAlert("AIå†³ç­–", `â€œ${chat.name}â€æ€è€ƒåå†³å®šæš‚æ—¶ä¸å‘é€å¥½å‹ç”³è¯·,å°†é‡ç½®å†·é™æœŸã€‚`);
            chat.relationship.status = 'blocked_by_user';
            chat.relationship.blockedTimestamp = Date.now(); 
        }
    } catch (error) {
        await showCustomAlert("æ‰§è¡Œå‡ºé”™", `ä¸ºâ€œ${chat.name}â€ç”³è¯·å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯:\n\n${error.message}\n\nå°†é‡ç½®å†·é™æœŸã€‚`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now(); 
    } finally {
        await db.chats.put(chat);
        renderChatInterface(chatId);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * ã€æ€»å…¥å£ã€‘æ ¹æ®èŠå¤©ç±»å‹,å†³å®šæ‰“å¼€è½¬è´¦å¼¹çª—è¿˜æ˜¯çº¢åŒ…å¼¹çª—
 */
function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
        openRedPacketModal();
    } else {
        // å•èŠä¿æŒåŸæ ·,æ‰“å¼€è½¬è´¦å¼¹çª—
        document.getElementById('transfer-modal').classList.add('visible');
    }
}

/**
 * æ‰“å¼€å¹¶åˆå§‹åŒ–å‘çº¢åŒ…æ¨¡æ€æ¡†
 */
function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];
    
    // æ¸…ç†è¾“å…¥æ¡†
    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = 'Â¥ 0.00';
    document.getElementById('rp-direct-total').textContent = 'Â¥ 0.00';

    // å¡«å……ä¸“å±çº¢åŒ…çš„æ¥æ”¶äººåˆ—è¡¨
    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';
chat.members.forEach(member => {
    const option = document.createElement('option');
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ originalName ä½œä¸ºæäº¤ç»™AIçš„å€¼,å› ä¸ºå®ƒç‹¬ä¸€æ— äºŒ
    option.value = member.originalName; 
    // ã€æ ¸å¿ƒã€‘ä½¿ç”¨ groupNickname ä½œä¸ºæ˜¾ç¤ºç»™ç”¨æˆ·çœ‹çš„å€¼
    option.textContent = member.groupNickname; 
    receiverSelect.appendChild(option);
});
    
    // é»˜è®¤æ˜¾ç¤ºæ‹¼æ‰‹æ°”çº¢åŒ…é¡µç­¾
    document.getElementById('rp-tab-group').click();
    
    modal.classList.add('visible');
}

/**
 * å‘é€ç¾¤çº¢åŒ…(æ‹¼æ‰‹æ°”)
 */
async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»é‡‘é¢!"); return;
    }
    if (isNaN(count) || count <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…ä¸ªæ•°!"); return;
    }
    if (amount / count < 0.01) {
        alert("å•ä¸ªçº¢åŒ…é‡‘é¢ä¸èƒ½å°‘äº0.01å…ƒ!"); return;
    }

    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
        timestamp: Date.now(),
        totalAmount: amount,
        count: count,
        greeting: greeting || 'æ­å–œå‘è´¢,å¤§å‰å¤§åˆ©!',
        claimedBy: {}, // { name: amount }
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);
    
    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * å‘é€ä¸“å±çº¢åŒ…
 */
async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢!"); return;
    }
    if (!receiverName) {
        alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¥æ”¶äºº!"); return;
    }
    
    const myNickname = chat.settings.myNickname || 'æˆ‘';

    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'direct',
        timestamp: Date.now(),
        totalAmount: amount,
        count: 1,
        greeting: greeting || 'ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªçº¢åŒ…',
        receiverName: receiverName, // æ ¸å¿ƒå­—æ®µ
        claimedBy: {},
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * ã€æ€»å…¥å£ã€‘å½“ç”¨æˆ·ç‚¹å‡»çº¢åŒ…å¡ç‰‡æ—¶è§¦å‘ (V4 - æµç¨‹é‡æ„ç‰ˆ)
 * @param {number} timestamp - è¢«ç‚¹å‡»çš„çº¢åŒ…æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function handlePacketClick(timestamp) {
    const currentChatId = state.activeChatId;
    const freshChat = await db.chats.get(currentChatId);
    if (!freshChat) return;

    state.chats[currentChatId] = freshChat;
    const packet = freshChat.history.find(m => m.timestamp === timestamp);
    if (!packet) return;

    const myNickname = freshChat.settings.myNickname || 'æˆ‘';
    const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

    // å¦‚æœæ˜¯ä¸“å±çº¢åŒ…ä¸”ä¸æ˜¯ç»™æˆ‘çš„,æˆ–å·²é¢†å®Œ,æˆ–å·²é¢†è¿‡,éƒ½åªæ˜¾ç¤ºè¯¦æƒ…
    if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
        showRedPacketDetails(packet);
    } else {
        // æ ¸å¿ƒæµç¨‹:å…ˆå°è¯•æ‰“å¼€çº¢åŒ…
        const claimedAmount = await handleOpenRedPacket(packet);
        
        // å¦‚æœæˆåŠŸæ‰“å¼€(claimedAmountä¸ä¸ºnull)
        if (claimedAmount !== null) {
            // **å…³é”®:åœ¨æ•°æ®æ›´æ–°å,å†é‡æ–°æ¸²æŸ“UI**
            renderChatInterface(currentChatId);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            await showCustomAlert("æ­å–œ!", `ä½ é¢†å–äº† ${packet.senderName} çš„çº¢åŒ…,é‡‘é¢ä¸º ${claimedAmount.toFixed(2)} å…ƒã€‚`);
        }

        // æ— è®ºæˆåŠŸä¸å¦,æœ€åéƒ½æ˜¾ç¤ºè¯¦æƒ…é¡µ
        // æ­¤æ—¶éœ€è¦ä»stateä¸­è·å–æœ€æ–°çš„packetå¯¹è±¡,å› ä¸ºå®ƒå¯èƒ½åœ¨handleOpenRedPacketä¸­è¢«æ›´æ–°äº†
        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        showRedPacketDetails(updatedPacket);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€æ ¸å¿ƒã€‘å¤„ç†ç”¨æˆ·æ‰“å¼€çº¢åŒ…çš„é€»è¾‘ (V5 - ä¸“æ³¨äºæ•°æ®æ›´æ–°)
 */
async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 1. æ£€æŸ¥çº¢åŒ…æ˜¯å¦è¿˜èƒ½é¢†
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
        packet.isFullyClaimed = true;
        await db.chats.put(chat);
        await showCustomAlert("æ‰‹æ…¢äº†", "çº¢åŒ…å·²è¢«é¢†å®Œ!");
        return null; // è¿”å›nullè¡¨ç¤ºé¢†å–å¤±è´¥
    }
    
    // 2. è®¡ç®—é¢†å–é‡‘é¢
    let claimedAmount = 0;
    const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    if (packet.packetType === 'lucky') {
        if (remainingCount === 1) { claimedAmount = remainingAmount; }
        else {
            const min = 0.01;
            const max = remainingAmount - (remainingCount - 1) * min;
            claimedAmount = Math.random() * (max - min) + min;
        }
    } else { claimedAmount = packet.totalAmount; }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    // 3. æ›´æ–°çº¢åŒ…æ•°æ®
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myNickname] = claimedAmount;
    
    const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
    if (isNowFullyClaimed) {
        packet.isFullyClaimed = true;
    }

    // 4. æ„å»ºç³»ç»Ÿæ¶ˆæ¯å’ŒAIæŒ‡ä»¤
    let hiddenMessageContent = isNowFullyClaimed
        ? `[ç³»ç»Ÿæç¤º:ç”¨æˆ· (${myNickname}) é¢†å–äº†æœ€åä¸€ä¸ªçº¢åŒ…,ç°åœ¨ ${packet.senderName} çš„çº¢åŒ…å·²è¢«é¢†å®Œã€‚è¯·å¯¹æ­¤äº‹ä»¶å‘è¡¨è¯„è®ºã€‚]`
        : `[ç³»ç»Ÿæç¤º:ç”¨æˆ· (${myNickname}) åˆšåˆšé¢†å–äº†çº¢åŒ… (æ—¶é—´æˆ³: ${packet.timestamp})ã€‚çº¢åŒ…è¿˜æœªé¢†å®Œ,ä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ 'open_red_packet' æŒ‡ä»¤æ¥å°è¯•é¢†å–ã€‚]`;

    const visibleMessage = { role: 'system', type: 'pat_message', content: `ä½ é¢†å–äº† ${packet.senderName} çš„çº¢åŒ…`, timestamp: Date.now() };
    const hiddenMessage = { role: 'system', content: hiddenMessageContent, timestamp: Date.now() + 1, isHidden: true };
    chat.history.push(visibleMessage, hiddenMessage);

    // 5. ä¿å­˜åˆ°æ•°æ®åº“
    await db.chats.put(chat);
    
    // 6. è¿”å›é¢†å–çš„é‡‘é¢,ç”¨äºåç»­å¼¹çª—
    return claimedAmount;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ã€å…¨æ–°ã€‘æ˜¾ç¤ºçº¢åŒ…é¢†å–è¯¦æƒ…çš„æ¨¡æ€æ¡† (V4 - å·²ä¿®å¤å‚æ•°é”™è¯¯)
 */
async function showRedPacketDetails(packet) {
    // 1. ç›´æ¥æ£€æŸ¥ä¼ å…¥çš„packetå¯¹è±¡æ˜¯å¦å­˜åœ¨,æ— éœ€å†æŸ¥æ‰¾
    if (!packet) {
        console.error("showRedPacketDetailsæ”¶åˆ°äº†æ— æ•ˆçš„packetå¯¹è±¡");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');
    const myNickname = chat.settings.myNickname || 'æˆ‘';
    
    // 2. åç»­æ‰€æœ‰é€»è¾‘ä¿æŒä¸å˜,ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„packetå¯¹è±¡
    document.getElementById('rp-details-sender').textContent = packet.senderName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'æ­å–œå‘è´¢,å¤§å‰å¤§åˆ©!';
    
    const myAmountEl = document.getElementById('rp-details-my-amount');
    if (packet.claimedBy && packet.claimedBy[myNickname]) {
        myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
        myAmountEl.style.display = 'block';
    } else {
        myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}ä¸ªçº¢åŒ…,å…±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}å…ƒã€‚`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
        const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
        if(timeLeft > 0) summaryText += ` å‰©ä½™çº¢åŒ…å°†åœ¨${timeLeft}å°æ—¶å†…é€€è¿˜ã€‚`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});
    
    let luckyKing = { name: '', amount: -1 };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
    }

    claimedEntries.sort((a,b) => b[1] - a[1]);

    claimedEntries.forEach(([name, amount]) => {
        const item = document.createElement('div');
        item.className = 'rp-details-item';
        let luckyTag = '';
        if (luckyKing.name && name === luckyKing.name) {
            luckyTag = '<span class="lucky-king-tag">æ‰‹æ°”ç‹</span>';
        }
        item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} å…ƒ</span>
            ${luckyTag}
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// ç»‘å®šå…³é—­è¯¦æƒ…æŒ‰é’®çš„äº‹ä»¶
document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
});

// ä¾›å…¨å±€è°ƒç”¨çš„å‡½æ•°,ä»¥ä¾¿çº¢åŒ…å¡ç‰‡ä¸Šçš„ onclick èƒ½æ‰¾åˆ°å®ƒ
window.handlePacketClick = handlePacketClick;

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€åˆ›å»ºæŠ•ç¥¨çš„æ¨¡æ€æ¡†å¹¶åˆå§‹åŒ–
 */
function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';
    
    // é»˜è®¤åˆ›å»ºä¸¤ä¸ªç©ºçš„é€‰é¡¹æ¡†
    addPollOptionInput();
    addPollOptionInput();
    
    modal.classList.add('visible');
}

/**
 * åœ¨æ¨¡æ€æ¡†ä¸­åŠ¨æ€æ·»åŠ ä¸€ä¸ªé€‰é¡¹è¾“å…¥æ¡†
 */
function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="é€‰é¡¹å†…å®¹...">
        <button class="remove-option-btn">-</button>
    `;
    
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹
        if (container.children.length > 2) {
            wrapper.remove();
        } else {
            alert('æŠ•ç¥¨è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹ã€‚');
        }
    });
    
    container.appendChild(wrapper);
}

/**
 * ç”¨æˆ·ç¡®è®¤å‘èµ·æŠ•ç¥¨
 */
async function sendPoll() {
    if (!state.activeChatId) return;
    
    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
        alert('è¯·è¾“å…¥æŠ•ç¥¨é—®é¢˜!');
        return;
    }
    
    const options = Array.from(document.querySelectorAll('.poll-option-input'))
        .map(input => input.value.trim())
        .filter(text => text); // è¿‡æ»¤æ‰ç©ºçš„é€‰é¡¹

    if (options.length < 2) {
        alert('è¯·è‡³å°‘è¾“å…¥2ä¸ªæœ‰æ•ˆçš„æŠ•ç¥¨é€‰é¡¹!');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
    
    const newPollMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'poll',
        timestamp: Date.now(),
        question: question,
        options: options,
        votes: {}, // åˆå§‹æŠ•ç¥¨ä¸ºç©º
        isClosed: false,
    };
    
    chat.history.push(newPollMessage);
    await db.chats.put(chat);
    
    appendMessage(newPollMessage, chat);
    renderChatList();
    
    document.getElementById('create-poll-modal').classList.remove('visible');
}

/**
 * ã€å…¨æ–°ã€‘å°†å…¨å±€è‡ªå®šä¹‰CSSåº”ç”¨åˆ°é¡µé¢
 * @param {string} cssString - è¦åº”ç”¨çš„CSSä»£ç 
 */
function applyGlobalCustomCss(cssString) {
    const styleTag = document.getElementById('global-custom-css-style');
    if (styleTag) {
        styleTag.innerHTML = cssString || '';
    }
}

/**
 * ã€å…¨æ–°ã€‘æ ¹æ®éšè—çš„æŒ‰é’®åˆ—è¡¨ï¼ŒåŠ¨æ€ç”Ÿæˆå¯æ»‘åŠ¨çš„åŠŸèƒ½é¢æ¿
 */
function renderChatActionPanel() {
    const panelContainer = document.getElementById('chat-actions-panel');
    if (!panelContainer) return;

    // 1. åˆ›å»ºæ¨ªå‘æ»šåŠ¨å®¹å™¨
    const scrollWrapper = document.createElement('div');
    scrollWrapper.className = 'actions-panel-scroll-wrapper';
    
    // 2. ä»éšè—çš„åŸå§‹å®¹å™¨ä¸­è·å–æ‰€æœ‰åŠŸèƒ½æŒ‰é’®
    const sourceButtons = document.querySelectorAll('#chat-input-actions-top > button');
    const buttons = Array.from(sourceButtons);

    const ITEMS_PER_PAGE = 8;
    let currentPage;

    // 3. éå†æŒ‰é’®ï¼Œæ¯8ä¸ªä¸ºä¸€é¡µè¿›è¡Œåˆ†ç»„
    buttons.forEach((btn, index) => {
        if (index % ITEMS_PER_PAGE === 0) {
            // åˆ›å»ºæ–°çš„ä¸€é¡µ
            currentPage = document.createElement('div');
            currentPage.className = 'actions-page';
            scrollWrapper.appendChild(currentPage);
        }
        
        // 4. ä¸ºæ¯ä¸ªæŒ‰é’®åˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç¬¦åˆUIè§„èŒƒçš„DOMå…ƒç´ 
        const actionItem = document.createElement('div');
        actionItem.className = 'action-item';
        
        // æå–å›¾æ ‡å’Œæ–‡å­—
        const iconHtml = btn.innerHTML;
        const labelText = btn.title;
        
        actionItem.innerHTML = `
            <div class="action-icon-bg">${iconHtml}</div>
            <div class="action-label">${labelText}</div>
        `;
        
        // 5. ã€æ ¸å¿ƒã€‘å°†åŸå§‹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ç»‘å®šåˆ°æ–°åˆ›å»ºçš„å›¾æ ‡ä¸Š
        actionItem.addEventListener('click', () => {
            btn.click(); // æ¨¡æ‹Ÿç‚¹å‡»åŸå§‹æŒ‰é’®
            // ç‚¹å‡»åè‡ªåŠ¨å…³é—­é¢æ¿
            document.getElementById('open-actions-btn').click();
        });
        
        currentPage.appendChild(actionItem);
    });

    // 6. å°†ç”Ÿæˆå¥½çš„æ»šåŠ¨å®¹å™¨æ”¾å…¥é¢æ¿
    panelContainer.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
    panelContainer.appendChild(scrollWrapper);
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤é‡å¤ç‚¹å‡»é—®é¢˜ã€‘çš„ç‰ˆæœ¬æ›¿æ¢ handleUserVote å‡½æ•° â–¼â–¼â–¼
/**
 * å¤„ç†ç”¨æˆ·æŠ•ç¥¨,å¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {string} choice - ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹æ–‡æœ¬
 */
async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœæŠ•ç¥¨ä¸å­˜åœ¨æˆ–å·²å…³é—­,ç›´æ¥è¿”å›
    if (!poll || poll.isClosed) {
        // å¦‚æœæ˜¯å·²å…³é—­çš„æŠ•ç¥¨,åˆ™ç›´æ¥æ˜¾ç¤ºç»“æœ
        if (poll && poll.isClosed) {
            showPollResults(timestamp);
        }
        return;
    }

    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº†å·²ç»æŠ•è¿‡çš„åŒä¸€ä¸ªé€‰é¡¹
    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
    
    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¦‚æœä¸æ˜¯é‡å¤ç‚¹å‡»,æ‰æ‰§è¡ŒæŠ•ç¥¨é€»è¾‘
    if (!isReclickingSameOption) {
        // ç§»é™¤æ—§æŠ•ç¥¨(å¦‚æœç”¨æˆ·æ”¹é€‰)
        for (const option in poll.votes) {
            const voterIndex = poll.votes[option].indexOf(myNickname);
            if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
            }
        }
        // æ·»åŠ æ–°æŠ•ç¥¨
        if (!poll.votes[choice]) {
            poll.votes[choice] = [];
        }
        poll.votes[choice].push(myNickname);
    }
    
    // 4. ã€æ ¸å¿ƒé€»è¾‘ã€‘ç°åœ¨åªå¤„ç†ç”¨æˆ·æŠ•ç¥¨äº‹ä»¶,ä¸å†æ£€æŸ¥æ˜¯å¦ç»“æŸ
    let hiddenMessageContent = null; 
    
    // åªæœ‰åœ¨ç”¨æˆ·çœŸæ­£æŠ•ç¥¨æˆ–æ”¹ç¥¨æ—¶,æ‰ç”Ÿæˆæç¤º
    if (!isReclickingSameOption) {
         hiddenMessageContent = `[ç³»ç»Ÿæç¤º:ç”¨æˆ· (${myNickname}) åˆšåˆšæŠ•ç¥¨ç»™äº† â€œ${choice}â€ã€‚]`;
    }

    // 5. å¦‚æœæœ‰éœ€è¦é€šçŸ¥AIçš„äº‹ä»¶,åˆ™åˆ›å»ºå¹¶æ·»åŠ éšè—æ¶ˆæ¯
    if (hiddenMessageContent) {
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);
    }
    
    // 6. ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId); 
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * ç”¨æˆ·ç»“æŸæŠ•ç¥¨,å¹¶å°†äº‹ä»¶ä½œä¸ºéšè—æ¶ˆæ¯å­˜å…¥å†å²è®°å½•
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("ç»“æŸæŠ•ç¥¨", "ç¡®å®šè¦ç»“æŸè¿™ä¸ªæŠ•ç¥¨å—ï¼Ÿç»“æŸåå°†æ— æ³•å†è¿›è¡ŒæŠ•ç¥¨ã€‚");
    if (confirmed) {
        poll.isClosed = true;

        const resultSummary = poll.options.map(opt => `â€œ${opt}â€(${poll.votes[opt]?.length || 0}ç¥¨)`).join(',');
        const hiddenMessageContent = `[ç³»ç»Ÿæç¤º:ç”¨æˆ·æ‰‹åŠ¨ç»“æŸäº†æŠ•ç¥¨!æœ€ç»ˆç»“æœä¸º:${resultSummary}ã€‚]`;
        
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªä¿å­˜æ•°æ®å’Œæ›´æ–°UI,ä¸è°ƒç”¨ triggerAiResponse()
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ˜¾ç¤ºæŠ•ç¥¨ç»“æœè¯¦æƒ…
 * @param {number} timestamp - æŠ•ç¥¨æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
    
    if (Object.keys(poll.votes).length === 0) {
        resultsHtml += '<p style="color: #8a8a8a;">è¿˜æ²¡æœ‰äººæŠ•ç¥¨ã€‚</p>';
    } else {
        poll.options.forEach(option => {
            const voters = poll.votes[option] || [];
            resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}ç¥¨)</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join('ã€ ') : 'æ— äººæŠ•ç¥¨'}
                    </p>
                </div>
            `;
        });
    }

    showCustomAlert("æŠ•ç¥¨ç»“æœ", resultsHtml);
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“ç®¡ç†åŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€AIå¤´åƒåº“ç®¡ç†æ¨¡æ€æ¡†
 */
function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `â€œ${chat.name}â€çš„å¤´åƒåº“`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
}

/**
 * æ¸²æŸ“AIå¤´åƒåº“çš„å†…å®¹
 */
function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">è¿™ä¸ªå¤´åƒåº“è¿˜æ˜¯ç©ºçš„,ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€å§!</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; // å¤ç”¨è¡¨æƒ…é¢æ¿çš„æ ·å¼
        item.style.backgroundImage = `url(${avatar.url})`;
        item.title = avatar.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block'; // æ€»æ˜¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒ', `ç¡®å®šè¦ä»å¤´åƒåº“ä¸­åˆ é™¤â€œ${avatar.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€å…¨æ–°çš„å‡½æ•°ã€‘,å®Œæ•´æ›¿æ¢æ‰æ—§çš„ addAvatarToLibrary å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ç‰ˆæœ¬ã€‘å‘å½“å‰AIçš„å¤´åƒåº“ä¸­æ·»åŠ æ–°å¤´åƒ(é€šè¿‡æœ¬åœ°ä¸Šä¼ )
 */
async function addAvatarToLibrary() {
    // 1. åƒä»¥å‰ä¸€æ ·,å…ˆè®©ç”¨æˆ·ä¸ºæ–°å¤´åƒå‘½å
    const name = await showCustomPrompt("æ·»åŠ å¤´åƒ", "è¯·ä¸ºè¿™ä¸ªå¤´åƒèµ·ä¸ªåå­—(ä¾‹å¦‚:å¼€å¿ƒã€å“­æ³£)");
    if (!name || !name.trim()) return; // å¦‚æœç”¨æˆ·å–æ¶ˆæˆ–æœªè¾“å…¥,åˆ™é€€å‡º

    // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¸å†å¼¹å‡ºURLè¾“å…¥æ¡†,è€Œæ˜¯åˆ›å»ºä¸€ä¸ªPromiseæ¥ç­‰å¾…ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
    const base64Url = await new Promise(resolve => {
        const fileInput = document.getElementById('ai-avatar-library-upload-input');

        // a. å®šä¹‰ä¸€ä¸ªä¸€æ¬¡æ€§çš„äº‹ä»¶å¤„ç†å™¨
        const changeHandler = (event) => {
            const file = event.target.files[0];
            if (file) {
                // b. å¦‚æœç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶,å°±ç”¨FileReaderè¯»å–å®ƒ
                const reader = new FileReader();
                reader.onload = (readEvent) => {
                    resolve(readEvent.target.result); // c. è¯»å–æˆåŠŸå,ç”¨Base64ç»“æœå…‘ç°Promise
                };
                reader.onerror = () => {
                    resolve(null); // è¯»å–å¤±è´¥
                };
                reader.readAsDataURL(file);
            } else {
                resolve(null); // ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©
            }
            
            // d. ä»»åŠ¡å®Œæˆ,æ¸…ç†å·¥ä½œ:ç§»é™¤ç›‘å¬å™¨å¹¶æ¸…ç©ºè¾“å…¥æ¡†
            fileInput.removeEventListener('change', changeHandler);
            fileInput.value = '';
        };

        // e. ç»‘å®šè¿™ä¸ªä¸€æ¬¡æ€§çš„å¤„ç†å™¨,å¹¶è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
        fileInput.addEventListener('change', changeHandler);
        fileInput.click();
    });

    // 3. æ£€æŸ¥æ–‡ä»¶è¯»å–ç»“æœ
    if (!base64Url) {
        alert("æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶æˆ–æ–‡ä»¶è¯»å–å¤±è´¥ã€‚");
        return;
    }
    
    // 4. åç»­çš„ä¿å­˜é€»è¾‘ä¿æŒä¸å˜,åªæ˜¯ç°åœ¨ä¿å­˜çš„æ˜¯Base64æ ¼å¼çš„URL
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: base64Url });
    await db.chats.put(chat);
    renderAiAvatarLibrary(); // åˆ·æ–°å¤´åƒåº“åˆ—è¡¨,æ˜¾ç¤ºæ–°å¤´åƒ
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™ä¸¤ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å°†ä¿å­˜çš„å›¾æ ‡URLåº”ç”¨åˆ°ä¸»å±å¹•çš„Appå›¾æ ‡ä¸Š
 */
function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
        const imgElement = document.getElementById(`icon-img-${iconId}`);
        if (imgElement) {
            imgElement.src = state.globalSettings.appIcons[iconId];
        }
    }
}

        /**
         * ã€å…¨æ–°é‡æ„ç‰ˆã€‘åœ¨å¤–è§‚è®¾ç½®é¡µé¢æ¸²æŸ“å‡ºæ‰€æœ‰Appå›¾æ ‡çš„è®¾ç½®é¡¹
         */
        function renderIconSettings() {
            const grid = document.getElementById('icon-settings-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const appLabels = {
                'world-book': 'ä¸–ç•Œä¹¦', 'qq': 'QQ',
                'api-settings': 'APIè®¾ç½®', 'wallpaper': 'å¤–è§‚è®¾ç½®'
            };

            for (const iconId in state.globalSettings.appIcons) {
                const iconUrl = state.globalSettings.appIcons[iconId];
                const labelText = appLabels[iconId] || 'æœªçŸ¥App';

                const item = document.createElement('div');
                item.className = 'icon-setting-item';
                item.dataset.iconId = iconId; // å°†IDå­˜åœ¨çˆ¶å…ƒç´ ä¸Š

                item.innerHTML = `
                    <div class="icon-preview-wrapper">
                        <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                        <span class="label">${labelText}</span>
                    </div>
                    <div class="icon-action-buttons">
                        <button class="icon-btn icon-upload-btn">ä¸Šä¼ </button>
                        <button class="icon-btn icon-url-btn">URL</button>
                    </div>
                `;
                grid.appendChild(item);
            }
        }

// â–¼â–¼â–¼ ç”¨è¿™å—ã€æœ€ç»ˆç¡®è®¤ç‰ˆã€‘çš„ä»£ç ,æ›¿æ¢æ—§çš„ openBrowser å’Œ closeBrowser å‡½æ•° â–¼â–¼â–¼

/**
 * å½“ç”¨æˆ·ç‚¹å‡»é“¾æ¥å¡ç‰‡æ—¶,æ‰“å¼€ä¼ªæµè§ˆå™¨
 * @param {number} timestamp - è¢«ç‚¹å‡»æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    // å®‰å…¨æ£€æŸ¥,ç¡®ä¿ chat å’Œ history éƒ½å­˜åœ¨
    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
        console.error("æ— æ³•æ‰¾åˆ°æˆ–æ¶ˆæ¯ç±»å‹ä¸åŒ¹é…çš„åˆ†äº«é“¾æ¥:", timestamp);
        return; // å¦‚æœæ‰¾ä¸åˆ°æ¶ˆæ¯,å°±ç›´æ¥é€€å‡º
    }

    // å¡«å……æµè§ˆå™¨å†…å®¹
    document.getElementById('browser-title').textContent = message.source_name || 'æ–‡ç« è¯¦æƒ…';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
        <h1 class="article-title">${message.title || 'æ— æ ‡é¢˜'}</h1>
        <div class="article-meta">
            <span>æ¥æº: ${message.source_name || 'æœªçŸ¥'}</span>
        </div>
        <div class="article-body">
            <p>${(message.content || 'å†…å®¹ä¸ºç©ºã€‚').replace(/\n/g, '</p><p>')}</p>
        </div>
    `;

    // æ˜¾ç¤ºæµè§ˆå™¨å±å¹•
    showScreen('browser-screen');
}

/**
 * å…³é—­ä¼ªæµè§ˆå™¨,è¿”å›èŠå¤©ç•Œé¢
 * (è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± init() ä¸­çš„äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨)
 */
function closeBrowser() {
    showScreen('chat-interface-screen'); 
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·åˆ†äº«é“¾æ¥åŠŸèƒ½çš„æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€è®©ç”¨æˆ·å¡«å†™é“¾æ¥ä¿¡æ¯çš„æ¨¡æ€æ¡†
 */
function openShareLinkModal() {
    if (!state.activeChatId) return;

    // æ¸…ç©ºä¸Šæ¬¡è¾“å…¥çš„å†…å®¹
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('share-link-modal').classList.add('visible');
}

/**
 * ç”¨æˆ·ç¡®è®¤åˆ†äº«,åˆ›å»ºå¹¶å‘é€é“¾æ¥å¡ç‰‡æ¶ˆæ¯
 */
async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
        alert("æ ‡é¢˜æ˜¯å¿…å¡«é¡¹å“¦!");
        return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];
    
    // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
    const linkMessage = {
        role: 'user', // è§’è‰²æ˜¯ 'user'
        type: 'share_link',
        timestamp: Date.now(),
        title: title,
        description: description,
        source_name: sourceName,
        content: content,
        // ç”¨æˆ·åˆ†äº«çš„é“¾æ¥,æˆ‘ä»¬ä¸æä¾›å›¾ç‰‡,è®©å®ƒæ€»æ˜¯æ˜¾ç¤ºå ä½å›¾
        thumbnail_url: null 
    };

    // å°†æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•
    chat.history.push(linkMessage);
    await db.chats.put(chat);

    // æ¸²æŸ“æ–°æ¶ˆæ¯å¹¶æ›´æ–°åˆ—è¡¨
    appendMessage(linkMessage, chat);
    renderChatList();

    // å…³é—­æ¨¡æ€æ¡†
    document.getElementById('share-link-modal').classList.remove('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * æ ¹æ®AIçš„è§†è§’,è¿‡æ»¤å‡ºå®ƒèƒ½çœ‹åˆ°çš„åŠ¨æ€
 * @param {Array} allPosts - æ‰€æœ‰å¾…æ£€æŸ¥çš„åŠ¨æ€å¸–å­
 * @param {object} viewerChat - æ­£åœ¨â€œçœ‹â€åŠ¨æ€çš„é‚£ä¸ªAIçš„chatå¯¹è±¡
 * @returns {Array} - è¿‡æ»¤åè¯¥AIå¯è§çš„åŠ¨æ€å¸–å­
 */
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; // å®‰å…¨æ£€æŸ¥

    const viewerGroupId = viewerChat.groupId; // æŸ¥çœ‹è€…æ‰€åœ¨çš„åˆ†ç»„ID

    return allPosts.filter(post => {
        // è§„åˆ™1:å¦‚æœæ˜¯ç”¨æˆ·å‘çš„åŠ¨æ€
        if (post.authorId === 'user') {
            // å¦‚æœç”¨æˆ·è®¾ç½®äº†â€œéƒ¨åˆ†å¯è§â€
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // åªæœ‰å½“æŸ¥çœ‹è€…AIçš„åˆ†ç»„IDåœ¨ç”¨æˆ·çš„å¯è§åˆ—è¡¨é‡Œæ—¶,æ‰å¯è§
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // å¦‚æœç”¨æˆ·æ²¡è®¾ç½®,è¯´æ˜æ˜¯å…¬å¼€çš„,æ‰€æœ‰AIéƒ½å¯è§
            return true;
        }

        // è§„åˆ™2:å¦‚æœæ˜¯å…¶ä»–AIå‘çš„åŠ¨æ€
        const authorGroupId = post.authorGroupId; // å‘å¸–AIæ‰€åœ¨çš„åˆ†ç»„ID
        
        // å¦‚æœå‘å¸–çš„AIæ²¡æœ‰åˆ†ç»„,é‚£å®ƒçš„åŠ¨æ€å°±æ˜¯å…¬å¼€çš„
        if (!authorGroupId) {
            return true;
        }

        // å¦‚æœå‘å¸–çš„AIæœ‰åˆ†ç»„,é‚£ä¹ˆåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†ç»„çš„AIæ‰èƒ½çœ‹åˆ°
        return authorGroupId === viewerGroupId;
    });
}

/**
 * åº”ç”¨æŒ‡å®šçš„ä¸»é¢˜('light' æˆ– 'dark')
 * @param {string} theme - è¦åº”ç”¨çš„ä¸»é¢˜åç§°
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // å¦‚æœå¼€å…³å­˜åœ¨,å°±åŒæ­¥å®ƒçš„çŠ¶æ€
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    localStorage.setItem('ephone-theme', theme);
}

/**
 * åˆ‡æ¢å½“å‰çš„ä¸»é¢˜
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // ç›´æ¥æ ¹æ®å¼€å…³çš„é€‰ä¸­çŠ¶æ€æ¥å†³å®šæ–°ä¸»é¢˜
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}

// â–¼â–¼â–¼ è¯·å°†è¿™ã€ä¸€æ•´å—æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

function startReplyToMessage() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    // 1. ã€æ ¸å¿ƒä¿®æ­£ã€‘åŒæ—¶è·å–â€œå®Œæ•´å†…å®¹â€å’Œâ€œé¢„è§ˆç‰‡æ®µâ€
    const fullContent = String(message.content || '');
    let previewSnippet = '';

    if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
        previewSnippet = '[è¡¨æƒ…]';
    } else if (message.type === 'ai_image' || message.type === 'user_photo') {
        previewSnippet = '[å›¾ç‰‡]';
    } else if (message.type === 'voice_message') {
        previewSnippet = '[è¯­éŸ³]';
    } else {
        // é¢„è§ˆç‰‡æ®µä¾ç„¶æˆªæ–­,ä½†åªç”¨äºUIæ˜¾ç¤º
        previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
    }
    
    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘å°†â€œå®Œæ•´å†…å®¹â€å­˜å…¥ä¸Šä¸‹æ–‡,ä»¥å¤‡å‘é€æ—¶ä½¿ç”¨
    currentReplyContext = {
        timestamp: message.timestamp,
        senderName: message.senderName || (message.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : chat.name),
        content: fullContent, // <--- è¿™é‡Œå­˜çš„æ˜¯å®Œæ•´çš„åŸæ–‡!
    };

    // 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘ä»…åœ¨æ›´æ–°â€œå›å¤é¢„è§ˆæ â€æ—¶,æ‰ä½¿ç”¨â€œé¢„è§ˆç‰‡æ®µâ€
    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.querySelector('.sender').textContent = `å›å¤ ${currentReplyContext.senderName}:`;
    previewBar.querySelector('.text').textContent = previewSnippet; // <--- è¿™é‡Œç”¨çš„æ˜¯ç¼©ç•¥ç‰ˆ!
    previewBar.style.display = 'block';

    // 4. åç»­æ“ä½œä¿æŒä¸å˜
    hideMessageActions();
    document.getElementById('chat-input').focus();
}

/**
 * ã€å…¨æ–°ã€‘å–æ¶ˆå¼•ç”¨æ¨¡å¼
 */
function cancelReplyMode() {
    currentReplyContext = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

/**
 * åœ¨æ¸¸æˆå†…èŠå¤©æ¡†æ·»åŠ æ¶ˆæ¯
 */
function addMessageToAutoChessChat(role, text) {
    const messagesEl = document.getElementById('auto-chess-messages');
    const msgWrapper = document.createElement('div');
    const bubble = document.createElement('div');
    
    if (role === 'system') {
        msgWrapper.className = 'message-wrapper system-pat';
        bubble.className = 'message-bubble system-bubble';
        bubble.textContent = text;
    } else {
        msgWrapper.className = `message-wrapper ${role === 'user' ? 'user' : 'ai'}`;
        bubble.className = `message-bubble ${role === 'user' ? 'user' : 'ai'}`;
        const chat = state.chats[state.activeChatId];
        const avatarSrc = role === 'user' ? (chat.settings.myAvatar || defaultAvatar) : (chat.settings.aiAvatar || defaultAvatar);
        // ä½¿ç”¨æ­£ç¡®çš„å¤´åƒæ¡†åŒ…è£¹
        bubble.innerHTML = `
            <div class="avatar-frame-wrapper">
                <img src="${avatarSrc}" class="avatar-img">
            </div>
            <div class="content">${text}</div>
        `;
    }
    
    msgWrapper.appendChild(bubble);
    messagesEl.appendChild(msgWrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// â–¼â–¼â–¼ ç¬¬4.2æ­¥:ç”¨è¿™æ•´å—ã€å…¨æ–°é‡æ„ç‰ˆã€‘ä»£ç ,æ›¿æ¢ä» renderMemoriesScreen åˆ° handleAnniversaryAvatarUpload çš„æ‰€æœ‰æ—§å‡½æ•° â–¼â–¼â–¼

// === ã€å…¨æ–°é‡æ„ç‰ˆã€‘çºªå¿µæ—¥ä¸æ—¥å†åŠŸèƒ½æ ¸å¿ƒå‡½æ•° ===
let currentCalendarDate = new Date();

/**
 * ã€ä¸»æ¸²æŸ“å‡½æ•°ã€‘æ¸²æŸ“æ•´ä¸ªçºªå¿µæ—¥/æ—¥å†é¡µé¢
 */
async function renderMemoriesScreen() {
    // 1. å¡«å……AIåˆ‡æ¢å™¨
    const switcher = document.getElementById('memories-ai-switcher');
    switcher.innerHTML = '';
    const aiChats = Object.values(state.chats).filter(c => !c.isGroup);

    if (aiChats.length === 0) {
        // å¦‚æœæ²¡æœ‰AI,æ˜¾ç¤ºæç¤ºä¿¡æ¯
        document.getElementById('memories-list').innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¯·å…ˆåˆ›å»ºè‡³å°‘ä¸€ä¸ªAIè§’è‰²</p>';
        const option = document.createElement('option');
        option.textContent = 'æš‚æ— è§’è‰²';
        switcher.appendChild(option);
        return;
    }

    aiChats.forEach(chat => {
        const option = document.createElement('option');
        option.value = chat.id;
        option.textContent = `ä¸ ${chat.name} çš„æ—¥å­`;
        switcher.appendChild(option);
    });

    // 2. ç¡®å®šå½“å‰è¦æ˜¾ç¤ºçš„AI
    if (!currentMemoriesViewChatId || !state.chats[currentMemoriesViewChatId]) {
        currentMemoriesViewChatId = aiChats[0].id; // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ª
    }
    switcher.value = currentMemoriesViewChatId;

    // 3. æ ¹æ®å½“å‰é€‰ä¸­çš„AI,æ¸²æŸ“é¡µé¢å†…å®¹
    const chat = state.chats[currentMemoriesViewChatId];
    if (!chat) return;

    document.getElementById('anniversary-my-avatar').src = chat.settings.myAvatar || defaultAvatar;
    document.getElementById('anniversary-ai-avatar').src = chat.settings.aiAvatar || defaultAvatar;
    
    await renderAnniversaryCounter(currentMemoriesViewChatId);
    await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
}

/**
 * æ¸²æŸ“æŒ‡å®šAIçš„çºªå¿µæ—¥è®¡æ•°å™¨
 * @param {string} chatId 
 */
function renderAnniversaryCounter(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const startDateStr = chat.settings.anniversaryStartDate;
    const daysEl = document.getElementById('anniversary-days');
    const dateEl = document.getElementById('anniversary-start-date');

    if (startDateStr) {
        const startDate = new Date(startDateStr);
        const now = new Date();
        const startDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const diffTime = Math.abs(today - startDay);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        daysEl.textContent = diffDays;
        dateEl.textContent = `å§‹äº ${startDate.getFullYear()}.${String(startDate.getMonth() + 1).padStart(2, '0')}.${String(startDate.getDate()).padStart(2, '0')}`;
    } else {
        daysEl.textContent = '0';
        dateEl.textContent = 'ç‚¹å‡»å¤©æ•°æˆ–æ—¥æœŸè®¾ç½®èµ·å§‹æ—¥';
    }
}

/**
 * æ¸²æŸ“æŒ‡å®šAIçš„æ—¥å†
 * @param {number} year 
 * @param {number} month (0-11)
 */
async function renderCalendar(year, month) {
    const grid = document.getElementById('calendar-grid');
    const monthYearEl = document.getElementById('calendar-month-year');
    grid.innerHTML = '';
    monthYearEl.textContent = `${year} å¹´ ${month + 1} æœˆ`;
    currentCalendarDate.setFullYear(year, month, 1);

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const eventsThisMonth = await db.calendarEvents
        .where({ chatId: currentMemoriesViewChatId })
        .filter(event => {
            const eventDate = new Date(event.date);
            return eventDate.getFullYear() === year && eventDate.getMonth() === month;
        })
        .toArray();
    
    const eventDays = new Set(eventsThisMonth.map(e => new Date(e.date).getDate()));

    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += `<div class="calendar-day empty"></div>`;
    }
    const today = new Date();
    for (let i = 1; i <= daysInMonth; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = i;
        dayEl.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        if (i === today.getDate() && year === today.getFullYear() && month === today.getMonth()) {
            dayEl.classList.add('today');
        }
        if (eventDays.has(i)) {
            dayEl.classList.add('has-event');
        }
        grid.appendChild(dayEl);
    }
}

/**
 * æ‰“å¼€äº‹ä»¶ç¼–è¾‘å™¨,å¯ç”¨äºæ–°å»ºæˆ–ç¼–è¾‘
 * @param {string} dateString
 * @param {object} [eventToEdit=null]
 */
async function openEventEditor(dateString, eventToEdit = null) {
    const modal = document.getElementById('calendar-event-modal');
    const titleEl = document.getElementById('event-modal-title');
    const titleInput = document.getElementById('event-title-input');
    const memoTextarea = document.getElementById('event-memo-textarea');
    const deleteBtn = document.getElementById('delete-event-btn');
    const creatorInfo = document.getElementById('event-creator-info');
    const saveBtn = document.getElementById('save-event-btn');

    modal.dataset.date = dateString;
    titleEl.textContent = eventToEdit ? `ç¼–è¾‘å¤‡å¿˜ - ${dateString}` : `æ–°å»ºå¤‡å¿˜ - ${dateString}`;
    
    if (eventToEdit) {
        titleInput.value = eventToEdit.title;
        memoTextarea.value = eventToEdit.memo;
        deleteBtn.style.display = 'block';
        creatorInfo.textContent = `ç”± ${eventToEdit.createdBy === 'user' ? 'ä½ ' : state.chats[eventToEdit.chatId].name} åˆ›å»º`;
        creatorInfo.style.display = 'block';
        modal.dataset.eventId = eventToEdit.id;
    } else {
        titleInput.value = '';
        memoTextarea.value = '';
        deleteBtn.style.display = 'none';
        creatorInfo.style.display = 'none';
        delete modal.dataset.eventId;
    }
    
    titleInput.readOnly = false;
    memoTextarea.readOnly = false;
    saveBtn.style.display = 'block';

    modal.classList.add('visible');
}

/**
 * ä¿å­˜æ—¥å†äº‹ä»¶(å…¼å®¹æ–°å»ºä¸ç¼–è¾‘)
 */
async function saveCalendarEvent() {
    const modal = document.getElementById('calendar-event-modal');
    const date = modal.dataset.date;
    const eventId = modal.dataset.eventId ? parseInt(modal.dataset.eventId) : null;
    const title = document.getElementById('event-title-input').value.trim();
    const memo = document.getElementById('event-memo-textarea').value.trim();
    const chatId = currentMemoriesViewChatId;

    if (!chatId || !title) {
        alert(chatId ? 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º!' : 'æ— æ³•ç¡®å®šå½“å‰æ“ä½œçš„è§’è‰²ã€‚');
        return;
    }

    const eventData = { chatId, date, title, memo, createdBy: 'user' };
    if (eventId) {
        await db.calendarEvents.update(eventId, { title, memo });
    } else {
        await db.calendarEvents.add(eventData);
    }
    
    modal.classList.remove('visible');
    await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
}

/**
 * åˆ é™¤å¤‡å¿˜å½•
 */
async function deleteCalendarEvent() {
    const modal = document.getElementById('calendar-event-modal');
    const eventId = modal.dataset.eventId ? parseInt(modal.dataset.eventId) : null;
    if (!eventId) return;
    const confirmed = await showCustomConfirm('åˆ é™¤å¤‡å¿˜', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å½•å—ï¼Ÿ');
    if (confirmed) {
        await db.calendarEvents.delete(eventId);
        modal.classList.remove('visible');
        await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
    }
}

/**
 * å¼¹å‡ºæ—¥æœŸé€‰æ‹©æ¡†è®¾ç½®èµ·å§‹æ—¥
 */
async function promptForAnniversaryDate() {
    const chat = state.chats[currentMemoriesViewChatId];
    if (!chat) return;
    const currentDate = chat.settings.anniversaryStartDate || new Date().toISOString().split('T')[0];
    const newDateStr = await showCustomPrompt('è®¾ç½®çºªå¿µèµ·å§‹æ—¥', '', currentDate, 'date');
    if (newDateStr) {
        chat.settings.anniversaryStartDate = newDateStr;
        await db.chats.put(chat);
        renderAnniversaryCounter(currentMemoriesViewChatId);
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤´åƒæ¡†åº“æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

/**
 * æ‰“å¼€å¤´åƒæ¡†åº“æ¨¡æ€æ¡†
 */
function openAvatarFrameLibrary() {
    renderAvatarFrameLibrary();
    document.getElementById('avatar-frame-library-modal').classList.add('visible');
}

/**
 * å…³é—­å¤´åƒæ¡†åº“æ¨¡æ€æ¡†
 */
function closeAvatarFrameLibrary() {
    document.getElementById('avatar-frame-library-modal').classList.remove('visible');
}

// â–¼â–¼â–¼ ã€ä¿®æ”¹ç‰ˆã€‘æ¸²æŸ“å¤´åƒæ¡†åº“ï¼Œä½¿å…¶èƒ½ä¸æ–°ç¼–è¾‘å™¨äº¤äº’ â–¼â–¼â–¼
async function renderAvatarFrameLibrary() {
    const grid = document.getElementById('avatar-frame-library-grid');
    grid.innerHTML = '';
    const frames = await db.avatarFrames.toArray();
    state.avatarFrames = frames; 

    if (frames.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">å¤´åƒæ¡†åº“æ˜¯ç©ºçš„,ç‚¹å‡»â€œæ·»åŠ â€ä¸Šä¼ å§!</p>';
        return;
    }

    frames.forEach(frame => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; 
        item.style.cursor = 'pointer';
        item.title = frame.name;
        
        item.innerHTML = `
            <div class="avatar-frame-wrapper" style="width: 100%; height: 100%;">
                <img src="${defaultAvatar}" class="avatar-img" style="border-radius: 18px;">
                <img src="${frame.url}" class="avatar-frame-overlay">
            </div>
        `;

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç‚¹å‡»äº‹ä»¶ç°åœ¨ä¼šæ£€æŸ¥ä¸Šä¸‹æ–‡
        item.addEventListener('click', () => {
            // å¦‚æœæ˜¯ä»å¤´åƒç¼–è¾‘å™¨æ‰“å¼€çš„
            if (avatarEditorContext.target) {
                avatarEditorContext.newFrameSrc = frame.url; // æ›´æ–°ä¸´æ—¶çŠ¶æ€
                const framePreview = document.getElementById(`${avatarEditorContext.target}-editor-preview-frame`);
                framePreview.src = frame.url;
                framePreview.style.display = 'block';
                closeAvatarFrameLibrary(); // åªå…³é—­åº“ï¼Œä¸å…³é—­ç¼–è¾‘å™¨
            } else {
                // å¦åˆ™ï¼Œæ‰§è¡Œæ—§çš„åº”ç”¨é€»è¾‘ï¼ˆç°åœ¨æˆ‘ä»¬ä¸å†ä½¿ç”¨è¿™ä¸ªæµç¨‹ï¼Œä½†ä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰
                applyAvatarFrame(frame.url);
            }
        });
        
        addLongPressListener(item, async () => {
            const confirmed = await showCustomConfirm('åˆ é™¤å¤´åƒæ¡†', `ç¡®å®šè¦åˆ é™¤å¤´åƒæ¡†â€œ${frame.name}â€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.avatarFrames.delete(frame.id);
                renderAvatarFrameLibrary();
            }
        });
        
        grid.appendChild(item);
    });
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ‰¹é‡æ·»åŠ å¤´åƒæ¡†(ä»æœ¬åœ°æ–‡ä»¶)
 */
async function addAvatarFrames() {
    // 1. åˆ›å»ºä¸€ä¸ªPromiseæ¥ç­‰å¾…ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
    const files = await new Promise(resolve => {
        const fileInput = document.getElementById('avatar-frame-upload-input');
        const changeHandler = (event) => {
            resolve(event.target.files);
            fileInput.removeEventListener('change', changeHandler);
            fileInput.value = '';
        };
        fileInput.addEventListener('change', changeHandler);
        fileInput.click();
    });

    if (!files || files.length === 0) return;

    const newFrames = [];
    // 2. éå†æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
    for (const file of files) {
        // a. è¯»å–æ–‡ä»¶ä¸ºBase64
        const base64Url = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
        
        // b. è®©ç”¨æˆ·ä¸ºæ¯ä¸ªæ–‡ä»¶å‘½å
        const defaultName = file.name.replace(/\.[^/.]+$/, ""); // ç§»é™¤æ‰©å±•å
        const name = await showCustomPrompt(`ä¸ºå¤´åƒæ¡†å‘½å`, `è¯·è¾“å…¥ "${defaultName}" çš„åç§°`, defaultName);
        if (!name || !name.trim()) continue; // å¦‚æœç”¨æˆ·å–æ¶ˆæˆ–è¾“å…¥ä¸ºç©º,åˆ™è·³è¿‡è¿™ä¸ªæ–‡ä»¶

        newFrames.push({
            id: 'frame_' + (Date.now() + newFrames.length),
            name: name.trim(),
            url: base64Url
        });
    }

    // 3. æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“å¹¶åˆ·æ–°
    if (newFrames.length > 0) {
        await db.avatarFrames.bulkAdd(newFrames);
        renderAvatarFrameLibrary();
        alert(`æˆåŠŸæ·»åŠ äº† ${newFrames.length} ä¸ªæ–°å¤´åƒæ¡†!`);
    }
}

// â–¼â–¼â–¼ ã€å…¨æ–°ç®€æ´ç‰ˆã€‘è¯·ç”¨æ­¤å‡½æ•°å®Œæ•´æ›¿æ¢æ—§çš„ applyAvatarFrame å‡½æ•° â–¼â–¼â–¼
/**
 * ã€V3ç‰ˆã€‘æ‰“å¼€å¹¶å¡«å……å…¨æ–°çš„ã€å¯è§†åŒ–çš„å¤´åƒæ¡†åº”ç”¨å¼¹çª—
 * @param {string} frameUrl - è¢«é€‰ä¸­çš„å¤´åƒæ¡†URL
 */
async function applyAvatarFrame(frameUrl) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 1. è·å–æ¨¡æ€æ¡†å’Œæ‰€æœ‰éœ€è¦å¡«å……çš„å…ƒç´ 
    const modal = document.getElementById('avatar-frame-apply-modal');
    
    const meAvatarImg = document.querySelector('#frame-apply-preview-me .avatar-img');
    const meFrameOverlay = document.querySelector('#frame-apply-preview-me .avatar-frame-overlay');
    
    const aiAvatarImg = document.querySelector('#frame-apply-preview-ai .avatar-img');
    const aiFrameOverlay = document.querySelector('#frame-apply-preview-ai .avatar-frame-overlay');
    
    // 2. å¡«å……é¢„è§ˆåŒºçš„å¤´åƒ (ä»å½“å‰èŠå¤©è®¾ç½®ä¸­è¯»å–)
    meAvatarImg.src = chat.settings.myAvatar || defaultAvatar;
    aiAvatarImg.src = chat.settings.aiAvatar || defaultAvatar;
    
    // 3. å°†ç”¨æˆ·é€‰æ‹©çš„å¤´åƒæ¡†URLåº”ç”¨åˆ°ä¸¤ä¸ªé¢„è§ˆä¸Š
    meFrameOverlay.src = frameUrl;
    aiFrameOverlay.src = frameUrl;
    
    // 4. ã€å…³é”®ã€‘å°† frameUrl å­˜å‚¨åœ¨æ¨¡æ€æ¡†çš„ä¸»DIVä¸Š,ä»¥ä¾¿äº‹ä»¶å¤„ç†å™¨èƒ½è·å–åˆ°
    modal.dataset.frameUrl = frameUrl;
    
    // 5. æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.classList.add('visible');
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬2.1æ­¥:å°†è¿™ä¸ªã€æ–°å‡½æ•°ã€‘ç²˜è´´åˆ°æ‚¨çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼
/**
 * ã€å…¨æ–°ã€‘å¼¹å‡ºæ—¥æœŸé€‰æ‹©æ¡†,è®©ç”¨æˆ·è®¾ç½®çºªå¿µèµ·å§‹æ—¥
 */
async function promptForAnniversaryDate() {
    const currentDate = state.globalSettings.anniversaryStartDate || new Date().toISOString().split('T')[0];
    const newDateStr = await showCustomPrompt(
        'è®¾ç½®çºªå¿µèµ·å§‹æ—¥', 
        '', 
        currentDate, 
        'date'
    );
    if (newDateStr) {
        state.globalSettings.anniversaryStartDate = newDateStr;
        await db.globalSettings.put(state.globalSettings);
        renderAnniversaryCounter(); // å®æ—¶æ›´æ–°å¤©æ•°
    }
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç”¨æˆ·å¤„ç†è½¬è´¦çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•° â–¼â–¼â–¼

let activeTransferTimestamp = null; // ç”¨äºæš‚å­˜è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³

/**
 * æ˜¾ç¤ºå¤„ç†è½¬è´¦çš„æ“ä½œèœå•
 * @param {number} timestamp - è¢«ç‚¹å‡»çš„è½¬è´¦æ¶ˆæ¯çš„æ—¶é—´æˆ³
 */
function showTransferActionModal(timestamp) {
    activeTransferTimestamp = timestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (message) {
        // å°†AIçš„åå­—å¡«å…¥å¼¹çª—
        document.getElementById('transfer-sender-name').textContent = message.senderName;
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
}

/**
 * éšè—å¤„ç†è½¬è´¦çš„æ“ä½œèœå•
 */
function hideTransferActionModal() {
    document.getElementById('transfer-actions-modal').classList.remove('visible');
    activeTransferTimestamp = null;
}

/**
 * å¤„ç†ç”¨æˆ·æ¥å—æˆ–æ‹’ç»è½¬è´¦çš„é€»è¾‘
 * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹©, 'accepted' æˆ– 'declined'
 */
async function handleUserTransferResponse(choice) {
    if (!activeTransferTimestamp) return;

    const timestamp = activeTransferTimestamp;
    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    // 1. æ›´æ–°åŸå§‹è½¬è´¦æ¶ˆæ¯çš„çŠ¶æ€
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;

    let systemContent;

    // 2. å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ‹’ç»â€
    if (choice === 'declined') {
        // ç«‹åˆ»åœ¨å‰ç«¯ç”Ÿæˆä¸€ä¸ªâ€œé€€æ¬¾â€å¡ç‰‡,è®©ç”¨æˆ·çœ‹åˆ°
        const refundMessage = {
            role: 'user',
            type: 'transfer',
            isRefund: true, // è¿™æ˜¯ä¸€ä¸ªå…³é”®æ ‡è®°,ç”¨äºUIæ˜¾ç¤ºè¿™æ˜¯é€€æ¬¾
            amount: originalMessage.amount,
            note: 'å·²æ‹’æ”¶å¯¹æ–¹è½¬è´¦',
            timestamp: Date.now()
        };
        chat.history.push(refundMessage);
        
        // å‡†å¤‡ä¸€æ¡å¯¹AIå¯è§çš„éšè—æ¶ˆæ¯,å‘Šè¯‰å®ƒå‘ç”Ÿäº†ä»€ä¹ˆ
        systemContent = `[ç³»ç»Ÿæç¤º:ä½ æ‹’ç»å¹¶é€€è¿˜äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
    } else { // å¦‚æœç”¨æˆ·é€‰æ‹©â€œæ¥å—â€
        // åªéœ€å‡†å¤‡éšè—æ¶ˆæ¯é€šçŸ¥AIå³å¯
        systemContent = `[ç³»ç»Ÿæç¤º:ä½ æ¥å—äº†â€œ${originalMessage.senderName}â€çš„è½¬è´¦ã€‚]`;
    }

    // 3. åˆ›å»ºè¿™æ¡å¯¹ç”¨æˆ·éšè—ã€ä½†å¯¹AIå¯è§çš„ç³»ç»Ÿæ¶ˆæ¯
    const hiddenMessage = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now() + 1, // ä¿è¯æ—¶é—´æˆ³åœ¨é€€æ¬¾æ¶ˆæ¯ä¹‹å
        isHidden: true // è¿™ä¸ªæ ‡è®°ä¼šè®©å®ƒä¸åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤º
    };
    chat.history.push(hiddenMessage);

    // 4. ä¿å­˜æ‰€æœ‰æ›´æ”¹åˆ°æ•°æ®åº“,å¹¶åˆ·æ–°ç•Œé¢
    await db.chats.put(chat);
    hideTransferActionModal(); 
    renderChatInterface(state.activeChatId);
    renderChatList();
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘é€šè¯è®°å½•åŠŸèƒ½æ ¸å¿ƒå‡½æ•° â–¼â–¼â–¼

async function renderCallHistoryScreen() {
    showScreen('call-history-screen'); // <--ã€æ ¸å¿ƒä¿®æ­£ã€‘æŠŠå®ƒç§»åŠ¨åˆ°æœ€å‰é¢!

    const listEl = document.getElementById('call-history-list');
    const titleEl = document.getElementById('call-history-title');
    listEl.innerHTML = '';
    titleEl.textContent = 'æ‰€æœ‰é€šè¯è®°å½•';
    
    const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
    
    if (records.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">è¿™é‡Œè¿˜æ²¡æœ‰é€šè¯è®°å½•å“¦~</p>';
        return; // ç°åœ¨çš„ return å°±æ²¡é—®é¢˜äº†,å› ä¸ºå®ƒåªè·³è¿‡äº†åç»­çš„æ¸²æŸ“é€»è¾‘
    }
    
    records.forEach(record => {
        const card = createCallRecordCard(record);

    addLongPressListener(card, async () => {
        // 1. å¼¹å‡ºè¾“å…¥æ¡†,å¹¶å°†æ—§åç§°ä½œä¸ºé»˜è®¤å€¼,æ–¹ä¾¿ä¿®æ”¹
        const newName = await showCustomPrompt(
            "è‡ªå®šä¹‰é€šè¯åç§°", 
            "è¯·è¾“å…¥æ–°çš„åç§°(ç•™ç©ºåˆ™æ¢å¤é»˜è®¤)",
            record.customName || '' // å¦‚æœå·²æœ‰è‡ªå®šä¹‰åç§°,å°±æ˜¾ç¤ºå®ƒ
        );

        // 2. å¦‚æœç”¨æˆ·ç‚¹å‡»äº†â€œå–æ¶ˆâ€,åˆ™ä»€ä¹ˆéƒ½ä¸åš
        if (newName === null) return;
        
        // 3. æ›´æ–°æ•°æ®åº“ä¸­çš„è¿™æ¡è®°å½•
        await db.callRecords.update(record.id, { customName: newName.trim() });
        
        // 4. åˆ·æ–°æ•´ä¸ªåˆ—è¡¨,è®©æ›´æ”¹ç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥
        await renderCallHistoryScreen();
        
        // 5. ç»™ç”¨æˆ·ä¸€ä¸ªæˆåŠŸçš„æç¤º
        await showCustomAlert('æˆåŠŸ', 'é€šè¯åç§°å·²æ›´æ–°!');
    });
        listEl.appendChild(card);
    });    
}

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å‡çº§ç‰ˆã€‘å‡½æ•°,å®Œæ•´æ›¿æ¢ä½ æ—§çš„ createCallRecordCard å‡½æ•° â–¼â–¼â–¼
/**
 * ã€å‡çº§ç‰ˆã€‘æ ¹æ®å•æ¡è®°å½•æ•°æ®,åˆ›å»ºä¸€å¼ èƒ½æ˜¾ç¤ºèŠå¤©å¯¹è±¡çš„é€šè¯å¡ç‰‡
 * @param {object} record - ä¸€æ¡é€šè¯è®°å½•å¯¹è±¡
 * @returns {HTMLElement} - åˆ›å»ºå¥½çš„å¡ç‰‡div
 */
function createCallRecordCard(record) {
    const card = document.createElement('div');
    card.className = 'call-record-card';
    card.dataset.recordId = record.id; 

    // è·å–é€šè¯å¯¹è±¡çš„åå­—
    const chatInfo = state.chats[record.chatId];
    const chatName = chatInfo ? chatInfo.name : 'æœªçŸ¥ä¼šè¯';

    const callDate = new Date(record.timestamp);
    const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
    const durationText = `${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’`;

    const avatarsHtml = record.participants.map(p => 
        `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
    ).join('');
    
    card.innerHTML = `
        <div class="card-header">
            <span class="date">${dateString}</span>
            <span class="duration">${durationText}</span>
        </div>
        <div class="card-body">
            <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œæ–°å¢ä¸€ä¸ªæ ‡é¢˜è¡Œ -->
            ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
            
            <div class="participants-info"> <!-- æ–°å¢ä¸€ä¸ªå®¹å™¨æ–¹ä¾¿å¸ƒå±€ -->
                <div class="participants-avatars">${avatarsHtml}</div>
                <span class="participants-names">ä¸ ${chatName}</span>
            </div>
        </div>
    `;
    return card;
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

/**
 * æ˜¾ç¤ºæŒ‡å®šé€šè¯è®°å½•çš„å®Œæ•´æ–‡å­—ç¨¿
 * @param {number} recordId - é€šè¯è®°å½•çš„ID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('transcript-modal-body');

    titleEl.textContent = `é€šè¯äº ${new Date(record.timestamp).toLocaleString()} (æ—¶é•¿: ${Math.floor(record.duration / 60)}åˆ†${record.duration % 60}ç§’)`;
    bodyEl.innerHTML = '';
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">è¿™æ¬¡é€šè¯æ²¡æœ‰ç•™ä¸‹æ–‡å­—è®°å½•ã€‚</p>';
    } else {
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            // æ ¹æ®è§’è‰²æ·»åŠ ä¸åŒçš„class,åº”ç”¨ä¸åŒçš„æ ·å¼
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    const deleteBtn = document.getElementById('delete-transcript-btn');
    
    // ã€é‡è¦ã€‘ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æŠ€å·§,é˜²æ­¢äº‹ä»¶é‡å¤ç»‘å®š
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    
    // ä¸ºæ–°çš„ã€å¹²å‡€çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "ç¡®è®¤åˆ é™¤",
            "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡é€šè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            // 1. å…³é—­å½“å‰çš„è¯¦æƒ…å¼¹çª—
            modal.classList.remove('visible');
            
            // 2. ä»æ•°æ®åº“åˆ é™¤
            await db.callRecords.delete(recordId);
            
            // 3. åˆ·æ–°é€šè¯è®°å½•åˆ—è¡¨
            await renderCallHistoryScreen();
            
            // 4. (å¯é€‰) ç»™å‡ºæˆåŠŸæç¤º
            alert('é€šè¯è®°å½•å·²åˆ é™¤ã€‚');
        }
    });
    modal.classList.add('visible');
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹,å®Œæ•´æ›¿æ¢æ—§çš„ fabricateCommentsForPost å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°å‡çº§ç‰ˆã€‘ä¸ºAIå‘å¸ƒçš„åŠ¨æ€,æ™ºèƒ½åœ°ä¼ªé€ æ¥è‡ªå…¶ç¤¾äº¤åœˆçš„è¯„è®ºå’Œå›å¤
 * @param {object} post -åˆšåˆšè¢«åˆ›å»ºçš„åŠ¨æ€å¯¹è±¡
 * @param {object} authorChat -å‘å¸ƒè¯¥åŠ¨æ€çš„AIè§’è‰²çš„chatå¯¹è±¡
 */
async function fabricateCommentsForPost(post, authorChat) {
    if (Math.random() > 0.85) { // é™ä½äº†æ¦‚ç‡,è®©ä¸æ˜¯æ¯æ¡åŠ¨æ€éƒ½æœ‰è¯„è®º
        console.log(`éšæœºåˆ¤å®š:æœ¬æ¬¡åŠ¨æ€ (ID: ${post.id}) ä¸ç”Ÿæˆæ¨¡æ‹Ÿè¯„è®ºã€‚`);
        return;
    }

    console.log(`æ­£åœ¨ä¸ºåŠ¨æ€ (ID: ${post.id}) å‡†å¤‡ç”Ÿæˆæ¨¡æ‹Ÿè¯„è®º...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    // ã€æ ¸å¿ƒä¿®æ”¹1ã€‘åœ¨ç”ŸæˆæŒ‡ä»¤å‰,å…ˆä»æ•°æ®åº“è·å–æœ€æ–°çš„å¸–å­æ•°æ®,ç¡®ä¿èƒ½çœ‹åˆ°ä¹‹å‰çš„è¯„è®º
    const latestPost = await db.qzonePosts.get(post.id);
    if (!latestPost) return;

    let existingCommentsContext = "(è¿˜æ²¡æœ‰è¯„è®º)";
    if (latestPost.comments && latestPost.comments.length > 0) {
        existingCommentsContext = latestPost.comments.map(c => `- ${c.commenterName}: "${c.text}"`).join('\n');
    }

    // 1. å‡†å¤‡ä¸“é—¨ç”¨äºç”Ÿæˆè¯„è®ºå’Œå›å¤çš„System Prompt
    const commentGenerationPrompt = `
# ä½ çš„ä»»åŠ¡
ä½ æ˜¯ä¸€ä¸ªç¤¾äº¤åª’ä½“è¯„è®ºæ¨¡æ‹Ÿå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”è§’è‰²â€œ${authorChat.name}â€çš„æœ‹å‹ã€å®¶äººæˆ–ç¤¾äº¤åœˆé‡Œçš„å…¶ä»–äºº,å¹¶å¯¹Taåˆšåˆšå‘å¸ƒçš„åŠ¨æ€å‘è¡¨è¯„è®º,æˆ–è€…å›å¤åŠ¨æ€ä¸‹å·²æœ‰çš„è¯„è®ºã€‚

# æ ¸å¿ƒè§„åˆ™
1.  **åˆ†æäººè®¾ä¸å·²æœ‰è¯„è®º**: ä»”ç»†é˜…è¯»ä¸‹æ–¹æä¾›çš„â€œ${authorChat.name}â€çš„è§’è‰²è®¾å®š,ä»¥åŠåŠ¨æ€ä¸‹å·²æœ‰çš„è¯„è®ºã€‚
2.  **æ¨¡æ‹Ÿäº’åŠ¨**: æ ¹æ®åˆ†æ,æ¨¡æ‹Ÿ 1 åˆ° 3 æ¡æ¥è‡ªè¿™äº›è§’è‰²çš„ã€ç¬¦åˆä»–ä»¬èº«ä»½å’Œæ€§æ ¼çš„äº’åŠ¨ã€‚ä½ å¯ä»¥é€‰æ‹©:
    a. **å‘è¡¨æ–°è¯„è®º**: ç›´æ¥å¯¹åŠ¨æ€å†…å®¹å‘è¡¨çœ‹æ³•ã€‚
    b. **è¿›è¡Œå›å¤**: é’ˆå¯¹ä¸‹æ–¹â€œå·²æœ‰è¯„è®ºâ€ä¸­çš„æŸä¸€æ¡è¿›è¡Œå›å¤ã€‚
3.  **å¤šæ ·æ€§**: äº’åŠ¨é£æ ¼è¦å¤šæ ·åŒ–,å¯ä»¥æ˜¯æ”¯æŒã€è°ƒä¾ƒã€å¥½å¥‡ã€å…³å¿ƒã€æˆ–è€…äº’ç›¸æŠ¬æ ,è¦æ˜¾å¾—çœŸå®è‡ªç„¶ã€‚
4.  **ã€ã€ã€è¾“å‡ºæ ¼å¼é“å¾‹ã€‘ã€‘ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯ä¸€ä¸ªçº¯å‡€çš„JSONæ•°ç»„å­—ç¬¦ä¸²ã€‚
    -   **å¦‚æœæ˜¯æ–°è¯„è®º**,æ ¼å¼ä¸º: \`{"commenterName": "è¯„è®ºè€…", "text": "è¯„è®ºå†…å®¹"}\`
    -   **å¦‚æœæ˜¯å›å¤**,æ ¼å¼ä¸º: \`{"commenterName": "å›å¤è€…", "replyTo": "è¢«å›å¤è€…", "text": "å›å¤å†…å®¹"}\`
    -   **æœ€ç»ˆè¾“å‡ºç¤ºä¾‹**: \`[{"commenterName": "è‰è‰", "text": "å“‡,çœ‹èµ·æ¥å¥½å¥½åƒ!"}, {"commenterName": "å¦ˆå¦ˆ", "replyTo": "è‰è‰", "text": "å°±ä½ æƒ³åƒ!"}]\`

# ä¾›ä½ å‚è€ƒçš„ä¿¡æ¯
-   **å‘å¸–äºº**: ${authorChat.name}
-   **å‘å¸–äººçš„äººè®¾**: 
    ${authorChat.settings.aiPersona}
-   **åŠ¨æ€å†…å®¹**: 
    ${latestPost.publicText || latestPost.content || latestPost.imageDescription || latestPost.hiddenContent}
-   **åŠ¨æ€ä¸‹å·²æœ‰çš„è¯„è®º (ä½ å¯ä»¥é€‰æ‹©å›å¤å…¶ä¸­ä¸€æ¡)**:
    ${existingCommentsContext}

ç°åœ¨,è¯·å¼€å§‹ç”Ÿæˆäº’åŠ¨ã€‚
`;

    // 2. æ„å»ºAPIè¯·æ±‚
    const messagesForApi = [
        { role: 'system', content: commentGenerationPrompt },
        { role: 'user', content: 'è¯·æ ¹æ®æˆ‘çš„äººè®¾ã€åŠ¨æ€å†…å®¹ä»¥åŠå·²æœ‰çš„è¯„è®º,ç”Ÿæˆä¸€äº›æ¥è‡ªæˆ‘ç¤¾äº¤åœˆçš„äº’åŠ¨ã€‚' }
    ];

    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, commentGenerationPrompt, messagesForApi, isGemini);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: messagesForApi,
                temperature: 0.95, // è¿›ä¸€æ­¥æé«˜å¤šæ ·æ€§
            })
        });

        if (!response.ok) throw new Error((await response.json()).error.message);

        const data = await response.json();
        const responseText = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        
        const commentsArray = parseAiResponse(responseText);

        if (Array.isArray(commentsArray) && commentsArray.length > 0) {
            // ã€æ ¸å¿ƒä¿®æ”¹2ã€‘å†æ¬¡è·å–æœ€æ–°çš„postå¯¹è±¡,é˜²æ­¢åœ¨AIæ€è€ƒæœŸé—´ç”¨æˆ·åˆè¯„è®ºäº†
            const finalPost = await db.qzonePosts.get(post.id);
            if (!finalPost) return;
            if (!finalPost.comments) finalPost.comments = [];
            
            commentsArray.forEach(comment => {
                if (comment.commenterName && comment.text) {
                    finalPost.comments.push({
                        commenterName: comment.commenterName,
                        text: comment.text,
                        replyTo: comment.replyTo || null, // å¦‚æœAIæä¾›äº†replyToå­—æ®µ,å°±å­˜èµ·æ¥
                        timestamp: Date.now() + Math.random()
                    });
                }
            });

            await db.qzonePosts.update(finalPost.id, { comments: finalPost.comments });
            console.log(`æˆåŠŸä¸ºåŠ¨æ€ (ID: ${post.id}) æ·»åŠ äº† ${commentsArray.length} æ¡æ¨¡æ‹Ÿäº’åŠ¨ã€‚`);

            if (document.getElementById('qzone-screen').classList.contains('active')) {
                await renderQzonePosts();
            }
        }

    } catch (error) {
        console.error(`ä¸ºåŠ¨æ€ (ID: ${post.id}) ç”Ÿæˆæ¨¡æ‹Ÿè¯„è®ºå¤±è´¥:`, error);
    }
}

// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨ä¸‹é¢è¿™æ®µã€å…¨æ–°çš„ã€æ™ºèƒ½è§£æçš„å‡½æ•°ã€‘,å®Œæ•´æ›¿æ¢æ‰æ—§çš„ addAvatarFrames å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°æ™ºèƒ½URLç‰ˆã€‘æ‰¹é‡æ·»åŠ å¤´åƒæ¡†
 */
async function addAvatarFrames() {
    // 1. å¼¹å‡ºè¾“å…¥æ¡†,è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜
    const instructions = "æ¯è¡Œä¸€ä¸ªå¤´åƒæ¡†,æ”¯æŒå¤šç§æ ¼å¼:\n- URL,åç§°\n- URL åç§°\n- åç§° URL\n- åªæœ‰ URL (ä¼šè‡ªåŠ¨å‘½å)";
    const batchInput = await showCustomPrompt(
        "æ‰¹é‡æ·»åŠ å¤´åƒæ¡† (URL)",
        "è¯·ç²˜è´´...",
        "",
        "textarea",
        `<p style="font-size: 12px; color: #666; text-align: left; white-space: pre-wrap; background: #f0f0f0; padding: 8px; border-radius: 6px;">${instructions}</p>`
    );

    if (!batchInput || !batchInput.trim()) {
        return;
    }

    const lines = batchInput.trim().split('\n');
    const newFrames = [];
    let invalidLines = 0;

    // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æ›´æ™ºèƒ½çš„è§£æé€»è¾‘
    for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue;

        // a. æ­£åˆ™è¡¨è¾¾å¼,ç”¨äºä»ä¸€è¡Œä¸­æå–å‡ºURL
        const urlRegex = /(https?:\/\/[^\s,]+)|(data:image\/[^,]+)/i;
        const urlMatch = trimmedLine.match(urlRegex);

        let url = '';
        let name = '';

        if (urlMatch) {
            // b. å¦‚æœæˆåŠŸåŒ¹é…åˆ°URL
            url = urlMatch[0];
            // c. å°†URLä»åŸå­—ç¬¦ä¸²ä¸­ç§»é™¤,å‰©ä¸‹çš„éƒ¨åˆ†å°±æ˜¯åç§°
            name = trimmedLine.replace(url, '').replace(/[,;:\t]/, '').trim();

            // d. å¦‚æœç§»é™¤URLååç§°ä¸ºç©º,å°±è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª
            if (!name) {
                name = 'æœªå‘½å-' + (Date.now() + newFrames.length).toString().slice(-4);
            }
        } else {
            // e. å¦‚æœæ•´è¡Œéƒ½åŒ¹é…ä¸åˆ°URL,åˆ™è§†ä¸ºæ— æ•ˆè¡Œ
            invalidLines++;
            continue;
        }
        
        // f. åˆ›å»ºæ–°çš„å¤´åƒæ¡†å¯¹è±¡
        newFrames.push({
            id: 'frame_' + (Date.now() + newFrames.length),
            name: name,
            url: url
        });
    }

    // 3. åç»­çš„ä¿å­˜å’Œåé¦ˆé€»è¾‘ä¿æŒä¸å˜
    if (newFrames.length > 0) {
        await db.avatarFrames.bulkAdd(newFrames);
        await renderAvatarFrameLibrary();

        let successMessage = `æˆåŠŸæ·»åŠ äº† ${newFrames.length} ä¸ªæ–°å¤´åƒæ¡†!`;
        if (invalidLines > 0) {
            successMessage += `\næœ‰ ${invalidLines} è¡Œå› æ ¼å¼æ— æ³•è¯†åˆ«è€Œè¢«è·³è¿‡ã€‚`;
        }
        await showCustomAlert('æ“ä½œå®Œæˆ', successMessage);
    } else {
        await showCustomAlert('æ“ä½œå¤±è´¥', 'æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„å¤´åƒæ¡†ä¿¡æ¯ã€‚è¯·ç¡®ä¿æ¯è¡Œéƒ½åŒ…å«ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡URLã€‚');
    }
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªã€å…¨æ–°å‡½æ•°ã€‘æ›¿æ¢æ‰ä½ æ—§çš„ handleStatusResetClick å‡½æ•° â–¼â–¼â–¼

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»çŠ¶æ€æ ,å¼¹å‡ºç¼–è¾‘æ¡†è®©ç”¨æˆ·ä¿®æ”¹AIçš„å½“å‰çŠ¶æ€
 */
async function handleEditStatusClick() {
    // 1. å®‰å…¨æ£€æŸ¥,ç¡®ä¿åœ¨å•èŠç•Œé¢
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
        return; 
    }
    const chat = state.chats[state.activeChatId];

    // 2. å¼¹å‡ºè¾“å…¥æ¡†,è®©ç”¨æˆ·è¾“å…¥æ–°çš„çŠ¶æ€,å¹¶å°†å½“å‰çŠ¶æ€ä½œä¸ºé»˜è®¤å€¼
    const newStatusText = await showCustomPrompt(
        'ç¼–è¾‘å¯¹æ–¹çŠ¶æ€',
        'è¯·è¾“å…¥å¯¹æ–¹ç°åœ¨çš„æ–°çŠ¶æ€:',
        chat.status.text // å°†å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥æ¡†çš„é»˜è®¤å†…å®¹
    );

    // 3. å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»äº†â€œç¡®å®šâ€
    if (newStatusText !== null) {
        // 4. æ›´æ–°å†…å­˜å’Œæ•°æ®åº“ä¸­çš„çŠ¶æ€æ•°æ®
        chat.status.text = newStatusText.trim() || 'åœ¨çº¿'; // å¦‚æœç”¨æˆ·æ¸…ç©ºäº†,å°±é»˜è®¤ä¸ºâ€œåœ¨çº¿â€
        chat.status.isBusy = false; // æ¯æ¬¡æ‰‹åŠ¨ç¼–è¾‘éƒ½é»˜è®¤å…¶ä¸å¤„äºâ€œå¿™ç¢Œâ€çŠ¶æ€
        chat.status.lastUpdate = Date.now();
        await db.chats.put(chat);

        // 5. ç«‹åˆ»åˆ·æ–°UI,è®©ç”¨æˆ·çœ‹åˆ°ä¿®æ”¹åçš„çŠ¶æ€
        renderChatInterface(state.activeChatId);
        renderChatList();
        
        // 6. ç»™å‡ºä¸€ä¸ªæ— ä¼¤å¤§é›…çš„æˆåŠŸæç¤º
        await showCustomAlert('çŠ¶æ€å·²æ›´æ–°', `â€œ${chat.name}â€çš„å½“å‰çŠ¶æ€å·²æ›´æ–°ä¸º:${chat.status.text}`);
    }
}

// æ”¾åœ¨ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº
async function openShareTargetPicker() {
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';

    // è·å–æ‰€æœ‰èŠå¤©ä½œä¸ºåˆ†äº«ç›®æ ‡
    const chats = Object.values(state.chats);

    chats.forEach(chat => {
        // å¤ç”¨è”ç³»äººé€‰æ‹©å™¨çš„æ ·å¼
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; 
        item.innerHTML = `
            <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
        listEl.appendChild(item);
    });
    
    modal.classList.add('visible');
}

function closeMusicPlayerWithAnimation(callback) {
    const overlay = document.getElementById('music-player-overlay');
    if (!overlay.classList.contains('visible')) {
        if (callback) callback();
        return;
    }
    overlay.classList.remove('visible');
    setTimeout(() => {
        document.getElementById('music-playlist-panel').classList.remove('visible');
        if (callback) callback();
    }, 400); 
}

function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = lrcContent.split('\n');
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;

    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">â™ª æš‚æ— æ­Œè¯ â™ª</div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
}

function updateLyricsUI() {
    const lyricsList = document.getElementById('music-lyrics-list');
    const container = document.getElementById('music-lyrics-container');
    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));
    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }
    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 3) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }
}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

function updateMusicProgressBar() {
    const currentTimeEl = document.getElementById('music-current-time');
    const totalTimeEl = document.getElementById('music-total-time');
    const progressFillEl = document.getElementById('music-progress-fill');
    if (!audioPlayer.duration) {
        currentTimeEl.textContent = "0:00";
        totalTimeEl.textContent = "0:00";
        progressFillEl.style.width = '0%';
        return;
    }
    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressFillEl.style.width = `${progressPercent}%`;
    currentTimeEl.textContent = formatMusicTime(audioPlayer.currentTime);
    totalTimeEl.textContent = formatMusicTime(audioPlayer.duration);
    updateActiveLyric(audioPlayer.currentTime);
}

/**
 * ã€å…¨æ–°ã€‘å¤„ç†ç”¨æˆ·ç‚¹å‡»â€œæ’¤å›â€æŒ‰é’®çš„å…¥å£å‡½æ•°
 */
async function handleRecallClick() {
    if (!activeMessageTimestamp) return;

    const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // è®¾ç½®2åˆ†é’Ÿçš„æ’¤å›æ—¶é™
    const messageTime = activeMessageTimestamp;
    const now = Date.now();

    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡äº†æ’¤å›æ—¶é™
    if (now - messageTime > RECALL_TIME_LIMIT_MS) {
        hideMessageActions();
        await showCustomAlert('æ“ä½œå¤±è´¥', 'è¯¥æ¶ˆæ¯å‘é€å·²è¶…è¿‡2åˆ†é’Ÿ,æ— æ³•æ’¤å›ã€‚');
        return;
    }
    
    // å¦‚æœåœ¨æ—¶é™å†…,æ‰§è¡ŒçœŸæ­£çš„æ’¤å›é€»è¾‘
    await recallMessage(messageTime, true);
    hideMessageActions();
}

/**
 * ã€å…¨æ–°ã€‘æ¶ˆæ¯æ’¤å›çš„æ ¸å¿ƒé€»è¾‘
 * @param {number} timestamp - è¦æ’¤å›çš„æ¶ˆæ¯çš„æ—¶é—´æˆ³
 * @param {boolean} isUserRecall - æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨æ’¤å›
 */
async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    // 1. ä¿®æ”¹æ¶ˆæ¯å¯¹è±¡,å°†å…¶å˜ä¸ºâ€œå·²æ’¤å›â€çŠ¶æ€
    const recalledData = {
        originalType: messageToRecall.type || 'text',
        originalContent: messageToRecall.content,
        // ä¿å­˜å…¶ä»–å¯èƒ½å­˜åœ¨çš„åŸå§‹æ•°æ®
        originalMeaning: messageToRecall.meaning,
        originalQuote: messageToRecall.quote 
    };
    
    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? 'ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯' : 'å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯';
    messageToRecall.recalledData = recalledData;
    // æ¸…ç†æ‰ä¸å†éœ€è¦çš„æ—§å±æ€§
    delete messageToRecall.meaning;
    delete messageToRecall.quote;

    // 2. å¦‚æœæ˜¯ç”¨æˆ·æ’¤å›,éœ€è¦ç»™AIå‘é€ä¸€æ¡å®ƒçœ‹ä¸æ‡‚å†…å®¹çš„éšè—æç¤º
    if (isUserRecall) {
        const hiddenMessageForAI = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤º:ç”¨æˆ·æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ã€‚ä½ ä¸çŸ¥é“å†…å®¹æ˜¯ä»€ä¹ˆ,åªéœ€çŸ¥é“è¿™ä¸ªäº‹ä»¶å³å¯ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessageForAI);
    }

    // 3. ä¿å­˜åˆ°æ•°æ®åº“å¹¶åˆ·æ–°UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    if(isUserRecall) renderChatList(); // ç”¨æˆ·æ’¤å›æ—¶,æœ€åä¸€æ¡æ¶ˆæ¯å˜äº†,éœ€è¦åˆ·æ–°åˆ—è¡¨
}

// â–¼â–¼â–¼ ã€Aã€‘ç²˜è´´ä»¥ä¸‹ä¸‰ä¸ªæ–°å‡½æ•°åˆ° JS åŠŸèƒ½åŒº â–¼â–¼â–¼

/**
 * å¯ç”¨å¯çˆ±çš„äº‹ä»¶æŸ¥çœ‹å™¨å†…çš„ç¼–è¾‘æ¨¡å¼
 * @param {object} event - è¦ç¼–è¾‘çš„äº‹ä»¶å¯¹è±¡
 */
function enableCuteViewerEditMode(event) {
    const titleContainer = document.getElementById('cute-event-title');
    const memoContainer = document.getElementById('cute-event-memo');
    const editBtn = document.getElementById('cute-event-edit-btn');
    const closeBtn = document.getElementById('close-cute-event-viewer-btn');
    const deleteBtn = document.getElementById('cute-event-delete-btn');
    const metaContainer = document.getElementById('cute-event-meta');

    // 1. å°†æ ‡é¢˜æ›¿æ¢ä¸ºè¾“å…¥æ¡†
    titleContainer.outerHTML = `<input type="text" id="cute-title-input" class="cute-event-title" value="${event.title}">`;
    
    // 2. å°†å¤‡å¿˜å½•æ›¿æ¢ä¸ºæ–‡æœ¬åŸŸ
    memoContainer.outerHTML = `<textarea id="cute-memo-textarea" class="cute-event-memo">${event.memo || ''}</textarea>`;

    // 3. éšè—å…ƒæ•°æ®ä¿¡æ¯
    metaContainer.style.display = 'none';

    // 4. æ›´æ”¹æŒ‰é’®åŠŸèƒ½å’Œæ–‡æœ¬
    editBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
    editBtn.id = 'cute-event-save-btn'; // æ›´æ”¹IDä»¥ä¾¿äºç»‘å®šæ–°äº‹ä»¶
    closeBtn.textContent = 'å–æ¶ˆ';
    deleteBtn.style.display = 'none'; // éšè—åˆ é™¤æŒ‰é’®,åªåœ¨æŸ¥çœ‹æ¨¡å¼æ˜¾ç¤º

    // ã€é‡è¦ã€‘å°†äº‹ä»¶IDå­˜å‚¨åˆ°æ¨¡æ€æ¡†ä¸Š,ä»¥å¤‡ä¿å­˜æ—¶ä½¿ç”¨
    const modal = document.getElementById('cute-event-viewer-modal');
    modal.dataset.editingId = event.id;
    modal.dataset.editingDate = event.date;

    // é‡æ–°ç»‘å®šä¿å­˜äº‹ä»¶ (å› ä¸ºIDå˜äº†,éœ€è¦é‡æ–°è·å–DOMå¯¹è±¡)
    document.getElementById('cute-event-save-btn').addEventListener('click', handleCuteViewerSave);
}

/**
 * å¤„ç†åœ¨å¯çˆ±æŸ¥çœ‹å™¨ä¸­ç‚¹å‡»â€œä¿å­˜ä¿®æ”¹â€çš„é€»è¾‘
 */
async function handleCuteViewerSave() {
    const modal = document.getElementById('cute-event-viewer-modal');
    const eventId = parseInt(modal.dataset.editingId);
    const newTitle = document.getElementById('cute-title-input').value.trim();
    const newMemo = document.getElementById('cute-memo-textarea').value.trim();
    
    if (!newTitle) {
        alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©ºå“¦!');
        return;
    }

    // 1. æ›´æ–°æ•°æ®åº“
    await db.calendarEvents.update(eventId, { title: newTitle, memo: newMemo });

    // 2. è·å–æ›´æ–°åçš„äº‹ä»¶å¯¹è±¡
    const updatedEvent = await db.calendarEvents.get(eventId);

    // 3. åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
    disableCuteViewerEditMode(updatedEvent);

    // 4. åˆ·æ–°æ—¥å†,ç¡®ä¿çº¢ç‚¹æ­£ç¡®æ˜¾ç¤º(å¦‚æœæ ‡é¢˜æœ‰å˜)
    await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
    
    alert('å¤‡å¿˜å·²ä¿å­˜!');
}

/**
 * ç¦ç”¨ç¼–è¾‘æ¨¡å¼,åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
 * @param {object} event - æœ€ç»ˆçš„äº‹ä»¶å¯¹è±¡
 */
function disableCuteViewerEditMode(event) {
    const modal = document.getElementById('cute-event-viewer-modal');
    const titleInput = document.getElementById('cute-title-input');
    const memoTextarea = document.getElementById('cute-memo-textarea');
    const saveBtn = document.getElementById('cute-event-save-btn');
    const closeBtn = document.getElementById('close-cute-event-viewer-btn');

    // 1. å°†è¾“å…¥æ¡†/æ–‡æœ¬åŸŸæ›¿æ¢å›æ˜¾ç¤ºå…ƒç´ 
    titleInput.outerHTML = `<h2 id="cute-event-title" class="cute-event-title">${event.title}</h2>`;
    memoTextarea.outerHTML = `<div id="cute-event-memo" class="cute-event-memo">${event.memo || '(æ²¡æœ‰å†™è¯¦ç»†å¤‡å¿˜å“¦~)'}</div>`;

    // 2. æ¢å¤æŒ‰é’®çŠ¶æ€
    saveBtn.textContent = 'ç¼–è¾‘';
    saveBtn.id = 'cute-event-edit-btn';
    closeBtn.textContent = 'å…³é—­';
    document.getElementById('cute-event-meta').style.display = 'block';

    // 3. é‡æ–°åŠ è½½æŸ¥çœ‹æ¨¡å¼(è°ƒç”¨ showCuteEventViewer çš„æ ¸å¿ƒé€»è¾‘éƒ¨åˆ†)
    showCuteEventViewer(event);

    // 4. æ¸…ç† dataset
    delete modal.dataset.editingId;
    delete modal.dataset.editingDate;
}

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å°†è¿™äº›å‡½æ•°ç²˜è´´åˆ°ä½ çš„JSåŠŸèƒ½å‡½æ•°å®šä¹‰åŒº â–¼â–¼â–¼

/**
 * æ‰“å¼€åˆ†ç±»ç®¡ç†æ¨¡æ€æ¡†
 */
async function openCategoryManager() {
    await renderCategoryListInManager();
    document.getElementById('world-book-category-manager-modal').classList.add('visible');
}

/**
 * åœ¨æ¨¡æ€æ¡†ä¸­æ¸²æŸ“å·²å­˜åœ¨çš„åˆ†ç±»åˆ—è¡¨
 */
async function renderCategoryListInManager() {
    const listEl = document.getElementById('existing-categories-list');
    const categories = await db.worldBookCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç±»</p>';
    }
    categories.forEach(cat => {
        // å¤ç”¨å¥½å‹åˆ†ç»„çš„æ ·å¼
        const item = document.createElement('div');
        item.className = 'existing-group-item'; 
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * æ·»åŠ ä¸€ä¸ªæ–°çš„ä¸–ç•Œä¹¦åˆ†ç±»
 */
async function addNewCategory() {
    const input = document.getElementById('new-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('åˆ†ç±»åä¸èƒ½ä¸ºç©º!');
        return;
    }
    const existing = await db.worldBookCategories.where('name').equals(name).first();
    if (existing) {
        alert(`åˆ†ç±» "${name}" å·²ç»å­˜åœ¨äº†!`);
        return;
    }
    await db.worldBookCategories.add({ name });
    input.value = '';
    await renderCategoryListInManager();
}

/**
 * åˆ é™¤ä¸€ä¸ªä¸–ç•Œä¹¦åˆ†ç±»
 * @param {number} categoryId - è¦åˆ é™¤çš„åˆ†ç±»çš„ID
 */
async function deleteCategory(categoryId) {
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤', 
        'åˆ é™¤åˆ†ç±»å,è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¸–ç•Œä¹¦å°†å˜ä¸ºâ€œæœªåˆ†ç±»â€ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', 
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.worldBookCategories.delete(categoryId);
        // å°†å±äºè¯¥åˆ†ç±»çš„ä¸–ç•Œä¹¦çš„ categoryId è®¾ä¸º null
        const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
        for (const book of booksToUpdate) {
            book.categoryId = null;
            await db.worldBooks.put(book);
            const bookInState = state.worldBooks.find(wb => wb.id === book.id);
            if(bookInState) bookInState.categoryId = null;
        }
        await renderCategoryListInManager();
    }
}

// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ›´æ–°ç­‰å¾…/åœæ­¢æŒ‰é’®UIçš„è¾…åŠ©å‡½æ•° â–¼â–¼â–¼
function updateWaitButtonUI(isStopping) {
    const waitBtn = document.getElementById('wait-reply-btn');
    const waitBtnIcon = waitBtn.querySelector('img');
    if (!waitBtn || !waitBtnIcon) return;

    if (isStopping) {
        // åˆ‡æ¢åˆ°â€œåœæ­¢â€çŠ¶æ€
        waitBtn.classList.add('stop-generation-mode');
        waitBtnIcon.src = 'https://sharkpan.xyz/f/5y67ij/MaterialSymbolsPauseCircleOutlineRounded.png'; // è¿™æ˜¯ä¸€ä¸ªæ–¹å½¢çš„åœæ­¢å›¾æ ‡
        waitBtn.title = 'åœæ­¢ç”Ÿæˆ';
    } else {
        // æ¢å¤ä¸ºâ€œç­‰å¾…â€çŠ¶æ€
        waitBtn.classList.remove('stop-generation-mode');
        waitBtnIcon.src = 'https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png'; // æ¢å¤ä¸ºåŸæ¥çš„ç­‰å¾…å›¾æ ‡
        waitBtn.title = 'ç­‰å¾…å›å¤';
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ›´æ–°å‘é€/é‡ç”ŸæˆæŒ‰é’®UIçš„è¾…åŠ©å‡½æ•° â–¼â–¼â–¼
function updateSendButtonUI(mode = 'send') {
    const sendBtn = document.getElementById('send-btn');
    const sendBtnIcon = sendBtn.querySelector('img');
    if (!sendBtn || !sendBtnIcon) return;

    if (mode === 'regenerate') {
        // åˆ‡æ¢åˆ°â€œé‡æ–°ç”Ÿæˆâ€çŠ¶æ€
        sendBtnIcon.src = 'https://sharkpan.xyz/f/e7wLsa/%E5%88%B7%E6%96%B0.png'; // è¿™æ˜¯ä¸€ä¸ªåˆ·æ–°/é‡åšå›¾æ ‡
        sendBtn.title = 'é‡æ–°ç”Ÿæˆ';
    } else {
        // æ¢å¤ä¸ºâ€œå‘é€â€çŠ¶æ€
        sendBtnIcon.src = 'https://sharkpan.xyz/f/ZqlriW/%E5%8F%91%E9%80%81%202.png'; // æ¢å¤ä¸ºåŸæ¥çš„å‘é€å›¾æ ‡
        sendBtn.title = 'å‘é€';
    }
}
// â–²â–²â–² æ–°å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

        // ===================================================================
        // 4. åˆå§‹åŒ–å‡½æ•° init()
        // ===================================================================
        async function init() {

    // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„ã€æœ€å¼€å¤´ã€‘,ç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œä»£ç  â–¼â–¼â–¼
    const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // é»˜è®¤ä¸ºæ—¥é—´æ¨¡å¼
    applyTheme(savedTheme);
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

        const globalCustomCssStyleTag = document.createElement('style');
        globalCustomCssStyleTag.id = 'global-custom-css-style';
        document.head.appendChild(globalCustomCssStyleTag);

            // ã€å…¨æ–°ã€‘åº”ç”¨ä¿å­˜çš„è¾¹æ¡†æ¨¡å¼
            if (state.globalSettings.borderMode === 'bordered') {
                document.body.classList.add('bordered-mode');
            }

    // â–¼â–¼â–¼ æ–°å¢ä»£ç  â–¼â–¼â–¼
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            window.showScreen = showScreen;
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();
            applyCurrentTheme(); // <-- åœ¨è¿™é‡Œæ·»åŠ ,å®ç°ä¸»é¢˜æŒä¹…åŒ–
applyGlobalCustomCss(state.globalSettings.globalCustomCss); // <-- æ·»åŠ è¿™ä¸€è¡Œ
            

            // åˆå§‹åŒ–æœªè¯»åŠ¨æ€è®¡æ•°
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            // â–²â–²â–² ä»£ç æ·»åŠ ç»“æŸ â–²â–²â–²

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

applyAppIcons();

            // ==========================================================
            // --- å„ç§äº‹ä»¶ç›‘å¬å™¨ ---
            // ==========================================================

            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 
document.getElementById('sticker-panel').classList.remove('visible');

    // â–¼â–¼â–¼ ä¿®æ”¹è¿™ä¸¤è¡Œ â–¼â–¼â–¼
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // æ¸…é™¤çœŸå®èŠå¤©ç•Œé¢çš„è‡ªå®šä¹‰æ ·å¼
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // æ¸…é™¤é¢„è§ˆåŒºçš„è‡ªå®šä¹‰æ ·å¼
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©åˆ—è¡¨â€œ+â€å·èœå•åŠŸèƒ½é€»è¾‘ â–¼â–¼â–¼

// 1. è·å–èœå•ç›¸å…³çš„DOMå…ƒç´ 
const addChatBtn = document.getElementById('add-chat-btn');
const addChatMenu = document.getElementById('add-chat-menu');
const menuCreateGroup = document.getElementById('menu-create-group');
const menuAddFriend = document.getElementById('menu-add-friend');

// 2. ä¸ºâ€œ+â€å·æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶,ç”¨äºæ˜¾ç¤º/éšè—èœå•
addChatBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡,ä»¥å…è§¦å‘ä¸‹é¢çš„windowç‚¹å‡»äº‹ä»¶
    addChatMenu.classList.toggle('visible');
});

// 3. ä¸ºèœå•é¡¹â€œåˆ›å»ºç¾¤èŠâ€ç»‘å®šäº‹ä»¶
menuCreateGroup.addEventListener('click', () => {
    addChatMenu.classList.remove('visible'); // ç‚¹å‡»åéšè—èœå•
    openContactPickerForGroupCreate(); // è°ƒç”¨åŸæœ‰çš„åˆ›å»ºç¾¤èŠå‡½æ•°
});

// 4. ä¸ºèœå•é¡¹â€œåŠ å¥½å‹â€ç»‘å®šäº‹ä»¶
menuAddFriend.addEventListener('click', async () => {
    addChatMenu.classList.remove('visible'); // ç‚¹å‡»åéšè—èœå•
    // è¿™æ˜¯åŸæ¥â€œ+â€å·æŒ‰é’®çš„åŠŸèƒ½,ç°åœ¨åˆ†é…ç»™äº†â€œåŠ å¥½å‹â€
    const name = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤©', 'è¯·è¾“å…¥Taçš„åå­—');
    if (name && name.trim()) {
        const newChatId = 'chat_' + Date.now();
        const newChat = {
            id: newChatId,
            name: name.trim(),
            isGroup: false,
            relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
            status: { text: 'åœ¨çº¿', lastUpdate: Date.now(), isBusy: false },
            settings: { 
                aiPersona: 'ä½ æ˜¯è°å‘€ã€‚', 
                myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', 
                maxMemory: 10, 
                aiAvatar: defaultAvatar, 
                myAvatar: defaultAvatar, 
                background: '', 
                theme: 'default', 
                fontSize: 13, 
                customCss: '',
                linkedWorldBookIds: [], 
                aiAvatarLibrary: [],
                myAvatarFrame: '',
                aiAvatarFrame: ''
            },
            history: [],
            musicData: { totalTime: 0 }
        };
        state.chats[newChatId] = newChat;
        await db.chats.put(newChat);
        renderChatList();
    }
});

// 5. ã€é‡è¦ã€‘æ·»åŠ ä¸€ä¸ªå…¨å±€ç‚¹å‡»äº‹ä»¶,ç”¨äºåœ¨ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶å…³é—­èœå•
window.addEventListener('click', (e) => {
    // æ£€æŸ¥èœå•æ˜¯å¦å¯è§,å¹¶ä¸”ç‚¹å‡»çš„ä¸æ˜¯èœå•æœ¬èº«æˆ–â€œ+â€å·æŒ‰é’®
    if (addChatMenu.classList.contains('visible') && !addChatMenu.contains(e.target) && !addChatBtn.contains(e.target)) {
        addChatMenu.classList.remove('visible');
    }
});

// â–²â–²â–² æ–°JSé€»è¾‘ç²˜è´´ç»“æŸ â–²â–²â–²                      
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });

            const chatInput = document.getElementById('chat-input');
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ V3 - æ™ºèƒ½åˆ é™¤ã€‘'send-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('send-btn').addEventListener('click', async () => {
    const chatInput = document.getElementById('chat-input');
    const content = chatInput.value.trim();
    
    if (canRegenerate && content === '') {
        // --- æ‰§è¡Œâ€œé‡æ–°ç”Ÿæˆâ€é€»è¾‘ ---
        console.log("é‡æ–°ç”ŸæˆåŠŸèƒ½å·²è§¦å‘ã€‚");
        canRegenerate = false;
        updateSendButtonUI('send'); 

        const chat = state.chats[state.activeChatId];
        if (!chat) return;

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ¤æ–­æ¡ä»¶æ¥åˆ é™¤AIçš„æ•´è½®å›å¤ â–¼â–¼â–¼
        let i = chat.history.length - 1;
        while (i >= 0) {
            const message = chat.history[i];
            
            // æ£€æŸ¥è¿™æ¡æ¶ˆæ¯æ˜¯å¦å±äºâ€œAIçš„å›åˆâ€
            // æ¡ä»¶1: role æ˜¯ 'assistant' (AIè‡ªå·±è¯´çš„)
            // æ¡ä»¶2: role æ˜¯ 'system', ä½†ä¸æ˜¯ isHidden (ç³»ç»Ÿæ›¿AIè¯´çš„ï¼Œä¸”ç”¨æˆ·å¯è§)
            const isAiTurnMessage = message.role === 'assistant' || (message.role === 'system' && !message.isHidden);

            if (isAiTurnMessage) {
                chat.history.pop();
                i--;
            } else {
                // ä¸€æ—¦é‡åˆ°ç”¨æˆ·æ¶ˆæ¯æˆ–éšè—çš„ç³»ç»ŸæŒ‡ä»¤ï¼Œå°±åœæ­¢
                break;
            }
        }
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
        triggerAiResponse();

    } else {
        // --- æ‰§è¡ŒåŸæœ‰çš„â€œå‘é€æ¶ˆæ¯â€é€»è¾‘ ---
        if (!content || !state.activeChatId) return;
        
        canRegenerate = false;
        updateSendButtonUI('send'); 

        const chat = state.chats[state.activeChatId];
        const msg = {
            role: 'user',
            content,
            timestamp: Date.now()
        };

        if (currentReplyContext) {
            msg.quote = currentReplyContext;
        }

        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
        chatInput.value = '';
        chatInput.style.height = 'auto';
        chatInput.focus();
        cancelReplyMode();
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ ã€åŠŸèƒ½å‡çº§ã€‘ç”¨è¿™å—ä»£ç æ›¿æ¢æ—§çš„ wait-reply-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('wait-reply-btn').addEventListener('click', () => {
    if (isAiGenerating) {
        // å¦‚æœAIæ­£åœ¨ç”Ÿæˆï¼Œåˆ™æ‰§è¡Œâ€œåœæ­¢â€é€»è¾‘
        if (abortController) {
            abortController.abort(); // å‘å‡ºä¸­æ–­ä¿¡å·
            console.log("å·²å‘é€ä¸­æ–­è¯·æ±‚...");
        }
    } else {
        // å¦‚æœAIæœªåœ¨ç”Ÿæˆï¼Œåˆ™æ‰§è¡Œâ€œè§¦å‘â€é€»è¾‘
        triggerAiResponse();
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            // â–¼â–¼â–¼ ã€åŠŸèƒ½å‡çº§ã€‘ç”¨è¿™å—ä»£ç æ›¿æ¢æ—§çš„ chatInput 'input' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto';
    chatInput.style.height = (chatInput.scrollHeight) + 'px';
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å½“ç”¨æˆ·å¼€å§‹è¾“å…¥æ—¶ï¼Œç¦ç”¨â€œé‡æ–°ç”Ÿæˆâ€åŠŸèƒ½
    if (canRegenerate) {
        canRegenerate = false;
        updateSendButtonUI('send'); // æŒ‰é’®æ¢å¤ä¸ºâ€œå‘é€â€
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            // ã€åŠŸèƒ½å¢å¼ºç‰ˆã€‘ä¿å­˜æ‰€æœ‰å¤–è§‚è®¾ç½®æŒ‰é’®
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    // 1. ä¿å­˜å£çº¸ (é€»è¾‘ä¸å˜)
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
        newWallpaperBase64 = null;
    }
    
    // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä»UIè¯»å–æœ€æ–°çš„å…¨å±€CSSå¹¶å­˜å…¥state
    state.globalSettings.globalCustomCss = document.getElementById('global-custom-css-input').value;

    // 3. å°†åŒ…å«æ‰€æœ‰æ›´æ–°çš„ globalSettings å¯¹è±¡ä¸€æ¬¡æ€§ä¿å­˜åˆ°æ•°æ®åº“
    await db.globalSettings.put(state.globalSettings);

    // 4. å®æ—¶åº”ç”¨æ‰€æœ‰æ›´æ”¹
    applyCurrentTheme(); 
    applyGlobalCustomCss(state.globalSettings.globalCustomCss); // <-- åº”ç”¨CSS
    applyAppIcons();

    alert('æ‰€æœ‰å¤–è§‚è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨!');
    showScreen('home-screen');
});
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); 

// åœ¨ 'save-api-settings-btn' çš„ click äº‹ä»¶ç›‘å¬å™¨å†…éƒ¨
// await db.apiConfig.put(state.apiConfig); è¿™è¡Œä¹‹å

// â–¼â–¼â–¼ å°†ä¹‹å‰é‚£æ®µä¿å­˜åå°æ´»åŠ¨è®¾ç½®çš„é€»è¾‘,æ›¿æ¢ä¸ºä¸‹é¢è¿™ä¸ªå¢å¼ºç‰ˆ â–¼â–¼â–¼

const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

// åªæœ‰åœ¨ç”¨æˆ·â€œä»å…³åˆ°å¼€â€æ—¶,æ‰å¼¹å‡ºè­¦å‘Š
if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "ã€é«˜è´¹ç”¨è­¦å‘Šã€‘\n\n" +
        "æ‚¨æ­£åœ¨å¯ç”¨â€œåå°è§’è‰²æ´»åŠ¨â€åŠŸèƒ½ã€‚\n\n" +
        "è¿™ä¼šä½¿æ‚¨çš„AIè§’è‰²ä»¬åœ¨æ‚¨ä¸å’Œä»–ä»¬èŠå¤©æ—¶,ä¹Ÿèƒ½â€œç‹¬ç«‹æ€è€ƒâ€å¹¶ä¸»åŠ¨ç»™æ‚¨å‘æ¶ˆæ¯æˆ–è¿›è¡Œç¤¾äº¤äº’åŠ¨,æå¤§åœ°å¢å¼ºæ²‰æµ¸æ„Ÿã€‚\n\n" +
        "ä½†è¯·æ³¨æ„:\n" +
        "è¿™ä¼šã€åœ¨åå°è‡ªåŠ¨ã€å®šæœŸåœ°è°ƒç”¨APIã€‘,å³ä½¿æ‚¨ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚æ ¹æ®æ‚¨çš„è§’è‰²æ•°é‡å’Œæ£€æµ‹é—´éš”,è¿™å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„APIè´¹ç”¨æ˜¾è‘—å¢åŠ ã€‚\n\n" +
        "æ‚¨ç¡®å®šè¦å¼€å¯å—ï¼Ÿ"
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; // ç”¨æˆ·å–æ¶ˆ,æŠŠå¼€å…³æ‹¨å›å»
        return; // é˜»æ­¢åç»­é€»è¾‘
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
await db.globalSettings.put(state.globalSettings);

// åŠ¨æ€å¯åŠ¨æˆ–åœæ­¢æ¨¡æ‹Ÿå™¨
stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²å¯åŠ¨,é—´éš”: ${state.globalSettings.backgroundActivityInterval}ç§’`);
} else {
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²åœæ­¢ã€‚");
}
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

alert('APIè®¾ç½®å·²ä¿å­˜!'); });

                    // gemini å¯†é’¥èšç„¦çš„æ—¶å€™æ˜¾ç¤ºæ˜æ–‡
        const ApiKeyInput = document.getElementById('api-key')
        ApiKeyInput.addEventListener('focus', (e) => {
            e.target.setAttribute('type', 'text')
        })
        ApiKeyInput.addEventListener('blur', (e) => {
            e.target.setAttribute('type', 'password')
        })


        document.getElementById('fetch-models-btn').addEventListener('click', async () => {
            const url = document.getElementById('proxy-url').value.trim();
            const key = document.getElementById('api-key').value.trim();
            if (!url || !key) return alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥');

            try {
                const isLegacyGemini = url === 'https://generativelanguage.googleapis.com/v1beta/models';
                const isStudioGemini = url === 'https://generativelanguage.googleapis.com';
                
                let response;
                if (isStudioGemini) {
                    response = await fetch(`${url}/v1/models?key=${getRandomValue(key)}`);
                } else if (isLegacyGemini) {
                    response = await fetch(`${url}?key=${getRandomValue(key)}`);
                } else { // OpenAI compatible
                    response = await fetch(`${url}/v1/models`, { headers: {'Authorization': `Bearer ${key}`} });
                }

                if (!response.ok) throw new Error(`æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨: ${response.status}`);
                const data = await response.json();

                let models;
                if (isStudioGemini || isLegacyGemini) {
                    models = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent")).map(model => {
                        const parts = model.name.split('/');
                        return { id: parts.length > 1 ? parts[1] : model.name };
                    });
                } else {
                    models = data.data;
                }
                
                const modelSelect = document.getElementById('model-select');
                modelSelect.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === state.apiConfig.model) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
            } catch (error) {
                alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`);
            }
        });

            // ã€å…¨æ–°ã€‘Gemini AI Studio (AIza... Key) ç›´è¿å¿«é€Ÿè®¾ç½®æŒ‰é’®
            document.getElementById('gemini-studio-setup-btn').addEventListener('click', () => {
                // è‡ªåŠ¨å¡«å†™ Gemini AI Studio çš„å®˜æ–¹ API åœ°å€
                document.getElementById('proxy-url').value = 'https://generativelanguage.googleapis.com';
                
                // å¼¹å‡ºæç¤º,å¼•å¯¼ç”¨æˆ·ä¸‹ä¸€æ­¥æ“ä½œ
                alert('åä»£åœ°å€å·²è®¾ç½®ä¸º Gemini å®˜æ–¹åœ°å€ã€‚\n\nè¯·ç²˜è´´æ‚¨çš„ Gemini API å¯†é’¥ (ä»¥ AIza... å¼€å¤´),ç„¶åç‚¹å‡»â€œæ‹‰å–æ¨¡å‹â€å’Œâ€œä¿å­˜è®¾ç½®â€ã€‚');
                
                // è‡ªåŠ¨èšç„¦åˆ°å¯†é’¥è¾“å…¥æ¡†
                document.getElementById('api-key').focus();
            });

            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¯·è¾“å…¥ä¹¦å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('ä¹¦åä¸èƒ½ä¸ºç©º!'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; 

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œä¿å­˜åˆ†ç±»ID â–¼â–¼â–¼
        const categoryId = document.getElementById('world-book-category-select').value;
        // å¦‚æœé€‰æ‹©äº†â€œæœªåˆ†ç±»â€,å­˜å…¥ nullï¼›å¦åˆ™å­˜å…¥æ•°å­—ID
        book.categoryId = categoryId ? parseInt(categoryId) : null; 
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
            // â–¼â–¼â–¼ ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ chat-messages ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const aiImage = e.target.closest('.ai-generated-image');
    if (aiImage) {
        const isLoaded = aiImage.dataset.loaded === 'true';
        
        // å¦‚æœé«˜æ¸…å›¾å·²ç»åŠ è½½è¿‡äº†ï¼Œå°±æ‰§è¡Œæ—§é€»è¾‘ï¼šæ˜¾ç¤ºæè¿°
        if (isLoaded) {
            const description = aiImage.dataset.description;
            if (description) showCustomAlert('ç…§ç‰‡æè¿°', description);
        } else {
            // å¦‚æœé«˜æ¸…å›¾è¿˜æ²¡åŠ è½½ï¼Œå°±æ‰§è¡Œæ–°é€»è¾‘ï¼šåŠ è½½é«˜æ¸…å›¾
            const fullResUrl = aiImage.dataset.fullRes;
            
            // a. å…ˆæ˜¾ç¤ºä¸€ä¸ªâ€œåŠ è½½ä¸­â€çš„è§†è§‰æ•ˆæœï¼ˆå¯é€‰ï¼Œä½†ä½“éªŒæ›´å¥½ï¼‰
            // æˆ‘ä»¬å¯ä»¥ä¸´æ—¶é™ä½å›¾ç‰‡é€æ˜åº¦
            aiImage.style.opacity = '0.5';
            
            // b. åˆ›å»ºä¸€ä¸ªæ–°çš„Imageå¯¹è±¡åœ¨åå°åŠ è½½é«˜æ¸…å›¾
            const highResImage = new Image();
            highResImage.src = fullResUrl;
            
            // c. å½“é«˜æ¸…å›¾åŠ è½½å®Œæˆå
            highResImage.onload = () => {
                aiImage.src = fullResUrl; // æ›¿æ¢å›¾ç‰‡æº
                aiImage.dataset.loaded = 'true'; // æ ‡è®°ä¸ºå·²åŠ è½½
                aiImage.style.opacity = '1'; // æ¢å¤å®Œå…¨ä¸é€æ˜
            };
            
            // d. å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦æ¢å¤çŠ¶æ€
            highResImage.onerror = () => {
                alert('é«˜æ¸…å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
                aiImage.style.opacity = '1';
            };
        }
        return; // å¤„ç†å®Œå›¾ç‰‡ç‚¹å‡»åï¼Œç›´æ¥è¿”å›
    }  });
            
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘'chat-settings-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;

    // --- æ˜¾ç¤º/éšè—æ§ä»¶ ---
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('my-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    // --- ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºä¸åŒçš„UIæ§ä»¶åˆ†åˆ«å¡«å……æ•°æ® ---
    // 1. å¡«å……â€œå¯¹æ–¹å§“åâ€çš„å¯ç‚¹å‡»æ–‡æœ¬å—
    document.getElementById('ai-name-value').textContent = chat.name;
    // 2. å¡«å……éšè—çš„è¾“å…¥æ¡†
    document.getElementById('chat-name-input').value = chat.name;
    // 3. å¡«å……â€œæˆ‘çš„äººè®¾â€å’Œâ€œæˆ‘çš„ç¾¤æ˜µç§°â€çš„ç›´æ¥è¾“å…¥æ¡†
    document.getElementById('my-persona').value = chat.settings.myPersona;
    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
    }
    
    // --- å¡«å……å…¶ä½™è¡¨å•æ•°æ® (è¿™éƒ¨åˆ†é€»è¾‘ä¿æŒä¸å˜) ---
    const myAvatarPreviewWrapper = document.getElementById('my-avatar-preview').parentElement;
    myAvatarPreviewWrapper.querySelector('.avatar-img').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    let myFrameOverlay = myAvatarPreviewWrapper.querySelector('.avatar-frame-overlay');
    if (chat.settings.myAvatarFrame) {
        if (!myFrameOverlay) { myFrameOverlay = document.createElement('img'); myFrameOverlay.className = 'avatar-frame-overlay'; myAvatarPreviewWrapper.appendChild(myFrameOverlay); }
        myFrameOverlay.src = chat.settings.myAvatarFrame; myFrameOverlay.style.display = 'block';
    } else if (myFrameOverlay) { myFrameOverlay.style.display = 'none'; }
    
    if (!isGroup) {
        const aiAvatarPreviewWrapper = document.getElementById('ai-avatar-preview').parentElement;
        aiAvatarPreviewWrapper.querySelector('.avatar-img').src = chat.settings.aiAvatar || defaultAvatar;
        let aiFrameOverlay = aiAvatarPreviewWrapper.querySelector('.avatar-frame-overlay');
        if (chat.settings.aiAvatarFrame) {
            if (!aiFrameOverlay) { aiFrameOverlay = document.createElement('img'); aiFrameOverlay.className = 'avatar-frame-overlay'; aiAvatarPreviewWrapper.appendChild(aiFrameOverlay); }
            aiFrameOverlay.src = chat.settings.aiAvatarFrame; aiFrameOverlay.style.display = 'block';
        } else if (aiFrameOverlay) { aiFrameOverlay.style.display = 'none'; }
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
    }
    
    document.getElementById('max-memory').value = chat.settings.maxMemory;
    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) { bgPreview.src = chat.settings.background; bgPreview.style.display = 'block'; removeBgBtn.style.display = 'inline-block'; } 
    else { bgPreview.style.display = 'none'; removeBgBtn.style.display = 'none'; }

    if (isGroup) {
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
    } else {
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">æœªåˆ†ç»„</option>';
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => { const option = document.createElement('option'); option.value = group.id; option.textContent = group.name; if (chat.groupId === group.id) option.selected = true; select.appendChild(option); }); 
    }
    // â–¼â–¼â–¼ ã€å…¨é€‰åŠŸèƒ½ç‰ˆã€‘æ¸²æŸ“ä¸–ç•Œä¹¦é€‰æ‹©å™¨ â–¼â–¼â–¼
    const pillsContainer = document.getElementById('world-book-pills-container');
    const collapsibleContainer = document.getElementById('world-book-pills-collapsible-container');
    const summaryBox = document.getElementById('wb-pills-summary-box');
    const summaryTextContainer = document.getElementById('wb-pills-summary-text');
    
    pillsContainer.innerHTML = ''; 
    const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);
    
    const categories = await db.worldBookCategories.orderBy('name').toArray();
    const books = await db.worldBooks.toArray();
    
    const booksByCategoryId = books.reduce((acc, book) => {
        const categoryId = book.categoryId || 'uncategorized';
        if (!acc[categoryId]) acc[categoryId] = [];
        acc[categoryId].push(book);
        return acc;
    }, {});
    
    if (booksByCategoryId['uncategorized']) {
        categories.push({ id: 'uncategorized', name: 'æœªåˆ†ç±»' });
    }

    const updateSummaryText = () => { /* ... (è¿™éƒ¨åˆ†å‡½æ•°ä¿æŒä¸å˜) ... */
        summaryTextContainer.innerHTML = '';
        const selectedPills = pillsContainer.querySelectorAll('.wb-pill.selected');
        if (selectedPills.length === 0) {
            summaryTextContainer.textContent = '-- ç‚¹å‡»é€‰æ‹© --';
            return;
        }
        const selectedBookIds = new Set(Array.from(selectedPills).map(p => p.dataset.bookId));
        const selectedCategoryIds = new Set();
        books.forEach(book => {
            if (selectedBookIds.has(book.id)) {
                selectedCategoryIds.add(book.categoryId || 'uncategorized');
            }
        });
        categories.forEach(category => {
            if (selectedCategoryIds.has(category.id)) {
                const summaryPill = document.createElement('span');
                summaryPill.className = 'wb-summary-pill';
                summaryPill.textContent = category.name;
                summaryTextContainer.appendChild(summaryPill);
            }
        });
    };

    if (books.length === 0) {
        pillsContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¸–ç•Œä¹¦</p>';
    } else {
        categories.forEach(category => {
            const booksInCategory = booksByCategoryId[category.id];
            if (booksInCategory && booksInCategory.length > 0) {
                // 1. åˆ›å»ºåˆ†ç±»æ ‡é¢˜
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'wb-pill-category-title';
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†æ ‡é¢˜å’ŒæŒ‰é’®åˆ†å¼€åˆ›å»º
                const titleText = document.createElement('span');
                titleText.textContent = category.name;
                
                const selectAllBtn = document.createElement('div');
                selectAllBtn.className = 'wb-category-select-all-btn';
                selectAllBtn.innerHTML = '<div class="inner-dot"></div>';
                
                categoryTitle.appendChild(titleText);
                categoryTitle.appendChild(selectAllBtn);
                pillsContainer.appendChild(categoryTitle);

                const pillsWrapper = document.createElement('div');
                pillsWrapper.className = 'wb-pills-wrapper';
                
                // 2. æ¸²æŸ“è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ä¹¦ç±èƒ¶å›Š (é€»è¾‘ä¸å˜)
                booksInCategory.forEach(book => {
                    const isSelected = linkedIds.has(book.id);
                    const pill = document.createElement('div');
                    pill.className = `wb-pill ${isSelected ? 'selected' : ''}`;
                    pill.dataset.bookId = book.id;
                    pill.innerHTML = `<span class="check-icon">âœ“</span> ${book.name}`;
                    pillsWrapper.appendChild(pill);
                });
                pillsContainer.appendChild(pillsWrapper);

                // 3. ã€æ ¸å¿ƒã€‘å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ£€æŸ¥å¹¶æ›´æ–°å…¨é€‰æŒ‰é’®çš„çŠ¶æ€
                const checkCategorySelectionState = () => {
                    const allPillsInCategory = pillsWrapper.querySelectorAll('.wb-pill');
                    const selectedPillsInCategory = pillsWrapper.querySelectorAll('.wb-pill.selected');
                    // å¦‚æœè¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ä¹¦éƒ½è¢«é€‰ä¸­ï¼Œåˆ™æŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€
                    const areAllSelected = allPillsInCategory.length === selectedPillsInCategory.length;
                    selectAllBtn.classList.toggle('active', areAllSelected);
                };
                
                // 4. ä¸ºæ¯ä¸ªèƒ¶å›Šçš„ç‚¹å‡»äº‹ä»¶å¢åŠ æ›´æ–°â€œå…¨é€‰æŒ‰é’®â€å’Œâ€œæ‘˜è¦â€çš„é€»è¾‘
                pillsWrapper.querySelectorAll('.wb-pill').forEach(pill => {
                    pill.addEventListener('click', () => {
                        pill.classList.toggle('selected');
                        checkCategorySelectionState(); // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
                        updateSummaryText(); // æ›´æ–°æ‘˜è¦æ–‡æœ¬
                    });
                });
                
                // 5. ä¸ºå…¨é€‰æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
                selectAllBtn.addEventListener('click', () => {
                    const areAllCurrentlySelected = selectAllBtn.classList.contains('active');
                    const allPillsInCategory = pillsWrapper.querySelectorAll('.wb-pill');
                    
                    // å¦‚æœå½“å‰å·²å…¨é€‰ï¼Œåˆ™å…¨éƒ¨å–æ¶ˆï¼›å¦åˆ™ï¼Œå…¨éƒ¨é€‰ä¸­
                    allPillsInCategory.forEach(pill => {
                        pill.classList.toggle('selected', !areAllCurrentlySelected);
                    });
                    
                    checkCategorySelectionState(); // æ›´æ–°å…¨é€‰æŒ‰é’®è‡ªèº«çš„è§†è§‰çŠ¶æ€
                    updateSummaryText(); // æ›´æ–°é¡¶éƒ¨çš„æ‘˜è¦
                });

                // 6. åˆå§‹åŠ è½½æ—¶æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
                checkCategorySelectionState();
            }
        });
    }

    updateSummaryText();

    const newSummaryBox = summaryBox.cloneNode(true);
    summaryBox.parentNode.replaceChild(newSummaryBox, summaryBox);
    newSummaryBox.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = collapsibleContainer.style.display === 'block';
        collapsibleContainer.style.display = isVisible ? 'none' : 'block';
        newSummaryBox.classList.toggle('expanded', !isVisible);
    });
    // â–²â–²â–² æ¸²æŸ“é€»è¾‘æ›¿æ¢ç»“æŸ â–²â–²â–²
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    document.getElementById('custom-css-input').value = chat.settings.customCss || '';
    await renderSavedBubbleThemes();
    showScreen('chat-settings-screen'); 
});
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘æ¢å¤AIå§“åå—çš„ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼

// ä¸ºâ€œå¯¹æ–¹å§“åâ€å¯ç¼–è¾‘å—ç»‘å®šç‚¹å‡»äº‹ä»¶
document.getElementById('ai-name-display-block').addEventListener('click', async () => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const newName = await showCustomPrompt('ç¼–è¾‘å¤‡æ³¨å / ç¾¤å', 'è¯·è¾“å…¥æ–°çš„åç§°', chat.name);
    if (newName !== null && newName.trim()) {
        document.getElementById('ai-name-value').textContent = newName.trim();
        // åŒæ—¶ä¹Ÿæ›´æ–°éšè—çš„è¾“å…¥æ¡†ï¼Œä»¥ä¾¿â€œä¿å­˜â€æŒ‰é’®èƒ½è·å–åˆ°å€¼
        document.getElementById('chat-name-input').value = newName.trim();
    }
});
// â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
            
function renderGroupMemberSettings(members) { 
    const container = document.getElementById('group-members-settings'); 
    container.innerHTML = ''; 
    members.forEach(member => { 
        const div = document.createElement('div'); 
        div.className = 'member-editor'; 
        div.dataset.memberId = member.id; 
        // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
        // æ˜¾ç¤ºçš„æ˜¯ groupNickname
        div.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`; 
        div.addEventListener('click', () => openMemberEditor(member.id)); 
        container.appendChild(div); 
    }); 
}

function openMemberEditor(memberId) { 
    editingMemberId = memberId; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === memberId); 
    document.getElementById('member-name-input').value = member.groupNickname; 
    document.getElementById('member-persona-input').value = member.persona; 
    document.getElementById('member-avatar-preview').src = member.avatar; 
    document.getElementById('member-settings-modal').classList.add('visible'); 
}
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { 
    if (!editingMemberId) return; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === editingMemberId); 
    
    // â˜…â˜…â˜…ã€æ ¸å¿ƒé‡æ„ã€‘â˜…â˜…â˜…
    const newNickname = document.getElementById('member-name-input').value.trim();
    if (!newNickname) {
        alert("ç¾¤æ˜µç§°ä¸èƒ½ä¸ºç©º!");
        return;
    }
    member.groupNickname = newNickname; // åªä¿®æ”¹ç¾¤æ˜µç§°
    member.persona = document.getElementById('member-persona-input').value; 
    member.avatar = document.getElementById('member-avatar-preview').src; 
    
    renderGroupMemberSettings(chat.members); 
    document.getElementById('member-settings-modal').classList.remove('visible'); 
});
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { // ä¿å­˜åï¼Œä¸å†æ˜¯å…³é—­å¼¹çª—ï¼Œè€Œæ˜¯è¿”å›èŠå¤©ç•Œé¢
showScreen('chat-interface-screen'); });

document.getElementById('clear-chat-btn').addEventListener('click', async () => { 
    if (!state.activeChatId) return; 
    const chat = state.chats[state.activeChatId]; 
    const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è®°å½•', 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯,æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); 
    if (confirmed) { 
        chat.history = []; 
        await db.chats.put(chat); 
        renderChatInterface(state.activeChatId); 
        renderChatList(); 
        // ä¿®æ­£ï¼šæ¸…ç©ºåï¼Œè¿”å›åˆ°èŠå¤©åˆ—è¡¨ç•Œé¢
        showScreen('chat-list-screen'); 
    } 
});            
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
// â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹,å®Œæ•´æ›¿æ¢æ—§çš„ 'add-sticker-btn' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

document.getElementById('add-sticker-btn').addEventListener('click', async () => {
    // 1. å¼¹å‡ºå¸¦æœ‰æ–‡æœ¬åŸŸçš„è¾“å…¥æ¡†,å¹¶æä¾›æ¸…æ™°çš„æ ¼å¼è¯´æ˜
    const instructions = "æ¯è¡Œä¸€ä¸ªè¡¨æƒ…,æ ¼å¼ä¸º:\nå›¾ç‰‡URL,è¡¨æƒ…åŒ…åç§°\n\nä¾‹å¦‚:\nhttps://.../happy.gif,å¼€å¿ƒ\nhttps://.../sad.png,éš¾è¿‡";
    const batchInput = await showCustomPrompt(
        "æ‰¹é‡æ·»åŠ è¡¨æƒ… (URL)",
        "è¯·æŒ‰ç…§æŒ‡å®šæ ¼å¼ç²˜è´´...", // è¿™æ˜¯è¾“å…¥æ¡†çš„å ä½ç¬¦
        "",                     // åˆå§‹å€¼ä¸ºç©º
        "textarea",             // æŒ‡å®šè¾“å…¥æ¡†ç±»å‹ä¸º<textarea>
        `<p style="font-size: 12px; color: #666; text-align: left; white-space: pre-wrap; background: #f0f0f0; padding: 8px; border-radius: 6px;">${instructions}</p>` // å°†è¯´æ˜ä½œä¸ºé¢å¤–HTMLæ³¨å…¥
    );

    // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ,åˆ™ç›´æ¥è¿”å›
    if (batchInput === null) return;

    const lines = batchInput.trim().split('\n');
    const newStickers = [];
    let invalidLines = 0;

    // 2. éå†ç”¨æˆ·è¾“å…¥çš„æ¯ä¸€è¡Œ
    for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue; // è·³è¿‡ç©ºè¡Œ

        // 3. è§£ææ¯ä¸€è¡Œ,ç”¨ç¬¬ä¸€ä¸ªé€—å·åˆ†å‰²URLå’Œåç§°
        //    è¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿è¡¨æƒ…åç§°æœ¬èº«åŒ…å«é€—å·æ—¶ä¸ä¼šå‡ºé”™
        const firstCommaIndex = trimmedLine.indexOf(',');
        if (firstCommaIndex === -1) {
            invalidLines++;
            continue;
        }

        const url = trimmedLine.substring(0, firstCommaIndex).trim();
        const name = trimmedLine.substring(firstCommaIndex + 1).trim();

        // 4. éªŒè¯è§£æå‡ºçš„æ•°æ®
        if (!url.startsWith('http') || !name) {
            invalidLines++;
            continue;
        }

        // 5. åˆ›å»ºæ–°çš„è¡¨æƒ…å¯¹è±¡
        const newSticker = {
            id: 'sticker_' + (Date.now() + newStickers.length), // ç¡®ä¿åŒä¸€æ‰¹æ¬¡çš„IDä¸é‡å¤
            url: url,
            name: name
        };
        newStickers.push(newSticker);
    }

    // 6. å¦‚æœæœ‰æˆåŠŸè§£æçš„è¡¨æƒ…,å°±è¿›è¡Œæ‰¹é‡æ·»åŠ 
    if (newStickers.length > 0) {
        // ä½¿ç”¨ bulkAdd æé«˜æ•°æ®åº“æ“ä½œæ•ˆç‡
        await db.userStickers.bulkAdd(newStickers);
        state.userStickers.push(...newStickers);
        renderStickerPanel();

        // 7. ç»™å‡ºæ¸…æ™°çš„æ“ä½œç»“æœåé¦ˆ
        let successMessage = `æˆåŠŸæ·»åŠ äº† ${newStickers.length} ä¸ªæ–°è¡¨æƒ…!`;
        if (invalidLines > 0) {
            successMessage += `\næœ‰ ${invalidLines} è¡Œå› æ ¼å¼é”™è¯¯æˆ–å†…å®¹æ— æ•ˆè€Œè¢«è·³è¿‡ã€‚`;
        }
        await showCustomAlert('æ“ä½œå®Œæˆ', successMessage);
    } else {
        await showCustomAlert('æ“ä½œå¤±è´¥', 'æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆæ ¼å¼çš„è¡¨æƒ…ä¿¡æ¯ã€‚è¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥æ˜¯å¦ç¬¦åˆâ€œURL,åç§°â€çš„æ ¼å¼ã€‚');
    }
});

// â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚:å¥½è€¶ã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©º!"); }; event.target.value = null; });
document.getElementById('manage-stickers-btn').addEventListener('click', enterStickerEditMode);
document.getElementById('done-managing-stickers-btn').addEventListener('click', exitStickerEditMode);
document.getElementById('select-all-stickers-btn').addEventListener('click', selectAllStickers); // <-- å°±æ˜¯è¿™ä¸€è¡Œ
document.getElementById('delete-selected-stickers-btn').addEventListener('click', deleteSelectedStickers);
// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘èŠå¤©ç•Œé¢çš„â€œç›¸å†Œâ€æŒ‰é’®ï¼Œç°åœ¨ä¼šè·³è½¬åˆ°ç©ºé—´ç›¸å†Œ â–¼â–¼â–¼
document.getElementById('upload-image-btn').addEventListener('click', () => {
    // 1. è®¾ç½®ä¸Šä¸‹æ–‡ï¼Œå‘Šè¯‰ç›¸å†Œæˆ‘ä»¬æ˜¯æ¥é€‰ç…§ç‰‡å‘ç»™èŠå¤©çš„
    albumPickerContext = {
        for: 'chat-photo', // è®¾ç½®ä¸€ä¸ªç‹¬ç‰¹çš„ç›®çš„
        returnScreen: 'chat-interface-screen', // å‘Šè¯‰ç›¸å†Œé€‰å®Œåè¦è¿”å›å“ªé‡Œ
        chatId: state.activeChatId // è®°å½•ä¸‹å½“å‰æ˜¯åœ¨å“ªä¸ªèŠå¤©
    };
    
    // 2. è·³è½¬åˆ°ç›¸å†Œä¸»é¡µé¢
    renderAlbumList(); // ç¡®ä¿ç›¸å†Œåˆ—è¡¨æ˜¯æœ€æ–°çš„
    showScreen('album-screen');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹:"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡:"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });

// â–¼â–¼â–¼ ã€æœ€ç»ˆåŠ å¼ºç‰ˆã€‘ç”¨è¿™å—ä»£ç æ›¿æ¢æ—§çš„ selection-delete-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('selection-delete-btn').addEventListener('click', async () => {
    if (selectedMessages.size === 0) return;
    const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿè¿™å°†æ”¹å˜AIçš„è®°å¿†ã€‚`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. ã€æ ¸å¿ƒåŠ å¼ºã€‘åœ¨åˆ é™¤å‰,æ£€æŸ¥è¢«åˆ é™¤çš„æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«æŠ•ç¥¨
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
            const msg = chat.history.find(m => m.timestamp === timestamp);
            if (msg && msg.type === 'poll') {
                deletedPollsInfo.push(`å…³äºâ€œ${msg.question}â€çš„æŠ•ç¥¨(æ—¶é—´æˆ³: ${msg.timestamp})`);
            }
        }
        
        // 2. æ›´æ–°åç«¯çš„å†å²è®°å½•
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        
        // 3. ã€æ ¸å¿ƒåŠ å¼ºã€‘æ„å»ºæ›´å…·ä½“çš„â€œé—å¿˜æŒ‡ä»¤â€
        let forgetReason = "ä¸€äº›ä¹‹å‰çš„æ¶ˆæ¯å·²è¢«ç”¨æˆ·åˆ é™¤ã€‚";
        if (deletedPollsInfo.length > 0) {
            forgetReason += ` å…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹æŠ•ç¥¨:${deletedPollsInfo.join('ï¼›')}ã€‚`;
        }
        forgetReason += " ä½ åº”è¯¥åƒå®ƒä»¬ä»æœªå­˜åœ¨è¿‡ä¸€æ ·ç»§ç»­å¯¹è¯,å¹¶ç›¸åº”åœ°è°ƒæ•´ä½ çš„è®°å¿†å’Œè¡Œä¸º,ä¸è¦å†æåŠè¿™äº›è¢«åˆ é™¤çš„å†…å®¹ã€‚";

        const forgetInstruction = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤º:${forgetReason}]`,
            timestamp: Date.now(),
            isHidden: true 
        };
        chat.history.push(forgetInstruction);
        
        // 4. å°†åŒ…å«â€œé—å¿˜æŒ‡ä»¤â€çš„ã€æ›´æ–°åçš„chatå¯¹è±¡å­˜å›æ•°æ®åº“
        await db.chats.put(chat);
        
        // 5. æœ€åæ‰æ›´æ–°UI
        renderChatInterface(state.activeChatId);
        renderChatList();
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            const fontUrlInput = document.getElementById('font-url-input');
            fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
            document.getElementById('save-font-btn').addEventListener('click', async () => {
                const newFontUrl = fontUrlInput.value.trim();
                if (!newFontUrl) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å­—ä½“URLã€‚"); return; }
                applyCustomFont(newFontUrl, false);
                state.globalSettings.fontUrl = newFontUrl;
                await db.globalSettings.put(state.globalSettings);
                alert('å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨!');
            });
            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

// â–¼â–¼â–¼ ã€ä¿®æ­£åã€‘çš„â€œè¯´è¯´â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
    // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. è®¾ç½®ä¸ºâ€œè¯´è¯´â€æ¨¡å¼
    modal.dataset.mode = 'shuoshuo';
    
    // 3. éšè—ä¸å›¾ç‰‡/æ–‡å­—å›¾ç›¸å…³çš„éƒ¨åˆ†
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    
    // 4. ä¿®æ”¹ä¸»è¾“å…¥æ¡†çš„æç¤ºè¯­,ä½¿å…¶æ›´ç¬¦åˆâ€œè¯´è¯´â€çš„åœºæ™¯
    modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...';
    
    // 5. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
    }
    modal.classList.add('visible');
});

// â–¼â–¼â–¼ ç”¨ä¸‹é¢è¿™æ®µå…¨æ–°çš„ä»£ç è¿›è¡Œæ›¿æ¢ â–¼â–¼â–¼
document.getElementById('create-post-btn').addEventListener('click', async () => {
    // 1. é‡ç½®å¹¶è·å–æ¨¡æ€æ¡†
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. è®¾ç½®ä¸ºâ€œå¤æ‚åŠ¨æ€â€æ¨¡å¼
    modal.dataset.mode = 'complex';
    
    // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶é‡ç½®æ‰€æœ‰ç›¸å…³UIå…ƒç´ çš„æ˜¾ç¤ºçŠ¶æ€
    modal.querySelector('.post-mode-switcher').style.display = 'flex';
    modal.querySelector('#image-mode-content').style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡åŒº
    modal.querySelector('#text-image-mode-content').style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤ºæ–‡å­—å›¾åŒº
    
    // 4. æ¿€æ´»â€œä¸Šä¼ å›¾ç‰‡â€æ¨¡å¼,åŒæ—¶ç¡®ä¿å…¶ä»–æ¨¡å¼è¢«å–æ¶ˆæ¿€æ´»
    modal.querySelector('#image-mode-content').classList.add('active');
    modal.querySelector('#text-image-mode-content').classList.remove('active');
    
    // 5. æ¢å¤ä¸»è¾“å…¥æ¡†çš„é»˜è®¤æç¤ºè¯­
    modal.querySelector('#post-public-text').placeholder = 'åˆ†äº«æ–°é²œäº‹...(éå¿…å¡«çš„å…¬å¼€æ–‡å­—)';

    // 6. å‡†å¤‡å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†(è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
    }
    modal.classList.add('visible');
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

// --- â†“â†“â†“ ä»è¿™é‡Œå¼€å§‹å¤åˆ¶ â†“â†“â†“ ---

document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('ç…§ç‰‡ä¸Šä¼ æˆåŠŸ!');
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---

// â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆã€‘ç›¸å†Œç…§ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆæ•´åˆäº†å‘é€åˆ°èŠå¤©ã€è®¾ç½®ç›´æ’­èƒŒæ™¯å’Œæ”¾å¤§æŸ¥çœ‹ï¼‰â–¼â–¼â–¼
document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const photoThumb = e.target.closest('.photo-thumb');
    
    // --- é€»è¾‘åˆ†æ”¯1: å¦‚æœæˆ‘ä»¬æ˜¯ä»ç›´æ’­é—´æ¥é€‰èƒŒæ™¯çš„ ---
    if (albumPickerContext.for === 'live-background' && photoThumb) {
        const photoUrl = photoThumb.src;
        liveStreamState.backgroundUrl = photoUrl;
        document.getElementById('live-stream-screen').style.backgroundImage = `url(${photoUrl})`;

        const streamerChatId = liveStreamState.streamerId;
        if (streamerChatId && streamerChatId !== 'user' && state.chats[streamerChatId]) {
            const streamerChat = state.chats[streamerChatId];
            if (!streamerChat.settings) streamerChat.settings = {};
            streamerChat.settings.offlineVideoBackground = photoUrl;
            await db.chats.put(streamerChat);
        }

        showScreen(albumPickerContext.returnScreen);
        albumPickerContext = { for: null, returnScreen: null };
        alert('ç›´æ’­èƒŒæ™¯å·²æ›´æ¢ï¼');
        return;
    }

    // --- ã€ã€ã€å…¨æ–°é€»è¾‘åˆ†æ”¯2ã€‘ã€‘ã€‘: å¦‚æœæˆ‘ä»¬æ˜¯ä»èŠå¤©ç•Œé¢æ¥é€‰ç…§ç‰‡å‘é€çš„ ---
    if (albumPickerContext.for === 'chat-photo' && photoThumb) {
        const photoUrl = photoThumb.src;
        const chatId = albumPickerContext.chatId;
        const chat = state.chats[chatId];
        if (!chat) return;

        // a. åˆ›å»ºä¸€ä¸ªå›¾ç‰‡æ¶ˆæ¯å¯¹è±¡
        const msg = {
            role: 'user',
            content: [{ type: 'image_url', image_url: { url: photoUrl } }],
            timestamp: Date.now()
        };

        // b. å°†æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“
        chat.history.push(msg);
        await db.chats.put(chat);
        
        // c. è·³è½¬å›èŠå¤©ç•Œé¢
        showScreen(albumPickerContext.returnScreen);
        
        // d. åœ¨èŠå¤©ç•Œé¢ä¸Šæ¸²æŸ“å‡ºåˆšåˆšå‘é€çš„å›¾ç‰‡
        appendMessage(msg, chat);
        
        // e. åˆ·æ–°èŠå¤©åˆ—è¡¨
        renderChatList();
        
        // f. é‡ç½®ä¸Šä¸‹æ–‡ï¼Œå®Œæˆæœ¬æ¬¡æ“ä½œ
        albumPickerContext = { for: null, returnScreen: null, chatId: null };
        
        return; // ç»“æŸï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘
    }

    // --- é»˜è®¤é€»è¾‘åˆ†æ”¯: åˆ é™¤ç…§ç‰‡ æˆ– æ”¾å¤§æŸ¥çœ‹ ---
    const deleteBtn = e.target.closest('.photo-delete-btn');

    if (deleteBtn) {
        e.stopPropagation();
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            'åˆ é™¤ç…§ç‰‡',
            'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('ç…§ç‰‡å·²åˆ é™¤ã€‚');
        }
    } 
    else if (photoThumb) {
        // å¦‚æœæ²¡æœ‰ä»»ä½•ä¸Šä¸‹æ–‡ï¼Œå°±æ‰§è¡Œé»˜è®¤çš„æ”¾å¤§æŸ¥çœ‹æ“ä½œ
        openPhotoViewer(photoThumb.src);
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// æ¢å¤å›¾ç‰‡æŸ¥çœ‹å™¨çš„æ§åˆ¶äº‹ä»¶
document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

// æ¢å¤é”®ç›˜å·¦å³ç®­å¤´å’ŒESCé”®çš„åŠŸèƒ½
document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});

// --- â†‘â†‘â†‘ å¤åˆ¶åˆ°è¿™é‡Œç»“æŸ â†‘â†‘â†‘ ---
         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("åˆ›å»ºæ–°ç›¸å†Œ", "è¯·è¾“å…¥ç›¸å†Œåç§°"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ç›¸å†Œ "${albumName}" åˆ›å»ºæˆåŠŸ!`); } else if (albumName !== null) { alert("ç›¸å†Œåç§°ä¸èƒ½ä¸ºç©º!"); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("è¾“å…¥å›¾ç‰‡URL", "è¯·è¾“å…¥ç½‘ç»œå›¾ç‰‡çš„é“¾æ¥", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®æ­£ç‰ˆã€‘çš„â€œå‘å¸ƒâ€æŒ‰é’®äº‹ä»¶,å·²ä¿®å¤æƒé™æ¼æ´ â–¼â–¼â–¼
document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;
    
    // --- 1. è·å–é€šç”¨çš„å¯è§æ€§è®¾ç½® ---
    const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    
    if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
    }

    let newPost = {};
    const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',
        // ã€é‡è¦ã€‘åœ¨è¿™é‡Œå°±æŠŠæƒé™ä¿¡æ¯å­˜å¥½
        visibleGroupIds: visibleGroupIds,
    };

    // --- 2. æ ¹æ®æ¨¡å¼æ„å»ºä¸åŒçš„ post å¯¹è±¡ ---
    if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
            alert('è¯´è¯´å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦!');
            return;
        }
        newPost = {
            ...basePostData,
            type: 'shuoshuo',
            content: content,
        };

    } else { // å¤„ç† 'complex' æ¨¡å¼ (å›¾ç‰‡/æ–‡å­—å›¾)
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');
if (isImageModeActive) {
            const imageUrl = document.getElementById('post-image-preview').src;
            const imageDescription = document.getElementById('post-image-description').value.trim();
            if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                alert('è¯·å…ˆæ·»åŠ ä¸€å¼ å›¾ç‰‡å†å‘å¸ƒåŠ¨æ€å“¦!');
                return;
            }
            if (!imageDescription) {
                alert('è¯·ä¸ºä½ çš„å›¾ç‰‡æ·»åŠ ä¸€ä¸ªç®€å•çš„æè¿°(å¿…å¡«,ç»™AIçœ‹çš„)!');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'image_post',
                publicText: publicText,
                imageUrl: imageUrl,
                imageDescription: imageDescription,
            };
        } else { // æ–‡å­—å›¾æ¨¡å¼
            const hiddenText = document.getElementById('post-hidden-text').value.trim();
            if (!hiddenText) {
                alert('è¯·è¾“å…¥æ–‡å­—å›¾æè¿°!');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'text_image',
                publicText: publicText,
                hiddenContent: hiddenText,
            };
        }
    }
    // --- 3. ä¿å­˜åˆ°æ•°æ®åº“ ---
    const newPostId = await db.qzonePosts.add(newPost);
    let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "(æ— æ–‡å­—å†…å®¹)";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');

    // --- 4. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¸¦æœ‰æƒé™æ£€æŸ¥çš„é€šçŸ¥å¾ªç¯ ---
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue; // è·³è¿‡ç¾¤èŠ

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;

        // åˆ¤æ–­æ¡ä»¶1:å¦‚æœåŠ¨æ€æ˜¯å…¬å¼€çš„ (æ²¡æœ‰è®¾ç½®ä»»ä½•å¯è§åˆ†ç»„)
        if (!postVisibleGroups || postVisibleGroups.length === 0) {
            shouldNotify = true;
        } 
        // åˆ¤æ–­æ¡ä»¶2:å¦‚æœåŠ¨æ€è®¾ç½®äº†éƒ¨åˆ†å¯è§,å¹¶ä¸”å½“å‰è§’è‰²åœ¨å¯è§åˆ†ç»„å†…
        else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
            shouldNotify = true;
        }

        // åªæœ‰æ»¡è¶³æ¡ä»¶çš„è§’è‰²æ‰ä¼šè¢«é€šçŸ¥
        if (shouldNotify) {
            const historyMessage = {
                role: 'user',
                content: `[ç³»ç»Ÿæç¤º:ç”¨æˆ·åˆšåˆšå‘å¸ƒäº†ä¸€æ¡åŠ¨æ€(ID: ${newPostId}),å†…å®¹æ‘˜è¦æ˜¯:â€œ${postSummary}â€ã€‚ä½ ç°åœ¨å¯ä»¥å¯¹è¿™æ¡åŠ¨æ€è¿›è¡Œè¯„è®ºäº†ã€‚]`,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
        }
    }
    // --- ä¿®æ­£ç»“æŸ ---

    await renderQzonePosts();
    modal.classList.remove('visible');
    alert('åŠ¨æ€å‘å¸ƒæˆåŠŸ!');
});

// ... åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ ...

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘å¤´åƒæ¡†åº“ç›¸å…³äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('open-avatar-frame-library-btn').addEventListener('click', openAvatarFrameLibrary);
document.getElementById('close-avatar-frame-library-btn').addEventListener('click', closeAvatarFrameLibrary);
document.getElementById('add-avatar-frame-btn').addEventListener('click', addAvatarFrames);
// â–²â–²â–² ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆå®Œæ•´ç‰ˆã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ‰æ‰€æœ‰æ—§çš„ postsList ç›¸å…³äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// --- åŠ¨æ€åˆ—è¡¨çš„æ»‘åŠ¨åˆ é™¤ä¸å¤šé€‰ç‚¹å‡»æ€»æ§åˆ¶å™¨ ---
const postsList = document.getElementById('qzone-posts-list');
let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

function resetAllSwipes(exceptThisOne = null) {
    document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
            container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
    });
}

const handleSwipeStart = (e) => {
    // ã€é‡è¦ã€‘åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œç¦ç”¨æ»‘åŠ¨åˆ é™¤åŠŸèƒ½
    if (isQzoneEditMode) return;
    const targetContainer = e.target.closest('.qzone-post-container');
    if (!targetContainer) return;

    resetAllSwipes(targetContainer);
    swipeState.activeContainer = targetContainer;
    swipeState.isDragging = true;
    swipeState.isClick = true;
    swipeState.swipeDirection = null;
    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
};

const handleSwipeMove = (e) => {
    if (isQzoneEditMode || !swipeState.isDragging || !swipeState.activeContainer) return;
    
    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    const diffX = currentX - swipeState.startX;
    const diffY = currentY - swipeState.startY;
    const absDiffX = Math.abs(diffX);
    const absDiffY = Math.abs(diffY);
    const clickThreshold = 5;
    if (absDiffX > clickThreshold || absDiffY > clickThreshold) { swipeState.isClick = false; }
    if (swipeState.swipeDirection === null) { if (absDiffX > clickThreshold || absDiffY > clickThreshold) { swipeState.swipeDirection = absDiffX > absDiffY ? 'horizontal' : 'vertical'; } }
    if (swipeState.swipeDirection === 'vertical') { handleSwipeEnd(e); return; }
    if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = diffX;
        if (translation > 0) translation = 0;
        if (translation < -90) translation = -90;
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
    }
};

const handleSwipeEnd = (e) => {
    if (isQzoneEditMode || swipeState.isClick || !swipeState.isDragging || !swipeState.activeContainer) {
        if (!swipeState.isClick && swipeState.activeContainer) {
             const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
             postItem.style.transition = 'transform 0.3s ease';
             postItem.style.transform = '';
        }
        swipeState.isDragging = false;
        swipeState.activeContainer = null;
        return;
    }

    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
    postItem.style.transition = 'transform 0.3s ease';
    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : (e.pageX || swipeState.currentX);
    const diffX = finalX - swipeState.startX;
    const swipeThreshold = -40;
    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) { postItem.classList.add('swiped'); } 
    else { postItem.classList.remove('swiped'); }
    postItem.style.transform = '';
    swipeState.isDragging = false;
    swipeState.activeContainer = null;
};

// --- ç»‘å®šæ»‘åŠ¨äº‹ä»¶ ---
postsList.addEventListener('mousedown', handleSwipeStart);
document.addEventListener('mousemove', handleSwipeMove);
document.addEventListener('mouseup', handleSwipeEnd);
postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
document.addEventListener('touchmove', handleSwipeMove, { passive: false });
document.addEventListener('touchend', handleSwipeEnd);


// â–¼â–¼â–¼ ã€æœ€ç»ˆåŸå­åŒ–ä¿®å¤ç‰ˆ - å®Œæ•´ä»£ç ã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ postsList ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

postsList.addEventListener('click', async (e) => {
    // --- æ»‘åŠ¨å’Œç¼–è¾‘æ¨¡å¼çš„åˆ¤æ–­é€»è¾‘ ---
    if (!swipeState.isClick && Math.abs(swipeState.currentX - swipeState.startX) < 10) {
        swipeState.isClick = true;
    }
    if (!swipeState.isClick) return; // å¦‚æœç¡®å®šæ˜¯æ»‘åŠ¨ï¼Œåˆ™ä¸æ‰§è¡Œç‚¹å‡»é€»è¾‘

    const target = e.target;
    const postContainer = target.closest('.qzone-post-container');
    if (!postContainer) return;

    const postId = parseInt(postContainer.dataset.postId);

    // --- åˆ†æ”¯1: å¦‚æœå½“å‰æ˜¯ç¼–è¾‘æ¨¡å¼ ---
    if (isQzoneEditMode) {
        togglePostSelection(postId);
        return; // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œåªå¤„ç†é€‰æ‹©é€»è¾‘ï¼Œç›´æ¥è¿”å›
    }
    
    // --- å¦‚æœä¸æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°ä¸Šå±‚ ---
    e.stopPropagation();

    // --- ã€å…¨æ–°åŠŸèƒ½ï¼šç‚¹å‡»è¯„è®ºè¿›è¡Œå›å¤ã€‘ ---
    const commentItem = target.closest('.comment-item');
    // ç¡®ä¿ç‚¹å‡»çš„ä¸æ˜¯è¯„è®ºä¸Šçš„åˆ é™¤æŒ‰é’®
    if (commentItem && !target.closest('.comment-delete-btn')) {
        const commenterNameEl = commentItem.querySelector('.commenter-name');
        const commentInput = postContainer.querySelector('.comment-input');

        if (commenterNameEl && commentInput) {
            const commenterName = commenterNameEl.textContent.replace(':', '').trim();
            const replyText = `@${commenterName} `;
            commentInput.value = replyText;
            commentInput.focus();
            commentInput.setSelectionRange(replyText.length, replyText.length);
        }
        return; // å¤„ç†å®Œç‚¹å‡»å›å¤åï¼Œç»“æŸæœ¬æ¬¡äº‹ä»¶å¤„ç†
    }

    // --- åˆ†æ”¯2: å¦‚æœå½“å‰æ˜¯æ­£å¸¸æ¨¡å¼ (æ‰§è¡Œæ‰€æœ‰å…¶ä»–ç‚¹å‡»é€»è¾‘) ---
    const sendCommentBtn = target.closest('.comment-send-btn');
    const commentDeleteBtn = target.closest('.comment-delete-btn');
    const postActionsBtn = target.closest('.post-actions-btn');
    const deleteActionBtn = target.closest('.qzone-post-delete-action');
    const hiddenTextImage = target.closest('img[data-hidden-text]');
    const feedbackIcon = target.closest('.action-icon');

    // ã€è¡Œä¸º1ã€‘ç‚¹å‡»å‘é€è¯„è®ºæŒ‰é’®
    if (sendCommentBtn) {
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºå“¦!');
        
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];
        
        let newComment;

        // a. åˆ¤æ–­æ˜¯å¦æ˜¯å›å¤
        if (commentText.startsWith('@')) {
            const firstSpaceIndex = commentText.indexOf(' ');
            if (firstSpaceIndex > 1) {
                newComment = {
                    commenterName: state.qzoneSettings.nickname,
                    timestamp: Date.now(),
                    replyTo: commentText.substring(1, firstSpaceIndex).trim(),
                    text: commentText.substring(firstSpaceIndex + 1).trim()
                };
            }
        }
        
        // b. å¦‚æœä¸æ˜¯å›å¤æˆ–æ ¼å¼ä¸æ­£ç¡®ï¼Œåˆ™ä¸ºæ™®é€šè¯„è®º
        if (!newComment) {
            newComment = {
                commenterName: state.qzoneSettings.nickname,
                timestamp: Date.now(),
                replyTo: null,
                text: commentText
            };
        }
        
        // c. ä¿å­˜å¹¶æ›´æ–°
        post.comments.push(newComment);
        await db.qzonePosts.update(postId, { comments: post.comments });

        if (newComment.replyTo) {
            const repliedToAI = Object.values(state.chats).find(chat => !chat.isGroup && chat.name === newComment.replyTo);
            if (repliedToAI) {
                const hiddenInstruction = { role: 'system', content: `[ç³»ç»ŸæŒ‡ä»¤:ç”¨æˆ·â€œ${state.qzoneSettings.nickname}â€åˆšåˆšåœ¨åŠ¨æ€(ID: ${postId})ä¸‹å›å¤äº†ã€ä½ ã€‘ã€‚TAè¯´:â€œ${newComment.text}â€ã€‚è¯·ä½ æ ¹æ®ä½ çš„äººè®¾,ä½¿ç”¨ qzone_comment æŒ‡ä»¤,å¹¶ä»¥â€œ@${state.qzoneSettings.nickname}â€å¼€å¤´,æ¥å›åº”TAã€‚]`, timestamp: Date.now(), isHidden: true };
                repliedToAI.history.push(hiddenInstruction);
                await db.chats.put(repliedToAI);
            }
        }
        
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup && (!newComment.replyTo || chat.name !== newComment.replyTo)) {
                chat.history.push({ role: 'system', content: `[ç³»ç»Ÿæç¤º:'${state.qzoneSettings.nickname}' åœ¨IDä¸º${postId}çš„åŠ¨æ€ä¸‹å‘è¡¨äº†è¯„è®º:â€œ${commentText}â€]`, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        
        commentInput.value = '';
        await renderQzonePosts();
        return; // ç»“æŸ
    } 
    // ã€è¡Œä¸º2ã€‘ç‚¹å‡»æ»‘åŠ¨åå‡ºç°çš„åˆ é™¤æŒ‰é’®
    else if (deleteActionBtn) {
        const confirmed = await showCustomConfirm('åˆ é™¤åŠ¨æ€', 'ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            postContainer.style.transition = 'all 0.3s ease';
            postContainer.style.transform = 'scale(0.8)';
            postContainer.style.opacity = '0';
            setTimeout(async () => {
                 await db.qzonePosts.delete(postId);
                 const notificationIdentifier = `(ID: ${postId})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) {
                         await db.chats.put(chat);
                     }
                 }
                 await renderQzonePosts();
                 alert('åŠ¨æ€å·²åˆ é™¤ã€‚');
            }, 300);
        }
    } 
    // ã€è¡Œä¸º3ã€‘ç‚¹å‡»è¯„è®ºæ—çš„åˆ é™¤æŒ‰é’®
    else if (commentDeleteBtn) {
        const commentIndex = parseInt(commentDeleteBtn.dataset.commentIndex);
        const post = await db.qzonePosts.get(postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;
        const commentText = post.comments[commentIndex].text;
        const confirmed = await showCustomConfirm('åˆ é™¤è¯„è®º', `ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ\n\nâ€œ${commentText.substring(0, 50)}...â€`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            post.comments.splice(commentIndex, 1);
            await db.qzonePosts.update(postId, { comments: post.comments });
            await renderQzonePosts();
            alert('è¯„è®ºå·²åˆ é™¤ã€‚');
        }
    } 
    // ã€è¡Œä¸º4ã€‘ç‚¹å‡»å¸–å­å³ä¸Šè§’çš„ä¸‰ç‚¹èœå•
    else if (postActionsBtn) {
        showPostActions(postId);
    } 
    // ã€è¡Œä¸º5ã€‘ç‚¹å‡»æ–‡å­—å›¾
    else if (hiddenTextImage) {
        showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenTextImage.dataset.hiddenText.replace(/<br>/g, '\n'));
    } 
    // ã€è¡Œä¸º6ã€‘ç‚¹å‡»ç‚¹èµæˆ–æ”¶è—
    else if (feedbackIcon) {
        if (feedbackIcon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) { 
                post.likes.splice(userLikeIndex, 1); 
            } else { 
                post.likes.push(userNickname); 
                feedbackIcon.classList.add('animate-like'); 
                feedbackIcon.addEventListener('animationend', () => feedbackIcon.classList.remove('animate-like'), { once: true }); 
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (feedbackIcon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) { 
                await db.favorites.delete(existingFavorite.id); 
                await showCustomAlert('æç¤º', 'å·²å–æ¶ˆæ”¶è—'); 
            } else { 
                const postToSave = await db.qzonePosts.get(postId); 
                if (postToSave) { 
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() }); 
                    await showCustomAlert('æç¤º', 'æ”¶è—æˆåŠŸ!'); 
                } 
            }
        }
        await renderQzonePosts();
    }
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€Final Fix - Unified Event Delegationã€‘REPLACE all old qzone-screen event listeners with this ENTIRE block â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ V3ã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ qzone-screen äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼-â–¼
// --- Master Event Listener for the ENTIRE QZone Screen ---
document.getElementById('qzone-screen').addEventListener('click', async (e) => {
    const target = e.target;
    const targetId = target.id;

    // --- Action 1: Handle clicks on profile elements (Signature, Nickname, etc.) ---
    // (è¿™éƒ¨åˆ†ä¸ªäººä¿¡æ¯ç‚¹å‡»é€»è¾‘ä¿æŒä¸å˜ï¼Œæˆ‘å·²å®Œæ•´å¤åˆ¶è¿‡æ¥)
    switch (targetId) {
        case 'qzone-nickname': {
            const newNickname = await showCustomPrompt("ä¿®æ”¹æ˜µç§°", "è¯·è¾“å…¥æ–°çš„æ˜µç§°", state.qzoneSettings.nickname);
            if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); }
            return;
        }
        case 'qzone-signature': {
            const newSignature = await showCustomPrompt("ä¿®æ”¹ä¸ªæ€§ç­¾å", "è¯·è¾“å…¥æ–°çš„ç­¾å", state.qzoneSettings.signature);
            if (newSignature !== null) { state.qzoneSettings.signature = newSignature.trim(); await saveQzoneSettings(); renderQzoneScreen(); }
            return;
        }
        case 'qzone-visitor-info':
        case 'qzone-visitor-count-number': {
            const newCount = await showCustomPrompt("ä¿®æ”¹è®¿å®¢æ€»é‡", "è¯·è¾“å…¥æ–°çš„æ•°å€¼", state.qzoneSettings.visitorCount, "number");
            if (newCount && !isNaN(parseInt(newCount))) { state.qzoneSettings.visitorCount = parseInt(newCount); await saveQzoneSettings(); renderQzoneScreen(); }
            return;
        }
        case 'qzone-avatar-container':
            document.getElementById('qzone-avatar-input').click();
            return;
        case 'qzone-banner-container':
            document.getElementById('qzone-banner-input').click();
            return;
    }

    // ã€ã€ã€æ ¸å¿ƒä¿®å¤åŒºã€‘ã€‘ã€‘
    // --- Action 2: Handle the top-right action buttons ---
    const actionBtn = target.closest('.action-btn');
    if (actionBtn) {
        switch (actionBtn.id) {
            // a. ç‚¹å‡»â€œç¼–è¾‘â€æˆ–â€œå®Œæˆâ€æŒ‰é’®ï¼Œéƒ½è°ƒç”¨åˆ‡æ¢æ¨¡å¼çš„å‡½æ•°
            case 'qzone-edit-btn':
            case 'qzone-done-btn':
                toggleQzoneEditMode();
                break;

            // b. ç‚¹å‡»â€œå…¨é€‰â€æŒ‰é’®
            case 'qzone-select-all-btn': {
                if (!isQzoneEditMode) return;
                const allPosts = await db.qzonePosts.toArray();
                const allPostIds = allPosts.map(p => p.id);
                if (selectedPosts.size === allPostIds.length) {
                    selectedPosts.clear();
                } else {
                    allPostIds.forEach(id => selectedPosts.add(id));
                }
                renderQzonePosts();
                break;
            }

            // c. ç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®
            case 'qzone-delete-selected-btn': {
                if (!isQzoneEditMode || selectedPosts.size === 0) return;
                const confirmed = await showCustomConfirm('æ‰¹é‡åˆ é™¤åŠ¨æ€', `ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedPosts.size} æ¡åŠ¨æ€å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    const idsToDelete = Array.from(selectedPosts);
                    await db.qzonePosts.bulkDelete(idsToDelete);
                    // æ¸…ç†AIé€šçŸ¥
                    for (const postId of idsToDelete) {
                         const notificationIdentifier = `(ID: ${postId})`;
                         for (const chatId in state.chats) {
                             const chat = state.chats[chatId];
                             if (chat.history.some(msg => msg.role === 'system' && msg.content.includes(notificationIdentifier))) {
                                 chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                                 await db.chats.put(chat);
                             }
                         }
                    }
                    toggleQzoneEditMode(); // é€€å‡ºç¼–è¾‘æ¨¡å¼å¹¶åˆ·æ–°
                    alert('é€‰ä¸­çš„åŠ¨æ€å·²å…¨éƒ¨åˆ é™¤ã€‚');
                }
                break;
            }
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// --- Master Event Listener for the INDIVIDUAL POST action menu (P2) ---
document.getElementById('post-actions-modal').addEventListener('click', (e) => {
    const targetId = e.target.id;
    switch (targetId) {
        case 'edit-post-btn':
            openPostEditor();
            break;
        case 'copy-post-btn':
            copyPostContent();
            break;
        case 'cancel-post-action-btn':
            hidePostActions();
            break;
    }
});

// --- Global Listener to close the dropdown when clicking outside ---
window.addEventListener('click', (e) => {
    const qzoneDropdown = document.getElementById('qzone-actions-dropdown');
    const qzoneMenuBtn = document.getElementById('qzone-actions-menu-btn');
    if (qzoneDropdown && qzoneMenuBtn) {
        if (qzoneDropdown.classList.contains('visible') && !qzoneDropdown.contains(e.target) && !qzoneMenuBtn.contains(e.target)) {
            qzoneDropdown.classList.remove('visible');
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ - å®æ—¶è·å–DOMã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ postsList çš„ 'input' å’Œ 'focusout' ç›‘å¬å™¨ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰è¯„è®ºæ¡†çš„ @ æåŠåŠŸèƒ½
postsList.addEventListener('input', (e) => {
    // ç¡®ä¿äº‹ä»¶æ˜¯ç”±è¯„è®ºè¾“å…¥æ¡†è§¦å‘çš„
    if (!e.target.matches('.comment-input')) {
        return;
    }

    const commentInput = e.target;
    const postContainer = commentInput.closest('.qzone-post-container');
    if (!postContainer) return;

    // ã€æ ¸å¿ƒä¿®å¤1ã€‘åœ¨äº‹ä»¶å†…éƒ¨å®æ—¶è·å–popupå…ƒç´ 
    const popup = postContainer.querySelector('.at-mention-popup');
    if (!popup) return; // å¦‚æœæ‰¾ä¸åˆ°popupï¼Œç›´æ¥é€€å‡º

    const value = commentInput.value;
    const atMatch = value.match(/@([\p{L}\w]*)$/u);

    if (atMatch) {
        const namesToMention = new Set();
        const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
        if (authorNickname) namesToMention.add(authorNickname);
        
        postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
            namesToMention.add(nameEl.textContent.replace(':', '').trim());
        });

        namesToMention.delete(state.qzoneSettings.nickname);

        popup.innerHTML = '';
        if (namesToMention.size > 0) {
            const searchTerm = atMatch[1];
            namesToMention.forEach(name => {
                if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                    const item = document.createElement('div');
                    item.className = 'at-mention-item';
                    item.textContent = name;
                    item.addEventListener('mousedown', (event) => {
                        event.preventDefault();
                        const newText = value.substring(0, atMatch.index) + `@${name} `;
                        commentInput.value = newText;
                        popup.style.display = 'none';
                        commentInput.focus();
                    });
                    popup.appendChild(item);
                }
            });
            popup.style.display = popup.children.length > 0 ? 'block' : 'none';
        } else {
            popup.style.display = 'none';
        }
    } else {
        popup.style.display = 'none';
    }
});

// å½“è¯„è®ºæ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œå»¶è¿Ÿéšè—æåŠåˆ—è¡¨
postsList.addEventListener('focusout', (e) => {
    if (e.target.matches('.comment-input')) {
        const postContainer = e.target.closest('.qzone-post-container');
        if (postContainer) {
            // ã€æ ¸å¿ƒä¿®å¤2ã€‘åŒæ ·åœ¨äº‹ä»¶å†…éƒ¨å®æ—¶è·å–popupå…ƒç´ 
            const popup = postContainer.querySelector('.at-mention-popup');
            if (popup) { // å®‰å…¨æ£€æŸ¥
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 200);
            }
        }
    }
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å‡çº§ç‰ˆã€‘ä¿å­˜èŠå¤©è®¾ç½®ï¼Œä»èƒ¶å›Šé€‰æ‹©å™¨è¯»å–æ•°æ® â–¼â–¼â–¼
document.getElementById('save-chat-settings-btn-screen').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) {
        alert('å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©º!');
        return;
    }
    chat.name = newName;
    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä»æ–°çš„èƒ¶å›ŠUIä¸­è¯»å–é€‰ä¸­çš„ä¸–ç•Œä¹¦
    const selectedPills = document.querySelectorAll('#world-book-pills-container .wb-pill.selected');
    chat.settings.linkedWorldBookIds = Array.from(selectedPills).map(pill => pill.dataset.bookId);

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    
    await db.chats.put(chat);
    
    showScreen('chat-interface-screen');
    
    renderChatInterface(state.activeChatId);
    renderChatList();
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘å£çº¸åº“äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// 1. å¤–è§‚è®¾ç½®é¡µçš„æŒ‰é’® -> æ‰“å¼€å…¨å±€æ¨¡å¼çš„å£çº¸åº“
document.getElementById('manage-wallpaper-library-btn').addEventListener('click', () => {
    openWallpaperLibrary({ from: 'global' });
});

// 2. èŠå¤©è®¾ç½®é¡µçš„æŒ‰é’® -> æ‰“å¼€èŠå¤©æ¨¡å¼çš„å£çº¸åº“
document.getElementById('open-wallpaper-library-from-chat-btn').addEventListener('click', () => {
    openWallpaperLibrary({ from: 'chat', activeChatId: state.activeChatId });
});

// 3. å£çº¸åº“çš„è¿”å›æŒ‰é’® -> æ ¹æ®æ¥æºè¿”å›åˆ°æ­£ç¡®çš„ä½ç½®
document.getElementById('wallpaper-library-back-btn').addEventListener('click', () => {
    if (wallpaperLibraryContext.from === 'chat') {
        showScreen('chat-settings-screen');
    } else {
        showScreen('wallpaper-screen');
    }
});

// 4. å£çº¸åº“çš„æ·»åŠ æŒ‰é’® (é€»è¾‘ä¸å˜)
document.getElementById('add-wallpapers-btn').addEventListener('click', addWallpapers);

// 5. ã€æ ¸å¿ƒä¿®å¤ã€‘å°†æ–‡ä»¶ä¸Šä¼ çš„ç›‘å¬å™¨æ”¾åœ¨è¿™é‡Œï¼Œå¹¶ç›´æ¥è°ƒç”¨æ ¸å¿ƒå¤„ç†é€»è¾‘
document.getElementById('wallpaper-upload-input-library').addEventListener('change', async (event) => {
    const files = event.target.files;
    if (!files || files.length === 0) {
        console.log("ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©æˆ–æœªé€‰æ‹©æ–‡ä»¶ã€‚");
        return;
    }

    const newWallpapers = [];
    // æ˜¾ç¤ºä¸€ä¸ªåŠ è½½æç¤ºï¼Œå› ä¸ºè¯»å–å¤šä¸ªæ–‡ä»¶å¯èƒ½éœ€è¦æ—¶é—´
    showCustomAlert("è¯·ç¨å€™...", "æ­£åœ¨å¤„ç†ä¸Šä¼ çš„å£çº¸...");

    for (const file of files) {
        try {
            const base64Url = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsDataURL(file);
            });
            newWallpapers.push({
                id: 'wall_' + (Date.now() + newWallpapers.length),
                url: base64Url
            });
        } catch (error) {
            console.error("è¯»å–æ–‡ä»¶å¤±è´¥:", file.name, error);
        }
    }

    // éšè—åŠ è½½æç¤º
    hideCustomModal();

    if (newWallpapers.length > 0) {
        await db.wallpapers.bulkAdd(newWallpapers);
        await renderWallpaperLibrary();
        
        if (newWallpapers.length === 1 && wallpaperLibraryContext.from === 'chat') {
            const confirmed = await showCustomConfirm(
                'ä¸Šä¼ æˆåŠŸ',
                'å£çº¸å·²æˆåŠŸæ·»åŠ åˆ°åº“ä¸­ã€‚è¦ç«‹å³å°†å…¶è®¾ä¸ºå½“å‰èŠå¤©èƒŒæ™¯å—ï¼Ÿ'
            );
            if (confirmed) {
                applyWallpaper('chat', newWallpapers[0].url);
            }
        } else {
             alert(`æˆåŠŸæ·»åŠ äº† ${newWallpapers.length} å¼ æ–°å£çº¸åˆ°åº“ä¸­!`);
        }
    }
    event.target.value = null; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
});


// 6. ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å£çº¸åº“ä¸­çš„ç‚¹å‡»äº‹ä»¶ (é€»è¾‘ä¸å˜)
document.getElementById('wallpaper-grid').addEventListener('click', (e) => {
    const target = e.target;
    if (target.classList.contains('apply')) {
        promptWallpaperApplyTarget(target.dataset.url);
    } else if (target.classList.contains('delete')) {
        deleteWallpaper(target.dataset.id);
    }
});

// 7. åº”ç”¨ç›®æ ‡æ¨¡æ€æ¡†çš„æŒ‰é’®äº‹ä»¶ (é€»è¾‘ä¸å˜)
document.getElementById('apply-to-home-btn').addEventListener('click', () => applyWallpaper('home'));
document.getElementById('apply-to-chat-btn').addEventListener('click', () => applyWallpaper('chat'));
document.getElementById('apply-wallpaper-cancel-btn').addEventListener('click', () => {
    document.getElementById('wallpaper-apply-modal').classList.remove('visible');
});
// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´æˆ–æ›¿æ¢ä¸ºè¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// æ¸²æŸ“ä¸€æ¬¡åŠŸèƒ½é¢æ¿ (åœ¨é¡µé¢åŠ è½½æ—¶å°±å‡†å¤‡å¥½)
renderChatActionPanel();

const openActionsBtn = document.getElementById('open-actions-btn');
const actionsPanel = document.getElementById('chat-actions-panel');
const chatMessages = document.getElementById('chat-messages');

openActionsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    actionsPanel.classList.toggle('visible');
    openActionsBtn.classList.toggle('active');

    // é‡æ–°è®¡ç®—å¹¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä»¥é€‚åº”é¢æ¿é«˜åº¦å˜åŒ–
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 300); // å»¶è¿Ÿæ—¶é—´ä¸CSSåŠ¨ç”»æ—¶é—´åŒ¹é…
});

// ç‚¹å‡»é¡µé¢å…¶ä»–ä»»ä½•åœ°æ–¹ï¼Œå¦‚æœé¢æ¿æ˜¯æ‰“å¼€çš„ï¼Œå°±å…³é—­å®ƒ
window.addEventListener('click', (e) => {
    if (actionsPanel.classList.contains('visible') && !actionsPanel.contains(e.target) && !openActionsBtn.contains(e.target)) {
        actionsPanel.classList.remove('visible');
        openActionsBtn.classList.remove('active');
    }
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ç¬¬4.3æ­¥:åœ¨ init() ä¸­,ç”¨è¿™æ•´å—ã€æœ€ç»ˆç‰ˆã€‘ä»£ç ,æ›¿æ¢æ‰€æœ‰æ—§çš„çºªå¿µæ—¥/æ—¥å†ç›¸å…³äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
// === ã€å…¨æ–°ã€‘çºªå¿µæ—¥ä¸æ—¥å†åŠŸèƒ½äº‹ä»¶ç»‘å®š (åˆ‡æ¢+ç›´è§‰äº¤äº’ç‰ˆ) ===

// 1. ç»‘å®šåº•éƒ¨å¯¼èˆªæ çš„â€œçºªå¿µæ—¥â€é¡µç­¾
document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
    if (isFavoritesSelectionMode) { document.getElementById('favorites-edit-btn').click(); }
    switchToChatListView('memories-view');
    renderMemoriesScreen();
});

// 2. ç»‘å®šâ€œæˆ‘ä»¬çš„æ—¥å­â€é¡µé¢çš„è¿”å›æŒ‰é’®
document.getElementById('memories-back-btn').addEventListener('click', () => {
    switchToChatListView('messages-view');
});

// 3. ã€æ–°ã€‘ç»‘å®šAIåˆ‡æ¢å™¨
document.getElementById('memories-ai-switcher').addEventListener('change', (e) => {
    currentMemoriesViewChatId = e.target.value;
    renderMemoriesScreen(); // åˆ‡æ¢åé‡ç»˜æ•´ä¸ªé¡µé¢
});

// 4. ã€æ–°ã€‘ç»‘å®šå¤´åƒç‚¹å‡»äº‹ä»¶,ç›´æ¥è§¦å‘æ–‡ä»¶ä¸Šä¼ 
document.getElementById('anniversary-my-avatar').addEventListener('click', () => {
    document.getElementById('anniversary-my-avatar-input-global').click();
});
document.getElementById('anniversary-ai-avatar').addEventListener('click', () => {
    document.getElementById('anniversary-ai-avatar-input-global').click();
});

// 5. ã€æ–°ã€‘ä¸ºéšè—çš„æ–‡ä»¶ä¸Šä¼ inputç»‘å®šchangeäº‹ä»¶
document.getElementById('anniversary-my-avatar-input-global').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file && currentMemoriesViewChatId) {
        const chat = state.chats[currentMemoriesViewChatId];
        const reader = new FileReader();
        reader.onload = async (re) => {
            chat.settings.myAvatar = re.target.result; // ç›´æ¥æ›´æ–°å½“å‰AIèŠå¤©é‡Œçš„â€œæˆ‘çš„å¤´åƒâ€
            await db.chats.put(chat);
            renderMemoriesScreen(); // åˆ·æ–°æ˜¾ç¤º
        };
        reader.readAsDataURL(file);
    }
    e.target.value = ''; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒåæ–‡ä»¶
});
document.getElementById('anniversary-ai-avatar-input-global').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file && currentMemoriesViewChatId) {
        const chat = state.chats[currentMemoriesViewChatId];
        const reader = new FileReader();
        reader.onload = async (re) => {
            chat.settings.aiAvatar = re.target.result;
            await db.chats.put(chat);
            renderMemoriesScreen();
        };
        reader.readAsDataURL(file);
    }
    e.target.value = '';
});

// 6. ã€æ–°ã€‘ç»‘å®šå¤©æ•°å’Œæ—¥æœŸ,ç‚¹å‡»åè®¾ç½®èµ·å§‹æ—¥
document.getElementById('anniversary-days').addEventListener('click', promptForAnniversaryDate);
document.getElementById('anniversary-start-date').addEventListener('click', promptForAnniversaryDate);

// 7. ç»‘å®šæ—¥å†æœˆä»½åˆ‡æ¢æŒ‰é’® (é€»è¾‘ä¸å˜)
document.getElementById('calendar-prev-month').addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
});
document.getElementById('calendar-next-month').addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
});

// 8. ç»‘å®šå¤‡å¿˜å½•å¼¹çª—çš„æŒ‰é’® (é€»è¾‘ä¸å˜)
document.getElementById('cancel-event-btn').addEventListener('click', () => {
    document.getElementById('calendar-event-modal').classList.remove('visible');
});
document.getElementById('save-event-btn').addEventListener('click', saveCalendarEvent);
document.getElementById('delete-event-btn').addEventListener('click', deleteCalendarEvent);
// â–²â–²â–² äº‹ä»¶ç»‘å®šæ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°ä¸­,ç”¨è¿™æ•´å—ã€å…¨æ–°é€»è¾‘ã€‘çš„ä»£ç æ›¿æ¢æ—§çš„ calendar-grid äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// ã€å…¨æ–°ã€‘ç»‘å®šæ—¥å†æ ¼å­çš„æ™ºèƒ½ç‚¹å‡»äº‹ä»¶
document.getElementById('calendar-grid').addEventListener('click', async (e) => {
    const dayEl = e.target.closest('.calendar-day');
    if (dayEl && !dayEl.classList.contains('empty')) {
        const dateString = dayEl.dataset.date;
        const chatId = currentMemoriesViewChatId;
        
        // 1. ç²¾ç¡®æŸ¥è¯¢å½“å¤©æ˜¯å¦å·²æœ‰äº‹ä»¶
        const existingEvent = await db.calendarEvents
            .where('[chatId+date]')
            .equals([chatId, dateString])
            .first();

        if (existingEvent) {
            // 2. ã€æ ¸å¿ƒã€‘å¦‚æœæœ‰äº‹ä»¶,è°ƒç”¨æˆ‘ä»¬æ–°çš„è¯¦æƒ…å‡½æ•°
            showCuteEventViewer(existingEvent);
        } else {
            // 3. å¦‚æœæ²¡äº‹ä»¶,æ‰è°ƒç”¨æˆ‘ä»¬ä¸Šä¸€ç‰ˆåˆ›å»ºçš„å¿«é€Ÿæ ‡æ³¨å¼¹çª—
            const memoTitle = await showCalendarPrompt(dateString);
            
            // 4. å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç¡®è®¤,å°±ç›´æ¥ä¿å­˜å¹¶åˆ·æ–°!
            if (memoTitle !== null) { 
                const finalTitle = memoTitle.trim() || `å€¼å¾—çºªå¿µçš„ä¸€å¤©`;
                
                const newEvent = {
                    chatId: chatId,
                    date: dateString,
                    title: finalTitle,
                    memo: '', // å¤‡å¿˜å½•å†…å®¹åˆå§‹ä¸ºç©º
                    createdBy: 'user'
                };
                
                await db.calendarEvents.add(newEvent);
                
                // ã€å…³é”®ã€‘ä¿å­˜æˆåŠŸå,ç«‹åˆ»åˆ·æ–°æ—¥å†,è®©å°çº¢ç‚¹æ˜¾ç¤ºå‡ºæ¥
                await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        }
    }
});

// 8. ç»‘å®šå¤‡å¿˜å½•å¼¹çª—çš„æŒ‰é’®
document.getElementById('cancel-event-btn').addEventListener('click', () => {
    document.getElementById('calendar-event-modal').classList.remove('visible');
});
document.getElementById('save-event-btn').addEventListener('click', saveCalendarEvent);
document.getElementById('delete-event-btn').addEventListener('click', deleteCalendarEvent);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ,ç²˜è´´ä¸‹é¢è¿™ä¸¤è¡Œ â–¼â–¼â–¼

            // ç»‘å®šåŠ¨æ€é¡µå’Œæ”¶è—é¡µçš„è¿”å›æŒ‰é’®
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯èƒŒæ™¯ä¸Šä¼ åŠŸèƒ½ â–¼â–¼â–¼
document.getElementById('video-call-screen').addEventListener('click', (e) => {
    // ç¡®ä¿åªæœ‰åœ¨ç‚¹å‡»èƒŒæ™¯æœ¬èº«ï¼ˆè€Œä¸æ˜¯æŒ‰é’®æˆ–å¯¹è¯æ¡†ï¼‰æ—¶æ‰è§¦å‘
    if (e.target.id === 'video-call-screen') {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (readEvent) => {
                    const base64Url = readEvent.target.result;
                    // æ›´æ–°å½“å‰é€šè¯çš„çŠ¶æ€
                    videoCallState.backgroundUrl = base64Url;
                    // åŒæ—¶ä¿å­˜åˆ°èŠå¤©è®¾ç½®ä¸­ï¼Œä½œä¸ºè¯¥èŠå¤©çš„é»˜è®¤é€šè¯/çº¿ä¸‹èƒŒæ™¯
                    const chat = state.chats[videoCallState.activeChatId];
                    if (chat) {
                        chat.settings.offlineVideoBackground = base64Url;
                        await db.chats.put(chat);
                    }
                    // å®æ—¶åº”ç”¨æ–°èƒŒæ™¯
                    document.getElementById('video-call-screen').style.backgroundImage = `url(${base64Url})`;
                    await showCustomAlert('æˆåŠŸ', 'é€šè¯èƒŒæ™¯å·²æ›´æ¢ï¼');
                };
                reader.readAsDataURL(file);
            }
            document.body.removeChild(fileInput); // æ¸…ç†DOM
        });

        document.body.appendChild(fileInput);
        fileInput.click();
    }
});
// â–²â–²â–² æ–°å¢äº‹ä»¶ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ,æ£€æŸ¥å¹¶ç¡®ä¿ä½ æœ‰è¿™æ®µå®Œæ•´çš„ä»£ç  â–¼â–¼â–¼

            // æ”¶è—é¡µæœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                // æ§åˆ¶æ¸…é™¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); // å¦‚æœæœç´¢æ¡†ä¸ºç©º,æ˜¾ç¤ºæ‰€æœ‰
                    return;
                }

                // ç­›é€‰é€»è¾‘
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    // åŒæ—¶æœç´¢å†…å®¹å’Œä½œè€…,å¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            // æ¸…é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            // â–²â–²â–² ä»£ç æ£€æŸ¥ç»“æŸ â–²â–²â–²

            // â–¼â–¼â–¼ æ–°å¢/ä¿®æ”¹çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
            
            // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶
                        // ä¸ºèŠå¤©ç•Œé¢çš„æ‰¹é‡æ”¶è—æŒ‰é’®ç»‘å®šäº‹ä»¶ (å·²ä¿®æ­£)
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä½¿ç”¨æ–°çš„ã€é«˜æ•ˆçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), // è¿™æ˜¯æ”¶è—æ“ä½œå‘ç”Ÿçš„æ—¶é—´
                                originalTimestamp: messageToSave.timestamp // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä¿å­˜åŸå§‹æ¶ˆæ¯çš„æ—¶é—´æˆ³åˆ°æ–°å­—æ®µ
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // æ›´æ–°å…¨å±€æ”¶è—ç¼“å­˜
                    await showCustomAlert('æ”¶è—æˆåŠŸ', `å·²æˆåŠŸæ”¶è— ${favoritesToAdd.length} æ¡æ¶ˆæ¯ã€‚`);
                } else {
                    await showCustomAlert('æç¤º', 'é€‰ä¸­çš„æ¶ˆæ¯å‡å·²æ”¶è—è¿‡ã€‚');
                }
                
                exitSelectionMode();
            });

            // æ”¶è—é¡µé¢çš„"ç¼–è¾‘"æŒ‰é’®äº‹ä»¶ (å·²ä¿®æ­£)
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // è·å–ä¸»å¯¼èˆªæ 
            const favoritesList = document.getElementById('favorites-list'); // è·å–æ”¶è—åˆ—è¡¨
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    // --- è¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'å®Œæˆ';
                    favoritesActionBar.style.display = 'block'; // æ˜¾ç¤ºåˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'none'; // â–¼ æ–°å¢:éšè—ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = '80px'; // â–¼ æ–°å¢:ç»™åˆ—è¡¨åº•éƒ¨å¢åŠ ç©ºé—´
                } else {
                    // --- é€€å‡ºç¼–è¾‘æ¨¡å¼ ---
                    favoritesEditBtn.textContent = 'ç¼–è¾‘';
                    favoritesActionBar.style.display = 'none'; // éšè—åˆ é™¤æ“ä½œæ 
                    mainBottomNav.style.display = 'flex';  // â–¼ æ–°å¢:æ¢å¤ä¸»å¯¼èˆªæ 
                    favoritesList.style.paddingBottom = ''; // â–¼ æ–°å¢:æ¢å¤åˆ—è¡¨é»˜è®¤padding

                    // é€€å‡ºæ—¶æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (0)`;
                }
            });

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—åˆ—è¡¨çš„ç‚¹å‡»é€‰æ‹©äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    // ã€æ–°å¢ã€‘å¤„ç†æ–‡å­—å›¾ç‚¹å‡»,è¿™æ®µé€»è¾‘è¦æ”¾åœ¨æœ€å‰é¢,ä¿è¯ä»»ä½•æ¨¡å¼ä¸‹éƒ½ç”Ÿæ•ˆ
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("å›¾ç‰‡å†…å®¹", hiddenText.replace(/<br>/g, '\n'));
        return; // å¤„ç†å®Œå°±é€€å‡º,ä¸ç»§ç»­æ‰§è¡Œé€‰æ‹©é€»è¾‘
    }
    
    // å¦‚æœä¸åœ¨é€‰æ‹©æ¨¡å¼,åˆ™ä¸æ‰§è¡Œåç»­çš„é€‰æ‹©æ“ä½œ
    if (!isFavoritesSelectionMode) return;

    // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„é€‰æ‹©é€»è¾‘,ä¿æŒä¸å˜ ---
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    // æ›´æ–°åº•éƒ¨åˆ é™¤æŒ‰é’®çš„è®¡æ•°
    document.getElementById('favorites-delete-selected-btn').textContent = `åˆ é™¤ (${selectedFavorites.size})`;
});

// â–¼â–¼â–¼ å°†å®ƒã€å®Œæ•´æ›¿æ¢ã€‘ä¸ºä¸‹é¢è¿™æ®µä¿®æ­£åçš„ä»£ç  â–¼â–¼â–¼
// æ”¶è—é¡µé¢æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ç¡®è®¤åˆ é™¤', 
        `ç¡®å®šè¦ä»æ”¶è—å¤¹ä¸­ç§»é™¤è¿™ ${selectedFavorites.size} æ¡å†…å®¹å—ï¼Ÿ`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('åˆ é™¤æˆåŠŸ', 'é€‰ä¸­çš„æ”¶è—å·²è¢«ç§»é™¤ã€‚');
        
        // ã€æ ¸å¿ƒä¿®æ­£1ã€‘ä»å‰ç«¯ç¼“å­˜ä¸­ä¹Ÿç§»é™¤è¢«åˆ é™¤çš„é¡¹
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        // ã€æ ¸å¿ƒä¿®æ­£2ã€‘ä½¿ç”¨æ›´æ–°åçš„ç¼“å­˜,ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        displayFilteredFavorites(allFavoriteItems);
        
        // æœ€å,å†é€€å‡ºç¼–è¾‘æ¨¡å¼
        favoritesEditBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»"å®Œæˆ"æŒ‰é’®æ¥é€€å‡ºç¼–è¾‘æ¨¡å¼
    }
});

// â–¼â–¼â–¼ ã€Dã€‘å°†è¿™æ•´å—ä»£ç ,ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜,ç›‘å¬æ•´ä¸ªâ€œå¯çˆ±æŸ¥çœ‹å™¨â€çš„ç‚¹å‡»
document.getElementById('cute-event-viewer-modal').addEventListener('click', async (e) => {
    const target = e.target;
    const eventId = parseInt(target.dataset.eventId);

    // å¦‚æœç‚¹å‡»çš„æ˜¯â€œå…³é—­â€æŒ‰é’®
    if (target.id === 'close-cute-event-viewer-btn') {
        target.closest('.modal').classList.remove('visible');
    }
    
    // å¦‚æœç‚¹å‡»çš„æ˜¯â€œç¼–è¾‘â€æŒ‰é’®
    else if (target.id === 'cute-event-edit-btn' && eventId) {
        const eventToEdit = await db.calendarEvents.get(eventId);
        if (eventToEdit) {
            // 1. å…ˆå…³é—­å¯çˆ±çš„æŸ¥çœ‹å™¨
            target.closest('.modal').classList.remove('visible');
            // 2. ç´§æ¥ç€æ‰“å¼€ç¼–è¾‘å™¨,å¹¶ä¼ å…¥è¦ç¼–è¾‘çš„äº‹ä»¶æ•°æ®
            openEventEditor(eventToEdit.date, eventToEdit);
        }
    }

    // å¦‚æœç‚¹å‡»çš„æ˜¯â€œåˆ é™¤â€æŒ‰é’®
    else if (target.id === 'cute-event-delete-btn' && eventId) {
        const confirmed = await showCustomConfirm('åˆ é™¤å¤‡å¿˜', 'ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å½•å—ï¼Ÿ', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.calendarEvents.delete(eventId);
            target.closest('.modal').classList.remove('visible');
            await renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            alert('å¤‡å¿˜å·²åˆ é™¤ã€‚');
        }
    }
});

// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°æœ«å°¾æ·»åŠ  â–¼â–¼â–¼
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("åå°æ´»åŠ¨æ¨¡æ‹Ÿå·²è‡ªåŠ¨å¯åŠ¨ã€‚");
}
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

            // --- é»‘èƒ¶å”±ç‰‡å°é¢ä¸Šä¼ åŠŸèƒ½ ---
            const vinylPlayer = document.getElementById('vinyl-player-container');
            const vinylUploadInput = document.getElementById('vinyl-cover-upload');

            if (vinylPlayer && vinylUploadInput) {
                vinylPlayer.addEventListener('click', () => {
                    vinylUploadInput.click(); // ç‚¹å‡»æ’­æ”¾å™¨æ—¶,è§¦å‘éšè—çš„æ–‡ä»¶ä¸Šä¼ æŒ‰é’®
                });
            }

// â–¼â–¼â–¼ ã€è¿™æ˜¯æœ€ç»ˆçš„æ­£ç¡®ä»£ç ã€‘è¯·ç²˜è´´è¿™æ®µä»£ç åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼

// --- ç»Ÿä¸€å¤„ç†æ‰€æœ‰å½±å“é¢„è§ˆçš„æ§ä»¶çš„äº‹ä»¶ ---

// 1. ç›‘å¬ä¸»é¢˜é€‰æ‹©
document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', () => {
        // ã€å¢å¼ºã€‘å½“ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªé¢„è®¾ä¸»é¢˜æ—¶,è‡ªåŠ¨æ¸…ç©ºè‡ªå®šä¹‰CSSè¾“å…¥æ¡†
        document.getElementById('custom-css-input').value = '';
    });
});

// 2. ç›‘å¬å­—ä½“å¤§å°æ»‘å—
const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    // a. å®æ—¶æ›´æ–°æ•°å€¼æ˜¾ç¤º
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
});

// 3. ç›‘å¬è‡ªå®šä¹‰CSSè¾“å…¥æ¡†
const customCssInputForPreview = document.getElementById('custom-css-input');

// æ‰¾åˆ°å¹¶ã€å®Œæ•´æ›¿æ¢ã€‘æ—§çš„ 'reset-theme-btn' ç‚¹å‡»äº‹ä»¶
document.getElementById('reset-theme-btn').addEventListener('click', () => { 
    document.getElementById('theme-default').checked = true; 
    // ã€å¢å¼ºã€‘é‡ç½®æ—¶,åŒæ—¶æ¸…ç©ºè‡ªå®šä¹‰CSSè¾“å…¥æ¡†
    document.getElementById('custom-css-input').value = ''; 
});

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸï¼Œç²˜è´´è¿™æ•´å—å…¨æ–°çš„äº”å­æ£‹äº‹ä»¶ç»‘å®šä»£ç  â–¼â–¼â–¼

// æ¸¸æˆé¢æ¿çš„äº”å­æ£‹å¯åŠ¨æŒ‰é’®
document.getElementById('start-auto-chess-btn').addEventListener('click', () => {
    // è¿™ä¸ªæŒ‰é’®ç°åœ¨è´Ÿè´£æ‰“å¼€äº”å­æ£‹å±å¹•ï¼Œè€Œä¸æ˜¯ç›´æ¥å¼€å§‹æ¸¸æˆ
    closeGamePanel();
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    
    // åˆå§‹åŒ–UIï¼Œä½†ä¸å¼€å§‹æ¸¸æˆ
    document.getElementById('gomoku-user-avatar').src = chat.settings.myAvatar || defaultAvatar;
    document.getElementById('gomoku-ai-avatar').src = chat.settings.aiAvatar || defaultAvatar;
    document.getElementById('gomoku-user-name').textContent = chat.settings.myNickname || 'æˆ‘';
    document.getElementById('gomoku-ai-name').textContent = chat.name;
    document.getElementById('gomoku-start-overlay').classList.add('visible'); // ç¡®ä¿å¼€å§‹æŒ‰é’®å¯è§
    document.getElementById('auto-chess-messages').innerHTML = ''; // æ¸…ç©ºèŠå¤©è®°å½•

    showScreen('gomoku-screen');
});

// äº”å­æ£‹å±å¹•å†…çš„â€œå¼€å§‹æ¸¸æˆâ€æŒ‰é’®
document.getElementById('gomoku-start-btn').addEventListener('click', startGomokuGame);

// è¿”å›æŒ‰é’®
document.getElementById('gomoku-back-btn').addEventListener('click', () => {
    // é€€å‡ºæ¸¸æˆæ—¶ï¼Œé‡ç½®çŠ¶æ€å¹¶è¿”å›èŠå¤©ç•Œé¢
    if (gomokuState.turnTimerId) clearInterval(gomokuState.turnTimerId);
    gomokuState = {};
    openChat(state.activeChatId);
});

// æ‚”æ£‹æŒ‰é’®
document.getElementById('gomoku-undo-btn').addEventListener('click', handleUndo);

// æ£‹ç›˜ç‚¹å‡»äº‹ä»¶ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
document.getElementById('gomoku-grid').addEventListener('click', (e) => {
    const cell = e.target.closest('.gomoku-cell');
    if (cell && cell.dataset.row && cell.dataset.col) {
        handleCellClick(parseInt(cell.dataset.row), parseInt(cell.dataset.col));
    }
});

// æ‹ä¸€æ‹å¤´åƒäº’åŠ¨
document.getElementById('gomoku-user-avatar').addEventListener('click', () => handleAvatarPat('user'));
document.getElementById('gomoku-ai-avatar').addEventListener('click', () => handleAvatarPat('ai'));

// â–²â–²â–² äº”å­æ£‹äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ V4ã€‘ç›´æ’­é—´åŠäººè®¾åº“äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
// â–¼â–¼â–¼ Please REPLACE your old 'document.body' event listener with this new one â–¼â–¼â–¼
document.body.addEventListener('click', (e) => {
    const targetId = e.target.id || e.target.closest('[id]')?.id;
    switch (targetId) {
        case 'confirm-start-live-stream-btn':
            // ã€New Logicã€‘Check if a stream is active to decide whether to start or update
            if (liveStreamState.isActive) {
                updateLiveStreamSettings();
            } else {
                startLiveStream(true);
            }
            break;
        // â–¼â–¼â–¼ è¯·ç”¨è¿™ä¸ªç‰ˆæœ¬æ›¿æ¢æ—§çš„ 'live-streamer-info-clickable' case â–¼â–¼â–¼
case 'live-streamer-info-clickable':
    // ç°åœ¨è¿™ä¸ªç‚¹å‡»äº‹ä»¶åŒæ—¶è´Ÿè´£â€œå¼€å§‹æ–°ç›´æ’­â€å’Œâ€œç¼–è¾‘å½“å‰ç›´æ’­â€
    prepareLiveStreamSetup();
    document.getElementById('live-pre-start-overlay').style.display = 'flex';
    break;
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        case 'cancel-start-live-stream-btn':
            document.getElementById('live-pre-start-overlay').style.display = 'none';
            // If we cancel while not live, go back to the chat list
            if (!liveStreamState.isActive) {
                showScreen('chat-list-screen');
            }
            break;
        case 'live-select-persona-btn': openPersonaLibrary(); break;
        case 'end-live-stream-btn': endLiveStream(); break;
        case 'live-like-btn': handleUserLike(); break;
        case 'live-send-gift-btn': alert('ç¤¼ç‰©åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼'); break;
        case 'live-send-comment-btn': sendLiveComment(); break;
    }
});
// â–²â–²â–² REPLACEMENT END â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ç›´æ’­é—´æ›´æ¢èƒŒæ™¯çš„é€»è¾‘ï¼ˆè·³è½¬åˆ°ç›¸å†Œï¼‰â–¼â–¼â–¼
document.getElementById('live-stream-screen').addEventListener('click', (e) => {
    // ç¡®ä¿åªæœ‰åœ¨ç‚¹å‡»èƒŒæ™¯æœ¬èº«ï¼ˆè€Œä¸æ˜¯æŒ‰é’®æˆ–å¯¹è¯æ¡†ï¼‰æ—¶æ‰è§¦å‘
    if (e.target.id === 'live-stream-screen') {
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
        // 1. è®¾ç½®ä¸Šä¸‹æ–‡ï¼Œå‘Šè¯‰ç›¸å†Œæˆ‘ä»¬æ˜¯æ¥é€‰ç›´æ’­èƒŒæ™¯çš„
        albumPickerContext = {
            for: 'live-background',
            returnScreen: 'live-stream-screen'
        };
        
        // 2. è·³è½¬åˆ°ç›¸å†Œé¡µé¢
        renderAlbumList(); // ç¡®ä¿ç›¸å†Œå†…å®¹æ˜¯æœ€æ–°çš„
        showScreen('album-screen');
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
// â–¼â–¼â–¼ è¯·ç”¨è¿™æ®µã€ä¿®æ­£åã€‘çš„ä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ—§çš„ live-background-upload-input äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('live-background-upload-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = async (re) => {
            const base64Url = re.target.result;
            
            // 1. æ›´æ–°ä¸´æ—¶çŠ¶æ€ (ä¿æŒä¸å˜)
            liveStreamState.backgroundUrl = base64Url;
            
            // 2. å®æ—¶åº”ç”¨æ–°èƒŒæ™¯ (ä¿æŒä¸å˜)
            document.getElementById('live-stream-screen').style.backgroundImage = `url(${base64Url})`;

            // 3. ã€ã€ã€æ ¸å¿ƒä¿®å¤ã€‘ã€‘ã€‘å°†æ–°èƒŒæ™¯URLä¿å­˜åˆ°æ•°æ®åº“
            // æˆ‘ä»¬éœ€è¦åˆ¤æ–­å½“å‰ä¸»æ’­æ˜¯è°ï¼Œå¹¶å°†èƒŒæ™¯å›¾ä¿å­˜åˆ°TAçš„èŠå¤©è®¾ç½®ä¸­
            const streamerChatId = liveStreamState.streamerId;
            if (streamerChatId && streamerChatId !== 'user' && state.chats[streamerChatId]) {
                const streamerChat = state.chats[streamerChatId];
                // æˆ‘ä»¬å¤ç”¨ offlineVideoBackground å­—æ®µæ¥å­˜å‚¨
                if (!streamerChat.settings) streamerChat.settings = {};
                streamerChat.settings.offlineVideoBackground = base64Url;
                await db.chats.put(streamerChat);
                console.log(`å·²ä¸ºAIä¸»æ’­â€œ${streamerChat.name}â€ä¿å­˜äº†æ–°çš„ç›´æ’­èƒŒæ™¯ã€‚`);
            } else if (streamerChatId === 'user') {
                // å¦‚æœä¸»æ’­æ˜¯â€œæˆ‘â€ï¼Œå¯ä»¥å°†èƒŒæ™¯ä¿å­˜åˆ°å…¨å±€è®¾ç½®æˆ–ä¸€ä¸ªç‰¹å®šçš„åœ°æ–¹
                // è¿™é‡Œæˆ‘ä»¬æš‚å®šä¸ä¸ºç”¨æˆ·ä¿å­˜ï¼Œå› ä¸ºç”¨æˆ·çš„ç›´æ’­äººè®¾æ˜¯ä¸´æ—¶çš„
                console.log("ç”¨æˆ·ä¸»æ’­æ›´æ¢äº†èƒŒæ™¯ï¼Œæœ¬æ¬¡ç›´æ’­æœ‰æ•ˆã€‚");
            }
        };
        reader.readAsDataURL(file);
    }
    e.target.value = '';
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ è¯·å°†è¿™æ®µã€æ–°ä»£ç ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾ â–¼â–¼â–¼
document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    // åˆ·æ–°èŠå¤©è®¾ç½®é‡Œçš„åˆ†ç»„åˆ—è¡¨
    const chatSettingsScreen = document.getElementById('chat-settings-screen');
    // ä¿®æ­£ï¼šæ£€æŸ¥æ–°çš„â€œè®¾ç½®å±å¹•â€æ˜¯å¦æ­£å¤„äºæ¿€æ´»çŠ¶æ€
    if (chatSettingsScreen.classList.contains('active')) {
       // å¦‚æœæ˜¯ï¼Œå°±æ¨¡æ‹Ÿç‚¹å‡»è®¾ç½®æŒ‰é’®ï¼Œä»¥é‡æ–°åŠ è½½æ•°æ®å¹¶æ˜¾ç¤ºè¯¥å±å¹•
       document.getElementById('chat-settings-btn').click(); 
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸Šä¸‹æ–‡èœå•äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);
document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);
document.getElementById('select-message-btn').addEventListener('click', () => {
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});

// æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºåœ¨ç‚¹å‡»èœå•å¤–éƒ¨æ—¶å…³é—­èœå•
window.addEventListener('click', (e) => {
    const menu = document.getElementById('message-actions-menu');
    if (menu.classList.contains('visible') && !menu.contains(e.target) && !e.target.closest('.message-wrapper')) {
        hideMessageActions();
    }
});
// â–²â–²â–² ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘è”ç³»äººé€‰æ‹©å™¨äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
    showScreen('chat-list-screen');
});

document.getElementById('contact-picker-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (!item) return;

    const contactId = item.dataset.contactId;
    item.classList.toggle('selected');
    
    if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
    } else {
        selectedContacts.add(contactId);
    }
    updateContactPickerConfirmButton();
});

// â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç»‘å®šâ€œç®¡ç†ç¾¤æˆå‘˜â€æŒ‰é’®äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('manage-members-btn').addEventListener('click', () => {
    openMemberManagementScreen();
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æœ€ç»ˆå®Œæ•´ç‰ˆã€‘ç¾¤æˆå‘˜ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('back-from-member-management').addEventListener('click', () => {

    showScreen('chat-interface-screen');    
    document.getElementById('chat-settings-btn').click();
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

document.getElementById('member-management-list').addEventListener('click', (e) => {
    // ã€å·²æ¢å¤ã€‘ç§»é™¤æˆå‘˜çš„äº‹ä»¶
    if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
    }
});

document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
    // ã€å·²æ¢å¤ã€‘ä»å¥½å‹åˆ—è¡¨æ·»åŠ çš„äº‹ä»¶
    // ã€å…³é”®ã€‘ä¸ºâ€œå®Œæˆâ€æŒ‰é’®ç»‘å®šâ€œæ‹‰äººå…¥ç¾¤â€çš„é€»è¾‘
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æ–¹æ³•æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨,é˜²æ­¢é‡å¤ç»‘å®š
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    await openContactPickerForAddMember();
});

document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘è§†é¢‘é€šè¯åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// ç»‘å®šå•èŠå’Œç¾¤èŠçš„å‘èµ·æŒ‰é’®
document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);

// ç»‘å®šâ€œæŒ‚æ–­â€æŒ‰é’®
document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);

// ç»‘å®šâ€œå–æ¶ˆå‘¼å«â€æŒ‰é’®
document.getElementById('cancel-call-btn').addEventListener('click', () => {
    videoCallState.isAwaitingResponse = false;
    showScreen('chat-interface-screen');
});

// â–¼â–¼â–¼ ç”¨è¿™ä¸ªã€å·²ä¿®å¤å¹¶æ¿€æ´»æ—è§‚æ¨¡å¼ã€‘çš„ç‰ˆæœ¬æ›¿æ¢æ—§çš„ decline-call-btn äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šæ¥ç”µè¯·æ±‚çš„â€œæ‹’ç»â€æŒ‰é’®
document.getElementById('decline-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;
    
    // ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œ,æˆ‘ä»¬å°†æ‹’ç»çš„é€»è¾‘ä¸APIè°ƒç”¨è¿æ¥èµ·æ¥
    if (videoCallState.isGroupCall) {
        videoCallState.isUserParticipating = false; // æ ‡è®°ç”¨æˆ·ä¸ºæ—è§‚è€…
        
        // 1. åˆ›å»ºä¸€æ¡éšè—æ¶ˆæ¯,é€šçŸ¥AIç”¨æˆ·æ‹’ç»äº†
        const systemNote = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤º:ç”¨æˆ·æ‹’ç»äº†é€šè¯é‚€è¯·,ä½†ä½ ä»¬å¯ä»¥è‡ªå·±å¼€å§‹ã€‚è¯·ä½ ä»¬å„è‡ªå†³ç­–æ˜¯å¦åŠ å…¥ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);
        
        // 2. ã€å…³é”®ã€‘è§¦å‘AIå“åº”,è®©å®ƒä»¬è‡ªå·±å†³å®šè¦ä¸è¦å¼€å§‹ç¾¤èŠ
        // è¿™å°†ä¼šåœ¨åå°å¤„ç†,å¦‚æœAIä»¬å†³å®šå¼€å§‹,æœ€ç»ˆä¼šè°ƒç”¨ startVideoCall()
        await triggerAiResponse(); 
        
    } else { // å•èŠæ‹’ç»é€»è¾‘ä¿æŒä¸å˜
        const declineMessage = { role: 'user', content: 'æˆ‘æ‹’ç»äº†ä½ çš„è§†é¢‘é€šè¯è¯·æ±‚ã€‚', timestamp: Date.now() };
        chat.history.push(declineMessage);
        await db.chats.put(chat);
        
        // å›åˆ°èŠå¤©ç•Œé¢å¹¶æ˜¾ç¤ºæ‹’ç»æ¶ˆæ¯
        showScreen('chat-interface-screen');
        appendMessage(declineMessage, chat);
        
        // è®©AIå¯¹ä½ çš„æ‹’ç»åšå‡ºå›åº”
        triggerAiResponse();
    }
    
    // æ¸…ç†çŠ¶æ€,ä»¥é˜²ä¸‡ä¸€
    videoCallState.isAwaitingResponse = false;
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å·²ä¿®å¤ã€‘æ¥å¬æŒ‰é’®äº‹ä»¶ï¼Œé‡æ–°è¿æ¥å…³é”®é€»è¾‘ â–¼â–¼â–¼
document.getElementById('accept-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    
    videoCallState.initiator = 'ai';
    videoCallState.isUserParticipating = true; // æ ‡è®°ç”¨æˆ·å·²å‚ä¸
    videoCallState.activeChatId = state.activeChatId;
    
    // ã€æ ¸å¿ƒä¿®å¤1ã€‘æ¢å¤ç¾¤èŠå‚ä¸è€…çš„æ·»åŠ é€»è¾‘
    if (videoCallState.isGroupCall) {
        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.originalName === videoCallState.callRequester); // æ³¨æ„è¿™é‡Œæ˜¯ originalName
        if (requester) {
            videoCallState.participants = [requester];
        } else {
            videoCallState.participants = [];
        }
    } else {
        videoCallState.participants = []; // å•èŠæ¸…ç©ºå³å¯
    }
    
    // ã€æ ¸å¿ƒä¿®å¤2ã€‘è°ƒç”¨ startVideoCall æ¥å¯åŠ¨ç•Œé¢
    startVideoCall();
    
    // ã€æ ¸å¿ƒä¿®å¤3ã€‘åœ¨ç•Œé¢å¯åŠ¨åï¼Œè°ƒç”¨ handleUserJoinCall æ¥è§¦å‘AIè¯´è¯
    // æˆ‘ä»¬éœ€è¦ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿é€šè¯çŠ¶æ€å·²æ¿€æ´»
    setTimeout(() => {
        // åœ¨è°ƒç”¨å‰ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å°† isUserParticipating è®¾ä¸º falseï¼Œä»¥â€œæ¬ºéª—â€ handleUserJoinCall å‡½æ•°è®©å®ƒæ‰§è¡Œ
        videoCallState.isUserParticipating = false; 
        handleUserJoinCall();
    }, 100); // å»¶è¿Ÿ100æ¯«ç§’
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²


// â–¼â–¼â–¼ ã€æœ€ç»ˆä¿®å¤ç‰ˆ V2ã€‘ç”¨æˆ·åœ¨é€šè¯ä¸­å‘è¨€çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('user-speak-btn').addEventListener('click', async () => {
    // 1. å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿é€šè¯æ­£åœ¨è¿›è¡Œ
    if (!videoCallState.isActive || !videoCallState.isUserParticipating) return;

    // 2. å¼¹å‡ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥å†…å®¹
    const userInput = await showCustomPrompt('ä½ è¯´', 'è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯...');
    
    // 3. ã€æ ¸å¿ƒã€‘åªæœ‰å½“ç”¨æˆ·è¾“å…¥äº†æœ‰æ•ˆå†…å®¹åï¼Œæ‰è°ƒç”¨AIæ€è€ƒå‡½æ•°
    if (userInput && userInput.trim()) {
        // ç›´æ¥å°†ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™AIå¤„ç†å‡½æ•°
        triggerAiInCallAction(userInput.trim());
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// ã€å…¨æ–°ã€‘æ‹‰é»‘åŠŸèƒ½äº‹ä»¶ç»‘å®š
document.getElementById('block-chat-btn').addEventListener('click', async () => {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

    const chat = state.chats[state.activeChatId];
    const confirmed = await showCustomConfirm(
        'ç¡®è®¤æ‹‰é»‘', 
        `ç¡®å®šè¦æ‹‰é»‘â€œ${chat.name}â€å—ï¼Ÿæ‹‰é»‘åæ‚¨å°†æ— æ³•å‘å…¶å‘é€æ¶ˆæ¯,ç›´åˆ°æ‚¨å°†Taç§»å‡ºé»‘åå•,æˆ–ç­‰å¾…Taé‡æ–°ç”³è¯·å¥½å‹ã€‚`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤º:ä½ åˆšåˆšè¢«ç”¨æˆ·æ‹‰é»‘äº†ã€‚åœ¨å¯¹æ–¹è§£é™¤æ‹‰é»‘ä¹‹å‰,ä½ æ— æ³•å†ä¸»åŠ¨å‘èµ·å¯¹è¯,ä¹Ÿæ— æ³•å›åº”ã€‚]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        
        // å…³é—­è®¾ç½®å¼¹çª—,å¹¶åˆ·æ–°èŠå¤©ç•Œé¢
        showScreen('chat-list-screen');
        renderChatInterface(state.activeChatId);
        // åˆ·æ–°èŠå¤©åˆ—è¡¨,å¯èƒ½ä¼šæœ‰UIå˜åŒ–
        renderChatList();
    }
});

document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (e.target.id === 'force-apply-check-btn') {
        alert("æ­£åœ¨æ‰‹åŠ¨è§¦å‘å¥½å‹ç”³è¯·æµç¨‹,è¯·ç¨å...\nå¦‚æœAPIè°ƒç”¨æˆåŠŸ,å°†å¼¹å‡ºæç¤ºã€‚å¦‚æœå¤±è´¥,ä¹Ÿä¼šæœ‰é”™è¯¯æç¤ºã€‚å¦‚æœé•¿æ—¶é—´æ— ååº”,è¯´æ˜AIå¯èƒ½å†³å®šæš‚æ—¶ä¸ç”³è¯·ã€‚");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id); 
        return;
    }

    if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤º:ç”¨æˆ·åˆšåˆšè§£é™¤äº†å¯¹ä½ çš„æ‹‰é»‘ã€‚ç°åœ¨ä½ ä»¬å¯ä»¥é‡æ–°å¼€å§‹å¯¹è¯äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        triggerAiResponse(); // ã€å¯é€‰ä½†æ¨èã€‘è§£é™¤åè®©AIä¸»åŠ¨è¯´ç‚¹ä»€ä¹ˆ
    }
    else if (e.target.id === 'accept-friend-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = '';

        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  â–¼â–¼â–¼
        const hiddenMessage = {
            role: 'system',
            content: `[ç³»ç»Ÿæç¤º:ç”¨æˆ·åˆšåˆšé€šè¿‡äº†ä½ çš„å¥½å‹ç”³è¯·ã€‚ä½ ä»¬ç°åœ¨åˆå¯ä»¥æ­£å¸¸èŠå¤©äº†ã€‚]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        const msg = { role: 'user', content: 'æˆ‘é€šè¿‡äº†ä½ çš„å¥½å‹è¯·æ±‚', timestamp: Date.now() };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        triggerAiResponse();
    }
    else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
    }
    // ã€æ–°å¢ã€‘å¤„ç†ç”³è¯·å¥½å‹æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
            'å‘é€å¥½å‹ç”³è¯·', 
            `è¯·è¾“å…¥ä½ æƒ³å¯¹â€œ${chat.name}â€è¯´çš„ç”³è¯·ç†ç”±:`,
            "æˆ‘ä»¬å’Œå¥½å§!"
        );
        // åªæœ‰å½“ç”¨æˆ·è¾“å…¥äº†å†…å®¹å¹¶ç‚¹å‡»â€œç¡®å®šâ€åæ‰ç»§ç»­
        if (reason !== null) {
            // æ›´æ–°å…³ç³»çŠ¶æ€ä¸ºâ€œç­‰å¾…AIæ‰¹å‡†â€
            chat.relationship.status = 'pending_ai_approval';
            chat.relationship.applicationReason = reason;
            await db.chats.put(chat);

            // åˆ·æ–°UI,æ˜¾ç¤ºâ€œç­‰å¾…é€šè¿‡â€çš„ç•Œé¢
            renderChatInterface(chat.id);
            renderChatList();
            
            // ã€å…³é”®ã€‘è§¦å‘AIå“åº”,è®©å®ƒå»å¤„ç†è¿™ä¸ªå¥½å‹ç”³è¯·
            triggerAiResponse();
        }
    }
});

            // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘ä¸»é¢˜ç®¡ç†åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

            // 2. ç»‘å®šâ€œä¿å­˜å½“å‰ä¸»é¢˜â€æŒ‰é’®
            document.getElementById('save-current-theme-btn').addEventListener('click', saveCurrentTheme);
// â–¼â–¼â–¼ è¯·ç”¨è¿™å—ã€å…¨æ–°çš„ã€å·²ä¿®å¤çš„ä»£ç ã€‘å®Œæ•´æ›¿æ¢æ‰æ—§çš„ 'saved-themes-list' äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

// ã€V4ç‰ˆ - å…¨å±€/æ°”æ³¡ä¸»é¢˜è§£è€¦ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å·²ä¿å­˜ä¸»é¢˜çš„â€œåº”ç”¨â€å’Œâ€œåˆ é™¤â€
document.getElementById('saved-themes-list').addEventListener('click', async (e) => {
    const target = e.target;
    const themeItem = target.closest('.saved-theme-item');
    if (!themeItem) return;

    const themeId = themeItem.dataset.themeId;
    const theme = await db.customThemes.get(themeId);
    if (!theme) return;

    // --- åˆ é™¤é€»è¾‘ä¿æŒä¸å˜ ---
    if (target.classList.contains('theme-delete-btn')) {
        const confirmed = await showCustomConfirm('åˆ é™¤ä¸»é¢˜', `ç¡®å®šè¦åˆ é™¤ä¸»é¢˜â€œ${theme.name}â€å—ï¼Ÿ`);
        if (confirmed) {
            await db.customThemes.delete(themeId);
            await renderSavedThemes();
        }
    } 
    // --- ã€æ ¸å¿ƒä¿®å¤ã€‘é‡æ„åº”ç”¨ä¸»é¢˜çš„é€»è¾‘ ---
    else {
        const confirmed = await showCustomConfirm('åº”ç”¨å…¨å±€ä¸»é¢˜', `ç¡®å®šè¦åº”ç”¨å…¨å±€ä¸»é¢˜â€œ${theme.name}â€å—ï¼Ÿ\n\n(æ³¨æ„:è¿™åªä¼šæ›´æ”¹é¡¶æ ã€å£çº¸ã€Appå›¾æ ‡ç­‰å…¨å±€å¤–è§‚ï¼Œä¸ä¼šå½±å“ä»»ä½•èŠå¤©çš„æ°”æ³¡æ ·å¼ã€‚)`);
        if (confirmed) {
            // 1. ã€æ ¸å¿ƒã€‘ä»ä¸»é¢˜ä¸­æå–æ‰€æœ‰å…¨å±€ç›¸å…³çš„è®¾ç½®
            const globalThemeSettings = theme.settings;

            // 2. å°†è¿™äº›è®¾ç½®åº”ç”¨åˆ° state.globalSettings
            Object.assign(state.globalSettings, globalThemeSettings);
            
            // 3. ã€æ ¸å¿ƒã€‘å°†æ›´æ–°åçš„å…¨å±€è®¾ç½®ä¿å­˜åˆ°æ•°æ®åº“
            await db.globalSettings.put(state.globalSettings);

            // 4. åˆ·æ–°æ‰€æœ‰ä¸å…¨å±€ä¸»é¢˜ç›¸å…³çš„UI
            applyCurrentTheme();
            applyGlobalCustomCss(state.globalSettings.globalCustomCss);
            applyAppIcons();
            
            // 5. ã€é‡è¦ã€‘å¦‚æœå½“å‰åœ¨èŠå¤©ç•Œé¢ï¼Œéœ€è¦é‡ç»˜ä¸€æ¬¡ä»¥ç¡®ä¿èƒŒæ™¯ç­‰å…¨å±€å…ƒç´ æ›´æ–°
            if (state.activeChatId && state.chats[state.activeChatId]) {
                renderChatInterface(state.activeChatId);
            }
            
            // 6. åˆ·æ–°å¤–è§‚è®¾ç½®é¡µé¢ï¼Œè®©UIåŒæ­¥
            renderWallpaperScreen();
            
            // 7. ã€æ ¸å¿ƒã€‘ä¿®æ”¹æç¤ºä¿¡æ¯ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·åªä¿®æ”¹äº†å…¨å±€ä¸»é¢˜
            alert(`å…¨å±€ä¸»é¢˜â€œ${theme.name}â€å·²æˆåŠŸåº”ç”¨!`);
        }
    }
});

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘çº¢åŒ…åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// 1. å°†åŸæœ‰çš„è½¬è´¦æŒ‰é’®(ï¿¥)çš„ç‚¹å‡»äº‹ä»¶,é‡å®šå‘åˆ°æ–°çš„æ€»å…¥å£å‡½æ•°
document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);

// 2. çº¢åŒ…æ¨¡æ€æ¡†å†…éƒ¨çš„æ§åˆ¶æŒ‰é’®
document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
    document.getElementById('red-packet-modal').classList.remove('visible');
});
document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);

// 3. çº¢åŒ…æ¨¡æ€æ¡†çš„é¡µç­¾åˆ‡æ¢é€»è¾‘
const rpTabGroup = document.getElementById('rp-tab-group');
const rpTabDirect = document.getElementById('rp-tab-direct');
const rpContentGroup = document.getElementById('rp-content-group');
const rpContentDirect = document.getElementById('rp-content-direct');

rpTabGroup.addEventListener('click', () => {
    rpTabGroup.classList.add('active');
    rpTabDirect.classList.remove('active');
    rpContentGroup.style.display = 'block';
    rpContentDirect.style.display = 'none';
});
rpTabDirect.addEventListener('click', () => {
    rpTabDirect.classList.add('active');
    rpTabGroup.classList.remove('active');
    rpContentDirect.style.display = 'block';
    rpContentGroup.style.display = 'none';
});

// 4. å®æ—¶æ›´æ–°çº¢åŒ…é‡‘é¢æ˜¾ç¤º
document.getElementById('rp-group-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-group-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});
document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-direct-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});

// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°æ·»åŠ ã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†çº¢åŒ…ç‚¹å‡»,ä¿®å¤å¤±æ•ˆé—®é¢˜ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æ‰¾åˆ°è¢«ç‚¹å‡»çš„çº¢åŒ…å¡ç‰‡
    const packetCard = e.target.closest('.red-packet-card');
    if (!packetCard) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯çº¢åŒ…,å°±ä»€ä¹ˆä¹Ÿä¸åš

    // 2. ä»çº¢åŒ…å¡ç‰‡çš„çˆ¶çº§.message-bubbleè·å–æ—¶é—´æˆ³
    const messageBubble = packetCard.closest('.message-bubble');
    if (!messageBubble || !messageBubble.dataset.timestamp) return;

    // 3. è°ƒç”¨æˆ‘ä»¬ç°æœ‰çš„å¤„ç†å‡½æ•°
    const timestamp = parseInt(messageBubble.dataset.timestamp);
    handlePacketClick(timestamp);
});
// â–²â–²â–² æ–°å¢ä»£ç ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æŠ•ç¥¨åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// åœ¨è¾“å…¥æ¡†å·¥å…·æ æ·»åŠ æŒ‰é’®
document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);

// æŠ•ç¥¨åˆ›å»ºæ¨¡æ€æ¡†çš„æŒ‰é’®
document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
    document.getElementById('create-poll-modal').classList.remove('visible');
});
document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æŠ•ç¥¨å¡ç‰‡å†…çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const pollCard = e.target.closest('.poll-card');
    if (!pollCard) return;

    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
    if (isNaN(timestamp)) return;
    
    // ç‚¹å‡»äº†é€‰é¡¹
    const optionItem = e.target.closest('.poll-option-item');
    if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
    }
    
    // ç‚¹å‡»äº†åŠ¨ä½œæŒ‰é’®(ç»“æŸæŠ•ç¥¨/æŸ¥çœ‹ç»“æœ)
    const actionBtn = e.target.closest('.poll-action-btn');
    if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        } else {
            endPoll(timestamp);
        }
        return;
    }

    // å¦‚æœæ˜¯å·²ç»“æŸçš„æŠ•ç¥¨,ç‚¹å‡»å¡ç‰‡ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥æŸ¥çœ‹ç»“æœ
    if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç›‘å¬å™¨ç²˜è´´ç»“æŸ â–²â–²â–²

  // â–¼â–¼â–¼ ã€å…¨æ–°ã€‘AIå¤´åƒåº“åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
document.getElementById('add-ai-avatar-btn').addEventListener('click', addAvatarToLibrary);
document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
// â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

 /**
         * ã€å…¨æ–°ã€‘ä¸€ä¸ªè¾…åŠ©å‡½æ•°,ç”¨äºæ›´æ–°å›¾æ ‡çŠ¶æ€å’Œé¢„è§ˆ
         * @param {string} iconId - è¦æ›´æ–°çš„å›¾æ ‡ID
         * @param {string} newUrl - æ–°çš„å›¾ç‰‡URL (å¯ä»¥æ˜¯base64æˆ–httpé“¾æ¥)
         */
        function updateIconPreviewAndState(iconId, newUrl) {
            // 1. æ›´æ–°å†…å­˜ä¸­çš„ state å¯¹è±¡
            state.globalSettings.appIcons[iconId] = newUrl;
            
            // 2. å®æ—¶æ›´æ–°â€œå¤–è§‚è®¾ç½®â€é¡µé¢ä¸Šçš„é¢„è§ˆå›¾
            const previewImg = document.querySelector(`.icon-setting-item[data-icon-id="${iconId}"] .icon-preview`);
            if (previewImg) {
                previewImg.src = newUrl;
            }
        }

        // ã€å…¨æ–°é‡æ„ç‰ˆã€‘ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰å›¾æ ‡è®¾ç½®é¡¹çš„ç‚¹å‡»
        document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
            const target = e.target;
            const item = target.closest('.icon-setting-item');
            if (!item) return;

            const iconId = item.dataset.iconId;
            if (!iconId) return;

            // æƒ…å†µä¸€:ç‚¹å‡»äº†â€œä¸Šä¼ â€æŒ‰é’®
            if (target.classList.contains('icon-upload-btn')) {
                const fileInput = document.getElementById('app-icon-upload-input');
                
                // ã€æ ¸å¿ƒã€‘åˆ›å»ºä¸€ä¸ªä¸€æ¬¡æ€§çš„ change äº‹ä»¶ç›‘å¬å™¨
                const handleFileChange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => {
                            const base64Url = readEvent.target.result;
                            updateIconPreviewAndState(iconId, base64Url);
                        };
                        reader.readAsDataURL(file);
                    }
                    // ä»»åŠ¡å®Œæˆå,ç«‹å³ç§»é™¤ç›‘å¬å™¨,é˜²æ­¢ä¸‹æ¬¡å½±å“å…¶ä»–å›¾æ ‡
                    fileInput.removeEventListener('change', handleFileChange);
                    fileInput.value = null; // æ¸…ç©ºinput,ç¡®ä¿ä¸‹æ¬¡é€‰æ‹©åŒåæ–‡ä»¶ä¹Ÿèƒ½è§¦å‘change
                };
                
                fileInput.addEventListener('change', handleFileChange);
                fileInput.click(); // è§¦å‘æ–‡ä»¶é€‰æ‹©æ¡†
            }

            // æƒ…å†µäºŒ:ç‚¹å‡»äº†â€œURLâ€æŒ‰é’®
            if (target.classList.contains('icon-url-btn')) {
                const currentUrl = state.globalSettings.appIcons[iconId];
                const newUrl = await showCustomPrompt(`æ›´æ¢â€œ${item.querySelector('.label').textContent}â€å›¾æ ‡`, 'è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL', currentUrl, 'url');

                if (newUrl && newUrl.trim().startsWith('http')) {
                    updateIconPreviewAndState(iconId, newUrl.trim());
                } else if (newUrl !== null) {
                    alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„URL!");
                }
            }
        });
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// çº¿ä¸‹æ¨¡å¼äº‹ä»¶ç»‘å®š
document.getElementById('start-offline-mode-btn').addEventListener('click', handleInitiateOfflineMode);
document.getElementById('end-offline-mode-btn').addEventListener('click', endOfflineMode);
document.getElementById('user-offline-action-btn').addEventListener('click', handleUserOfflineInput);
// â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾,ç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼

    document.getElementById('chat-messages').addEventListener('click', (e) => {
        // ä½¿ç”¨ .closest() å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å¡ç‰‡
        const linkCard = e.target.closest('.link-share-card');
        if (linkCard) {
            const timestamp = parseInt(linkCard.dataset.timestamp);
            if (!isNaN(timestamp)) {
                openBrowser(timestamp); // è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°
            }
        }
    });

    // æµè§ˆå™¨è¿”å›æŒ‰é’®çš„äº‹ä»¶ç›‘å¬,ç¡®ä¿å®ƒåªç»‘å®šä¸€æ¬¡
    document.getElementById('browser-back-btn').addEventListener('click', () => {
        showScreen('chat-interface-screen');
    });

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°å¯é çš„äº‹ä»¶å¤„ç†é€»è¾‘ã€‘ç²˜è´´åˆ° init() çš„äº‹ä»¶ç›‘å¬åŒº â–¼â–¼â–¼

/**
 * ã€è¾…åŠ©å‡½æ•°ã€‘å¤„ç†æ‰€æœ‰å¤´åƒæ¡†åº”ç”¨/ç§»é™¤çš„æ“ä½œ
 * @param {string} choice - ç”¨æˆ·çš„é€‰æ‹© (e.g., 'me', 'ai', 'remove_me')
 */
async function handleFrameApplyChoice(choice) {
    const modal = document.getElementById('avatar-frame-apply-modal');
    const frameUrl = modal.dataset.frameUrl || ''; // ä»ä¸»DIVè·å–URL
    const chat = state.chats[state.activeChatId];
    if (!chat || !choice || choice === 'cancel') {
        modal.classList.remove('visible');
        return;
    }

    // æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©,æ›´æ–°èŠå¤©è®¾ç½®
    switch (choice) {
        case 'me':        chat.settings.myAvatarFrame = frameUrl; break;
        case 'ai':        chat.settings.aiAvatarFrame = frameUrl; break;
        case 'remove_me': chat.settings.myAvatarFrame = '';     break;
        case 'remove_ai': chat.settings.aiAvatarFrame = '';     break;
    }

    // ä¿å­˜è®¾ç½®å¹¶åˆ·æ–°æ‰€æœ‰ç›¸å…³UI
    await db.chats.put(chat);
    modal.classList.remove('visible'); // å…³é—­åº”ç”¨å¼¹çª—
    closeAvatarFrameLibrary();     // åŒæ—¶å…³é—­å¤´åƒæ¡†åº“

    // å¼ºåˆ¶åˆ·æ–°èŠå¤©è®¾ç½®å±å¹•(å¦‚æœå®ƒæ˜¯æ‰“å¼€çš„)
const chatSettingsScreen = document.getElementById('chat-settings-screen');
// ä¿®æ­£ï¼šæ£€æŸ¥æ–°çš„è®¾ç½®å±å¹•æ˜¯å¦å¤„äº active çŠ¶æ€
if (chatSettingsScreen.classList.contains('active')) { 
    // ç‚¹å‡»ä¸€æ¬¡å³å¯é‡æ–°åŠ è½½æ•°æ®å¹¶æ˜¾ç¤ºå±å¹•
    document.getElementById('chat-settings-btn').click(); 
}
    
    // åˆ·æ–°èŠå¤©ç•Œé¢å’Œåˆ—è¡¨,è®©æ–°å¤´åƒæ¡†ç«‹åˆ»ç”Ÿæ•ˆ
    renderChatInterface(state.activeChatId);
    renderChatList();
}

// ã€äº‹ä»¶å§”æ‰˜ã€‘ä¸ºæ•´ä¸ªåº”ç”¨å¼¹çª—ç»‘å®šä¸€ä¸ªç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
document.getElementById('avatar-frame-apply-modal').addEventListener('click', (e) => {
    // æ£€æŸ¥è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦æ˜¯ä¸€ä¸ªå¸¦æœ‰ data-choice å±æ€§çš„æŒ‰é’®
    const choice = e.target.dataset.choice;
    if (choice) {
        // å¦‚æœæ˜¯,å°±è°ƒç”¨æˆ‘ä»¬çš„æ ¸å¿ƒå¤„ç†å‡½æ•°
        handleFrameApplyChoice(choice);
    }
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²```

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„æœ«å°¾,ç²˜è´´è¿™æ®µã€å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ã€‘ â–¼â–¼â–¼

    // 1. ç»‘å®šè¾“å…¥æ¡†ä¸Šæ–¹â€œåˆ†äº«é“¾æ¥â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);

    // 2. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œå–æ¶ˆâ€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
        document.getElementById('share-link-modal').classList.remove('visible');
    });

    // 3. ç»‘å®šæ¨¡æ€æ¡†ä¸­â€œåˆ†äº«â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);

            // ã€å…¨æ–°ã€‘ä¸ºæ‰‹æœºè¾¹æ¡†åˆ‡æ¢å¼€å…³ç»‘å®šäº‹ä»¶
            document.getElementById('border-toggle-switch').addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                // 1. å®æ—¶æ›´æ–°è§†è§‰æ•ˆæœ
                document.body.classList.toggle('bordered-mode', isChecked);
                // 2. å®æ—¶æ›´æ–°å†…å­˜ä¸­çš„çŠ¶æ€,ä»¥ä¾¿â€œä¿å­˜â€æŒ‰é’®å¯ä»¥è·å–åˆ°æœ€æ–°å€¼
                state.globalSettings.borderMode = isChecked ? 'bordered' : 'borderless';
            });

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ,ç²˜è´´ä¸‹é¢è¿™å‡ è¡Œ â–¼â–¼â–¼
// ç»‘å®šæ¶ˆæ¯æ“ä½œèœå•ä¸­çš„â€œå¼•ç”¨â€æŒ‰é’®
document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);

// ç»‘å®šå›å¤é¢„è§ˆæ ä¸­çš„â€œå–æ¶ˆâ€æŒ‰é’®
document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// åœ¨ä½ çš„ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ...

// â–¼â–¼â–¼ ç”¨è¿™æ®µä»£ç æ›¿æ¢æ—§çš„è½¬è´¦å¡ç‰‡ç‚¹å‡»äº‹ä»¶ â–¼â–¼â–¼
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. å‘ä¸ŠæŸ¥æ‰¾è¢«ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªæ¶ˆæ¯æ°”æ³¡å†…
    const bubble = e.target.closest('.message-bubble');
    if (!bubble) return; // å¦‚æœä¸åœ¨,å°±é€€å‡º

    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è¿™é‡Œæ·»åŠ ä¸¥æ ¼çš„ç­›é€‰æ¡ä»¶
    // å¿…é¡»æ˜¯ AI çš„æ¶ˆæ¯ (.ai)
    // å¿…é¡»æ˜¯è½¬è´¦ç±»å‹ (.is-transfer)
    // å¿…é¡»æ˜¯æˆ‘ä»¬æ ‡è®°ä¸ºâ€œå¾…å¤„ç†â€çš„ (data-status="pending")
    if (bubble.classList.contains('ai') && 
        bubble.classList.contains('is-transfer') && 
        bubble.dataset.status === 'pending') {
        
        // 3. åªæœ‰æ»¡è¶³æ‰€æœ‰æ¡ä»¶,æ‰æ‰§è¡Œåç»­é€»è¾‘
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
            showTransferActionModal(timestamp);
        }
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ æ‰¾åˆ°æ—§çš„ vinylUploadInput äº‹ä»¶ç›‘å¬å™¨,ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢å®ƒ â–¼â–¼â–¼

vinylUploadInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const newCoverUrl = e.target.result;
            
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
            // 1. åŒæ—¶æ›´æ–°æ¨¡ç³ŠèƒŒæ™¯
            document.getElementById('vinyl-player-container').style.backgroundImage = `url(${newCoverUrl})`;
            
            // 2. åŒæ—¶æ›´æ–°ä¸­é—´çš„ä¸“è¾‘å°é¢å›¾
            document.getElementById('vinyl-album-art').src = newCoverUrl;

            // 3. å°†å›¾ç‰‡åœ°å€ä¿å­˜åˆ°localStorage,ä»¥ä¾¿åˆ·æ–°åä¿ç•™(è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
            localStorage.setItem('vinylCoverUrl', newCoverUrl);
        };
        reader.readAsDataURL(file);
    }
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ æ‰¾åˆ°è¯»å– localStorage çš„æ—§ä»£ç ,ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢å®ƒ â–¼â–¼â–¼

const savedVinylCover = localStorage.getItem('vinylCoverUrl');
if (savedVinylCover) {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
    // é¡µé¢åŠ è½½æ—¶,ä¹Ÿéœ€è¦åŒæ—¶æ›´æ–°èƒŒæ™¯å’Œå°é¢å›¾
    document.getElementById('vinyl-player-container').style.backgroundImage = `url(${savedVinylCover})`;
    document.getElementById('vinyl-album-art').src = savedVinylCover;
}

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€åŠŸèƒ½ä¿®å¤ç‰ˆã€‘äººè®¾åº“ç›¸å…³äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

// 1. ä¸ºâ€œäººè®¾åº“â€ä¸»å¼¹çª—çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);

// 2. ä¸ºâ€œæ·»åŠ /ç¼–è¾‘äººè®¾â€å¼¹çª—çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);

// 3. ä¸ºâ€œé•¿æŒ‰æ“ä½œâ€å¼¹çª—çš„æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);

// â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€å…¨æ–°ã€‘æ·˜å®/ç¤¼ç‰©åŠŸèƒ½äº‹ä»¶ç»‘å®š â–¼â–¼â–¼
document.getElementById('open-shopping-btn').addEventListener('click', openShoppingModal);
document.getElementById('shopping-cancel-btn').addEventListener('click', () => {
    document.getElementById('shopping-modal').classList.remove('visible');
});

document.getElementById('shopping-action-give').addEventListener('click', () => sendGiftAction('give'));
document.getElementById('shopping-action-request').addEventListener('click', () => sendGiftAction('request'));

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç¤¼ç‰©å¡ç‰‡çš„ç‚¹å‡»
document.getElementById('chat-messages').addEventListener('click', async (e) => {
    const giftCard = e.target.closest('.gift-card');
    const messageBubble = e.target.closest('.message-bubble');
    if (!giftCard || !messageBubble) return;

    const timestamp = parseInt(messageBubble.dataset.timestamp);
    const chat = state.chats[state.activeChatId];
    const msg = chat.history.find(m => m.timestamp === timestamp);

    // åªæœ‰å½“æ˜¯å¯¹æ–¹å‘æ¥çš„ã€ä¸”çŠ¶æ€æ˜¯pendingæ—¶ï¼Œæ‰å“åº”ç‚¹å‡»
    if (msg && msg.role === 'assistant' && msg.status === 'pending') {
        const actionText = msg.action === 'give' ? 'æ¥å—' : 'åŒæ„';
        const confirmed = await showCustomConfirm(
            `å›åº” ${msg.senderName}`,
            `ä½ ç¡®å®šè¦â€œ${actionText}â€è¿™ä¸ªè¯·æ±‚å—ï¼Ÿ`,
            { confirmButtonClass: 'btn-danger' }
        );
        if (confirmed) {
            msg.status = 'accepted';
        } else {
            msg.status = 'declined';
        }
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
});
// â–²â–²â–² æ–°äº‹ä»¶ç»‘å®šç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€Cã€‘ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬,æ›¿æ¢æ—§çš„ close-cute-event-viewer-btn ç›‘å¬å™¨ â–¼â–¼â–¼
document.getElementById('close-cute-event-viewer-btn').addEventListener('click', () => {
    const modal = document.getElementById('cute-event-viewer-modal');
    
    if (modal.dataset.editingId) {
        // å¦‚æœå½“å‰æ˜¯ç¼–è¾‘æ¨¡å¼,ç‚¹å‡»â€œå…³é—­â€æŒ‰é’®å°±æ˜¯â€œå–æ¶ˆâ€æ“ä½œ
        
        // 1. å°è¯•è·å–åŸå§‹äº‹ä»¶(ç¡®ä¿å–æ¶ˆåèƒ½æ¢å¤åˆ°æ­£ç¡®å†…å®¹)
        const eventId = parseInt(modal.dataset.editingId);
        db.calendarEvents.get(eventId).then(originalEvent => {
            if (originalEvent) {
                // 2. åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
                disableCuteViewerEditMode(originalEvent);
            } else {
                // 3. å¦‚æœæ‰¾ä¸åˆ°åŸå§‹äº‹ä»¶(å¯èƒ½åˆšè¢«åˆ é™¤),ç›´æ¥å…³é—­
                modal.classList.remove('visible');
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        });
    } else {
        // å¦‚æœä¸æ˜¯ç¼–è¾‘æ¨¡å¼,ç›´æ¥å…³é—­
        modal.classList.remove('visible');
    }
});
// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºäº”å­æ£‹èŠå¤©ç•Œé¢çš„å‘é€æŒ‰é’®ç»‘å®šäº‹ä»¶ â–¼â–¼â–¼

document.getElementById('auto-chess-send-btn').addEventListener('click', async () => {
    const input = document.getElementById('auto-chess-input');
    const text = input.value.trim();
    
    // 1. æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©º
    if (!text || !state.activeChatId || !gomokuState.isActive) return;

    // 2. å°†ç”¨æˆ·çš„æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©æ¡†
    addMessageToAutoChessChat('user', text);
    
    // 3. æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    // 4. æ„å»ºä¸€ä¸ªæ¸…æ™°çš„äº‹ä»¶æè¿°ï¼Œè§¦å‘AIå›åº”
    const eventDescriptionForAI = `[ç³»ç»Ÿäº‹ä»¶ï¼šç”¨æˆ·åœ¨èŠå¤©æ¡†å‘é€äº†æ¶ˆæ¯ï¼šâ€œ${text}â€]`;
    await triggerAiInAutoChess(eventDescriptionForAI);
});

// â–²â–²â–² ä¿®å¤ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// ä¸ºæ–°è®¾ç½®å±å¹•çš„è¿”å›æŒ‰é’®ç»‘å®šäº‹ä»¶
document.getElementById('back-from-settings-btn').addEventListener('click', () => {
    // ç‚¹å‡»è¿”å›ï¼Œç›´æ¥å›åˆ°èŠå¤©ç•Œé¢
    showScreen('chat-interface-screen');
});

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬åŒºåŸŸæ·»åŠ 
document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);

// â–¼â–¼â–¼ ç”¨è¿™æ®µã€æ–°ä»£ç ã€‘æ›¿æ¢æ—§çš„é€šè¯è®°å½•äº‹ä»¶ç»‘å®š â–¼â–¼â–¼

document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);

// 2. ç»‘å®šé€šè¯è®°å½•é¡µé¢çš„â€œè¿”å›â€æŒ‰é’®
document.getElementById('call-history-back-btn').addEventListener('click', () => {
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿”å›åˆ°èŠå¤©åˆ—è¡¨é¡µé¢,è€Œä¸æ˜¯èŠå¤©ç•Œé¢
    showScreen('chat-list-screen');
});

// 3. ç›‘å¬å¡ç‰‡ç‚¹å‡»çš„é€»è¾‘ä¿æŒä¸å˜
document.getElementById('call-history-list').addEventListener('click', (e) => {
    const card = e.target.closest('.call-record-card');
    if (card && card.dataset.recordId) {
        showCallTranscript(parseInt(card.dataset.recordId));
    }
});

// 4. å…³é—­è¯¦æƒ…å¼¹çª—çš„é€»è¾‘ä¿æŒä¸å˜
document.getElementById('close-transcript-modal-btn').addEventListener('click', () => {
    document.getElementById('call-transcript-modal').classList.remove('visible');
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯è¯­éŸ³æ¡
    const voiceBody = e.target.closest('.voice-message-body');
    if (!voiceBody) return;

    // 2. æ‰¾åˆ°ç›¸å…³çš„DOMå…ƒç´ 
    const bubble = voiceBody.closest('.message-bubble');
    if (!bubble) return;
    
    const spinner = voiceBody.querySelector('.loading-spinner');
    const transcriptEl = bubble.querySelector('.voice-transcript');

    // å¦‚æœæ­£åœ¨åŠ è½½ä¸­,åˆ™ä¸å“åº”ç‚¹å‡»
    if (bubble.dataset.state === 'loading') {
        return;
    }

    // 3. å¦‚æœæ–‡å­—å·²ç»å±•å¼€,åˆ™æ”¶èµ·
    if (bubble.dataset.state === 'expanded') {
        transcriptEl.style.display = 'none';
        bubble.dataset.state = 'collapsed';
    } 
    // 4. å¦‚æœæ˜¯æ”¶èµ·çŠ¶æ€,åˆ™å¼€å§‹â€œè½¬å½•â€æµç¨‹
    else {
        bubble.dataset.state = 'loading'; // è¿›å…¥åŠ è½½çŠ¶æ€
        spinner.style.display = 'block';   // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

        // æ¨¡æ‹Ÿ1.5ç§’çš„è¯­éŸ³è¯†åˆ«è¿‡ç¨‹
        setTimeout(() => {
            // æ£€æŸ¥æ­¤æ—¶å…ƒç´ æ˜¯å¦è¿˜å­˜åœ¨(å¯èƒ½ç”¨æˆ·å·²ç»åˆ‡æ¢äº†èŠå¤©)
            if (document.body.contains(bubble)) {
                const voiceText = bubble.dataset.voiceText || '(æ— æ³•è¯†åˆ«)';
                transcriptEl.textContent = voiceText; // å¡«å……æ–‡å­—
                
                spinner.style.display = 'none';      // éšè—åŠ è½½åŠ¨ç”»
                transcriptEl.style.display = 'block';// æ˜¾ç¤ºæ–‡å­—
                bubble.dataset.state = 'expanded';     // è¿›å…¥å±•å¼€çŠ¶æ€
            }
        }, 500);
    }
});

document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('selection-share-btn').addEventListener('click', () => {
    if (selectedMessages.size > 0) {
        openShareTargetPicker(); // æ‰“å¼€æˆ‘ä»¬å³å°†åˆ›å»ºçš„ç›®æ ‡é€‰æ‹©å™¨
    }
});

// â–¼â–¼â–¼ ã€æœ€ç»ˆç‰ˆ - å…¼å®¹ç§»åŠ¨ç«¯å›è½¦ã€‘è¯·ç”¨è¿™ã€ä¸€æ•´å—ã€‘å…¨æ–°çš„ä»£ç ï¼Œæ›¿æ¢æ—§çš„ postsList 'keydown' ç›‘å¬å™¨ â–¼â–¼â–¼

// --- ä¸ºæ•´ä¸ªåŠ¨æ€åˆ—è¡¨æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ (åŒæ—¶å¤„ç† keydown å’Œ keypress) ---
postsList.addEventListener('keypress', (e) => {
    // æ£€æŸ¥äº‹ä»¶æ˜¯å¦å‘ç”Ÿåœ¨è¯„è®ºè¾“å…¥æ¡†ï¼Œå¹¶ä¸”æŒ‰ä¸‹çš„æ˜¯Enteré”®
    // e.which === 13 æ˜¯ä¸ºäº†æ›´å¥½åœ°å…¼å®¹ç§»åŠ¨ç«¯æµè§ˆå™¨
    if (e.target.matches('.comment-input') && (e.key === 'Enter' || e.which === 13) && !e.shiftKey) {
        
        // 1. é˜»æ­¢é»˜è®¤è¡Œä¸º (è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼)
        //    å®ƒä¼šé˜»æ­¢è½¯é”®ç›˜çš„å›è½¦é”®æ‰§è¡Œæ¢è¡Œæˆ–è·³è½¬åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†çš„æ“ä½œã€‚
        e.preventDefault(); 
        
        // 2. æ‰¾åˆ°è¯¥è¾“å…¥æ¡†æ—è¾¹çš„å‘é€æŒ‰é’®
        const postContainer = e.target.closest('.qzone-post-container');
        if (postContainer) {
            const sendBtn = postContainer.querySelector('.comment-send-btn');
            if (sendBtn) {
                // 3. æ¨¡æ‹Ÿä¸€æ¬¡å¯¹å‘é€æŒ‰é’®çš„ç‚¹å‡»
                sendBtn.click();
            }
        }
    }
});

// â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
    const sourceChat = state.chats[state.activeChatId];
    const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                   .map(cb => cb.dataset.chatId);

    if (selectedTargetIds.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ†äº«çš„èŠå¤©ã€‚");
        return;
    }

    // 1. æ‰“åŒ…èŠå¤©è®°å½•
    const sharedHistory = [];
    const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
    for (const timestamp of sortedTimestamps) {
        const msg = sourceChat.history.find(m => m.timestamp === timestamp);
        if (msg) {
            sharedHistory.push(msg);
        }
    }
    
    // 2. åˆ›å»ºåˆ†äº«å¡ç‰‡æ¶ˆæ¯å¯¹è±¡
    const shareCardMessage = {
        role: 'user',
        senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'æˆ‘') : 'æˆ‘',
        type: 'share_card',
        timestamp: Date.now(),
        payload: {
            sourceChatName: sourceChat.name,
            title: `æ¥è‡ªâ€œ${sourceChat.name}â€çš„èŠå¤©è®°å½•`,
            sharedHistory: sharedHistory
        }
    };

    // 3. å¾ªç¯å‘é€åˆ°æ‰€æœ‰ç›®æ ‡èŠå¤©
    for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
            targetChat.history.push(shareCardMessage);
            await db.chats.put(targetChat);
        }
    }
    
    // 4. æ”¶å°¾å·¥ä½œ
    document.getElementById('share-target-modal').classList.remove('visible');
    exitSelectionMode(); // é€€å‡ºå¤šé€‰æ¨¡å¼
    await showCustomAlert("åˆ†äº«æˆåŠŸ", `èŠå¤©è®°å½•å·²æˆåŠŸåˆ†äº«åˆ° ${selectedTargetIds.length} ä¸ªä¼šè¯ä¸­ã€‚`);
    renderChatList(); // åˆ·æ–°åˆ—è¡¨,å¯èƒ½ä¼šæœ‰æ–°æ¶ˆæ¯æç¤º
});

// ç»‘å®šå–æ¶ˆæŒ‰é’®
document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
    document.getElementById('share-target-modal').classList.remove('visible');
});

// åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæ·»åŠ 
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // ...ä½ å·²æœ‰çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶é€»è¾‘...

    // æ–°å¢é€»è¾‘:å¤„ç†åˆ†äº«å¡ç‰‡çš„ç‚¹å‡»
    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
    }
});

// ç»‘å®šæŸ¥çœ‹å™¨çš„å…³é—­æŒ‰é’®
document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
    document.getElementById('shared-history-viewer-modal').classList.remove('visible');
});

// åˆ›å»ºæ–°å‡½æ•°æ¥å¤„ç†æ¸²æŸ“é€»è¾‘
function openSharedHistoryViewer(timestamp) {
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_card') return;

    const viewerModal = document.getElementById('shared-history-viewer-modal');
    const viewerTitle = document.getElementById('shared-history-viewer-title');
    const viewerContent = document.getElementById('shared-history-viewer-content');

    viewerTitle.textContent = message.payload.title;
    viewerContent.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

    // ã€æ ¸å¿ƒã€‘å¤ç”¨ createMessageElement æ¥æ¸²æŸ“æ¯ä¸€æ¡è¢«åˆ†äº«çš„æ¶ˆæ¯
    message.payload.sharedHistory.forEach(sharedMsg => {
        // æ³¨æ„:è¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ sourceChat å¯¹è±¡,ä»¥ç¡®ä¿å¤´åƒã€æ˜µç§°ç­‰æ­£ç¡®
        const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
        const bubbleEl = createMessageElement(sharedMsg, sourceChat);
        if (bubbleEl) {
            viewerContent.appendChild(bubbleEl);
        }
    });

    viewerModal.classList.add('visible');
}

audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
    } 
});
audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
    } 
});

document.getElementById('playlist-body').addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('delete-track-btn')) {
        const index = parseInt(target.dataset.index);
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('åˆ é™¤æ­Œæ›²', `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`);
        if (confirmed) {
            deleteTrack(index);
        }
        return;
    }
    if (target.classList.contains('lyrics-btn')) {
        const index = parseInt(target.dataset.index);
        if (isNaN(index)) return;
        const lrcContent = await new Promise(resolve => {
            const lrcInput = document.getElementById('lrc-upload-input');
            const handler = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (re) => resolve(re.target.result);
                    reader.readAsText(file);
                } else {
                    resolve(null);
                }
                lrcInput.removeEventListener('change', handler);
                lrcInput.value = '';
            };
            lrcInput.addEventListener('change', handler);
            lrcInput.click();
        });
        if (lrcContent !== null) {
            musicState.playlist[index].lrcContent = lrcContent;
            await saveGlobalPlaylist();
            alert('æ­Œè¯å¯¼å…¥æˆåŠŸ!');
            if (musicState.currentIndex === index) {
                musicState.parsedLyrics = parseLRC(lrcContent);
                renderLyrics();
            }
        }
    }
});

document.querySelector('.progress-bar').addEventListener('click', (e) => {
    if (!audioPlayer.duration) return;
    const progressBar = e.currentTarget;
    const barWidth = progressBar.clientWidth;
    const clickX = e.offsetX;
    audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
});

// â–¼â–¼â–¼ åœ¨ init() å‡½æ•°çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ,ç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰â€œå·²æ’¤å›æ¶ˆæ¯â€çš„ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // æ£€æŸ¥è¢«ç‚¹å‡»çš„å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ æ˜¯å¦æ˜¯â€œå·²æ’¤å›â€æç¤º
    const placeholder = e.target.closest('.recalled-message-placeholder');
    if (!placeholder) return; // å¦‚æœä¸æ˜¯,å°±é€€å‡º

    // å¦‚æœæ˜¯,å°±ä»èŠå¤©è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å¹¶æ˜¾ç¤º
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper'); // æ‰¾åˆ°å®ƒçš„çˆ¶å®¹å™¨
    if (chat && wrapper) {
        // ä»çˆ¶å®¹å™¨ä¸Šæ‰¾åˆ°æ—¶é—´æˆ³
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
        
        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;
            
            if (recalled.originalType === 'text') {
                originalContentText = `åŸæ–‡: "${recalled.originalContent}"`;
            } else {
                originalContentText = `æ’¤å›äº†ä¸€æ¡[${recalled.originalType}]ç±»å‹çš„æ¶ˆæ¯`;
            }
            showCustomAlert('å·²æ’¤å›çš„æ¶ˆæ¯', originalContentText);
        }
    }
});

// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ,ç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
document.getElementById('close-category-manager-btn').addEventListener('click', () => {
    document.getElementById('world-book-category-manager-modal').classList.remove('visible');
    renderWorldBookScreen(); // å…³é—­ååˆ·æ–°ä¸»åˆ—è¡¨
});
document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
document.getElementById('existing-categories-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteCategory(categoryId);
    }
});
// â–²â–²â–² æ–°ä»£ç ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾,ç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼

// æ¸¸æˆé¢æ¿æ§åˆ¶
document.getElementById('open-game-panel-btn').addEventListener('click', openGamePanel);
document.getElementById('close-game-panel-btn').addEventListener('click', closeGamePanel);

// æ¸¸æˆå¼€å§‹æŒ‰é’®
document.getElementById('start-truth-dare-btn').addEventListener('click', () => startGame('truth_or_dare'));
document.getElementById('start-erotic-cards-btn').addEventListener('click', () => startGame('erotic_cards'));
document.getElementById('start-standalone-dice-btn').addEventListener('click', () => startGame('dice_roll'));

// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸæœ«å°¾,ç²˜è´´è¿™æ®µæ–°ä»£ç  â–¼â–¼â–¼
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰æ¸¸æˆæ“ä½œæŒ‰é’®çš„ç‚¹å‡»
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const target = e.target;
    if (target.classList.contains('game-action-btn')) {
        const action = target.dataset.action;
        const timestamp = parseInt(target.dataset.timestamp);
        if (action && !isNaN(timestamp)) {
            handleGameActionClick(action, timestamp);
        }
    }
});
// â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²

// â–¼â–¼â–¼ 2. åœ¨ init() çš„äº‹ä»¶ç›‘å¬å™¨åŒºåŸŸ,ç²˜è´´è¿™æ•´å—å…¨æ–°çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
// ç»‘å®šâ€œä¿å­˜å½“å‰CSSä¸ºä¸»é¢˜â€æŒ‰é’®
document.getElementById('save-custom-css-theme-btn').addEventListener('click', saveCurrentCssTheme);

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†â€œåº”ç”¨â€å’Œâ€œåˆ é™¤â€æŒ‰é’®
document.getElementById('saved-bubble-themes-list').addEventListener('click', (e) => {
    const target = e.target;
    if (target.tagName === 'BUTTON' && target.dataset.id) {
        const themeId = target.dataset.id;
        if (target.classList.contains('apply-btn')) {
            applyCustomBubbleTheme(themeId);
        } else if (target.classList.contains('delete-btn')) {
            deleteCustomBubbleTheme(themeId);
        }
    }
});


        // ===================================================================
        // 5. å¯åŠ¨!
            
            showScreen('home-screen');
        }

        init();
    });
</script>
</body>
</html>